import{G as d}from"./gcanvas.es-ChtmA8T6.js";const r={IRRATIONAL:0,RATIONAL:1,CHAOS:2},h={activePathLength:150,bakeInterval:60,circles:[{outerR:140,innerR:50,traceR:35,speed:1},{outerR:100,innerR:35,traceR:25,speed:.7},{outerR:180,innerR:60,traceR:45,speed:1.3}],traceAngleMultiplier:2,rationalPi:3,wanderRadiusRatio:.15,wanderFreqX:Math.sqrt(2)*.3,wanderFreqY:Math.sqrt(3)*.25,hueSpeed1:10,hueSpeed2:15,hueSpeed3:8,hueOffsets:[0,120,240],timeStep:.015,glowLayers:[20,15,10,5],rationalMessageStart:20,rationalMessageEnd:25,irrationalMessageStart:50,irrationalMessageEnd:55,chaosMessageStart:30,chaosMessageEnd:35};class f{constructor(t,e,s){this.outerR=t.outerR*e,this.innerR=t.innerR*e,this.traceR=t.traceR*e,this.speed=t.speed,this.hueOffset=s,this.path=[]}update(t,e,s,i,a){const n=t*this.speed,o=t*e*this.speed;this.cx1=s+this.outerR*Math.cos(n),this.cy1=i+this.outerR*Math.sin(n),this.cx2=this.cx1+this.innerR*Math.cos(o),this.cy2=this.cy1+this.innerR*Math.sin(o);const c=o*h.traceAngleMultiplier;this.px=this.cx2+this.traceR*Math.cos(c),this.py=this.cy2+this.traceR*Math.sin(c),this.hue=(a+this.hueOffset)%360,this.path.push({x:this.px,y:this.py,hue:this.hue})}extractPointsToBake(){if(this.path.length<=h.activePathLength)return[];const t=this.path.length-h.activePathLength;return this.path.splice(0,t)}reset(){this.path=[]}}class u extends d{constructor(t){super(t),this.backgroundColor="#05000f"}init(){super.init(),this.time=0,this.mode=r.RATIONAL,this.isAnimating=!0,this.scale=Math.min(this.width,this.height)/600,this.circles=h.circles.map((t,e)=>new f(t,this.scale,h.hueOffsets[e])),this.baseCenterX=this.width/2,this.baseCenterY=this.height/2,this.centerX=this.baseCenterX,this.centerY=this.baseCenterY,this.wanderRadius=Math.min(this.width,this.height)*h.wanderRadiusRatio,this.offscreenCanvas=document.createElement("canvas"),this.offscreenCanvas.width=this.width,this.offscreenCanvas.height=this.height,this.offscreenCtx=this.offscreenCanvas.getContext("2d"),this.clearOffscreen(),this.frameCount=0,this._clickHandler||(this._clickHandler=()=>this.toggleMode(),this.canvas.addEventListener("click",this._clickHandler)),this._keyHandler||(this._keyHandler=t=>{t.code==="Space"?(t.preventDefault(),this.isAnimating=!this.isAnimating):t.code==="KeyR"&&this.reset()},this.canvas.addEventListener("keydown",this._keyHandler)),this.canvas.tabIndex=0,this.canvas.focus()}toggleMode(){this.mode=(this.mode+1)%3,this.reset()}reset(){this.time=0,this.frameCount=0,this.centerX=this.baseCenterX,this.centerY=this.baseCenterY,this.circles.forEach(e=>e.reset());const t=this.ctx;t.save(),t.setTransform(1,0,0,1,0,0),t.shadowBlur=0,t.globalCompositeOperation="source-over",t.fillStyle=this.backgroundColor,t.fillRect(0,0,this.canvas.width,this.canvas.height),t.restore(),this.offscreenCanvas=document.createElement("canvas"),this.offscreenCanvas.width=this.canvas.width,this.offscreenCanvas.height=this.canvas.height,this.offscreenCtx=this.offscreenCanvas.getContext("2d"),this.offscreenCtx.fillStyle=this.backgroundColor,this.offscreenCtx.fillRect(0,0,this.offscreenCanvas.width,this.offscreenCanvas.height)}clearOffscreen(){if(this.offscreenCtx){const t=this.offscreenCtx;t.save(),t.setTransform(1,0,0,1,0,0),t.shadowBlur=0,t.globalCompositeOperation="source-over",t.globalAlpha=1,t.fillStyle=this.backgroundColor,t.fillRect(0,0,this.offscreenCanvas.width,this.offscreenCanvas.height),t.restore()}}get piValue(){return this.mode===r.RATIONAL?h.rationalPi:Math.PI}get isChaosMode(){return this.mode===r.CHAOS}update(t){if(super.update(t),!this.isAnimating)return;this.time+=h.timeStep,this.isChaosMode?(this.centerX=this.baseCenterX+Math.sin(this.time*h.wanderFreqX)*this.wanderRadius,this.centerY=this.baseCenterY+Math.sin(this.time*h.wanderFreqY)*this.wanderRadius):(this.centerX=this.baseCenterX,this.centerY=this.baseCenterY);const e=this.time*h.hueSpeed1%360,s=this.time*h.hueSpeed2%360,i=this.time*h.hueSpeed3%360,a=[e,s,i];this.circles.forEach((n,o)=>{n.update(this.time,this.piValue,this.centerX,this.centerY,a[o])}),this.frameCount++,this.frameCount%h.bakeInterval===0&&this.bakeTrails()}bakeTrails(){const t=this.offscreenCtx;t.fillStyle="rgba(5, 0, 15, 0.02)",t.fillRect(0,0,this.width,this.height),this.circles.forEach(e=>{const s=e.extractPointsToBake();if(!(s.length<2)){t.lineCap="round",t.lineJoin="round",t.shadowBlur=12,t.shadowColor=`hsla(${s[0].hue}, 100%, 60%, 0.6)`,t.lineWidth=3,t.beginPath(),t.moveTo(s[0].x,s[0].y);for(let i=1;i<s.length;i++)t.lineTo(s[i].x,s[i].y);t.strokeStyle=`hsla(${s[s.length-1].hue}, 100%, 55%, 0.6)`,t.stroke(),t.shadowBlur=0,t.lineWidth=2,t.beginPath(),t.moveTo(s[0].x,s[0].y);for(let i=1;i<s.length;i++)t.lineTo(s[i].x,s[i].y);t.strokeStyle=`hsla(${s[s.length-1].hue}, 100%, 65%, 0.8)`,t.stroke()}})}render(){const t=this.ctx;this.offscreenCanvas?t.drawImage(this.offscreenCanvas,0,0):(t.fillStyle=this.backgroundColor,t.fillRect(0,0,this.width,this.height)),this.circles.forEach(e=>{this.renderCirclePath(e),this.renderCircleGeometry(e),this.renderTracingPoint(e)}),t.shadowBlur=0,this.renderUI()}renderCirclePath(t){const e=this.ctx,s=t.path;if(!(s.length<2)){h.glowLayers.forEach(i=>{e.shadowBlur=i,e.shadowColor=`hsla(${t.hue}, 100%, 60%, 0.4)`,e.strokeStyle=`hsla(${t.hue}, 100%, ${50+i}%, 0.3)`,e.lineWidth=3,e.beginPath(),e.moveTo(s[0].x,s[0].y);for(let a=1;a<s.length;a++){const n=a/s.length,o=(s[a].hue+n*30)%360;e.strokeStyle=`hsla(${o}, 100%, ${50+n*30}%, ${n*.6})`,e.lineTo(s[a].x,s[a].y)}e.stroke()}),e.shadowBlur=0,e.strokeStyle=`hsla(${t.hue}, 100%, 70%, 0.9)`,e.lineWidth=2,e.beginPath(),e.moveTo(s[0].x,s[0].y);for(let i=1;i<s.length;i++)e.lineTo(s[i].x,s[i].y);e.stroke()}}renderCircleGeometry(t){const e=this.ctx;e.shadowBlur=30,e.shadowColor=`hsla(${t.hue}, 100%, 60%, 0.5)`,e.strokeStyle=`hsla(${t.hue}, 80%, 60%, 0.2)`,e.lineWidth=2,e.beginPath(),e.arc(t.cx1,t.cy1,t.innerR,0,Math.PI*2),e.stroke(),e.beginPath(),e.arc(t.cx2,t.cy2,t.traceR,0,Math.PI*2),e.stroke(),e.shadowBlur=15,e.strokeStyle=`hsla(${t.hue}, 70%, 60%, 0.15)`,e.lineWidth=1,e.beginPath(),e.moveTo(this.centerX,this.centerY),e.lineTo(t.cx1,t.cy1),e.lineTo(t.cx2,t.cy2),e.lineTo(t.px,t.py),e.stroke()}renderTracingPoint(t){const e=this.ctx,s=e.createRadialGradient(t.px,t.py,0,t.px,t.py,15);s.addColorStop(0,`hsla(${t.hue}, 100%, 80%, 1)`),s.addColorStop(.5,`hsla(${t.hue}, 100%, 60%, 0.6)`),s.addColorStop(1,`hsla(${t.hue}, 100%, 40%, 0)`),e.shadowBlur=25,e.shadowColor=`hsla(${t.hue}, 100%, 60%, 0.8)`,e.fillStyle=s,e.beginPath(),e.arc(t.px,t.py,6,0,Math.PI*2),e.fill()}getModeLabel(){switch(this.mode){case r.RATIONAL:return"n = 3.14";case r.CHAOS:return"n = π + drift";default:return"n = π"}}renderUI(){const t=this.ctx,e=12*this.scale;t.fillStyle="rgba(255, 255, 255, 0.15)",t.font=`${e}px monospace`,t.fillText(this.getModeLabel(),20,30),t.fillText(`θ = ${this.time.toFixed(2)}`,20,50),this.mode===r.RATIONAL&&this.time>h.rationalMessageStart&&this.time<h.rationalMessageEnd&&(t.fillStyle="rgba(255, 100, 100, 0.3)",t.font=`${16*this.scale}px monospace`,t.fillText("we will meet again",20,80)),this.mode===r.IRRATIONAL&&this.time>h.irrationalMessageStart&&this.time<h.irrationalMessageEnd&&(t.fillStyle="rgba(100, 200, 255, 0.3)",t.font=`${16*this.scale}px monospace`,t.fillText("never closing...",20,80)),this.mode===r.CHAOS&&this.time>h.chaosMessageStart&&this.time<h.chaosMessageEnd&&(t.fillStyle="rgba(255, 150, 255, 0.3)",t.font=`${16*this.scale}px monospace`,t.fillText("lost in infinity...",20,80))}}function p(l){const t=new u(l);return t.start(),{stop:()=>t.stop(),game:t}}export{p as default};
