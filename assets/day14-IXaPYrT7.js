import{G as P,P as C,p as k,k as b,T as u,B as S,E as D,R as v,q as M,r as E,o as T}from"./gcanvas.es-CkPclmv-.js";import{DESIGN_START_CONFIG as w,ALL_CONFIGS as m,CONFIG as l,TANGRAM as f,DEFAULT_VIEW as L}from"./day14.config-C2x5zr_q.js";function I(y){return y.view??L}function X(y,e=45){return(Math.round(y/e)*e%360+360)%360}class Y extends T{constructor(e,t,s={}){super(e,s),this.shape=t,this.baseSize=s.baseSize||100,this.scaleX=1,this.scaleY=1,this.interactive=!0,this._calculateHitSize(),this._calculateLocalVertices()}_calculateHitSize(){const e=this.shape;e.leg!==void 0?(this.width=e.leg,this.height=e.leg):e.side!==void 0?(this.width=e.side,this.height=e.side):e.width!==void 0?(this.width=e.width+(e.slant||0),this.height=e.height||e.width):(this.width=50,this.height=50)}_calculateLocalVertices(){const e=this.shape;if(e.leg!==void 0){const t=e.leg,s=t/3,i=t/3;this._localVertices=[{x:-s,y:-i},{x:t-s,y:-i},{x:-s,y:t-i}]}else if(e.side!==void 0){const t=e.side/2;this._localVertices=[{x:-t,y:-t},{x:t,y:-t},{x:t,y:t},{x:-t,y:t}]}else if(e.width!==void 0){const t=e.width,s=e.height,i=e.slant||0;this._localVertices=[{x:-t/2,y:s/2},{x:t/2,y:s/2},{x:t/2+i,y:-s/2},{x:-t/2+i,y:-s/2}]}else this._localVertices=[]}getWorldVertices(){const e=this._rotationDeg!==void 0?this._rotationDeg*Math.PI/180:this.rotation,t=Math.cos(e),s=Math.sin(e);return this._localVertices.map(i=>({x:this.x+i.x*t-i.y*s,y:this.y+i.x*s+i.y*t}))}getBounds(){const e=this.width*Math.abs(this.scaleX),t=this.height*Math.abs(this.scaleY);return{x:this.x,y:this.y,width:e,height:t}}animateTo(e,t=0){u.killTarget(this),u.to(this,{x:e.x*this.baseSize,y:e.y*this.baseSize,rotation:e.rotation,scaleX:e.scaleX??1,scaleY:e.scaleY??1},l.animDuration,D.easeOutBack,{delay:t})}setPosition(e){this.x=e.x*this.baseSize,this.y=e.y*this.baseSize,this.rotation=e.rotation,this.scaleX=e.scaleX??1,this.scaleY=e.scaleY??1}draw(){super.draw(),this.shape.draw()}}class A extends P{constructor(e){super(e),this.configIndex=0,this.draggingPiece=null,this.selectedPiece=null,this._onKeyDown=null,this._onCanvasClick=null,this._dragCleanups=[],this.shuffledIndices=[],this.shufflePosition=0}init(){super.init(),C.init(this.ctx),this.baseSize=Math.min(this.width,this.height)*.8,this.scene=new k(this,{x:this.width/2,y:this.height/2}),this.pieces=this.createPieces();for(const e of this.pieces)this.scene.add(e);this.pipeline.add(this.scene),this.createButtons(),this.initStateMachine(),this.initKeyboardHandler(),this.canvas.tabIndex=0,this.canvas.style.outline="none",this.canvas.addEventListener("pointerdown",()=>this.canvas.focus()),this.canvas.focus()}initStateMachine(){this.fsm=new b({initial:"menu",context:this,states:{menu:{enter:()=>{this.showButtons(!0),this.removeCanvasClickHandler(),this.disableDragging(),this.configuration=m[0],this.applyConfiguration(!1)},exit:()=>{this.showButtons(!1)}},showcase:{enter:()=>{this.shuffleConfigs(),this.configIndex=this.shuffledIndices[0],this.shufflePosition=0,this.configuration=m[this.configIndex],this.applyConfiguration(!1),this.assignDistinctColors(),this.setupCanvasClickHandler(()=>this.toggleShowcase()),this.disableDragging()},exit:()=>{this.removeCanvasClickHandler()}},design:{enter:()=>{for(const e of this.pieces)u.killTarget(e);u.killTarget(this.scene),this.scene.x=this.width/2,this.scene.y=this.height/2,w?(this.loadDesignConfig(w),console.log(`[Design Mode] Loaded config: ${w.name}`)):(this.scene.scaleX=1,this.scene.scaleY=1,this._designScale=1,this.scatterPieces()),this.enableDragging(),this.enableWheelZoom(),console.log("[Design Mode] Q/E rotate, W/S flip, Wheel zoom, Drag canvas, P print, SHIFT = no snap")},exit:()=>{this.disableDragging(),this.disableWheelZoom()}}}})}createButtons(){const{width:e,height:t,spacing:s}=l.button,i=this.width/2,n=this.height/2;this.showcaseBtn=new S(this,{x:i-e/2-s/2,y:n,width:e,height:t,text:"Showcase",onClick:()=>this.fsm.setState("showcase")}),this.designBtn=new S(this,{x:i+e/2+s/2,y:n,width:e,height:t,text:"Design",onClick:()=>this.fsm.setState("design")}),this.backBtn=new S(this,{x:80,y:30,width:100,height:30,text:"← Back",onClick:()=>this.fsm.setState("menu")}),this.pipeline.add(this.showcaseBtn),this.pipeline.add(this.designBtn),this.pipeline.add(this.backBtn)}showButtons(e){this.showcaseBtn&&(this.showcaseBtn.visible=e,this.designBtn.visible=e,this.backBtn.visible=!e,this.showcaseBtn.interactive=e,this.designBtn.interactive=e,this.backBtn.interactive=!e)}initKeyboardHandler(){this._onKeyDown=t=>{const s=t.key.toLowerCase();if(this.fsm.is("design")&&this.selectedPiece){if(s==="q"||s==="e"){t.preventDefault(),t.stopPropagation(),this.selectedPiece._rotationDeg===void 0&&(this.selectedPiece._rotationDeg=0);const i=s==="q"?-45:45;this.selectedPiece._rotationDeg+=i,console.log(`[Rotate] ${s.toUpperCase()}: ${this.selectedPiece._rotationDeg-i}° -> ${this.selectedPiece._rotationDeg}°`),this.selectedPiece.rotation=this.selectedPiece._rotationDeg;return}if(s==="w"||s==="s"){t.preventDefault(),t.stopPropagation(),s==="w"?(this.selectedPiece.scaleX*=-1,console.log(`[Flip] Horizontal: scaleX = ${this.selectedPiece.scaleX}`)):(this.selectedPiece.scaleY*=-1,console.log(`[Flip] Vertical: scaleY = ${this.selectedPiece.scaleY}`));return}}if(s==="p"&&this.fsm.is("design")){t.preventDefault(),t.stopPropagation(),this.printConfiguration();return}s==="escape"&&!this.fsm.is("menu")&&(t.preventDefault(),this.fsm.setState("menu")),t.shiftKey&&(this._shiftHeld=!0)},this._onKeyUp=t=>{t.key==="Shift"&&(this._shiftHeld=!1)},window.addEventListener("keydown",this._onKeyDown,{capture:!0}),window.addEventListener("keyup",this._onKeyUp,{capture:!0})}setupCanvasClickHandler(e){this.removeCanvasClickHandler(),this._onCanvasClick=e,this.canvas.addEventListener("click",this._onCanvasClick)}removeCanvasClickHandler(){this._onCanvasClick&&(this.canvas.removeEventListener("click",this._onCanvasClick),this._onCanvasClick=null)}enableDragging(){this.disableDragging();for(const e of this.pieces){e.interactive=!0,e._dragOffset={x:0,y:0},e._isDragging=!1;const t=n=>{e._isDragging=!0,this.draggingPiece=e,this.selectPiece(e);const o=this.scene.scaleX||1,a=(n.x-this.scene.x)/o,h=(n.y-this.scene.y)/o;e._dragOffset.x=e.x-a,e._dragOffset.y=e.y-h},s=n=>{if(!e._isDragging)return;const o=this.scene.scaleX||1,a=(n.x-this.scene.x)/o,h=(n.y-this.scene.y)/o;e.x=a+e._dragOffset.x,e.y=h+e._dragOffset.y},i=()=>{e._isDragging&&(e._isDragging=!1,this.draggingPiece=null,this.snapPieceToNearby(e))};e.on("inputdown",t),this.events.on("inputmove",s),this.events.on("inputup",i),this._dragCleanups.push(()=>{e.off("inputdown",t),this.events.off("inputmove",s),this.events.off("inputup",i),delete e._dragOffset,delete e._isDragging})}this._clickedPiece=!1,this._isDraggingCanvas=!1,this._canvasDragStart={x:0,y:0},this._sceneDragStart={x:0,y:0},this._onDesignCanvasDown=e=>{this._clickedPiece=!1,setTimeout(()=>{!this._clickedPiece&&!this.draggingPiece&&(this._isDraggingCanvas=!0,this._canvasDragStart.x=e.x,this._canvasDragStart.y=e.y,this._sceneDragStart.x=this.scene.x,this._sceneDragStart.y=this.scene.y)},0)},this._onDesignCanvasMove=e=>{if(this._isDraggingCanvas){const t=e.x-this._canvasDragStart.x,s=e.y-this._canvasDragStart.y;this.scene.x=this._sceneDragStart.x+t,this.scene.y=this._sceneDragStart.y+s}},this._onDesignCanvasUp=()=>{!this._clickedPiece&&!this.draggingPiece&&!this._isDraggingCanvas&&this.deselectPiece(),this._isDraggingCanvas=!1};for(const e of this.pieces){const t=()=>{this._clickedPiece=!0};e.on("inputdown",t),this._dragCleanups.push(()=>e.off("inputdown",t))}this.events.on("inputdown",this._onDesignCanvasDown),this.events.on("inputmove",this._onDesignCanvasMove),this.events.on("inputup",this._onDesignCanvasUp),this._dragCleanups.push(()=>{this.events.off("inputdown",this._onDesignCanvasDown),this.events.off("inputmove",this._onDesignCanvasMove),this.events.off("inputup",this._onDesignCanvasUp)})}selectPiece(e){this.selectedPiece&&this.selectedPiece!==e&&this.restorePieceStroke(this.selectedPiece),this.selectedPiece=e,this.scene.bringToFront(e),e._originalStroke||(e._originalStroke=e.shape.stroke,e._originalLineWidth=e.shape.lineWidth),e.shape.stroke="#0f0",e.shape.lineWidth=4}restorePieceStroke(e){e._originalStroke!==void 0&&(e.shape.stroke=e._originalStroke,e.shape.lineWidth=e._originalLineWidth)}deselectPiece(){this.selectedPiece&&(this.restorePieceStroke(this.selectedPiece),this.selectedPiece=null)}disableDragging(){for(const e of this._dragCleanups)typeof e=="function"&&e();this._dragCleanups=[],this.draggingPiece=null,this.deselectPiece()}enableWheelZoom(){this._onWheel=e=>{e.preventDefault();const t=.05,s=e.deltaY>0?-t:t;this._designScale=Math.max(.3,Math.min(1,this._designScale+s)),this.scene.scaleX=this._designScale,this.scene.scaleY=this._designScale},this.canvas.addEventListener("wheel",this._onWheel,{passive:!1})}disableWheelZoom(){this._onWheel&&(this.canvas.removeEventListener("wheel",this._onWheel),this._onWheel=null)}_closestPointOnSegment(e,t,s){const i=s.x-t.x,n=s.y-t.y,o=e.x-t.x,a=e.y-t.y,h=i*i+n*n;if(h===0){const g=Math.sqrt(o*o+a*a);return{x:t.x,y:t.y,dist:g}}let c=(o*i+a*n)/h;c=Math.max(0,Math.min(1,c));const p=t.x+c*i,d=t.y+c*n,r=e.x-p,_=e.y-d,x=Math.sqrt(r*r+_*_);return{x:p,y:d,dist:x,t:c}}snapPieceToNearby(e){if(this._shiftHeld){console.log("[Snap] Disabled (SHIFT held)");return}const t=20,s=15,i=e.getWorldVertices();if(i.length===0)return;let n=null,o=Math.max(t,s),a="";for(const h of this.pieces){if(h===e)continue;const c=h.getWorldVertices(),p=c.length;for(const d of i)for(const r of c){const _=r.x-d.x,x=r.y-d.y,g=Math.sqrt(_*_+x*x);g<o&&g<t&&(o=g,n={dx:_,dy:x},a="vertex")}if(o>s*.5)for(const d of i)for(let r=0;r<p;r++){const _=c[r],x=c[(r+1)%p],g=this._closestPointOnSegment(d,_,x);g.t<.05||g.t>.95||g.dist<o&&g.dist<s&&(o=g.dist,n={dx:g.x-d.x,dy:g.y-d.y},a="edge")}}n&&(e.x+=n.dx,e.y+=n.dy,console.log(`[Snap] ${a} snap by (${n.dx.toFixed(1)}, ${n.dy.toFixed(1)})`))}scatterPieces(){const e=this.baseSize*.25,t=4,s=-e*1.5,i=-e;for(let n=0;n<this.pieces.length;n++){const o=this.pieces[n],a=n%t,h=Math.floor(n/t);o.x=s+a*e,o.y=i+h*e,o.rotation=0,o._rotationDeg=0,o.scaleX=o.scaleY=1}}loadDesignConfig(e){const t=e.view??{scale:1};this._designScale=t.scale,this.scene.scaleX=t.scale,this.scene.scaleY=t.scale;for(let s=0;s<this.pieces.length;s++){const i=this.pieces[s],n=e.pieces[s];i.x=n.x*this.baseSize,i.y=n.y*this.baseSize,i.rotation=n.rotation,i._rotationDeg=n.rotation,i.scaleX=n.scaleX??1,i.scaleY=n.scaleY??1}}printConfiguration(){const e=["Large 1","Large 2","Medium","Small 1","Small 2","Square","Parallelogram"];console.log(`
=== TANGRAM CONFIGURATION ===`),console.log(`Copy this into ALL_CONFIGS:
`);const s=`{
  name: "custom",
  view: { offsetX: 0, offsetY: 0, scale: ${(this._designScale??1).toFixed(2)} },
  pieces: [
${this.pieces.map((i,n)=>{const o=(i.x/this.baseSize).toFixed(3),a=(i.y/this.baseSize).toFixed(3),h=i._rotationDeg!==void 0?i._rotationDeg:i.rotation*180/Math.PI,c=X(h,45),p=i.scaleX??1,d=i.scaleY??1;let r="";return p!==1&&(r+=`, scaleX: ${p}`),d!==1&&(r+=`, scaleY: ${d}`),`    // ${e[n]}
    { x: ${o}, y: ${a}, rotation: ${c}${r} },`}).join(`
`)}
  ],
}`;console.log(s),console.log(`
=============================
`)}applySceneView(e=!0){const t=I(this.configuration),i=this.baseSize/640,n={x:this.width/2+t.offsetX*i,y:this.height/2+t.offsetY*i,scaleX:t.scale,scaleY:t.scale};u.killTarget(this.scene),e?u.to(this.scene,n,l.animDuration,D.easeOutBack):(this.scene.x=n.x,this.scene.y=n.y,this.scene.scaleX=n.scaleX,this.scene.scaleY=n.scaleY)}toggleShowcase(){this.nextConfiguration(),this.assignDistinctColors()}assignDistinctColors(){const e=this.pieces.length,t=30,s=[];let i=Math.random()*360;for(let n=0;n<e;n++)s.push(i%360),i+=t+Math.random()*40;for(let n=s.length-1;n>0;n--){const o=Math.floor(Math.random()*(n+1));[s[n],s[o]]=[s[o],s[n]]}for(let n=0;n<e;n++){const o=Math.round(s[n]),a=70+Math.random()*25,h=45+Math.random()*20,c=`hsl(${o}, ${a.toFixed(0)}%, ${h.toFixed(0)}%)`;this.pieces[n].shape.color=c,this.pieces[n].shape.fill=c}}scatterPiecesAnimated(){const e={offsetX:0,offsetY:0,scale:1};this.configuration={view:e},this.applySceneView(!0);for(let t=0;t<this.pieces.length;t++){const s=this.pieces[t];u.killTarget(s),s._originalColor||(s._originalColor=s.shape.color);const i=(Math.random()-.5)*this.baseSize*1.2,n=(Math.random()-.5)*this.baseSize*1.2,o=Math.floor(Math.random()*8)*45,a=C.colors.randomColorHSL();s.shape.color=a,s.shape.fill=a,u.to(s,{x:i,y:n,rotation:o},l.animDuration,D.easeOutBack,{delay:t*l.staggerDelay})}}restoreOriginalColors(){for(const e of this.pieces)e._originalColor&&(e.shape.color=e._originalColor,e.shape.fill=e._originalColor)}createPieces(){const e=this.baseSize,t=[],s=n=>new Y(this,n,{baseSize:e}),i=n=>({color:n,stroke:l.strokeColor,lineWidth:l.strokeWidth,lineJoin:"round"});return t.push(s(new v(f.LARGE_LEG*e,i(l.colors.largeTriangle1)))),t.push(s(new v(f.LARGE_LEG*e,i(l.colors.largeTriangle2)))),t.push(s(new v(f.MEDIUM_LEG*e,i(l.colors.mediumTriangle)))),t.push(s(new v(f.SMALL_LEG*e,i(l.colors.smallTriangle1)))),t.push(s(new v(f.SMALL_LEG*e,i(l.colors.smallTriangle2)))),t.push(s(new M(f.SQUARE_SIDE*e,i(l.colors.square)))),t.push(s(new E({width:f.PARA_BASE*e,height:f.PARA_HEIGHT*e,slant:f.PARA_HEIGHT*e,...i(l.colors.parallelogram)}))),t}applyConfiguration(e=!0){const t=this.configuration;for(let s=0;s<this.pieces.length;s++){const i=t.pieces[s];e?this.pieces[s].animateTo(i,s*l.staggerDelay):this.pieces[s].setPosition(i)}this.applySceneView(e)}shuffleConfigs(){const e=m.length;this.shuffledIndices=Array.from({length:e},(t,s)=>s);for(let t=e-1;t>0;t--){const s=Math.floor(Math.random()*(t+1));[this.shuffledIndices[t],this.shuffledIndices[s]]=[this.shuffledIndices[s],this.shuffledIndices[t]]}console.log(`[Showcase] Shuffled ${e} configs: ${this.shuffledIndices.map(t=>m[t].name).join(", ")}`)}nextConfiguration(){const e=m.length;e!==0&&(this.shufflePosition++,this.shufflePosition>=e&&(this.shuffleConfigs(),this.shufflePosition=0),this.configIndex=this.shuffledIndices[this.shufflePosition],this.configuration=m[this.configIndex],console.log(`Assembling: ${this.configuration.name} (${this.shufflePosition+1}/${e})`),this.applyConfiguration(!0))}update(e){super.update(e),u.updateAll(e),this.fsm.update(e)}render(){var e,t;if(super.render(),((e=this.fsm)==null?void 0:e.state)==="showcase"&&((t=this.configuration)!=null&&t.name)){const s=this.ctx,i=this.configuration.name;s.save(),s.font='14px "Fira Code", monospace',s.fillStyle="rgba(255, 255, 255, 0.5)",s.textAlign="left",s.textBaseline="bottom",s.fillText(i,16,this.height-16),s.restore()}}stop(){this._onKeyDown&&window.removeEventListener("keydown",this._onKeyDown,{capture:!0}),this._onKeyUp&&window.removeEventListener("keyup",this._onKeyUp,{capture:!0}),this.removeCanvasClickHandler(),this.disableDragging(),super.stop()}}function $(y){const e=new A(y);return e.start(),{stop:()=>e.stop(),game:e}}export{$ as default};
