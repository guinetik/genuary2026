import{G as E,P as B,C as L,r as x,s as T}from"./gcanvas.es-CMQjSjBY.js";const o={bhMass:1,starCount:800,starFieldRadius:1200,lensEffectRadius:600,lensStrength:180,lensFalloff:.007,occlusionRadius:2.6,diskInnerRadius:1.8,diskOuterRadius:8,diskParticles:3e3,diskThickness:.15,baseOrbitalSpeed:.6,colorHot:{r:255,g:250,b:220},colorMid:{r:255,g:160,b:50},colorCool:{r:180,g:40,b:20},particleSizeMin:.5,particleSizeMax:1,particleScale:.0025,perspective:800,initialTilt:.4},X=[{size:1.5,brightness:1},{size:1,brightness:.7},{size:.6,brightness:.5}];class q extends E{constructor(t){super(t),this.backgroundColor="#000"}init(){super.init(),B.init(this.ctx);const t=Math.min(this.width,this.height);this.baseScale=t,this.bhRadius=t*.06,this.camera=new L({perspective:o.perspective,rotationX:o.initialTilt,rotationY:0,sensitivity:.004,inertia:!0,friction:.92,clampX:!1,autoRotate:!0,autoRotateSpeed:.08,autoRotateAxis:"y"}),this.camera.enableMouseControl(this.canvas),this.time=0,this.lensingStrength=1,this.mouseX=this.width/2,this.mouseY=this.height/2,this.mouseDownPos=null,this.isDragging=!1,this.initStarfield(),this.initAccretionDisk(),this.initFallingMatter(),this.canvas.addEventListener("mousemove",n=>{const r=this.canvas.getBoundingClientRect();this.mouseX=n.clientX-r.left,this.mouseY=n.clientY-r.top}),this.canvas.addEventListener("mousedown",n=>{const r=this.canvas.getBoundingClientRect();this.mouseDownPos={x:n.clientX-r.left,y:n.clientY-r.top},this.isDragging=!1}),this.canvas.addEventListener("mousemove",n=>{if(this.mouseDownPos){const r=this.canvas.getBoundingClientRect(),e=n.clientX-r.left-this.mouseDownPos.x,a=n.clientY-r.top-this.mouseDownPos.y;Math.sqrt(e*e+a*a)>5&&(this.isDragging=!0)}}),this.canvas.addEventListener("mouseup",n=>{!this.isDragging&&this.mouseDownPos&&this.spawnMatterAtMouse(),this.mouseDownPos=null,this.isDragging=!1}),this.canvas.addEventListener("touchstart",n=>{if(n.touches.length===1){const r=this.canvas.getBoundingClientRect(),e=n.touches[0];this.mouseX=e.clientX-r.left,this.mouseY=e.clientY-r.top,this.mouseDownPos={x:this.mouseX,y:this.mouseY},this.isDragging=!1}}),this.canvas.addEventListener("touchmove",n=>{if(n.touches.length===1&&this.mouseDownPos){const r=this.canvas.getBoundingClientRect(),e=n.touches[0],a=e.clientX-r.left-this.mouseDownPos.x,s=e.clientY-r.top-this.mouseDownPos.y;Math.sqrt(a*a+s*s)>10&&(this.isDragging=!0)}}),this.canvas.addEventListener("touchend",n=>{!this.isDragging&&this.mouseDownPos&&this.spawnMatterAtMouse(),this.mouseDownPos=null,this.isDragging=!1})}initStarfield(){this.stars=[];for(let t=0;t<o.starCount;t++){const n=Math.random()*Math.PI*2,r=Math.acos(2*Math.random()-1),e=o.starFieldRadius*(.5+Math.random()*.5),a=X[Math.floor(Math.random()*X.length)];this.stars.push({x:e*Math.sin(r)*Math.cos(n),y:e*Math.sin(r)*Math.sin(n),z:e*Math.cos(r),type:a,twinkleSpeed:1+Math.random()*2,twinklePhase:Math.random()*Math.PI*2})}}initAccretionDisk(){this.diskParticles=[];const t=this.bhRadius*o.diskInnerRadius,n=this.bhRadius*o.diskOuterRadius;for(let r=0;r<o.diskParticles;r++){const e=Math.pow(Math.random(),.5),a=t+(n-t)*e,s=Math.random()*Math.PI*2,i=x(a,o.bhMass,o.baseOrbitalSpeed,n),h=(Math.random()-.5)*this.bhRadius*o.diskThickness;this.diskParticles.push({angle:s,distance:a,yOffset:h,speed:i,size:o.particleSizeMin+Math.random()*(o.particleSizeMax-o.particleSizeMin),baseColor:this.getHeatColor(a,t,n)})}}getHeatColor(t,n,r){const e=Math.max(0,Math.min(1,(t-n)/(r-n)));let a,s,i;if(e<.5){const h=e*2;a=o.colorHot.r+(o.colorMid.r-o.colorHot.r)*h,s=o.colorHot.g+(o.colorMid.g-o.colorHot.g)*h,i=o.colorHot.b+(o.colorMid.b-o.colorHot.b)*h}else{const h=(e-.5)*2;a=o.colorMid.r+(o.colorCool.r-o.colorMid.r)*h,s=o.colorMid.g+(o.colorCool.g-o.colorMid.g)*h,i=o.colorMid.b+(o.colorCool.b-o.colorMid.b)*h}return{r:Math.round(a),g:Math.round(s),b:Math.round(i)}}initFallingMatter(){this.fallingParticles=[]}spawnMatterAtMouse(){const t=this.width/2,n=this.height/2,r=this.mouseX-t,e=this.mouseY-n,a=-300,s=this.camera.perspective/(this.camera.perspective+a);let i=r/s,h=e/s,u=a;for(let l=0;l<30;l++){const c=(Math.random()-.5)*40,d=(Math.random()-.5)*40,g=(Math.random()-.5)*40;this.fallingParticles.push({x:i+c,y:h+d,z:u+g,vx:(Math.random()-.5)*20,vy:(Math.random()-.5)*20,vz:(Math.random()-.5)*20+30,size:1+Math.random()*2,age:0,maxAge:5+Math.random()*3})}this.fallingParticles.length>500&&(this.fallingParticles=this.fallingParticles.slice(-400))}update(t){super.update(t),this.time+=t,this.camera.update(t);for(let s=this.diskParticles.length-1;s>=0;s--){const i=this.diskParticles[s];i.angle+=i.speed*t,i.age!==void 0&&(i.age+=t,i.age>i.maxAge&&this.diskParticles.splice(s,1))}const n=15e3,r=this.bhRadius*1.5,e=this.bhRadius*o.diskInnerRadius,a=this.bhRadius*o.diskOuterRadius;for(let s=this.fallingParticles.length-1;s>=0;s--){const i=this.fallingParticles[s],h=Math.sqrt(i.x*i.x+i.y*i.y+i.z*i.z);if(h>1){const u=n/(h*h),l=-i.x/h*u*t,c=-i.y/h*u*t,d=-i.z/h*u*t;i.vx+=l,i.vy+=c,i.vz+=d}if(i.x+=i.vx*t,i.y+=i.vy*t,i.z+=i.vz*t,i.age+=t,h<r||i.age>i.maxAge){if(h<r&&h>this.bhRadius){const u=Math.atan2(i.z,i.x),l=e+Math.random()*(a-e)*.3;this.diskParticles.push({angle:u,distance:l,yOffset:(Math.random()-.5)*this.bhRadius*o.diskThickness,speed:x(l,o.bhMass,o.baseOrbitalSpeed,a),size:i.size*.5,baseColor:this.getHeatColor(l,e,a),age:0,maxAge:3+Math.random()*2})}this.fallingParticles.splice(s,1)}}}render(){const t=this.ctx,n=this.width,r=this.height,e=n/2,a=r/2;t.fillStyle="rgba(0, 0, 0, 0.12)",t.fillRect(0,0,n,r),this.renderStarfield(t,e,a),this.renderFallingMatter(t,e,a),this.renderDisk(t,e,a),this.renderBlackHole(t,e,a)}renderStarfield(t,n,r){const e=this.time;for(const a of this.stars){const s=this.camera.project(a.x,a.y,a.z);if(s.scale<=0)continue;let i=s.x,h=s.y;if(s.z>0&&this.lensingStrength>0){const m=T(i,h,o.lensEffectRadius,o.lensStrength*this.lensingStrength,o.lensFalloff,5);i=m.x,h=m.y}const u=Math.sqrt(i*i+h*h),l=this.bhRadius*o.occlusionRadius;if(u<l)continue;const c=n+i,d=r+h;if(c<-10||c>this.width+10||d<-10||d>this.height+10)continue;const p=.5+.5*Math.sin(e*a.twinkleSpeed+a.twinklePhase);if(p<.1)continue;const M=a.type.size*s.scale*a.type.brightness,f=Math.round(180+a.type.brightness*75);t.globalAlpha=p*.8,t.fillStyle=`rgb(${f}, ${f}, ${f})`,t.beginPath(),t.arc(c,d,Math.max(.5,M),0,Math.PI*2),t.fill()}t.globalAlpha=1}renderDisk(t,n,r){const e=[],a=Math.abs(Math.sin(this.camera.rotationX));for(const s of this.diskParticles){const i=Math.cos(s.angle)*s.distance,h=s.yOffset,u=Math.sin(s.angle)*s.distance,l=Math.cos(this.camera.rotationY),c=Math.sin(this.camera.rotationY);let d=i*l-u*c,g=i*c+u*l;const p=Math.cos(this.camera.rotationX),M=Math.sin(this.camera.rotationX);let f=h*p-g*M;g=h*M+g*p;const m=Math.sqrt(d*d+f*f),v=g>0;if(this.lensingStrength>0&&m<this.bhRadius*6){const y=this.bhRadius*1.8,C=Math.exp(-m/(this.bhRadius*1.8)),O=C*1.2*this.lensingStrength,A=s.angle+this.camera.rotationY,D=Math.sin(A)>0,I=1-a;if(m>0){let b=O;!D&&v&&(b*=1-I*.6);const R=(m+y*b)/m;d*=R,f*=R}if(a>.05){const b=this.bhRadius*5,R=d/b,z=Math.max(0,Math.cos(R*Math.PI*.5)),F=v?Math.min(1,g/(this.bhRadius*3)):Math.min(1,Math.abs(g)/(this.bhRadius*3)),k=this.bhRadius*2*C*F*a;v?D?f-=k*z:f+=k*z*.5:f+=k*z*.4}}const P=this.camera.perspective/(this.camera.perspective+g);if(g<-this.camera.perspective+10)continue;const Y=d*P,$=f*P,H=1+Math.cos(s.angle+this.camera.rotationY)*.4;let S=1;if(s.age!==void 0){const y=s.age/s.maxAge;S=1-Math.pow(y,2)}e.push({x:Y,y:$,z:g,scale:P,color:s.baseColor,doppler:H,alpha:S,size:s.size})}e.sort((s,i)=>i.z-s.z);for(const s of e){const{r:i,g:h,b:u}=s.color,l=this.baseScale*o.particleScale*s.scale*s.size;if(l<.1)continue;const c=Math.min(255,Math.round(i*s.doppler)),d=Math.min(255,Math.round(h*s.doppler)),g=Math.min(255,Math.round(u*s.doppler)),p=Math.max(0,Math.min(1,s.alpha*s.doppler*.8));t.fillStyle=`rgba(${c}, ${d}, ${g}, ${p})`,t.beginPath(),t.arc(n+s.x,r+s.y,l,0,Math.PI*2),t.fill(),s.doppler>1.1&&s.alpha>.5&&(t.globalCompositeOperation="screen",t.fillStyle=`rgba(${c}, ${d}, ${g}, ${p*.3})`,t.beginPath(),t.arc(n+s.x,r+s.y,l*1.5,0,Math.PI*2),t.fill(),t.globalCompositeOperation="source-over")}}renderFallingMatter(t,n,r){for(const e of this.fallingParticles){const a=this.camera.project(e.x,e.y,e.z);if(a.scale<=0)continue;const s=n+a.x,i=r+a.y;if(s<-20||s>this.width+20||i<-20||i>this.height+20)continue;const h=Math.sqrt(e.x*e.x+e.y*e.y+e.z*e.z),u=this.bhRadius*o.diskInnerRadius,l=this.bhRadius*o.diskOuterRadius*2,c=this.getHeatColor(h,u,l),d=e.age/e.maxAge,g=(1-d*d)*.9,p=e.size*a.scale;t.globalCompositeOperation="screen",t.fillStyle=`rgba(${c.r}, ${c.g}, ${c.b}, ${g*.4})`,t.beginPath(),t.arc(s,i,p*2,0,Math.PI*2),t.fill(),t.globalCompositeOperation="source-over",t.fillStyle=`rgba(${c.r}, ${c.g}, ${c.b}, ${g})`,t.beginPath(),t.arc(s,i,p,0,Math.PI*2),t.fill()}}renderBlackHole(t,n,r){}}function Z(w){const t=new q(w);return t.start(),{stop:()=>t.stop(),game:t}}export{Z as default};
