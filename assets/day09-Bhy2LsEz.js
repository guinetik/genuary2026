import{G as H,P}from"./gcanvas.es-ChtmA8T6.js";const c={agentCount:8e3,moveSpeed:1,turnSpeed:.4,randomSteer:.3,sensorAngle:Math.PI/6,sensorDistance:12,trailWeight:8,decayRate:.985,diffuseRate:1,foodRadius:50,foodStrength:500,foodConsumeRate:.1,maxAgents:15e3,foodSenseRange:300,foodAttraction:2,hue:120,foodHue:50,saturation:100};class D{constructor(s,i,e){this.x=s,this.y=i,this.angle=e}}class T extends H{constructor(s){super(s),this.backgroundColor=null}init(){super.init(),P.init(this.ctx),this.container=this.canvas.parentElement,this.container&&this.enableFluidSize(this.container),this.trailWidth=Math.floor(this.width),this.trailHeight=Math.floor(this.height),this.trailMap=new Float32Array(this.trailWidth*this.trailHeight),this.trailMapNext=new Float32Array(this.trailWidth*this.trailHeight),this.trailImageData=this.ctx.createImageData(this.trailWidth,this.trailHeight),this.agents=[];const s=50;for(let i=0;i<c.agentCount;i++){const e=s+Math.random()*(this.width-s*2),t=s+Math.random()*(this.height-s*2),a=Math.random()*Math.PI*2;this.agents.push(new D(e,t,a))}this.foodSources=[],this.canvas.addEventListener("click",i=>{const e=this.canvas.getBoundingClientRect(),t=(i.clientX-e.left)*(this.width/e.width),a=(i.clientY-e.top)*(this.height/e.height);this.foodSources.push({x:t,y:a,strength:c.foodStrength})}),this.elapsedTime=0}sampleTrail(s,i){const e=Math.floor(s),t=Math.floor(i);return e<0||e>=this.trailWidth||t<0||t>=this.trailHeight?0:this.trailMap[t*this.trailWidth+e]}depositTrail(s,i,e){const t=Math.floor(s),a=Math.floor(i);if(t<0||t>=this.trailWidth||a<0||a>=this.trailHeight)return;const n=a*this.trailWidth+t;this.trailMap[n]=Math.min(255,this.trailMap[n]+e)}processTrailMap(){const s=this.trailWidth,i=this.trailHeight,e=c.decayRate,t=c.diffuseRate;for(let a=1;a<i-1;a++)for(let n=1;n<s-1;n++){const r=a*s+n;let f=0;for(let h=-t;h<=t;h++)for(let o=-t;o<=t;o++)f+=this.trailMap[(a+h)*s+(n+o)];const l=(t*2+1)*(t*2+1);this.trailMapNext[r]=f/l*e}[this.trailMap,this.trailMapNext]=[this.trailMapNext,this.trailMap]}processFoodSources(){const s=[];for(let i=0;i<this.foodSources.length;i++){const e=this.foodSources[i],t=Math.floor(e.x),a=Math.floor(e.y),n=c.foodRadius;for(let l=-n;l<=n;l++)for(let h=-n;h<=n;h++){const o=Math.sqrt(h*h+l*l);if(o<=n){const d=t+h,g=a+l;if(d>=0&&d<this.trailWidth&&g>=0&&g<this.trailHeight){const M=1-o/n,u=g*this.trailWidth+d;this.trailMap[u]=Math.min(255,this.trailMap[u]+e.strength/50*M*2)}}}let r=0;const f=n*1.2;for(const l of this.agents){const h=l.x-e.x,o=l.y-e.y;Math.sqrt(h*h+o*o)<f&&r++}if(r>0){if(e.strength-=c.foodConsumeRate*r,this.agents.length<c.maxAgents){const l=Math.min(r,10);for(let h=0;h<l;h++){const o=Math.random()*Math.PI*2,d=Math.random()*f*.5;this.agents.push(new D(e.x+Math.cos(o)*d,e.y+Math.sin(o)*d,o))}}for(let l=-5;l<=5;l++)for(let h=-5;h<=5;h++){const o=Math.floor(e.x)+h,d=Math.floor(e.y)+l;if(o>=0&&o<this.trailWidth&&d>=0&&d<this.trailHeight){const g=d*this.trailWidth+o;this.trailMap[g]=Math.min(255,this.trailMap[g]+r*2)}}}e.strength<=0&&s.push(i)}for(let i=s.length-1;i>=0;i--)this.foodSources.splice(s[i],1)}update(s){super.update(s),this.elapsedTime+=s;const i=this.trailWidth,e=this.trailHeight;for(const t of this.agents){let a=null,n=c.foodSenseRange;for(const p of this.foodSources){const m=p.x-t.x,y=p.y-t.y,A=Math.sqrt(m*m+y*y);A<n&&(n=A,a=Math.atan2(y,m))}if(a!==null){let p=a-t.angle;for(;p>Math.PI;)p-=Math.PI*2;for(;p<-Math.PI;)p+=Math.PI*2;const m=1-n/c.foodSenseRange,y=c.foodAttraction*m*m;t.angle+=p*y*.2}const r=c.sensorDistance,f=c.sensorAngle,l=t.x+Math.cos(t.angle-f)*r,h=t.y+Math.sin(t.angle-f)*r,o=this.sampleTrail(l,h),d=t.x+Math.cos(t.angle)*r,g=t.y+Math.sin(t.angle)*r,M=this.sampleTrail(d,g),u=t.x+Math.cos(t.angle+f)*r,S=t.y+Math.sin(t.angle+f)*r,x=this.sampleTrail(u,S),R=c.turnSpeed,I=(Math.random()-.5)*c.randomSteer;M>o&&M>x?t.angle+=I:M<o&&M<x?t.angle+=(Math.random()<.5?-1:1)*R+I:o>x?t.angle-=R:x>o?t.angle+=R:t.angle+=I*2;const W=c.moveSpeed,b=t.x+Math.cos(t.angle)*W,C=t.y+Math.sin(t.angle)*W;b<1||b>=i-1||C<1||C>=e-1?t.angle=Math.random()*Math.PI*2:(t.x=b,t.y=C,this.depositTrail(t.x,t.y,c.trailWeight))}this.processTrailMap(),this.processFoodSources()}render(){const s=this.ctx;this.trailWidth,this.trailHeight;const i=this.trailImageData.data,e=c.hue,t=c.saturation;for(let a=0;a<this.trailMap.length;a++){const n=this.trailMap[a],r=a*4;if(n>.5){const h=(20+Math.min(1,n/100)*60)/100,o=t/100,d=(1-Math.abs(2*h-1))*o,g=d*(1-Math.abs(e/60%2-1)),M=h-d/2;let u,S,x;u=0,S=d,x=g,i[r]=Math.floor((u+M)*255),i[r+1]=Math.floor((S+M)*255),i[r+2]=Math.floor((x+M)*255),i[r+3]=Math.min(255,n*3)}else i[r]=0,i[r+1]=0,i[r+2]=0,i[r+3]=255}s.putImageData(this.trailImageData,0,0),s.globalCompositeOperation="lighter",s.filter="blur(2px)",s.globalAlpha=.3,s.drawImage(this.canvas,0,0),s.filter="none",s.globalCompositeOperation="source-over",s.globalAlpha=1;for(const a of this.foodSources){const n=a.strength/c.foodStrength,r=.8+Math.sin(this.elapsedTime*5)*.2,l=c.foodRadius*n*r*.6,h=c.foodHue,o=s.createRadialGradient(a.x,a.y,0,a.x,a.y,l*2);o.addColorStop(0,`hsla(${h}, 100%, 70%, ${.6*n})`),o.addColorStop(.5,`hsla(${h}, 100%, 50%, ${.3*n})`),o.addColorStop(1,"transparent"),s.beginPath(),s.arc(a.x,a.y,l*2,0,Math.PI*2),s.fillStyle=o,s.fill(),s.beginPath(),s.arc(a.x,a.y,l*.4,0,Math.PI*2),s.fillStyle=`hsla(${h}, 100%, 80%, ${.9*n})`,s.fill()}s.font='10px "Fira Code", monospace',s.fillStyle="rgba(0, 255, 128, 0.5)",s.textAlign="right",s.fillText("CLICK TO FEED",this.width-15,this.height-15)}}function F(w){const s=new T(w);return s.start(),{stop:()=>s.stop(),game:s}}export{F as default};
