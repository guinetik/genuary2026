import{G as lt,P as rt,e as ct}from"./index-DTFuSMoL.js";const c={colonyCount:6,baseAgentsPerColony:5e3,baseArea:1920*1080,minAgentsPerColony:3e3,maxAgentsPerColony:15e3,moveSpeed:1,turnSpeed:.3,randomSteer:.05,sensorAngle:Math.PI/4,sensorDistance:9,trailWeight:5,decayRate:.96,trailScale:.55,ownTrailAttraction:1.5,enemyTrailRepulsion:3,starvationThreshold:.5,enemyDeathThreshold:10,deathCheckInterval:.2,deathChance:.1,enemyDeathChance:1,foodPerAgent:2,foodLifetime:10,colonyBaseHues:[0,35,120,180,240,300],hueVariation:20,saturation:100,lightness:60,brightnessScale:15};class L{constructor(t,s,e,n){this.x=t,this.y=s,this.angle=e,this.colonyId=n}}class ft{constructor(t,s,e,n){this.id=t,this.hue=s,this.startX=e,this.startY=n,this.agents=[],this.foodBank=0}}class gt extends lt{constructor(t){super(t),this.backgroundColor=null}init(){super.init(),rt.init(this.ctx),this.container=this.canvas.parentElement,this.container&&this.enableFluidSize(this.container);const t=this.width*this.height/c.baseArea;this.agentsPerColony=Math.floor(Math.min(c.maxAgentsPerColony,Math.max(c.minAgentsPerColony,c.baseAgentsPerColony*t))),console.log(`[Day09] Canvas: ${this.width}x${this.height}, agents/colony: ${this.agentsPerColony}`);const s=c.trailScale;this.trailWidth=Math.floor(this.width*s),this.trailHeight=Math.floor(this.height*s),this.trailScale=s,this.colonies=[],this.trailMaps=[],this.trailMapsNext=[];const e=this._getColonyStartPositions(c.colonyCount);this._shuffle(e);const n=c.colonyBaseHues.map(i=>{const a=(Math.random()-.5)*2*c.hueVariation;return(i+a+360)%360});this._shuffle(n);const h=Math.min(this.width,this.height)*.08;for(let i=0;i<c.colonyCount;i++){const a=n[i%n.length],l=e[i],r=new ft(i,a,l.x,l.y);for(let o=0;o<this.agentsPerColony;o++){const f=Math.random()*Math.PI*2,y=Math.sqrt(Math.random())*h,g=l.x+Math.cos(f)*y,d=l.y+Math.sin(f)*y,u=Math.random()*Math.PI*2;r.agents.push(new L(g,d,u,i))}this.colonies.push(r),this.trailMaps.push(new Float32Array(this.trailWidth*this.trailHeight)),this.trailMapsNext.push(new Float32Array(this.trailWidth*this.trailHeight))}this.trailImageData=this.ctx.createImageData(this.trailWidth,this.trailHeight),this.canvas.addEventListener("click",i=>{const a=this.canvas.getBoundingClientRect(),l=(i.clientX-a.left)*(this.width/a.width),r=(i.clientY-a.top)*(this.height/a.height);if(this.statsButton){const o=this.statsButton.x,f=this.statsButton.y,y=this.statsButton.width,g=this.statsButton.height;if(l>=o-y/2&&l<=o+y/2&&r>=f-g/2&&r<=f+g/2)return}if(this.showDataOverlay){this.showDataOverlay=!1,this.statsButton&&this.statsButton.toggle(!1);return}this._reinforceNearestColony(l,r)}),this._keyHandler=i=>{i.key==="r"||i.key==="R"?this._restart():(i.key==="i"||i.key==="I")&&(this.showPerformance=!this.showPerformance)},window.addEventListener("keydown",this._keyHandler),this.elapsedTime=0,this.frameCount=0,this.lastFpsTime=performance.now(),this.fps=60,this.updateTime=0,this.renderTime=0,this.lastDeathCheck=0,this.food=[],this._trailCanvas=document.createElement("canvas"),this._trailCanvas.width=this.trailWidth,this._trailCanvas.height=this.trailHeight,this._trailCtx=this._trailCanvas.getContext("2d"),this.showDataOverlay=!1,this.history=[],this.lastHistoryTime=0,this.historyInterval=.5,this.maxHistoryLength=120,this.showPerformance=!1,this.statsButton=new ct(this,{text:"[i]",x:this.width-22,y:22,width:36,height:36,font:'14px "Fira Code", monospace',startToggled:!1,onToggle:i=>{this.showDataOverlay=i}}),this.pipeline.add(this.statsButton)}_shuffle(t){for(let s=t.length-1;s>0;s--){const e=Math.floor(Math.random()*(s+1));[t[s],t[e]]=[t[e],t[s]]}return t}_getColonyStartPositions(t){const s=[];if(this.width-100*2,this.height-100*2,t<=4){const n=[{x:100,y:100},{x:this.width-100,y:100},{x:100,y:this.height-100},{x:this.width-100,y:this.height-100}];for(let h=0;h<t;h++)s.push(n[h])}else s.push({x:100,y:100}),s.push({x:this.width-100,y:100}),s.push({x:100,y:this.height-100}),s.push({x:this.width-100,y:this.height-100}),s.push({x:this.width/2,y:100}),s.push({x:this.width/2,y:this.height-100});return s}_restart(){for(let e=0;e<this.trailMaps.length;e++)this.trailMaps[e].fill(0);this.food=[];const t=Math.min(this.width,this.height)*.08,s=this._getColonyStartPositions(c.colonyCount);for(let e=0;e<this.colonies.length;e++){const n=this.colonies[e],h=s[e];n.agents=[],n.foodBank=0;for(let i=0;i<this.agentsPerColony;i++){const a=Math.random()*Math.PI*2,l=Math.sqrt(Math.random())*t,r=h.x+Math.cos(a)*l,o=h.y+Math.sin(a)*l,f=Math.random()*Math.PI*2;n.agents.push(new L(r,o,f,e))}}this.elapsedTime=0,this.history=[],this.lastHistoryTime=0}_reinforceNearestColony(t,s){if(this.colonies.length===0)return;let e=null,n=1/0;for(const i of this.colonies){if(i.agents.length===0)continue;let a=0,l=0;for(const o of i.agents)a+=o.x,l+=o.y;a/=i.agents.length,l/=i.agents.length;const r=Math.sqrt((t-a)**2+(s-l)**2);r<n&&(n=r,e=i)}if(!e||e.agents.length>=c.maxAgentsPerColony)return;const h=Math.min(500,c.maxAgentsPerColony-e.agents.length);for(let i=0;i<h;i++){const a=Math.random()*Math.PI*2,l=Math.random()*30,r=t+Math.cos(a)*l,o=s+Math.sin(a)*l;e.agents.push(new L(r,o,Math.random()*Math.PI*2,e.id))}}sampleTrail(t,s,e){const n=Math.floor(s*this.trailScale),h=Math.floor(e*this.trailScale);return n<0||n>=this.trailWidth||h<0||h>=this.trailHeight?0:this.trailMaps[t][h*this.trailWidth+n]}sampleEnemyTrails(t,s,e){const n=Math.floor(s*this.trailScale),h=Math.floor(e*this.trailScale);if(n<0||n>=this.trailWidth||h<0||h>=this.trailHeight)return 0;const i=h*this.trailWidth+n;let a=0;const l=this.trailMaps,r=l.length;for(let o=0;o<r;o++)if(o!==t){const f=l[o][i];f>a&&(a=f)}return a}depositTrail(t,s,e,n){const h=Math.floor(s*this.trailScale),i=Math.floor(e*this.trailScale);if(h<0||h>=this.trailWidth||i<0||i>=this.trailHeight)return;const a=i*this.trailWidth+h;this.trailMaps[t][a]=Math.min(255,this.trailMaps[t][a]+n)}processTrailMaps(){const t=this.trailWidth,s=this.trailHeight,e=c.decayRate,n=t*s;for(let h=0;h<this.trailMaps.length;h++){const i=this.trailMaps[h];for(let a=0;a<n;a++)i[a]*=e}}update(t){super.update(t),this.elapsedTime+=t;const s=performance.now();this.trailWidth,this.trailHeight;const e=c.sensorDistance,n=c.sensorAngle,h=c.turnSpeed,i=c.ownTrailAttraction,a=c.enemyTrailRepulsion,l=performance.now(),r=this.trailMaps,o=this.trailScale,f=this.trailWidth,y=this.trailHeight,g=r.length,d=this.width,u=this.height,p=c.moveSpeed,x=c.trailWeight,C=c.randomSteer;for(const P of this.colonies){const S=P.id,b=r[S],J=P.agents,st=J.length;for(let G=0;G<st;G++){const A=J[G],_=A.x,H=A.y,v=A.angle,it=Math.cos(v),et=Math.sin(v),ot=Math.cos(v-n),nt=Math.sin(v-n),at=Math.cos(v+n),ht=Math.sin(v+n),X=Math.floor((_+ot*e)*o),q=Math.floor((H+nt*e)*o);let K=0,I=0;if(X>=0&&X<f&&q>=0&&q<y){const M=q*f+X;K=b[M]*i;for(let m=0;m<g;m++)if(m!==S){const w=r[m][M];w>I&&(I=w)}I*=a}const R=K-I,j=Math.floor((_+it*e)*o),V=Math.floor((H+et*e)*o);let Z=0,W=0;if(j>=0&&j<f&&V>=0&&V<y){const M=V*f+j;Z=b[M]*i;for(let m=0;m<g;m++)if(m!==S){const w=r[m][M];w>W&&(W=w)}W*=a}const k=Z-W,U=Math.floor((_+at*e)*o),z=Math.floor((H+ht*e)*o);let tt=0,E=0;if(U>=0&&U<f&&z>=0&&z<y){const M=z*f+U;tt=b[M]*i;for(let m=0;m<g;m++)if(m!==S){const w=r[m][M];w>E&&(E=w)}E*=a}const F=tt-E,Q=(Math.random()-.5)*C;let T=v;k>R&&k>F?T+=Q:k<R&&k<F?T+=(Math.random()<.5?-1:1)*h+Q:R>F?T-=h:F>R?T+=h:T+=Q*2;const O=_+Math.cos(T)*p,$=H+Math.sin(T)*p;if(O<1||O>=d-1||$<1||$>=u-1)A.angle=Math.random()*Math.PI*2;else{A.x=O,A.y=$,A.angle=T;const M=Math.floor(O*o),m=Math.floor($*o);if(M>=0&&M<f&&m>=0&&m<y){const w=m*f+M;b[w]=Math.min(255,b[w]+x)}}}}performance.now()-l;const N=performance.now();this.processTrailMaps(),performance.now()-N;const Y=performance.now();this.lastDeathCheck+=t,this.lastDeathCheck>=c.deathCheckInterval&&(this.lastDeathCheck=0,this._processDeaths()),performance.now()-Y;const B=performance.now();if(this._processFood(),this._decayFood(),performance.now()-B,this.updateTime=performance.now()-s,this.elapsedTime-this.lastHistoryTime>=this.historyInterval){this.lastHistoryTime=this.elapsedTime;const P={};for(const S of this.colonies)P[S.id]=S.agents.length;this.history.push({time:this.elapsedTime,counts:P})}}_processDeaths(){const t=c.starvationThreshold,s=c.enemyDeathThreshold,e=c.deathChance,n=c.enemyDeathChance;for(const h of this.colonies)h.agents=h.agents.filter(i=>{const a=i.colonyId,l=this.sampleTrail(a,i.x,i.y);if(this.sampleEnemyTrails(a,i.x,i.y)>s&&Math.random()<n)return this.food.push({x:i.x,y:i.y,born:this.elapsedTime}),!1;const o=50;return!(i.x<o||i.x>this.width-o||i.y<o||i.y>this.height-o)&&l<t&&Math.random()<e?(this.food.push({x:i.x,y:i.y,born:this.elapsedTime}),!1):!0})}_decayFood(){const t=c.foodLifetime,s=this.elapsedTime;for(let e=this.food.length-1;e>=0;e--)s-this.food[e].born>t&&this.food.splice(e,1)}_processFood(){const t=this.food.length;if(t===0)return;const s=5,e=s*s,n=c.foodPerAgent,h=[];for(let i=t-1;i>=0;i--){const a=this.food[i],l=a.x,r=a.y;t:for(const o of this.colonies){const f=o.agents,y=f.length;for(let g=0;g<y;g+=10){const d=f[g],u=d.x-l,p=d.y-r;if(u*u+p*p<e){if(o.foodBank++,h.push(i),o.foodBank>=n&&f.length<c.maxAgentsPerColony){const C=Math.random()<.1,N=C?2:1,Y=C?1:n;for(let B=0;B<N;B++)f.push(new L(d.x,d.y,Math.random()*Math.PI*2,o.id));o.foodBank-=Y}break t}}}}for(const i of h)this.food.splice(i,1)}hslToRgb(t,s,e){s/=100,e/=100;const n=(1-Math.abs(2*e-1))*s,h=n*(1-Math.abs(t/60%2-1)),i=e-n/2;let a,l,r;return t<60?(a=n,l=h,r=0):t<120?(a=h,l=n,r=0):t<180?(a=0,l=n,r=h):t<240?(a=0,l=h,r=n):t<300?(a=h,l=0,r=n):(a=n,l=0,r=h),{r:Math.floor((a+i)*255),g:Math.floor((l+i)*255),b:Math.floor((r+i)*255)}}render(){const t=performance.now(),s=this.ctx;this.trailWidth,this.trailHeight;const e=this.trailImageData.data,n=c.saturation,h=c.lightness;for(let o=0;o<e.length;o+=4)e[o]=0,e[o+1]=0,e[o+2]=0,e[o+3]=255;for(let o=0;o<this.colonies.length;o++){const f=this.colonies[o],y=this.trailMaps[o],g=this.hslToRgb(f.hue,n,h);for(let d=0;d<y.length;d++){const u=y[d];if(u>.1){const p=d*4,x=Math.min(1,u/c.brightnessScale);e[p]=Math.min(255,e[p]+g.r*x),e[p+1]=Math.min(255,e[p+1]+g.g*x),e[p+2]=Math.min(255,e[p+2]+g.b*x)}}}if(this._trailCtx.putImageData(this.trailImageData,0,0),s.imageSmoothingEnabled=!0,s.imageSmoothingQuality="high",s.drawImage(this._trailCanvas,0,0,this.width,this.height),s.filter="blur(3px)",s.globalAlpha=.4,s.drawImage(this.canvas,0,0),s.filter="none",s.globalAlpha=1,this.food.length>0){s.fillStyle="#fff",s.shadowColor="#fff",s.shadowBlur=4;for(const o of this.food)s.fillRect(o.x-2,o.y-2,4,4);s.shadowBlur=0}this.renderTime=performance.now()-t,this.frameCount++;const i=performance.now();i-this.lastFpsTime>=1e3&&(this.fps=this.frameCount,this.frameCount=0,this.lastFpsTime=i),s.font='10px "Fira Code", monospace';const a=this.colonies.reduce((o,f)=>o+f.agents.length,0);if(this.showPerformance){const o=this.colonies.length*this.trailWidth*this.trailHeight*4*2/1048576;s.fillStyle="rgba(0, 0, 0, 0.7)",s.fillRect(10,this.height-70,130,65),s.fillStyle="#fff",s.textAlign="left",s.fillText(`FPS: ${this.fps}`,15,this.height-55),s.fillText(`UPDATE: ${this.updateTime.toFixed(1)}ms`,15,this.height-40),s.fillText(`RENDER: ${this.renderTime.toFixed(1)}ms`,15,this.height-25),s.fillText(`TRAIL MEM: ${o.toFixed(1)}MB`,15,this.height-10)}let l=this.colonies[0];for(const o of this.colonies)o.agents.length>l.agents.length&&(l=o);s.fillStyle="rgba(0, 0, 0, 0.85)",s.fillRect(this.width-230,this.height-45,220,40),s.textAlign="right",s.fillStyle="#fff",s.fillText(`${this.colonies.length} COLONIES · ${a} AGENTS · ${this.food.length} FOOD`,this.width-15,this.height-30);const r=`hsl(${l.hue}, 100%, 60%)`;s.fillStyle=r,s.fillText(`LEADING: ${l.agents.length} AGENTS`,this.width-15,this.height-15),this.showDataOverlay&&this._drawDataOverlay(s),this.statsButton&&this.statsButton.render()}_drawDataOverlay(t){t.fillStyle="rgba(0, 0, 0, 0.85)",t.fillRect(0,0,this.width,this.height);const s=40,e=this.width-s*2;this.height-s*2-60,t.font='16px "Fira Code", monospace',t.fillStyle="#fff",t.textAlign="center",t.textBaseline="top",t.fillText("COLONY POPULATIONS",this.width/2,s);const n=s+60,h=s+50,i=30,a=15,l=e-80;let r=0;for(const g of this.colonies)g.agents.length>r&&(r=g.agents.length);r=Math.ceil(r*1.05);const o=[...this.colonies].sort((g,d)=>d.agents.length-g.agents.length);for(let g=0;g<o.length;g++){const d=o[g],u=d.hue,p=d.agents.length,x=p/r*l,C=h+g*(i+a);t.fillStyle="rgba(255, 255, 255, 0.1)",t.fillRect(n,C,l,i),t.fillStyle=`hsl(${u}, 100%, 50%)`,t.fillRect(n,C,x,i),t.shadowColor=`hsl(${u}, 100%, 60%)`,t.shadowBlur=10,t.fillRect(n,C,x,i),t.shadowBlur=0,t.font='12px "Fira Code", monospace',t.fillStyle="#888",t.textAlign="right",t.textBaseline="middle",t.fillText(`#${g+1}`,n-10,C+i/2),t.font='14px "Fira Code", monospace',t.fillStyle="#fff",t.textAlign="left",t.fillText(p.toString(),n+x+10,C+i/2)}const f=this.colonies.reduce((g,d)=>g+d.agents.length,0);t.font='14px "Fira Code", monospace',t.fillStyle="#888",t.textAlign="center";const y=h+o.length*(i+a)+20;t.fillText(`TOTAL: ${f} AGENTS`,this.width/2,y)}}function mt(D){const t=new gt(D);return t.start(),{stop:()=>{t._keyHandler&&window.removeEventListener("keydown",t._keyHandler),t.stop()},game:t}}export{mt as default};
