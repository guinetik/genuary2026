import{G as A,P as O,C as D,j as $,c as X,U as T,b as Y,k as E,E as Z,M as G,l as k}from"./index-Bh0GMSTl.js";const c={star:{radius:80,temperature:25e3,activityLevel:.7,color:[.6,.8,1],rotationSpeed:.3},lattice:{nodeSize:1.5,rotationSpeed:.03,color:"#44aaff",layers:[{radius:140,count:80,size:1},{radius:160,count:120,size:1.5},{radius:180,count:100,size:1.25}]},streams:{particleCount:80,speed:100,innerColor:{r:150,g:200,b:255,a:.9}},ships:{count:15,size:4,speed:120,constructorSpeed:250,color:"#44ddbb",glowColor:"rgba(80, 220, 180, 0.8)",trailColor:"rgba(80, 200, 170, 0.4)"},stations:{count:5,orbitRadius:350},camera:{perspective:700,autoRotateSpeed:.08,friction:.92},phases:{intro:3,arrival:4,deployment:3,capitol:8},rocket:{bodyColor:"#663399",accentColor:"#ffcc00",thrustColor:"#ff8800",panelColor:"#8866ff",voxelSize:4},reveal:{staggerDelay:.008,annexStagger:1,shipSpawnInterval:.8},style:{bgColor:"#000",trailAlpha:.12},starfield:{count:250,radius:450,minSize:.5,maxSize:1.5,twinkleSpeed:1.5},wormhole:{radius:60,ringCount:5,particleCount:40,rotationSpeed:2,spawnTime:2.3,colors:{inner:"#aa88ff",outer:"#4488ff",particles:"#cc99ff"},fadeOutStart:.4,fadeOutEnd:.8}};function I(b,t){const i=[],e=Math.PI*(3-Math.sqrt(5));for(let a=0;a<b;a++){const s=1-a/(b-1)*2,r=Math.sqrt(1-s*s),n=e*a;i.push({x:Math.cos(n)*r*t,y:s*t,z:Math.sin(n)*r*t})}return i}function j(b,t,i,e,a){b.save(),b.translate(t,i),b.rotate(a),b.beginPath(),b.moveTo(e,0),b.lineTo(-e*.6,-e*.5),b.lineTo(-e*.3,0),b.lineTo(-e*.6,e*.5),b.closePath(),b.fillStyle=c.ships.color,b.fill(),b.beginPath(),b.arc(-e*.4,0,e*.3,0,Math.PI*2),b.fillStyle=c.ships.glowColor,b.fill(),b.restore()}class F{constructor(t,i,e){this.id=t,this.route=i,this.routeIndex=0,this.speed=e,this.active=!1,this.state="travel",this.stateTimer=0,this.orbitRadius=25+Math.random()*15,this.orbitSpeed=(Math.random()>.5?1:-1)*(.5+Math.random()*.8),this.orbitAngle=Math.random()*Math.PI*2,this.orbitTilt=(Math.random()-.5)*1,this.x=0,this.y=0,this.z=0,this.trail=[],this.angle=0}spawn(t,i,e){this.active=!0,this.x=t,this.y=i,this.z=e,this.state="travel",this.routeIndex=0,this.trail=[]}getCurrentTargetPos(){const t=this.route[this.routeIndex];return t.type==="station"?{x:t.target.x,y:t.target.y,z:t.target.z}:t.target}update(t){const i=this.getCurrentTargetPos();if(this.trail.push({x:this.x,y:this.y,z:this.z}),this.trail.length>25&&this.trail.shift(),this.state==="travel"){const e=i.x-this.x,a=i.y-this.y,s=i.z-this.z,r=Math.sqrt(e*e+a*a+s*s),n=this.route[this.routeIndex].type==="station"?this.orbitRadius:5;if(r<n+2)this.state="orbit",this.stateTimer=4+Math.random()*5,this.orbitAngle=Math.atan2(this.z-i.z,this.x-i.x);else{const o=this.speed*t;this.x+=e/r*o,this.y+=a/r*o,this.z+=s/r*o,this.angle=Math.atan2(a,e)}}else if(this.state==="orbit"){if(this.stateTimer-=t,this.stateTimer<=0){this.state="travel",this.routeIndex=(this.routeIndex+1)%this.route.length;return}this.orbitAngle+=this.orbitSpeed*t;const e=this.orbitRadius,a=Math.cos(this.orbitAngle)*e,s=Math.sin(this.orbitAngle)*e,r=Math.sin(this.orbitAngle)*Math.sin(this.orbitTilt)*e;this.x=i.x+a,this.y=i.y+r,this.z=i.z+s;const n=this.orbitAngle+.1*Math.sign(this.orbitSpeed),o=Math.cos(n)*e,h=Math.sin(n)*Math.sin(this.orbitTilt)*e;this.angle=Math.atan2(h-r,o-a)}}}class L{constructor(t){this.game=t,this.visible=!0,this.x=0,this.y=0,this.z=0,this.heading=0,this.panelDeployProgress=0,this.satelliteSeparation=0,this.disassembling=!1,this.disassemblyProgress=0,this.capitolTarget=null,this.voxels=[],this.panels=[],this.satellites=[],this.generateStarship()}setCapitolTarget(t,i,e){this.capitolTarget={x:t,y:i,z:e}}generateStarship(){var g,d,f,m,S;const t=(g=c.rocket)==null?void 0:g.voxelSize,i=(d=c.rocket)==null?void 0:d.bodyColor,e="#442266",a=(f=c.rocket)==null?void 0:f.accentColor,s=(m=c.rocket)==null?void 0:m.thrustColor,r=(S=c.rocket)==null?void 0:S.panelColor,n=(l,y,u,x,M=1)=>{const w=Math.random()*Math.PI*2,P=(Math.random()-.5)*Math.PI,v=80+Math.random()*120;return{lx:l*t,ly:y*t,lz:u*t,size:t*M,color:x,cube:new k(t*M,{camera:this.game.camera,faceColors:{front:x,back:x,left:x,right:x,top:x,bottom:x},stroke:"rgba(150, 100, 200, 0.4)"}),scatterVel:{x:Math.cos(w)*Math.cos(P)*v,y:Math.sin(P)*v,z:Math.sin(w)*Math.cos(P)*v},disassemblyOffset:{x:0,y:0,z:0},alpha:1}},o=[{x:-8,width:9},{x:-7,width:9},{x:-6,width:8},{x:-5,width:8},{x:-4,width:7},{x:-3,width:7},{x:-2,width:6},{x:-1,width:5},{x:0,width:5},{x:1,width:4},{x:2,width:4},{x:3,width:3},{x:4,width:3},{x:5,width:2},{x:6,width:2},{x:7,width:1},{x:8,width:1},{x:9,width:1},{x:10,width:.5}];for(const l of o){const y=l.width/2;for(let u=-Math.floor(y);u<=Math.floor(y);u++)this.voxels.push(n(l.x,0,u,i)),l.width>=5&&Math.abs(u)<y-1&&this.voxels.push(n(l.x,1,u,i,.9)),l.width>=4&&Math.abs(u)<y-.5&&this.voxels.push(n(l.x,-1,u,e,.9)),l.width>=7&&Math.abs(u)<y-1.5&&this.voxels.push(n(l.x,-2,u,e,.8))}for(let l=-4;l<=0;l++)for(let y=-1;y<=1;y++)this.voxels.push(n(l,2,y,i,.85));for(let l=-3;l<=-1;l++)this.voxels.push(n(l,3,0,a,.7));this.voxels.push(n(-2,4,0,a,.5));for(let l=-6;l<=6;l+=2){const y=o.findIndex(u=>u.x===l);if(y>=0){const u=Math.floor(o[y].width/2);this.voxels.push(n(l,0,u,a,.6)),this.voxels.push(n(l,0,-u,a,.6))}}for(let l=-4;l<=4;l++)this.voxels.push(n(-9,0,l,s,.8)),Math.abs(l)<3&&this.voxels.push(n(-9,-1,l,s,.7));for(let l=2;l<=6;l+=2)this.voxels.push(n(l,1,0,a,.5));const h=[-5,-4,-3,-2,-1,0,1,2];for(const l of h)this.panels.push({...n(l,0,5,r,.5),baseX:l*t,baseZ:5*t,side:1,deployOffset:4*t}),this.panels.push({...n(l,0,-5,r,.5),baseX:l*t,baseZ:-5*t,side:-1,deployOffset:4*t});const p=[{x:4,y:2,z:2,dir:{x:1,y:1,z:1}},{x:4,y:2,z:-2,dir:{x:1,y:1,z:-1}},{x:0,y:2,z:3,dir:{x:0,y:1,z:1}},{x:0,y:2,z:-3,dir:{x:0,y:1,z:-1}},{x:-4,y:2,z:3,dir:{x:-1,y:1,z:1}},{x:-4,y:2,z:-3,dir:{x:-1,y:1,z:-1}}];for(const l of p)this.satellites.push({...n(l.x,l.y,l.z,a,.6),baseX:l.x*t,baseY:l.y*t,baseZ:l.z*t,separationDir:l.dir})}setPosition(t,i,e){this.x=t,this.y=i,this.z=e}setHeading(t){this.heading=t}deployPanels(t){this.panelDeployProgress=Math.max(0,Math.min(1,t));for(const i of this.panels)i.lz=i.baseZ+i.side*i.deployOffset*this.panelDeployProgress}separateSatellites(t){if(this.satelliteSeparation=Math.max(0,Math.min(1,t)),!this.capitolTarget){for(const r of this.satellites){const n=this.satelliteSeparation;r.lx=r.baseX+r.separationDir.x*40*n,r.ly=r.baseY+r.separationDir.y*40*n,r.lz=r.baseZ+r.separationDir.z*40*n}return}const i=this.satellites.length,e=.6,a=(1-e)/Math.max(1,i-1);for(let s=0;s<i;s++){const r=this.satellites[s],n=s*a,o=n+e;let h=0;if(this.satelliteSeparation>=o?h=1:this.satelliteSeparation>n&&(h=(this.satelliteSeparation-n)/e),h>0&&!r.flightStartPos&&(r.flightStartPos={x:this.x+r.baseX,y:this.y+r.baseY,z:this.z+r.baseZ}),!r.flightStartPos){r.lx=r.baseX,r.ly=r.baseY,r.lz=r.baseZ,r.worldPos=null;continue}const p=h*h*(3-2*h),g=30,d=s/i*Math.PI*2,f=this.capitolTarget.x+Math.cos(d)*g,m=this.capitolTarget.y+10,S=this.capitolTarget.z+Math.sin(d)*g,l=r.flightStartPos.x+(f-r.flightStartPos.x)*p,y=r.flightStartPos.y+(m-r.flightStartPos.y)*p,u=r.flightStartPos.z+(S-r.flightStartPos.z)*p;r.worldPos={x:l,y,z:u},r.alpha=1}}startDisassembly(t,i=4){this.disassembling=!0,this.disassemblyStartTime=t,this.disassemblyDuration=i;const e=[...this.voxels,...this.panels,...this.satellites];for(let s=e.length-1;s>0;s--){const r=Math.floor(Math.random()*(s+1));[e[s],e[r]]=[e[r],e[s]]}const a=i/e.length;e.forEach((s,r)=>{s.hideTime=t+r*a,s.alpha=1})}updateDisassembly(t){if(!this.disassembling)return!0;const i=[...this.voxels,...this.panels,...this.satellites];let e=!0;for(const a of i)t>=a.hideTime?a.alpha=0:e=!1;return e?(this.disassembling=!1,this.visible=!1,!0):!1}update(t){this.disassembling&&this.updateDisassembly(t)}getRenderables(t){if(!this.visible)return;const i=Math.cos(this.heading),e=Math.sin(this.heading),a=s=>{var f,m,S;if(s.alpha<=0)return;const r=s.lx*i-s.lz*e,n=s.lx*e+s.lz*i,o=s.ly,h=this.x+r+(((f=s.disassemblyOffset)==null?void 0:f.x)||0),p=this.y+o+(((m=s.disassemblyOffset)==null?void 0:m.y)||0),g=this.z+n+(((S=s.disassemblyOffset)==null?void 0:S.z)||0),d=this.game.camera.project(h,p,g);t.push({type:"voxel",cube:s.cube,x:h,y:p,z:g,depth:d.z,scale:d.scale,revealScale:1,alpha:s.alpha})};for(const s of this.voxels)a(s);for(const s of this.panels)a(s);for(const s of this.satellites){if(s.alpha<=0)continue;let r,n,o;if(s.worldPos)r=s.worldPos.x,n=s.worldPos.y,o=s.worldPos.z;else{const p=s.lx*i-s.lz*e,g=s.lx*e+s.lz*i;r=this.x+p,n=this.y+s.ly,o=this.z+g}const h=this.game.camera.project(r,n,o);t.push({type:"voxel",cube:s.cube,x:r,y:n,z:o,depth:h.z,scale:h.scale,revealScale:1,alpha:s.alpha})}}}class V{constructor(t,i,e,a,s=!1,r=.03){this.game=t,this.id=i,this.orbitRadius=e,this.isCapitol=s,this.orbitSpeed=r,this.tilt=(Math.random()-.5)*.4,this.angle=a,this.rotation=Math.random()*Math.PI*2,this.rotationSpeed=.1+Math.random()*.1,this.baseRadius=s?16:4+Math.floor(Math.random()*2),this.voxelSize=s?5:4,this.voxels=[],this.generateCity(),this.updatePosition()}generateCity(){const t=this.baseRadius,i=this.voxelSize,e={capitol:{main:"#ffaa44",accent:"#ffcc88",dark:"#aa6600",glow:"#ffff00",stroke:"rgba(255, 200, 100, 0.4)"},annex:[{main:"#00ffaa",accent:"#44ffcc",dark:"#006644",glow:"#00ffff",stroke:"rgba(0, 255, 200, 0.4)"},{main:"#4488ff",accent:"#88aaff",dark:"#222266",glow:"#44ccff",stroke:"rgba(100, 150, 255, 0.4)"},{main:"#aa44ff",accent:"#cc88ff",dark:"#442244",glow:"#ff44ff",stroke:"rgba(180, 100, 255, 0.4)"},{main:"#44ff44",accent:"#88ff88",dark:"#224422",glow:"#00ff00",stroke:"rgba(100, 255, 100, 0.4)"}]},a=this.isCapitol?e.capitol:e.annex[this.id%e.annex.length],s=a.stroke,r=(d,f,m,S,l=1)=>{const y=this.voxels.length;this.voxels.push({lx:d*i,ly:f*i,lz:m*i,size:i*l,color:S,cube:new k(i*l,{camera:this.game.camera,faceColors:{front:S,back:S,left:S,right:S,top:S,bottom:S},stroke:s}),visible:!0,revealOrder:y,revealTime:0,revealScale:1})},n=this.isCapitol?12:5+Math.floor(Math.random()*3);for(let d=1;d<=n;d++){const f=d>n*.7?.7:1;r(0,-d,0,a.dark,f)}r(0,-(n+1),0,a.glow,.6);const o=this.isCapitol?6:2;for(let d=0;d<o;d++){const f=d/o*Math.PI*2,m=Math.round(Math.cos(f)*1.5),S=Math.round(Math.sin(f)*1.5);for(let l=2;l<=n*.6;l++)r(m,-l,S,a.dark,.6)}for(let d=-t;d<=t;d++)for(let f=-t;f<=t;f++){const m=d*d+f*f;m<=t*t&&(r(d,0,f,a.dark),Math.floor(Math.sqrt(Math.max(0,t*t-m))*.3)>0&&m>(t-2)*(t-2)&&r(d,-1,f,a.dark,.8))}for(let d=0;d<Math.PI*2;d+=.3){const f=Math.round(Math.cos(d)*t),m=Math.round(Math.sin(d)*t);Math.random()>.3&&r(f,1,m,a.accent,.5)}const h=new Map,p=this.isCapitol?7:2;for(let d=0;d<p;d++){const f=d/p*Math.PI*2+Math.random()*.5,m=Math.random()*t*.5,S=Math.round(Math.cos(f)*m),l=Math.round(Math.sin(f)*m),y=this.isCapitol?10+Math.floor(Math.random()*6):4+Math.floor(Math.random()*3);for(let u=-1;u<=1;u++)for(let x=-1;x<=1;x++){const M=S+u,w=l+x,P=`${M},${w}`;if(h.has(P)||M*M+w*w>t*t||Math.random()>.7)continue;const v=Math.max(1,y-Math.abs(u)-Math.abs(x)+Math.floor(Math.random()*2));for(let z=1;z<=v;z++){const R=z===v&&v>2?.7:.9;let C;z===v&&v>2?C=a.accent:z>v*.6?C=a.main:C=a.dark,r(M,z,w,C,R)}v>=y-1&&Math.random()>.5&&r(M,v+1,w,a.glow,.3),h.set(P,!0)}}const g=this.isCapitol?35:12;for(let d=0;d<g;d++){const f=Math.random()*Math.PI*2,m=.3*t+Math.random()*t*.6,S=Math.round(Math.cos(f)*m),l=Math.round(Math.sin(f)*m),y=`${S},${l}`;if(h.has(y)||S*S+l*l>t*t)continue;const u=this.isCapitol?2+Math.floor(Math.random()*4):1+Math.floor(Math.random()*2);for(let x=1;x<=u;x++){const M=x===u?a.main:a.dark;r(S,x,l,M,.8)}h.set(y,!0)}if(this.isCapitol){for(let f=1;f<=14;f++){const m=f<3?1.3:f>12?.5:.85;r(0,f,0,f===14?a.glow:a.main,m)}r(0,15,0,a.glow,.4)}}update(t){this.angle+=this.orbitSpeed*t,this.rotation+=this.rotationSpeed*t,this.updatePosition()}updatePosition(){this.x=Math.cos(this.angle)*this.orbitRadius,this.z=Math.sin(this.angle)*this.orbitRadius,this.y=Math.sin(this.angle*2)*Math.sin(this.tilt)*this.orbitRadius*.15}sortVoxelsForReveal(){let t=1/0;for(const e of this.voxels)e.ly<t&&(t=e.ly);for(const e of this.voxels){const a=e.ly-t,s=Math.sqrt(e.lx*e.lx+e.lz*e.lz);e.revealOrder=a*10+s*.5}[...this.voxels].sort((e,a)=>e.revealOrder-a.revealOrder).forEach((e,a)=>e.revealOrder=a)}startReveal(t,i=.02){this.sortVoxelsForReveal();for(const e of this.voxels)e.visible=!0,e.revealTime=t+e.revealOrder*i,e.revealScale=0}hideAll(){for(const t of this.voxels)t.visible=!1,t.revealScale=0}updateReveal(t){for(const i of this.voxels){if(!i.visible)continue;const e=t-i.revealTime;if(e<0){i.revealScale=0;continue}const a=G.spring(0,1,e,.3,!1,!1,{stiffness:.8,damping:.5});i.revealScale=Math.min(1,a.value)}}getRenderables(t){const i=Math.cos(this.rotation),e=Math.sin(this.rotation);for(const a of this.voxels){if(!a.visible||a.revealScale<=.01)continue;const s=a.lx*i-a.lz*e,r=a.lx*e+a.lz*i,n=-a.ly,o=this.x+s,h=this.y+n,p=this.z+r,g=this.game.camera.project(o,h,p);t.push({type:"voxel",cube:a.cube,x:o,y:h,z:p,depth:g.z,scale:g.scale,revealScale:a.revealScale})}}}class N extends A{constructor(t){super(t),this.backgroundColor=c.style.bgColor}init(){console.log("[Day08] init() called"),super.init(),O.init(this.ctx),this.time=0;const t=Math.min(this.width,this.height);this.scale=t/600,this.camera=new D({perspective:c.camera.perspective*this.scale,rotationX:.3,rotationY:0,autoRotate:!0,autoRotateSpeed:c.camera.autoRotateSpeed,inertia:!0,friction:c.camera.friction,sensitivity:.004}),this.camera.enableMouseControl(this.canvas),this.starfield=[];const i=c.starfield,e=I(i.count,i.radius*this.scale);for(const s of e)this.starfield.push({x:s.x,y:s.y,z:s.z,size:i.minSize+Math.random()*(i.maxSize-i.minSize),twinkleOffset:Math.random()*Math.PI*2,brightness:.3+Math.random()*.7});console.log("[STARFIELD] Created",this.starfield.length,"stars"),this.star=new $(c.star.radius*this.scale,{camera:this.camera,useShader:!0,shaderType:"star",shaderUniforms:{uStarColor:c.star.color,uTemperature:c.star.temperature,uActivityLevel:c.star.activityLevel,uRotationSpeed:c.star.rotationSpeed}}),this.latticeNodes=[];for(const s of c.lattice.layers){const r=I(s.count,s.radius*this.scale);for(const n of r)n.size=s.size,n.layer=s.radius,n.alpha=0,n.revealTime=0;this.latticeNodes.push(...r)}this.latticeRotation=0,this.latticeRevealing=!1,this.stations=[],this.createStations(this.scale),this.ships=[],this.createShips(this.scale),this.createEnergyStreams(this.scale),this.rocket=new L(this);const a=-800*this.scale;this.rocket.setPosition(a,0,0),this.rocket.setHeading(0),this.rocket.visible=!0,this.shipsActive=!1,this.energyParticlesActive=!1,this.latticeVisible=!1;for(const s of this.stations)s.hideAll();this.initStateMachine()}createShips(t){const i=c.lattice.layers[1].radius*t,e=c.stations.orbitRadius*t;for(let a=0;a<c.ships.count;a++){let s=[];const r=a%4;if(r===0){const n=this.stations[Math.floor(Math.random()*this.stations.length)],o=Math.random()*Math.PI*2,h={x:Math.cos(o)*i,y:(Math.random()-.5)*i*.4,z:Math.sin(o)*i};s=[{type:"station",target:n},{type:"space",target:h}]}else if(r===1){const n=this.stations[Math.floor(Math.random()*this.stations.length)];let o=this.stations[Math.floor(Math.random()*this.stations.length)];for(;n===o;)o=this.stations[Math.floor(Math.random()*this.stations.length)];s=[{type:"station",target:n},{type:"station",target:o}]}else if(r===2){const n=this.stations[Math.floor(Math.random()*this.stations.length)],o=this.stations[Math.floor(Math.random()*this.stations.length)],h=Math.random()*Math.PI*2,p={x:Math.cos(h)*e*1.2,y:(Math.random()-.5)*e*.5,z:Math.sin(h)*e*1.2};s=[{type:"station",target:n},{type:"space",target:p},{type:"station",target:o}]}else{const n=this.stations[Math.floor(Math.random()*this.stations.length)],o=Math.random()*Math.PI*2,h={x:Math.cos(o)*i*.5,y:(Math.random()-.5)*i*.2,z:Math.sin(o)*i*.5};s=[{type:"station",target:n},{type:"space",target:h}]}this.ships.push(new F(a,s,c.ships.speed*t*(.8+Math.random()*.4)))}}createStations(t){for(let e=0;e<c.stations.count;e++){const a=e===0;let s;if(a)s=Math.PI*.5;else{const h=e-1,p=c.stations.count-1;s=Math.PI*.5+(h+1)/(p+1)*Math.PI*2}const r=c.stations.orbitRadius*t,n=a?1:.85+Math.random()*.3,o=r*n;this.stations.push(new V(this,e,o,s,a,.025))}}createEnergyStreams(t){const i=a=>{const s=a.age/a.lifetime;a.color.r=Math.round(150+105*s),a.color.g=Math.round(200+0*s),a.color.b=Math.round(255+-155*s)};this.energyParticles=new X(this,{camera:this.camera,maxParticles:c.streams.particleCount,blendMode:"lighter",depthSort:!0,updaters:[T.velocity,T.lifetime,i,T.fadeOut,T.shrink(.3)]});const e=8;for(let a=0;a<e;a++){const s=a/e*Math.PI*2,r=Math.PI*.5+(Math.random()-.5)*.8,n={x:Math.sin(r)*Math.cos(s),y:Math.cos(r),z:Math.sin(r)*Math.sin(s)},o=c.star.radius*this.scale;this.energyParticles.addEmitter(`stream${a}`,new Y({rate:2,position:{x:n.x*o*1.2,y:n.y*o*1.2,z:n.z*o*1.2},velocity:{x:n.x*c.streams.speed*t,y:n.y*c.streams.speed*t,z:n.z*c.streams.speed*t},velocitySpread:{x:15,y:15,z:15},lifetime:{min:1.2,max:2},size:{min:2,max:4},color:c.streams.innerColor,shape:"circle"}))}}startLatticeReveal(t){this.latticeRevealing=!0,this.latticeVisible=!0;for(const h of this.latticeNodes)h.finalX=h.x,h.finalY=h.y,h.finalZ=h.z,h.flightProgress=0,h.flightStarted=!1;const i=[...this.latticeNodes].sort((h,p)=>h.layer!==p.layer?p.layer-h.layer:Math.random()-.5),e=4,a=.08,s=Math.max(...c.lattice.layers.map(h=>h.radius)),r=Math.min(...c.lattice.layers.map(h=>h.radius));let n=null,o=0;i.forEach(h=>{h.layer!==n&&(n=h.layer,o=0);const g=(s-h.layer)/(s-r||1)*e,d=o*a;h.revealTime=t+g+d,o++})}updateLatticeReveal(t){if(!this.latticeRevealing)return;let i=!0;const e=2.5,a=this.stations[0],s=Math.cos(this.latticeRotation),r=Math.sin(this.latticeRotation);for(const n of this.latticeNodes){if(n.flightProgress>=1)continue;const o=t-n.revealTime;if(o<0)n.alpha=0,n.flightProgress=0,n.x=a.x,n.y=a.y,n.z=a.z,i=!1;else{n.flightStarted||(n.flightStarted=!0,n.startX=a.x,n.startY=a.y,n.startZ=a.z);const h=n.finalX*s-n.finalZ*r,p=n.finalX*r+n.finalZ*s,g=n.finalY,d=Math.min(1,o/e),f=d*d*(3-2*d);n.flightProgress=d,n.x=n.startX+(h-n.startX)*f,n.y=n.startY+(g-n.startY)*f,n.z=n.startZ+(p-n.startZ)*f,n.alpha=Math.min(1,d*2),n.flightProgress<1&&(i=!1)}}i&&(this.latticeRevealing=!1)}updateConstructorShips(){if(!(!this.constructorShips||!this.constructorSpawningStarted)){if(this.nextConstructorSpawn<this.constructorShips.length&&this.time>=this.nextConstructorSpawnTime){const t=this.constructorShips[this.nextConstructorSpawn],i=this.ships[t.shipIndex],e=this.stations[0];i.route=[{type:"station",target:e},{type:"station",target:t.annex}],i.routeIndex=1,i.speed=c.ships.constructorSpeed*this.scale,i.spawn(e.x,e.y,e.z),console.log(`[FORGE STAR] Constructor ship ${this.nextConstructorSpawn} launched to Annex ${t.annexIndex}`),this.nextConstructorSpawn++,this.nextConstructorSpawnTime=this.time+c.reveal.annexStagger}for(const t of this.constructorShips){if(t.triggered)continue;const i=this.ships[t.shipIndex];if(i.active&&i.state==="orbit"&&i.routeIndex===1&&(t.arrived=!0,!t.triggered)){t.triggered=!0,console.log(`[FORGE STAR] Constructor arrived - building Annex ${t.annexIndex}`),t.annex.startReveal(this.time,c.reveal.staggerDelay),this.annexesBuilt=(this.annexesBuilt||0)+1;const e=(t.annexIndex-1)*this.voxelsPerAnnex,a=Math.min(e+this.voxelsPerAnnex,this.remainingShipVoxels.length);for(let s=e;s<a;s++)this.remainingShipVoxels[s]&&(this.remainingShipVoxels[s].alpha=0);this.nextConstructorSpawn>=this.constructorShips.length&&(this.nextShipSpawnTime=this.time+c.reveal.shipSpawnInterval)}}}}initStateMachine(){this.phaseTime=0;const t=this.stations[0];this.capitolOrbit={radius:t.orbitRadius,angle:t.angle};const i=t.orbitRadius*.85;this.shipOrbit={x:0,y:i*.9,z:i*.4},this.shipPath={startX:-350*this.scale,startY:50*this.scale,startZ:200*this.scale,endX:this.shipOrbit.x,endY:this.shipOrbit.y,endZ:this.shipOrbit.z},this.sceneFSM=E.fromSequence([{name:"intro",duration:c.phases.intro,enter:()=>{console.log("[FORGE STAR] Phase: INTRO"),this.phaseTime=0,this.rocket.visible=!1,this.wormhole=null,this.camera.autoRotateSpeed=c.camera.autoRotateSpeed*.2},update:e=>{this.phaseTime+=e}},{name:"arrival",duration:c.phases.arrival,enter:()=>{console.log("[FORGE STAR] Phase: ARRIVAL"),this.phaseTime=0,this.camera.autoRotateSpeed=c.camera.autoRotateSpeed*.3,this.rocket.visible=!1,this.wormhole={x:this.shipPath.startX,y:-this.shipPath.startY,z:this.shipPath.startZ,alpha:0,scale:0,rotation:0,active:!0,spawnTime:c.wormhole.spawnTime,particles:[]};const e=c.wormhole.particleCount;for(let a=0;a<e;a++){const s=a/e*Math.PI*2*3,r=a/e*c.wormhole.radius*this.scale;this.wormhole.particles.push({angle:s,dist:r,speed:.5+Math.random()*1.5,size:1+Math.random()*2})}},update:e=>{this.phaseTime+=e;const a=c.phases.arrival,s=c.wormhole.spawnTime;if(this.wormhole&&this.wormhole.active){this.wormhole.rotation+=c.wormhole.rotationSpeed*e;const u=this.phaseTime/a,x=Math.min(1,this.phaseTime/s);if(x<1){const M=x,w=Math.sin(M*Math.PI*1.5)*.2*(1-M);this.wormhole.scale=M+w,this.wormhole.alpha=M}else{this.wormhole.scale=1,this.rocket.visible||(this.rocket.visible=!0);const M=c.wormhole.fadeOutStart,w=c.wormhole.fadeOutEnd;u<M?this.wormhole.alpha=1:u>w?(this.wormhole.alpha=0,this.wormhole.active=!1):this.wormhole.alpha=1-(u-M)/(w-M)}for(const M of this.wormhole.particles)M.angle+=M.speed*e}const r=Math.max(0,this.phaseTime-s),n=a-s,o=Math.min(1,r/(n*.85)),h=Z.easeInOutCubic(o),p=this.shipPath.startX+(this.shipPath.endX-this.shipPath.startX)*h,g=this.shipPath.startZ+(this.shipPath.endZ-this.shipPath.startZ)*h,d=this.shipPath.startY+(this.shipPath.endY-this.shipPath.startY)*h,f=Math.sin(h*Math.PI)*this.shipOrbit.y*.3,m=-(d+f);this.rocket.setPosition(p,m,g);const S=this.shipPath.endX-this.shipPath.startX,l=this.shipPath.endZ-this.shipPath.startZ,y=Math.atan2(l,S);this.rocket.setHeading(y)}},{name:"deployment",duration:c.phases.deployment,enter:()=>{console.log("[FORGE STAR] Phase: DEPLOYMENT"),this.phaseTime=0,this.rocket.setPosition(this.shipOrbit.x,-this.shipOrbit.y,this.shipOrbit.z),this.rocket.setHeading(Math.PI/2);const e=this.stations[0];this.rocket.setCapitolTarget(e.x,e.y,e.z)},update:e=>{this.phaseTime+=e;const a=this.phaseTime/c.phases.deployment;this.rocket.setPosition(this.shipOrbit.x,-this.shipOrbit.y,this.shipOrbit.z),this.rocket.setHeading(Math.PI/2);const s=this.stations[0];this.rocket.setCapitolTarget(s.x,s.y,s.z),a<.5?this.rocket.deployPanels(a*2):(this.rocket.deployPanels(1),this.rocket.separateSatellites((a-.5)*2))}},{name:"capitol",duration:c.phases.capitol,enter:()=>{console.log("[FORGE STAR] Phase: CAPITOL"),this.phaseTime=0;const e=this.stations[0],a=e.voxels.length*c.reveal.staggerDelay+.5;this.capitolRevealDuration=a,this.capitolRevealStartTime=this.time,this.rocket.startDisassembly(this.time,a),e.startReveal(this.time,c.reveal.staggerDelay),this.startLatticeReveal(this.time);const s=this.stations.length-1;this.constructorShips=[],this.nextConstructorSpawn=0,this.constructorSpawningStarted=!1;for(let r=0;r<s;r++){const n=this.stations[r+1];this.constructorShips.push({shipIndex:r,annexIndex:r+1,annex:n,arrived:!1,triggered:!1})}this.remainingShipVoxels=this.rocket.voxels.filter(r=>r.alpha>0),this.voxelsPerAnnex=Math.ceil(this.remainingShipVoxels.length/s),this.shipsActive=!0,this.nextShipToSpawn=s,this.nextShipSpawnTime=1/0,this.annexesBuilt=0,this.camera.autoRotate=!1,this.cameraSwing={startRotationY:this.camera.rotationY,startRotationX:this.camera.rotationX,targetRotationX:.2,duration:3,elapsed:0,complete:!1}},update:e=>{if(this.phaseTime+=e,this.cameraSwing&&!this.cameraSwing.complete){this.cameraSwing.elapsed+=e;const s=Math.min(1,this.cameraSwing.elapsed/this.cameraSwing.duration),r=s<.5?4*s*s*s:1-Math.pow(-2*s+2,3)/2,n=this.stations[0],o=Math.atan2(n.x,n.z)+Math.PI;this.camera.rotationY=this.cameraSwing.startRotationY+(o-this.cameraSwing.startRotationY)*r,this.camera.rotationX=this.cameraSwing.startRotationX+(this.cameraSwing.targetRotationX-this.cameraSwing.startRotationX)*r,s>=1&&(this.cameraSwing.complete=!0,this.camera.autoRotate=!0,this.camera.autoRotateSpeed=c.camera.autoRotateSpeed*.3,console.log("[FORGE STAR] Camera swing complete - skyline view"))}this.rocket.updateDisassembly(this.time),this.stations[0].updateReveal(this.time),this.updateLatticeReveal(this.time),(this.time-this.capitolRevealStartTime)/this.capitolRevealDuration>=.5&&!this.constructorSpawningStarted&&(this.constructorSpawningStarted=!0,this.nextConstructorSpawnTime=this.time,console.log("[FORGE STAR] Capitol at 50% - starting constructor ships")),this.updateConstructorShips()}},{name:"empire",duration:null,enter:()=>{console.log("[FORGE STAR] Phase: EMPIRE"),this.phaseTime=0,this.constructorSpawningStarted||(this.constructorSpawningStarted=!0,this.nextConstructorSpawnTime=this.time),this.energyParticlesActive=!1,this.annexesBuilt=this.annexesBuilt||0,this.empireComplete=!1,this.starTransitionStartTime=null,this.camera.autoRotate=!0,this.camera.autoRotateSpeed=c.camera.autoRotateSpeed},update:e=>{if(this.phaseTime+=e,this.cameraSwing&&!this.cameraSwing.complete){this.cameraSwing.elapsed+=e;const s=Math.min(1,this.cameraSwing.elapsed/this.cameraSwing.duration),r=s<.5?4*s*s*s:1-Math.pow(-2*s+2,3)/2,n=this.stations[0],o=Math.atan2(n.x,n.z)+Math.PI;this.camera.rotationY=this.cameraSwing.startRotationY+(o-this.cameraSwing.startRotationY)*r,this.camera.rotationX=this.cameraSwing.startRotationX+(this.cameraSwing.targetRotationX-this.cameraSwing.startRotationX)*r,s>=1&&(this.cameraSwing.complete=!0,this.camera.autoRotate=!0,this.camera.autoRotateSpeed=c.camera.autoRotateSpeed)}for(const s of this.stations)s.updateReveal(this.time);this.updateConstructorShips();const a=this.stations.length-1;if(this.annexesBuilt>=a&&this.nextShipToSpawn<this.ships.length&&this.time>=this.nextShipSpawnTime){const s=this.stations[0];this.ships[this.nextShipToSpawn].spawn(s.x,s.y,s.z),this.nextShipToSpawn++,this.nextShipSpawnTime=this.time+c.reveal.shipSpawnInterval}if(!this.energyParticlesActive&&this.annexesBuilt>=a-1){console.log("[FORGE STAR] Energy harvesting begins"),this.energyParticlesActive=!0,this.pipeline.add(this.energyParticles);for(const[s,r]of Object.entries(this.energyParticles.emitters))r.active=!0}if(!this.empireComplete&&this.annexesBuilt>=a&&this.nextShipToSpawn>=this.ships.length&&(console.log("[FORGE STAR] Empire complete - star transforms"),this.empireComplete=!0,this.starTransitionStartTime=this.time),this.empireComplete){const r=this.time-this.starTransitionStartTime,n=Math.min(1,r/5),o=.6+(.7-.6)*n,h=.8+(.3-.8)*n,p=1;this.starColor={r:o,g:h,b:p},this.star&&this.star.setShaderUniforms&&this.star.setShaderUniforms({uStarColor:[o,h,p],uTime:this.time})}this.updateLatticeReveal(this.time)}}],{context:this,loop:!1})}update(t){if(super.update(t),this.time+=t,this.camera.update(t),this.sceneFSM.update(t),this.latticeRotation+=c.lattice.rotationSpeed*t,this.rocket&&this.rocket.visible&&this.rocket.update(t),this.shipsActive)for(const i of this.ships)i.active&&i.update(t);for(const i of this.stations)i.update(t);this.star&&this.star.setShaderUniforms&&this.star.setShaderUniforms({uTime:this.time})}render(){const t=this.ctx,i=this.width,e=this.height,a=i/2,s=e/2;t.fillStyle=`rgba(0, 0, 0, ${c.style.trailAlpha})`,t.fillRect(0,0,i,e);const r=[];for(const o of this.stations)o.getRenderables(r);this.rocket&&this.rocket.visible&&this.rocket.getRenderables(r);const n=this.camera.project(0,0,0);if(r.push({type:"star",x:n.x,y:n.y,z:n.z,scale:n.scale,depth:n.z}),this.wormhole&&this.wormhole.active&&this.wormhole.alpha>0){const o=this.camera.project(this.wormhole.x,this.wormhole.y,this.wormhole.z);r.push({type:"wormhole",x:o.x,y:o.y,z:o.z,scale:o.scale,depth:o.z,alpha:this.wormhole.alpha,spawnScale:this.wormhole.scale,rotation:this.wormhole.rotation,particles:this.wormhole.particles})}if(this.shipsActive)for(const o of this.ships){if(!o.active)continue;const h=this.camera.project(o.x,o.y,o.z);r.push({type:"ship",x:h.x,y:h.y,z:h.z,scale:h.scale,depth:h.z,angle:o.angle,trail:o.trail.map(p=>{const g=this.camera.project(p.x,p.y,p.z);return{x:g.x,y:g.y}})})}if(this.latticeVisible)for(const o of this.latticeNodes){if(o.alpha<=0)continue;let h,p,g;if(o.flightProgress<1)h=o.x,g=o.y,p=o.z;else{const f=Math.cos(this.latticeRotation),m=Math.sin(this.latticeRotation);h=o.finalX*f-o.finalZ*m,p=o.finalX*m+o.finalZ*f,g=o.finalY}const d=this.camera.project(h,g,p);r.push({type:"latticeNode",x:d.x,y:d.y,z:d.z,scale:d.scale,depth:d.z,nodeSize:o.size,alpha:o.alpha})}if(r.sort((o,h)=>h.depth-o.depth),super.render(),this.starfield&&this.starfield.length>0){t.save(),t.translate(a,s),t.fillStyle="#ffffff";for(const o of this.starfield){const h=this.camera.project(o.x,o.y,o.z);if(h.scale<=0)continue;const p=.5+.5*Math.sin(this.time*c.starfield.twinkleSpeed+o.twinkleOffset);t.globalAlpha=o.brightness*p,t.beginPath(),t.arc(h.x,h.y,o.size,0,Math.PI*2),t.fill()}t.globalAlpha=1,t.restore()}t.save(),t.translate(a,s);for(const o of r)if(!(o.scale<=0))switch(o.type){case"latticeNode":this.drawLatticeNode(t,o);break;case"ship":this.drawShipWithTrail(t,o);break;case"voxel":if(o.cube){o.cube.x=o.x,o.cube.y=o.y,o.cube.z=o.z;const h=o.revealScale!==void 0&&o.revealScale<1,p=o.alpha!==void 0&&o.alpha<1;if(h||p){if(t.save(),p&&(t.globalAlpha=Math.max(0,o.alpha)),h){const g=this.camera.project(o.x,o.y,o.z);t.translate(g.x,g.y),t.scale(o.revealScale,o.revealScale),t.translate(-g.x,-g.y)}o.cube.draw(),t.restore()}else o.cube.draw()}break;case"star":this.drawStarItem(t,o);break;case"wormhole":this.drawWormhole(t,o);break}t.restore()}drawWormhole(t,i){const e=i.spawnScale||1,a=c.wormhole.radius*this.scale*i.scale*e,s=c.wormhole.colors,r=c.wormhole.ringCount;t.save(),t.translate(i.x,i.y),t.globalAlpha=i.alpha,t.globalCompositeOperation="lighter";const n=t.createRadialGradient(0,0,a*.5,0,0,a*2);n.addColorStop(0,"rgba(68, 136, 255, 0.3)"),n.addColorStop(.5,"rgba(170, 136, 255, 0.15)"),n.addColorStop(1,"transparent"),t.fillStyle=n,t.beginPath(),t.arc(0,0,a*2,0,Math.PI*2),t.fill();for(let h=0;h<r;h++){const p=a*(.3+h/r*.7),g=i.rotation*(h%2===0?1:-.7)+h*Math.PI/r,d=.6-h/r*.3;t.save(),t.rotate(g);const f=8,m=.3;for(let S=0;S<f;S++){const l=S/f*Math.PI*2,y=l+Math.PI*2/f*(1-m);t.strokeStyle=h<r/2?s.inner:s.outer,t.lineWidth=2+(r-h)*.5,t.globalAlpha=i.alpha*d,t.beginPath(),t.arc(0,0,p,l,y),t.stroke()}t.restore()}t.globalAlpha=i.alpha*.8,t.fillStyle=s.particles;for(const h of i.particles){const p=Math.cos(h.angle)*h.dist,g=Math.sin(h.angle)*h.dist;t.beginPath(),t.arc(p,g,h.size*i.scale,0,Math.PI*2),t.fill()}const o=t.createRadialGradient(0,0,0,0,0,a*.4);o.addColorStop(0,"rgba(255, 255, 255, 0.9)"),o.addColorStop(.3,"rgba(200, 180, 255, 0.6)"),o.addColorStop(.7,"rgba(136, 100, 255, 0.3)"),o.addColorStop(1,"transparent"),t.globalAlpha=i.alpha,t.fillStyle=o,t.beginPath(),t.arc(0,0,a*.4,0,Math.PI*2),t.fill(),t.restore()}drawStarItem(t,i){const e=i.x,a=i.y,s=c.star.radius*this.scale*i.scale,r=this.time||0,n=this.starColor||{r:.6,g:.8,b:1},o=Math.floor(n.r*255),h=Math.floor(n.g*255),p=Math.floor(n.b*255),g=1+Math.sin(r*2)*.05+Math.sin(r*3.7)*.03;t.save(),t.globalCompositeOperation="lighter";const d=s*4*g,f=t.createRadialGradient(e,a,s*.5,e,a,d);f.addColorStop(0,`rgba(${o+50}, ${h+50}, ${p}, 0.15)`),f.addColorStop(.3,`rgba(${o}, ${h}, ${p}, 0.08)`),f.addColorStop(.6,`rgba(${Math.floor(o*.7)}, ${Math.floor(h*.7)}, ${p}, 0.03)`),f.addColorStop(1,"transparent"),t.fillStyle=f,t.beginPath(),t.arc(e,a,d,0,Math.PI*2),t.fill();const m=12;for(let w=0;w<m;w++){const P=w/m*Math.PI*2+r*.1,v=s*(1.5+Math.sin(r*2+w)*.5)*g,z=s*.15;t.save(),t.translate(e,a),t.rotate(P);const R=t.createLinearGradient(s*.8,0,s+v,0);R.addColorStop(0,`rgba(${o+80}, ${h+60}, ${p}, 0.4)`),R.addColorStop(.3,`rgba(${o+30}, ${h+30}, ${p}, 0.2)`),R.addColorStop(1,"transparent"),t.fillStyle=R,t.beginPath(),t.moveTo(s*.8,0),t.lineTo(s+v,-z*.3),t.lineTo(s+v,z*.3),t.closePath(),t.fill(),t.restore()}const S=s*2*g,l=t.createRadialGradient(e,a,0,e,a,S);l.addColorStop(0,`rgba(${o+100}, ${h+80}, ${p}, 0.5)`),l.addColorStop(.2,`rgba(${o+50}, ${h+50}, ${p}, 0.35)`),l.addColorStop(.5,`rgba(${o}, ${h}, ${p}, 0.15)`),l.addColorStop(1,"transparent"),t.fillStyle=l,t.beginPath(),t.arc(e,a,S,0,Math.PI*2),t.fill();const y=s*1.1,u=t.createRadialGradient(e,a,0,e,a,y);u.addColorStop(0,"rgba(255, 255, 255, 1)"),u.addColorStop(.3,`rgba(${o+100}, ${h+80}, ${p}, 0.95)`),u.addColorStop(.6,`rgba(${o+50}, ${h+50}, ${p}, 0.8)`),u.addColorStop(.85,`rgba(${o}, ${h}, ${p}, 0.6)`),u.addColorStop(1,`rgba(${Math.floor(o*.6)}, ${Math.floor(h*.6)}, ${p}, 0.3)`),t.fillStyle=u,t.beginPath(),t.arc(e,a,y,0,Math.PI*2),t.fill();const x=s*.4,M=t.createRadialGradient(e,a,0,e,a,x);M.addColorStop(0,"rgba(255, 255, 255, 1)"),M.addColorStop(.5,"rgba(255, 255, 255, 0.8)"),M.addColorStop(1,"rgba(230, 245, 255, 0.4)"),t.fillStyle=M,t.beginPath(),t.arc(e,a,x,0,Math.PI*2),t.fill(),t.restore(),this.star&&(t.save(),t.globalAlpha=.6,t.translate(e,a),t.scale(i.scale,i.scale),this.star.x=0,this.star.y=0,this.star.z=0,this.star.draw(),t.restore())}drawLatticeNode(t,i){const e=(i.nodeSize||c.lattice.nodeSize)*i.scale,a=i.alpha!==void 0?i.alpha:1;if(a<=0)return;t.save(),t.globalAlpha=a;const s=t.createRadialGradient(i.x,i.y,0,i.x,i.y,e*3);s.addColorStop(0,"rgba(100, 170, 255, 0.5)"),s.addColorStop(.4,"rgba(100, 170, 255, 0.15)"),s.addColorStop(1,"transparent"),t.fillStyle=s,t.beginPath(),t.arc(i.x,i.y,e*3,0,Math.PI*2),t.fill(),t.fillStyle=c.lattice.color,t.beginPath(),t.arc(i.x,i.y,e,0,Math.PI*2),t.fill(),t.restore()}drawShipWithTrail(t,i){if(i.trail.length>1){t.beginPath(),t.moveTo(i.trail[0].x,i.trail[0].y);for(let e=1;e<i.trail.length;e++)t.lineTo(i.trail[e].x,i.trail[e].y);t.strokeStyle=c.ships.trailColor,t.lineWidth=1.5,t.stroke()}j(t,i.x,i.y,c.ships.size*i.scale,i.angle)}}function B(b){console.log("[Day08] Initializing Forge Star...",b);const t=new N(b);return console.log("[Day08] Game created, starting..."),t.start(),console.log("[Day08] Game started"),{stop:()=>t.stop(),game:t}}export{B as default};
