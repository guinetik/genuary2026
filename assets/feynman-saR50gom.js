import{b as I,c as q,p as B,d as D,L as Q,Z as K,_ as Y,o as X,$ as A,G as $,P as G,C as W,ad as V,W as Z,ae as N,Y as j,e as H,E as F}from"./index-BHpYPlok.js";const _=`precision highp float;\r
\r
attribute vec2 aPosition;\r
attribute vec2 aUv;\r
\r
varying vec2 vUv;\r
\r
void main() {\r
    vUv = aUv;\r
    gl_Position = vec4(aPosition, 0.0, 1.0);\r
}\r
`,L=`/**\r
 * Feynman Plasma Background Shader with CMB Overlay\r
 *\r
 * Background: Perlin-based plasma (electron-photon plasma)\r
 * Overlay: XorDev's CMB plasma shader\r
 *\r
 * CMB shader from: x.com/XorDev/status/1894123951401378051\r
 */\r
\r
precision highp float;\r
\r
varying vec2 vUv;\r
\r
uniform float uTime;\r
uniform float uTemperature;      // 0-1, affects speed and intensity\r
uniform float uIntensity;        // Overall brightness (0-1)\r
uniform vec2 uResolution;\r
uniform float uSpaceSize;        // Current space expansion (0-1)\r
\r
// Manual tanh for GLSL ES 1.0 (WebGL 1.0 compatibility)\r
vec4 tanh(vec4 x) {\r
    vec4 exp2x = exp(2.0 * x);\r
    return (exp2x - 1.0) / (exp2x + 1.0);\r
}\r
\r
void main() {\r
    vec2 fragCoord = vUv * uResolution;\r
    float aspect = uResolution.x / uResolution.y;\r
\r
    // Check space bounds\r
    vec2 centered = (vUv - 0.5) * 2.0;\r
    centered.x *= aspect;\r
    vec2 spaceCheck = abs(centered) / vec2(aspect, 1.0);\r
    if (max(spaceCheck.x, spaceCheck.y) > uSpaceSize) {\r
        gl_FragColor = vec4(0.0);\r
        return;\r
    }\r
\r
    // Time scale based on temperature\r
    float timeScale;\r
    if (uTemperature > 0.1) {\r
        timeScale = 1.0 + (uTemperature - 0.1) * 1.1;  // 1.0 at 10%, 2.0 at 100%\r
    } else {\r
        timeScale = 0.3 + uTemperature * 7.0;  // 0.3 at 0%, 1.0 at 10%\r
    }\r
    float time = uTime * timeScale;\r
\r
    // Iterative UV distortion plasma\r
    vec2 uv = (fragCoord.xy / uResolution.xx - 0.5) * 8.0;\r
    vec2 uv0 = uv;\r
    float i0 = 1.0;\r
    float i1 = 1.0;\r
    float i2 = 1.0;\r
    float i4 = 0.0;\r
\r
    for (int s = 0; s < 7; s++) {\r
        vec2 r;\r
        r = vec2(cos(uv.y * i0 - i4 + time / i1), sin(uv.x * i0 - i4 + time / i1)) / i2;\r
        r += vec2(-r.y, r.x) * 0.3;\r
        uv.xy += r;\r
\r
        i0 *= 1.93;\r
        i1 *= 1.15;\r
        i2 *= 1.7;\r
        i4 += 0.05 + 0.1 * time * i1;\r
    }\r
\r
    // Black and white plasma (background)\r
    float intensity = sin(uv.x - time) * 0.5 + 0.5;\r
    intensity += sin(uv.y + time) * 0.5 + 0.5;\r
    intensity *= 0.5;\r
    vec3 bgColor = vec3(intensity);\r
\r
    // ============================================================\r
    // CMB PLASMA OVERLAY (XorDev's shader)\r
    // ============================================================\r
    \r
    // Centered, ratio corrected coordinates (matching original)\r
    vec2 r = uResolution.xy;\r
    vec2 p = (fragCoord + fragCoord - r) / r.y;\r
    \r
    // Z depth\r
    float z = 4.0 - 4.0 * abs(0.7 - dot(p, p));\r
    \r
    // Fluid coordinates\r
    vec2 f = p * z;\r
    \r
    // Iterator\r
    vec2 i = vec2(0.0);\r
    \r
    // CMB color output\r
    vec4 O = vec4(0.0);\r
    \r
    // Loop 8 times (matching XorDev's compact loop)\r
    for (float iter = 0.0; iter < 8.0; iter += 1.0) {\r
        i.y = iter + 1.0;\r
        \r
        // Color waves and line brightness (xyyx swizzle creates gradient)\r
        vec2 sinF = sin(f) + 1.0;  // Add 1.0 to vec2\r
        vec4 colorWave = vec4(sinF.x, sinF.y, sinF.y, sinF.x);  // xyyx swizzle\r
        O += colorWave * abs(f.x - f.y);  // Multiply vec4 by float\r
        \r
        // Add fluid waves\r
        f += cos(f.yx * i.y + i + time) / i.y + 0.7;\r
    }\r
    \r
    // Tonemap (keeping it neutral for white output)\r
    vec4 expArg = vec4(z) - 4.0;\r
    O = tanh(7.0 * exp(clamp(expArg, -10.0, 10.0)) / max(O, vec4(0.001)));\r
    \r
    // Convert to white/grayscale (average all channels)\r
    float cmbIntensity = (O.r + O.g + O.b + O.a) * 0.25;\r
    // Boost brightness significantly\r
    cmbIntensity = pow(cmbIntensity, 0.7) * 2.0;  // Gamma correction + 2x boost\r
    vec3 cmbWhite = vec3(cmbIntensity);\r
    \r
    // Blend white CMB over background\r
    vec3 color = mix(bgColor, cmbWhite, min(cmbIntensity, 1.0));\r
\r
    // Very smooth feathered vignette - starts early with gradual transition\r
    float dist = length(centered) / (max(aspect, 1.0) * uSpaceSize);\r
    // Start at 0.5, full black at 1.0 for extended feathering\r
    float vignette = 1.0 - smoothstep(0.5, 1.0, dist);\r
    vignette = pow(vignette, 1.5); // Power curve for even smoother, more natural falloff\r
    float falloff = vignette;\r
\r
    // Temperature affects visibility\r
    float tempFactor = 0.5 + uTemperature * 0.5;\r
\r
    // Brighter output\r
    float alpha = falloff * tempFactor * uIntensity * 0.6;\r
    gl_FragColor = vec4(color * 0.7, alpha);\r
}\r
`,c={QUARK:"quark",PROTON:"proton",NEUTRON:"neutron",HYDROGEN:"hydrogen",DEUTERIUM:"deuterium",HELIUM3:"helium3",HELIUM4:"helium4",PHOTON:"photon"},T={RED:"red",GREEN:"green",BLUE:"blue"};function J(S,e,s){return S!==e&&e!==s&&S!==s}const U={QUARK_TO_PROTON:{reactants:[c.QUARK,c.QUARK,c.QUARK],products:[c.PROTON],photonEnergy:.94,probability:.95,minEnergy:.001,tripleCollision:!0},QUARK_TO_NEUTRON:{reactants:[c.QUARK,c.QUARK,c.QUARK],products:[c.NEUTRON],photonEnergy:.94,probability:.95,minEnergy:.001,tripleCollision:!0},PROTON_NEUTRON_FUSION:{reactants:[c.PROTON,c.NEUTRON],products:[c.DEUTERIUM],photonEnergy:2.22,probability:.7,minEnergy:.05},DEUTERIUM_PROTON_FUSION:{reactants:[c.DEUTERIUM,c.PROTON],products:[c.HELIUM3],photonEnergy:5.49,probability:.04,minEnergy:.15},DEUTERIUM_NEUTRON_FUSION:{reactants:[c.DEUTERIUM,c.NEUTRON],products:[c.HELIUM3],photonEnergy:6.26,probability:.04,minEnergy:.15},HELIUM3_NEUTRON_FUSION:{reactants:[c.HELIUM3,c.NEUTRON],products:[c.HELIUM4],photonEnergy:20.58,probability:.02,minEnergy:.1},HELIUM3_PROTON_FUSION:{reactants:[c.HELIUM3,c.PROTON],products:[c.HELIUM4],photonEnergy:19.8,probability:.005,minEnergy:.4},DEUTERIUM_DEUTERIUM_FUSION_A:{reactants:[c.DEUTERIUM,c.DEUTERIUM],products:[c.HELIUM3,c.NEUTRON],photonEnergy:3.27,probability:.02,minEnergy:.25},DEUTERIUM_DEUTERIUM_FUSION_B:{reactants:[c.DEUTERIUM,c.DEUTERIUM],products:[c.HELIUM4],photonEnergy:23.8,probability:.002,minEnergy:.35}};class E{static attract(e,s,o=100,t=1){const i=s.x-e.x,r=s.y-e.y,a=(s.z||0)-(e.z||0),n=i*i+r*r+a*a,h=Math.sqrt(n)||t,l=Math.max(h,t),f=o/(l*l);return{fx:i/h*f,fy:r/h*f,fz:a/h*f,dist:h}}static checkCollision(e,s,o=1){const t=s.x-e.x,i=s.y-e.y,r=(s.z||0)-(e.z||0),a=Math.sqrt(t*t+i*i+r*r),n=((e.size||1)+(s.size||1))*o;return a<n?{dist:a,overlap:n-a,dx:t,dy:i,dz:r}:null}static elasticCollision(e,s,o,t=.9){const i=e.mass||1,r=s.mass||1,a=i+r,n=o.dist||1,h=o.dx/n,l=o.dy/n,f=o.dz/n,u=e.vx-s.vx,m=e.vy-s.vy,d=(e.vz||0)-(s.vz||0),y=u*h+m*l+d*f;if(y<0)return null;const p=-(1+t)*y/a;return{v1:{vx:e.vx+p*r*h,vy:e.vy+p*r*l,vz:(e.vz||0)+p*r*f},v2:{vx:s.vx-p*i*h,vy:s.vy-p*i*l,vz:(s.vz||0)-p*i*f}}}static boundsCollision(e,s,o=.9){const t=(e.size||1)/2;let i=!1;const r=s.minX+t,a=s.maxX-t,n=s.minY+t,h=s.maxY-t;return e.x<r?(e.x=r,e.vx<0&&(e.vx=-e.vx*o),i=!0):e.x>a&&(e.x=a,e.vx>0&&(e.vx=-e.vx*o),i=!0),e.y<n?(e.y=n,e.vy<0&&(e.vy=-e.vy*o),i=!0):e.y>h&&(e.y=h,e.vy>0&&(e.vy=-e.vy*o),i=!0),i}static createAttractUpdater(e,s=100){return(o,t)=>{const i=E.attract(o,e,s);o.vx+=i.fx*t,o.vy+=i.fy*t,o.vz=(o.vz||0)+i.fz*t}}static createMutualAttractionUpdater(e,s=100){return(o,t)=>{const i=e();for(const r of i){if(r===o||r.dead)continue;const a=E.attract(o,r,s);o.vx+=a.fx*t,o.vy+=a.fy*t,o.vz=(o.vz||0)+a.fz*t}}}static kineticEnergy(e){const s=(e.vx||0)**2+(e.vy||0)**2+(e.vz||0)**2;return .5*(e.mass||1)*s}static findReaction(e,s){for(const[o,t]of Object.entries(U)){const[i,r]=t.reactants;if(e===i&&s===r||e===r&&s===i)return{name:o,...t}}return null}static checkFusion(e,s,o){if(!e.type||!s.type)return null;const t=E.findReaction(e.type,s.type);if(!t)return null;const r=(E.kineticEnergy(e)+E.kineticEnergy(s))/1e4;if(r<t.minEnergy)return null;const a=Math.min(1,r/t.minEnergy-1)*.2,n=Math.min(.95,t.probability+a);return{reaction:t,probability:n,totalEnergy:r}}static performFusion(e,s,o){const{reaction:t}=o,i=[],r=e.mass||1,a=s.mass||1,n=r*e.vx+a*s.vx,h=r*e.vy+a*s.vy,l=r*(e.vz||0)+a*(s.vz||0),f=r+a,u=(e.x*r+s.x*a)/f,m=(e.y*r+s.y*a)/f,d=((e.z||0)*r+(s.z||0)*a)/f,y=Math.random()*Math.PI*2,p=200+t.photonEnergy*20,x=Math.cos(y)*p*.1,b=Math.sin(y)*p*.1,v=n-x,R=h-b,P=l;for(const z of t.products){const M=E.getMass(z);i.push({type:z,x:u,y:m,z:d,vx:v/M,vy:R/M,vz:P/M,mass:M,size:E.getSize(z),isNew:!0,lifetime:99999,stable:!0})}return i.push({type:c.PHOTON,x:u,y:m,z:d,originX:u,originY:m,originZ:d,vx:Math.cos(y)*p,vy:Math.sin(y)*p,vz:0,mass:0,size:2+t.photonEnergy*.3,energy:t.photonEnergy,isPhoton:!0,lifetime:.4}),i}static getMass(e){return{[c.QUARK]:.33,[c.PROTON]:1,[c.NEUTRON]:1,[c.HYDROGEN]:1,[c.DEUTERIUM]:2,[c.HELIUM3]:3,[c.HELIUM4]:4,[c.PHOTON]:0}[e]||1}static getSize(e){return{[c.QUARK]:3,[c.PROTON]:5,[c.NEUTRON]:5,[c.HYDROGEN]:5,[c.DEUTERIUM]:6,[c.HELIUM3]:7,[c.HELIUM4]:8,[c.PHOTON]:2}[e]||5}static getColor(e){return{[c.QUARK]:{r:255,g:255,b:255,a:1},[c.PROTON]:{r:255,g:255,b:255,a:1},[c.NEUTRON]:{r:90,g:90,b:90,a:1},[c.HYDROGEN]:{r:0,g:255,b:136,a:1},[c.DEUTERIUM]:{r:0,g:255,b:255,a:1},[c.HELIUM3]:{r:255,g:0,b:255,a:1},[c.HELIUM4]:{r:255,g:255,b:0,a:1},[c.PHOTON]:{r:255,g:255,b:255,a:1}}[e]||{r:255,g:255,b:255,a:1}}static getQCDColorValue(e){return{[T.RED]:{r:255,g:0,b:0,a:1},[T.GREEN]:{r:0,g:255,b:0,a:1},[T.BLUE]:{r:0,g:100,b:255,a:1}}[e]||{r:255,g:255,b:255,a:1}}static findTripleReaction(e){if(e.length!==3)return null;const s=e.map(o=>o.type).sort();for(const[o,t]of Object.entries(U)){if(!t.tripleCollision)continue;const i=[...t.reactants].sort();if(s.every((r,a)=>r===i[a]))return{name:o,...t}}return null}static checkTripleCollision(e,s,o=1.5){if(s.length<2)return null;s.sort((l,f)=>l.dist-f.dist);const t=s[0].p,i=s[1].p,r=30*o,a=s[0].dist,n=s[1].dist,h=Math.sqrt((i.x-t.x)**2+(i.y-t.y)**2+((i.z||0)-(t.z||0))**2);return a<r&&n<r&&h<r?[e,t,i]:null}static performTripleFusion(e,s){const o=[];let t=0,i=0,r=0,a=0,n=0,h=0,l=0;for(const b of e){const v=b.mass||1;l+=v,t+=v*b.vx,i+=v*b.vy,r+=v*(b.vz||0),a+=b.x*v,n+=b.y*v,h+=(b.z||0)*v}a/=l,n/=l,h/=l;const f=Math.random()*Math.PI*2,u=150+s.photonEnergy*30,m=Math.cos(f)*u*.1,d=Math.sin(f)*u*.1,y=t-m,p=i-d,x=r;for(const b of s.products){const v=E.getMass(b);o.push({type:b,x:a,y:n,z:h,vx:y/v,vy:p/v,vz:x/v,mass:v,size:E.getSize(b),isNew:!0,lifetime:99999,stable:!0})}return o.push({type:c.PHOTON,x:a,y:n,z:h,originX:a,originY:n,originZ:h,vx:Math.cos(f)*u,vy:Math.sin(f)*u,vz:0,mass:0,size:2+s.photonEnergy*.3,energy:s.photonEnergy,isPhoton:!0,lifetime:1}),o}static drawSquigglyLine(e,s,o,t,i,r=1.5,a=12,n=1){const h=t-s,l=i-o,f=Math.sqrt(h*h+l*l);if(f<3)return;const u=25;if(f>u){const v=u/f;s=t-h*v,o=i-l*v}const m=t-s,d=i-o,y=Math.sqrt(m*m+d*d),p=-d/y,x=m/y;e.beginPath(),e.strokeStyle=`rgba(255, 255, 150, ${n*.6})`,e.lineWidth=.8;const b=Math.max(8,Math.floor(y/2));for(let v=0;v<=b;v++){const R=v/b,P=s+m*R,z=o+d*R,M=Math.sin(R*Math.PI*2*a)*r,O=P+p*M,k=z+x*M;v===0?e.moveTo(O,k):e.lineTo(O,k)}e.stroke()}}const g={quarkCount:{mobile:150,tablet:450,desktop:1500},maxParticles:{mobile:300,tablet:800,desktop:3e3},quarkSpeed:150,startDelay:1,expansionDelay:-.1,expansionTime:.7,physicsDelay:1,flashDuration:1.5,webgl:{enabled:!0,shape:"circle-soft",blendMode:"normal",depthShading:!1,depthShadingMin:.3,depthShadingMax:1},initialSpaceSize:0,finalSpaceSize:1,initialTemp:1,coolingRate:.02,minTemp:.1,targetDHRatio:26/1e3,minHelium3:10,protonRatio:.88,thermalJitter:100,heatTransferRate:.2,heatTransferRange:30,confinement:{searchRadius:10,baseStrength:500,distanceScale:.5},hadronizationTemp:.3,hadronizationBoost:8,quarkMaxAge:8,coolingDuration:10,gasFormation:{enabled:!0,thermal:{buoyancy:150,sinking:100,neutralTemp:.5,deadZone:.1},clustering:{sameTypeAttraction:300,differentTypeRepulsion:50,clusterRadius:150},turbulence:{strength:30,frequency:2},damping:.992},fusionEffects:{maxConcurrent:5,particlesPerBurst:2,duration:.5,initialSpeed:800,minSize:3,maxSize:3,flashRadius:40,flashDuration:.2,maxFlashes:50,hadronizationColor:{r:100,g:255,b:255},nucleosynthesisColor:{r:255,g:100,b:255}},plasma:{intensity:.25,fadeInDuration:30}};class w{static createSpawnEmitter(){return new I({rate:0,position:{x:0,y:0,z:0},velocity:{x:0,y:0,z:0},velocitySpread:{x:0,y:0,z:0},lifetime:{min:999,max:999},size:{min:8,max:8},color:{r:255,g:255,b:255,a:1},shape:"glow"})}static createEmitter(e,s,o,t){return new I({rate:0,position:{x:0,y:0,z:0},spread:{x:0,y:0,z:0},velocity:{x:0,y:0,z:0},velocitySpread:{x:1,y:1,z:0},lifetime:{min:999,max:999},size:{min:t,max:t},color:o,shape:"glow"})}static create(e,s,o){return new q(e,{camera:s,maxParticles:o,depthSort:!1,useWebGL:g.webgl.enabled,webglShape:g.webgl.shape,webglBlendMode:g.webgl.blendMode,depthShading:g.webgl.depthShading,depthShadingMin:g.webgl.depthShadingMin,depthShadingMax:g.webgl.depthShadingMax,webglOffset:{x:e.width/2,y:e.height/2},updaters:[(t,i)=>{t.x+=t.vx*i,t.y+=t.vy*i,t.z=(t.z||0)+(t.vz||0)*i},(t,i)=>{t.isPhoton&&!t.stable&&(t.lifetime-=i,t.alpha=Math.max(0,t.lifetime/2),t.lifetime<=0&&(t.dead=!0)),t.isEffect&&(t.lifetime-=i,t.lifetime<=0&&(t.dead=!0)),t.age=(t.age||0)+i,t.dead&&(t.alpha=0,t.size=0)},(t,i,r)=>{if(!e.physicsEnabled||t.isPhoton||t.isEffect)return;const a=r.particles,n=t.type===c.QUARK,h=n?5e3:800,l=50,f=l*l;for(const u of a){if(u===t||u.dead||u.isPhoton||u.isEffect)continue;const m=u.x-t.x,d=u.y-t.y;if(m*m+d*d>f)continue;const p=n&&u.type===c.QUARK,x=p&&t.qcdColor!==u.qcdColor?1.5:1,b=p?h*x:800,v=E.attract(t,u,b,3);t.vx+=v.fx*i,t.vy+=v.fy*i}},(t,i,r)=>{if(!e.physicsEnabled||t.dead||t.type!==c.QUARK)return;const a=g.confinement,n=r.particles;let h=null,l=a.searchRadius*a.searchRadius;for(const f of n){if(f===t||f.dead||f.type!==c.QUARK)continue;const u=f.x-t.x,m=f.y-t.y,d=u*u+m*m;d<l&&(l=d,h=f)}if(h){const f=Math.sqrt(l),u=h.x-t.x,m=h.y-t.y,d=a.baseStrength+f*a.distanceScale;t.vx+=u/f*d*i,t.vy+=m/f*d*i}},(t,i,r)=>{if(!e.physicsEnabled||t.dead||t.type!==c.QUARK||e.reactionsThisFrame>=e.maxReactionsThisFrame||!e.canFuse())return;const a=r.particles.filter(f=>f!==t&&!f.dead&&f.type===c.QUARK);let n=25;e.universeTemp<g.hadronizationTemp&&(n*=g.hadronizationBoost);const h=[];for(const f of a){const u=f.x-t.x,m=f.y-t.y,d=(f.z||0)-(t.z||0),y=Math.sqrt(u*u+m*m+d*d);y<n&&h.push({p:f,dist:y})}const l=E.checkTripleCollision(t,h,4);if(l){const f=l[0].qcdColor,u=l[1].qcdColor,m=l[2].qcdColor;if(!J(f,u,m))return;const y=l.map(p=>p.id||r.particles.indexOf(p)).sort().join("-");if(!e.processedTriples.has(y)){e.processedTriples.add(y),e.reactionsThisFrame++;const p=Math.random()<g.protonRatio?U.QUARK_TO_PROTON:U.QUARK_TO_NEUTRON,x=E.performTripleFusion(l,p);e.spawnQueue.push(...x);const b=(l[0].x+l[1].x+l[2].x)/3,v=(l[0].y+l[1].y+l[2].y)/3;e.spawnFusionEffect(b,v,"hadron"),l.forEach(R=>R.dead=!0),p.products[0]}}},(t,i,r)=>{if(!e.physicsEnabled||t.isPhoton||t.isEffect||t.dead||t.type===c.QUARK||!e.canFuse())return;const a=r.particles;for(const n of a){if(n===t||n.dead||n.isPhoton||n.isEffect||n.type===c.QUARK)continue;const h=E.checkCollision(t,n,1);if(h){const l=E.checkFusion(t,n,h);if(l&&l.reaction.products.includes(c.DEUTERIUM)&&e.dhLimitReached){const d=E.elasticCollision(t,n,h,.9);d&&(t.vx=d.v1.vx,t.vy=d.v1.vy,n.vx=d.v2.vx,n.vy=d.v2.vy);continue}if((t.type===c.DEUTERIUM||n.type===c.DEUTERIUM)&&e.currentDHRatio<g.targetDHRatio){const d=E.elasticCollision(t,n,h,.9);d&&(t.vx=d.v1.vx,t.vy=d.v1.vy,n.vx=d.v2.vx,n.vy=d.v2.vy);continue}if(t.plotArmor||n.plotArmor){const d=E.elasticCollision(t,n,h,.9);d&&(t.vx=d.v1.vx,t.vy=d.v1.vy,n.vx=d.v2.vx,n.vy=d.v2.vy);continue}if(e.reactionsThisFrame>=e.maxReactionsThisFrame){const d=E.elasticCollision(t,n,h,.9);d&&(t.vx=d.v1.vx,t.vy=d.v1.vy,n.vx=d.v2.vx,n.vy=d.v2.vy);continue}if(l&&Math.random()<l.probability){e.reactionsThisFrame++;const d=E.performFusion(t,n,l);e.spawnQueue.push(...d);const y=(t.x+n.x)/2,p=(t.y+n.y)/2;e.spawnFusionEffect(y,p,"fusion"),t.dead=!0,n.dead=!0;return}const m=E.elasticCollision(t,n,h,.9);if(m){t.vx=m.v1.vx,t.vy=m.v1.vy,n.vx=m.v2.vx,n.vy=m.v2.vy;const d=h.overlap*.5,y=h.dist||1;t.x-=h.dx/y*d,t.y-=h.dy/y*d,n.x+=h.dx/y*d,n.y+=h.dy/y*d}}}},(t,i)=>{if(!t.isPhoton&&!t.isEffect){const r=e.getCurrentBounds(),a=.95+e.universeTemp*.05;E.boundsCollision(t,r,a)}},(t,i,r)=>{if(t.isPhoton||t.isEffect||t.dead)return;if(t.type===c.QUARK){t.temperature=g.initialTemp;const h=g.thermalJitter*t.temperature;t.vx+=(Math.random()-.5)*h*i*60,t.vy+=(Math.random()-.5)*h*i*60;return}t.temperature===void 0&&(t.temperature=e.universeTemp);const a=e.universeTemp-t.temperature;t.temperature+=a*.1;const n=g.thermalJitter*t.temperature;if(t.vx+=(Math.random()-.5)*n*i*60,t.vy+=(Math.random()-.5)*n*i*60,e.physicsEnabled){const h=r.particles,l=g.heatTransferRange*g.heatTransferRange;for(const f of h){if(f===t||f.dead||f.isPhoton||f.isEffect||f.temperature===void 0)continue;const u=f.x-t.x,m=f.y-t.y;if(u*u+m*m<l){const y=(f.temperature-t.temperature)*g.heatTransferRate*i;t.temperature+=y}}}},(t,i)=>{t.isPhoton||(t.vx=Math.max(-800,Math.min(800,t.vx)),t.vy=Math.max(-800,Math.min(800,t.vy)),e.dhLimitReached&&(t.vx*=.995,t.vy*=.995))},(t,i,r)=>{if(t.isPhoton||t.dead||!e.dhLimitReached)return;const a=r.particles,n=50,h=150,l=225,f=4e4;for(const u of a){if(u===t||u.dead||u.isPhoton)continue;const m=u.x-t.x,d=u.y-t.y,y=m*m+d*d;if(y<l||y>f)continue;const p=Math.sqrt(y),x=t.type===u.type,b=n+(x?h:0),v=(t.mass||1)*(u.mass||1),R=b*v/y;t.vx+=m/p*R*i,t.vy+=d/p*R*i}},(t,i,r)=>{if(!e.gasFormationEnabled||t.isPhoton||t.isEffect||t.dead||t.type===c.QUARK)return;const a=g.gasFormation.thermal,h=(t.temperature??.5)-a.neutralTemp;if(Math.abs(h)>a.deadZone){let l=0;h>0?l=-(h-a.deadZone)*a.buoyancy:l=(-h-a.deadZone)*a.sinking,t.vy+=l*i}},(t,i,r)=>{if(!e.gasFormationEnabled||t.isPhoton||t.isEffect||t.dead||t.type===c.QUARK)return;const a=g.gasFormation.clustering,n=r.particles,h=a.clusterRadius*a.clusterRadius;for(const l of n){if(l===t||l.dead||l.isPhoton||l.isEffect||l.type===c.QUARK)continue;const f=l.x-t.x,u=l.y-t.y,m=f*f+u*u;if(m>h||m<100)continue;const d=Math.sqrt(m);if(t.type===l.type){const p=a.sameTypeAttraction/m;t.vx+=f/d*p*i,t.vy+=u/d*p*i}else{const p=a.differentTypeRepulsion/m;t.vx-=f/d*p*i,t.vy-=u/d*p*i}}},(t,i,r)=>{if(!e.gasFormationEnabled||t.isPhoton||t.isEffect||t.dead||t.type===c.QUARK)return;const a=g.gasFormation.turbulence,n=e.elapsedTime*a.frequency,h=Math.sin(n+t.x*.01)*Math.cos(n*.7+t.y*.01),l=Math.cos(n+t.y*.01)*Math.sin(n*.8+t.x*.01);t.vx+=h*a.strength*i,t.vy+=l*a.strength*i;const f=g.gasFormation.damping;t.vx*=f,t.vy*=f},(t,i,r)=>{if(!e.physicsEnabled||t.dead||t.type!==c.QUARK)return;const a=t.age||0;if(a<g.quarkMaxAge)return;const n=r.particles.filter(x=>!x.dead&&x.type===c.QUARK);if(n.length===3&&n[0]===t&&e.canFuse()){n[0].dead=!0,n[1].dead=!0,n[2].dead=!0,e.reactionsThisFrame++;const x=Math.random()<g.protonRatio?U.QUARK_TO_PROTON:U.QUARK_TO_NEUTRON,b=E.performTripleFusion(n,x);e.spawnQueue.push(...b);return}if(t.seekDelay===void 0&&(t.seekDelay=Math.random()*5),a<g.quarkMaxAge+t.seekDelay)return;const h=n.filter(x=>x!==t),l=t.qcdColor,f=[T.RED,T.GREEN,T.BLUE].filter(x=>x!==l);let u=null,m=null,d=1/0,y=1/0;for(const x of h){const b=x.x-t.x,v=x.y-t.y,R=Math.sqrt(b*b+v*v);x.qcdColor===f[0]&&R<d?(d=R,u=x):x.qcdColor===f[1]&&R<y&&(y=R,m=x)}const p=50;if(u){const x=u.x-t.x,b=u.y-t.y,v=Math.sqrt(x*x+b*b);v>1&&(t.vx+=x/v*p*i,t.vy+=b/v*p*i)}if(m){const x=m.x-t.x,b=m.y-t.y,v=Math.sqrt(x*x+b*b);v>1&&(t.vx+=x/v*p*i,t.vy+=b/v*p*i)}}]})}}const C={quark:{r:255,g:68,b:68},proton:{r:255,g:255,b:255},neutron:{r:153,g:153,b:153},deuterium:{r:0,g:255,b:255},helium3:{r:255,g:0,b:255},helium4:{r:255,g:255,b:0}};class tt extends B{constructor(e,s={}){const o=D.isMobile,t=o?320:420,i=o?480:520;super(e,{width:t,height:i,...s}),this.dialogWidth=t,this.dialogHeight=i,this.fontSize=o?10:12,this.lineHeight=o?16:20,this.x=e.width/2,this.y=e.height/2,this.visible=!1,this._createUI()}_createUI(){const{dialogWidth:e,dialogHeight:s,fontSize:o,lineHeight:t}=this,i=new Q({width:e,height:s,color:"rgba(0, 0, 0, 0.95)",stroke:"#555",lineWidth:2}),r=K.create(this.game,i,{name:"helpBackground"});this.add(r);const a=new Y(this.game,{spacing:4,padding:15,width:e,height:s,scrollable:!0,viewportHeight:s-30});this.add(a);const n=(l,f="#ccc",u=!1)=>{const m=new A(this.game,l,{font:`${u?"bold ":""}${o}px monospace`,color:f,align:"left",baseline:"middle"});a.add(m)},h=()=>{const l=new A(this.game," ",{font:`${o*.5}px monospace`,color:"transparent"});a.add(l)};n("BIG BANG NUCLEOSYNTHESIS","#0f0",!0),h(),n("PHASE 1: QUARK EPOCH","#fff",!0),n("The universe begins as a hot quark soup.","#aaa"),n("Quarks carry QCD color charge:","#aaa"),n("  • Red, Green, Blue quarks","#888"),n("Quarks cannot exist alone (confinement).","#aaa"),h(),n("PHASE 2: HADRONIZATION","#0ff",!0),n("As the universe cools, quarks combine:","#aaa"),n("  R + G + B → Hadron (white)","#888"),n("  • Proton (white) - 88%","#fff"),n("  • Neutron (gray) - 12%","#999"),h(),n("PHASE 3: NUCLEOSYNTHESIS","#f0f",!0),n("Protons and neutrons fuse into nuclei:","#aaa"),n("  p + n → Deuterium (cyan)","#0ff"),n("  D + p → Helium-3 (magenta)","#f0f"),n("  D + D → Helium-4 (yellow)","#ff0"),n("  He3 + n → Helium-4 (yellow)","#ff0"),h(),n("PHASE 4: GAS FORMATION","#f0f",!0),n("As the universe cools further:","#aaa"),n("  • Particles cluster by type","#888"),n("  • Hot gas rises, cold sinks","#888"),n("  • Primordial gas clouds form","#888"),h(),n("PRIMORDIAL ABUNDANCES","#0f0",!0),n("After ~20 minutes, nucleosynthesis ends:","#aaa"),n("  • ~75% Hydrogen (protons)","#fff"),n("  • ~25% Helium-4","#ff0"),n("  • Trace D, He-3","#888"),h(),n("CONTROLS","#0f0",!0),n("  [R] Restart simulation","#888"),n("  [?] Toggle this help","#888"),n("  [i] Toggle data overlay","#888"),h(),n("Click anywhere to close","#555")}toggle(e){e===void 0?this.visible=!this.visible:this.visible=e}}class et extends X{constructor(e,s={}){super(e,s),this.visible=!1,this._stats={history:[],counts:{quarks:0,protons:0,neutrons:0,deuterium:0,helium3:0,helium4:0},dhRatio:0,dhLimitReached:!1}}updateStats(e){e.history!==void 0&&(this._stats.history=e.history),e.counts!==void 0&&(this._stats.counts=e.counts),e.dhRatio!==void 0&&(this._stats.dhRatio=e.dhRatio),e.dhLimitReached!==void 0&&(this._stats.dhLimitReached=e.dhLimitReached)}toggle(e){e===void 0?this.visible=!this.visible:this.visible=e}render(){if(!this.visible)return;const e=this.game.ctx,s=this.game.width,o=this.game.height;e.fillStyle="rgba(0, 0, 0, 0.88)",e.fillRect(0,0,s,o);const t=40,i=s-t*2|0,r=(o-t*3.5)/2|0;e.font="bold 16px monospace",e.fillStyle="#fff",e.textAlign="center",e.textBaseline="top",e.fillText("BIG BANG NUCLEOSYNTHESIS",s/2|0,15),this._drawEvolutionChart(e,t,t+25|0,i,r),this._drawCompositionBars(e,t,t+r+50|0,i,r-30),e.font="11px monospace",e.fillStyle="rgba(255, 255, 255, 0.5)",e.textAlign="center",e.fillText("click anywhere to close",s/2|0,o-15|0)}_drawEvolutionChart(e,s,o,t,i){s=s|0,o=o|0,t=t|0,i=i|0;const r=this._stats.history;if(e.fillStyle="rgba(255, 255, 255, 0.05)",e.fillRect(s,o,t,i),e.font="12px monospace",e.fillStyle="#888",e.textAlign="left",e.textBaseline="top",e.fillText("Particle Evolution",s,o-15),r.length<2){e.fillStyle="#444",e.textAlign="center",e.fillText("Collecting data...",s+t/2|0,o+i/2|0);return}let a=1;for(const n of r)a=Math.max(a,n.quarks,n.protons+n.neutrons,n.deuterium+n.helium3+n.helium4);e.strokeStyle="rgba(255, 255, 255, 0.1)",e.lineWidth=1;for(let n=0;n<=4;n++){const h=o+i-n/4*i|0;e.beginPath(),e.moveTo(s,h+.5),e.lineTo(s+t,h+.5),e.stroke()}this._drawChartLine(e,s,o,t,i,a,r.map(n=>n.quarks),"#ff4444"),this._drawChartLine(e,s,o,t,i,a,r.map(n=>n.protons+n.neutrons),"#ffffff"),this._drawChartLine(e,s,o,t,i,a,r.map(n=>n.deuterium+n.helium3+n.helium4),"#00ffff"),e.font="10px monospace",e.textAlign="right",e.fillStyle="#ff4444",e.fillText("■ Quarks",s+t-120|0,o-15),e.fillStyle="#ffffff",e.fillText("■ Hadrons",s+t-60|0,o-15),e.fillStyle="#00ffff",e.fillText("■ Nuclei",s+t,o-15),e.fillStyle="#666",e.textAlign="right",e.fillText(a.toString(),s-5,o),e.fillText("0",s-5,o+i)}_drawChartLine(e,s,o,t,i,r,a,n){e.strokeStyle=n,e.lineWidth=2,e.beginPath();let h=!1;for(let l=0;l<a.length;l++){const f=a[l],u=s+l/(a.length-1)*t,m=o+i-f/r*i;h?e.lineTo(u,m):(e.moveTo(u,m),h=!0)}e.stroke()}_drawCompositionBars(e,s,o,t,i){s=s|0,o=o|0,t=t|0,i=i|0;const r=this._stats.counts;e.fillStyle="rgba(255, 255, 255, 0.05)",e.fillRect(s,o,t,i),e.font="12px monospace",e.fillStyle="#888",e.textAlign="left",e.textBaseline="top",e.fillText("Current Composition",s,o-15);const a=[{key:"quarks",label:"Quark",color:C.quark},{key:"protons",label:"p",color:C.proton},{key:"neutrons",label:"n",color:C.neutron},{key:"deuterium",label:"D",color:C.deuterium},{key:"helium3",label:"He3",color:C.helium3},{key:"helium4",label:"He4",color:C.helium4}];let n=1;for(const u of a)n=Math.max(n,r[u.key]||0);const h=Math.min(60,(t-20)/a.length-10)|0,l=(t-h*a.length)/(a.length+1)|0;for(let u=0;u<a.length;u++){const m=a[u],d=r[m.key]||0,y=s+l+u*(h+l)|0,p=d/n*(i-30)|0;e.fillStyle=`rgb(${m.color.r}, ${m.color.g}, ${m.color.b})`,e.fillRect(y,o+i-20-p,h,p),e.font="10px monospace",e.fillStyle=`rgb(${m.color.r}, ${m.color.g}, ${m.color.b})`,e.textAlign="center",e.fillText(m.label,y+h/2|0,o+i-8),p>15&&(e.font="9px monospace",e.fillStyle="#fff",e.fillText(d.toString(),y+h/2|0,o+i-25-p))}const f=(this._stats.dhRatio*1e3).toFixed(1);e.font="12px monospace",e.fillStyle=this._stats.dhLimitReached?"#0f0":"#0ff",e.textAlign="right",e.fillText(`D/H: ${f}/1000 (target: 26)`,s+t,o-15)}}class it extends ${constructor(e){super(e),this.backgroundColor=null,this.nextParticleId=0,this.elapsedTime=0,this.physicsEnabled=!1,this.universeTemp=g.initialTemp,this.spaceSize=g.initialSpaceSize,this.cleanupTimer=0,this.currentDHRatio=0,this.dhLimitReached=!1,this.he3PlotArmorCount=0,this.flashIntensity=1,this.hadronizationComplete=!1,this.nucleosynthesisComplete=!1,this.coolingStartTime=null,this.gasFormationEnabled=!1,this.flashEffects=[],this.flashPool=[];for(let s=0;s<g.fusionEffects.maxFlashes;s++)this.flashPool.push({active:!1,x:0,y:0,age:0,color:null});this._flashCache=new Map,this.plasmaRenderer=null,this.plasmaFadeIn=0,this.bangStarted=!1,this.history=[],this.lastHistoryTime=0,this.dataButton=null,this.dataDialog=null,this.universeMask=null}spawnFusionEffect(e,s,o="fusion"){if(o==="hadron"&&Math.random()>.2)return;const t=g.fusionEffects,i=o==="hadron"?t.hadronizationColor:t.nucleosynthesisColor,r=this.flashPool.find(a=>!a.active);r&&(r.active=!0,r.x=e,r.y=s,r.age=0,r.color=i,this.flashEffects.push(r));for(let a=0;a<t.particlesPerBurst;a++){const n=a/t.particlesPerBurst*Math.PI*2+(Math.random()-.5)*.5,h=t.initialSpeed*(.7+Math.random()*.6),l=t.duration*(.7+Math.random()*.6),f=t.minSize+Math.random()*(t.maxSize-t.minSize);this.spawnParticle({type:"effect",x:e,y:s,z:0,vx:Math.cos(n)*h,vy:Math.sin(n)*h,vz:0,size:f,lifetime:l,mass:0,isEffect:!0,effectColor:{r:i.r,g:i.g,b:i.b}})}}updateFusionEffects(e){const s=g.fusionEffects;for(let o=this.flashEffects.length-1;o>=0;o--){const t=this.flashEffects[o];t.age+=e,t.age>=s.flashDuration&&(t.active=!1,this.flashEffects.splice(o,1))}}_getFlashCanvas(e,s,o){const t=`${e},${s},${o}`;if(this._flashCache.has(t))return this._flashCache.get(t);const i=g.fusionEffects.flashRadius*2,r=document.createElement("canvas");r.width=i,r.height=i;const a=r.getContext("2d"),n=i/2,h=a.createRadialGradient(n,n,0,n,n,i/2);return h.addColorStop(0,`rgb(${e}, ${s}, ${o})`),h.addColorStop(.3,`rgba(${e}, ${s}, ${o}, 0.6)`),h.addColorStop(1,`rgba(${e}, ${s}, ${o}, 0)`),a.fillStyle=h,a.fillRect(0,0,i,i),this._flashCache.set(t,r),r}renderFusionEffects(){if(this.flashEffects.length===0)return;const e=this.ctx,s=this.width/2,o=this.height/2,t=g.fusionEffects,i=t.flashRadius*2;e.save(),e.globalCompositeOperation="lighter";for(const r of this.flashEffects){const a=r.age/t.flashDuration,n=1-a,h=.3+a*.7;if(n<=0)continue;const{r:l,g:f,b:u}=r.color,m=this._getFlashCanvas(l,f,u),d=s+r.x,y=o+r.y,p=i*h;e.globalAlpha=n,e.drawImage(m,d-p/2,y-p/2,p,p)}e.globalAlpha=1,e.restore()}renderPlasmaLayer(){if(!this.plasmaRenderer||!this.plasmaRenderer.isAvailable()||this.plasmaFadeIn<=0)return;(this.plasmaRenderer.width!==this.width||this.plasmaRenderer.height!==this.height)&&this.plasmaRenderer.resize(this.width,this.height),this.plasmaRenderer.useProgram("plasma",_,L),this.plasmaRenderer.setUniforms({uTime:this.elapsedTime,uTemperature:this.universeTemp,uIntensity:g.plasma.intensity*this.plasmaFadeIn,uResolution:[this.width,this.height],uSpaceSize:this.spaceSize}),this.plasmaRenderer.clear(0,0,0,0),this.plasmaRenderer.render();const e=this.ctx;e.save(),e.globalAlpha=this.plasmaFadeIn,e.globalCompositeOperation="overlay",this.plasmaRenderer.compositeOnto(e,0,0),e.restore()}updateDHRatio(){const e=this.particles.particles;let s=0,o=0;for(const t of e)t.dead||(t.type===c.PROTON?s++:t.type===c.DEUTERIUM&&o++);this.currentDHRatio=s>0?o/s:0,!this.dhLimitReached&&this.currentDHRatio>=g.targetDHRatio&&(this.dhLimitReached=!0)}canFuse(){const e=g.fusionEffects.maxConcurrent;return this.flashEffects.length<e}getCurrentBounds(){const e=this.width/2*this.spaceSize,s=this.height/2*this.spaceSize;return{minX:-e,maxX:e,minY:-s,maxY:s}}init(){if(this._initialized)return;this._initialized=!0,super.init(),G.init(this.ctx),D.init(this),this.quarkCount=D.responsive(g.quarkCount.mobile,g.quarkCount.tablet,g.quarkCount.desktop),this.maxParticles=D.responsive(g.maxParticles.mobile,g.maxParticles.tablet,g.maxParticles.desktop),this.camera=new W({perspective:800,rotationX:0,rotationY:0}),this.scene3d=new V(this,{x:this.width/2,y:this.height/2,camera:this.camera}),this.bounds={minX:-this.width/2,maxX:this.width/2,minY:-this.height/2,maxY:this.height/2},this.spawnQueue=[],this.processedTriples=new Set,this.particles=w.create(this,this.camera,this.maxParticles);const e={r:255,g:255,b:255,a:1},s=E.getSize(c.QUARK);this.particles.addEmitter("quark",w.createEmitter(this,c.QUARK,e,s)),this.particles.burst(this.quarkCount,"quark");const o=this.particles.particles;this.nextParticleId=o.length;const t=[T.RED,T.GREEN,T.BLUE];for(let i=0;i<o.length;i++){const r=o[i];r.type=c.QUARK,r.mass=E.getMass(c.QUARK),r.id=i,r.temperature=g.initialTemp,r.stable=!0,r.lifetime=99999,r.age=0,r.qcdColor=t[i%3];const a=E.getQCDColorValue(r.qcdColor);r.color=a,r.r=a.r,r.g=a.g,r.b=a.b,r.a=a.a;const n=Math.random()*Math.PI*2,h=g.quarkSpeed*(.7+Math.random()*.6);r.vx=Math.cos(n)*h,r.vy=Math.sin(n)*h,r.x=0,r.y=0,r.z=0}this.particles.addEmitter("spawn",w.createSpawnEmitter()),this.scene3d.add(this.particles),this.pipeline.add(this.scene3d),this.plasmaRenderer=new Z(this.width,this.height),this.plasmaRenderer.isAvailable()?this.plasmaRenderer.useProgram("plasma",_,L):this.plasmaRenderer=null,this.universeMask=N.circle(this.width/2,this.height/2,0),this._btnSize=36,this._btnMargin=10,this._btnSpacing=8,this.buttonBar=new j(this,{spacing:this._btnSpacing,anchor:"bottom-right",debug:!0,debugColor:"#999"}),this.pipeline.add(this.buttonBar),this.helpButton=new H(this,{text:"[?]",width:this._btnSize,height:this._btnSize,font:"14px monospace",startToggled:!1,onToggle:i=>{this.helpDialog&&this.helpDialog.toggle(i)}}),this.buttonBar.add(this.helpButton),this.dataButton=new H(this,{text:"[i]",width:this._btnSize,height:this._btnSize,font:"14px monospace",startToggled:!1,onToggle:i=>{this.dataDialog&&this.dataDialog.toggle(i)}}),this.buttonBar.add(this.dataButton),this.helpDialog=new tt(this),this.pipeline.add(this.helpDialog),this.dataDialog=new et(this),this.pipeline.add(this.dataDialog),this._onClick=i=>{const r=this.canvas.getBoundingClientRect(),a=i.clientX-r.left,n=i.clientY-r.top,h=this.width-(this._btnSize*2+this._btnSpacing)-this._btnMargin,l=this.height-this._btnSize-this._btnMargin;if(!(a>=h&&a<=this.width-this._btnMargin&&n>=l&&n<=this.height-this._btnMargin)){if(this.helpDialog&&this.helpDialog.visible){const u=this.helpDialog.x-this.helpDialog.width/2,m=this.helpDialog.y-this.helpDialog.height/2;a>=u&&a<=u+this.helpDialog.width&&n>=m&&n<=m+this.helpDialog.height||(this.helpDialog.toggle(!1),this.helpButton.toggle(!1));return}this.dataDialog&&this.dataDialog.visible&&(this.dataDialog.toggle(!1),this.dataButton.toggle(!1))}},this.canvas.addEventListener("click",this._onClick),this._onKeyDown=i=>{i.key==="r"||i.key==="R"?this.restart():i.key==="i"||i.key==="I"?this.dataDialog&&(this.dataDialog.toggle(),this.dataButton.toggle(this.dataDialog.visible)):(i.key==="?"||i.key==="/")&&this.helpDialog&&(this.helpDialog.toggle(),this.helpButton.toggle(this.helpDialog.visible))},window.addEventListener("keydown",this._onKeyDown),this._precacheFlashEffects()}_precacheFlashEffects(){const e=g.fusionEffects,s=e.hadronizationColor;this._getFlashCanvas(s.r,s.g,s.b);const o=e.nucleosynthesisColor;this._getFlashCanvas(o.r,o.g,o.b)}cleanupDeadParticles(){const e=this.particles.particles;e.length;let s=0;for(let o=0;o<e.length;o++){const t=e[o];t.dead||(s!==o&&(e[s]=t),s++)}e.length=s}spawnParticle(e){const s=this.particles.emitters.get("spawn");if(!s)return;s.position={x:e.x,y:e.y,z:e.z||0},s.velocity={x:e.vx,y:e.vy,z:e.vz||0},s.size={min:e.size,max:e.size};const o=e.effectColor||E.getColor(e.type);s.color=o,s.lifetime={min:e.lifetime||999,max:e.lifetime||999},this.particles.burst(1,"spawn");const t=this.particles.particles[this.particles.particles.length-1];t&&(t.type=e.type,t.mass=e.mass,t.isPhoton=e.isPhoton||!1,t.isEffect=e.isEffect||!1,t.lifetime=e.lifetime||99999,t.age=0,t.energy=e.energy||0,t.isNew=e.isNew||!1,t.stable=e.stable||!e.isPhoton,t.id=this.nextParticleId++,t.temperature=this.universeTemp,e.type===c.HELIUM3&&this.he3PlotArmorCount<g.minHelium3&&(t.plotArmor=!0,this.he3PlotArmorCount++),t.color=o,t.r=o.r,t.g=o.g,t.b=o.b,t.a=o.a,e.originX!==void 0&&(t.originX=e.originX,t.originY=e.originY,t.originZ=e.originZ||0))}update(e){if(super.update(e),this.elapsedTime+=e,this.elapsedTime<g.startDelay)return;this.bangStarted||(this.bangStarted=!0);const s=this.elapsedTime-g.startDelay;if(!this.physicsEnabled){const l=g.expansionDelay,f=Math.max(0,s-l),u=Math.min(1,f/g.expansionTime),m=Math.max(0,F.easeInOutQuart(u)),d=this.spaceSize;if(this.spaceSize=g.initialSpaceSize+(g.finalSpaceSize-g.initialSpaceSize)*m,d>0&&this.spaceSize>d){const y=this.spaceSize/d;for(const p of this.particles.particles)p.dead||p.isPhoton||(p.x*=y,p.y*=y)}}if(this.flashIntensity>0)if(s<.3)this.flashIntensity=1;else{const f=s-.3,u=Math.min(1,f/(g.flashDuration-.3));this.flashIntensity=1-F.easeOutExpo(u)}!this.physicsEnabled&&s>=g.physicsDelay&&(this.physicsEnabled=!0,this.spaceSize=g.finalSpaceSize);const o=this.particles.particles.filter(l=>!l.dead&&l.type===c.QUARK).length,t=this.particles.particles.filter(l=>!l.dead&&l.type===c.NEUTRON).length;for(!this.hadronizationComplete&&this.physicsEnabled&&o===0&&(this.hadronizationComplete=!0),!this.nucleosynthesisComplete&&this.hadronizationComplete&&t===0&&(this.nucleosynthesisComplete=!0,this.coolingStartTime=this.elapsedTime),!this.gasFormationEnabled&&this.nucleosynthesisComplete&&g.gasFormation.enabled&&this.elapsedTime-this.coolingStartTime>=g.coolingDuration&&(this.gasFormationEnabled=!0),this.physicsEnabled?this.nucleosynthesisComplete?this.gasFormationEnabled?this.universeTemp=Math.max(g.minTemp,this.universeTemp-g.coolingRate*.5*e):this.universeTemp=Math.max(g.minTemp,this.universeTemp-g.coolingRate*e):this.universeTemp=Math.max(.3,this.universeTemp-g.coolingRate*e):this.universeTemp=Math.max(.6,this.universeTemp-.4*e),this.processedTriples.clear(),this.reactionsThisFrame=0,this.maxReactionsThisFrame=2+Math.floor(Math.random()*3),this.effectsThisFrame=0;this.spawnQueue.length>0;){const l=this.spawnQueue.shift();this.spawnParticle(l)}if(this.cleanupTimer+=e,this.cleanupTimer>=.5&&(this.cleanupTimer=0,this.cleanupDeadParticles()),this.updateDHRatio(),this.updateFusionEffects(e),this.plasmaFadeIn<1&&(this.plasmaFadeIn=Math.min(1,this.plasmaFadeIn+e/g.plasma.fadeInDuration)),this.elapsedTime-this.lastHistoryTime>=.5&&(this.recordHistory(),this.lastHistoryTime=this.elapsedTime),this.universeMask){const l=Math.sqrt(this.width*this.width+this.height*this.height)/2*1.2,f=this.spaceSize*l;this.universeMask.radius=f,this.universeMask.x=this.width/2,this.universeMask.y=this.height/2,f>=l&&(this.universeMask=null)}const i=this.getCurrentBounds(),r=.95+this.universeTemp*.05,a=(i.maxX-i.minX)/2,n=(i.maxY-i.minY)/2,h=Math.min(a,n)*30;for(const l of this.particles.particles)l.dead||l.isPhoton||(this.physicsEnabled||(l.vx=Math.max(-h,Math.min(h,l.vx)),l.vy=Math.max(-h,Math.min(h,l.vy))),l.x<i.minX&&(l.x=i.minX,l.vx=Math.abs(l.vx)*r),l.x>i.maxX&&(l.x=i.maxX,l.vx=-Math.abs(l.vx)*r),l.y<i.minY&&(l.y=i.minY,l.vy=Math.abs(l.vy)*r),l.y>i.maxY&&(l.y=i.maxY,l.vy=-Math.abs(l.vy)*r))}renderCosmicBackground(){const e=this.ctx,s=this.universeTemp;let o,t,i;if(s>.9){const a=(s-.9)/.1;o=180+75*a,t=200+55*a,i=255}else if(s>.6){const a=(s-.6)/.3;o=80+100*a,t=150+50*a,i=255}else if(s>.4){const a=(s-.4)/.2;o=255-175*a,t=220-70*a,i=50+205*a}else if(s>.25){const a=(s-.25)/.15;o=255,t=180+40*a,i=30+20*a}else if(s>.15){const a=(s-.15)/.1;o=200+55*a,t=80+100*a,i=15+15*a}else{const a=s/.15;o=60+140*a,t=15+65*a,i=5+10*a}const r=.4+.4*s;e.fillStyle=`rgba(${Math.floor(o)}, ${Math.floor(t)}, ${Math.floor(i)}, ${r})`,e.fillRect(0,0,this.width,this.height)}renderVignette(){const e=this.ctx,s=this.width/2,o=this.height/2,t=Math.sqrt(this.width*this.width+this.height*this.height)/2,i=e.createRadialGradient(s,o,0,s,o,t);i.addColorStop(0,"rgba(0, 0, 0, 0)"),i.addColorStop(.25,"rgba(0, 0, 0, 0)"),i.addColorStop(.4,"rgba(0, 0, 0, 0.05)"),i.addColorStop(.5,"rgba(0, 0, 0, 0.12)"),i.addColorStop(.6,"rgba(0, 0, 0, 0.25)"),i.addColorStop(.7,"rgba(0, 0, 0, 0.4)"),i.addColorStop(.8,"rgba(0, 0, 0, 0.6)"),i.addColorStop(.9,"rgba(0, 0, 0, 0.85)"),i.addColorStop(1,"rgba(0, 0, 0, 1)"),e.fillStyle=i,e.fillRect(0,0,this.width,this.height)}renderBigBangFlash(){if(this.flashIntensity<=.01)return;const e=this.ctx,s=this.flashIntensity;e.fillStyle=`rgba(255, 255, 255, ${s})`,e.fillRect(0,0,this.width,this.height)}recordHistory(){const e=this.particles.particles,s={};for(const t of e){if(t.dead)continue;const i=t.type||"unknown";s[i]=(s[i]||0)+1}const o={time:this.elapsedTime,temp:this.universeTemp,quarks:s[c.QUARK]||0,protons:s[c.PROTON]||0,neutrons:s[c.NEUTRON]||0,deuterium:s[c.DEUTERIUM]||0,helium3:s[c.HELIUM3]||0,helium4:s[c.HELIUM4]||0,dhRatio:this.currentDHRatio};this.history.push(o),this.history.length>200&&this.history.shift(),this.dataDialog&&this.dataDialog.updateStats({history:this.history,counts:{quarks:o.quarks,protons:o.protons,neutrons:o.neutrons,deuterium:o.deuterium,helium3:o.helium3,helium4:o.helium4},dhRatio:this.currentDHRatio,dhLimitReached:this.dhLimitReached})}renderMinimalHUD(e){const s=this.particles.particles,o={};for(const l of s){if(l.dead)continue;const f=l.type||"unknown";o[f]=(o[f]||0)+1}e.fillStyle="rgba(0, 0, 0, 0.6)",e.fillRect(12,this.height-130|0,140,118),e.font="11px monospace",e.textAlign="left",e.textBaseline="top";let t=this.height-124|0;this.physicsEnabled?this.hadronizationComplete?this.nucleosynthesisComplete?this.gasFormationEnabled?(e.fillStyle="#f0f",e.fillText("GAS FORMATION",18,t)):(e.fillStyle="#08f",e.fillText("COOLING",18,t)):(e.fillStyle="#0f0",e.fillText("NUCLEOSYNTHESIS",18,t)):(e.fillStyle="#f80",e.fillText("HADRONIZATION",18,t)):(e.fillStyle="#ff0",e.fillText("EXPANDING...",18,t)),t+=16;const i=(this.universeTemp*100).toFixed(0);e.fillStyle=`rgb(255, ${100+this.universeTemp*155|0}, ${this.universeTemp*100|0})`,e.fillText(`TEMP: ${i}%`,18,t),t+=16;const r=o[c.QUARK]||0,a=(o[c.PROTON]||0)+(o[c.NEUTRON]||0),n=(o[c.DEUTERIUM]||0)+(o[c.HELIUM3]||0)+(o[c.HELIUM4]||0);e.fillStyle="#f00",e.fillText(`QUARKS: ${r}`,18,t),t+=14,e.fillStyle="#fff",e.fillText(`HADRONS: ${a}`,18,t),t+=14,e.fillStyle="#0ff",e.fillText(`NUCLEI: ${n}`,18,t),t+=16;const h=(this.currentDHRatio*1e3).toFixed(1);e.fillStyle=this.dhLimitReached?"#0f0":"#0ff",e.fillText(`D/H: ${h}/1000`,18,t),e.fillStyle="rgba(0, 0, 0, 0.5)",e.fillRect(this.width-130|0,12,118,32),e.fillStyle="rgba(255, 255, 255, 0.6)",e.textAlign="right",e.fillText("[R] RESTART",this.width-18|0,18),e.fillText("[I] INFO",this.width-18|0,32)}render(){if(!this.bangStarted){this.ctx.fillStyle="#000",this.ctx.fillRect(0,0,this.width,this.height);return}this.universeMask&&this.universeMask.apply(this.ctx),this.renderCosmicBackground(),this.renderPlasmaLayer(),this.renderBigBangFlash(),this.renderVignette();const e=this.particles.particles.filter(t=>t.isPhoton&&!t.dead),s=this.width/2,o=this.height/2;for(const t of e)if(t.originX!==void 0){const i=s+t.originX,r=o+t.originY,a=s+t.x,n=o+t.y,h=t.alpha!==void 0?t.alpha:1;E.drawSquigglyLine(this.ctx,i,r,a,n,3,6,h)}this.renderFusionEffects(),this.universeMask&&this.universeMask.remove(this.ctx),this.renderMinimalHUD(this.ctx),this.pipeline.render()}restart(){this.particles.clear(),this.particles.pool=[],this.elapsedTime=0,this.physicsEnabled=!1,this.universeTemp=g.initialTemp,this.spaceSize=g.initialSpaceSize,this.cleanupTimer=0,this.currentDHRatio=0,this.dhLimitReached=!1,this.he3PlotArmorCount=0,this.flashIntensity=1,this.plasmaFadeIn=0,this.bangStarted=!1,this.nextParticleId=0,this.spawnQueue=[],this.processedTriples.clear(),this.reactionsThisFrame=0,this.maxReactionsThisFrame=3,this.effectsThisFrame=0,this.hadronizationComplete=!1,this.nucleosynthesisComplete=!1,this.coolingStartTime=null,this.gasFormationEnabled=!1;for(const t of this.flashEffects)t.active=!1;this.flashEffects.length=0,this._flashCache.clear(),this._precacheFlashEffects(),this.history=[],this.lastHistoryTime=0,this.dataDialog&&this.dataDialog.toggle(!1),this.dataButton&&this.dataButton.toggle(!1),this.helpDialog&&this.helpDialog.toggle(!1),this.helpButton&&this.helpButton.toggle(!1),this.universeMask=N.circle(this.width/2,this.height/2,0),this.particles.burst(this.quarkCount,"quark");const e=this.particles.particles;this.nextParticleId=e.length;const s=E.getSize(c.QUARK),o=[T.RED,T.GREEN,T.BLUE];for(let t=0;t<e.length;t++){const i=e[t];i.dead=!1,i.alive=!0,i.isPhoton=!1,i.isNew=!1,i.isEffect=!1,i.effectColor=void 0,i.seekDelay=void 0,i.meetingPoint=void 0,i.meetingLeader=void 0,i.type=c.QUARK,i.mass=E.getMass(c.QUARK),i.id=t,i.temperature=g.initialTemp,i.stable=!0,i.lifetime=99999,i.age=0,i.energy=0,i.qcdColor=o[t%3],i.size=s,i.alpha=1;const r=E.getQCDColorValue(i.qcdColor);i.color={...r},i.r=r.r,i.g=r.g,i.b=r.b,i.a=r.a,i.x=0,i.y=0,i.z=0;const a=Math.random()*Math.PI*2,n=g.quarkSpeed*(.7+Math.random()*.6);i.vx=Math.cos(a)*n,i.vy=Math.sin(a)*n,i.vz=0,i.originX=void 0,i.originY=void 0,i.originZ=void 0}}stop(){this._initialized=!1,this._onKeyDown&&window.removeEventListener("keydown",this._onKeyDown),this._onClick&&this.canvas.removeEventListener("click",this._onClick),this.plasmaRenderer&&(this.plasmaRenderer.destroy(),this.plasmaRenderer=null),super.stop()}}function nt(S){const e=new it(S);return e.start(),{stop:()=>e.stop(),game:e}}export{nt as default};
