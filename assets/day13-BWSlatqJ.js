import{G as k,P as D,R as v,n as M,I as C,B as S}from"./gcanvas.es-BBvhR3Fu.js";const a={background:"#000",borderColor:"#0f0",borderWidth:3,boxPadding:20,boxGap:40,buttonWidth:150,buttonHeight:50,buttonY:50,maxImageSize:800};class z extends k{constructor(t){super(t),this.backgroundColor=a.background}init(){super.init(),D.init(this.ctx);const t=this.width-a.boxPadding*2,e=Math.min(t-a.boxGap,(this.height-a.boxPadding*2-a.buttonHeight-a.buttonY)*2-a.boxGap),i=Math.floor((e-a.boxGap)/2);this.boxSize=i,this.boxCenterY=this.height/2;const s=i*2+a.boxGap,o=(this.width-s)/2;this.leftBoxX=o+i/2,this.rightBoxX=o+i+a.boxGap+i/2,this.createBoundingBoxes(),this.leftImage=null,this.rightImage=null,this.resultImage=null,this.loadAvatar(),this.createTransformButton(),this.setupDragAndDrop(),this.uploadedImageData=null,this.avatarImageData=null,this.isProcessing=!1}createBoundingBoxes(){const t=this.boxSize,e=a.borderWidth;this.leftBox=new v({x:this.leftBoxX,y:this.boxCenterY,width:t,height:t,stroke:a.borderColor,lineWidth:e,fill:!1}),this.rightBox=new v({x:this.rightBoxX,y:this.boxCenterY,width:t,height:t,stroke:a.borderColor,lineWidth:e,fill:!1}),this.leftLabel=new M("Drop Image Here",{x:this.leftBoxX,y:this.boxCenterY,font:"16px monospace",color:a.borderColor,align:"center",baseline:"middle"}),this.rightLabel=new M("Avatar",{x:this.rightBoxX,y:this.boxCenterY,font:"16px monospace",color:a.borderColor,align:"center",baseline:"middle"}),this.pipeline.add(this.leftBox),this.pipeline.add(this.rightBox),this.pipeline.add(this.leftLabel),this.pipeline.add(this.rightLabel)}async loadAvatar(){try{const t=new Image;t.crossOrigin="anonymous",await new Promise((m,h)=>{t.onload=m,t.onerror=h,t.src="/avatar.jpeg"});const e=document.createElement("canvas");e.width=t.width,e.height=t.height;const i=e.getContext("2d");i.drawImage(t,0,0),this.avatarImageData=i.getImageData(0,0,t.width,t.height);const s=Math.min(this.boxSize/t.width,this.boxSize/t.height),o=Math.floor(t.width*s),n=Math.floor(t.height*s),c=document.createElement("canvas");c.width=o,c.height=n;const x=c.getContext("2d");x.drawImage(t,0,0,o,n),this.avatarImageData=x.getImageData(0,0,o,n),this.rightImage=new C(this,this.avatarImageData,{x:this.rightBoxX,y:this.boxCenterY,width:o,height:n,anchor:"center"}),this.pipeline.add(this.rightImage)}catch(t){console.error("Failed to load avatar:",t)}}createTransformButton(){this.transformButton=new S(this,{x:this.width/2,y:a.buttonY,width:a.buttonWidth,height:a.buttonHeight,text:"Transform",onClick:()=>this.transformPixels()}),this.pipeline.add(this.transformButton)}setupDragAndDrop(){["dragenter","dragover","dragleave","drop"].forEach(t=>{this.canvas.addEventListener(t,e=>{e.preventDefault(),e.stopPropagation()},!1)}),this.canvas.addEventListener("dragenter",()=>{this.leftBox.stroke="#0ff",this.leftBox.lineWidth=a.borderWidth+2}),this.canvas.addEventListener("dragleave",()=>{this.leftBox.stroke=a.borderColor,this.leftBox.lineWidth=a.borderWidth}),this.canvas.addEventListener("drop",async t=>{this.leftBox.stroke=a.borderColor,this.leftBox.lineWidth=a.borderWidth;const e=t.dataTransfer.files;if(e.length>0){const i=e[0];i.type.startsWith("image/")&&await this.loadUploadedImage(i)}}),this.canvas.addEventListener("click",async t=>{const e=this.canvas.getBoundingClientRect(),i=t.clientX-e.left,s=t.clientY-e.top,o={x:this.leftBoxX-this.boxSize/2,y:this.boxCenterY-this.boxSize/2,width:this.boxSize,height:this.boxSize};if(i>=o.x&&i<=o.x+o.width&&s>=o.y&&s<=o.y+o.height){const n=document.createElement("input");n.type="file",n.accept="image/*",n.onchange=async c=>{c.target.files.length>0&&await this.loadUploadedImage(c.target.files[0])},n.click()}})}async loadUploadedImage(t){try{const e=new Image;await new Promise((b,u)=>{e.onload=b,e.onerror=u,e.src=URL.createObjectURL(t)});let i=e.width,s=e.height;const o=Math.max(i,s);if(o>a.maxImageSize){const b=a.maxImageSize/o;i=Math.floor(i*b),s=Math.floor(s*b)}const n=document.createElement("canvas");n.width=i,n.height=s;const c=n.getContext("2d");c.drawImage(e,0,0,i,s),this.uploadedImageData=c.getImageData(0,0,i,s);const m=this.boxSize-10*2,h=Math.min(m/i,m/s),g=Math.floor(i*h),l=Math.floor(s*h),r=document.createElement("canvas");r.width=g,r.height=l;const d=r.getContext("2d");d.drawImage(e,0,0,g,l);const f=d.getImageData(0,0,g,l);this.leftImage&&this.pipeline.remove(this.leftImage),this.leftImage=new C(this,f,{x:this.leftBox.x,y:this.leftBox.y,width:g,height:l,anchor:"center"}),this.pipeline.add(this.leftImage),this.leftLabel&&(this.leftLabel.visible=!1),this.transformButton.label.color=a.borderColor}catch(e){console.error("Failed to load uploaded image:",e)}}transformPixels(){if(!this.uploadedImageData||!this.avatarImageData||this.isProcessing)return;this.isProcessing=!0,this.transformButton.label.text="Processing...",this.transformButton.label.color="#888";const t=this.uploadedImageData,e=this.buildColorMap(t);this.processChunk(e,0)}processChunk(t,e){const i=this.uploadedImageData,s=this.avatarImageData,o=10;this.resultImageData||(this.resultImageData=D.img.createImageData(s.width,s.height),this.resultData=this.resultImageData.data,this.targetData=s.data);const n=Math.min(e+o,s.height);for(let x=e;x<n;x++)for(let m=0;m<s.width;m++){const h=(x*s.width+m)*4,g=this.targetData[h],l=this.targetData[h+1],r=this.targetData[h+2],d=this.targetData[h+3];if(d<10){this.resultData[h]=0,this.resultData[h+1]=0,this.resultData[h+2]=0,this.resultData[h+3]=0;continue}const f=this.findBestMatch(g,l,r,i,t);this.resultData[h]=f.r,this.resultData[h+1]=f.g,this.resultData[h+2]=f.b,this.resultData[h+3]=d}const c=Math.floor(n/s.height*100);this.transformButton.label.text=`Processing... ${c}%`,n<s.height?requestAnimationFrame(()=>{this.processChunk(t,n)}):this.displayResult()}displayResult(){const t=this.avatarImageData,e=D.img.cloneImageData(this.resultImageData);this.resultImage&&this.pipeline.remove(this.resultImage),this.rightImage&&(this.rightImage.visible=!1),this.resultImage=new C(this,e,{x:this.rightBoxX,y:this.boxCenterY,width:t.width,height:t.height,anchor:"center"}),this.pipeline.add(this.resultImage),this.isProcessing=!1,this.resultData=null,this.targetData=null,this.transformButton.label.text="Transform",this.transformButton.label.color=a.borderColor,setTimeout(()=>{this.resultImageData=null},100)}buildColorMap(t){const e=new Map,i=t.data,s=16;for(let o=0;o<i.length;o+=4){const n=i[o],c=i[o+1],x=i[o+2];if(i[o+3]<10)continue;const h=Math.floor(n/s),g=Math.floor(c/s),l=Math.floor(x/s),r=`${h},${g},${l}`;e.has(r)||e.set(r,[]);const d=o/4%t.width,f=Math.floor(o/4/t.width);e.get(r).push({r:n,g:c,b:x,x:d,y:f})}return e}findBestMatch(t,e,i,s,o){const c=Math.floor(t/16),x=Math.floor(e/16),m=Math.floor(i/16);let h=null,g=1/0;for(let l=-1;l<=1;l++)for(let r=-1;r<=1;r++)for(let d=-1;d<=1;d++){const f=`${c+l},${x+r},${m+d}`,b=o.get(f);if(b)for(const u of b){const p=t-u.r,B=e-u.g,I=i-u.b,w=p*p+B*B+I*I;w<g&&(g=w,h=u)}}if(!h){const l=s.data;for(let r=0;r<l.length;r+=4){const d=l[r],f=l[r+1],b=l[r+2];if(l[r+3]<10)continue;const p=t-d,B=e-f,I=i-b,w=p*p+B*B+I*I;w<g&&(g=w,h={r:d,g:f,b})}}return h||{r:0,g:0,b:0}}onResize(){const t=this.width-a.boxPadding*2,e=Math.min(t-a.boxGap,(this.height-a.boxPadding*2-a.buttonHeight-a.buttonY)*2-a.boxGap),i=Math.floor((e-a.boxGap)/2);this.boxSize=i,this.boxCenterY=this.height/2;const s=i*2+a.boxGap,o=(this.width-s)/2;this.leftBoxX=o+i/2,this.rightBoxX=o+i+a.boxGap+i/2,this.leftBox&&(this.leftBox.x=this.leftBoxX,this.leftBox.y=this.boxCenterY,this.leftBox.width=i,this.leftBox.height=i),this.rightBox&&(this.rightBox.x=this.rightBoxX,this.rightBox.y=this.boxCenterY,this.rightBox.width=i,this.rightBox.height=i),this.leftLabel&&(this.leftLabel.x=this.leftBoxX,this.leftLabel.y=this.boxCenterY),this.rightLabel&&(this.rightLabel.x=this.rightBoxX,this.rightLabel.y=this.boxCenterY),this.leftImage&&(this.leftImage.x=this.leftBoxX,this.leftImage.y=this.boxCenterY),this.rightImage&&(this.rightImage.x=this.rightBoxX,this.rightImage.y=this.boxCenterY),this.resultImage&&(this.resultImage.x=this.rightBoxX,this.resultImage.y=this.boxCenterY),this.transformButton&&(this.transformButton.x=this.width/2)}}function X(y){const t=new z(y);return t.start(),{stop:()=>t.stop(),game:t}}export{X as default};
