import{G as O,P as v}from"./gcanvas.es-ChtmA8T6.js";const c={colonyCount:6,agentsPerColony:15e3,moveSpeed:1,turnSpeed:.3,randomSteer:.05,sensorAngle:Math.PI/4,sensorDistance:9,trailWeight:3,decayRate:.96,ownTrailAttraction:1.5,enemyTrailRepulsion:3,colonyHues:[0,35,120,180,240,300],saturation:100,lightness:60};class P{constructor(n,t,e,i){this.x=n,this.y=t,this.angle=e,this.colonyId=i}}class E{constructor(n,t,e,i){this.id=n,this.hue=t,this.startX=e,this.startY=i,this.agents=[]}}class Y extends O{constructor(n){super(n),this.backgroundColor=null}init(){super.init(),v.init(this.ctx),this.container=this.canvas.parentElement,this.container&&this.enableFluidSize(this.container),this.trailWidth=Math.floor(this.width),this.trailHeight=Math.floor(this.height),this.colonies=[],this.trailMaps=[],this.trailMapsNext=[];const n=this._getColonyStartPositions(c.colonyCount),t=Math.min(this.width,this.height)*.25;for(let e=0;e<c.colonyCount;e++){const i=c.colonyHues[e%c.colonyHues.length],s=n[e],r=new E(e,i,s.x,s.y);for(let o=0;o<c.agentsPerColony;o++){const l=Math.random()*Math.PI*2,a=Math.sqrt(Math.random())*t,p=s.x+Math.cos(l)*a,h=s.y+Math.sin(l)*a,g=Math.random()*Math.PI*2;r.agents.push(new P(p,h,g,e))}this.colonies.push(r),this.trailMaps.push(new Float32Array(this.trailWidth*this.trailHeight)),this.trailMapsNext.push(new Float32Array(this.trailWidth*this.trailHeight))}this.trailImageData=this.ctx.createImageData(this.trailWidth,this.trailHeight),this.nextColonyHue=0,this.canvas.addEventListener("click",e=>{const i=this.canvas.getBoundingClientRect(),s=(e.clientX-i.left)*(this.width/i.width),r=(e.clientY-i.top)*(this.height/i.height);this._spawnColony(s,r)}),this.elapsedTime=0,this.frameCount=0,this.lastFpsTime=performance.now(),this.fps=60,this.updateTime=0,this.renderTime=0}_getColonyStartPositions(n){const t=[];if(this.width-100*2,this.height-100*2,n<=4){const i=[{x:100,y:100},{x:this.width-100,y:100},{x:100,y:this.height-100},{x:this.width-100,y:this.height-100}];for(let s=0;s<n;s++)t.push(i[s])}else t.push({x:100,y:100}),t.push({x:this.width-100,y:100}),t.push({x:100,y:this.height-100}),t.push({x:this.width-100,y:this.height-100}),t.push({x:this.width/2,y:100}),t.push({x:this.width/2,y:this.height-100});return t}_spawnColony(n,t){const e=this.colonies.length,i=this.nextColonyHue*60%360;this.nextColonyHue++;const s=new E(e,i,n,t);for(let r=0;r<c.agentsPerColony/2;r++){const o=Math.random()*Math.PI*2,l=Math.random()*50,a=n+Math.cos(o)*l,p=t+Math.sin(o)*l;s.agents.push(new P(a,p,Math.random()*Math.PI*2,e))}this.colonies.push(s),this.trailMaps.push(new Float32Array(this.trailWidth*this.trailHeight)),this.trailMapsNext.push(new Float32Array(this.trailWidth*this.trailHeight))}sampleTrail(n,t,e){const i=Math.floor(t),s=Math.floor(e);return i<0||i>=this.trailWidth||s<0||s>=this.trailHeight?0:this.trailMaps[n][s*this.trailWidth+i]}sampleEnemyTrails(n,t,e){const i=Math.floor(t),s=Math.floor(e);if(i<0||i>=this.trailWidth||s<0||s>=this.trailHeight)return 0;const r=s*this.trailWidth+i;let o=0;for(let l=0;l<this.trailMaps.length;l++)l!==n&&(o+=this.trailMaps[l][r]);return o}depositTrail(n,t,e,i){const s=Math.floor(t),r=Math.floor(e);if(s<0||s>=this.trailWidth||r<0||r>=this.trailHeight)return;const o=r*this.trailWidth+s;this.trailMaps[n][o]=Math.min(255,this.trailMaps[n][o]+i)}processTrailMaps(){const n=this.trailWidth,t=this.trailHeight,e=c.decayRate;for(let i=0;i<this.trailMaps.length;i++){const s=this.trailMaps[i],r=this.trailMapsNext[i];for(let o=1;o<t-1;o++)for(let l=1;l<n-1;l++){const a=o*n+l;r[a]=s[a]*e}this.trailMaps[i]=r,this.trailMapsNext[i]=s}}update(n){super.update(n),this.elapsedTime+=n;const t=performance.now(),e=this.trailWidth,i=this.trailHeight,s=c.sensorDistance,r=c.sensorAngle,o=c.turnSpeed,l=c.ownTrailAttraction,a=c.enemyTrailRepulsion;for(const p of this.colonies)for(const h of p.agents){const g=h.colonyId,d=h.x+Math.cos(h.angle-r)*s,f=h.y+Math.sin(h.angle-r)*s,m=this.sampleTrail(g,d,f)*l,M=this.sampleEnemyTrails(g,d,f)*a,y=m-M,A=h.x+Math.cos(h.angle)*s,H=h.y+Math.sin(h.angle)*s,F=this.sampleTrail(g,A,H)*l,R=this.sampleEnemyTrails(g,A,H)*a,x=F-R,W=h.x+Math.cos(h.angle+r)*s,b=h.y+Math.sin(h.angle+r)*s,D=this.sampleTrail(g,W,b)*l,N=this.sampleEnemyTrails(g,W,b)*a,w=D-N,T=(Math.random()-.5)*c.randomSteer;x>y&&x>w?h.angle+=T:x<y&&x<w?h.angle+=(Math.random()<.5?-1:1)*o+T:y>w?h.angle-=o:w>y?h.angle+=o:h.angle+=T*2;const I=c.moveSpeed,C=h.x+Math.cos(h.angle)*I,S=h.y+Math.sin(h.angle)*I;C<1||C>=e-1||S<1||S>=i-1?h.angle=Math.random()*Math.PI*2:(h.x=C,h.y=S,this.depositTrail(g,h.x,h.y,c.trailWeight))}this.processTrailMaps(),this.updateTime=performance.now()-t}hslToRgb(n,t,e){t/=100,e/=100;const i=(1-Math.abs(2*e-1))*t,s=i*(1-Math.abs(n/60%2-1)),r=e-i/2;let o,l,a;return n<60?(o=i,l=s,a=0):n<120?(o=s,l=i,a=0):n<180?(o=0,l=i,a=s):n<240?(o=0,l=s,a=i):n<300?(o=s,l=0,a=i):(o=i,l=0,a=s),{r:Math.floor((o+r)*255),g:Math.floor((l+r)*255),b:Math.floor((a+r)*255)}}render(){const n=performance.now(),t=this.ctx;this.trailWidth,this.trailHeight;const e=this.trailImageData.data,i=c.saturation,s=c.lightness;for(let a=0;a<e.length;a+=4)e[a]=0,e[a+1]=0,e[a+2]=0,e[a+3]=255;for(let a=0;a<this.colonies.length;a++){const p=this.colonies[a],h=this.trailMaps[a],g=this.hslToRgb(p.hue,i,s);for(let d=0;d<h.length;d++){const f=h[d];if(f>.1){const m=d*4,M=Math.min(1,f/15);e[m]=Math.min(255,e[m]+g.r*M),e[m+1]=Math.min(255,e[m+1]+g.g*M),e[m+2]=Math.min(255,e[m+2]+g.b*M)}}}t.putImageData(this.trailImageData,0,0),t.globalCompositeOperation="lighter",t.filter="blur(1px)",t.globalAlpha=.2,t.drawImage(this.canvas,0,0),t.filter="none",t.globalCompositeOperation="source-over",t.globalAlpha=1,this.renderTime=performance.now()-n,this.frameCount++;const r=performance.now();r-this.lastFpsTime>=1e3&&(this.fps=this.frameCount,this.frameCount=0,this.lastFpsTime=r);const o=this.colonies.reduce((a,p)=>a+p.agents.length,0),l=this.colonies.length*this.trailWidth*this.trailHeight*4*2/(1024*1024);t.font='10px "Fira Code", monospace',t.fillStyle="rgba(0, 0, 0, 0.7)",t.fillRect(10,this.height-70,130,65),t.fillStyle="rgba(0, 0, 0, 0.7)",t.fillRect(this.width-250,this.height-40,240,35),t.fillStyle="#fff",t.textAlign="left",t.fillText(`FPS: ${this.fps}`,15,this.height-55),t.fillText(`UPDATE: ${this.updateTime.toFixed(1)}ms`,15,this.height-40),t.fillText(`RENDER: ${this.renderTime.toFixed(1)}ms`,15,this.height-25),t.fillText(`TRAIL MEM: ${l.toFixed(1)}MB`,15,this.height-10),t.textAlign="right",t.fillText(`${this.colonies.length} COLONIES Â· ${o} AGENTS`,this.width-15,this.height-25),t.fillText("CLICK TO SPAWN COLONY",this.width-15,this.height-10)}}function $(u){const n=new Y(u);return n.start(),{stop:()=>n.stop(),game:n}}export{$ as default};
