import{G as M,P as C,k as X,l as b,K as v,m as w,M as D}from"./gcanvas.es-BBvhR3Fu.js";const m={background:"#000",colors:{primary:["#D40920","#1356A2","#F7D842"],neutral:"#F2F5F1",line:"#111"},iso:{gridSize:10,elevationScale:1,tileRatio:.038},subdivision:{step:1,splitProbability:.72,minSize:1},height:{colored:{min:1,max:3},neutral:{min:.2,max:.7}},animation:{springDuration:1.2},camera:{rotationStep:Math.PI/2,animationDuration:.4}};class Y extends w{constructor(t,n,i){super(t),this.isoScene=n,this.gridX=i.x,this.gridY=i.y,this.gridW=i.w,this.gridD=i.d,this.targetHeight=i.h,this.baseColor=i.color,this.currentHeight=0,this.animTime=0,this.animDelay=i.delay||0,this.animStarted=!1,this.topColor=i.color,this.leftColor=this.shadeColor(i.color,-25),this.rightColor=this.shadeColor(i.color,-45)}get isoDepth(){const t=this.isoScene.camera?this.isoScene.camera.angle:0,n=Math.cos(t),i=Math.sin(t),a=[{x:this.gridX,y:this.gridY},{x:this.gridX+this.gridW,y:this.gridY},{x:this.gridX,y:this.gridY+this.gridD},{x:this.gridX+this.gridW,y:this.gridY+this.gridD}];let e=-1/0;for(const s of a){const l=s.x*n-s.y*i,h=s.x*i+s.y*n,d=l+h;d>e&&(e=d)}return e+this.currentHeight*.5}shadeColor(t,n){const i=parseInt(t.replace("#",""),16),a=Math.round(2.55*n),e=Math.max(0,Math.min(255,(i>>16)+a)),s=Math.max(0,Math.min(255,(i>>8&255)+a)),l=Math.max(0,Math.min(255,(i&255)+a));return`#${(16777216+e*65536+s*256+l).toString(16).slice(1)}`}update(t){if(this.currentHeight>=this.targetHeight||(this.animTime+=t,this.animTime<this.animDelay))return;this.animStarted||(this.animStarted=!0,this.animTime=0);const n=D.spring(0,this.targetHeight,this.animTime,m.animation.springDuration,!1,!1,{stiffness:.4,damping:.65});this.currentHeight=n.value,n.completed&&(this.currentHeight=this.targetHeight)}render(){if(this.currentHeight<1)return;const t=this.isoScene;t.camera&&t.camera.angle;const n=this.currentHeight,i=t.toIsometric(this.gridX,this.gridY,n),a=t.toIsometric(this.gridX+this.gridW,this.gridY,n),e=t.toIsometric(this.gridX+this.gridW,this.gridY+this.gridD,n),s=t.toIsometric(this.gridX,this.gridY+this.gridD,n),l=t.toIsometric(this.gridX,this.gridY,0),h=t.toIsometric(this.gridX+this.gridW,this.gridY,0),d=t.toIsometric(this.gridX+this.gridW,this.gridY+this.gridD,0),g=t.toIsometric(this.gridX,this.gridY+this.gridD,0),u=[{verts:[i,a,h,l],normalAngle:-Math.PI/2},{verts:[a,e,d,h],normalAngle:0},{verts:[e,s,g,d],normalAngle:Math.PI/2},{verts:[s,i,l,g],normalAngle:Math.PI}];for(const o of u){const c=o.verts.reduce((p,y)=>p+y.x,0)/4,f=o.verts.reduce((p,y)=>p+y.y,0)/4;o.screenX=c,o.screenY=f}u.sort((o,c)=>o.screenY-c.screenY);const r=[...u].sort((o,c)=>o.screenX-c.screenX);r[0].color=this.leftColor,r[1].color=this.shadeColor(this.baseColor,-30),r[2].color=this.shadeColor(this.baseColor,-35),r[3].color=this.rightColor,C.useCtx(o=>{o.strokeStyle=m.colors.line,o.lineWidth=2;for(const c of u){o.beginPath(),o.moveTo(c.verts[0].x,c.verts[0].y);for(let f=1;f<c.verts.length;f++)o.lineTo(c.verts[f].x,c.verts[f].y);o.closePath(),o.fillStyle=c.color,o.fill(),o.stroke()}o.beginPath(),o.moveTo(i.x,i.y),o.lineTo(a.x,a.y),o.lineTo(e.x,e.y),o.lineTo(s.x,s.y),o.closePath(),o.fillStyle=this.topColor,o.fill(),o.stroke()})}}class I extends M{constructor(t){super(t),this.backgroundColor=m.background}init(){super.init(),C.init(this.ctx);const t=Math.min(this.width,this.height);this.tileWidth=Math.round(t*m.iso.tileRatio),this.tileHeight=Math.round(this.tileWidth/2),this.isoCamera=new X({rotationStep:m.camera.rotationStep,animationDuration:m.camera.animationDuration,easing:"easeOutCubic"}),this.isoScene=new b(this,{x:this.width/2,y:this.height/2,tileWidth:this.tileWidth,tileHeight:this.tileHeight,gridSize:m.iso.gridSize,elevationScale:m.iso.elevationScale,depthSort:!0,camera:this.isoCamera}),this.pipeline.add(this.isoScene),this.generateComposition(),this.wasSwipe=!1,this.events.on(v.Q,()=>this.isoCamera.rotateLeft()),this.events.on(v.E,()=>this.isoCamera.rotateRight()),this.setupTouchControls()}setupTouchControls(){let t=0,n=!1,i=!1;const a=10;this.canvas.addEventListener("touchstart",e=>{const s=e.touches[0];t=s.clientX,s.clientY,i=!1},{passive:!0}),this.canvas.addEventListener("touchend",e=>{const l=e.changedTouches[0].clientX-t;Math.abs(l)>a?(l>0?this.isoCamera.rotateRight():this.isoCamera.rotateLeft(),i=!0):this.regenerate()},{passive:!0}),this.canvas.addEventListener("mousedown",e=>{t=e.clientX,e.clientY,n=!0,i=!1}),this.canvas.addEventListener("mousemove",e=>{if(n){const s=e.clientX-t;Math.abs(s)>a&&(i=!0)}}),this.canvas.addEventListener("mouseup",e=>{if(n){const s=e.clientX-t;Math.abs(s)>a&&(s>0?this.isoCamera.rotateRight():this.isoCamera.rotateLeft(),i=!0),n=!1}}),this.canvas.addEventListener("click",e=>{i||this.regenerate(),i=!1}),this.canvas.addEventListener("mouseleave",()=>{n=!1})}subdivide(){const t=m.iso.gridSize,{step:n,splitProbability:i,minSize:a}=m.subdivision;let e=[{x:-t,y:-t,w:t*2,d:t*2}];const s=[];for(let h=-t;h<=t;h+=n)s.push(h);const l=h=>{const{splitX:d,splitY:g}=h;for(let u=e.length-1;u>=0;u--){const r=e[u];d!==void 0&&d>r.x+a&&d<r.x+r.w-a&&Math.random()<i&&(e.splice(u,1),e.push({x:r.x,y:r.y,w:d-r.x,d:r.d},{x:d,y:r.y,w:r.w-(d-r.x),d:r.d})),g!==void 0&&g>r.y+a&&g<r.y+r.d-a&&Math.random()<i&&(e.splice(u,1),e.push({x:r.x,y:r.y,w:r.w,d:g-r.y},{x:r.x,y:g,w:r.w,d:r.d-(g-r.y)}))}};for(const h of s)l({splitY:h}),l({splitX:h});return e}generateComposition(){const t=this.subdivide(),{colors:n,height:i}=m,a=new Set,e=Math.floor(t.length*.4);for(;a.size<e&&a.size<t.length;)a.add(Math.floor(Math.random()*t.length));t.forEach((s,l)=>{const h=a.has(l),d=h?n.primary[Math.floor(Math.random()*n.primary.length)]:n.neutral,g=h?i.colored:i.neutral,r=(g.min+Math.random()*(g.max-g.min))*this.tileWidth,o=s.x+s.w/2,c=s.y+s.d/2,f=Math.sqrt(o*o+c*c),p=m.iso.gridSize*Math.SQRT2,y=f/p*.5+Math.random()*.1,x=new Y(this,this.isoScene,{x:s.x,y:s.y,w:s.w,d:s.d,h:r,color:d,delay:y});this.isoScene.add(x)})}regenerate(){this.isoScene.clear(),this.generateComposition()}onResize(){this.isoScene&&(this.isoScene.x=this.width/2,this.isoScene.y=this.height/2)}update(t){super.update(t),this.isoCamera.update(t)}}function H(S){const t=new I(S);return t.start(),{stop:()=>t.stop(),game:t}}export{H as default};
