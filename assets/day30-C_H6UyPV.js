import{G as B,d as A,P as M,B as S}from"./index-B6QQFJuW.js";const v={lineWidth:3,glowAmount:15,wave:{colorSpeed:1.5},hue:135,hueRange:60,effects:{bassBlurIntensity:.3,midHueRotationSpeed:2,highEdgeIntensity:.5,amplitudeSaturation:1.5,silenceSolarization:.8,colorTintStrength:.3,motionParticleRate:.1}};class x extends B{constructor(t){super(t),this.backgroundColor="#000"}init(){super.init(),A.init(this),M.init(this.ctx),this.time=0,this.idlePhase=0,this.colorPhase=0,this.synesthesiaActive=!1,this.videoStream=null,this.videoElement=null,this.audioContext=null,this.analyser=null,this.audioSource=null,this.audioBuffer=null,this.isPlaying=!1,this.videoCanvas=null,this.videoCtx=null,this.currentFrame=null,this.frequencyData=null,this.bassLevel=0,this.midLevel=0,this.highLevel=0,this.amplitude=0,this.dominantColor={r:0,g:255,b:0},this.motionAmount=0,this.brightness=.5,this.prevFrame=null,this.startButton=new S(this,{text:"start synesthesia",width:200,height:50,font:'16px "Fira Code", monospace',onClick:()=>this.startSynesthesia()}),this.startButton.x=this.width/2,this.startButton.y=this.height/2+100,this.pipeline.add(this.startButton),this.backButton=new S(this,{x:80,y:30,width:100,height:30,text:"â† Back",onClick:()=>this.goBackToStart()}),this.backButton.visible=!1,this.backButton.interactive=!1,this.pipeline.add(this.backButton)}async startSynesthesia(){try{const t=await navigator.mediaDevices.getUserMedia({video:{width:{ideal:this.width},height:{ideal:this.height}}});this.videoStream=t.getVideoTracks()[0],this.videoElement=document.createElement("video"),this.videoElement.srcObject=t,this.videoElement.autoplay=!0,this.videoElement.playsInline=!0,this.videoElement.width=this.width,this.videoElement.height=this.height,this.videoCanvas=document.createElement("canvas"),this.videoCanvas.width=this.width,this.videoCanvas.height=this.height,this.videoCtx=this.videoCanvas.getContext("2d"),this.audioContext=new(window.AudioContext||window.webkitAudioContext),this.analyser=this.audioContext.createAnalyser(),this.analyser.fftSize=2048,this.analyser.smoothingTimeConstant=.8,this.frequencyData=new Uint8Array(this.analyser.frequencyBinCount),this.startButton.visible=!1,this.startButton.interactive=!1,this.backButton.visible=!0,this.backButton.interactive=!0,this.createAudioFileInput()}catch(t){console.error("Error accessing webcam:",t),alert("Could not access webcam. Please allow permissions.")}}goBackToStart(){if(this.synesthesiaActive=!1,this.videoStream&&(this.videoStream.stop(),this.videoStream=null),this.audioSource){try{this.audioSource.stop(),this.audioSource.disconnect()}catch{}this.audioSource=null}this.audioContext&&(this.audioContext.close(),this.audioContext=null),this.videoElement&&(this.videoElement.srcObject=null,this.videoElement=null),this.currentFrame=null,this.videoCanvas=null,this.videoCtx=null,this.frequencyData=null,this.startButton.visible=!0,this.startButton.interactive=!0,this.backButton.visible=!1,this.backButton.interactive=!1}createAudioFileInput(){const t=document.createElement("input");t.type="file",t.accept="audio/*",t.style.display="none",document.body.appendChild(t),t.addEventListener("change",async i=>{i.target.files.length>0&&(await this.loadAudioFile(i.target.files[0]),t.remove())}),t.click()}async loadAudioFile(t){try{const i=await t.arrayBuffer();this.audioBuffer=await this.audioContext.decodeAudioData(i),this.audioSource=this.audioContext.createBufferSource(),this.audioSource.buffer=this.audioBuffer,this.audioSource.connect(this.analyser),this.analyser.connect(this.audioContext.destination),this.audioSource.onended=()=>{this.isPlaying=!1,this.startAudioPlayback()},this.startAudioPlayback(),this.synesthesiaActive=!0,this.processVideo()}catch(i){console.error("Error loading audio file:",i),alert("Could not load audio file.")}}startAudioPlayback(){!this.audioBuffer||!this.audioContext||(this.audioSource=this.audioContext.createBufferSource(),this.audioSource.buffer=this.audioBuffer,this.audioSource.connect(this.analyser),this.analyser.connect(this.audioContext.destination),this.audioSource.onended=()=>{this.isPlaying=!1,this.startAudioPlayback()},this.audioSource.start(0),this.isPlaying=!0)}processVideo(){if(!this.synesthesiaActive||!this.videoElement)return;const t=this.videoElement.videoWidth||this.width,i=this.videoElement.videoHeight||this.height;(this.videoCanvas.width!==this.width||this.videoCanvas.height!==this.height)&&(this.videoCanvas.width=this.width,this.videoCanvas.height=this.height);const h=t/i,o=this.width/this.height;let n,r,a,l;h>o?(r=this.height,n=this.height*h,a=(this.width-n)/2,l=0):(n=this.width,r=this.width/h,a=0,l=(this.height-r)/2),this.videoCtx.fillStyle="#000",this.videoCtx.fillRect(0,0,this.width,this.height),this.videoCtx.drawImage(this.videoElement,a,l,n,r);const e=this.videoCtx.getImageData(0,0,this.videoCanvas.width,this.videoCanvas.height);this.analyzeVisual(e),this.applyAudioToVisual(e),this.prevFrame=new Uint8Array(e.data),this.videoCtx.putImageData(e,0,0),this.currentFrame=this.videoCanvas,requestAnimationFrame(()=>this.processVideo())}analyzeVisual(t){const i=t.data;let h=0,o=0,n=0,r=0,a=0;const l=i.length/4;for(let e=0;e<i.length;e+=4){const m=i[e],s=i[e+1],d=i[e+2];h+=m,o+=s,n+=d;const c=(m*.299+s*.587+d*.114)/255;if(r+=c,this.prevFrame){const f=this.prevFrame[e],b=this.prevFrame[e+1],g=this.prevFrame[e+2],p=Math.abs(m-f)+Math.abs(s-b)+Math.abs(d-g);a+=p/765}}this.dominantColor={r:Math.floor(h/l),g:Math.floor(o/l),b:Math.floor(n/l)},this.brightness=r/l,this.motionAmount=a/l}applyAudioToVisual(t){if(!this.analyser||!this.frequencyData)return;this.analyser.getByteFrequencyData(this.frequencyData);const i=Math.floor(this.frequencyData.length*.1),h=Math.floor(this.frequencyData.length*.1),o=Math.floor(this.frequencyData.length*.5),n=Math.floor(this.frequencyData.length*.5);let r=0,a=0,l=0;for(let s=0;s<i;s++)r+=this.frequencyData[s];for(let s=h;s<o;s++)a+=this.frequencyData[s];for(let s=n;s<this.frequencyData.length;s++)l+=this.frequencyData[s];this.bassLevel=r/(i*255),this.midLevel=a/((o-h)*255),this.highLevel=l/((this.frequencyData.length-n)*255),this.amplitude=(this.bassLevel+this.midLevel+this.highLevel)/3;const e=t.data,m=this.amplitude<.1;for(let s=0;s<e.length;s+=4){let d=e[s],c=e[s+1],f=e[s+2];if(this.bassLevel>.3){const u=this.bassLevel*v.effects.bassBlurIntensity;s>4&&(d=d*(1-u)+e[s-4]*u,c=c*(1-u)+e[s-3]*u,f=f*(1-u)+e[s-2]*u)}if(this.midLevel>.2){const u=this.midLevel*v.effects.midHueRotationSpeed*this.time,y=this.rgbToHsv(d,c,f);y.h=(y.h+u)%360;const C=this.hsvToRgb(y.h,y.s,y.v);d=C.r,c=C.g,f=C.b}if(this.highLevel>.3){const u=this.highLevel*v.effects.highEdgeIntensity;s>4&&Math.abs(d-e[s-4])+Math.abs(c-e[s-3])+Math.abs(f-e[s-2])>30&&(d=Math.min(255,d*(1+u)),c=Math.min(255,c*(1+u)),f=Math.min(255,f*(1+u)))}const b=1+this.amplitude*v.effects.amplitudeSaturation,g=this.rgbToHsv(d,c,f);g.s=Math.min(100,g.s*b);const p=this.hsvToRgb(g.h,g.s,g.v);if(d=p.r,c=p.g,f=p.b,m){const u=v.effects.silenceSolarization;d=d>128?255-(d-128)*u:d*(1+u),c=c>128?255-(c-128)*u:c*(1+u),f=f>128?255-(f-128)*u:f*(1+u)}e[s]=d,e[s+1]=c,e[s+2]=f}}rgbToHsv(t,i,h){t/=255,i/=255,h/=255;const o=Math.max(t,i,h),n=Math.min(t,i,h),r=o-n;let a=0;r!==0&&(o===t?a=(i-h)/r%6:o===i?a=(h-t)/r+2:a=(t-i)/r+4),a=Math.round(a*60),a<0&&(a+=360);const l=o===0?0:Math.round(r/o*100),e=Math.round(o*100);return{h:a,s:l,v:e}}hsvToRgb(t,i,h){t/=60,i/=100,h/=100;const o=h*i,n=o*(1-Math.abs(t%2-1)),r=h-o;let a,l,e;return t<1?[a,l,e]=[o,n,0]:t<2?[a,l,e]=[n,o,0]:t<3?[a,l,e]=[0,o,n]:t<4?[a,l,e]=[0,n,o]:t<5?[a,l,e]=[n,0,o]:[a,l,e]=[o,0,n],{r:Math.round((a+r)*255),g:Math.round((l+r)*255),b:Math.round((e+r)*255)}}update(t){super.update(t),this.time+=t,this.idlePhase+=t*.5,this.colorPhase+=t*v.wave.colorSpeed,this.startButton&&!this.synesthesiaActive&&(this.startButton.x=this.width/2,this.startButton.y=this.height/2+100)}render(){const t=this.ctx,i=this.width,h=this.height;if(this.synesthesiaActive&&this.currentFrame){t.save();const o=v.effects.colorTintStrength;if(t.globalCompositeOperation="multiply",t.fillStyle=`rgba(${this.dominantColor.r}, ${this.dominantColor.g}, ${this.dominantColor.b}, ${o})`,t.fillRect(0,0,i,h),t.globalCompositeOperation="source-over",t.drawImage(this.currentFrame,0,0,i,h),this.motionAmount>.1){t.save(),t.globalAlpha=this.motionAmount*v.effects.motionParticleRate,t.fillStyle=`hsl(${v.hue}, 100%, 60%)`;for(let n=0;n<this.motionAmount*20;n++){const r=Math.random()*i,a=Math.random()*h;t.fillRect(r,a,2,2)}t.restore()}t.restore(),this.backButton&&this.backButton.visible&&(t.save(),t.globalAlpha=1,t.shadowBlur=0,t.shadowColor="transparent",this.backButton.render(),t.restore())}else{const o=h/2;t.fillStyle="rgba(0, 0, 0, 0.15)",t.fillRect(0,0,i,h);const n=this.generateWavePoints(i,h,o);n.length>=2&&this.drawWave(t,n,i,h,o),this.startButton&&(t.save(),t.globalAlpha=1,t.shadowBlur=0,t.shadowColor="transparent",this.startButton.render(),t.restore())}}generateWavePoints(t,i,h){const o=[];for(let a=0;a<200;a++){const l=a/200*t,e=this.idlePhase,m=Math.sin(a*.05+e*.8)*.5*.3+Math.sin(a*.12-e*1.2)*.5*.2+Math.sin(a*.03+e*.3)*.05+(Math.random()-.5)*.5*.1,s=h+m*i*.4;o.push({x:l,y:s,v:m})}return o}drawWave(t,i,h,o,n){t.save();const r=v.hue+Math.sin(this.colorPhase)*v.hueRange,a=70,l=50;t.shadowColor=`hsl(${r}, ${a}%, ${l}%)`,t.shadowBlur=v.glowAmount,t.lineWidth=v.lineWidth,t.lineCap="round",t.lineJoin="round",t.strokeStyle=`hsl(${r}, ${a}%, ${l}%)`,t.beginPath(),t.moveTo(i[0].x,i[0].y);for(let m=1;m<i.length-1;m++){const s=i[m],d=i[m+1],c=s.x+(d.x-s.x)*.5,f=s.y+(d.y-s.y)*.5;t.quadraticCurveTo(s.x,s.y,c,f)}const e=i[i.length-1];t.lineTo(e.x,e.y),t.stroke(),t.globalAlpha=.6,t.lineWidth=v.lineWidth*.5,t.strokeStyle=`hsl(${r}, 100%, 90%)`,t.stroke(),t.restore()}stop(){if(this.videoStream&&this.videoStream.stop(),this.audioSource)try{this.audioSource.stop(),this.audioSource.disconnect()}catch{}this.audioContext&&this.audioContext.close(),this.videoElement&&(this.videoElement.srcObject=null),super.stop()}}function E(w){const t=new x(w);return t.start(),{stop:()=>t.stop(),game:t}}export{E as default};
