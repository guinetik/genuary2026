const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["assets/day14-BApK3_Yi.js","assets/day14.config-C2x5zr_q.js","assets/day19.grokking-BLQhquhM.js","assets/day19.utils-DeEDoNyc.js","assets/day19-Dyd4XAPM.js","assets/day19.worker-DnZQuLnN.js","assets/day25-BzEsJEQ1.js","assets/day25.config-DJwhhKHN.js","assets/day25.chemistry-fLO6Y1II.js","assets/day25.molecule-Baxzd6wS.js","assets/day25.ui-CVeRNEGR.js","assets/day25.lightning-BYJs8w6b.js","assets/day31.birds-BeLwQsgh.js","assets/day31.config-DDGTRykT.js","assets/day31-CApvlH2u.js","assets/day31.posters-Dmc02CF_.js","assets/day31.runner-B6sN3_uy.js","assets/day31.matrix-B7FGu3RC.js"])))=>i.map(i=>d[i]);
(function(){const t=document.createElement("link").relList;if(t&&t.supports&&t.supports("modulepreload"))return;for(const s of document.querySelectorAll('link[rel="modulepreload"]'))i(s);new MutationObserver(s=>{for(const n of s)if(n.type==="childList")for(const o of n.addedNodes)o.tagName==="LINK"&&o.rel==="modulepreload"&&i(o)}).observe(document,{childList:!0,subtree:!0});function e(s){const n={};return s.integrity&&(n.integrity=s.integrity),s.referrerPolicy&&(n.referrerPolicy=s.referrerPolicy),s.crossOrigin==="use-credentials"?n.credentials="include":s.crossOrigin==="anonymous"?n.credentials="omit":n.credentials="same-origin",n}function i(s){if(s.ep)return;s.ep=!0;const n=e(s);fetch(s.href,n)}})();const Ui="modulepreload",Vi=function(c){return"/"+c},ui={},z=function(t,e,i){let s=Promise.resolve();if(e&&e.length>0){document.getElementsByTagName("link");const o=document.querySelector("meta[property=csp-nonce]"),r=(o==null?void 0:o.nonce)||(o==null?void 0:o.getAttribute("nonce"));s=Promise.allSettled(e.map(a=>{if(a=Vi(a),a in ui)return;ui[a]=!0;const l=a.endsWith(".css"),h=l?'[rel="stylesheet"]':"";if(document.querySelector(`link[href="${a}"]${h}`))return;const d=document.createElement("link");if(d.rel=l?"stylesheet":Ui,l||(d.as="script"),d.crossOrigin="",d.href=a,r&&d.setAttribute("nonce",r),document.head.appendChild(d),l)return new Promise((u,f)=>{d.addEventListener("load",u),d.addEventListener("error",()=>f(new Error(`Unable to preload CSS for ${a}`)))})}))}function n(o){const r=new Event("vite:preloadError",{cancelable:!0});if(r.payload=o,window.dispatchEvent(r),!r.defaultPrevented)throw o}return s.then(o=>{for(const r of o||[])r.status==="rejected"&&n(r.reason);return t().catch(n)})},wi=(c,t,e)=>{const i=c[t];return i?typeof i=="function"?i():Promise.resolve(i):new Promise((s,n)=>{(typeof queueMicrotask=="function"?queueMicrotask:setTimeout)(n.bind(null,new Error("Unknown variable dynamic import: "+t+(t.split("/").length!==e?". Note that variables only represent file names one level deep.":""))))})},qi={1:"One color, one shape",2:"Twelve principles of animation",3:"Fibonacci forever",4:"Lowres",5:'Write "Genuary"',6:"Lights on/off",7:"Boolean algebra",8:"A City",9:"Crazy automaton",10:"Polar coordinates",11:"Quine",12:"Boxes only",13:"Self portrait",14:"Everything fits perfectly",15:"Invisible object",16:"Order and disorder",17:"Wallpaper group",18:"Unexpected path",19:"16x16",20:"One line",21:"Bauhaus Poster",22:"Pen plotter ready",23:"Transparency",24:"Perfectionist's nightmare",25:"Organic Geometry",26:"Recursive Grids",27:"Lifeform",28:"No libraries, only HTML",29:"Genetic evolution",30:"It's not a bug, it's a feature",31:"GLSL day"},$i={1:"Infinite green circles form a twisting wormhole through space",2:"Origami Murmuration: paper cranes flock together, demonstrating follow-through, overlapping action, and arcs. Move mouse to scatter, click to burst.",3:"Phyllotaxis: the Fibonacci spiral pattern you see in sunflowers and pinecones",4:"Banksy-inspired street art wall: infinite scrolling pixelated patterns on a midnight sidewalk",5:"Hand-coded 5x7 pixel font (no system fonts!) rendered as 3D fingerprint ridges. Particles orbit from G and spring into place. Mouse repels with glow.",6:'A digital lava lamp: toggle the "lights" to fade the heat, glow, and motion in/out',7:"Bitwise fractals: Sierpinski triangles and infinite patterns emerge from simple boolean operations like (x & y) and (x ^ y)",8:"Forge Star: a colonizer ship emerges from a wormhole to build a Dyson swarm to collect energy from the star. They dope the star with heavy elements to forge metals, shifting it from blue to purple.",9:"Fungal Hunger Games: 6 slime mold species battle for territory. Each follows its own trails, avoids enemies. Cross enemy trails = death. Dead become food (3 = 1 agent). Click to reinforce nearest colony.",10:"Hyperbolic Crochet: a polar (r,Î¸) wireframe mesh with exponential ruffling at the edges. A mathematical coral that crocheters create to visualize negative curvature. Click to excite the fabric.",11:"Matrix rain that fetches and displays its own source code. Hover to slow down and illuminate the text for reading. Click to reset.",12:"Isometric Mondrian: recursive grid subdivision rendered as 3D boxes with primary colors on black. Swipe/drag or Q/E to rotate, tap/click to regenerate.",13:"Pixel Teleporter: pixels fly from your image to reveal a hidden portrait. Layer multiple sources for variations.",14:"Tangram: 7 ancient puzzle pieces spring into cats, birds, runners, and more. Click to transform.",15:"Black Hole: an invisible singularity revealed only by gravitational lensing and its glowing accretion disk. Click to feed matter into the void.",16:"Maxwell's Demon: a tiny demon sorts hot and cold gas particles, seemingly violating the second law of thermodynamics. Order emerges from chaos... or does it? ðŸ˜ˆ",17:"Infinite PoincarÃ©: hyperbolic tessellation that never ends. Zoom in or out forever through nested disks within disks. Click to change pattern, drag to pan, scroll to dive deeper.",18:"Langton's Ant Ã— Particle Collider: two ants walk opposing planes (screen & exclusion blend). When paths cross, matter collides in bursts of light. Press [R] to restart.",19:"Grokking: a 16Ã—16 neural network learns modular arithmetic. Watch hidden neurons light up as it trains. If you think nothing is happening, wait. Click to restart.",20:"Ouroboros: the ancient serpent eating its own tail. One continuous line, eternally consuming and regenerating. Click to grow, drag to rotate.",21:"Procedural Bauhaus: Living geometric composition with primary colors and breathing shapes. Parallax layers respond to mouse, click to regenerate.",22:"Etch-a-Sketch: terminal-style drawing toy with rotary knobs. Drag to draw, shake to clear, [S] exports SVG for pen plotters.",23:"Liquid Glass: Apple-inspired metaball blobs with frosted glass refraction, chromatic aberration, and fresnel rim lighting. Move mouse to attract.",24:"Mathematician's Bad Dream: watch an irrational spiral grow from z(Î¸) = e^(Î¸i) + e^(Ï€Î¸i) and engulf you with patterns that never close. Inspired by Pi (1998). Drag to orbit, scroll to zoom.",25:"Primordial Soup: Simple molecules in a warm ocean, energized by lightning and hydrothermal vents. Watch amino acids and peptides emerge from chaos.",26:"Menger Sponge: 8,000 particles assemble into the 3D recursive fractal, one cube at a time. Double-click to scatter and watch them reform. Drag to orbit, scroll to zoom.",27:"Gaseous Sentience: click to feed it colored nebulae, watch it grow complex. It slowly starves as it radiates.",28:"GENUARY 2006: No canvas, only HTML! What if Genuary existed in 2006? Synthwave sunset, neon grid, VHS scanlines, and maximum vaporwave energy. Click to visit.",29:"SEIR epidemic model with viral mutation. Click agent to infect, watch variants emerge. Hospital zone (cyan) forces mutation pressure. [i] for analytics.",30:"Synesthesia Player: A feedback loop where music paints the screen and video affects the sound. It's not a bug, it's a feature!",31:"Finale: A synthwave tour into a black hole. Fractal skies, passing billboards, birds overhead. Move mouse to look around."};function Pe(c){return qi[c]||"Coming soon..."}function Mi(c){return $i[c]||"Coming soon..."}const _t=31,Si={1:"Spiral Galaxy",2:"Menger Sponge (GLSL)",3:"Menger Sponge (3D)",4:"Hilbert Curve Flow",5:"Boolean Algebra Demo",6:"Logic Gates",7:"Feynman Diagrams",8:"16x16",9:"ASCII Art",10:"Finale"},Zi={1:"Logarithmic spiral arms wind out from a supermassive black hole. Stars cluster along golden ratio spirals.",2:"GPU-raymarched Menger Sponge fractal with animated build progress. Drag to rotate, scroll to zoom.",3:"3D Menger Sponge rendered with particles assembling into the recursive fractal structure.",4:"Space-filling Hilbert curve with flowing particles tracing the infinite path.",5:"Interactive boolean algebra circuit visualization. Converts boolean expressions into logic gate circuits with animated signal propagation. Click to generate new expressions, drag to pan, scroll to zoom.",6:"Interactive logic gate simulator with visual circuit building.",7:"Feynman diagram particle physics visualization.",8:"An homage to No Man's Sky: 16x16 pixel art exploration in infinite space.",9:"Real-time ASCII art rendering with character-based graphics.",10:"Celebration visualization with domain warping, pulsing rings, and terminal green aesthetic. Mouse to interact."};function Ge(c){return Si[c]||"Unknown Kernel"}function di(c){return Zi[c]||"Experimental kernel"}function ji(c){return{1:"galaxy",2:"spongegl",3:"spongecube3d",4:"hilbert",5:"booleandemo",6:"gates",7:"feynman",8:"day19",9:"ascii",10:"finale"}[c]||null}const Me=Object.keys(Si).length;var Ki=Object.defineProperty,Ti=c=>{throw TypeError(c)},Qi=(c,t,e)=>t in c?Ki(c,t,{enumerable:!0,configurable:!0,writable:!0,value:e}):c[t]=e,P=(c,t,e)=>Qi(c,typeof t!="symbol"?t+"":t,e),Ze=(c,t,e)=>t.has(c)||Ti("Cannot "+e),b=(c,t,e)=>(Ze(c,t,"read from private field"),t.get(c)),N=(c,t,e)=>t.has(c)?Ti("Cannot add the same private member more than once"):t instanceof WeakSet?t.add(c):t.set(c,e),q=(c,t,e,i)=>(Ze(c,t,"write to private field"),t.set(c,e),e),st=(c,t,e)=>(Ze(c,t,"access private method"),e),yt,je,Ae,F,J,Ke,ie,Qe,kt,ct,ce,At,me,pe,ye,ve,_e,be,xe,Vt,$t,Ce,De,U,qt,j,Je,we,tt,se,ne,et,vt,he;class ti{constructor(t={}){this.children=[],this.sortByZIndex=t.sortByZIndex||!0,this._zOrderDirty=!1}add(t){return this.children.includes(t)?(console.warn("Object is already in this collection"),t):(this.children.push(t),t.parent=this._owner||this,this.sortByZIndex&&(this._zOrderDirty=!0,(t.zIndex===void 0||t.zIndex===null)&&(t.zIndex=this.children.length-1)),t)}remove(t){const e=this.children.indexOf(t);return e!==-1?(this.children.splice(e,1),t.parent=null,!0):!1}clear(){this.children.forEach(t=>{t.parent=null}),this.children=[]}bringToFront(t){const e=this.children.indexOf(t);if(e===-1){this.add(t);return}if(this.sortByZIndex){let i=!0;for(const s of this.children)if(s!==t&&(s.zIndex||0)>=(t.zIndex||0)){i=!1;break}i||(t.zIndex=Number.MAX_SAFE_INTEGER,this._zOrderDirty=!0,this._normalizeZIndices())}else e!==this.children.length-1&&(this.children.splice(e,1),this.children.push(t))}sendToBack(t){const e=this.children.indexOf(t);if(e===-1){this.children.unshift(t),t.parent=this._owner||this;return}if(this.sortByZIndex){let i=!0;for(const s of this.children)if(s!==t&&(s.zIndex||0)<=(t.zIndex||0)){i=!1;break}i||(t.zIndex=Number.MIN_SAFE_INTEGER,this._zOrderDirty=!0,this._normalizeZIndices())}else e!==0&&(this.children.splice(e,1),this.children.unshift(t))}bringForward(t){const e=this.children.indexOf(t);if(!(e===-1||e===this.children.length-1))if(this.sortByZIndex){const i=[...this.children].sort((n,o)=>(n.zIndex||0)-(o.zIndex||0)),s=i.indexOf(t);if(s<i.length-1){const n=i[s+1],o=n.zIndex||0,r=t.zIndex||0;o-r>1?t.zIndex=r+Math.floor((o-r)/2):(t.zIndex=o,n.zIndex=r),this._zOrderDirty=!0,this._normalizeZIndices()}}else{const i=this.children[e+1];this.children[e+1]=t,this.children[e]=i}}sendBackward(t){const e=this.children.indexOf(t);if(!(e<=0))if(this.sortByZIndex){const i=[...this.children].sort((n,o)=>(n.zIndex||0)-(o.zIndex||0)),s=i.indexOf(t);if(s>0){const n=i[s-1],o=n.zIndex||0,r=t.zIndex||0;r-o>1?t.zIndex=o+Math.floor((r-o)/2):(t.zIndex=o,n.zIndex=r),this._zOrderDirty=!0,this._normalizeZIndices()}}else{const i=this.children[e-1];this.children[e-1]=t,this.children[e]=i}}_normalizeZIndices(){if(this.children.length<=1)return;this.children.some(e=>(e.zIndex||0)>1e3||(e.zIndex||0)<-1e3)&&([...this.children].sort((i,s)=>(i.zIndex||0)-(s.zIndex||0)).forEach((i,s)=>{i.zIndex=s*10}),this._zOrderDirty=!0)}getSortedChildren(){return this.sortByZIndex&&this._zOrderDirty&&(this.children.sort((t,e)=>(t.zIndex||0)-(e.zIndex||0)),this._zOrderDirty=!1),this.children}}const Ht=class It{static calculate(t,e,i,s=10,n=0,o=0){const r=e.width||0,a=e.height||0,l=i.width||0,h=i.height||0,d=i.x||0,u=i.y||0;let f,g,m,p;switch(t){case It.TOP_LEFT:f=d-l/2+s+r/2,g=u-h/2+s+a/2,m="left",p="top";break;case It.TOP_CENTER:f=d,g=u-h/2+s+a/2,m="center",p="top";break;case It.TOP_RIGHT:f=d+l/2-s-r/2,g=u-h/2+s+a/2,m="right",p="top";break;case It.CENTER_LEFT:f=d-l/2+s+r/2,g=u,m="left",p="middle";break;case It.CENTER:f=d,g=u,m="center",p="middle";break;case It.CENTER_RIGHT:f=d+l/2-s-r/2,g=u,m="right",p="middle";break;case It.BOTTOM_LEFT:f=d-l/2+s+r/2,g=u+h/2-s-a/2,m="left",p="bottom";break;case It.BOTTOM_CENTER:f=d,g=u+h/2-s-a/2,m="center",p="bottom";break;case It.BOTTOM_RIGHT:f=d+l/2-s-r/2,g=u+h/2-s-a/2,m="right",p="bottom";break;default:f=d-l/2+s+r/2,g=u-h/2+s+a/2,m="left",p="top"}return f+=n,g+=o,{x:f,y:g,align:m,baseline:p}}static calculateAbsolute(t,e,i,s=10,n=0,o=0){const r={width:i.width,height:i.height,x:i.width/2,y:i.height/2};return It.calculate(t,e,r,s,n,o)}};P(Ht,"TOP_LEFT","top-left");P(Ht,"TOP_CENTER","top-center");P(Ht,"TOP_RIGHT","top-right");P(Ht,"CENTER_LEFT","center-left");P(Ht,"CENTER","center");P(Ht,"CENTER_RIGHT","center-right");P(Ht,"BOTTOM_LEFT","bottom-left");P(Ht,"BOTTOM_CENTER","bottom-center");P(Ht,"BOTTOM_RIGHT","bottom-right");let fi=Ht;function Ji(c,t,e={}){const i=e.offsetX??0,s=e.offsetY??0,n=e.transform;return c.forEach((o,r)=>{if(r<t.length){const a=t[r];if(n){const l=n(a);o.x=l.x+i,o.y=l.y+s}else o.x=a.x+i,o.y=a.y+s}}),c}function ts(c,t={}){const e=t.spacing??10,i=t.padding??0,s=t.align??"start",n=t.centerItems??!0;let o=i,r=0;const a=[];for(const d of c)r=Math.max(r,d.height??0);for(let d=0;d<c.length;d++){const u=c[d],f=u.width??0,g=u.height??0,m=n?o+f/2:o;let p;switch(s){case"center":p=(r-g)/2;break;case"end":p=r-g;break;case"start":default:p=0}a.push({x:m,y:p}),o+=f,d<c.length-1&&(o+=e)}const l=o+i,h=r+i*2;return{positions:a,width:l,height:h}}function es(c,t={}){const e=t.spacing??10,i=t.padding??0,s=t.align??"start",n=t.centerItems??!0;let o=i,r=0;const a=[];for(const d of c)r=Math.max(r,d.width??0);for(let d=0;d<c.length;d++){const u=c[d],f=u.width??0,g=u.height??0,m=n?o+g/2:o;let p;switch(s){case"center":p=(r-f)/2;break;case"end":p=r-f;break;case"start":default:p=0}a.push({x:p,y:m}),o+=g,d<c.length-1&&(o+=e)}const l=r+i*2,h=o+i;return{positions:a,width:l,height:h}}function is(c,t={}){if(c.length===0)return{positions:[],width:0,height:0};const e=t.columns??4,i=t.spacing??10,s=t.padding??0,n=t.centerItems??!0,o=c[0].width??0,r=c[0].height??0,a=Math.ceil(c.length/e),l=[],h=e*o+(e-1)*i+s*2,d=a*r+(a-1)*i+s*2;let u=s,f=s,g=0;for(let m=0;m<c.length;m++){const p=n?u+o/2:u,v=n?f+r/2:f;l.push({x:p,y:v}),g++,g<e?u+=o+i:(g=0,u=s,f+=r+i)}return{positions:l,width:h,height:d}}class On{constructor(t={}){this.rotationX=t.rotationX??0,this.rotationY=t.rotationY??0,this.rotationZ=t.rotationZ??0,this.x=t.x??0,this.y=t.y??0,this.z=t.z??0,this._initialRotationX=this.rotationX,this._initialRotationY=this.rotationY,this._initialRotationZ=this.rotationZ,this._initialX=this.x,this._initialY=this.y,this._initialZ=this.z,this.perspective=t.perspective??800,this.sensitivity=t.sensitivity??.005,this.minRotationX=t.minRotationX??-1.5,this.maxRotationX=t.maxRotationX??1.5,this.clampX=t.clampX??!0,this.autoRotate=t.autoRotate??!1,this.autoRotateSpeed=t.autoRotateSpeed??.5,this.autoRotateAxis=t.autoRotateAxis??"y",this.inertia=t.inertia??!1,this.friction=t.friction??.92,this.velocityScale=t.velocityScale??1,this._velocityX=0,this._velocityY=0,this._lastDeltaX=0,this._lastDeltaY=0,this._lastMoveTime=0,this._isDragging=!1,this._lastMouseX=0,this._lastMouseY=0,this._canvas=null,this._boundHandlers=null,this._followTarget=null,this._followOffset={x:0,y:0,z:0},this._followLookAt=!0,this._followLerp=.1,this._targetX=null,this._targetY=null,this._targetZ=null,this._targetRotationX=null,this._targetRotationY=null,this._positionLerp=.05}project(t,e,i){if(t-=this.x,e-=this.y,i-=this.z,this.rotationZ!==0){const m=Math.cos(this.rotationZ),p=Math.sin(this.rotationZ),v=t,_=e;t=v*m-_*p,e=v*p+_*m}const s=Math.cos(this.rotationY),n=Math.sin(this.rotationY),o=t*s-i*n,r=t*n+i*s,a=Math.cos(this.rotationX),l=Math.sin(this.rotationX),h=e*a-r*l,d=e*l+r*a,u=this.perspective/(this.perspective+d),f=o*u,g=h*u;return{x:f,y:g,z:d,scale:u}}projectAll(t){return t.map(e=>this.project(e.x,e.y,e.z))}update(t){var e,i,s;if(this._followTarget){const n=this._followTarget,o=(n.x??0)+this._followOffset.x,r=(n.y??0)+this._followOffset.y,a=(n.z??0)+this._followOffset.z;if(this.x+=(o-this.x)*this._followLerp,this.y+=(r-this.y)*this._followLerp,this.z+=(a-this.z)*this._followLerp,this._followLookAt){const l=((e=this._followLookAtTarget)==null?void 0:e.x)??0,h=((i=this._followLookAtTarget)==null?void 0:i.y)??0,d=((s=this._followLookAtTarget)==null?void 0:s.z)??0,u=l-this.x,f=h-this.y,g=d-this.z,m=Math.sqrt(u*u+g*g),p=Math.atan2(u,g),v=Math.atan2(-f,m);this.rotationY+=this._angleDiff(this.rotationY,p)*this._followLerp,this.rotationX+=(v-this.rotationX)*this._followLerp}}else if(this._targetX!==null){const n=this._positionLerp;this.x+=(this._targetX-this.x)*n,this.y+=(this._targetY-this.y)*n,this.z+=(this._targetZ-this.z)*n,this._targetRotationX!==null&&(this.rotationX+=(this._targetRotationX-this.rotationX)*n),this._targetRotationY!==null&&(this.rotationY+=this._angleDiff(this.rotationY,this._targetRotationY)*n),Math.abs(this._targetX-this.x)+Math.abs(this._targetY-this.y)+Math.abs(this._targetZ-this.z)<.1&&(this.x=this._targetX,this.y=this._targetY,this.z=this._targetZ,this._targetX=null,this._targetY=null,this._targetZ=null,this._targetRotationX=null,this._targetRotationY=null)}if(this.inertia&&!this._isDragging&&!this._followTarget&&(Math.abs(this._velocityX)>1e-4||Math.abs(this._velocityY)>1e-4)&&(this.rotationY+=this._velocityY,this.rotationX+=this._velocityX,this.clampX&&(this.rotationX=Math.max(this.minRotationX,Math.min(this.maxRotationX,this.rotationX))),this._velocityX*=this.friction,this._velocityY*=this.friction,Math.abs(this._velocityX)<1e-4&&(this._velocityX=0),Math.abs(this._velocityY)<1e-4&&(this._velocityY=0)),this.autoRotate&&!this._isDragging&&!this._followTarget&&!(Math.abs(this._velocityX)>.001||Math.abs(this._velocityY)>.001)){const o=this.autoRotateSpeed*t;switch(this.autoRotateAxis){case"x":this.rotationX+=o;break;case"y":this.rotationY+=o;break;case"z":this.rotationZ+=o;break}}}_angleDiff(t,e){let i=e-t;for(;i>Math.PI;)i-=Math.PI*2;for(;i<-Math.PI;)i+=Math.PI*2;return i}enableMouseControl(t,e={}){this._canvas&&this.disableMouseControl(),this._canvas=t;const i=e.invertX?-1:1,s=e.invertY?-1:1;return this._boundHandlers={mousedown:n=>{this._isDragging=!0,this._lastMouseX=n.clientX,this._lastMouseY=n.clientY,this._lastMoveTime=performance.now(),this._velocityX=0,this._velocityY=0},mousemove:n=>{if(!this._isDragging)return;const o=n.clientX-this._lastMouseX,r=n.clientY-this._lastMouseY,a=o*this.sensitivity*i,l=r*this.sensitivity*s;this.rotationY+=a,this.rotationX+=l,this.clampX&&(this.rotationX=Math.max(this.minRotationX,Math.min(this.maxRotationX,this.rotationX))),this.inertia&&(this._lastDeltaX=l,this._lastDeltaY=a,this._lastMoveTime=performance.now()),this._lastMouseX=n.clientX,this._lastMouseY=n.clientY},mouseup:()=>{this.inertia&&this._isDragging&&performance.now()-this._lastMoveTime<50&&(this._velocityX=this._lastDeltaX*this.velocityScale,this._velocityY=this._lastDeltaY*this.velocityScale),this._isDragging=!1},mouseleave:()=>{this.inertia&&this._isDragging&&performance.now()-this._lastMoveTime<50&&(this._velocityX=this._lastDeltaX*this.velocityScale,this._velocityY=this._lastDeltaY*this.velocityScale),this._isDragging=!1},touchstart:n=>{n.touches.length===1&&(this._isDragging=!0,this._lastMouseX=n.touches[0].clientX,this._lastMouseY=n.touches[0].clientY,this._lastMoveTime=performance.now(),this._velocityX=0,this._velocityY=0)},touchmove:n=>{if(!this._isDragging||n.touches.length!==1)return;n.preventDefault();const o=n.touches[0].clientX-this._lastMouseX,r=n.touches[0].clientY-this._lastMouseY,a=o*this.sensitivity*i,l=r*this.sensitivity*s;this.rotationY+=a,this.rotationX+=l,this.clampX&&(this.rotationX=Math.max(this.minRotationX,Math.min(this.maxRotationX,this.rotationX))),this.inertia&&(this._lastDeltaX=l,this._lastDeltaY=a,this._lastMoveTime=performance.now()),this._lastMouseX=n.touches[0].clientX,this._lastMouseY=n.touches[0].clientY},touchend:()=>{this.inertia&&this._isDragging&&performance.now()-this._lastMoveTime<50&&(this._velocityX=this._lastDeltaX*this.velocityScale,this._velocityY=this._lastDeltaY*this.velocityScale),this._isDragging=!1},dblclick:()=>{this.reset()}},t.addEventListener("mousedown",this._boundHandlers.mousedown),t.addEventListener("mousemove",this._boundHandlers.mousemove),t.addEventListener("mouseup",this._boundHandlers.mouseup),t.addEventListener("mouseleave",this._boundHandlers.mouseleave),t.addEventListener("touchstart",this._boundHandlers.touchstart),t.addEventListener("touchmove",this._boundHandlers.touchmove,{passive:!1}),t.addEventListener("touchend",this._boundHandlers.touchend),t.addEventListener("dblclick",this._boundHandlers.dblclick),this}disableMouseControl(){return this._canvas&&this._boundHandlers&&(this._canvas.removeEventListener("mousedown",this._boundHandlers.mousedown),this._canvas.removeEventListener("mousemove",this._boundHandlers.mousemove),this._canvas.removeEventListener("mouseup",this._boundHandlers.mouseup),this._canvas.removeEventListener("mouseleave",this._boundHandlers.mouseleave),this._canvas.removeEventListener("touchstart",this._boundHandlers.touchstart),this._canvas.removeEventListener("touchmove",this._boundHandlers.touchmove),this._canvas.removeEventListener("touchend",this._boundHandlers.touchend),this._canvas.removeEventListener("dblclick",this._boundHandlers.dblclick)),this._canvas=null,this._boundHandlers=null,this}reset(){return this.rotationX=this._initialRotationX,this.rotationY=this._initialRotationY,this.rotationZ=this._initialRotationZ,this.x=this._initialX,this.y=this._initialY,this.z=this._initialZ,this._velocityX=0,this._velocityY=0,this._followTarget=null,this._targetX=null,this._targetY=null,this._targetZ=null,this}stopInertia(){return this._velocityX=0,this._velocityY=0,this}setPosition(t,e,i){return this.x=t,this.y=e,this.z=i,this}moveTo(t,e,i,s={}){return this._targetX=t,this._targetY=e,this._targetZ=i,this._targetRotationX=s.rotationX??null,this._targetRotationY=s.rotationY??null,this._positionLerp=s.lerp??.05,this}follow(t,e={}){return this._followTarget=t,this._followOffset={x:e.offsetX??0,y:e.offsetY??0,z:e.offsetZ??0},this._followLookAt=e.lookAt??!0,this._followLookAtTarget=e.lookAtTarget??null,this._followLerp=e.lerp??.1,this}unfollow(t=!1){return this._followTarget=null,t&&this.moveTo(this._initialX,this._initialY,this._initialZ,{rotationX:this._initialRotationX,rotationY:this._initialRotationY,lerp:.05}),this}isFollowing(){return this._followTarget!==null}setRotation(t,e,i=0){return this.rotationX=t,this.rotationY=e,this.rotationZ=i,this}rotate(t,e,i=0){return this.rotationX+=t,this.rotationY+=e,this.rotationZ+=i,this.clampX&&(this.rotationX=Math.max(this.minRotationX,Math.min(this.maxRotationX,this.rotationX))),this}isDragging(){return this._isDragging}lookAt(t,e,i){const s=t-this.x,n=e-this.y,o=i-this.z,r=Math.sqrt(s*s+o*o);return this.rotationY=Math.atan2(s,o),this.rotationX=Math.atan2(-n,r),this}}class zn{constructor(t={}){this.angle=t.angle??0,this._targetAngle=this.angle,this.rotationStep=t.rotationStep??Math.PI/2,this.animationDuration=t.animationDuration??.4,this.easingType=t.easing??"easeInOutCubic",this._animating=!1,this._animationProgress=0,this._startAngle=0,this._onRotationStart=null,this._onRotationEnd=null}rotateRight(){return this._animating?this:(this._startRotation(this._targetAngle+this.rotationStep),this)}rotateLeft(){return this._animating?this:(this._startRotation(this._targetAngle-this.rotationStep),this)}rotateTo(t){return this._animating?this:(this._startRotation(t),this)}setAngle(t){return this.angle=t,this._targetAngle=t,this._animating=!1,this}_startRotation(t){this._startAngle=this.angle,this._targetAngle=t,this._animationProgress=0,this._animating=!0,this._onRotationStart&&this._onRotationStart(this._startAngle,this._targetAngle)}update(t){if(this._animating)if(this._animationProgress+=t/this.animationDuration,this._animationProgress>=1)this._animationProgress=1,this.angle=this._targetAngle,this._animating=!1,this._onRotationEnd&&this._onRotationEnd(this.angle);else{const e=this._ease(this._animationProgress);this.angle=this._startAngle+(this._targetAngle-this._startAngle)*e}}_ease(t){switch(this.easingType){case"linear":return t;case"easeInQuad":return t*t;case"easeOutQuad":return t*(2-t);case"easeInOutQuad":return t<.5?2*t*t:-1+(4-2*t)*t;case"easeInCubic":return t*t*t;case"easeOutCubic":return--t*t*t+1;case"easeInOutCubic":return t<.5?4*t*t*t:(t-1)*(2*t-2)*(2*t-2)+1;case"easeOutBack":const e=1.70158;return 1+(e+1)*Math.pow(t-1,3)+e*Math.pow(t-1,2);default:return t<.5?4*t*t*t:(t-1)*(2*t-2)*(2*t-2)+1}}isAnimating(){return this._animating}getAngleDegrees(){return this.angle*180/Math.PI%360}getNormalizedAngle(){let t=this.angle%(Math.PI*2);return t<0&&(t+=Math.PI*2),t}onRotationStart(t){return this._onRotationStart=t,this}onRotationEnd(t){return this._onRotationEnd=t,this}reset(){return this.setAngle(0),this}}class Yt{constructor(t,e=0){this.real=t,this.imag=e}static fromPolar(t,e){return new Yt(t*Math.cos(e),t*Math.sin(e))}add(t){return new Yt(this.real+t.real,this.imag+t.imag)}subtract(t){return new Yt(this.real-t.real,this.imag-t.imag)}multiply(t){return new Yt(this.real*t.real-this.imag*t.imag,this.real*t.imag+this.imag*t.real)}divide(t){return new Yt(this.real/t,this.imag/t)}scale(t){return new Yt(this.real*t,this.imag*t)}abs(){return Math.sqrt(this.real*this.real+this.imag*this.imag)}}class ki{static applyColorScheme(t,e,i,s,n,o){const r=(e==null?void 0:e.data)||[];for(let a=0;a<t.length;a++){const l=t[a],h=a*4;switch(i){case"futuristic":{const d=t[a]/10,u={r:0,g:5,b:10},f={r:0,g:30,b:20};if(d>.7){const g=(d-.7)*3.33;r[h]=Math.floor(u.r*(1-g)+f.r*g),r[h+1]=Math.floor(u.g*(1-g)+f.g*g),r[h+2]=Math.floor(u.b*(1-g)+f.b*g)}else{const g=d*1.43;r[h]=Math.floor(u.r*g),r[h+1]=Math.floor(u.g*g),r[h+2]=Math.floor(u.b*g)}r[h+3]=255}break;case"rainbow":if(l===0)r[h]=0,r[h+1]=0,r[h+2]=0,r[h+3]=255;else{const d=(l*10+n)%360,[u,f,g]=o(d,.8,.5);r[h]=u,r[h+1]=f,r[h+2]=g,r[h+3]=255}break;case"grayscale":{const d=l===0?0:255-l*255/s;r[h]=d,r[h+1]=d,r[h+2]=d,r[h+3]=255}break;case"binary":l!==0?(r[h]=0,r[h+1]=0,r[h+2]=0):(r[h]=255,r[h+1]=255,r[h+2]=255),r[h+3]=255;break;case"fire":{if(l==0)r[h]=0,r[h+1]=0,r[h+2]=0;else{const d=l/s;if(d<.3){const u=d/.3;r[h]=Math.floor(255*u),r[h+1]=0,r[h+2]=0}else if(d<.6){const u=(d-.3)/.3;r[h]=255,r[h+1]=Math.floor(165*u),r[h+2]=0}else if(d<.9){const u=(d-.6)/.3;r[h]=255,r[h+1]=165+Math.floor(90*u),r[h+2]=Math.floor(255*u)}else r[h]=255,r[h+1]=255,r[h+2]=255}r[h+3]=255}break;case"ocean":{if(l===0)r[h]=0,r[h+1]=20,r[h+2]=50;else{const d=l/s;r[h]=Math.floor(10+50*d),r[h+1]=Math.floor(50+150*d),r[h+2]=Math.floor(100+155*d)}r[h+3]=255}break;case"electric":{if(l===0)r[h]=0,r[h+1]=0,r[h+2]=0;else{const d=(l+n)%3,u=l%20/20;d===0?(r[h]=Math.floor(255*(.5+.5*Math.sin(u*Math.PI*2))),r[h+1]=Math.floor(128*u),r[h+2]=Math.floor(255*u)):d===1?(r[h]=Math.floor(255*u),r[h+1]=Math.floor(255*(.5+.5*Math.sin(u*Math.PI*2))),r[h+2]=Math.floor(128*u)):(r[h]=Math.floor(128*u),r[h+1]=Math.floor(255*u),r[h+2]=Math.floor(255*(.5+.5*Math.sin(u*Math.PI*2))))}r[h+3]=255}break;case"topographic":{if(l===0)r[h]=5,r[h+1]=15,r[h+2]=30;else{const d=l/s;if(d<.1){const u=d/.1;r[h]=Math.floor(5+20*u),r[h+1]=Math.floor(15+40*u),r[h+2]=Math.floor(30+50*u)}else if(d<.3){const u=(d-.1)/.2;r[h]=Math.floor(210+45*u),r[h+1]=Math.floor(180+40*u),r[h+2]=Math.floor(140+30*u)}else if(d<.7){const u=(d-.3)/.4;r[h]=Math.floor(50*(1-u)),r[h+1]=Math.floor(100+80*u),r[h+2]=Math.floor(50*(1-u))}else{const u=(d-.7)/.3;r[h]=Math.floor(150+105*u),r[h+1]=Math.floor(150+105*u),r[h+2]=Math.floor(150+105*u)}}r[h+3]=255}break;case"historic":default:{if(l===0)r[h]=0,r[h+1]=0,r[h+2]=0;else{const u=(l+n)%64;u<16?(r[h]=u*16,r[h+1]=0,r[h+2]=0):u<32?(r[h]=255,r[h+1]=(u-16)*16,r[h+2]=0):u<48?(r[h]=255-(u-32)*16,r[h+1]=255,r[h+2]=0):(r[h]=0,r[h+1]=255-(u-48)*16,r[h+2]=(u-48)*16)}r[h+3]=255}}}return e??r}static pythagorasTree(t,e,i=10,s=-2,n=2,o=-.5,r=3.5){const a=new Uint8Array(t*e),l=x=>Math.floor((x-s)*t/(n-s)),h=x=>Math.floor((x-o)*e/(r-o)),d=(x,S,k,C)=>{const M=l(x),R=h(S),D=l(k),A=h(C);let O=M,E=R;const L=Math.abs(D-M),X=Math.abs(A-R),H=M<D?1:-1,it=R<A?1:-1;let Z=L-X;for(;O>=0&&O<t&&E>=0&&E<e&&(a[E*t+O]=255),!(O===D&&E===A);){const ht=2*Z;ht>-X&&(Z-=X,O+=H),ht<L&&(Z+=L,E+=it)}},u=(x,S,k,C,M,R,D,A)=>{d(x,S,k,C),d(k,C,M,R),d(M,R,D,A),d(D,A,x,S)},f=(x,S,k,C,M)=>{if(M<=0)return;const R=k-x,D=C-S,A=k+D,O=C-R,E=x+D,L=S-R;u(x,S,k,C,A,O,E,L);const X=Math.PI/4,H=Math.sqrt(R*R+D*D)*.7,it=H*Math.cos(Math.atan2(D,R)-X),Z=H*Math.sin(Math.atan2(D,R)-X),ht=Math.sqrt(R*R+D*D)*.7,Tt=ht*Math.cos(Math.atan2(D,R)+X),bt=ht*Math.sin(Math.atan2(D,R)+X),xt=A,rt=O,nt=E,ut=L,le=xt+it,Qt=rt+Z,de=nt+Tt,Et=ut+bt;f(xt,rt,le,Qt,M-1),f(nt,ut,de,Et,M-1)},g=Math.min(i,12),m=1,p=-1/2,v=0,_=m/2;return f(p,v,_,0,g),a}static mandelbrot(t,e,i=100,s=-2.5,n=1,o=-1.5,r=1.5){const a=new Uint8Array(t*e),l=(n-s)/t,h=(r-o)/e;for(let d=0;d<e;d++){const u=d*t,f=o+d*h;for(let g=0;g<t;g++){const m=s+g*l;let p=0,v=0,_=0,w=0,x=0;do{const S=_-w+m;v=2*p*v+f,p=S,_=p*p,w=v*v,x++}while(_+w<4&&x<i);a[u+g]=x<i?x%256:0}}return a}static julia(t,e,i=100,s=-.7,n=.27,o=1,r=0,a=0){const l=new Uint8Array(t*e),h=2/o,d=-h+r,u=h+r,f=-h+a,g=h+a,m=(u-d)/t,p=(g-f)/e;for(let v=0;v<e;v++){const _=v*t,w=f+v*p;for(let x=0;x<t;x++){let k=d+x*m,C=w,M=0,R=0,D=0;do{M=k*k,R=C*C;const A=M-R+s;C=2*k*C+n,k=A,D++}while(M+R<4&&D<i);l[_+x]=D<i?D%256:0}}return l}static tricorn(t,e,i=100,s=-2.5,n=1.5,o=-1.5,r=1.5){const a=new Uint8Array(t*e),l=(n-s)/t,h=(r-o)/e;for(let d=0;d<e;d++){const u=d*t,f=o+d*h;for(let g=0;g<t;g++){const m=s+g*l;let p=0,v=0,_=0,w=0,x=0;do{const S=_-w+m;v=-2*p*v+f,p=S,_=p*p,w=v*v,x++}while(_+w<4&&x<i);a[u+g]=x<i?x%256:0}}return a}static phoenix(t,e,i=100,s=.5,n=.5,o=-2,r=2,a=-2,l=2){const h=new Uint8Array(t*e),d=(r-o)/t,u=(l-a)/e;for(let f=0;f<e;f++){const g=f*t,m=a+f*u;for(let p=0;p<t;p++){const v=o+p*d;let _=0,w=0,x=0,S=0,k=0,C=0,M=0;do{const R=k-C+v+s*x+n,D=2*_*w+m+s*S;x=_,S=w,_=R,w=D,k=_*_,C=w*w,M++}while(k+C<4&&M<i);h[g+p]=M<i?M%256:0}}return h}static newton(t,e,i=100,s=1e-6,n=-2,o=2,r=-2,a=2){const l=new Uint8Array(t*e),h=s*s,d=o-n,u=a-r,f=3,g=new Float64Array(f),m=new Float64Array(f);for(let _=0;_<f;_++){const w=2*Math.PI*_/f;g[_]=Math.cos(w),m[_]=Math.sin(w)}const p=d/t,v=u/e;for(let _=0;_<e;_++){const w=_*t,x=r+_*v;for(let S=0;S<t;S++){let C=n+S*p,M=x,R=0,D=-1;for(;R<i&&D<0;){const A=C*C-M*M,O=2*C*M,E=A*C-O*M-1,L=A*M+O*C,X=3*A,H=3*O,it=X*X+H*H;if(it<h)break;const Z=1/it,ht=(E*X+L*H)*Z,Tt=(L*X-E*H)*Z,bt=C-ht,xt=M-Tt;for(let rt=0;rt<f;rt++){const nt=bt-g[rt],ut=xt-m[rt];if(nt*nt+ut*ut<h){D=rt;break}}C=bt,M=xt,R++}if(D>=0){const A=1-Math.min(R/i,1),O=D*(255/f);l[w+S]=Math.floor(O+A*(255/f))}else l[w+S]=0}}return l}static sierpinski(t,e,i=6,s=0,n=1,o=0,r=1){const a=new Uint8Array(t*e).fill(1),l=Math.sqrt(3)/2,h=n-s,u=(r-o)/h;if(Math.abs(u-l)>1e-9){const _=(o+r)/2,w=h*l;o=_-w/2,r=_+w/2}const g=(1<<Math.min(i,32))-1,m=(n-s)/t,p=(r-o)/e,v=2/Math.sqrt(3);for(let _=0;_<e;++_){const w=o+_*p,x=Math.floor(w*v),S=x*.5;for(let k=0;k<t;++k){const C=s+k*m;Math.floor(C-S)&x&g&&(a[_*t+k]=0)}}return a}static sierpinskiCarpet(t,e,i=5,s=0,n=1,o=0,r=1){const a=new Uint8Array(t*e).fill(1),l=n-s,h=r-o,d=Math.max(l,h),u=(s+n)/2,f=(o+r)/2;s=u-d/2,n=u+d/2,o=f-d/2,r=f+d/2;const g=Math.pow(3,i),m=(p,v)=>{let _=p,w=v;for(;_>0||w>0;){if(_%3===1&&w%3===1)return!0;_=Math.floor(_/3),w=Math.floor(w/3)}return!1};for(let p=0;p<e;++p){const _=(o+p/e*(r-o))*g,w=(Math.floor(_)%g+g)%g;for(let x=0;x<t;++x){const k=(s+x/t*(n-s))*g,C=(Math.floor(k)%g+g)%g;m(C,w)&&(a[p*t+x]=0)}}return a}static barnsleyFern(t,e,i=1e5){const s=new Uint8Array(t*e).fill(0);let n=0,o=0;const r=Math.min(t,e)/10,a=t/2;for(let l=0;l<i;l++){const h=Math.random();let d,u;h<.01?(d=0,u=.16*o):h<.86?(d=.85*n+.04*o,u=-.04*n+.85*o+1.6):h<.93?(d=.2*n-.26*o,u=.23*n+.22*o+1.6):(d=-.15*n+.28*o,u=.26*n+.24*o+.44),n=d,o=u;const f=Math.floor(n*r+a),g=Math.floor(e-o*r);if(f>=0&&f<t&&g>=0&&g<e){const m=g*t+f;s[m]<255&&s[m]++}}return s}static lyapunov(t,e,i=1e3,s="AB",n=3.4,o=4,r=3.4,a=4){console.time("lyapunov"),s=s.toUpperCase().replace(/[^AB]/g,"")||"AB";const l=s.length,h=new Float32Array(t*e);let d=1/0,u=-1/0;for(let m=0;m<e;m++){const p=r+(a-r)*m/e;for(let v=0;v<t;v++){const _=n+(o-n)*v/t;let w=.5;for(let C=0;C<100;C++)w=(s[C%l]==="A"?_:p)*w*(1-w);let x=0,S=0;for(;S<i;){const C=s[S%l]==="A"?_:p;w=C*w*(1-w);const M=Math.abs(C*(1-2*w));if(x+=Math.log(Math.max(M,1e-10)),S++,Math.abs(x/S)>10)break}const k=x/S;h[m*t+v]=k,k>-10&&k<10&&(k<d&&(d=k),k>u&&(u=k))}}d===u&&(d-=1,u+=1);const f=u-d,g=new Uint8Array(t*e);for(let m=0;m<h.length;m++){let p=h[m];p=Math.max(-10,Math.min(10,p));let v=(p-d)/f;g[m]=Math.floor(v*255)}return console.timeEnd("lyapunov"),g}static koch(t,e,i=4,s=-2,n=2,o=-2,r=2){const a=new Uint8Array(t*e),l=w=>Math.floor((w-s)*t/(n-s)),h=w=>Math.floor((w-o)*e/(r-o)),d=(w,x,S,k)=>{const C=l(w),M=h(x),R=l(S),D=h(k);let A=C,O=M;const E=Math.abs(R-C),L=Math.abs(D-M),X=C<R?1:-1,H=M<D?1:-1;let it=E-L;for(;A>=0&&A<t&&O>=0&&O<e&&(a[O*t+A]=255),!(A===R&&O===D);){const Z=2*it;Z>-L&&(it-=L,A+=X),Z<E&&(it+=E,O+=H)}},u=(w,x,S,k,C)=>{if(C<=0){d(w,x,S,k);return}const M=(S-w)/3,R=(k-x)/3,D=w+M,A=x+R,O=w+2*M,E=x+2*R,L=Math.PI/3,X=D+M*Math.cos(L)-R*Math.sin(L),H=A+M*Math.sin(L)+R*Math.cos(L);u(w,x,D,A,C-1),u(D,A,X,H,C-1),u(X,H,O,E,C-1),u(O,E,S,k,C-1)},f=Math.min(i,10),g=3,m=g*Math.sqrt(3)/2,p=[0,-m/2+.5],v=[-3/2,m/2+.5],_=[g/2,m/2+.5];return u(p[0],p[1],v[0],v[1],f),u(v[0],v[1],_[0],_[1],f),u(_[0],_[1],p[0],p[1],f),a}}P(ki,"types",{MANDELBROT:"mandelbrot",TRICORN:"tricorn",PHOENIX:"phoenix",JULIA:"julia",SIERPINSKI:"sierpinski",SCARPET:"sierpinskiCarpet",BARNSEY_FERN:"barnsleyFern",KOCH:"koch",PYTHAGORAS_TREE:"pythagorasTree",NEWTON:"newton",LYAPUNOV:"lyapunov"});P(ki,"colors",{FUTURISTIC:"futuristic",RAINBOW:"rainbow",GRAYSCALE:"grayscale",TOPOGRAPHIC:"topographic",FIRE:"fire",OCEAN:"ocean",ELECTRIC:"electric",BINARY:"binary",HISTORIC:"historic"});const Q=class{static seed(t){t>0&&t<1&&(t*=65536),t=Math.floor(t),t<256&&(t|=t<<8);for(let e=0;e<256;e++){let i;e&1?i=b(this,Ae)[e]^t&255:i=b(this,Ae)[e]^t>>8&255,b(this,F)[e]=b(this,F)[e+256]=i,b(this,J)[e]=b(this,J)[e+256]=b(this,je)[i%12]}}static simplex2(t,e){let i,s,n;const o=(t+e)*b(this,Ke),r=Math.floor(t+o),a=Math.floor(e+o),l=(r+a)*b(this,ie),h=t-r+l,d=e-a+l;let u,f;h>d?(u=1,f=0):(u=0,f=1);const g=h-u+b(this,ie),m=d-f+b(this,ie),p=h-1+2*b(this,ie),v=d-1+2*b(this,ie),_=r&255,w=a&255,x=b(this,J)[_+b(this,F)[w]],S=b(this,J)[_+u+b(this,F)[w+f]],k=b(this,J)[_+1+b(this,F)[w+1]];let C=.5-h*h-d*d;C<0?i=0:(C*=C,i=C*C*x.dot2(h,d));let M=.5-g*g-m*m;M<0?s=0:(M*=M,s=M*M*S.dot2(g,m));let R=.5-p*p-v*v;return R<0?n=0:(R*=R,n=R*R*k.dot2(p,v)),70*(i+s+n)}static simplex3(t,e,i){let s,n,o,r;const a=(t+e+i)*b(this,Qe),l=Math.floor(t+a),h=Math.floor(e+a),d=Math.floor(i+a),u=(l+h+d)*b(this,kt),f=t-l+u,g=e-h+u,m=i-d+u;let p,v,_,w,x,S;f>=g?g>=m?(p=1,v=0,_=0,w=1,x=1,S=0):f>=m?(p=1,v=0,_=0,w=1,x=0,S=1):(p=0,v=0,_=1,w=1,x=0,S=1):g<m?(p=0,v=0,_=1,w=0,x=1,S=1):f<m?(p=0,v=1,_=0,w=0,x=1,S=1):(p=0,v=1,_=0,w=1,x=1,S=0);const k=f-p+b(this,kt),C=g-v+b(this,kt),M=m-_+b(this,kt),R=f-w+2*b(this,kt),D=g-x+2*b(this,kt),A=m-S+2*b(this,kt),O=f-1+3*b(this,kt),E=g-1+3*b(this,kt),L=m-1+3*b(this,kt),X=l&255,H=h&255,it=d&255,Z=b(this,J)[X+b(this,F)[H+b(this,F)[it]]],ht=b(this,J)[X+p+b(this,F)[H+v+b(this,F)[it+_]]],Tt=b(this,J)[X+w+b(this,F)[H+x+b(this,F)[it+S]]],bt=b(this,J)[X+1+b(this,F)[H+1+b(this,F)[it+1]]];let xt=.6-f*f-g*g-m*m;xt<0?s=0:(xt*=xt,s=xt*xt*Z.dot3(f,g,m));let rt=.6-k*k-C*C-M*M;rt<0?n=0:(rt*=rt,n=rt*rt*ht.dot3(k,C,M));let nt=.6-R*R-D*D-A*A;nt<0?o=0:(nt*=nt,o=nt*nt*Tt.dot3(R,D,A));let ut=.6-O*O-E*E-L*L;return ut<0?r=0:(ut*=ut,r=ut*ut*bt.dot3(O,E,L)),32*(s+n+o+r)}static perlin2(t,e){const i=Math.floor(t),s=Math.floor(e);t=t-i,e=e-s;const n=i&255,o=s&255,r=b(this,J)[n+b(this,F)[o]].dot2(t,e),a=b(this,J)[n+b(this,F)[o+1]].dot2(t,e-1),l=b(this,J)[n+1+b(this,F)[o]].dot2(t-1,e),h=b(this,J)[n+1+b(this,F)[o+1]].dot2(t-1,e-1),d=st(this,ct,ce).call(this,t);return st(this,ct,At).call(this,st(this,ct,At).call(this,r,l,d),st(this,ct,At).call(this,a,h,d),st(this,ct,ce).call(this,e))}static perlin3(t,e,i){const s=Math.floor(t),n=Math.floor(e),o=Math.floor(i);t=t-s,e=e-n,i=i-o;const r=s&255,a=n&255,l=o&255,h=b(this,J)[r+b(this,F)[a+b(this,F)[l]]].dot3(t,e,i),d=b(this,J)[r+b(this,F)[a+b(this,F)[l+1]]].dot3(t,e,i-1),u=b(this,J)[r+b(this,F)[a+1+b(this,F)[l]]].dot3(t,e-1,i),f=b(this,J)[r+b(this,F)[a+1+b(this,F)[l+1]]].dot3(t,e-1,i-1),g=b(this,J)[r+1+b(this,F)[a+b(this,F)[l]]].dot3(t-1,e,i),m=b(this,J)[r+1+b(this,F)[a+b(this,F)[l+1]]].dot3(t-1,e,i-1),p=b(this,J)[r+1+b(this,F)[a+1+b(this,F)[l]]].dot3(t-1,e-1,i),v=b(this,J)[r+1+b(this,F)[a+1+b(this,F)[l+1]]].dot3(t-1,e-1,i-1),_=st(this,ct,ce).call(this,t),w=st(this,ct,ce).call(this,e),x=st(this,ct,ce).call(this,i);return st(this,ct,At).call(this,st(this,ct,At).call(this,st(this,ct,At).call(this,h,g,_),st(this,ct,At).call(this,d,m,_),x),st(this,ct,At).call(this,st(this,ct,At).call(this,u,p,_),st(this,ct,At).call(this,f,v,_),x),w)}};yt=new WeakMap;je=new WeakMap;Ae=new WeakMap;F=new WeakMap;J=new WeakMap;Ke=new WeakMap;ie=new WeakMap;Qe=new WeakMap;kt=new WeakMap;ct=new WeakSet;ce=function(c){return c*c*c*(c*(c*6-15)+10)};At=function(c,t,e){return(1-e)*c+e*t};N(Q,ct);N(Q,yt,class{constructor(c,t,e){this.x=c,this.y=t,this.z=e}dot2(c,t){return this.x*c+this.y*t}dot3(c,t,e){return this.x*c+this.y*t+this.z*e}});N(Q,je,[new(b(Q,yt))(1,1,0),new(b(Q,yt))(-1,1,0),new(b(Q,yt))(1,-1,0),new(b(Q,yt))(-1,-1,0),new(b(Q,yt))(1,0,1),new(b(Q,yt))(-1,0,1),new(b(Q,yt))(1,0,-1),new(b(Q,yt))(-1,0,-1),new(b(Q,yt))(0,1,1),new(b(Q,yt))(0,-1,1),new(b(Q,yt))(0,1,-1),new(b(Q,yt))(0,-1,-1)]);N(Q,Ae,[151,160,137,91,90,15,131,13,201,95,96,53,194,233,7,225,140,36,103,30,69,142,8,99,37,240,21,10,23,190,6,148,247,120,234,75,0,26,197,62,94,252,219,203,117,35,11,32,57,177,33,88,237,149,56,87,174,20,125,136,171,168,68,175,74,165,71,134,139,48,27,166,77,146,158,231,83,111,229,122,60,211,133,230,220,105,92,41,55,46,245,40,244,102,143,54,65,25,63,161,1,216,80,73,209,76,132,187,208,89,18,169,200,196,135,130,116,188,159,86,164,100,109,198,173,186,3,64,52,217,226,250,124,123,5,202,38,147,118,126,255,82,85,212,207,206,59,227,47,16,58,17,182,189,28,42,223,183,170,213,119,248,152,2,44,154,163,70,221,153,101,155,167,43,172,9,129,22,39,253,19,98,108,110,79,113,224,232,178,185,112,104,218,246,97,228,251,34,242,193,238,210,144,12,191,179,162,241,81,51,145,235,249,14,239,107,49,192,214,31,181,199,106,157,184,84,204,176,115,121,50,45,127,4,150,254,138,236,205,93,222,114,67,29,24,72,243,141,128,195,78,66,215,61,156,180]);N(Q,F,new Array(512));N(Q,J,new Array(512));N(Q,Ke,.5*(Math.sqrt(3)-1));N(Q,ie,(3-Math.sqrt(3))/6);N(Q,Qe,1/3);N(Q,kt,1/6);Q.seed(0);let Pt=Q;function ss(c=800,t=800,e){const{divisions:i=5,zoomType:s="in",color1:n=[255,0,0,255],color2:o=[0,0,255,255],color3:r=[0,0,0,255],backgroundColor:a=[255,255,255,255]}=e||{},l=new Uint8ClampedArray(c*t*4);for(let x=0;x<l.length;x+=4)l[x]=a[0],l[x+1]=a[1],l[x+2]=a[2],l[x+3]=a[3]||255;const h=s==="in"?1:2,d=Math.max(c,t),u=d/h,f=d/h,g=.5*h,m=.5*h,p=(Math.sqrt(5)+1)/2,v=5;let _=[];for(let x=0;x<v*2;x++){const S=Yt.fromPolar(1,(2*x-1)*Math.PI/(v*2)),k=Yt.fromPolar(1,(2*x+1)*Math.PI/(v*2));x%2===0?_.push(["thin",new Yt(0),k,S]):_.push(["thin",new Yt(0),S,k])}for(let x=0;x<i;x++){const S=[];for(const[k,C,M,R]of _)if(k==="thin"){const D=C.add(M.subtract(C).scale(1/p));S.push(["thin",R,D,M]),S.push(["thicc",D,R,C])}else{const D=M.add(C.subtract(M).scale(1/p)),A=M.add(R.subtract(M).scale(1/p));S.push(["thicc",A,R,C]),S.push(["thicc",D,A,M]),S.push(["thin",A,D,C])}_=S}function w(x){const S=Math.floor((x.real*u+g*u)*c/d),k=Math.floor((x.imag*f+m*f)*t/d);return{x:S,y:k}}for(const[x,S,k,C]of _){const M=w(S),R=w(k),D=w(C);ns(l,M,R,D,x==="thin"?n:o,c,t)}if(r&&r[3]>0)for(const[x,S,k,C]of _){const M=w(S),R=w(k),D=w(C);We(l,M,R,r,c,t),We(l,R,D,r,c,t),We(l,D,M,r,c,t)}return l}function ns(c,t,e,i,s,n,o){t.y>e.y&&([t,e]=[e,t]),t.y>i.y&&([t,i]=[i,t]),e.y>i.y&&([e,i]=[i,e]);const r=s[0],a=s[1],l=s[2],h=s[3]||255;if(e.y===i.y)gi(c,t,e,i,r,a,l,h,n,o);else if(t.y===e.y)mi(c,t,e,i,r,a,l,h,n,o);else{const d={x:Math.floor(t.x+(e.y-t.y)/(i.y-t.y)*(i.x-t.x)),y:e.y};gi(c,t,e,d,r,a,l,h,n,o),mi(c,e,d,i,r,a,l,h,n,o)}}function gi(c,t,e,i,s,n,o,r,a,l){const h=(e.x-t.x)/(e.y-t.y||1),d=(i.x-t.x)/(i.y-t.y||1);let u=t.x,f=t.x;for(let g=t.y;g<=e.y;g++){if(g>=0&&g<l){const m=Math.max(0,Math.min(Math.floor(u),a-1)),p=Math.max(0,Math.min(Math.floor(f),a-1));for(let v=Math.min(m,p);v<=Math.max(m,p);v++){const _=(g*a+v)*4;_>=0&&_<c.length-3&&(c[_]=s,c[_+1]=n,c[_+2]=o,c[_+3]=r)}}u+=h,f+=d}}function mi(c,t,e,i,s,n,o,r,a,l){const h=(i.x-t.x)/(i.y-t.y||1),d=(i.x-e.x)/(i.y-e.y||1);let u=i.x,f=i.x;for(let g=i.y;g>t.y;g--)if(g>=0&&g<l){u-=h,f-=d;const m=Math.max(0,Math.min(Math.floor(u),a-1)),p=Math.max(0,Math.min(Math.floor(f),a-1));for(let v=Math.min(m,p);v<=Math.max(m,p);v++){const _=(g*a+v)*4;_>=0&&_<c.length-3&&(c[_]=s,c[_+1]=n,c[_+2]=o,c[_+3]=r)}}}function We(c,t,e,i,s,n){const o=i[0],r=i[1],a=i[2],l=i[3]||255;let h=t.x,d=t.y,u=e.x,f=e.y;const g=Math.abs(u-h),m=Math.abs(f-d),p=h<u?1:-1,v=d<f?1:-1;let _=g-m;for(;;){if(h>=0&&h<s&&d>=0&&d<n){const x=(d*s+h)*4;if(x>=0&&x<c.length-3){const S=l/255;c[x]=Math.round(c[x]*(1-S)+o*S),c[x+1]=Math.round(c[x+1]*(1-S)+r*S),c[x+2]=Math.round(c[x+2]*(1-S)+a*S),c[x+3]=255}}if(h===u&&d===f)break;const w=2*_;w>-m&&(_-=m,h+=p),w<g&&(_+=g,d+=v)}}class Yn{static void(t,e,i={}){const{background:s=[255,255,255,255],foreground:n=[0,0,200,255]}=i,o=new Uint8ClampedArray(t*e*4);for(let r=0;r<o.length;r+=4)o[r]=s[0],o[r+1]=s[1],o[r+2]=s[2],o[r+3]=s[3];return o}static solidGrid(t,e,i={}){const{spacing:s=8,background:n=[0,0,0,0],foreground:o=[128,128,128,255]}=i,r=new Uint8ClampedArray(t*e*4);for(let a=0;a<e;a++){const l=a%s===0;for(let h=0;h<t;h++){const u=h%s===0||l,f=(a*t+h)*4,g=u?o:n;r[f]=g[0],r[f+1]=g[1],r[f+2]=g[2],r[f+3]=g[3]}}return r}static checkerboard(t,e,i={}){const{cellSize:s=8,color1:n=[0,0,0,255],color2:o=[255,255,255,255]}=i,r=new Uint8ClampedArray(t*e*4);for(let a=0;a<e;a++){const l=Math.floor(a/s);for(let h=0;h<t;h++){const f=(Math.floor(h/s)+l)%2===0?n:o,g=(a*t+h)*4;r.set(f,g)}}return r}static stripes(t,e,i={}){const{spacing:s=4,thickness:n=1,background:o=[0,0,0,0],foreground:r=[255,255,0,255]}=i,a=new Uint8ClampedArray(t*e*4);for(let l=0;l<e;l++)for(let h=0;h<t;h++){const u=(h+l)%s<n,f=(l*t+h)*4;a.set(u?r:o,f)}return a}static honeycomb(t,e,i={}){const{radius:s=10,lineWidth:n=1,foreground:o=[255,255,255,255],background:r=[0,0,0,255]}=i,a=new Uint8ClampedArray(t*e*4);for(let _=0;_<a.length;_+=4)a[_]=r[0],a[_+1]=r[1],a[_+2]=r[2],a[_+3]=r[3];const l=Math.floor(t/2),h=Math.floor(e/2),d=(_,w,x,S,k)=>{const C=Math.abs(_-x),M=Math.abs(w-S),R=k*Math.sqrt(3)/2;return M>R||C>k?!1:k*R*2>=k*M*2+R*C},u=s-n,f=s*Math.sqrt(3),g=Math.max(0,Math.floor(l-s-1)),m=Math.min(t-1,Math.ceil(l+s+1)),p=Math.max(0,Math.floor(h-f/2-1)),v=Math.min(e-1,Math.ceil(h+f/2+1));for(let _=p;_<=v;_++)for(let w=g;w<=m;w++){const x=d(w,_,l,h,s),S=u>0?d(w,_,l,h,u):!1;if(x&&!S){const k=(_*t+w)*4;a[k]=o[0],a[k+1]=o[1],a[k+2]=o[2],a[k+3]=o[3]}}return a}static harlequin(t,e,i={}){const{size:s=20,spacing:n=0,background:o=[255,255,255,255],foreground:r=[0,0,0,255]}=i,a=new Uint8ClampedArray(t*e*4);for(let g=0;g<a.length;g+=4)a[g]=o[0],a[g+1]=o[1],a[g+2]=o[2],a[g+3]=o[3];const l=s*2,h=s*2,d=l+n,u=h+n,f=(g,m,p,v)=>{const _=Math.abs(g-p)/(l/2),w=Math.abs(m-v)/(h/2);return _+w<=1};for(let g=-1;g<e/u+1;g++)for(let m=-1;m<t/d+1;m++){const p=m*d+d/2,v=g*u+u/2;if(!((g+m)%2===0))continue;const w=Math.max(0,Math.floor(p-l/2)),x=Math.min(t-1,Math.ceil(p+l/2)),S=Math.max(0,Math.floor(v-h/2)),k=Math.min(e-1,Math.ceil(v+h/2));for(let C=S;C<=k;C++)for(let M=w;M<=x;M++)if(f(M,C,p,v)){const R=(C*t+M)*4;a[R]=r[0],a[R+1]=r[1],a[R+2]=r[2],a[R+3]=r[3]}}return a}static circles(t,e,i={}){const{radius:s=10,lineWidth:n=2,spacing:o=5,background:r=[0,0,0,255],foreground:a=[255,255,255,255]}=i,l=new Uint8ClampedArray(t*e*4);for(let u=0;u<l.length;u+=4)l[u]=r[0],l[u+1]=r[1],l[u+2]=r[2],l[u+3]=r[3];const h=s*2+o,d=(u,f,g,m,p)=>{const v=u-g,_=f-m;return v*v+_*_<=p*p};for(let u=0;u<Math.ceil(e/h)+1;u++)for(let f=0;f<Math.ceil(t/h)+1;f++){const g=f*h+s,m=u*h+s;if(g<-s||g>t+s||m<-s||m>e+s)continue;const p=Math.max(0,Math.floor(g-s)),v=Math.min(t-1,Math.ceil(g+s)),_=Math.max(0,Math.floor(m-s)),w=Math.min(e-1,Math.ceil(m+s)),x=s-n;for(let S=_;S<=w;S++)for(let k=p;k<=v;k++){const C=d(k,S,g,m,s),M=d(k,S,g,m,x);if(C&&!M){const R=(S*t+k)*4;l[R]=a[0],l[R+1]=a[1],l[R+2]=a[2],l[R+3]=a[3]}}}return l}static diamonds(t,e,i={}){const{size:s=16,squareSize:n=6,background:o=[255,255,255,255],foreground:r=[0,0,0,255],innerColor:a=[255,255,255,255]}=i,l=new Uint8ClampedArray(t*e*4);for(let f=0;f<l.length;f+=4)l[f]=o[0],l[f+1]=o[1],l[f+2]=o[2],l[f+3]=o[3];const h=s,d=(f,g,m,p,v)=>{const _=Math.abs(f-m),w=Math.abs(g-p);return _+w<=v/2},u=(f,g,m,p,v)=>Math.abs(f-m)<=v/2&&Math.abs(g-p)<=v/2;for(let f=-1;f<e/h+1;f++)for(let g=-1;g<t/h+1;g++){const m=g*h+h/2,p=f*h+h/2;if(m<-h||m>t+h||p<-h||p>e+h)continue;const v=Math.max(0,Math.floor(m-h/2)),_=Math.min(t-1,Math.ceil(m+h/2)),w=Math.max(0,Math.floor(p-h/2)),x=Math.min(e-1,Math.ceil(p+h/2));for(let S=w;S<=x;S++)for(let k=v;k<=_;k++){const C=d(k,S,m,p,h),M=u(k,S,m,p,n);if(C){const R=(S*t+k)*4;M?(l[R]=a[0],l[R+1]=a[1],l[R+2]=a[2],l[R+3]=a[3]):(l[R]=r[0],l[R+1]=r[1],l[R+2]=r[2],l[R+3]=r[3])}}}return l}static cubes(t,e,i={}){const{size:s=10,spacing:n=2,background:o=[0,0,0,255],foreground:r=[255,100,0,255]}=i,a=new Uint8ClampedArray(t*e*4);for(let h=0;h<a.length;h+=4)a[h]=o[0],a[h+1]=o[1],a[h+2]=o[2],a[h+3]=o[3];const l=s+n;for(let h=0;h<Math.ceil(e/l)+1;h++)for(let d=0;d<Math.ceil(t/l)+1;d++){const u=d*l,f=h*l;if(!(u>=t||f>=e))for(let g=f;g<Math.min(f+s,e);g++)for(let m=u;m<Math.min(u+s,t);m++){const p=(g*t+m)*4;a[p]=r[0],a[p+1]=r[1],a[p+2]=r[2],a[p+3]=r[3]}}return a}static cross(t,e,i={}){const{size:s=8,thickness:n=2,spacing:o=16,background:r=[255,255,255,255],foreground:a=[80,80,80,255]}=i,l=new Uint8ClampedArray(t*e*4);for(let h=0;h<l.length;h+=4)l[h]=r[0],l[h+1]=r[1],l[h+2]=r[2],l[h+3]=r[3];for(let h=0;h<Math.ceil(e/o)+1;h++)for(let d=0;d<Math.ceil(t/o)+1;d++){const u=d*o,f=h*o;if(u<-s||u>t+s||f<-s||f>e+s)continue;const g=u-s/2,m=u+s/2,p=f-n/2,v=f+n/2;for(let k=Math.max(0,Math.floor(p));k<Math.min(e,Math.ceil(v));k++)for(let C=Math.max(0,Math.floor(g));C<Math.min(t,Math.ceil(m));C++){const M=(k*t+C)*4;l[M]=a[0],l[M+1]=a[1],l[M+2]=a[2],l[M+3]=a[3]}const _=u-n/2,w=u+n/2,x=f-s/2,S=f+s/2;for(let k=Math.max(0,Math.floor(x));k<Math.min(e,Math.ceil(S));k++)for(let C=Math.max(0,Math.floor(_));C<Math.min(t,Math.ceil(w));C++){const M=(k*t+C)*4;l[M]=a[0],l[M+1]=a[1],l[M+2]=a[2],l[M+3]=a[3]}}return l}static mesh(t,e,i={}){const{spacing:s=20,lineWidth:n=2,background:o=[255,255,255,0],foreground:r=[0,0,0,255]}=i,a=new Uint8ClampedArray(t*e*4);for(let l=0;l<a.length;l+=4)a[l]=o[0],a[l+1]=o[1],a[l+2]=o[2],a[l+3]=o[3];for(let l=0;l<e;l++)for(let h=0;h<t;h++){const d=(h+l)%s,u=d<n||d>s-n,f=(h-l+e)%s,g=f<n||f>s-n;if(u||g){const m=(l*t+h)*4;a[m]=r[0],a[m+1]=r[1],a[m+2]=r[2],a[m+3]=r[3]}}return a}static isometric(t,e,i={}){const{cellSize:s=20,lineWidth:n=1,background:o=[0,0,0,0],foreground:r=[0,255,0,255]}=i,a=new Uint8ClampedArray(t*e*4);for(let d=0;d<a.length;d+=4)a[d]=o[0],a[d+1]=o[1],a[d+2]=o[2],a[d+3]=o[3];const l=s,h=s/2;for(let d=0;d<e;d++)for(let u=0;u<t;u++){const f=u%l,g=d%h,m=g-f/2,p=g+f/2-h,v=Math.abs(m)<n/2,_=Math.abs(p)<n/2;if(v||_){const w=(d*t+u)*4;a[w]=r[0],a[w+1]=r[1],a[w+2]=r[2],a[w+3]=r[3]}}return a}static weave(t,e,i={}){const{tileSize:s=40,lineWidth:n=2,background:o=[255,255,255,255],foreground:r=[0,0,0,255]}=i,a=new Uint8ClampedArray(t*e*4);for(let l=0;l<a.length;l+=4)a[l]=o[0],a[l+1]=o[1],a[l+2]=o[2],a[l+3]=o[3];for(let l=0;l<e;l++)for(let h=0;h<t;h++){const d=h%s,u=l%s,f=Math.abs((u+s/2)%s-s/2)<n/2,g=Math.abs((d+u*2+s*1.5)%s-s/2)<n/2,m=Math.abs((d-u*2+s*1.5)%s-s/2)<n/2;if(f||g||m){const v=(l*t+h)*4;a[v]=r[0],a[v+1]=r[1],a[v+2]=r[2],a[v+3]=r[3]}}return a}static perlinNoise(t,e,i={}){const{background:s=[0,0,0,0],foreground:n=[255,255,255,255],scale:o=.1,octaves:r=4,persistence:a=.5,lacunarity:l=2,seed:h=Math.random()*65536}=i,d=new Uint8ClampedArray(t*e*4);Pt.seed(h);for(let u=0;u<e;u++)for(let f=0;f<t;f++){let g=1,m=1,p=0,v=0;for(let S=0;S<r;S++){const k=f*o*m,C=u*o*m,M=Pt.perlin2(k,C);p+=M*g,v+=g,g*=a,m*=l}p/=v;const _=(p+1)*.5,w=[Math.floor(s[0]+_*(n[0]-s[0])),Math.floor(s[1]+_*(n[1]-s[1])),Math.floor(s[2]+_*(n[2]-s[2])),Math.floor(s[3]+_*(n[3]-s[3]))],x=(u*t+f)*4;d.set(w,x)}return d}static circularGradient(t,e,i={}){const{innerColor:s=[255,255,255,255],outerColor:n=[0,0,0,255],centerX:o=t/2,centerY:r=e/2,radius:a=Math.min(t,e)/2,fadeExponent:l=1}=i,h=new Uint8ClampedArray(t*e*4);for(let d=0;d<e;d++)for(let u=0;u<t;u++){const f=(d*t+u)*4,g=u-o,m=d-r,p=Math.sqrt(g*g+m*m);let v=Math.min(p/a,1);v=Math.pow(v,l);const _=[Math.floor(s[0]+v*(n[0]-s[0])),Math.floor(s[1]+v*(n[1]-s[1])),Math.floor(s[2]+v*(n[2]-s[2])),Math.floor(s[3]+v*(n[3]-s[3]))];h.set(_,f)}return h}static noiseDisplacement(t,e,i={}){const{gridSpacing:s=16,gridColor:n=[255,255,255,255],background:o=[0,0,0,0],displacementScale:r=8,noiseScale:a=.05,gridThickness:l=1,seed:h=Math.random()*65536}=i,d=new Uint8ClampedArray(t*e*4);Pt.seed(h);for(let u=0;u<d.length;u+=4)d.set(o,u);for(let u=0;u<e;u++)for(let f=0;f<t;f++){const g=Pt.perlin2(f*a,u*a),m=Pt.perlin2((f+31.416)*a,(u+27.182)*a),p=f+g*r,v=u+m*r,_=p%s<l||p%s>s-l,w=v%s<l||v%s>s-l;if(_||w){const x=(u*t+f)*4;d.set(n,x)}}return d}static dotPattern(t,e,i={}){const{dotSize:s=3,spacing:n=12,dotColor:o=[0,0,0,255],background:r=[255,255,255,255],useNoise:a=!1,noiseScale:l=.1,noiseDensity:h=.4,seed:d=Math.random()*65536}=i,u=new Uint8ClampedArray(t*e*4);a&&Pt.seed(d);for(let f=0;f<u.length;f+=4)u.set(r,f);if(a){for(let f=0;f<e;f++)for(let g=0;g<t;g++)if((Pt.perlin2(g*l,f*l)+1)*.5>h)for(let v=-s;v<=s;v++)for(let _=-s;_<=s;_++){const w=g+_,x=f+v;if(w>=0&&w<t&&x>=0&&x<e&&_*_+v*v<=s*s){const k=(x*t+w)*4;u.set(o,k)}}}else for(let f=Math.floor(n/2);f<e;f+=n)for(let g=Math.floor(n/2);g<t;g+=n)for(let m=-s;m<=s;m++)for(let p=-s;p<=s;p++){const v=g+p,_=f+m;if(v>=0&&v<t&&_>=0&&_<e&&p*p+m*m<=s*s){const x=(_*t+v)*4;u.set(o,x)}}return u}static voronoi(t,e,i={}){const{cellCount:s=20,cellColors:n=null,edgeColor:o=[0,0,0,255],edgeThickness:r=1.5,seed:a=Math.random()*1e3,jitter:l=.5,baseColor:h=null,colorVariation:d=.3}=i,u=new Uint8ClampedArray(t*e*4);Pt.seed(a);const f=[],g=[],m=()=>{let S=Math.sin(a*.167+f.length*.423)*1e4;return S-Math.floor(S)},p=Math.sqrt(s),v=t/p,_=e/p,w=S=>{if(h){const[k,C,M,R]=h,D=Math.max(k,C,M)/255,A=Math.min(k,C,M)/255,O=(D+A)/2;let E,L;if(D===A)E=L=0;else{const nt=D-A;L=O>.5?nt/(2-D-A):nt/(D+A),D===k/255?E=(C/255-M/255)/nt+(C/255<M/255?6:0):D===C/255?E=(M/255-k/255)/nt+2:E=(k/255-C/255)/nt+4,E/=6}const X=Pt.perlin2(S*.15,0)*d*.3,H=Pt.perlin2(0,S*.15)*d,it=Pt.perlin2(S*.15,S*.15)*d*.5;E=(E+X)%1,L=Math.min(1,Math.max(0,L*(1+H)));const Z=Math.min(.9,Math.max(.1,O*(1+it)));let ht,Tt,bt;if(L===0)ht=Tt=bt=Z;else{const nt=(Qt,de,Et)=>(Et<0&&(Et+=1),Et>1&&(Et-=1),Et<.16666666666666666?Qt+(de-Qt)*6*Et:Et<.5?de:Et<.6666666666666666?Qt+(de-Qt)*(.6666666666666666-Et)*6:Qt),ut=Z<.5?Z*(1+L):Z+L-Z*L,le=2*Z-ut;ht=nt(le,ut,E+1/3),Tt=nt(le,ut,E),bt=nt(le,ut,E-1/3)}const xt=.05,rt=()=>(m()*2-1)*xt;return[Math.min(255,Math.max(0,Math.floor(ht*255*(1+rt())))),Math.min(255,Math.max(0,Math.floor(Tt*255*(1+rt())))),Math.min(255,Math.max(0,Math.floor(bt*255*(1+rt())))),R]}else{const k=S*.618033988749895%1;let C,M,R;const D=k*6,A=Math.floor(D),O=D-A,E=.5,L=.5*(1-O),X=.5*(1-(1-O));switch(A%6){case 0:C=.5,M=X,R=E;break;case 1:C=L,M=.5,R=E;break;case 2:C=E,M=.5,R=X;break;case 3:C=E,M=L,R=.5;break;case 4:C=X,M=E,R=.5;break;case 5:C=.5,M=E,R=L;break}return[Math.floor(C*255+50+m()*100),Math.floor(M*255+50+m()*100),Math.floor(R*255+50+m()*100),255]}};for(let S=0;S<p;S++)for(let k=0;k<p&&!(f.length>=s);k++){const C=k*v+v/2,M=S*_+_/2,R=(m()*2-1)*l*v,D=(m()*2-1)*l*_;f.push({x:Math.floor(C+R),y:Math.floor(M+D)}),n&&f.length-1<n.length?g.push(n[f.length-1]):g.push(w(f.length-1))}const x=(S,k,C,M)=>{let R=Math.abs(S-C),D=Math.abs(k-M);R=Math.min(R,t-R),D=Math.min(D,e-D);const A=Math.sqrt(R*R+D*D),O=R+D;return A*.8+O*.2};for(let S=0;S<e;S++)for(let k=0;k<t;k++){const C=(S*t+k)*4;let M=1/0,R=1/0,D=0;for(let E=0;E<f.length;E++){const L=x(k,S,f[E].x,f[E].y);L<M?(R=M,M=L,D=E):L<R&&(R=L)}for(let E=0;E<f.length;E++)for(let L=-1;L<=1;L++)for(let X=-1;X<=1;X++){if(L===0&&X===0)continue;const H=f[E].x+L*t,it=f[E].y+X*e,Z=Math.sqrt(Math.pow(k-H,2)+Math.pow(S-it,2));Z<M?(R=M,M=Z,D=E):Z<R&&(R=Z)}R-M<r?u.set(o,C):u.set(g[D],C)}return u}static penrose(t,e,i={}){return ss(t,e,i)}}const at={tokens:{unaryNot:["!","~","Â¬","NOT"],and:["&","âˆ§","AND"],nand:["NAND"],or:["|","âˆ¨","OR"],nor:["NOR"],xor:["^","âŠ•","XOR"],xnor:["XNOR"]},precedence:{OR:1,NOR:1,XOR:2,XNOR:2,AND:3,NAND:3,NOT:4},constants:{true:["1","TRUE"],false:["0","FALSE"]}};function mt(c){return!!c}function Gt(c){return String(c).toUpperCase()}function rs(c){const t=[],e=String(c??"");let i=0;const s=r=>r===" "||r===`
`||r==="	"||r==="\r",n=r=>r>="A"&&r<="Z"||r>="a"&&r<="z"||r==="_",o=r=>n(r)||r>="0"&&r<="9";for(;i<e.length;){const r=e[i];if(s(r)){i++;continue}if(r==="("){t.push({type:"lp",value:r}),i++;continue}if(r===")"){t.push({type:"rp",value:r}),i++;continue}if(r==="!"||r==="~"||r==="Â¬"||r==="&"||r==="âˆ§"||r==="|"||r==="âˆ¨"||r==="^"||r==="âŠ•"){t.push({type:"op",value:r}),i++;continue}if(n(r)||r>="0"&&r<="9"){let a=i+1;for(;a<e.length&&o(e[a]);)a++;const l=e.slice(i,a),h=Gt(l);at.constants.true.includes(h)||at.constants.false.includes(h)?t.push({type:"const",value:h}):at.tokens.unaryNot.includes(h)||at.tokens.and.includes(h)||at.tokens.nand.includes(h)||at.tokens.or.includes(h)||at.tokens.nor.includes(h)||at.tokens.xor.includes(h)||at.tokens.xnor.includes(h)?t.push({type:"op",value:h}):t.push({type:"ident",value:l}),i=a;continue}throw new Error(`[BooleanAlgebra] Unexpected character "${r}" at ${i}`)}return t}function pi(c){const t=Gt(c);if(at.tokens.unaryNot.map(Gt).includes(t))return"NOT";if(at.tokens.and.map(Gt).includes(t))return"AND";if(at.tokens.nand.map(Gt).includes(t))return"NAND";if(at.tokens.or.map(Gt).includes(t))return"OR";if(at.tokens.nor.map(Gt).includes(t))return"NOR";if(at.tokens.xor.map(Gt).includes(t))return"XOR";if(at.tokens.xnor.map(Gt).includes(t))return"XNOR";throw new Error(`[BooleanAlgebra] Unknown operator "${c}"`)}function os(c){return at.precedence[c]??0}function as(c){let t=0;const e=()=>c[t],i=()=>c[t++];function s(){const r=i();if(!r)throw new Error("[BooleanAlgebra] Unexpected end of input");if(r.type==="const"){const a=Gt(r.value);return{type:"const",value:at.constants.true.includes(a)}}if(r.type==="ident")return{type:"var",name:r.value};if(r.type==="lp"){const a=n(0),l=i();if(!l||l.type!=="rp")throw new Error("[BooleanAlgebra] Missing closing ')'");return a}if(r.type==="op"){if(pi(r.value)!=="NOT")throw new Error(`[BooleanAlgebra] Unexpected binary operator "${r.value}"`);return{type:"not",left:s()}}throw new Error(`[BooleanAlgebra] Unexpected token "${r.type}"`)}function n(r){let a=s();for(;;){const l=e();if(!l||l.type!=="op")break;const h=pi(l.value);if(h==="NOT")break;const d=os(h);if(d<r)break;i();const u=n(d+1);a={type:h==="AND"?"and":h==="OR"?"or":h==="XOR"?"xor":h==="NAND"?"nand":h==="NOR"?"nor":"xnor",left:a,right:u}}return a}const o=n(0);if(t<c.length)throw new Error("[BooleanAlgebra] Unexpected trailing tokens");return o}function gt(c,t){switch(c.type){case"const":return!!c.value;case"var":{const e=(t==null?void 0:t[c.name])??!1;return mt(e)}case"not":return!gt(c.left,t);case"and":return gt(c.left,t)&&gt(c.right,t);case"nand":return!(gt(c.left,t)&&gt(c.right,t));case"or":return gt(c.left,t)||gt(c.right,t);case"nor":return!(gt(c.left,t)||gt(c.right,t));case"xor":{const e=gt(c.left,t),i=gt(c.right,t);return e&&!i||!e&&i}case"xnor":{const e=gt(c.left,t),i=gt(c.right,t);return e===i}default:throw new Error(`[BooleanAlgebra] Unknown AST node type "${c.type}"`)}}function Ne(c,t){c&&(c.type==="var"&&c.name&&t.add(c.name),c.left&&Ne(c.left,t),c.right&&Ne(c.right,t))}function yi(c){const t=1<<c,e=new Array(t);for(let i=0;i<t;i++)e[i]=i^i>>1;return e}class fe{static and(t,e){return mt(t)&&mt(e)}static nand(t,e){return!(mt(t)&&mt(e))}static or(t,e){return mt(t)||mt(e)}static nor(t,e){return!(mt(t)||mt(e))}static xor(t,e){const i=mt(t),s=mt(e);return i&&!s||!i&&s}static xnor(t,e){return mt(t)===mt(e)}static not(t){return!mt(t)}static parse(t){return as(rs(t))}static evaluate(t,e={}){const i=typeof t=="string"?fe.parse(t):t;return gt(i,e)}static variables(t){const e=typeof t=="string"?fe.parse(t):t,i=new Set;return Ne(e,i),[...i].sort((s,n)=>s.localeCompare(n))}static grayCode(t){return yi(t)}static truthTable(t,e,i={}){const s=typeof t=="string"?fe.parse(t):t,n=e&&e.length>0?[...e]:fe.variables(s),o=n.length,r=1<<o,a=i.order==="gray"?"gray":"binary",h=(a==="gray"?yi(o):Array.from({length:r},(d,u)=>u)).map(d=>{const u={};for(let f=0;f<o;f++){const g=1<<o-1-f;u[n[f]]=!!(d&g)}return{index:d,inputs:u,output:gt(s,u)}});return{variables:n,order:a,rows:h}}}function ls(c,t,e,i,s=5){return c<=s||c>=t?0:Math.exp(-c*i)*e}function Xn(c,t,e,i,s,n=5){const o=Math.sqrt(c*c+t*t);if(o<=n||o>=e)return{x:c,y:t,displacement:0};const r=ls(o,e,i,s,n),a=(o+r)/o;return{x:c*a,y:t*a,displacement:r}}function Fn(c,t,e=1,i=5){return c<=0?0:e*Math.sqrt(t)/Math.pow(c/i,1.5)}class lt{static lerp(t,e,i){return t+(e-t)*i}static linear(t){return t}static smoothstep(t){return t*t*(3-2*t)}static smootherstep(t){return t*t*t*(t*(t*6-15)+10)}static easeInQuad(t){return t*t}static easeOutQuad(t){return t*(2-t)}static easeInOutQuad(t){return t<.5?2*t*t:-1+(4-2*t)*t}static easeInCubic(t){return t*t*t}static easeOutCubic(t){return--t*t*t+1}static easeInOutCubic(t){return t<.5?4*t*t*t:(t-1)*(2*t-2)*(2*t-2)+1}static easeInQuart(t){return t*t*t*t}static easeOutQuart(t){return 1- --t*t*t*t}static easeInOutQuart(t){return t<.5?8*t*t*t*t:1-8*--t*t*t*t}static easeInSine(t){return 1-Math.cos(t*Math.PI/2)}static easeOutSine(t){return Math.sin(t*Math.PI/2)}static easeInOutSine(t){return-(Math.cos(Math.PI*t)-1)/2}static easeInExpo(t){return t===0?0:Math.pow(2,10*(t-1))}static easeOutExpo(t){return t===1?1:1-Math.pow(2,-10*t)}static easeInOutExpo(t){return t===0||t===1?t:t<.5?.5*Math.pow(2,20*t-10):.5*(2-Math.pow(2,-20*t+10))}static easeInCirc(t){return 1-Math.sqrt(1-t*t)}static easeOutCirc(t){return Math.sqrt(1- --t*t)}static easeInOutCirc(t){return t<.5?.5*(1-Math.sqrt(1-4*t*t)):.5*(Math.sqrt(-(2*t-3)*(2*t-1))+1)}static easeInElastic(t,e=1,i=.3){if(t===0||t===1)return t;const s=i/(2*Math.PI)*Math.asin(1/e);return-(e*Math.pow(2,10*(t-1))*Math.sin((t-1-s)*(2*Math.PI)/i))}static easeOutElastic(t,e=1,i=.3){if(t===0||t===1)return t;const s=i/(2*Math.PI)*Math.asin(1/e);return e*Math.pow(2,-10*t)*Math.sin((t-s)*(2*Math.PI)/i)+1}static easeInOutElastic(t,e=1,i=.3){if(t===0||t===1)return t;const s=i/(2*Math.PI)*Math.asin(1/e);return t<.5?-.5*(e*Math.pow(2,10*(2*t-1))*Math.sin((2*t-1-s)*(2*Math.PI)/i)):e*Math.pow(2,-10*(2*t-1))*Math.sin((2*t-1-s)*(2*Math.PI)/i)*.5+1}static easeInBack(t,e=1.70158){return t*t*((e+1)*t-e)}static easeOutBack(t,e=1.70158){return--t*t*((e+1)*t+e)+1}static easeInOutBack(t,e=1.70158){const i=e*1.525;return t<.5?.5*(2*t)*(2*t)*((i+1)*2*t-i):.5*((2*t-2)*(2*t-2)*((i+1)*(2*t-2)+i)+2)}static easeOutBounce(t){return t<1/2.75?7.5625*t*t:t<2/2.75?7.5625*(t-=1.5/2.75)*t+.75:t<2.5/2.75?7.5625*(t-=2.25/2.75)*t+.9375:7.5625*(t-=2.625/2.75)*t+.984375}static easeInBounce(t){return 1-lt.easeOutBounce(1-t)}static easeInOutBounce(t){return t<.5?lt.easeInBounce(t*2)*.5:lt.easeOutBounce(t*2-1)*.5+.5}}function vi(c,t,e){const i=Math.max(0,Math.min(1,(e-c)/(t-c)));return lt.smoothstep(i)}function cs(c,t,e){const{heatZone:i,coolZone:s,rate:n,heatMultiplier:o=1.5,coolMultiplier:r=1.5,middleMultiplier:a=.05,transitionWidth:l=.1}=e,h=vi(i-l,i+l*.5,c),d=1-vi(s-l*.5,s+l,c),u=1-h-d;let f=0;return h>0&&(f+=(1-t)*n*o*h),d>0&&(f+=(0-t)*n*r*d),u>0&&(f+=(c-t)*n*a*u),Math.max(0,Math.min(1,t+f))}function Wn(c,t,e){return(c-t)*e}function Gn(c,t,e){const i=c/t;return e*i}function Nn(c,t,e,i,s){return e>=i?0:(t-c)*s}function Hn(c,t,e,i,s,n=1){if(e>=i)return 0;const o=t-c,r=Math.pow(1-e/i,n);return o*s*r}const ke={kernel:{smoothingRadius:28},fluid:{restDensity:1.1,particleMass:1,pressureStiffness:1800,nearPressureStiffness:2.5,viscosity:.18,surfaceTension:0,maxForce:6e3},gas:{interactionRadius:34,pressure:12,diffusion:.08,drag:.04,buoyancy:260,neutralTemperature:.5,turbulence:16},external:{gravity:{x:0,y:820}}},Re=1e-4;function Be(c={}){return{kernel:{...ke.kernel,...c.kernel||{}},fluid:{...ke.fluid,...c.fluid||{}},gas:{...ke.gas,...c.gas||{}},external:{...ke.external,...c.external||{}}}}const re={poly6(c,t){const e=t*t;if(c>=e)return 0;const i=4/(Math.PI*Math.pow(t,8)),s=e-c;return i*s*s*s},spikyPow2(c,t){if(c>=t)return 0;const e=6/(Math.PI*Math.pow(t,4)),i=t-c;return e*i*i},spikyPow3(c,t){if(c>=t)return 0;const e=10/(Math.PI*Math.pow(t,5)),i=t-c;return e*i*i*i},spikyPow2Derivative(c,t){return c===0||c>=t?0:-12/(Math.PI*Math.pow(t,4))*(t-c)},spikyPow3Derivative(c,t){if(c===0||c>=t)return 0;const e=-30/(Math.PI*Math.pow(t,5)),i=t-c;return e*i*i},spikyGradient(c,t){if(c===0||c>=t)return 0;const e=-30/(Math.PI*Math.pow(t,5)),i=(t-c)*(t-c);return e*i},viscosityLaplacian(c,t){return c>=t?0:40/(Math.PI*Math.pow(t,5))*(t-c)}};function hs(c,t={},e){const s=Be(t).kernel.smoothingRadius,n=s*s,o=e??ei(c,s),r=c.length,a=new Float32Array(r),l=new Float32Array(r);for(let h=0;h<r;h++)a[h]=re.spikyPow2(0,s),l[h]=re.spikyPow3(0,s),ii(h,c,o,n,(d,u,f,g)=>{const m=Math.sqrt(g);a[h]+=re.spikyPow2(m,s),l[h]+=re.spikyPow3(m,s)});return{densities:a,nearDensities:l}}function us(c,t,e={}){const i=Be(e),s=c.length,n=new Float32Array(s),o=new Float32Array(s),{pressureStiffness:r,nearPressureStiffness:a,restDensity:l}=i.fluid;for(let h=0;h<s;h++)n[h]=(c[h]-l)*r,o[h]=t[h]*a;return{pressures:n,nearPressures:o}}function _i(c,t={}){const e=Be(t),i=e.kernel.smoothingRadius,s=i*i,n=c.length,o=ei(c,i),{densities:r,nearDensities:a}=hs(c,e,o),{pressures:l,nearPressures:h}=us(r,a,e),d=new Array(n);for(let u=0;u<n;u++)d[u]={x:0,y:0};for(let u=0;u<n;u++){const f=c[u];Math.max(r[u],Re),ii(u,c,o,s,(g,m,p,v)=>{if(g<=u)return;const _=Math.sqrt(v);if(_<Re||_>=i)return;const w=c[g],x=1/_,S=-m*x,k=-p*x,C=Math.max(r[g],Re),M=Math.max(a[g],Re),R=(l[u]+l[g])*.5,D=(h[u]+h[g])*.5,A=re.spikyPow2Derivative(_,i),O=re.spikyPow3Derivative(_,i),E=R*A/C,L=D*O/M,X=E+L,H=S*X,it=k*X;d[u].x+=H,d[u].y+=it,d[g].x-=H,d[g].y-=it;const Z=re.poly6(v,i),ht=e.fluid.viscosity*Z,Tt=(w.vx-f.vx)*ht,bt=(w.vy-f.vy)*ht;d[u].x+=Tt,d[u].y+=bt,d[g].x-=Tt,d[g].y-=bt})}return Ri(d,e.fluid.maxForce),{forces:d,densities:r,pressures:l}}function bi(c,t={}){var e;const i=Be(t),s=i.gas.interactionRadius,n=s*s,o=c.length,r=ei(c,s),a=new Array(o);for(let l=0;l<o;l++)a[l]={x:0,y:0};for(let l=0;l<o;l++){const h=c[l],d=xi(h,i),u=h.temperature??((e=h.custom)==null?void 0:e.temperature)??i.gas.neutralTemperature;ii(l,c,r,n,(f,g,m,p)=>{var v;if(f<=l||p===0)return;const _=Math.sqrt(p),w=1/_,x=c[f],S=xi(x,i),k=x.temperature??((v=x.custom)==null?void 0:v.temperature)??i.gas.neutralTemperature,C=i.gas.pressure*(1-_/s),M=g*w*C,R=m*w*C;a[l].x+=M,a[l].y+=R,a[f].x-=M,a[f].y-=R;const D=i.gas.diffusion,A=(x.vx-h.vx)*D,O=(x.vy-h.vy)*D;a[l].x+=A*S,a[l].y+=O*S,a[f].x-=A*d,a[f].y-=O*d;const L=(u-k)*i.gas.buoyancy*.5;a[l].y-=L,a[f].y+=L})}for(let l=0;l<o;l++){const h=c[l],d=i.gas.drag;a[l].x+=-h.vx*d,a[l].y+=-h.vy*d,a[l].x+=(Math.random()-.5)*i.gas.turbulence,a[l].y+=(Math.random()-.5)*i.gas.turbulence}return Ri(a,i.fluid.maxForce),{forces:a}}function ds(c,t,e){const i=Math.min(c.length,t.length),s=new Array(i);for(let n=0;n<i;n++)s[n]={x:lt.lerp(c[n].x,t[n].x,e),y:lt.lerp(c[n].y,t[n].y,e)};return s}function xi(c,t){return c.custom&&typeof c.custom.mass=="number"?c.custom.mass:c.mass?c.mass:c.size?c.size*.5+t.fluid.particleMass:t.fluid.particleMass}function Ri(c,t){const e=t*t;for(let i=0;i<c.length;i++){const s=c[i],n=s.x*s.x+s.y*s.y;if(n>e){const o=1/Math.sqrt(n);s.x*=t*o,s.y*=t*o}}}function ei(c,t){const e=t,i=new Map;for(let s=0;s<c.length;s++){const n=c[s],o=Math.floor(n.x/e),r=Math.floor(n.y/e),a=`${o},${r}`;let l=i.get(a);l||(l=[],i.set(a,l)),l.push(s)}return{cellSize:e,buckets:i}}function ii(c,t,e,i,s){const n=t[c],o=e.cellSize,r=Math.floor(n.x/o),a=Math.floor(n.y/o);for(let l=-1;l<=1;l++)for(let h=-1;h<=1;h++){const d=`${r+l},${a+h}`,u=e.buckets.get(d);if(u)for(let f=0;f<u.length;f++){const g=u[f];if(g===c)continue;const m=t[g],p=n.x-m.x,v=n.y-m.y,_=p*p+v*v;_<i&&s(g,p,v,_)}}}const Wt=class W{static disableAll(){W.enabledClasses=new Set,W.globalLevel=0}static disable(){W.enabled=!1}static enable(){W.enabled=!0}static setLevel(t){W.globalLevel=t}static enableFor(t){W.enabledClasses.add(t)}static disableFor(t){W.enabledClasses.delete(t)}static setOutput(t){W.output=t}constructor(t){this.className=t}static getLogger(t){return W.loggerz[t]||(W.loggerz[t]=new W(t)),W.loggerz[t]}_log(t,e,...i){W.enabled&&(W.globalLevel>=t||W.enabledClasses.has(this.className))&&W.output[e](`[${this.className}]`,...i)}log(...t){this._log(W.INFO,"log",...t)}warn(...t){this._log(W.WARN,"warn",...t)}error(...t){this._log(W.ERROR,"error",...t)}debug(...t){this._log(W.DEBUG,"log",...t)}table(...t){this._log(W.INFO,"table",...t)}groupCollapsed(t){W.enabled&&W.output.groupCollapsed(`[${this.className}] ${t}`)}groupEnd(){W.enabled&&W.output.groupEnd()}time(t){W.enabled&&W.output.time(`[${this.className}] ${t}`)}timeEnd(t){W.enabled&&W.output.timeEnd(`[${this.className}] ${t}`)}clear(){W.output.clear()}};P(Wt,"ERROR",1);P(Wt,"WARN",2);P(Wt,"INFO",3);P(Wt,"DEBUG",4);P(Wt,"globalLevel",Wt.ERROR);P(Wt,"enabledClasses",new Set);P(Wt,"output",console);P(Wt,"enabled",!0);P(Wt,"loggerz",[]);let zt=Wt;class Ci{constructor(t={}){this.name=t.name||this.constructor.name,this._logger=this.getLogger(t)}get logger(){return this._logger==null?this.getLogger():this._logger}trace(t="render"){this.logger.log(this.name==null?this.constructor.name:this.name,t,"x",this.x,"y",this.y,"w",this.width,"h",this.height,"opacity",this._opacity,"visible",this._visible,"active",this._active,"debug",this.debug)}getLogger(t){return zt.getLogger(t.name||this.constructor.name)}}const fs=class ge{static getInstance(){return ge.instance||(ge.instance=new ge),ge.instance}constructor(){this.createTab()}createTab(){this.tab=document.createElement("div"),Object.assign(this.tab.style,{position:"fixed",bottom:"0",left:"0",right:"0",height:"30px",backgroundColor:"#333",color:"#fff",padding:"5px",cursor:"pointer",fontFamily:"monospace",zIndex:"10000",display:"flex",justifyContent:"space-between",alignItems:"center"}),this.tab.innerText="Console";const t=document.createElement("div"),e=(i,s)=>{const n=document.createElement("button");return n.innerText=i,Object.assign(n.style,{marginLeft:"5px",padding:"2px 5px",fontFamily:"monospace",cursor:"pointer"}),n.onclick=s,n};this.paused=!1,this.scrollLock=!0,t.appendChild(e("Clear",()=>this.consoleArea.value="")),t.appendChild(e("Pause",()=>this.paused=!this.paused)),t.appendChild(e("Scroll Lock",()=>this.scrollLock=!this.scrollLock)),this.tab.appendChild(t),document.body.appendChild(this.tab),this.consoleArea=document.createElement("textarea"),Object.assign(this.consoleArea.style,{position:"fixed",bottom:"30px",left:"0",right:"0",height:"200px",display:"none",backgroundColor:"#111",color:"#0f0",fontFamily:"monospace",zIndex:"9999",padding:"10px",resize:"none"}),this.consoleArea.readOnly=!0,document.body.appendChild(this.consoleArea),this.tab.onclick=i=>{i.target===this.tab&&(this.consoleArea.style.display=this.consoleArea.style.display==="none"?"block":"none")}}appendMessage(t,e,...i){if(this.paused)return;const s=`[${t.toUpperCase()}] ${e} ${i.join(" ")}
`;this.consoleArea.value+=s,this.scrollLock&&(this.consoleArea.scrollTop=this.consoleArea.scrollHeight)}log(t,...e){this.appendMessage("log",t,...e)}warn(t,...e){this.appendMessage("warn",t,...e)}error(t,...e){this.appendMessage("error",t,...e)}table(t){const e=JSON.stringify(t,null,2);this.appendMessage("table",e)}groupCollapsed(t){this.appendMessage("group",`Group Start: ${t}`)}groupEnd(){this.appendMessage("group","Group End")}time(t){this[`time_${t}`]=performance.now()}timeEnd(t){const e=performance.now(),i=this[`time_${t}`],s=(e-i).toFixed(2);this.appendMessage("time",`${t}: ${s} ms`)}};P(fs,"instance");const si=class wt{static dropShadow(t,e,i=0,s=0){y.ctx.shadowColor=t,y.ctx.shadowBlur=e,y.ctx.shadowOffsetX=i,y.ctx.shadowOffsetY=s}static clearShadow(){y.ctx.shadowColor="rgba(0, 0, 0, 0)",y.ctx.shadowBlur=0,y.ctx.shadowOffsetX=0,y.ctx.shadowOffsetY=0}static setAlpha(t){y.ctx.globalAlpha=t}static setBlendMode(t){y.ctx.globalCompositeOperation=t}static clipRect(t,e,i,s){y.ctx.beginPath(),y.ctx.rect(t,e,i,s),y.ctx.clip()}static clipCircle(t,e,i){y.ctx.beginPath(),y.shapes.arc(t,e,i,0,Math.PI*2),y.ctx.clip()}static blurRegion(t,e,i,s,n){const o=y.ctx.filter;y.ctx.filter=`blur(${n}px)`;const r=y.ctx.getImageData(t,e,i,s);y.ctx.putImageData(r,t,e),y.ctx.filter=o}static createGlow(t,e,i={}){const s="glow-"+Math.random().toString(36).substr(2,9),o={...{pulseSpeed:0,pulseMin:e*.5,pulseMax:e*1.5,colorShift:0},...i},r={id:s,type:"glow",active:!0,time:0,color:t,blur:e,options:o,update(a){return Object.assign(this,a),this},stop(){return this.active=!1,wt._activeEffects.delete(this.id),this},apply(){if(!this.active)return;let a=this.blur,l=this.color;if(this.options.pulseSpeed>0){const h=Math.sin(this.time*this.options.pulseSpeed)*.5+.5;a=this.options.pulseMin+h*(this.options.pulseMax-this.options.pulseMin)}return this.options.colorShift>0&&(l=l.replace("hue",this.time*this.options.colorShift%360)),y.ctx.shadowColor=l,y.ctx.shadowBlur=a,y.ctx.shadowOffsetX=0,y.ctx.shadowOffsetY=0,this.time+=1/60,this}};return wt._activeEffects.set(s,r),wt._startAnimationLoop(),r}static _startAnimationLoop(){if(wt._animationId!==null)return;const t=()=>{if(wt._activeEffects.forEach(e=>{e.active&&e.apply()}),wt._activeEffects.size===0){cancelAnimationFrame(wt._animationId),wt._animationId=null;return}wt._animationId=requestAnimationFrame(t)};wt._animationId=requestAnimationFrame(t)}static clearAllEffects(){wt._activeEffects.forEach(t=>t.stop()),wt._activeEffects.clear(),y.ctx.shadowColor="rgba(0, 0, 0, 0)",y.ctx.shadowBlur=0,y.ctx.shadowOffsetX=0,y.ctx.shadowOffsetY=0,y.ctx.filter="none",y.ctx.globalAlpha=1,y.ctx.globalCompositeOperation="source-over"}};P(si,"_activeEffects",new Map);P(si,"_animationId",null);let gs=si;class ms{static draw(t,e=0,i=0,{width:s,height:n,crop:o=null,anchor:r="topâ€‘left",rotation:a=0,scaleX:l=1,scaleY:h=1,flipX:d=!1,flipY:u=!1,alpha:f=1,smoothing:g=!0}={}){const m=y.ctx;if(!m||!t)return;const p=s??(o?o.sw:t.width??t.videoWidth),v=n??(o?o.sh:t.height??t.videoHeight),_={left:0,center:.5,right:1}[r.split("-").pop()]??0,w={top:0,center:.5,bottom:1}[r.split("-")[0]]??0,x=-p*_,S=-v*w;if(m.save(),m.imageSmoothingEnabled=g,m.globalAlpha*=f,m.translate(e,i),a&&m.rotate(a),(d||u)&&m.scale(d?-1:1,u?-1:1),m.scale(l,h),o){const{sx:k,sy:C,sw:M,sh:R}=o;m.drawImage(t,k,C,M,R,x,S,p,v)}else m.drawImage(t,x,S,p,v);m.restore()}static blit(t,e,i,s,n){this.draw(t,e,i,{width:s,height:n})}static createPattern(t,e="repeat"){return y.ctx.createPattern(t,e)}static fillPattern(t,e,i,s,n){const o=y.ctx;o.save(),o.fillStyle=t,o.fillRect(e,i,s,n),o.restore()}static createImageData(t,e){return y.ctx.createImageData(t,e)}static cloneImageData(t){return new ImageData(new Uint8ClampedArray(t.data),t.width,t.height)}static getImageData(t,e,i,s){return y.ctx.getImageData(t,e,i,s)}static putImageData(t,e,i,s=0,n=0,o=t.width,r=t.height){y.ctx.putImageData(t,e,i,s,n,o,r)}static mapPixels(t,e){const i=t.data;for(let s=0;s<i.length;s+=4){const n=s>>2,o=e(i[s],i[s+1],i[s+2],i[s+3],n);o&&([i[s],i[s+1],i[s+2],i[s+3]]=o)}return t}static setPixel(t,e,i,s,n,o,r=255){const a=(i*t.width+e)*4,l=t.data;l[a]=s,l[a+1]=n,l[a+2]=o,l[a+3]=r}static async toBitmap({type:t="image/png",quality:e=.92}={}){const s=await y.ctx.canvas.convertToBlob({type:t,quality:e});return createImageBitmap(s)}static async createBitmap(t){return createImageBitmap(t)}static toImageData(t,e,i){if(t.length!==e*i*4)throw new Error("Invalid RGBA array size for given dimensions");return new ImageData(t,e,i)}static async createImageBitmapFromPixels(t,e,i){const s=this.toImageData(t,e,i);return await createImageBitmap(s)}static createPatternFromImageData(t,e="repeat"){const i=document.createElement("canvas");i.width=t.width,i.height=t.height;const s=i.getContext("2d");return s.putImageData(t,0,0),s.createPattern(i,e)}static createPatternFromPixels(t,e,i,s="repeat"){const n=this.toImageData(t,e,i);return this.createPatternFromImageData(n,s)}}class ps{static path(t,e,i,s=1){const n=y.ctx;n.beginPath();for(const o of t){const[r,...a]=o;r==="M"?n.moveTo(...a):r==="L"?n.lineTo(...a):r==="C"?n.bezierCurveTo(...a):r==="Q"?n.quadraticCurveTo(...a):r==="Z"&&n.closePath()}e&&(n.fillStyle=e,y.colors.fill(e)),i&&(n.strokeStyle=i,n.lineWidth=s,y.colors.stroke())}static line(t,e,i,s,n,o){y.ctx.beginPath(),y.ctx.moveTo(t,e),y.ctx.lineTo(i,s),y.colors.stroke(n,o)}static beginPath(){y.ctx.beginPath()}static closePath(){y.ctx.closePath()}static moveTo(t,e){y.ctx.moveTo(t,e)}static lineTo(t,e){y.ctx.lineTo(t,e)}static bezierCurveTo(t,e,i,s,n,o){y.ctx.bezierCurveTo(t,e,i,s,n,o)}static dashedLine(t,e,i,s,n,o,r){y.ctx.beginPath(),o&&(y.ctx.strokeStyle=o),r!==void 0&&(y.ctx.lineWidth=r),y.ctx.setLineDash(n),y.ctx.moveTo(t,e),y.ctx.lineTo(i,s),y.colors.stroke(),y.ctx.setLineDash([])}static dottedLine(t,e,i,s,n=2,o=5,r){return y.lines.dashedLine(t,e,i,s,[n,o],r,n)}static setLineDash(t){y.ctx.setLineDash(t)}static resetLineDash(){y.ctx.setLineDash([])}static setLineWidth(t){y.ctx.lineWidth=t}static quadraticCurve(t,e,i,s,n,o,r,a){y.ctx.beginPath(),y.ctx.moveTo(t,e),y.ctx.quadraticCurveTo(i,s,n,o),r&&(y.ctx.strokeStyle=r),a!==void 0&&(y.ctx.lineWidth=a),y.colors.stroke()}}class Di{static pushOpacity(t){const i=this._opacityStack[this._opacityStack.length-1]*t;this._opacityStack.push(i),y.logger.log("NEXT OPACITY WILL BE",i),y.effects.setAlpha(i)}static popOpacity(){if(this._opacityStack.length>1){this._opacityStack.pop();const t=this._opacityStack[this._opacityStack.length-1];y.logger.log("NEXT OPACITY WILL BE",t),y.effects.setAlpha(t)}}static _clone(){this._opacityStack=[...this._opacityStack]}static saveOpacityState(){this._opacityStateBackup=[...this._opacityStack]}static restoreOpacityState(){this._opacityStateBackup&&(this._opacityStack=this._opacityStateBackup,delete this._opacityStateBackup)}}P(Di,"_opacityStack",[1]);class ys{static rect(t,e,i,s,n){const o=y.ctx.fillStyle;y.colors.fill(n),y.ctx.fillRect(t,e,i,s),y.ctx.fillStyle=o}static outlineRect(t,e,i,s,n,o=1){const r=y.ctx.strokeStyle,a=y.ctx.lineWidth;y.ctx.strokeStyle=n,y.ctx.lineWidth=o,y.ctx.strokeRect(t,e,i,s),y.ctx.strokeStyle=r,y.ctx.lineWidth=a}static roundRect(t,e,i,s,n=0,o,r,a){let l;typeof n=="number"?l=[n,n,n,n]:Array.isArray(n)?l=n.length===4?n:[n[0]||0,n[1]||n[0]||0,n[2]||n[0]||0,n[3]||n[1]||n[0]||0]:l=[0,0,0,0];const[h,d,u,f]=l,g=t+i,m=e+s;y.lines.beginPath(),y.lines.moveTo(t+h,e),y.lines.lineTo(g-d,e),this.arc(g-d,e+d,d,-Math.PI/2,0),y.lines.lineTo(g,m-u),this.arc(g-u,m-u,u,0,Math.PI/2),y.lines.lineTo(t+f,m),this.arc(t+f,m-f,f,Math.PI/2,Math.PI),y.lines.lineTo(t,e+h),this.arc(t+h,e+h,h,Math.PI,-Math.PI/2),y.lines.closePath(),o&&(y.fillStyle=o,y.colors.fill(o)),r&&y.colors.stroke(r,a)}static fillRoundRect(t,e,i,s,n=0,o){this.roundRect(t,e,i,s,n,o,null)}static strokeRoundRect(t,e,i,s,n=0,o,r){this.roundRect(t,e,i,s,n,null,o,r)}static fillCircle(t,e,i,s){y.logger.log("PainterShapes.fillCircle",t,e,i,s),y.lines.beginPath(),this.arc(t,e,i,0,Math.PI*2),y.colors.fill(s)}static arc(t,e,i,s,n,o){y.ctx.arc(t,e,i,s,n,o)}static strokeCircle(t,e,i,s,n){y.lines.beginPath(),this.arc(t,e,i,0,Math.PI*2),y.colors.stroke(s,n)}static fillEllipse(t,e,i,s,n=0,o){y.lines.beginPath(),this.ellipse(t,e,i,s,n,0,Math.PI*2),o&&(y.fillStyle=o),y.colors.fill(o)}static strokeEllipse(t,e,i,s,n=0,o,r){y.lines.beginPath(),this.ellipse(t,e,i,s,n,0,Math.PI*2),o&&(y.strokeStyle=o),r!==void 0&&(y.lineWidth=r),y.colors.stroke(o,r)}static ellipse(t,e,i,s,n,o,r,a){y.ctx.ellipse(t,e,i,s,n,o,r,a)}static polygon(t,e,i,s,n){if(t.length<2)return;const o=y.ctx;o.beginPath(),o.moveTo(t[0].x,t[0].y);for(let r=1;r<t.length;r++)o.lineTo(t[r].x,t[r].y);o.closePath(),e&&y.colors.fill(e),i&&(n&&(o.lineJoin=n),y.colors.stroke(i,s))}}class vs{static font(){return y.ctx.font}static setFont(t){y.ctx.font=t}static setTextAlign(t){y.ctx.textAlign=t}static setTextBaseline(t){y.ctx.textBaseline=t}static fillText(t,e,i,s,n){s&&(y.ctx.fillStyle=s),n&&(y.ctx.font=n),y.ctx.fillText(t,e,i)}static strokeText(t,e,i,s,n,o){s&&(y.ctx.strokeStyle=s),n!==void 0&&(y.ctx.lineWidth=n),o&&(y.ctx.font=o),y.ctx.strokeText(t,e,i)}static measureTextDimensions(t,e,i="start",s="alphabetic"){e&&(y.ctx.font=e);const n=y.ctx.measureText(t),o=n.width,r=n.actualBoundingBoxAscent+n.actualBoundingBoxDescent;let a=0;return s==="middle"&&(a=-1.5),{width:o,height:r,verticalAdjustment:a}}static measureTextWidth(t,e){return e&&(y.ctx.font=e),y.ctx.measureText(t).width}static outlinedText(t,e,i,s,n,o,r){r&&(y.ctx.font=r),y.ctx.strokeStyle=n,y.ctx.lineWidth=o,y.ctx.strokeText(t,e,i),y.ctx.fillStyle=s,y.ctx.fillText(t,e,i)}static wrappedText(t,e,i,s,n,o,r){o&&(y.ctx.fillStyle=o),r&&(y.ctx.font=r);const a=t.split(" ");let l="",h="",d=1;for(let u=0;u<a.length;u++)h=l+a[u]+" ",y.ctx.measureText(h).width>s&&u>0?(y.ctx.fillText(l,e,i),l=a[u]+" ",i+=n,d++):l=h;return y.ctx.fillText(l,e,i),d*n}static textOnPath(t,e,i,s,n=!1){if(e.length<2)return;i&&(y.ctx.fillStyle=i),s&&(y.ctx.font=s);const o=t.split(""),r=o.map(u=>y.ctx.measureText(u).width);n&&(o.reverse(),r.reverse(),e.reverse());let a=0;for(let u=1;u<e.length;u++){const f=e[u].x-e[u-1].x,g=e[u].y-e[u-1].y;a+=Math.sqrt(f*f+g*g)}const l=r.reduce((u,f)=>u+f,0);let h=(a-l)/2;h<0&&(h=0);let d=h;for(let u=0;u<o.length;u++){const f=r[u],{x:g,y:m,angle:p}=getPositionOnPath(e,d);y.ctx.save(),y.ctx.translate(g,m),y.ctx.rotate(p),y.ctx.fillText(o[u],0,0),y.ctx.restore(),d+=f}}static getPositionOnPath(t,e){let i=0;for(let r=1;r<t.length;r++){const a=t[r-1],l=t[r],h=l.x-a.x,d=l.y-a.y,u=Math.sqrt(h*h+d*d);if(i+u>=e){const f=(e-i)/u,g=a.x+h*f,m=a.y+d*f,p=Math.atan2(d,h);return{x:g,y:m,angle:p}}i+=u}const s=t[t.length-1],n=t[t.length-2],o=Math.atan2(s.y-n.y,s.x-n.x);return{x:s.x,y:s.y,angle:o}}}const Ut=class Mt{static get colors(){return st(this,Vt,$t).call(this,"colors",b(this,me)),b(this,me)}static get effects(){return st(this,Vt,$t).call(this,"effects",b(this,pe)),b(this,pe)}static get img(){return st(this,Vt,$t).call(this,"img",b(this,ye)),b(this,ye)}static get lines(){return st(this,Vt,$t).call(this,"lines",b(this,ve)),b(this,ve)}static get opacity(){return st(this,Vt,$t).call(this,"opacity",b(this,_e)),b(this,_e)}static get shapes(){return st(this,Vt,$t).call(this,"shapes",b(this,be)),b(this,be)}static get text(){return st(this,Vt,$t).call(this,"text",b(this,xe)),b(this,xe)}static set ctx(t){this._ctx=t}static get ctx(){if(!this._ctx)throw new Error("Cannot access Painter.ctx before initialization!");return this._ctx}static init(t){this._ctx=t,this.saveStack=[],q(this,me,_s),q(this,pe,gs),q(this,ye,ms),q(this,ve,ps),q(this,_e,Di),q(this,be,ys),q(this,xe,vs),Mt.logger=zt.getLogger("Painter"),Mt.saveStack=[]}static setContext(t){this._ctx=t}static save(){const e=(new Error().stack.split(`
`)[2]||"").match(/at\s+(\w+)\.(\w+)/),i=e?`${e[1]}.${e[2]}`:"unknown";this.saveStack.push(i),this.logger.log(`Painter.save() by: ${i}`),this.ctx.save(),Mt.opacity.saveOpacityState()}static restore(){if(this.saveStack.length===0){console.error("PAINTER ERROR: restore() without matching save()!");return}const t=this.saveStack.pop();this.logger.log(`Painter.restore() balancing save from: ${t}`),this.ctx.restore(),Mt.opacity.restoreOpacityState()}static translateTo(t,e){(isNaN(t)||t===void 0)&&(t=0),(isNaN(e)||e===void 0)&&(e=0),this.logger.log("moveTo",t,e),this.ctx.translate(t,e)}static resetPosition(){this.logger.log("resetPosition");const t=this.ctx.getTransform();this.ctx.setTransform(t.a,t.b,t.c,t.d,0,0)}static withPosition(t,e,i){this.logger.log("withPosition",t,e),this.save(),this.translateTo(t,e),i(),this.restore()}static clear(t=0,e=0,i=Mt.ctx.canvas.width,s=Mt.ctx.canvas.height){Mt.ctx.clearRect(t,e,i,s)}static translate(t,e){Mt.ctx.translate(t,e)}static rotate(t){Mt.logger.log("Painter.rotate",t),Mt.ctx.rotate(t)}static scale(t,e){Mt.logger.log("Painter.scale",t,e),Mt.ctx.scale(t,e)}static useCtx(t,e={}){const i=this.ctx,{saveState:s=!1}=e;s&&this.save(),i.beginPath(),t(i),i.beginPath(),s&&this.restore()}};me=new WeakMap;pe=new WeakMap;ye=new WeakMap;ve=new WeakMap;_e=new WeakMap;be=new WeakMap;xe=new WeakMap;Vt=new WeakSet;$t=function(c,t){if(!t)throw new Error(`Painter.${c} is not initialized. Call Painter.init(ctx) first.`)};N(Ut,Vt);N(Ut,me,null);N(Ut,pe,null);N(Ut,ye,null);N(Ut,ve,null);N(Ut,_e,null);N(Ut,be,null);N(Ut,xe,null);P(Ut,"logger");let y=Ut;class _s{static fill(t){y.logger.log("PainterColors.fill - before:",y.ctx.fillStyle,"setting to:",t),y.ctx.fillStyle,y.ctx.fillStyle=t,y.ctx.fill(),y.logger.log("PainterColors.fill - after:",y.ctx.fillStyle)}static strokeOptions(t){t.color&&(y.ctx.strokeStyle=t.color),t.lineWidth!==void 0&&(y.ctx.lineWidth=t.lineWidth),t.lineCap&&(y.ctx.lineCap=t.lineCap),t.lineJoin&&(y.ctx.lineJoin=t.lineJoin),t.strokeStyle&&(y.ctx.strokeStyle=t.strokeStyle)}static stroke(t,e){t&&(y.ctx.strokeStyle=t),e!==void 0&&(y.ctx.lineWidth=e),y.ctx.stroke()}static setFillColor(t){y.ctx.fillStyle=t}static setStrokeColor(t){y.ctx.strokeStyle=t}static randomColorRGB(){const t=Math.floor(Math.random()*360),e=70+Math.floor(Math.random()*30),i=50+Math.floor(Math.random()*20);return y.colors.hslToRgb(t,e,i)}static randomColorRGBA(t=255){const[e,i,s]=this.randomColorRGB();return[e,i,s,t]}static randomColorHSL(){return`hsl(${Math.random()*360}, 100%, 50%)`}static randomColorHSL_RGBA(t=255){const e=Math.random()*360,i=60+Math.random()*40,s=40+Math.random()*40,[n,o,r]=y.colors.hslToRgb(e,i,s);return[n,o,r,t]}static randomColorHEX(){return"#"+(Math.random()*1048575*1e6).toString(16).slice(0,6)}static parseColorString(t){if(t=t.trim().toLowerCase(),t.startsWith("hsl")){const e=t.replace(/hsla?\(|\)/g,""),[i,s,n]=e.split(",").map(l=>l.trim()),o=parseFloat(i),r=parseFloat(s)/100,a=parseFloat(n)/100;return y.colors.hslToRgb(o,r,a)}if(t.startsWith("#"))return hexToRgb(t);if(t.startsWith("rgb")){const e=t.replace(/rgba?\(|\)/g,""),[i,s,n]=e.split(",").map(o=>parseInt(o.trim()));return[i,s,n]}return[0,0,0]}static rgbArrayToCSS([t,e,i]){return`rgb(${Math.round(t)}, ${Math.round(e)}, ${Math.round(i)})`}static hslToRgb(t,e,i){e/=100,i/=100;const s=r=>(r+t/30)%12,n=e*Math.min(i,1-i),o=r=>i-n*Math.max(-1,Math.min(s(r)-3,Math.min(9-s(r),1)));return[Math.round(o(0)*255),Math.round(o(8)*255),Math.round(o(4)*255)]}static rgbToHsl(t,e,i){t/=255,e/=255,i/=255;const s=Math.max(t,e,i),n=Math.min(t,e,i),o=s-n;let r=0,a=0,l=(s+n)/2;if(o!==0)switch(a=o/(1-Math.abs(2*l-1)),s){case t:r=60*(((e-i)/o+6)%6);break;case e:r=60*((i-t)/o+2);break;case i:r=60*((t-e)/o+4);break}return[r%360,a,l]}static hexToRgb(t){const e=t.replace("#",""),i=parseInt(e.substring(0,2),16),s=parseInt(e.substring(2,4),16),n=parseInt(e.substring(4,6),16);return[i,s,n]}static linearGradient(t,e,i,s,n){const o=y.ctx.createLinearGradient(t,e,i,s);for(const r of n)o.addColorStop(r.offset,r.color);return o}static radialGradient(t,e,i,s,n,o,r){const a=y.ctx.createRadialGradient(t,e,i,s,n,o);for(const l of r)a.addColorStop(l.offset,l.color);return a}static verticalGradient(t,e,i,s,n){return y.colors.linearGradient(t,e,t,e+s,n)}static horizontalGradient(t,e,i,s,n){return y.colors.linearGradient(t,e,t+i,e,n)}static conicGradient(t,e,i,s){if(typeof y.ctx.createConicGradient=="function"){const n=y.ctx.createConicGradient(i,t,e);for(const o of s)n.addColorStop(o.offset,o.color);return n}return null}static rgba(t,e,i,s=1){return`rgba(${Math.round(t)}, ${Math.round(e)}, ${Math.round(i)}, ${s})`}static hsl(t,e,i){return`hsl(${t}, ${e}%, ${i}%)`}static hsla(t,e,i,s){return`hsla(${t}, ${e}%, ${i}%, ${s})`}}class bs extends Ci{constructor(t={}){super(t),this._x=typeof t.x=="number"?t.x:0,this._y=typeof t.y=="number"?t.y:0,this._width=typeof t.width=="number"?t.width:0,this._height=typeof t.height=="number"?t.height:0,this.logger.log("Euclidian",this._x,this._y,this._width,this._height)}get x(){return this._x}set x(t){this.validateProp(t,"x"),this._x=t}get y(){return this._y}set y(t){this.validateProp(t,"y"),this._y=t}get width(){return this._width}set width(t){this.validateProp(t,"width"),this._width=Math.max(0,t)}get height(){return this._height}set height(t){this.validateProp(t,"height"),this._height=Math.max(0,t)}get debug(){return this._debug}set debug(t){this.validateProp(t,"debug"),this._debug=!!t}get debugColor(){return this._debugColor}set debugColor(t){this.validateProp(t,"debugColor"),this._debugColor=t}validateProp(t,e){if(t==null)throw new Error("Invalid property value: "+e+" "+t)}}class xs extends bs{constructor(t={}){super(t),this._minX=t.minX,this._maxX=t.maxX,this._minY=t.minY,this._maxY=t.maxY,this._boundsDirty=!0,this._cachedBounds=null,this.crisp=t.crisp??!0,this.logger.log("Geometry2d",this.x,this.y,this.width,this.height)}update(){this.trace("Geometry2d.update"),this.applyConstraints(),this.getBounds()}get minX(){return this._minX}set minX(t){this._minX=t}get maxX(){return this._maxX}set maxX(t){this._maxX=t}get minY(){return this._minY}set minY(t){this._minY=t}get maxY(){return this._maxY}set maxY(t){this._maxY=t}get boundsDirty(){return this._boundsDirty}applyConstraints(){this._minX!==void 0&&(this.x=Math.max(this.x,this._minX)),this._maxX!==void 0&&(this.x=Math.min(this.x,this._maxX)),this._minY!==void 0&&(this.y=Math.max(this.y,this._minY)),this._maxY!==void 0&&(this.y=Math.min(this.y,this._maxY)),this.crisp&&(this.x=Math.round(this.x),this.y=Math.round(this.y),this.width=Math.round(this.width),this.height=Math.round(this.height))}getBounds(){return(this._boundsDirty||!this._cachedBounds)&&(this._cachedBounds=this.calculateBounds(),this._boundsDirty=!1),this._cachedBounds}calculateBounds(){return{width:this.width,height:this.height,x:this.x,y:this.y}}getLocalPosition(){let t=0,e=0;return this.parent&&(t=this.parent.x,e=this.parent.y),{x:this.x-t-this.width/2,y:this.y-e-this.height/2}}markBoundsDirty(){this._boundsDirty=!0}validateProp(t,e){super.validateProp(t,e);const i=this[e];t!==i&&this.markBoundsDirty()}setTopLeft(t,e){return this.x=t+this.width/2,this.y=e+this.height/2,this}setCenter(t,e){return this.x=t,this.y=e,this}}class ws extends xs{constructor(t={}){super(t),this._debug=!!t.debug,this._debugColor=typeof t.debugColor=="string"?t.debugColor:"#0f0",this.logger.log("Traceable",this.x,this.y,this.width,this.height)}drawDebug(){if(!this._debug)return;const t=this.getDebugBounds();this.logger.log(this.constructor.name,"drawDebug",t.x,t.y,t.width,t.height),y.shapes.outlineRect(t.x,t.y,t.width,t.height,this._debugColor,2)}getDebugBounds(){return{width:this.width,height:this.height,x:-this.width/2,y:-this.height/2}}trace(t="render"){this.logger.log(this.name==null?this.constructor.name:this.name,t,"x",this.x,"y",this.y,"w",this.width,"h",this.height,"opacity",this._opacity,"visible",this._visible,"active",this._active,"debug",this.debug)}}class Ms extends ws{constructor(t={}){super(t),this._visible=t.visible!==!1,this._opacity=typeof t.opacity=="number"?t.opacity:1,this._active=t.active!==!1,this.zIndex=t.zIndex??0,this._shadowColor=t.shadowColor??void 0,this._shadowBlur=t.shadowBlur??0,this._shadowOffsetX=t.shadowOffsetX??0,this._shadowOffsetY=t.shadowOffsetY??0,this._cacheRendering=t.cacheRendering??!1,this._cacheCanvas=null,this._cacheDirty=!0,this._cachePadding=t.cachePadding??2,this._tick=0,this.logger.log("Renderable",this.x,this.y,this.width,this.height)}render(){if(!(!this._visible||this._opacity<=0)){if(y.save(),y.effects.setBlendMode(this._blendMode),this.crisp?y.translateTo(Math.round(this.x),Math.round(this.y)):y.translateTo(this.x,this.y),this.applyShadow(y.ctx),!this._cacheRendering||this.constructor.name==="Renderable")y.opacity.pushOpacity(this._opacity),this.draw(),y.opacity.popOpacity();else{const t=typeof this.width=="number"?this.width:0,e=typeof this.height=="number"?this.height:0,i=this._cachePadding*2,s=Math.ceil(t+i)||1,n=Math.ceil(e+i)||1;(!this._cacheCanvas||this._cacheCanvas.width!==s||this._cacheCanvas.height!==n)&&(this._cacheCanvas=document.createElement("canvas"),this._cacheCanvas.width=s,this._cacheCanvas.height=n,this._cacheDirty=!0),this._cacheDirty&&(this._renderToCache(s,n),this._cacheDirty=!1),y.opacity.pushOpacity(this._opacity);const o=this.rotation??0,r=this.scaleX??1,a=this.scaleY??1;y.img.draw(this._cacheCanvas,0,0,{width:s,height:n,rotation:o,scaleX:r,scaleY:a,anchor:"center"}),y.opacity.popOpacity()}y.restore()}}_renderToCache(t,e){const i=this._cacheCanvas.getContext("2d");i.clearRect(0,0,t,e);const s=y.ctx;y.ctx=i,this._isCaching=!0,i.save(),i.translate(t/2,e/2),this.draw(),i.restore(),this._isCaching=!1,y.ctx=s}invalidateCache(){this._cacheDirty=!0}draw(){this.drawDebug()}update(t){this.trace("Renderable.update"),this._tick+=t,super.update(t)}applyShadow(t){this._shadowColor&&(t.shadowColor=this._shadowColor,t.shadowBlur=this._shadowBlur,t.shadowOffsetX=this._shadowOffsetX,t.shadowOffsetY=this._shadowOffsetY)}get visible(){return this._visible}set visible(t){this._visible=!!t}get width(){return super.width}set width(t){super.width=t,this.invalidateCache()}get height(){return super.height}set height(t){super.height=t,this.invalidateCache()}get active(){return this._active}set active(t){this._active=!!t}get opacity(){return this._opacity}set opacity(t){this._opacity=Math.min(1,Math.max(0,typeof t=="number"?t:1))}get shadowColor(){return this._shadowColor}set shadowColor(t){this._shadowColor=t,this.invalidateCache()}get shadowBlur(){return this._shadowBlur}set shadowBlur(t){this._shadowBlur=t,this.invalidateCache()}get shadowOffsetX(){return this._shadowOffsetX}set shadowOffsetX(t){this._shadowOffsetX=t,this.invalidateCache()}get shadowOffsetY(){return this._shadowOffsetY}set shadowOffsetY(t){this._shadowOffsetY=t,this.invalidateCache()}get tick(){return this._tick}get cacheRendering(){return this._cacheRendering}set cacheRendering(t){this._cacheRendering=!!t,t&&this.invalidateCache()}}const Ei=class He{constructor(t){this._owner=t}get owner(){return this._owner}x(t){return this._owner._x=t,this._owner.markBoundsDirty(),this}y(t){return this._owner._y=t,this._owner.markBoundsDirty(),this}position(t,e){return this._owner._x=t,this._owner._y=e,this._owner.markBoundsDirty(),this}translateBy(t,e){return this._owner._x+=t,this._owner._y+=e,this._owner.markBoundsDirty(),this}width(t){var e,i;return this._owner._width=Math.max(0,t),this._owner.markBoundsDirty(),(i=(e=this._owner).invalidateCache)==null||i.call(e),this}height(t){var e,i;return this._owner._height=Math.max(0,t),this._owner.markBoundsDirty(),(i=(e=this._owner).invalidateCache)==null||i.call(e),this}size(t,e){var i,s;return this._owner._width=Math.max(0,t),this._owner._height=Math.max(0,e),this._owner.markBoundsDirty(),(s=(i=this._owner).invalidateCache)==null||s.call(i),this}rotation(t){return this._owner._rotation=t*Math.PI/180,this._owner.markBoundsDirty(),this}rotationRad(t){return this._owner._rotation=t,this._owner.markBoundsDirty(),this}rotateBy(t){return this._owner._rotation+=t*Math.PI/180,this._owner.markBoundsDirty(),this}scaleX(t){return this._owner._scaleX=t,this._owner.markBoundsDirty(),this}scaleY(t){return this._owner._scaleY=t,this._owner.markBoundsDirty(),this}scale(t){return this._owner._scaleX=t,this._owner._scaleY=t,this._owner.markBoundsDirty(),this}scaleBy(t){return this._owner._scaleX*=t,this._owner._scaleY*=t,this._owner.markBoundsDirty(),this}set(t){var e,i;let s=!1;return t.x!==void 0&&(this._owner._x=t.x),t.y!==void 0&&(this._owner._y=t.y),t.width!==void 0&&(this._owner._width=Math.max(0,t.width),s=!0),t.height!==void 0&&(this._owner._height=Math.max(0,t.height),s=!0),t.rotation!==void 0&&(this._owner._rotation=t.rotation*Math.PI/180),t.scaleX!==void 0&&(this._owner._scaleX=t.scaleX),t.scaleY!==void 0&&(this._owner._scaleY=t.scaleY),this._owner.markBoundsDirty(),s&&((i=(e=this._owner).invalidateCache)==null||i.call(e)),this}reset(){return this._owner._rotation=0,this._owner._scaleX=1,this._owner._scaleY=1,this._owner.markBoundsDirty(),this}resetAll(){var t,e;return this._owner._x=0,this._owner._y=0,this._owner._width=0,this._owner._height=0,this._owner._rotation=0,this._owner._scaleX=1,this._owner._scaleY=1,this._owner.markBoundsDirty(),(e=(t=this._owner).invalidateCache)==null||e.call(t),this}toObject(){return{x:this._owner._x,y:this._owner._y,width:this._owner._width,height:this._owner._height,rotation:this._owner._rotation*180/Math.PI,scaleX:this._owner._scaleX,scaleY:this._owner._scaleY}}copyFrom(t){const e=t instanceof He?t.toObject():t;return this.set(e)}static handleDirectSet(t,e){if(He.strictMode)throw new Error(`Direct property assignment "${t} = ${e}" is disabled. Use shape.transform.${t}(${e}) instead. Set Transform.strictMode = false to allow direct assignment.`);console.warn(`[Deprecation] Direct assignment "${t} = ${e}" is deprecated. Use shape.transform.${t}(${e}) instead.`)}};P(Ei,"strictMode",!1);let Ss=Ei;class Ie extends Ms{constructor(t={}){super(t),this._rotation=t.rotation*Math.PI/180,this._scaleX=t.scaleX??1,this._scaleY=t.scaleY??1,this.transform=new Ss(this),this.logger.log("Transformable",this.x,this.y,this.width,this.height)}draw(){this.applyTransforms();const t=y.ctx;t.beginPath(),t.fill(),this.drawDebug()}applyTransforms(){this._isCaching||(y.rotate(this._rotation),y.scale(this._scaleX,this._scaleY))}get rotation(){return this._rotation}set rotation(t){this._rotation=t*Math.PI/180,this.markBoundsDirty()}get scaleX(){return this._scaleX}set scaleX(t){this._scaleX=t,this.markBoundsDirty()}get scaleY(){return this._scaleY}set scaleY(t){this._scaleY=t,this.markBoundsDirty()}calculateBounds(){const t=this.width/2,e=this.height/2,i=[{x:-t,y:-e},{x:t,y:-e},{x:t,y:e},{x:-t,y:e}],s=Math.cos(this._rotation),n=Math.sin(this._rotation),o=i.map(({x:f,y:g})=>{f*=this._scaleX,g*=this._scaleY;const m=f*s-g*n,p=f*n+g*s;return{x:m+this.x,y:p+this.y}}),r=o.map(f=>f.x),a=o.map(f=>f.y),l=Math.min(...r),h=Math.max(...r),d=Math.min(...a),u=Math.max(...a);return{x:(l+h)/2,y:(d+u)/2,width:h-l,height:u-d}}}class dt extends Ie{constructor(t={}){super(t),this._color=t.color??null,this._stroke=t.stroke??null,this._lineWidth=t.lineWidth??1,this._lineJoin=t.lineJoin??"miter",this._lineCap=t.lineCap??"butt",this._miterLimit=t.miterLimit??10,this.logger.log("Shape",this.x,this.y,this.width,this.height)}get color(){return this._color}set color(t){this._color=t,this.invalidateCache()}get stroke(){return this._stroke}set stroke(t){this._stroke=t,this.invalidateCache()}get lineWidth(){return this._lineWidth}set lineWidth(t){this._lineWidth=Math.max(0,t),this.invalidateCache()}get lineJoin(){return this._lineJoin}set lineJoin(t){this._lineJoin=t,this.invalidateCache()}get lineCap(){return this._lineCap}set lineCap(t){this._lineCap=t,this.invalidateCache()}get miterLimit(){return this._miterLimit}set miterLimit(t){this._miterLimit=t,this.invalidateCache()}}class Ts extends Ie{constructor(t={}){super(t),this._collection=new ti({sortByZIndex:t.sortByZIndex||!0}),this._collection._owner=this,this._childrenVersion=0,this._cachedBounds=null,t.width=Math.max(0,t.width||0),t.height=Math.max(0,t.height||0),this.userDefinedWidth=t.width,this.userDefinedHeight=t.height,this.userDefinedDimensions=t.width!==void 0&&t.height!==void 0&&(t.width>0||t.height>0)}add(t){if(t==null||t==null)throw new Error("Object is null or undefined");if(!(t instanceof Ie))throw new TypeError("Group can only add Transformable instances");return t.parent=this,this._collection.add(t),this._childrenVersion++,this.markBoundsDirty(),this.invalidateCache(),t}remove(t){const e=this._collection.remove(t);return e&&(t.parent=null,this._childrenVersion++,this.markBoundsDirty(),this.invalidateCache()),e}clear(){this._collection.clear(),this._childrenVersion++,this.markBoundsDirty(),this.invalidateCache()}bringToFront(t){return this._collection.bringToFront(t)}sendToBack(t){return this._collection.sendToBack(t)}bringForward(t){return this._collection.bringForward(t)}sendBackward(t){return this._collection.sendBackward(t)}draw(){super.draw(),this.logger.log("Group.draw children:",this.children.length),this._renderChildren()}_renderChildren(){const t=this._collection.getSortedChildren();for(let e=0;e<t.length;e++){const i=t[e];i.visible&&(y.save(),i.render(),y.restore())}}update(t){this.logger.groupCollapsed("Group.update");const e=this._collection.getSortedChildren();for(let i=0;i<e.length;i++){const s=e[i];s.active&&typeof s.update=="function"&&s.update(t)}super.update(t),this.logger.groupEnd()}get children(){var t;return((t=this._collection)==null?void 0:t.children)||[]}get width(){return this.userDefinedDimensions?this._width:this.getBounds().width}set width(t){const e=Math.max(0,t);this._width=e,this.userDefinedWidth=e,this.userDefinedDimensions=(this.userDefinedWidth>0||this.userDefinedHeight>0)&&this.userDefinedWidth!==void 0&&this.userDefinedHeight!==void 0,this.markBoundsDirty()}get height(){return this.userDefinedDimensions?this._height:this.getBounds().height}set height(t){const e=Math.max(0,t);this._height=e,this.userDefinedHeight=e,this.userDefinedDimensions=(this.userDefinedWidth>0||this.userDefinedHeight>0)&&this.userDefinedWidth!==void 0&&this.userDefinedHeight!==void 0,this.markBoundsDirty()}calculateBounds(){var t;if(this.userDefinedDimensions)return{x:this.x,y:this.y,width:this._width,height:this._height};if(!((t=this.children)!=null&&t.length))return{x:this.x,y:this.y,width:0,height:0};let e=1/0,i=1/0,s=-1/0,n=-1/0;for(const a of this.children){const l=a.x,h=a.y,d=a.width,u=a.height,f=l-d/2,g=l+d/2,m=h-u/2,p=h+u/2;e=Math.min(e,f),s=Math.max(s,g),i=Math.min(i,m),n=Math.max(n,p)}const o=s-e,r=n-i;return{x:this.x,y:this.y,width:o,height:r}}getDebugBounds(){const t=this.calculateBounds();return{width:t.width,height:t.height,x:-t.width/2,y:-t.height/2}}forEachTransform(t){return this.children.forEach((e,i)=>{e.transform&&t(e.transform,e,i)}),this}translateChildren(t,e){return this.forEachTransform(i=>i.translateBy(t,e))}scaleChildren(t){return this.forEachTransform(e=>e.scaleBy(t))}rotateChildren(t){return this.forEachTransform(e=>e.rotateBy(t))}resetChildTransforms(){return this.forEachTransform(t=>t.reset())}}class Un extends dt{constructor(t,e,i,s={}){super(s),this.radius=t,this.startAngle=e,this.endAngle=i}draw(){super.draw(),y.lines.beginPath(),y.shapes.arc(0,0,this.radius,this.startAngle,this.endAngle,!1),this.stroke&&y.colors.stroke(this.stroke,this.lineWidth)}getBounds(){const t=this.radius;return{x:this.x,y:this.y,width:t*2,height:t*2}}}class Vn extends dt{constructor(t,e={}){super(e),this._radius=t,this.width=t*2,this.height=t*2}draw(){super.draw(),this.color&&y.shapes.fillCircle(0,0,this._radius,this.color),this.stroke&&y.shapes.strokeCircle(0,0,this._radius,this.stroke,this.lineWidth)}calculateBounds(){const t=this._radius*2;return this.trace("Circle.calculateBounds:"+t),{x:this.x,y:this.y,width:t,height:t}}get radius(){return this._radius}set radius(t){this.validateProp(t,"radius"),t!=this._radius&&(this._radius=t,this.width=t*2,this.height=t*2,this._boundsDirty=!0,this.calculateBounds())}}class qn extends dt{constructor(t=40,e={}){super(e),this.size=t,this.width=t*2,this.height=t*2}draw(){super.draw();const t=this.size,e=y.ctx,i=[{x:-t*.5,y:0,r:t*.4},{x:-t*.2,y:-t*.3,r:t*.35},{x:t*.2,y:-t*.35,r:t*.4},{x:t*.5,y:0,r:t*.35},{x:0,y:t*.15,r:t*.5}];if(this.color){e.fillStyle=this.color;for(const s of i)e.beginPath(),e.arc(s.x,s.y,s.r,0,Math.PI*2),e.fill()}if(this.stroke){e.strokeStyle=this.stroke,e.lineWidth=this.lineWidth;for(const s of i)e.beginPath(),e.arc(s.x,s.y,s.r,0,Math.PI*2),e.stroke()}}getBounds(){const t=this.size*2;return{x:this.x,y:this.y,width:t,height:t}}}class Pi extends dt{constructor(t={}){super(t)}draw(){super.draw(),this.drawRect()}drawRect(){const t=-this.width/2,e=-this.height/2;this.color&&y.shapes.rect(t,e,this.width,this.height,this.color),this.stroke&&y.shapes.outlineRect(t,e,this.width,this.height,this.stroke,this.lineWidth)}}class $n extends Pi{constructor(t,e={}){super(e),this.width=t,this.height=t}}class Zn extends dt{constructor(t=50,e={}){super(e),this.size=t}draw(){super.draw();const t=this.size/2,e=[{x:0,y:-t},{x:t,y:t},{x:-t,y:t}];y.shapes.polygon(e,this.color,this.stroke,this.lineWidth)}}class jn extends dt{constructor(t=50,e={}){super(e),this._leg=t,this._updateDimensions()}get leg(){return this._leg}set leg(t){this._leg=t,this._updateDimensions(),this.invalidateCache()}get hypotenuse(){return this._leg*Math.SQRT2}_updateDimensions(){this._width=this._leg,this._height=this._leg}getVertices(){const t=this._leg,e=t/3,i=t/3;return[{x:-e,y:-i},{x:t-e,y:-i},{x:-e,y:t-i}]}draw(){super.draw();const t=this.getVertices();y.shapes.polygon(t,this.color,this.stroke,this.lineWidth,this.lineJoin)}calculateBounds(){return{x:this.x,y:this.y,width:this._width,height:this._height}}}class Kn extends dt{constructor(t={}){super(t),this._pgWidth=t.width??100,this._pgHeight=t.height??50,this._slant=t.slant??this._pgHeight,this._flipX=t.flipX??!1,this._updateDimensions()}get pgWidth(){return this._pgWidth}set pgWidth(t){this._pgWidth=t,this._updateDimensions(),this.invalidateCache()}get pgHeight(){return this._pgHeight}set pgHeight(t){this._pgHeight=t,this._updateDimensions(),this.invalidateCache()}get slant(){return this._slant}set slant(t){this._slant=t,this._updateDimensions(),this.invalidateCache()}get flipX(){return this._flipX}set flipX(t){this._flipX=t,this.invalidateCache()}_updateDimensions(){this._width=this._pgWidth+Math.abs(this._slant),this._height=this._pgHeight}getVertices(){const t=this._pgWidth,e=this._pgHeight;let i=this._slant;this._flipX&&(i=-i);const n=-(t+Math.abs(i))/2+(i<0?-i:0);return[{x:n,y:e/2},{x:n+t,y:e/2},{x:n+t+i,y:-e/2},{x:n+i,y:-e/2}]}draw(){super.draw();const t=this.getVertices();y.shapes.polygon(t,this.color,this.stroke,this.lineWidth,this.lineJoin)}calculateBounds(){return{x:this.x,y:this.y,width:this._width,height:this._height}}}class Ai{constructor(t,e){if(this.width=t,this.height=e,this.canvas=document.createElement("canvas"),this.canvas.width=t,this.canvas.height=e,this.gl=this.canvas.getContext("webgl",{alpha:!0,premultipliedAlpha:!0,antialias:!0,preserveDrawingBuffer:!0}),!this.gl){console.warn("WebGL not available, falling back to Canvas 2D"),this.available=!1;return}this.available=!0;const i=this.gl;i.enable(i.BLEND),i.blendFunc(i.ONE,i.ONE_MINUS_SRC_ALPHA),i.viewport(0,0,t,e),this.programs=new Map,this.currentProgram=null,this.uniformLocations=new Map,this._needsAttributeRebind=!1,this._createQuad()}isAvailable(){return this.available}resize(t,e){this.width=t,this.height=e,this.canvas.width=t,this.canvas.height=e,this.gl&&(this.gl.viewport(0,0,t,e),this._needsAttributeRebind=!0)}_createQuad(){const t=this.gl,e=new Float32Array([-1,-1,1,-1,-1,1,-1,1,1,-1,1,1]),i=new Float32Array([0,0,1,0,0,1,0,1,1,0,1,1]);this.positionBuffer=t.createBuffer(),t.bindBuffer(t.ARRAY_BUFFER,this.positionBuffer),t.bufferData(t.ARRAY_BUFFER,e,t.STATIC_DRAW),this.uvBuffer=t.createBuffer(),t.bindBuffer(t.ARRAY_BUFFER,this.uvBuffer),t.bufferData(t.ARRAY_BUFFER,i,t.STATIC_DRAW)}_compileShader(t,e){const i=this.gl,s=i.createShader(t);return i.shaderSource(s,e),i.compileShader(s),i.getShaderParameter(s,i.COMPILE_STATUS)?s:(console.error("Shader compile error:",i.getShaderInfoLog(s)),console.error("Source:",e),i.deleteShader(s),null)}useProgram(t,e,i){if(!this.available)return null;const s=this.gl;if(this.programs.has(t)){const a=this.programs.get(t);return s.useProgram(a),this.currentProgram=t,this._needsAttributeRebind&&(this._bindAttributes(a),this._needsAttributeRebind=!1),a}const n=this._compileShader(s.VERTEX_SHADER,e),o=this._compileShader(s.FRAGMENT_SHADER,i);if(!n||!o)return null;const r=s.createProgram();return s.attachShader(r,n),s.attachShader(r,o),s.linkProgram(r),s.getProgramParameter(r,s.LINK_STATUS)?(this.programs.set(t,r),this.uniformLocations.set(t,new Map),s.useProgram(r),this.currentProgram=t,this._bindAttributes(r),r):(console.error("Program link error:",s.getProgramInfoLog(r)),s.deleteProgram(r),null)}_bindAttributes(t){const e=this.gl,i=e.getAttribLocation(t,"aPosition"),s=e.getAttribLocation(t,"aUv");i!==-1&&(e.bindBuffer(e.ARRAY_BUFFER,this.positionBuffer),e.enableVertexAttribArray(i),e.vertexAttribPointer(i,2,e.FLOAT,!1,0,0)),s!==-1&&(e.bindBuffer(e.ARRAY_BUFFER,this.uvBuffer),e.enableVertexAttribArray(s),e.vertexAttribPointer(s,2,e.FLOAT,!1,0,0))}_getUniformLocation(t){const e=this.gl,i=this.programs.get(this.currentProgram),s=this.uniformLocations.get(this.currentProgram);return s.has(t)||s.set(t,e.getUniformLocation(i,t)),s.get(t)}setUniforms(t){if(!this.available||!this.currentProgram)return;const e=this.gl;for(const[i,s]of Object.entries(t)){const n=this._getUniformLocation(i);if(n!==null)if(typeof s=="number")e.uniform1f(n,s);else if(Array.isArray(s))switch(s.length){case 2:e.uniform2fv(n,s);break;case 3:e.uniform3fv(n,s);break;case 4:e.uniform4fv(n,s);break}else s instanceof Float32Array&&(s.length===9?e.uniformMatrix3fv(n,!1,s):s.length===16&&e.uniformMatrix4fv(n,!1,s))}}setColorUniform(t,e){if(!this.available||!this.currentProgram)return;const i=e.replace("#",""),s=parseInt(i.substring(0,2),16)/255,n=parseInt(i.substring(2,4),16)/255,o=parseInt(i.substring(4,6),16)/255,r=this._getUniformLocation(t);r!==null&&this.gl.uniform3f(r,s,n,o)}clear(t=0,e=0,i=0,s=0){if(!this.available)return;const n=this.gl;n.clearColor(t,e,i,s),n.clear(n.COLOR_BUFFER_BIT)}render(){if(!this.available||!this.currentProgram)return;const t=this.gl;t.drawArrays(t.TRIANGLES,0,6)}compositeOnto(t,e,i,s,n){this.available&&t.drawImage(this.canvas,e,i,s??this.canvas.width,n??this.canvas.height)}getCanvas(){return this.canvas}destroy(){if(!this.available)return;const t=this.gl;for(const e of this.programs.values())t.deleteProgram(e);t.deleteBuffer(this.positionBuffer),t.deleteBuffer(this.uvBuffer),this.programs.clear(),this.uniformLocations.clear()}}const ks=`
precision highp float;

attribute vec2 aPosition;
attribute vec2 aUv;

varying vec2 vUv;

void main() {
    vUv = aUv;
    gl_Position = vec4(aPosition, 0.0, 1.0);
}
`,Ye=`
precision highp float;

varying vec2 vUv;

// Uniforms common to all sphere shaders
uniform float uTime;
uniform vec2 uResolution;
uniform vec3 uCameraRotation;  // rotationX, rotationY, rotationZ

// =============================================================================
// NOISE FUNCTIONS
// =============================================================================

float hash(float n) {
    return fract(sin(n) * 43758.5453123);
}

float hash2(vec2 p) {
    return fract(sin(dot(p, vec2(127.1, 311.7))) * 43758.5453123);
}

float hash3(vec3 p) {
    return fract(sin(dot(p, vec3(127.1, 311.7, 74.7))) * 43758.5453123);
}

// 3D Value noise
float noise3D(vec3 x) {
    vec3 i = floor(x);
    vec3 f = fract(x);
    f = f * f * (3.0 - 2.0 * f);

    float n = dot(i, vec3(1.0, 57.0, 113.0));

    return mix(
        mix(mix(hash(n + 0.0), hash(n + 1.0), f.x),
            mix(hash(n + 57.0), hash(n + 58.0), f.x), f.y),
        mix(mix(hash(n + 113.0), hash(n + 114.0), f.x),
            mix(hash(n + 170.0), hash(n + 171.0), f.x), f.y), f.z
    );
}

// FBM (Fractional Brownian Motion)
float fbm(vec3 p, int octaves) {
    float value = 0.0;
    float amplitude = 0.5;
    float frequency = 1.0;

    for (int i = 0; i < 8; i++) {
        if (i >= octaves) break;
        value += amplitude * noise3D(p * frequency);
        frequency *= 2.0;
        amplitude *= 0.5;
    }

    return value;
}

// =============================================================================
// RAY-SPHERE INTERSECTION
// =============================================================================

/**
 * Ray-sphere intersection
 * @param rayOrigin - Ray origin (camera position)
 * @param rayDir - Normalized ray direction
 * @param sphereCenter - Sphere center
 * @param sphereRadius - Sphere radius
 * @return t value for intersection, -1.0 if no hit
 */
float raySphereIntersect(vec3 rayOrigin, vec3 rayDir, vec3 sphereCenter, float sphereRadius) {
    vec3 oc = rayOrigin - sphereCenter;
    float a = dot(rayDir, rayDir);
    float b = 2.0 * dot(oc, rayDir);
    float c = dot(oc, oc) - sphereRadius * sphereRadius;
    float discriminant = b * b - 4.0 * a * c;

    if (discriminant < 0.0) {
        return -1.0;
    }

    return (-b - sqrt(discriminant)) / (2.0 * a);
}

// =============================================================================
// CAMERA AND ROTATION
// =============================================================================

/**
 * Create rotation matrix from Euler angles
 */
mat3 rotationMatrix(vec3 rotation) {
    float cx = cos(rotation.x);
    float sx = sin(rotation.x);
    float cy = cos(rotation.y);
    float sy = sin(rotation.y);
    float cz = cos(rotation.z);
    float sz = sin(rotation.z);

    mat3 rx = mat3(
        1.0, 0.0, 0.0,
        0.0, cx, -sx,
        0.0, sx, cx
    );

    mat3 ry = mat3(
        cy, 0.0, sy,
        0.0, 1.0, 0.0,
        -sy, 0.0, cy
    );

    mat3 rz = mat3(
        cz, -sz, 0.0,
        sz, cz, 0.0,
        0.0, 0.0, 1.0
    );

    return rz * ry * rx;
}

/**
 * Calculate ray direction from UV coordinates
 * Uses a simple pinhole camera model
 */
vec3 getRayDirection(vec2 uv) {
    // Convert UV to normalized device coordinates (-1 to 1)
    vec2 ndc = uv * 2.0 - 1.0;
    // Field of view ~53 degrees (atan(0.5) * 2)
    return normalize(vec3(ndc * 0.5, 1.0));
}

// =============================================================================
// LIGHTING
// =============================================================================

/**
 * Simple diffuse + ambient lighting
 */
float lighting(vec3 normal, vec3 lightDir, float ambient) {
    float diffuse = max(0.0, dot(normal, lightDir));
    return ambient + (1.0 - ambient) * diffuse;
}

/**
 * Fresnel effect for rim lighting
 */
float fresnel(vec3 normal, vec3 viewDir, float power) {
    return pow(1.0 - abs(dot(normal, viewDir)), power);
}
`,Rs=`
${Ye}

uniform vec3 uStarColor;
uniform float uTemperature;      // Kelvin, affects color
uniform float uActivityLevel;    // 0-1, affects turbulence
uniform float uRotationSpeed;    // Self-rotation speed (radians/second)

// Tidal disruption uniforms
uniform float uTidalStretch;     // 0 = sphere, 1+ = elongated toward BH
uniform float uStretchDirX;      // Direction to black hole (X component)
uniform float uStretchDirZ;      // Direction to black hole (Z component)
uniform float uStressLevel;      // 0-1, surface chaos from tidal forces
uniform float uBaseRadius;       // Dynamic base radius for proper sizing
uniform float uTidalFlare;       // 0-1, sudden brightness burst at disruption start
uniform float uTidalWobble;      // 0-1, violent geometry wobble during trauma

// =============================================================================
// TIDAL DISTORTION - True Spaghettification via Ellipsoid Deformation
// Uses ray-ellipsoid intersection for physically correct stretching
// =============================================================================

/**
 * Ray-Ellipsoid intersection
 * Ellipsoid defined by semi-axes (a, b, c) where:
 * - a = stretch along BH direction (in XZ plane)
 * - b = Y axis (slight compression)
 * - c = perpendicular to BH direction in XZ plane (compression)
 *
 * Technique: Transform ray into "unit sphere space" via inverse scaling
 */
float rayEllipsoidIntersect(vec3 rayOrigin, vec3 rayDir, vec3 center, vec3 semiAxes) {
    // Scale ray into unit sphere space
    vec3 scaledOrigin = (rayOrigin - center) / semiAxes;
    vec3 scaledDir = rayDir / semiAxes;

    // Standard ray-sphere intersection in scaled space
    float a = dot(scaledDir, scaledDir);
    float b = 2.0 * dot(scaledOrigin, scaledDir);
    float c = dot(scaledOrigin, scaledOrigin) - 1.0;
    float discriminant = b * b - 4.0 * a * c;

    if (discriminant < 0.0) {
        return -1.0;
    }

    return (-b - sqrt(discriminant)) / (2.0 * a);
}

/**
 * Calculate ellipsoid normal at hit point
 * Normal = gradient of ellipsoid equation = 2*(x/aÂ², y/bÂ², z/cÂ²)
 */
vec3 ellipsoidNormal(vec3 hitPoint, vec3 center, vec3 semiAxes) {
    vec3 localPos = hitPoint - center;
    // Gradient of (x/a)Â² + (y/b)Â² + (z/c)Â² = 1
    vec3 grad = localPos / (semiAxes * semiAxes);
    return normalize(grad);
}

/**
 * Build tidal stretch axes from BH direction
 * Returns semi-axes (stretchAxis, Y, perpAxis) for ellipsoid
 * Includes violent wobble effect during trauma
 */
vec3 tidalSemiAxes(float stretch, vec2 stretchDir, float baseRadius, float wobble, float time) {
    // Stretch factor along BH direction (elongation toward/away from BH)
    float stretchFactor = 1.0 + stretch * 0.8;  // Up to 1.8x longer

    // Compression factor perpendicular (volume roughly conserved)
    float compressFactor = 1.0 / sqrt(stretchFactor);  // Compress to conserve volume

    // Y axis gets slight compression too
    float yFactor = 1.0 - stretch * 0.15;

    // === TRAUMA WOBBLE ===
    // Violent, chaotic geometry distortion during tidal shock
    if (wobble > 0.01) {
        // Multiple frequency wobbles for organic chaos
        float wobble1 = sin(time * 12.0) * cos(time * 7.3);
        float wobble2 = sin(time * 19.0 + 1.5) * cos(time * 11.0);
        float wobble3 = sin(time * 8.0 + 3.0);
        
        // Asymmetric wobble - more violent on stretch axis
        float stretchWobble = wobble * (0.3 + wobble1 * 0.2 + wobble2 * 0.15);
        float yWobble = wobble * (wobble2 * 0.25 + wobble3 * 0.15);
        float perpWobble = wobble * (wobble3 * 0.2 + wobble1 * 0.1);
        
        stretchFactor *= (1.0 + stretchWobble);
        yFactor *= (1.0 + yWobble);
        compressFactor *= (1.0 + perpWobble);
    }

    return vec3(
        baseRadius * stretchFactor,   // Stretch along BH radial
        baseRadius * yFactor,         // Slight Y compression
        baseRadius * compressFactor   // Compress perpendicular
    );
}

// =============================================================================
// PLASMA NOISE with flowing distortion
// =============================================================================

float plasmaNoise(vec3 p, float time) {
    float value = 0.0;
    float amplitude = 1.0;
    float frequency = 1.0;
    float totalAmp = 0.0;

    for (int i = 0; i < 5; i++) {
        vec3 offset = vec3(
            sin(time * 0.1 + float(i)) * 0.5,
            cos(time * 0.15 + float(i) * 0.7) * 0.5,
            time * 0.05
        );
        value += amplitude * noise3D((p + offset) * frequency);
        totalAmp += amplitude;
        amplitude *= 0.5;
        frequency *= 2.0;
    }

    return value / totalAmp;
}

// =============================================================================
// HOT BUBBLES - bright spots that appear and pop
// =============================================================================

float hotBubbles(vec3 p, float time) {
    // Large slow bubbles
    vec3 p1 = p * 5.0 + vec3(0.0, time * 0.06, 0.0);
    float b1 = noise3D(p1);
    b1 = smoothstep(0.3, 0.6, b1);

    // Medium bubbles, faster
    vec3 p2 = p * 9.0 + vec3(time * 0.04, time * 0.08, 0.0);
    float b2 = noise3D(p2);
    b2 = smoothstep(0.35, 0.65, b2);

    // Small rapid bubbles
    vec3 p3 = p * 16.0 + vec3(time * 0.1, 0.0, time * 0.12);
    float b3 = noise3D(p3);
    b3 = smoothstep(0.4, 0.7, b3);

    float bubbles = b1 * 0.5 + b2 * 0.35 + b3 * 0.15;
    float pulse = sin(time * 2.0 + p.x * 10.0) * 0.3 + 0.7;

    return bubbles * pulse;
}

// =============================================================================
// BOILING TURBULENCE - fast chaotic movement
// =============================================================================

float boilingTurbulence(vec3 p, float time) {
    float turb = 0.0;
    float amp = 1.0;
    float freq = 4.0;

    for (int i = 0; i < 4; i++) {
        vec3 offset = vec3(
            sin(time * 0.3 + float(i) * 1.7) * 0.5,
            cos(time * 0.25 + float(i) * 2.3) * 0.5,
            time * 0.15 * (1.0 + float(i) * 0.3)
        );
        turb += amp * abs(noise3D(p * freq + offset));
        amp *= 0.5;
        freq *= 2.1;
    }
    return turb;
}

// =============================================================================
// CORONA FLAMES - structures around the edge
// =============================================================================

float coronaFlames(float angle, float rimFactor, float time, float activity) {
    // Multiple flame frequencies
    float flames = 0.0;

    // Large slow flames
    float f1 = sin(angle * 5.0 + time * 0.5) * 0.5 + 0.5;
    f1 *= noise3D(vec3(angle * 2.0, time * 0.3, 0.0));

    // Medium flames
    float f2 = sin(angle * 12.0 + time * 0.8) * 0.5 + 0.5;
    f2 *= noise3D(vec3(angle * 4.0, time * 0.5, 5.0));

    // Small rapid flames
    float f3 = sin(angle * 25.0 + time * 1.5) * 0.5 + 0.5;
    f3 *= noise3D(vec3(angle * 8.0, time * 0.8, 10.0));

    flames = f1 * 0.5 + f2 * 0.3 + f3 * 0.2;

    // Flames only visible at rim
    flames *= pow(rimFactor, 1.5);
    flames *= 0.5 + activity * 0.5;

    return flames;
}

// =============================================================================
// SELF ROTATION - rotate normal around Y axis
// =============================================================================

vec3 rotateY(vec3 v, float angle) {
    float c = cos(angle);
    float s = sin(angle);
    return vec3(v.x * c + v.z * s, v.y, -v.x * s + v.z * c);
}

void main() {
    // === CIRCULAR MASK - prevents square canvas artifacts ===
    vec2 center = vUv - 0.5;
    float distFromCenter = length(center) * 2.0;

    // Wider cutoff for stretched ellipsoid
    if (distFromCenter > 1.6) {
        gl_FragColor = vec4(0.0);
        return;
    }

    float circularMask = 1.0 - smoothstep(1.3, 1.6, distFromCenter);

    // Setup ray - camera looking at sphere from fixed position
    vec3 rayOrigin = vec3(0.0, 0.0, -2.5);
    vec3 rayDir = getRayDirection(vUv);

    float time = uTime;
    float selfRotation = time * uRotationSpeed;

    // === TIDAL ELLIPSOID SETUP ===
    // Direction toward black hole in XZ plane
    vec2 stretchDir2D = normalize(vec2(uStretchDirX, uStretchDirZ) + 0.0001);
    float stretch = uTidalStretch;

    // Build rotation matrix to align ellipsoid X-axis with stretch direction
    // This rotates the ellipsoid so its long axis points toward the BH
    float stretchAngle = atan(stretchDir2D.y, stretchDir2D.x);
    float cs = cos(stretchAngle);
    float sn = sin(stretchAngle);

    // Rotation matrix around Y axis (to align stretch in XZ plane)
    mat3 stretchRot = mat3(
        cs,  0.0, -sn,
        0.0, 1.0, 0.0,
        sn,  0.0,  cs
    );
    mat3 stretchRotInv = mat3(
        cs,  0.0,  sn,
        0.0, 1.0, 0.0,
        -sn, 0.0,  cs
    );

    // Transform ray into ellipsoid-aligned space
    vec3 rotatedRayDir = stretchRotInv * rayDir;
    vec3 rotatedRayOrigin = stretchRotInv * rayOrigin;

    // Calculate ellipsoid semi-axes based on stretch
    // Use dynamic base radius passed from JS (scales with render texture size)
    // Falls back to 0.4 if uniform not set
    float baseRadius = uBaseRadius > 0.0 ? uBaseRadius : 0.4;
    vec3 semiAxes = tidalSemiAxes(stretch, stretchDir2D, baseRadius, uTidalWobble, time);

    // Ray-ellipsoid intersection for SURFACE
    float t = rayEllipsoidIntersect(rotatedRayOrigin, rotatedRayDir, vec3(0.0), semiAxes);

    // === NO CORONA - just render solid ellipsoid ===
    // If ray doesn't hit the surface, render transparent
    if (t < 0.0) {
        gl_FragColor = vec4(0.0);
        return;
    }

    // === SURFACE RENDERING ===
    // Calculate hit point in rotated (ellipsoid-aligned) space
    vec3 rotatedHitPoint = rotatedRayOrigin + rotatedRayDir * t;

    // Calculate ellipsoid normal (gradient of implicit surface)
    vec3 rotatedNormalRaw = ellipsoidNormal(rotatedHitPoint, vec3(0.0), semiAxes);

    // Transform hit point and normal back to world space
    vec3 hitPoint = stretchRot * rotatedHitPoint;
    vec3 normal = normalize(stretchRot * rotatedNormalRaw);

    // Apply inverse camera rotation to the normal (camera orbit)
    mat3 camRotMat = rotationMatrix(-uCameraRotation);
    vec3 rotatedNormal = camRotMat * normal;

    // Apply self-rotation to surface features
    rotatedNormal = rotateY(rotatedNormal, selfRotation);

    // === SPHERICAL DISTORTION for boiling effect ===
    vec2 sp = normal.xy;
    float r = dot(sp, sp);

    float brightness = 0.15 + (uTemperature / 10000.0) * 0.1;
    float distortStrength = 2.0 - brightness;

    vec2 warpedUV;
    if (r < 0.0001) {
        // At pole - use alternative coords
        float poleAngle = atan(rotatedNormal.y, rotatedNormal.x) + time * 0.15;
        float poleElev = acos(clamp(rotatedNormal.z, -1.0, 1.0));
        warpedUV = vec2(cos(poleAngle), sin(poleAngle)) * (poleElev / 3.14159) * distortStrength;
    } else {
        sp *= distortStrength;
        r = dot(sp, sp);
        float f = (1.0 - sqrt(abs(1.0 - r))) / (r + 0.001) + brightness * 0.5;
        warpedUV = sp * f + vec2(time * 0.05, 0.0);
    }

    // === PLASMA TEXTURE ===
    vec3 plasmaCoord = vec3(warpedUV * 3.0, time * 0.12);
    float plasma1 = plasmaNoise(plasmaCoord, time);
    float plasma2 = plasmaNoise(plasmaCoord * 1.3 + vec3(50.0), time * 1.2);
    float plasma = plasma1 * 0.6 + plasma2 * 0.4;
    plasma = plasma * 0.5 + 0.5;

    // === VIEW GEOMETRY ===
    float viewAngle = dot(normal, -rayDir);
    float edgeDist = 1.0 - viewAngle;
    float limbDarkening = pow(max(0.0, viewAngle), 0.4);

    // === TIDAL FACE INTENSITY ===
    // The side facing the black hole experiences more violent tidal forces
    // Calculate how much this surface point faces the BH direction
    vec3 bhDir3D = normalize(vec3(uStretchDirX, 0.0, uStretchDirZ));
    float facingBH = dot(normal, bhDir3D);  // -1 to 1, positive = facing BH
    float tidalFace = smoothstep(-0.2, 0.8, facingBH);  // Gradual transition
    tidalFace = tidalFace * tidalFace;  // More concentrated on BH side
    
    // Tidal face boost - up to 3x more violent on the BH-facing side
    float tidalFaceBoost = 1.0 + tidalFace * uStressLevel * 2.0;

    // === MULTI-LAYER EFFECTS (stress-enhanced) ===
    // Stress amplifies all turbulent effects - star is being torn apart!
    // Much more violent - up to 5x chaos at max stress
    float stressBoost = 1.0 + uStressLevel * 4.0;
    
    // Combined boost: general stress + extra violence on BH-facing side
    float combinedBoost = stressBoost * tidalFaceBoost;

    float turbIntensity = boilingTurbulence(rotatedNormal, time * combinedBoost) * 0.6;
    turbIntensity *= combinedBoost;

    float bubbles = hotBubbles(rotatedNormal, time * combinedBoost);
    bubbles *= combinedBoost * 1.5;  // More dramatic bubbles on tidal face

    // Granulation becomes violent under stress - larger and faster
    float gran = noise3D(rotatedNormal * 15.0 + time * 0.5 * combinedBoost);
    gran *= combinedBoost * 1.2;

    // === TIDAL FRACTURING ===
    // Stress causes visible cracks/tears - concentrated on BH-facing side
    float fractures = 0.0;
    if (uStressLevel > 0.15) {  // Start fractures earlier (was 0.3)
        // Fractures are more intense on the tidal face
        float fractureBoost = 1.0 + tidalFace * 2.0;  // Up to 3x on BH side
        float fractureNoise = noise3D(rotatedNormal * 6.0 + time * 0.8 * fractureBoost);
        float fractureThreshold = 1.0 - (uStressLevel - 0.15) * 1.2 * fractureBoost;
        fractures = smoothstep(fractureThreshold, fractureThreshold + 0.08, fractureNoise);
        fractures *= uStressLevel * 1.2 * fractureBoost;  // More intense on BH side
    }

    // === PULSATION (amplified by stress) ===
    float pulse1 = cos(time * 0.5) * 0.5;
    float pulse2 = sin(time * 0.25) * 0.5;
    float pulseAmp = uActivityLevel * (1.0 + uStressLevel);
    float pulse = (pulse1 + pulse2) * 0.3 * pulseAmp;

    // === TIDAL HOTSPOT ===
    // Bright glowing region on the BH-facing side - like matter being pulled off
    float tidalHotspot = pow(tidalFace, 3.0) * uStressLevel;
    // Add some flickering/chaos to the hotspot
    tidalHotspot *= 0.7 + 0.3 * noise3D(rotatedNormal * 8.0 + time * 2.0);

    // === COMBINED INTENSITY ===
    float totalIntensity = plasma * 0.35 + turbIntensity * 0.25 + gran * 0.2;
    totalIntensity += bubbles * 0.4;
    totalIntensity += fractures * 0.5;  // Fractures glow hot
    totalIntensity += tidalHotspot * 0.8;  // Bright tidal hotspot
    totalIntensity *= 1.0 + pulse;

    // === 4-TIER COLOR SYSTEM ===
    vec3 baseColor = uStarColor;
    float maxComp = max(baseColor.r, max(baseColor.g, baseColor.b));
    if (maxComp > 0.01) baseColor = baseColor / maxComp * 0.85;

    // Temperature-based color blending
    float tempBlend = smoothstep(5000.0, 7500.0, uTemperature);

    vec3 hotColor = baseColor * vec3(1.6, 1.35, 1.2);
    vec3 coolColor = mix(baseColor * vec3(0.5, 0.3, 0.2), baseColor * vec3(0.7, 0.8, 0.95), tempBlend);
    vec3 warmColor = mix(baseColor * vec3(1.2, 1.0, 0.85), baseColor * vec3(1.0, 1.05, 1.2), tempBlend);
    vec3 blazingColor = mix(baseColor * vec3(2.0, 1.6, 1.3), baseColor * vec3(1.4, 1.5, 1.8), tempBlend);

    // Map intensity to color
    vec3 surfaceColor;
    if (totalIntensity < 0.35) {
        surfaceColor = mix(coolColor, warmColor, totalIntensity / 0.35);
    } else if (totalIntensity < 0.65) {
        surfaceColor = mix(warmColor, hotColor, (totalIntensity - 0.35) / 0.3);
    } else if (totalIntensity < 1.0) {
        surfaceColor = mix(hotColor, blazingColor, (totalIntensity - 0.65) / 0.35);
    } else {
        surfaceColor = blazingColor * (1.0 + (totalIntensity - 1.0) * 0.8);
    }

    // Bubble highlights
    float bubbleHighlight = pow(bubbles, 1.5) * turbIntensity;
    surfaceColor += blazingColor * bubbleHighlight * 0.6;

    // === LIMB DARKENING ===
    surfaceColor *= 0.75 + limbDarkening * 0.25;

    // === ORGANIC RIM GLOW ===
    float rimAngle = atan(normal.y, normal.x) + selfRotation;
    float rimNoise = noise3D(vec3(rimAngle * 3.0, edgeDist * 2.0, time * 0.2));
    rimNoise = rimNoise * 0.5 + 0.5;

    float rimIntensity = pow(edgeDist, 2.0) * (0.4 + rimNoise * 0.6);
    vec3 rimColor = baseColor * vec3(1.3, 0.95, 0.6);
    surfaceColor += rimColor * rimIntensity * 0.6 * uActivityLevel;

    // === EDGE GLOW (corona bleeding into surface) ===
    float edgeGlow = pow(edgeDist, 0.5) * 0.3 * uActivityLevel;
    surfaceColor += warmColor * edgeGlow;

    // === CENTER BOOST ===
    float centerBoost = pow(viewAngle, 1.5) * 0.2;
    surfaceColor += baseColor * centerBoost;

    // === SHIMMER ===
    float shimmer = sin(turbIntensity * 10.0 + time * 3.0) * 0.05 + 1.0;
    surfaceColor *= shimmer;

    // === TIDAL FLARE ===
    // Sudden brightness burst when disruption begins
    // Concentrated on the BH-facing side with violent flickering
    if (uTidalFlare > 0.01) {
        // Flare is brightest on the BH-facing side
        float flareFace = 0.3 + tidalFace * 0.7;
        
        // Violent flickering during the flare
        float flareFlicker = 0.7 + 0.3 * noise3D(rotatedNormal * 10.0 + time * 8.0);
        
        // White-hot flare color
        vec3 flareColor = vec3(1.0, 0.95, 0.8);
        
        // Additive flare - makes entire star brighter
        float flareIntensity = uTidalFlare * flareFace * flareFlicker * 2.0;
        surfaceColor += flareColor * flareIntensity;
        
        // Extra bloom at the BH-facing tip
        float tipFlare = pow(tidalFace, 4.0) * uTidalFlare * 1.5;
        surfaceColor += vec3(1.0, 0.9, 0.7) * tipFlare;
    }

    surfaceColor = clamp(surfaceColor, 0.0, 3.5);  // Allow brighter for flare

    gl_FragColor = vec4(surfaceColor, 1.0);
}
`,Cs=`
${Ye}

uniform float uAwakeningLevel;  // 0 = dormant, 1 = fully active
uniform float uFeedingPulse;    // Temporary glow from feeding
uniform float uRotation;        // Black hole spin angle (Kerr rotation)

void main() {
    vec2 uv = vUv;
    vec2 center = uv - 0.5;
    float dist = length(center) * 2.0;  // 0 at center, 1 at edge
    float angle = atan(center.y, center.x);

    float time = uTime;
    float awakeFactor = uAwakeningLevel;
    float pulseFactor = uFeedingPulse;

    // Spin angle for rotating effects (frame dragging)
    // Using uTime since custom uniforms don't update properly
    float spinAngle = angle + uTime * 4.0;  // Faster spin

    // === RADII (normalized to quad size) ===
    float eventHorizon = 0.42;          // Slightly larger core
    float photonSphere = 0.54;          // Tighten ring closer to horizon
    float shadowEdge = 0.5;             // Shadow boundary

    // === CIRCULAR MASK ===
    if (dist > 1.5) {
        gl_FragColor = vec4(0.0);
        return;
    }

    // === NO INTERNAL STARFIELD ===
    // The real starfield is rendered separately in the scene
    // This shader just renders the dark void + subtle edge effects
    // True gravitational lensing would require render-to-texture of background

    // === EVENT HORIZON - Gradient from pure black to very dark edge ===
    // Edge color ~#110b06 = RGB(17,11,6) = vec3(0.067, 0.043, 0.024)
    if (dist < shadowEdge) {
        // Use shadowEdge (0.52) as outer boundary for smooth transition to ring
        float edgeT = dist / shadowEdge;  // 0 at center, 1 at shadow edge

        // Very steep curve - stays pure black until very close to edge
        float glowFactor = pow(edgeT, 8.0);

        // Very dark brownish-black - NO yellow, matches #110b06
        vec3 edgeColor = vec3(0.067, 0.043, 0.024) * glowFactor;

        gl_FragColor = vec4(edgeColor, 1.0);
        return;
    }

    // === PHOTON SPHERE - Subtle ring with gentler spin asymmetry ===
    float photonRingWidth = 0.035;
    float photonDist = abs(dist - photonSphere);
    float photonRing = exp(-photonDist * photonDist / (photonRingWidth * photonRingWidth));

    // Softer Doppler asymmetry to avoid pointy highlights
    float doppler = 0.78 + 0.22 * cos(spinAngle);  // narrower asymmetry
    photonRing *= 0.18 + doppler * 0.38;           // 18%..56% brightness

    // Soft tip highlight to indicate spin without a spike
    float tipAlign = max(0.0, cos(spinAngle));
    float tipRadial = smoothstep(photonRingWidth * 1.2, 0.0, photonDist);
    float hotSpotGlow = tipAlign * tipAlign * tipRadial * 0.25;

    // Scale with awakening - more visible when feeding
    photonRing *= 0.15 + awakeFactor * 0.35;

    // === FEEDING PULSE - Subtle ripple when consuming ===
    float pulseRipple = 0.0;
    if (pulseFactor > 0.01) {
        float ripplePhase = fract(time * 1.5) * 0.3;
        float rippleRadius = shadowEdge + ripplePhase;
        float ripple = exp(-pow(dist - rippleRadius, 2.0) * 80.0);
        pulseRipple = ripple * pulseFactor * 0.15;  // Subtle
    }

    // === EDGE GLOW - keep subtle; avoid wide smear
    float edgeGlow = 0.0;
    if (dist > shadowEdge && dist < photonSphere + 0.08) {
        float edgeFactor = smoothstep(shadowEdge, photonSphere, dist);
        edgeFactor *= smoothstep(photonSphere + 0.08, photonSphere, dist);
        edgeGlow = edgeFactor * pulseFactor * 0.06;
    }

    // === COMBINE EFFECTS ===
    vec3 color = vec3(0.0);

    // Photon sphere ring (warm orange-yellow)
    vec3 photonColor = vec3(1.0, 0.8, 0.45);
    color += photonColor * photonRing;

    // Soft tip highlight (spin indicator)
    vec3 hotSpotColor = vec3(1.0, 0.9, 0.65);
    color += hotSpotColor * hotSpotGlow;

    // Edge glow when feeding
    vec3 glowColor = vec3(1.0, 0.5, 0.2);
    color += glowColor * edgeGlow;

    // Feeding pulse ripple
    vec3 pulseColor = vec3(1.0, 0.6, 0.3);
    color += pulseColor * pulseRipple;

    // === OUTER FADE ===
    float outerFade = 1.0 - smoothstep(0.9, 1.25, dist);
    color *= outerFade;

    // === ALPHA ===
    // Event horizon and photon sphere are fully opaque to occlude background
    float alpha;
    if (dist < photonSphere) {
        alpha = 1.0;
        color = (dist < shadowEdge) ? vec3(0.0) : color; // keep core solid black
    } else {
        // Alpha based on visible content
        float contentBrightness = max(max(color.r, color.g), color.b);
        alpha = smoothstep(0.01, 0.06, contentBrightness);
        alpha = max(alpha, smoothstep(photonSphere + 0.12, shadowEdge, dist) * 0.25);
        alpha *= outerFade;
    }

    gl_FragColor = vec4(color, alpha);
}
`,Ds=`
${Ye}

uniform vec3 uBaseColor;
uniform float uHasAtmosphere;  // 0-1
uniform float uSeed;

void main() {
    // Setup ray - camera looking at sphere from fixed position
    vec3 rayOrigin = vec3(0.0, 0.0, -2.5);
    vec3 rayDir = getRayDirection(vUv);

    // Ray-sphere intersection (sphere at origin with radius 0.5)
    float t = raySphereIntersect(rayOrigin, rayDir, vec3(0.0), 0.5);

    if (t < 0.0) {
        // Atmosphere halo
        if (uHasAtmosphere > 0.0) {
            vec2 center = vUv - 0.5;
            float dist = length(center) * 2.0;
            float atmo = smoothstep(0.6, 0.5, dist) * smoothstep(0.45, 0.52, dist);
            atmo *= uHasAtmosphere * 0.4;
            vec3 atmoColor = vec3(0.5, 0.7, 1.0) * atmo;
            // Premultiplied alpha
            gl_FragColor = vec4(atmoColor * atmo, atmo);
        } else {
            gl_FragColor = vec4(0.0);
        }
        return;
    }

    // Calculate hit point and normal
    vec3 hitPoint = rayOrigin + rayDir * t;
    vec3 normal = normalize(hitPoint);

    // Apply inverse camera rotation for surface features
    mat3 rotMat = rotationMatrix(-uCameraRotation);
    vec3 rotatedNormal = rotMat * normal;

    // Seeded noise for consistent terrain
    vec3 noiseCoord = rotatedNormal * 4.0 + uSeed * 100.0;
    float terrain = fbm(noiseCoord, 5);

    // Height-based coloring
    vec3 lowColor = uBaseColor * 0.6;    // Valleys/lowlands
    vec3 highColor = uBaseColor * 1.2;   // Mountains/highlands
    vec3 surfaceColor = mix(lowColor, highColor, terrain);

    // Add some variation
    float variation = noise3D(rotatedNormal * 10.0 + uSeed * 50.0);
    surfaceColor *= 0.9 + variation * 0.2;

    // Lighting
    vec3 lightDir = normalize(vec3(1.0, 1.0, 0.5));
    float light = lighting(normal, lightDir, 0.3);
    surfaceColor *= light;

    // Atmosphere scattering at edges
    if (uHasAtmosphere > 0.0) {
        float rim = fresnel(normal, -rayDir, 3.0);
        vec3 atmoColor = vec3(0.5, 0.7, 1.0);
        surfaceColor = mix(surfaceColor, atmoColor, rim * uHasAtmosphere * 0.4);
    }

    gl_FragColor = vec4(surfaceColor, 1.0);
}
`,Es=`
${Ye}

uniform vec3 uBaseColor;
uniform float uSeed;
uniform float uStormIntensity;  // 0-1
uniform float uRotationSpeed;   // rotation speed multiplier (default ~0.1)

void main() {
    // Setup ray - camera looking at sphere from fixed position
    vec3 rayOrigin = vec3(0.0, 0.0, -2.5);
    vec3 rayDir = getRayDirection(vUv);

    // Ray-sphere intersection (sphere at origin with radius 0.5)
    float t = raySphereIntersect(rayOrigin, rayDir, vec3(0.0), 0.5);

    if (t < 0.0) {
        gl_FragColor = vec4(0.0);
        return;
    }

    // Calculate hit point and normal
    vec3 hitPoint = rayOrigin + rayDir * t;
    vec3 normal = normalize(hitPoint);

    // Apply inverse camera rotation for surface features
    mat3 rotMat = rotationMatrix(-uCameraRotation);
    vec3 rotatedNormal = rotMat * normal;

    // Convert to spherical coordinates for banding (use rotated normal)
    float latitude = asin(rotatedNormal.y);  // -PI/2 to PI/2
    float longitude = atan(rotatedNormal.z, rotatedNormal.x);  // -PI to PI

    // Animated rotation (use uRotationSpeed, default to 0.1 if not set)
    float rotSpeed = uRotationSpeed > 0.0 ? uRotationSpeed : 0.1;
    float time = uTime * rotSpeed;

    // Create bands based on latitude
    float bands = sin(latitude * 15.0 + time) * 0.5 + 0.5;
    bands += sin(latitude * 25.0 - time * 0.5) * 0.25;
    bands += sin(latitude * 40.0 + time * 0.3) * 0.125;

    // Turbulent distortion of bands
    vec3 noiseCoord = vec3(longitude + time * 0.2, latitude * 3.0, uSeed);
    float turb = fbm(noiseCoord * 5.0, 4) * 0.3;
    bands += turb;

    // Color variation based on bands
    vec3 lightBand = uBaseColor * 1.3;
    vec3 darkBand = uBaseColor * 0.7;
    vec3 surfaceColor = mix(darkBand, lightBand, bands);

    // Add storm features
    if (uStormIntensity > 0.0) {
        // Great red spot style storm
        float stormLat = 0.3;  // Storm latitude
        float stormLon = time * 0.5;  // Storm drifts
        vec2 stormCenter = vec2(stormLon, stormLat);
        vec2 pos = vec2(longitude, latitude);
        float stormDist = length(pos - stormCenter);
        float storm = smoothstep(0.5, 0.2, stormDist);
        storm *= uStormIntensity;

        // Storm color and swirl
        vec3 stormColor = vec3(0.8, 0.3, 0.2);
        float swirl = sin(stormDist * 20.0 - time * 3.0) * 0.5 + 0.5;
        surfaceColor = mix(surfaceColor, stormColor * swirl, storm);
    }

    // Lighting with some subsurface scattering effect
    vec3 lightDir = normalize(vec3(1.0, 0.5, 0.3));
    float light = lighting(normal, lightDir, 0.4);
    surfaceColor *= light;

    // Limb darkening
    float viewAngle = dot(normal, -rayDir);
    surfaceColor *= 0.7 + max(0.0, viewAngle) * 0.3;

    gl_FragColor = vec4(surfaceColor, 1.0);
}
`,Jt={vertex:ks,star:Rs,blackHole:Cs,rockyPlanet:Ds,gasGiant:Es},ni=class Lt extends dt{static _getGLRenderer(t,e){return Lt._glRenderer?(Lt._glRendererSize.width!==t||Lt._glRendererSize.height!==e)&&(Lt._glRenderer.resize(t,e),Lt._glRendererSize={width:t,height:e}):(Lt._glRenderer=new Ai(t,e),Lt._glRendererSize={width:t,height:e}),Lt._glRenderer}constructor(t,e={}){super(e),this.radius=t,this.camera=e.camera??null,this.debug=e.debug??!1,this.segments=e.segments??20,this.useShader=e.useShader??!1,this.shaderType=e.shaderType??"star",this.shaderUniforms=e.shaderUniforms??{},this._shaderInitialized=!1,this.selfRotationX=e.selfRotationX??0,this.selfRotationY=e.selfRotationY??0,this.selfRotationZ=e.selfRotationZ??0,this._generateGeometry()}setCamera(t){return this.camera=t,this}setShaderUniforms(t){return Object.assign(this.shaderUniforms,t),this}_getFragmentShader(){switch(this.shaderType){case"star":return Jt.star;case"blackHole":return Jt.blackHole;case"rockyPlanet":return Jt.rockyPlanet;case"gasGiant":return Jt.gasGiant;default:return Jt.star}}_initShader(t,e){const i=Lt._getGLRenderer(t,e);if(!i||!i.isAvailable()){this.useShader=!1;return}const s=`sphere_${this.shaderType}`;i.useProgram(s,Jt.vertex,this._getFragmentShader()),this._shaderInitialized=!0}_renderWithShader(t,e,i,s){var n,o,r,a;const h=1+(((n=this.shaderUniforms)==null?void 0:n.uTidalStretch)??0),d=s*h,u=Math.ceil((s+d)*2),f=Lt._getGLRenderer(u,u);if(!f||!f.isAvailable())return!1;this._shaderInitialized||this._initShader(u,u);const g=`sphere_${this.shaderType}`;f.useProgram(g,Jt.vertex,this._getFragmentShader()),f.clear(0,0,0,0);const p=1.25*s/(u/2);f.setUniforms({uTime:performance.now()/1e3,uResolution:[u,u],uBaseRadius:p,uCameraRotation:[((o=this.camera)==null?void 0:o.rotationX)??0,((r=this.camera)==null?void 0:r.rotationY)??0,((a=this.camera)==null?void 0:a.rotationZ)??0]}),f.setUniforms(this.shaderUniforms);for(const[w,x]of Object.entries(this.shaderUniforms))typeof x=="string"&&x.startsWith("#")&&f.setColorUniform(w,x);f.render();const v=e-u/2,_=i-u/2;return f.compositeOnto(t,v,_,u,u),!0}_generateGeometry(){this.vertices=[],this.faces=[];const t=this.segments,e=this.segments*2;for(let i=0;i<=t;i++){const s=i*Math.PI/t,n=Math.sin(s),o=Math.cos(s);for(let r=0;r<=e;r++){const a=r*2*Math.PI/e,l=Math.sin(a),h=Math.cos(a),d=this.radius*n*h,u=this.radius*o,f=this.radius*n*l;this.vertices.push({x:d,y:u,z:f,nx:n*h,ny:o,nz:n*l})}}for(let i=0;i<t;i++)for(let s=0;s<e;s++){const n=i*(e+1)+s,o=n+e+1;this.faces.push([n,o,n+1]),this.faces.push([o,o+1,n+1])}}_applySelfRotation(t,e,i){if(this.selfRotationY!==0){const s=Math.cos(this.selfRotationY),n=Math.sin(this.selfRotationY),o=t*s-i*n,r=t*n+i*s;t=o,i=r}if(this.selfRotationX!==0){const s=Math.cos(this.selfRotationX),n=Math.sin(this.selfRotationX),o=e*s-i*n,r=e*n+i*s;e=o,i=r}if(this.selfRotationZ!==0){const s=Math.cos(this.selfRotationZ),n=Math.sin(this.selfRotationZ),o=t*s-e*n,r=t*n+e*s;t=o,e=r}return{x:t,y:e,z:i}}_calculateLighting(t,e,i){const r=Math.sqrt(.99),a=.5/r,l=.7/r,h=.5/r;let d=t*a+e*l+i*h;return d=Math.max(0,d)*.7+.3,d}_applyLighting(t,e){if(!t||typeof t!="string"||!t.startsWith("#"))return t;const i=t.replace("#",""),s=parseInt(i.substring(0,2),16),n=parseInt(i.substring(2,4),16),o=parseInt(i.substring(4,6),16),r=Math.round(s*e),a=Math.round(n*e),l=Math.round(o*e);return`rgb(${r}, ${a}, ${l})`}draw(){if(super.draw(),!this.camera){this.color&&y.shapes.fillCircle(0,0,this.radius,this.color),this.debug&&this.stroke&&y.shapes.strokeCircle(0,0,this.radius,this.stroke,this.lineWidth);return}if(this.useShader&&!this.debug){const s=this.camera.project(this.x||0,this.y||0,this.z||0),n=this.camera.perspective/(this.camera.perspective+s.z),o=this.radius*n,r=y.ctx,a=r.getTransform(),l=a.e,h=a.f;r.save(),r.setTransform(1,0,0,1,0,0);const d=this._renderWithShader(r,l+s.x,h+s.y,o);if(r.restore(),d)return}const t=this.selfRotationX!==0||this.selfRotationY!==0||this.selfRotationZ!==0,e=this.vertices.map(s=>{let n=s.x,o=s.y,r=s.z,a=s.nx,l=s.ny,h=s.nz;if(t){const x=this._applySelfRotation(n,o,r);n=x.x,o=x.y,r=x.z;const S=this._applySelfRotation(a,l,h);a=S.x,l=S.y,h=S.z}const d=this.camera.project(n+(this.x||0),o+(this.y||0),r+(this.z||0));if(this.camera.rotationZ!==0){const x=Math.cos(this.camera.rotationZ),S=Math.sin(this.camera.rotationZ),k=a,C=l;a=k*x-C*S,l=k*S+C*x}const u=Math.cos(this.camera.rotationY),f=Math.sin(this.camera.rotationY),g=a*u-h*f,m=a*f+h*u,p=Math.cos(this.camera.rotationX),v=Math.sin(this.camera.rotationX),_=l*p-m*v,w=l*v+m*p;return{...d,nx:g,ny:_,nz:w}});this.debug&&this.trace("Sphere3D.draw: projected vertices",e.length);const i=[];for(const s of this.faces){const n=e[s[0]],o=e[s[1]],r=e[s[2]];if(n.z<-this.camera.perspective+10||o.z<-this.camera.perspective+10||r.z<-this.camera.perspective+10)continue;const a=(n.z+o.z+r.z)/3,l=(n.nx+o.nx+r.nx)/3,h=(n.ny+o.ny+r.ny)/3,d=(n.nz+o.nz+r.nz)/3;if(d>.1)continue;const u=this._calculateLighting(l,h,d);i.push({vertices:[n,o,r],avgZ:a,intensity:u})}i.sort((s,n)=>n.avgZ-s.avgZ);for(const s of i){const n=s.vertices.map(o=>({x:o.x,y:o.y}));if(this.debug)y.ctx.beginPath(),y.ctx.moveTo(n[0].x,n[0].y),y.ctx.lineTo(n[1].x,n[1].y),y.ctx.lineTo(n[2].x,n[2].y),y.ctx.closePath(),this.stroke&&(y.ctx.strokeStyle=this.stroke,y.ctx.lineWidth=this.lineWidth??1,y.ctx.stroke());else if(this.color){const o=this._applyLighting(this.color,s.intensity);y.ctx.beginPath(),y.ctx.moveTo(n[0].x,n[0].y),y.ctx.lineTo(n[1].x,n[1].y),y.ctx.lineTo(n[2].x,n[2].y),y.ctx.closePath(),y.ctx.fillStyle=o,y.ctx.fill()}}}calculateBounds(){const t=this.radius*2;return{x:this.x,y:this.y,width:t,height:t}}};P(ni,"_glRenderer",null);P(ni,"_glRendererSize",{width:0,height:0});let Qn=ni;const Ps=`
precision highp float;

attribute vec2 aPosition;
attribute vec2 aUv;

varying vec2 vUv;

void main() {
    vUv = aUv;
    gl_Position = vec4(aPosition, 0.0, 1.0);
}
`,Xe=`
precision highp float;

varying vec2 vUv;

uniform float uTime;
uniform vec2 uResolution;

// =============================================================================
// NOISE FUNCTIONS
// =============================================================================

float hash(float n) {
    return fract(sin(n) * 43758.5453123);
}

float hash2(vec2 p) {
    return fract(sin(dot(p, vec2(127.1, 311.7))) * 43758.5453123);
}

// 2D Value noise
float noise2D(vec2 x) {
    vec2 i = floor(x);
    vec2 f = fract(x);
    f = f * f * (3.0 - 2.0 * f);

    float a = hash2(i);
    float b = hash2(i + vec2(1.0, 0.0));
    float c = hash2(i + vec2(0.0, 1.0));
    float d = hash2(i + vec2(1.0, 1.0));

    return mix(mix(a, b, f.x), mix(c, d, f.x), f.y);
}

// FBM (Fractional Brownian Motion)
float fbm2D(vec2 p, int octaves) {
    float value = 0.0;
    float amplitude = 0.5;
    float frequency = 1.0;

    for (int i = 0; i < 8; i++) {
        if (i >= octaves) break;
        value += amplitude * noise2D(p * frequency);
        frequency *= 2.0;
        amplitude *= 0.5;
    }

    return value;
}
`,As=`
${Xe}

uniform vec3 uColor1;
uniform vec3 uColor2;
uniform float uAngle;

void main() {
    vec2 uv = vUv;

    // Calculate gradient direction from angle
    vec2 dir = vec2(cos(uAngle), sin(uAngle));

    // Project UV onto gradient direction
    // Center at 0.5 so gradient goes through middle
    float t = dot(uv - 0.5, dir) + 0.5;
    t = clamp(t, 0.0, 1.0);

    // Interpolate colors
    vec3 color = mix(uColor1, uColor2, t);

    gl_FragColor = vec4(color, 1.0);
}
`,Is=`
${Xe}

uniform vec3 uLineColor;
uniform vec3 uBackgroundColor;
uniform float uGridSize;
uniform float uLineWidth;

void main() {
    vec2 uv = vUv;

    // Scale UV to grid space
    vec2 grid = fract(uv * uGridSize);

    // Calculate distance to nearest grid line
    float lineX = min(grid.x, 1.0 - grid.x);
    float lineY = min(grid.y, 1.0 - grid.y);

    // Smoothstep for anti-aliased lines
    float halfWidth = uLineWidth * 0.5;
    float edgeSmooth = 0.01;

    float lineAlphaX = 1.0 - smoothstep(halfWidth - edgeSmooth, halfWidth + edgeSmooth, lineX);
    float lineAlphaY = 1.0 - smoothstep(halfWidth - edgeSmooth, halfWidth + edgeSmooth, lineY);
    float lineAlpha = max(lineAlphaX, lineAlphaY);

    // Mix colors
    vec3 color = mix(uBackgroundColor, uLineColor, lineAlpha);

    gl_FragColor = vec4(color, 1.0);
}
`,Ls=`
${Xe}

uniform vec3 uColor1;
uniform vec3 uColor2;
uniform float uSize;

void main() {
    vec2 uv = vUv;

    // Calculate which square we're in
    vec2 cell = floor(uv * uSize);

    // Alternating pattern based on cell coordinates
    float checker = mod(cell.x + cell.y, 2.0);

    // Select color
    vec3 color = mix(uColor1, uColor2, checker);

    gl_FragColor = vec4(color, 1.0);
}
`,Os=`
${Xe}

uniform vec3 uColor1;
uniform vec3 uColor2;
uniform float uNoiseScale;
uniform float uAnimSpeed;

void main() {
    vec2 uv = vUv;

    // Animated noise
    float n = fbm2D(uv * uNoiseScale + uTime * uAnimSpeed, 4);

    // Map noise to colors
    vec3 color = mix(uColor1, uColor2, n);

    gl_FragColor = vec4(color, 1.0);
}
`,te={vertex:Ps,gradient:As,grid:Is,checkerboard:Ls,noise:Os},Ii=class Ot extends dt{static _getGLRenderer(t,e){return Ot._glRenderer?(Ot._glRendererSize.width!==t||Ot._glRendererSize.height!==e)&&(Ot._glRenderer.resize(t,e),Ot._glRendererSize={width:t,height:e}):(Ot._glRenderer=new Ai(t,e),Ot._glRendererSize={width:t,height:e}),Ot._glRenderer}constructor(t,e,i={}){super(i),this.planeWidth=t,this.planeHeight=e,this.x=i.x??0,this.y=i.y??0,this.z=i.z??0,this.camera=i.camera??null,this.debug=i.debug??!1,this.doubleSided=i.doubleSided??!0,this.texture=i.texture??null,this.selfRotationX=i.selfRotationX??0,this.selfRotationY=i.selfRotationY??0,this.selfRotationZ=i.selfRotationZ??0,this.useShader=i.useShader??!1,this.shaderType=i.shaderType??"gradient",this.shaderUniforms=i.shaderUniforms??{},this._shaderInitialized=!1,this._generateGeometry()}setCamera(t){return this.camera=t,this}setTexture(t){return this.texture=t,this}setShaderUniforms(t){return Object.assign(this.shaderUniforms,t),this}_generateGeometry(){const t=this.planeWidth/2,e=this.planeHeight/2;this.vertices=[{x:-t,y:-e,z:0,nx:0,ny:0,nz:-1,u:0,v:0},{x:t,y:-e,z:0,nx:0,ny:0,nz:-1,u:1,v:0},{x:t,y:e,z:0,nx:0,ny:0,nz:-1,u:1,v:1},{x:-t,y:e,z:0,nx:0,ny:0,nz:-1,u:0,v:1}],this.faces=[[0,1,2],[0,2,3]]}_getFragmentShader(){switch(this.shaderType){case"gradient":return te.gradient;case"grid":return te.grid;case"checkerboard":return te.checkerboard;case"noise":return te.noise;default:return te.gradient}}_initShader(t,e){const i=Ot._getGLRenderer(t,e);if(!i||!i.isAvailable())return!1;const s=`plane_${this.shaderType}`,n=te.vertex,o=this._getFragmentShader();try{return i.useProgram(s,n,o),this._shaderInitialized=!0,!0}catch(r){return console.warn("Plane3D shader init failed:",r),!1}}_renderWithShader(t,e,i,s,n){const o=Math.max(Math.ceil(Math.max(s,n)),16);if(!this._shaderInitialized&&!this._initShader(o,o))return!1;const r=Ot._getGLRenderer(o,o);if(!r||!r.isAvailable())return!1;const a=`plane_${this.shaderType}`;r.useProgram(a,te.vertex,this._getFragmentShader());const l=performance.now()/1e3;r.setUniforms({uTime:l,uResolution:[o,o]}),r.setUniforms(this.shaderUniforms),r.render();const h=e-s/2,d=i-n/2;return r.compositeOnto(t,h,d,s,n),!0}_applySelfRotation(t,e,i){if(this.selfRotationY!==0){const s=Math.cos(this.selfRotationY),n=Math.sin(this.selfRotationY),o=t*s-i*n,r=t*n+i*s;t=o,i=r}if(this.selfRotationX!==0){const s=Math.cos(this.selfRotationX),n=Math.sin(this.selfRotationX),o=e*s-i*n,r=e*n+i*s;e=o,i=r}if(this.selfRotationZ!==0){const s=Math.cos(this.selfRotationZ),n=Math.sin(this.selfRotationZ),o=t*s-e*n,r=t*n+e*s;t=o,e=r}return{x:t,y:e,z:i}}_calculateLighting(t,e,i){const r=Math.sqrt(.99),a=.5/r,l=.7/r,h=.5/r;let d=t*a+e*l+i*h;return d=Math.max(0,d)*.7+.3,d}_applyLighting(t,e){if(!t||typeof t!="string"||!t.startsWith("#"))return t;const i=t.replace("#",""),s=parseInt(i.substring(0,2),16),n=parseInt(i.substring(2,4),16),o=parseInt(i.substring(4,6),16),r=Math.round(s*e),a=Math.round(n*e),l=Math.round(o*e);return`rgb(${r}, ${a}, ${l})`}draw(){if(super.draw(),!this.camera){this.color&&y.shapes.fillRect(-this.planeWidth/2,-this.planeHeight/2,this.planeWidth,this.planeHeight,this.color);return}const t=this.selfRotationX!==0||this.selfRotationY!==0||this.selfRotationZ!==0,e=this.vertices.map(u=>{let f=u.x,g=u.y,m=u.z,p=u.nx,v=u.ny,_=u.nz;if(t){const O=this._applySelfRotation(f,g,m);f=O.x,g=O.y,m=O.z;const E=this._applySelfRotation(p,v,_);p=E.x,v=E.y,_=E.z}const w=this.camera.project(f+this.x,g+this.y,m+this.z);if(this.camera.rotationZ!==0){const O=Math.cos(this.camera.rotationZ),E=Math.sin(this.camera.rotationZ),L=p,X=v;p=L*O-X*E,v=L*E+X*O}const x=Math.cos(this.camera.rotationY),S=Math.sin(this.camera.rotationY),k=p*x-_*S,C=p*S+_*x,M=Math.cos(this.camera.rotationX),R=Math.sin(this.camera.rotationX),D=v*M-C*R,A=v*R+C*M;return{...w,nx:k,ny:D,nz:A,u:u.u,v:u.v}}),i=(e[0].nz+e[1].nz+e[2].nz+e[3].nz)/4;if(!this.doubleSided&&i>.1||((e[0].z+e[1].z+e[2].z+e[3].z)/4,e.some(u=>u.z<-this.camera.perspective+10)))return;if(this.useShader&&!this.debug){const u=e.map(A=>A.x),f=e.map(A=>A.y),g=Math.min(...u),m=Math.max(...u),p=Math.min(...f),v=Math.max(...f),_=m-g,w=v-p,x=(g+m)/2,S=(p+v)/2,k=y.ctx,C=k.getTransform(),M=C.e,R=C.f;k.save(),k.setTransform(1,0,0,1,0,0);const D=this._renderWithShader(k,M+x,R+S,_,w);if(k.restore(),D)return}const n=y.ctx;let o=(e[0].nx+e[1].nx+e[2].nx+e[3].nx)/4,r=(e[0].ny+e[1].ny+e[2].ny+e[3].ny)/4,a=o,l=r,h=i;this.doubleSided&&i>0&&(a=-o,l=-r,h=-i);const d=this._calculateLighting(a,l,h);for(const u of this.faces){const f=e[u[0]],g=e[u[1]],m=e[u[2]];if(this.debug)n.beginPath(),n.moveTo(f.x,f.y),n.lineTo(g.x,g.y),n.lineTo(m.x,m.y),n.closePath(),this.stroke&&(n.strokeStyle=this.stroke,n.lineWidth=this.lineWidth??1,n.stroke());else if(this.texture)this._renderTexturedTriangle(n,f,g,m);else if(this.color){const p=this._applyLighting(this.color,d);n.beginPath(),n.moveTo(f.x,f.y),n.lineTo(g.x,g.y),n.lineTo(m.x,m.y),n.closePath(),n.fillStyle=p,n.fill()}}}_renderTexturedTriangle(t,e,i,s){if(!this.texture||!this.texture.complete)return;const n=this.texture,o=n.width,r=n.height,a=e.u*o,l=e.v*r,h=i.u*o,d=i.v*r,u=s.u*o,f=s.v*r,g=e.x,m=e.y,p=i.x,v=i.y,_=s.x,w=s.y,x=(h-a)*(f-l)-(u-a)*(d-l);if(Math.abs(x)<1e-4)return;const S=((p-g)*(f-l)-(_-g)*(d-l))/x,k=((_-g)*(h-a)-(p-g)*(u-a))/x,C=g-S*a-k*l,M=((v-m)*(f-l)-(w-m)*(d-l))/x,R=((w-m)*(h-a)-(v-m)*(u-a))/x,D=m-M*a-R*l;t.save(),t.beginPath(),t.moveTo(g,m),t.lineTo(p,v),t.lineTo(_,w),t.closePath(),t.clip(),t.setTransform(S,M,k,R,C,D),t.drawImage(n,0,0),t.restore()}getCenter(){return{x:this.x,y:this.y,z:this.z}}getBounds(){return{x:this.x-this.planeWidth/2,y:this.y-this.planeHeight/2,width:this.planeWidth,height:this.planeHeight}}};P(Ii,"_glRenderer",null);P(Ii,"_glRendererSize",{width:0,height:0});class Jn extends dt{constructor(t,e={}){var i,s,n,o,r,a;super(e),this.size=t,this.x=e.x??0,this.y=e.y??0,this.z=e.z??0,this.camera=e.camera??null,this.debug=e.debug??!1,this.selfRotationX=e.selfRotationX??0,this.selfRotationY=e.selfRotationY??0,this.selfRotationZ=e.selfRotationZ??0,this.faceColors={front:((i=e.faceColors)==null?void 0:i.front)??"#B71234",back:((s=e.faceColors)==null?void 0:s.back)??"#FF5800",top:((n=e.faceColors)==null?void 0:n.top)??"#FFFFFF",bottom:((o=e.faceColors)==null?void 0:o.bottom)??"#FFD500",left:((r=e.faceColors)==null?void 0:r.left)??"#009B48",right:((a=e.faceColors)==null?void 0:a.right)??"#0046AD"},this.stroke=e.stroke??null,this.lineWidth=e.lineWidth??1,this.stickerMode=e.stickerMode??!1,this.stickerMargin=e.stickerMargin??.15,this.stickerBackgroundColor=e.stickerBackgroundColor??"#0A0A0A",this._faceConfigs=this._createFaceConfigs()}_createFaceConfigs(){const t=this.size/2;return{front:{localPos:{x:0,y:0,z:-t},faceRotX:0,faceRotY:0,color:this.faceColors.front},back:{localPos:{x:0,y:0,z:t},faceRotX:0,faceRotY:Math.PI,color:this.faceColors.back},top:{localPos:{x:0,y:-t,z:0},faceRotX:-Math.PI/2,faceRotY:0,color:this.faceColors.top},bottom:{localPos:{x:0,y:t,z:0},faceRotX:Math.PI/2,faceRotY:0,color:this.faceColors.bottom},left:{localPos:{x:-t,y:0,z:0},faceRotX:0,faceRotY:Math.PI/2,color:this.faceColors.left},right:{localPos:{x:t,y:0,z:0},faceRotX:0,faceRotY:-Math.PI/2,color:this.faceColors.right}}}setCamera(t){return this.camera=t,this}setFaceColors(t){Object.assign(this.faceColors,t);for(const[e,i]of Object.entries(this._faceConfigs))t[e]&&(i.color=t[e]);return this}_applySelfRotation(t,e,i){if(this.selfRotationY!==0){const s=Math.cos(this.selfRotationY),n=Math.sin(this.selfRotationY),o=t*s-i*n,r=t*n+i*s;t=o,i=r}if(this.selfRotationX!==0){const s=Math.cos(this.selfRotationX),n=Math.sin(this.selfRotationX),o=e*s-i*n,r=e*n+i*s;e=o,i=r}if(this.selfRotationZ!==0){const s=Math.cos(this.selfRotationZ),n=Math.sin(this.selfRotationZ),o=t*s-e*n,r=t*n+e*s;t=o,e=r}return{x:t,y:e,z:i}}_calculateLighting(t,e,i){const r=Math.sqrt(.99),a=.5/r,l=.7/r,h=.5/r;let d=t*a+e*l+i*h;return d=Math.max(0,d)*.7+.3,d}_applyLighting(t,e){if(!t||typeof t!="string"||!t.startsWith("#"))return t;const i=t.replace("#",""),s=parseInt(i.substring(0,2),16),n=parseInt(i.substring(2,4),16),o=parseInt(i.substring(4,6),16),r=Math.round(s*e),a=Math.round(n*e),l=Math.round(o*e);return`rgb(${r}, ${a}, ${l})`}draw(){if(super.draw(),!this.camera){const s=this.size/2;this.faceColors.front&&y.shapes.fillRect(-s,-s,this.size,this.size,this.faceColors.front);return}const t=y.ctx;this.size/2;const e=this.selfRotationX!==0||this.selfRotationY!==0||this.selfRotationZ!==0,i=[];for(const[s,n]of Object.entries(this._faceConfigs)){let{x:o,y:r,z:a}=n.localPos;if(e){const E=this._applySelfRotation(o,r,a);o=E.x,r=E.y,a=E.z}const l=this.x+o,h=this.y+r,d=this.z+a;let u=0,f=0,g=0;if(s==="front"?(u=0,f=0,g=-1):s==="back"?(u=0,f=0,g=1):s==="top"?(u=0,f=-1,g=0):s==="bottom"?(u=0,f=1,g=0):s==="left"?(u=-1,f=0,g=0):s==="right"&&(u=1,f=0,g=0),e){const E=this._applySelfRotation(u,f,g);u=E.x,f=E.y,g=E.z}let m=u,p=f,v=g;if(this.camera.rotationZ!==0){const E=Math.cos(this.camera.rotationZ),L=Math.sin(this.camera.rotationZ),X=m,H=p;m=X*E-H*L,p=X*L+H*E}const _=Math.cos(this.camera.rotationY),w=Math.sin(this.camera.rotationY),x=m*_-v*w,S=m*w+v*_,k=Math.cos(this.camera.rotationX),C=Math.sin(this.camera.rotationX),M=p*k-S*C,R=p*C+S*k;if(R>.01)continue;const D=this.camera.project(l,h,d);if(D.z<-this.camera.perspective+10)continue;const A=this._calculateLighting(x,M,R),O=this._getFaceVertices(s,n,e);i.push({name:s,config:n,projected:D,vertices:O,depth:D.z,intensity:A,nx:x,ny:M,nz:R})}i.sort((s,n)=>n.depth-s.depth);for(const s of i)this._renderFace(t,s)}_getFaceVertices(t,e,i){const s=this.size/2;let n;switch(t){case"front":n=[{x:-s,y:-s,z:-s},{x:s,y:-s,z:-s},{x:s,y:s,z:-s},{x:-s,y:s,z:-s}];break;case"back":n=[{x:s,y:-s,z:s},{x:-s,y:-s,z:s},{x:-s,y:s,z:s},{x:s,y:s,z:s}];break;case"top":n=[{x:-s,y:-s,z:s},{x:s,y:-s,z:s},{x:s,y:-s,z:-s},{x:-s,y:-s,z:-s}];break;case"bottom":n=[{x:-s,y:s,z:-s},{x:s,y:s,z:-s},{x:s,y:s,z:s},{x:-s,y:s,z:s}];break;case"left":n=[{x:-s,y:-s,z:s},{x:-s,y:-s,z:-s},{x:-s,y:s,z:-s},{x:-s,y:s,z:s}];break;case"right":n=[{x:s,y:-s,z:-s},{x:s,y:-s,z:s},{x:s,y:s,z:s},{x:s,y:s,z:-s}];break}return n.map(o=>{let{x:r,y:a,z:l}=o;if(i){const h=this._applySelfRotation(r,a,l);r=h.x,a=h.y,l=h.z}return r+=this.x,a+=this.y,l+=this.z,this.camera.project(r,a,l)})}_renderFace(t,e){const{vertices:i,config:s,intensity:n}=e,o=this._applyLighting(s.color,n);t.beginPath(),t.moveTo(i[0].x,i[0].y);for(let r=1;r<i.length;r++)t.lineTo(i[r].x,i[r].y);if(t.closePath(),this.debug)t.strokeStyle=this.stroke||"#fff",t.lineWidth=this.lineWidth??1,t.stroke();else if(this.stickerMode){const r=this._applyLighting(this.stickerBackgroundColor,n);t.fillStyle=r,t.fill(),this.stroke&&(t.strokeStyle=this.stroke,t.lineWidth=this.lineWidth??1,t.stroke());const a=this._getInsetVertices(i,this.stickerMargin);t.beginPath(),t.moveTo(a[0].x,a[0].y);for(let l=1;l<a.length;l++)t.lineTo(a[l].x,a[l].y);t.closePath(),t.fillStyle=o,t.fill()}else t.fillStyle=o,t.fill(),this.stroke&&(t.strokeStyle=this.stroke,t.lineWidth=this.lineWidth??1,t.stroke())}_getInsetVertices(t,e){let i=0,s=0;for(const o of t)i+=o.x,s+=o.y;i/=t.length,s/=t.length;const n=1-e*2;return t.map(o=>({x:i+(o.x-i)*n,y:s+(o.y-s)*n}))}getCenter(){return{x:this.x,y:this.y,z:this.z}}getBounds(){const t=this.size/2;return{x:this.x-t,y:this.y-t,width:this.size,height:this.size}}}class Li extends dt{static async fromURL(t,e={}){const s=await(await fetch(t)).text(),r=new DOMParser().parseFromString(s,"image/svg+xml").querySelector("path");if(!r)throw new Error("No path element found in SVG");const a=r.getAttribute("d");if(!a)throw new Error("Path element has no d attribute");return new Li(a,e)}constructor(t,e={}){super(e),this.scale=e.scale||1,this.centerPath=e.centerPath!==void 0?e.centerPath:!0,this.animationProgress=e.animationProgress!==void 0?e.animationProgress:1,this.svgPathData=t,this.pathCommands=this.parseSVGPath(t),this.centerPath?this.pathCommands=this.centerAndScalePath(this.pathCommands,this.scale):this.pathCommands=this.scalePath(this.pathCommands,this.scale),this.prevX=0,this.prevY=0,this.currentPoint={x:0,y:0}}parseSVGPath(t){const e=[];let i=0,s=0,n=0,o=0;const r=/([MLHVCSQTAZmlhvcsqtaz])([^MLHVCSQTAZmlhvcsqtaz]*)/g;let a;for(;(a=r.exec(t))!==null;){const l=a[1],h=a[2].trim(),d=h.length>0?h.split(/[\s,]+/).map(parseFloat).filter(u=>!isNaN(u)):[];switch(l){case"M":for(let u=0;u<d.length;u+=2)i=d[u],s=d[u+1],u===0?(n=i,o=s,e.push(["M",i,s])):e.push(["L",i,s]);break;case"m":for(let u=0;u<d.length;u+=2)i+=d[u],s+=d[u+1],u===0?(n=i,o=s,e.push(["M",i,s])):e.push(["L",i,s]);break;case"L":for(let u=0;u<d.length;u+=2){const f=d[u],g=d[u+1];e.push(["L",f,g]),i=f,s=g}break;case"l":for(let u=0;u<d.length;u+=2)i+=d[u],s+=d[u+1],e.push(["L",i,s]);break;case"H":for(let u=0;u<d.length;u++)i=d[u],e.push(["L",i,s]);break;case"h":for(let u=0;u<d.length;u++)i+=d[u],e.push(["L",i,s]);break;case"V":for(let u=0;u<d.length;u++)s=d[u],e.push(["L",i,s]);break;case"v":for(let u=0;u<d.length;u++)s+=d[u],e.push(["L",i,s]);break;case"C":for(let u=0;u<d.length;u+=6)e.push(["C",d[u],d[u+1],d[u+2],d[u+3],d[u+4],d[u+5]]),i=d[u+4],s=d[u+5];break;case"c":for(let u=0;u<d.length;u+=6)e.push(["C",i+d[u],s+d[u+1],i+d[u+2],s+d[u+3],i+d[u+4],s+d[u+5]]),i+=d[u+4],s+=d[u+5];break;case"S":for(let u=0;u<d.length;u+=4){const f=e[e.length-1];let g=i,m=s;f&&f[0]==="C"&&(g=2*i-f[3],m=2*s-f[4]),e.push(["C",g,m,d[u],d[u+1],d[u+2],d[u+3]]),i=d[u+2],s=d[u+3]}break;case"s":for(let u=0;u<d.length;u+=4){const f=e[e.length-1];let g=i,m=s;f&&f[0]==="C"&&(g=2*i-f[3],m=2*s-f[4]),e.push(["C",g,m,i+d[u],s+d[u+1],i+d[u+2],s+d[u+3]]),i+=d[u+2],s+=d[u+3]}break;case"Q":for(let u=0;u<d.length;u+=4){const f=d[u],g=d[u+1],m=d[u+2],p=d[u+3],v=i+2/3*(f-i),_=s+2/3*(g-s),w=m+2/3*(f-m),x=p+2/3*(g-p);e.push(["C",v,_,w,x,m,p]),i=m,s=p}break;case"q":for(let u=0;u<d.length;u+=4){const f=i+d[u],g=s+d[u+1],m=i+d[u+2],p=s+d[u+3],v=i+2/3*(f-i),_=s+2/3*(g-s),w=m+2/3*(f-m),x=p+2/3*(g-p);e.push(["C",v,_,w,x,m,p]),i=m,s=p}break;case"Z":case"z":e.push(["Z"]),i=n,s=o;break}}return e}centerAndScalePath(t,e){let i=1/0,s=1/0,n=-1/0,o=-1/0;for(const l of t)l[0]==="M"||l[0]==="L"?(i=Math.min(i,l[1]),s=Math.min(s,l[2]),n=Math.max(n,l[1]),o=Math.max(o,l[2])):l[0]==="C"&&(i=Math.min(i,l[1],l[3],l[5]),s=Math.min(s,l[2],l[4],l[6]),n=Math.max(n,l[1],l[3],l[5]),o=Math.max(o,l[2],l[4],l[6]));const r=(i+n)/2,a=(s+o)/2;return this.originalWidth=(n-i)*e,this.originalHeight=(o-s)*e,t.map(l=>l[0]==="M"||l[0]==="L"?[l[0],(l[1]-r)*e,(l[2]-a)*e]:l[0]==="C"?["C",(l[1]-r)*e,(l[2]-a)*e,(l[3]-r)*e,(l[4]-a)*e,(l[5]-r)*e,(l[6]-a)*e]:[...l])}scalePath(t,e){let i=1/0,s=1/0,n=-1/0,o=-1/0;for(const r of t)r[0]==="M"||r[0]==="L"?(i=Math.min(i,r[1]),s=Math.min(s,r[2]),n=Math.max(n,r[1]),o=Math.max(o,r[2])):r[0]==="C"&&(i=Math.min(i,r[1],r[3],r[5]),s=Math.min(s,r[2],r[4],r[6]),n=Math.max(n,r[1],r[3],r[5]),o=Math.max(o,r[2],r[4],r[6]));return this.originalWidth=(n-i)*e,this.originalHeight=(o-s)*e,t.map(r=>r[0]==="M"||r[0]==="L"?[r[0],r[1]*e,r[2]*e]:r[0]==="C"?["C",r[1]*e,r[2]*e,r[3]*e,r[4]*e,r[5]*e,r[6]*e]:[...r])}getPointOnSegment(t,e){if(t[0]==="M")return{x:t[1],y:t[2]};if(t[0]==="L"){const i=this.prevX+(t[1]-this.prevX)*e,s=this.prevY+(t[2]-this.prevY)*e;return{x:i,y:s}}else if(t[0]==="C"){const i=this.prevX,s=this.prevY,n=t[1],o=t[2],r=t[3],a=t[4],l=t[5],h=t[6],d=Math.pow(1-e,3)*i+3*Math.pow(1-e,2)*e*n+3*(1-e)*Math.pow(e,2)*r+Math.pow(e,3)*l,u=Math.pow(1-e,3)*s+3*Math.pow(1-e,2)*e*o+3*(1-e)*Math.pow(e,2)*a+Math.pow(e,3)*h;return{x:d,y:u}}return{x:0,y:0}}getBezierPoint(t,e){return this.getPointOnSegment(t,e)}getPartialPath(){const t=[];let e=this.pathCommands.length,i=Math.floor(this.animationProgress*e),s=this.animationProgress*e%1,n=!1;this.prevX=0,this.prevY=0;for(let o=0;o<i;o++){const r=this.pathCommands[o];t.push([...r]),r[0]==="M"||r[0]==="L"?(this.prevX=r[1],this.prevY=r[2],n=!0):r[0]==="C"&&(this.prevX=r[5],this.prevY=r[6],n=!0)}if(i<e){const o=this.pathCommands[i];if(o[0]==="M")t.push([...o]),this.prevX=o[1],this.prevY=o[2],this.currentPoint={x:o[1],y:o[2]};else if(o[0]==="L"){n||this.findPreviousPoint(i);const r=this.getPointOnSegment(o,s);t.push(["L",r.x,r.y]),this.currentPoint=r}else if(o[0]==="C"){n||this.findPreviousPoint(i);const r=this.getPointOnSegment(o,s);t.push(["C",o[1],o[2],o[3],o[4],r.x,r.y]),this.currentPoint=r}else o[0]==="Z"&&(s>.5&&t.push(["Z"]),this.currentPoint={x:this.prevX,y:this.prevY})}return t}findPreviousPoint(t){for(let e=t-1;e>=0;e--){const i=this.pathCommands[e];if(i[0]==="M"||i[0]==="L"){this.prevX=i[1],this.prevY=i[2];return}else if(i[0]==="C"){this.prevX=i[5],this.prevY=i[6];return}}this.prevX=0,this.prevY=0}draw(){super.draw();const t=this.getPartialPath();y.lines.path(t,this.color,this.stroke,this.lineWidth)}getCurrentPoint(){return{x:this.currentPoint.x,y:this.currentPoint.y}}setAnimationProgress(t){this.animationProgress=Math.max(0,Math.min(1,t))}calculateBounds(){return{x:this.x,y:this.y,width:this.originalWidth||100,height:this.originalHeight||100}}}class tr extends dt{constructor(t=1,e={}){super(e),this.scale=t,this.stroke=e.stroke||"#000",this.headColor=e.headColor||this.stroke,this.jointColor=e.jointColor||this.stroke,this.lineWidth=e.lineWidth||2,this.showJoints=e.showJoints!==!1}draw(){super.draw();const t=this.scale,e=10*t,i=-30*t,n=i+e,o=n+40*t,r=n+10*t,a=15*t,l=10*t,h=o+40*t,d=3*t;y.shapes.fillCircle(0,i,e,this.headColor),y.shapes.strokeCircle(0,i,e,this.stroke,this.lineWidth),y.lines.line(0,n,0,o,this.stroke,this.lineWidth),y.lines.line(-a,r,a,r,this.stroke,this.lineWidth),y.lines.line(0,o,-l,h,this.stroke,this.lineWidth),y.lines.line(0,o,l,h,this.stroke,this.lineWidth),this.showJoints&&[[0,n],[-a,r],[a,r],[0,o],[-l,h],[l,h]].forEach(([f,g])=>y.shapes.fillCircle(f,g,d,this.jointColor))}getBounds(){const t=100*this.scale,e=40*this.scale;return{x:this.x,y:this.y,width:e,height:t}}}class er extends dt{constructor(t,e,i={}){super(i),this.outerRadius=t,this.innerRadius=e}draw(){super.draw(),y.lines.beginPath(),y.shapes.arc(0,0,this.outerRadius,0,Math.PI*2),y.shapes.arc(0,0,this.innerRadius,0,Math.PI*2,!0),y.lines.closePath(),this.color&&y.colors.fill(this.color),this.stroke&&y.colors.stroke(this.stroke,this.lineWidth)}}class ir extends dt{constructor(t,e,i,s={}){super(s),this.radius=t,this.startAngle=e,this.endAngle=i}draw(){super.draw(),y.lines.beginPath(),y.lines.moveTo(0,0),y.shapes.arc(0,0,this.radius,this.startAngle,this.endAngle),y.lines.closePath(),this.color&&y.colors.fill(this.color),this.stroke&&y.colors.stroke(this.stroke,this.lineWidth)}}class Oi extends dt{constructor(t,e={}){super(e),this._text=t,this._font=e.font||"12px monospace",this._color=e.color||"yellow",this._align=e.align||"center",this._baseline=e.baseline||"middle",this._calculateBounds(),this._calculateAlignmentOffsets()}draw(){super.draw(),this.logger.log("draw",this.font,this.color,this.opacity),y.text.setFont(this.font),y.text.setTextAlign(this.align),y.text.setTextBaseline(this.baseline),y.text.fillText(this.text,-this._centerOffsetX,-this._centerOffsetY,this.color)}_calculateAlignmentOffsets(){if(!y.text)return;const t=y.text.measureTextDimensions(this.text,this.font);switch(this._align){case"left":this._centerOffsetX=t.width/2;break;case"center":this._centerOffsetX=0;break;case"right":this._centerOffsetX=-t.width/2;break}switch(this._baseline){case"top":this._centerOffsetY=t.height/2;break;case"middle":this._centerOffsetY=0;break;case"bottom":this._centerOffsetY=-t.height/2;break}}getTextBounds(){if(y.text){const t=y.text.measureTextDimensions(this.text,this.font),e=2;return{x:this._centerOffsetX-t.width/2,y:this._centerOffsetY-t.height/2,width:t.width+e*2,height:t.height+e*2}}return{x:this._centerOffsetX,y:this._centerOffsetY,width:this._width,height:this._height}}_calculateBounds(){if(y.text){const t=y.text.measureTextDimensions(this.text,this.font);this._width=t.width,this._height=t.height,this._calculateAlignmentOffsets()}else this._width=this.text?this.text.length*8:0,this._height=16;this.trace("TextShape.calculateBounds: "+this._width+"x"+this._height)}getDebugBounds(){const t=this.getTextBounds();return{x:t.x,y:t.y,width:t.width,height:t.height}}checkDirty(t,e){t!==e&&(this._boundsDirty=!0,this._calculateBounds())}get text(){return this._text}set text(t){this.checkDirty(t,this._text),this._text=t}get font(){return this._font}set font(t){this.checkDirty(t,this._font),this._font=t}get color(){return this._color}set color(t){this._color=t}get align(){return this._align}set align(t){this.checkDirty(t,this._align),this._align=t}get baseline(){return this._baseline}set baseline(t){this.checkDirty(t,this._baseline),this._baseline=t}}class Ue extends dt{constructor(t,e={}){if(!t&&!e.width&&!e.height)throw new Error("ImageShape must be initialized with either a bitmap or width and height");super(e),this._bitmap=t??y.img.createImageData(e.width,e.height),this._width=e.width??(t==null?void 0:t.width)??0,this._height=e.height??(t==null?void 0:t.height)??0,this.anchor=e.anchor??"center",this._anchorX=.5,this._anchorY=.5,this._updateAnchorOffsets(),this.smoothing=e.smoothing!==!1,t instanceof ImageData&&this.buffer(t)}_updateAnchorOffsets(){var t;const e=((t=this.anchor)==null?void 0:t.toLowerCase())??"center";e.includes("left")?this._anchorX=0:e.includes("right")?this._anchorX=1:this._anchorX=.5,e.includes("top")?this._anchorY=0:e.includes("bottom")?this._anchorY=1:this._anchorY=.5}get bitmap(){return this._bitmap}set bitmap(t){t&&(this._bitmap=t,!this._width&&t.width&&(this._width=t.width),!this._height&&t.height&&(this._height=t.height),t instanceof ImageData&&this.buffer(t))}buffer(t){if(!t)return;this._buffer||(this._buffer=document.createElement("canvas")),(this._buffer.width!==t.width||this._buffer.height!==t.height)&&(this._buffer.width=t.width,this._buffer.height=t.height),this._buffer.getContext("2d").putImageData(t,0,0)}reset(){this._buffer=null,this._bitmap=y.img.createImageData(this.width,this.height)}setAnchor(t){this.anchor=t,this._updateAnchorOffsets()}draw(){if(!this.visible||!this._bitmap&&!this._buffer)return;super.draw();let t=this._bitmap instanceof ImageData?this._buffer:this._bitmap;(!t||this._bitmap instanceof ImageData&&!this._buffer)&&(this._bitmap instanceof ImageData&&(this.buffer(this._bitmap),t=this._buffer),!t)||y.img.draw(t,0,0,{width:this.width,height:this.height,anchor:this.anchor,rotation:this.rotation,scaleX:this.scaleX,scaleY:this.scaleY,alpha:this.opacity,smoothing:this.smoothing,flipX:this.scaleX<0,flipY:this.scaleY<0})}calculateBounds(){return{x:-this._anchorX*this.width,y:-this._anchorY*this.height,width:this.width,height:this.height}}}class zi{constructor(){this.listeners={}}on(t,e){this.listeners[t]||(this.listeners[t]=[]),this.listeners[t].push(e)}off(t,e){this.listeners[t]&&(this.listeners[t]=this.listeners[t].filter(i=>i!==e))}emit(t,e){this.listeners[t]&&this.listeners[t].forEach(i=>i(e))}}class V{static init(t){V.game=t,V.x=0,V.y=0,V.down=!1,t.events.on("mousedown",e=>V._onDown(e,t)),t.events.on("mouseup",e=>V._onUp(e,t)),t.events.on("mousemove",e=>V._onMove(e,t)),t.events.on("touchstart",e=>V._onTouchStart(e,t)),t.events.on("touchend",e=>V._onTouchEnd(e,t)),t.events.on("touchmove",e=>V._onTouchMove(e,t))}static _scaleToCanvas(t,e,i){const s=t.canvas,n=s.getBoundingClientRect(),o=s.width/n.width,r=s.height/n.height;return{x:e*o,y:i*r}}static _setPosition(t,e){V.x=t,V.y=e}static _onDown(t,e){V.down=!0;const i=V._scaleToCanvas(e,t.offsetX,t.offsetY);V._setPosition(i.x,i.y),Object.defineProperty(t,"x",{value:i.x,configurable:!0}),Object.defineProperty(t,"y",{value:i.y,configurable:!0}),e.events.emit("inputdown",t)}static _onUp(t,e){V.down=!1;const i=V._scaleToCanvas(e,t.offsetX,t.offsetY);V._setPosition(i.x,i.y),Object.defineProperty(t,"x",{value:i.x,configurable:!0}),Object.defineProperty(t,"y",{value:i.y,configurable:!0}),e.events.emit("inputup",t)}static _onMove(t,e){const i=V._scaleToCanvas(e,t.offsetX,t.offsetY);V._setPosition(i.x,i.y),Object.defineProperty(t,"x",{value:i.x,configurable:!0}),Object.defineProperty(t,"y",{value:i.y,configurable:!0}),e.events.emit("inputmove",t)}static _onTouchStart(t,e){const i=t.touches[0],s=e.canvas.getBoundingClientRect();V.down=!0;const n=i.clientX-s.left,o=i.clientY-s.top,r=V._scaleToCanvas(e,n,o);V._setPosition(r.x,r.y),Object.defineProperty(t,"x",{value:r.x,configurable:!0}),Object.defineProperty(t,"y",{value:r.y,configurable:!0}),e.events.emit("inputdown",t)}static _onTouchEnd(t,e){V.down=!1,e.events.emit("inputup",t)}static _onTouchMove(t,e){const i=t.touches[0],s=e.canvas.getBoundingClientRect(),n=i.clientX-s.left,o=i.clientY-s.top,r=V._scaleToCanvas(e,n,o);V._setPosition(r.x,r.y),Object.defineProperty(t,"x",{value:r.x,configurable:!0}),Object.defineProperty(t,"y",{value:r.y,configurable:!0}),e.events.emit("inputmove",t)}}const K=class ot{static init(t){ot._gameMap.set(t.canvas,t),ot.game=t,ot.canvas=t.canvas,ot.x=0,ot.y=0,ot.leftDown=!1,ot.middleDown=!1,ot.rightDown=!1,t.canvas.addEventListener("mousemove",ot._onMove),t.canvas.addEventListener("mousedown",ot._onDown),t.canvas.addEventListener("mouseup",ot._onUp),t.canvas.addEventListener("click",ot._onClick),t.canvas.addEventListener("wheel",ot._onWheel)}static _getGameForEvent(t){const e=t.currentTarget;return ot._gameMap.get(e)||ot.game}static _updatePosition(t,e){const i=e.canvas,s=i.getBoundingClientRect(),n=t.clientX-s.left,o=t.clientY-s.top,r=i.width/s.width,a=i.height/s.height;ot.x=n*r,ot.y=o*a}};P(K,"_gameMap",new Map);P(K,"_onMove",c=>{const t=K._getGameForEvent(c);K._updatePosition(c,t),t.events.emit("mousemove",c)});P(K,"_onDown",c=>{const t=K._getGameForEvent(c);K._updatePosition(c,t),c.button===0&&(K.leftDown=!0),c.button===1&&(K.middleDown=!0),c.button===2&&(K.rightDown=!0),t.events.emit("mousedown",c)});P(K,"_onUp",c=>{const t=K._getGameForEvent(c);K._updatePosition(c,t),c.button===0&&(K.leftDown=!1),c.button===1&&(K.middleDown=!1),c.button===2&&(K.rightDown=!1),t.events.emit("mouseup",c)});P(K,"_onClick",c=>{const t=K._getGameForEvent(c);K._updatePosition(c,t),c.canvasX=K.x,c.canvasY=K.y,Object.defineProperty(c,"x",{value:K.x,writable:!1}),Object.defineProperty(c,"y",{value:K.y,writable:!1}),t.events.emit("click",c)});P(K,"_onWheel",c=>{const t=K._getGameForEvent(c);K._updatePosition(c,t),t.events.emit("wheel",c)});let zs=K;const B=class ft{static init(t){ft.game=t,window.addEventListener("keydown",ft._onKeyDown),window.addEventListener("keyup",ft._onKeyUp)}static isDown(t){return ft._down.has(t)}static _onKeyDown(t){const e=ft._codeMap[t.code];e&&(ft._down.has(e)||(ft._down.add(e),ft.game.events.emit(e,t))),ft.game.events.emit(t.type,t)}static _onKeyUp(t){const e=ft._codeMap[t.code];e&&ft._down.has(e)&&(ft._down.delete(e),ft.game.events.emit(e+"_up",t)),ft.game.events.emit(t.type,t)}};P(B,"W","W");P(B,"A","A");P(B,"S","S");P(B,"D","D");P(B,"Q","Q");P(B,"E","E");P(B,"R","R");P(B,"F","F");P(B,"G","G");P(B,"J","J");P(B,"K","K");P(B,"L","L");P(B,"Z","Z");P(B,"C","C");P(B,"UP","UP");P(B,"DOWN","DOWN");P(B,"LEFT","LEFT");P(B,"RIGHT","RIGHT");P(B,"SPACE","SPACE");P(B,"SHIFT","SHIFT");P(B,"ENTER","ENTER");P(B,"ESC","ESC");P(B,"_codeMap",{KeyW:B.W,KeyA:B.A,KeyS:B.S,KeyD:B.D,KeyQ:B.Q,KeyE:B.E,KeyR:B.R,KeyF:B.F,KeyG:B.G,KeyJ:B.J,KeyK:B.K,KeyL:B.L,KeyZ:B.Z,KeyC:B.C,ArrowUp:B.UP,ArrowDown:B.DOWN,ArrowLeft:B.LEFT,ArrowRight:B.RIGHT,Space:B.SPACE,ShiftLeft:B.SHIFT,ShiftRight:B.SHIFT,Enter:B.ENTER,NumpadEnter:B.ENTER,Escape:B.ESC});P(B,"_down",new Set);P(B,"game",null);let Bs=B;const Ct=class pt{static init(t){pt._gameMap.set(t.canvas,t),pt.game=t,pt.canvas=t.canvas,pt.x=0,pt.y=0,pt.active=!1,t.canvas.addEventListener("touchstart",pt._onStart),t.canvas.addEventListener("touchend",pt._onEnd),t.canvas.addEventListener("touchmove",pt._onMove)}static _getGameForEvent(t){const e=t.currentTarget;return pt._gameMap.get(e)||pt.game}static _updatePosition(t,e){const i=e.canvas,s=i.getBoundingClientRect(),n=t.clientX-s.left,o=t.clientY-s.top,r=i.width/s.width,a=i.height/s.height;pt.x=n*r,pt.y=o*a}};P(Ct,"_gameMap",new Map);P(Ct,"_onStart",c=>{if(c.touches.length>0){const t=Ct._getGameForEvent(c);Ct.active=!0,Ct._updatePosition(c.touches[0],t),t.events.emit("touchstart",c)}});P(Ct,"_onEnd",c=>{const t=Ct._getGameForEvent(c);Ct.active=!1,t.events.emit("touchend",c)});P(Ct,"_onMove",c=>{if(c.touches.length>0){const t=Ct._getGameForEvent(c);Ct._updatePosition(c.touches[0],t),t.events.emit("touchmove",c)}});let Ys=Ct;const Y=class I{static init(t){if(I.game=t,I._detect(),!I._initialized){if(I._initialized=!0,window.addEventListener("resize",I._onResize),window.addEventListener("orientationchange",I._onOrientationChange),window.matchMedia){const e=window.matchMedia(`(max-width: ${I.MOBILE_BREAKPOINT}px)`),i=window.matchMedia(`(max-width: ${I.TABLET_BREAKPOINT}px)`);e.addEventListener&&(e.addEventListener("change",I._onMediaChange),i.addEventListener("change",I._onMediaChange))}document.addEventListener("visibilitychange",I._onVisibilityChange)}}static _detect(){I.width=window.innerWidth,I.height=window.innerHeight,I.pixelRatio=window.devicePixelRatio||1,I.isMobile=I.width<=I.MOBILE_BREAKPOINT,I.isTablet=I.width>I.MOBILE_BREAKPOINT&&I.width<=I.TABLET_BREAKPOINT,I.isDesktop=I.width>I.TABLET_BREAKPOINT,I.hasTouch="ontouchstart"in window||navigator.maxTouchPoints>0||navigator.msMaxTouchPoints>0,I.isPortrait=I.height>I.width,I.isLandscape=!I.isPortrait,I.orientation=I.isPortrait?"portrait":"landscape"}static responsive(t,e,i){return I.width===0&&typeof window<"u"&&I._detect(),e===void 0&&(e=t),i===void 0&&(i=e),I.isMobile?t:I.isTablet?e:i}static scaled(t){return t*I.pixelRatio}static isTouchPrimary(){return I.hasTouch&&(I.isMobile||I.isTablet)}static minDimension(){return Math.min(I.width,I.height)}static maxDimension(){return Math.max(I.width,I.height)}static aspectRatio(){return I.width/I.height}static matches(t){return window.matchMedia?window.matchMedia(t).matches:!1}static prefersReducedMotion(){return I.matches("(prefers-reduced-motion: reduce)")}static prefersDarkMode(){return I.matches("(prefers-color-scheme: dark)")}static async _acquireWakeLock(){if(!I.wakeLockSupported)return!1;try{return I._wakeLock=await navigator.wakeLock.request("screen"),I._wakeLock.addEventListener("release",()=>{I.game&&I.game.events.emit("wakelockrelease")}),I.game&&I.game.events.emit("wakelockacquire"),!0}catch(t){return console.warn("[Screen] Wake lock request failed:",t.message),!1}}static async requestWakeLock(){return I.wakeLockSupported?(I.wakeLockEnabled=!0,await I._acquireWakeLock()):(console.warn("[Screen] Wake Lock API not supported in this browser"),!1)}static async releaseWakeLock(){if(I.wakeLockEnabled=!1,I._wakeLock)try{await I._wakeLock.release(),I._wakeLock=null}catch(t){console.warn("[Screen] Wake lock release failed:",t.message)}}static isWakeLockActive(){return I._wakeLock!==null&&!I._wakeLock.released}};P(Y,"MOBILE_BREAKPOINT",768);P(Y,"TABLET_BREAKPOINT",1024);P(Y,"game",null);P(Y,"_initialized",!1);P(Y,"width",0);P(Y,"height",0);P(Y,"pixelRatio",1);P(Y,"isMobile",!1);P(Y,"isTablet",!1);P(Y,"isDesktop",!1);P(Y,"hasTouch",!1);P(Y,"orientation","landscape");P(Y,"isPortrait",!1);P(Y,"isLandscape",!0);P(Y,"_wakeLock",null);P(Y,"wakeLockEnabled",!1);P(Y,"wakeLockSupported",!1);typeof window<"u"&&(Y._detect(),Y.wakeLockSupported="wakeLock"in navigator);P(Y,"_onResize",()=>{const c=Y.isMobile,t=Y.isTablet,e=Y.orientation;Y._detect(),Y.game&&(Y.game.events.emit("screenresize",{width:Y.width,height:Y.height,isMobile:Y.isMobile,isTablet:Y.isTablet,isDesktop:Y.isDesktop}),(c!==Y.isMobile||t!==Y.isTablet)&&Y.game.events.emit("devicechange",{isMobile:Y.isMobile,isTablet:Y.isTablet,isDesktop:Y.isDesktop,previous:{isMobile:c,isTablet:t,isDesktop:!c&&!t}}),e!==Y.orientation&&Y.game.events.emit("orientationchange",{orientation:Y.orientation,isPortrait:Y.isPortrait,isLandscape:Y.isLandscape}))});P(Y,"_onOrientationChange",()=>{setTimeout(()=>{Y._onResize()},100)});P(Y,"_onMediaChange",()=>{Y._onResize()});P(Y,"_onVisibilityChange",async()=>{Y.wakeLockEnabled&&document.visibilityState==="visible"&&await Y._acquireWakeLock()});let jt=Y;class sr{constructor(t,e={}){this.canvas=t,this.onZoom=e.onZoom||null,this.onPan=e.onPan||null,this.onTap=e.onTap||null,this.onDragStart=e.onDragStart||null,this.onDragEnd=e.onDragEnd||null,this.wheelZoomFactor=e.wheelZoomFactor??.1,this.pinchZoomFactor=e.pinchZoomFactor??1,this.panScale=e.panScale??1,this.tapThreshold=e.tapThreshold??10,this.tapTimeout=e.tapTimeout??300,this.preventDefault=e.preventDefault??!0,this._isDragging=!1,this._hasMoved=!1,this._startTime=0,this._startX=0,this._startY=0,this._lastX=0,this._lastY=0,this._touches=new Map,this._lastPinchDist=0,this._lastPinchCenterX=0,this._lastPinchCenterY=0,this._onMouseDown=this._onMouseDown.bind(this),this._onMouseMove=this._onMouseMove.bind(this),this._onMouseUp=this._onMouseUp.bind(this),this._onMouseLeave=this._onMouseLeave.bind(this),this._onWheel=this._onWheel.bind(this),this._onTouchStart=this._onTouchStart.bind(this),this._onTouchMove=this._onTouchMove.bind(this),this._onTouchEnd=this._onTouchEnd.bind(this),this._onTouchCancel=this._onTouchCancel.bind(this),this._attachListeners()}get isDragging(){return this._isDragging}_attachListeners(){const t=this.canvas,e=!this.preventDefault;t.addEventListener("mousedown",this._onMouseDown),t.addEventListener("mousemove",this._onMouseMove),t.addEventListener("mouseup",this._onMouseUp),t.addEventListener("mouseleave",this._onMouseLeave),t.addEventListener("wheel",this._onWheel,{passive:e}),t.addEventListener("touchstart",this._onTouchStart,{passive:e}),t.addEventListener("touchmove",this._onTouchMove,{passive:e}),t.addEventListener("touchend",this._onTouchEnd,{passive:e}),t.addEventListener("touchcancel",this._onTouchCancel)}destroy(){const t=this.canvas;t.removeEventListener("mousedown",this._onMouseDown),t.removeEventListener("mousemove",this._onMouseMove),t.removeEventListener("mouseup",this._onMouseUp),t.removeEventListener("mouseleave",this._onMouseLeave),t.removeEventListener("wheel",this._onWheel),t.removeEventListener("touchstart",this._onTouchStart),t.removeEventListener("touchmove",this._onTouchMove),t.removeEventListener("touchend",this._onTouchEnd),t.removeEventListener("touchcancel",this._onTouchCancel),this._touches.clear()}_getMousePos(t){const e=this.canvas.getBoundingClientRect();return{x:t.clientX-e.left,y:t.clientY-e.top}}_getTouchPos(t){const e=this.canvas.getBoundingClientRect();return{x:t.clientX-e.left,y:t.clientY-e.top}}_onMouseDown(t){const e=this._getMousePos(t);this._isDragging=!0,this._hasMoved=!1,this._startTime=Date.now(),this._startX=e.x,this._startY=e.y,this._lastX=e.x,this._lastY=e.y,this.onDragStart&&this.onDragStart(e.x,e.y)}_onMouseMove(t){if(!this._isDragging)return;const e=this._getMousePos(t),i=e.x-this._lastX,s=e.y-this._lastY,n=Math.abs(e.x-this._startX),o=Math.abs(e.y-this._startY);(n>this.tapThreshold||o>this.tapThreshold)&&(this._hasMoved=!0),this.onPan&&this._hasMoved&&this.onPan(i*this.panScale,s*this.panScale),this._lastX=e.x,this._lastY=e.y}_onMouseUp(t){if(!this._isDragging)return;const i=Date.now()-this._startTime;if(!this._hasMoved&&i<this.tapTimeout&&this.onTap){const s=this._getMousePos(t);this.onTap(s.x,s.y)}this._isDragging=!1,this.onDragEnd&&this.onDragEnd()}_onMouseLeave(){this._isDragging&&(this._isDragging=!1,this.onDragEnd&&this.onDragEnd())}_onWheel(t){if(this.preventDefault&&t.preventDefault(),this.onZoom){const e=this._getMousePos(t),i=t.deltaY>0?-this.wheelZoomFactor:this.wheelZoomFactor;this.onZoom(i,e.x,e.y)}}_onTouchStart(t){this.preventDefault&&t.preventDefault(),this._startTime=Date.now(),this._hasMoved=!1;for(const e of t.changedTouches){const i=this._getTouchPos(e);this._touches.set(e.identifier,{x:i.x,y:i.y})}if(this._touches.size===2){const[e,i]=Array.from(this._touches.values());this._lastPinchDist=Math.hypot(i.x-e.x,i.y-e.y),this._lastPinchCenterX=(e.x+i.x)/2,this._lastPinchCenterY=(e.y+i.y)/2,this._isDragging=!1}if(this._touches.size===1){const e=t.touches[0],i=this._getTouchPos(e);this._isDragging=!0,this._startX=i.x,this._startY=i.y,this._lastX=i.x,this._lastY=i.y,this.onDragStart&&this.onDragStart(i.x,i.y)}}_onTouchMove(t){this.preventDefault&&t.preventDefault();for(const e of t.changedTouches)if(this._touches.has(e.identifier)){const i=this._getTouchPos(e);this._touches.set(e.identifier,{x:i.x,y:i.y})}if(this._touches.size===2){const[e,i]=Array.from(this._touches.values()),s=Math.hypot(i.x-e.x,i.y-e.y),n=(e.x+i.x)/2,o=(e.y+i.y)/2;if(this._lastPinchDist>0){if(this.onZoom){const a=(s/this._lastPinchDist-1)*this.pinchZoomFactor;this.onZoom(a,n,o)}if(this.onPan){const r=n-this._lastPinchCenterX,a=o-this._lastPinchCenterY;this.onPan(r*this.panScale,a*this.panScale)}this._hasMoved=!0}this._lastPinchDist=s,this._lastPinchCenterX=n,this._lastPinchCenterY=o}else if(this._touches.size===1&&this._isDragging){const e=t.touches[0],i=this._getTouchPos(e),s=i.x-this._lastX,n=i.y-this._lastY,o=Math.abs(i.x-this._startX),r=Math.abs(i.y-this._startY);(o>this.tapThreshold||r>this.tapThreshold)&&(this._hasMoved=!0),this.onPan&&this._hasMoved&&this.onPan(s*this.panScale,n*this.panScale),this._lastX=i.x,this._lastY=i.y}}_onTouchEnd(t){this.preventDefault&&t.preventDefault();for(const e of t.changedTouches)this._touches.delete(e.identifier);if(this._touches.size<2&&(this._lastPinchDist=0),this._touches.size===0){const i=Date.now()-this._startTime;!this._hasMoved&&i<this.tapTimeout&&this.onTap&&this.onTap(this._startX,this._startY),this._isDragging=!1,this.onDragEnd&&this.onDragEnd()}}_onTouchCancel(){this._touches.clear(),this._lastPinchDist=0,this._isDragging=!1,this.onDragEnd&&this.onDragEnd()}}function Xs(c,t={}){var e;if(!c||!(c instanceof ue))return console.warn("applyAnchor can only be applied to GameObject instances"),c;c._anchor={position:t.anchor??null,margin:t.anchorMargin??10,offsetX:t.anchorOffsetX??0,offsetY:t.anchorOffsetY??0,relative:t.anchorRelative??!1,setTextAlign:t.anchorSetTextAlign!==!1,lastUpdate:0};const i=(e=c.update)==null?void 0:e.bind(c);c.update=function(n){const o=c._anchor.relative===!0&&c.parent?c.parent:c._anchor.relative;if(c._anchor.position&&(c.boundsDirty||o&&o.boundsDirty||c.parent&&c.parent.boundsDirty)){let r;if(o){const h={x:o.x,y:o.y,width:o.width,height:o.height};r=fi.calculate(c._anchor.position,c,h,c._anchor.margin,c._anchor.offsetX,c._anchor.offsetY)}else r=fi.calculateAbsolute(c._anchor.position,c,c.game,c._anchor.margin,c._anchor.offsetX,c._anchor.offsetY);let a,l;c.parent&&!s(c)?o===c.parent?(a=r.x-o.x,l=r.y-o.y):(a=r.x-c.parent.x,l=r.y-c.parent.y):(a=r.x,l=r.y),c.transform&&typeof c.transform.position=="function"?c.transform.position(a,l):(c.x=a,c.y=l),c._anchor.setTextAlign&&("align"in c&&(c.align=r.align),"baseline"in c&&(c.baseline=r.baseline)),c._anchor.lastUpdate=c.game?c.game.lastTime:Date.now()}i&&i(n)};function s(n){return n.game&&n.game.pipeline&&n.game.pipeline.gameObjects&&n.game.pipeline.gameObjects.includes(n)}return c}class ue extends Ie{constructor(t,e={}){super(e),this.game=t,this.parent=null,this.events=new zi,this._interactive=e.interactive??!1,this._hovered=!1,e.anchor&&Xs(this,e)}update(t){this.logger.groupCollapsed("GameObject.update: "+(this.name==null?this.constructor.name:this.name)),super.update(t),this.logger.groupEnd()}get interactive(){return this._interactive}set interactive(t){const e=!!t;this._interactive!==e&&(this._interactive=e,e===!0?this._enableEvents():(this._disableEvents(),this._hovered&&(this._hovered=!1,this.events.emit("mouseout"))))}_enableEvents(){this.logger.log(`${this.constructor.name} is now interactive`)}_disableEvents(){this.logger.log(`${this.constructor.name} is no longer interactive`)}get hovered(){return this._hovered}set hovered(t){this._hovered=!!t}_setHovered(t){this._hovered=!!t}_hitTest(t,e){var i;if(!this._interactive)return!1;const s=(i=this.getBounds)==null?void 0:i.call(this);if(!s)return!1;let n=t,o=e;const r=[];let a=this;for(;a;)r.unshift(a),a=a.parent;for(const d of r){if(n-=d.x||0,o-=d.y||0,d.getHitTestOffset){const u=d.getHitTestOffset();n-=u.x||0,o-=u.y||0}if(d.rotation){const u=Math.cos(-d.rotation),f=Math.sin(-d.rotation),g=n;n=g*u-o*f,o=g*f+o*u}d.scaleX!==void 0&&d.scaleX!==0&&(n/=d.scaleX),d.scaleY!==void 0&&d.scaleY!==0&&(o/=d.scaleY)}const l=(s.width||this.width||0)/2,h=(s.height||this.height||0)/2;return n>=-l&&n<=l&&o>=-h&&o<=h}on(t,e){this.events.on(t,e)}off(t,e){this.events.off(t,e)}emit(t,...e){this.events.emit(t,...e)}}class nr{static create(t,e,i={}){const s={x:(e==null?void 0:e.x)??0,y:(e==null?void 0:e.y)??0,width:(e==null?void 0:e.width)??0,height:(e==null?void 0:e.height)??0,rotation:(e==null?void 0:e.rotation)??0,scaleX:(e==null?void 0:e.scaleX)??1,scaleY:(e==null?void 0:e.scaleY)??1,opacity:(e==null?void 0:e.opacity)??1,visible:(e==null?void 0:e.visible)??!0,active:!0,debug:(e==null?void 0:e.debug)??!1,color:(e==null?void 0:e.color)??null,stroke:(e==null?void 0:e.stroke)??null,lineWidth:(e==null?void 0:e.lineWidth)??1,lineJoin:(e==null?void 0:e.lineJoin)??"miter",lineCap:(e==null?void 0:e.lineCap)??"butt",miterLimit:(e==null?void 0:e.miterLimit)??10,...i,name:i.name??(e==null?void 0:e.constructor.name)??"ShapeWrapper"};return new ri(t,e,s)}}class ri extends ue{constructor(t,e,i={}){const{anchor:s,...n}=i;if(super(t,n),!e||e==null||e==null)throw new Error("GameObjectShapeWrapper requires a shape");this.shape=e,i.color!==void 0&&(e.color=i.color),i.stroke!==void 0&&(e.stroke=i.stroke),i.lineWidth!==void 0&&(e.lineWidth=i.lineWidth),i.lineJoin!==void 0&&(e.lineJoin=i.lineJoin),i.lineCap!==void 0&&(e.lineCap=i.lineCap),i.miterLimit!==void 0&&(e.miterLimit=i.miterLimit),this.syncPropertiesToShape(),this.logger.log(`Created GameObject(${this.constructor.name}):`,{x:this.x,y:this.y,width:this.width,height:this.height,color:this.color,stroke:this.stroke})}syncPropertiesToShape(){if(!this.shape)return;const t=["width","height","rotation","scaleX","scaleY","visible","debug","debugColor"];for(const e of t)e in this&&e in this.shape&&this[e]!==this.shape[e]&&(this.shape[e]=this[e])}get color(){return this.shape?this.shape.color:null}set color(t){this.shape&&(this.shape.color=t)}get stroke(){return this.shape?this.shape.stroke:null}set stroke(t){this.shape&&(this.shape.stroke=t)}get lineWidth(){return this.shape?this.shape.lineWidth:1}set lineWidth(t){this.shape&&(this.shape.lineWidth=t)}get lineJoin(){return this.shape?this.shape.lineJoin:"miter"}set lineJoin(t){this.shape&&(this.shape.lineJoin=t)}get lineCap(){return this.shape?this.shape.lineCap:"butt"}set lineCap(t){this.shape&&(this.shape.lineCap=t)}get miterLimit(){return this.shape?this.shape.miterLimit:10}set miterLimit(t){this.shape&&(this.shape.miterLimit=t)}update(t){var e;this.active&&((e=this.onUpdate)==null||e.call(this,t),(this._boundsDirty||this.tweening)&&(this.syncPropertiesToShape(),this._boundsDirty=!1),super.update(t))}draw(){super.draw(),this.shape.draw()}}class Zt extends ue{constructor(t,e={}){super(t,e),this._collection=new ti({sortByZIndex:e.sortByZIndex||!0}),this._collection._owner=this,this._width=e.width??0,this._height=e.height??0,this.forceWidth=null,this.forceHeight=null,this._naturalWidth=null,this._naturalHeight=null,this.userDefinedDimensions=!1,e.width!=null&&e.height!=null&&(this.userDefinedWidth=e.width,this.userDefinedHeight=e.height,this.userDefinedDimensions=!0)}update(t){this.logger.groupCollapsed("Scene.update: "+(this.name==null?this.constructor.name:this.name));for(let e=0;e<this.children.length;e++){const i=this.children[e];i.active&&i.update&&i.update(t)}super.update(t),this.logger.groupEnd()}add(t){if(t==null||t==null)throw new Error("GameObject is null or undefined");return t.parent!=null&&console.warn("This GameObject already has a parent. Consider removing it first."),t.parent=this,this._collection.add(t),this.markBoundsDirty(),t.init&&t.init(),t}markBoundsDirty(){super.markBoundsDirty(),this.children.forEach(t=>{t.markBoundsDirty()})}remove(t){const e=this._collection.remove(t);return e&&(t.parent=null,this.markBoundsDirty()),e}draw(){super.draw(),this.logger.log("Scene.draw chilren:"),this._collection.getSortedChildren().filter(t=>t.visible).map(function(t){return y.save(),t.render(),y.restore(),t})}getDebugBounds(){return{width:this.width,height:this.height,x:-this.width/2,y:-this.height/2}}getBounds(){return{x:this.x,y:this.y,width:this._width||0,height:this._height||0}}bringToFront(t){return this._collection.bringToFront(t)}sendToBack(t){return this._collection.sendToBack(t)}bringForward(t){return this._collection.bringForward(t)}sendBackward(t){return this._collection.sendBackward(t)}clear(){return this._collection.children.forEach(t=>this.remove(t)),this._collection.clear()}get children(){return this._collection.children}getHitTestOffset(){return{x:0,y:0}}isChildHittable(t){return!0}}class rr extends Zt{constructor(t,e={}){if(super(t,e),!e.camera)throw new Error("Scene3D requires a camera option");this.camera=e.camera,this.depthSort=e.depthSort??!0,this.scaleByDepth=e.scaleByDepth??!0}render(){if(!this.visible)return;y.save(),y.translateTo(this.x,this.y);const t=[];for(const e of this._collection.getSortedChildren()){if(!e.visible)continue;const i=e.z??0,s=this.camera.project(e.x,e.y,i);s.z<-this.camera.perspective+10||t.push({child:e,x:s.x,y:s.y,z:s.z,scale:s.scale})}this.depthSort&&t.sort((e,i)=>{const s=e.child.zIndex??0,n=i.child.zIndex??0;return s!==n?s-n:i.z-e.z});for(const e of t)y.save(),y.translateTo(e.x,e.y),this.scaleByDepth&&y.ctx.scale(e.scale,e.scale),y.translateTo(-e.child.x,-e.child.y),e.child.render(),y.restore();y.restore()}}class or extends Zt{constructor(t,e={}){super(t,e),this.tileWidth=e.tileWidth??64,this.tileHeight=e.tileHeight??this.tileWidth/2,this.depthSort=e.depthSort??!0,this.scaleByDepth=e.scaleByDepth??!1,this.gridSize=e.gridSize??10,this.elevationScale=e.elevationScale??1,this.camera=e.camera??null}setCamera(t){return this.camera=t,this}toIsometric(t,e,i=0){let s=t,n=e;if(this.camera){const l=this.camera.angle,h=Math.cos(l),d=Math.sin(l);s=t*h-e*d,n=t*d+e*h}const o=(s-n)*(this.tileWidth/2),r=(s+n)*(this.tileHeight/2)-i*this.elevationScale,a=s+n-i*.01;return{x:o,y:r,depth:a}}fromIsometric(t,e){const i=this.tileWidth/2,s=this.tileHeight/2;let n=(t/i+e/s)/2,o=(e/s-t/i)/2;if(this.camera){const r=-this.camera.angle,a=Math.cos(r),l=Math.sin(r),h=n*a-o*l,d=n*l+o*a;return{x:h,y:d}}return{x:n,y:o}}update(t){super.update(t),this.camera&&this.camera.update(t)}getTileAt(t,e){const i=this.fromIsometric(t,e);return{x:Math.floor(i.x),y:Math.floor(i.y)}}getRotatedDepth(t,e=0){const i=this.camera?this.camera.angle:0,s=Math.cos(i),n=Math.sin(i);let o=-1/0;for(const r of t){const a=r.x*s-r.y*n,l=r.x*n+r.y*s,h=a+l;h>o&&(o=h)}return o+e*.5}getDepthScale(t){const e=Math.abs(t),i=this.gridSize;return .7+e/i*.6}render(){if(!this.visible)return;y.save(),y.translateTo(this.x,this.y);const t=[];for(const e of this._collection.getSortedChildren()){if(!e.visible)continue;let i;if(e.isoDepth!==void 0)i=e.isoDepth;else{let s=e.x,n=e.y;if(this.camera){const r=this.camera.angle,a=Math.cos(r),l=Math.sin(r);s=e.x*a-e.y*l,n=e.x*l+e.y*a}const o=e.z??0;i=s+n+o*.05}t.push({child:e,depth:i})}this.depthSort&&t.sort((e,i)=>{const s=e.child.zIndex??0,n=i.child.zIndex??0;return s!==n?s-n:e.depth-i.depth});for(const e of t)y.save(),e.child.render(),y.restore();y.restore()}}class oi extends Zt{constructor(t,e={}){super(t,e),this.spacing=e.spacing??10,this.padding=e.padding??0,this.autoSize=e.autoSize??!0,this.align=e.align??"start",this.debug=e.debug??!1,this._layoutDirty=!0,this.scrollable=e.scrollable??!1,this.scrollFriction=e.scrollFriction??.92,this.scrollBounce=e.scrollBounce??.3,this.scrollThreshold=e.scrollThreshold??.5,this._viewportWidth=e.viewportWidth??null,this._viewportHeight=e.viewportHeight??null,this._scrollOffset={x:0,y:0},this._scrollVelocity={x:0,y:0},this._scrollDragging=!1,this._scrollDragStart={x:0,y:0},this._scrollDragStartOffset={x:0,y:0},this._lastDragPosition={x:0,y:0},this._lastDragTime=0,this.scrollable&&this._setupScrollInteraction(),this._scrollInitialized=!1}calculateLayout(){throw new Error("Subclasses must implement calculateLayout()")}update(t){if(this._boundsDirty||this._layoutDirty){const e=this.width,i=this.height,s=this.calculateLayout();if(this.autoSize&&s){this._contentWidth=s.width,this._contentHeight=s.height;const n=this.getScrollAxis(),o=this._viewportWidth,r=this._viewportHeight;let a=s.width,l=s.height;this.scrollable&&o!==null&&n.horizontal&&(a=Math.min(s.width,o)),this.scrollable&&r!==null&&n.vertical&&(l=Math.min(s.height,r)),Math.abs(this.width-a)>.1&&(this.width=a),Math.abs(this.height-l)>.1&&(this.height=l)}if(s&&s.positions&&this.applyPositionsToChildren(s.positions),this.scrollable&&!this._scrollInitialized&&this._needsScrolling()){const n=this._getScrollBounds(),o=this.getScrollAxis();o.horizontal&&(this._scrollOffset.x=n.maxX),o.vertical&&(this._scrollOffset.y=n.maxY),this._scrollInitialized=!0}this._boundsDirty=!1,this._layoutDirty=!1,(e!==this.width||i!==this.height)&&!this._updatingBoundsFromLayout&&(this._updatingBoundsFromLayout=!0,Zt.prototype.markBoundsDirty.call(this),this._updatingBoundsFromLayout=!1)}this.scrollable&&!this._scrollDragging&&this._updateScrollMomentum(t),super.update(t)}markBoundsDirty(){if(this._updatingBoundsFromLayout){this._boundsDirty=!0;return}super.markBoundsDirty(),this._layoutDirty=!0}applyPositionsToChildren(t){Ji(this.children,t,this.getLayoutOffset())}getLayoutOffset(){return{offsetX:0,offsetY:0}}add(t){const e=super.add(t);return this._layoutDirty=!0,e}remove(t){const e=super.remove(t);return this._layoutDirty=!0,e}getScrollAxis(){return{horizontal:!1,vertical:!0}}calculateBounds(){if(this.scrollable&&(this._viewportWidth||this._viewportHeight)){const t=this._viewportWidth??this.width,e=this._viewportHeight??this.height;return{x:-t/2,y:-e/2,width:t,height:e}}return super.calculateBounds()}_getScrollBounds(){const t=this._contentWidth??this.width,e=this._contentHeight??this.height,i=this._viewportWidth??t,s=this._viewportHeight??e,n=Math.max(0,t-i),o=Math.max(0,e-s);return{minX:-n/2,maxX:n/2,minY:-o/2,maxY:o/2}}_clampScrollBounds(){const t=this._getScrollBounds(),e=this.getScrollAxis();e.horizontal&&(this._scrollOffset.x<t.minX?(this._scrollOffset.x+=(t.minX-this._scrollOffset.x)*this.scrollBounce,this._scrollVelocity.x=0):this._scrollOffset.x>t.maxX&&(this._scrollOffset.x+=(t.maxX-this._scrollOffset.x)*this.scrollBounce,this._scrollVelocity.x=0)),e.vertical&&(this._scrollOffset.y<t.minY?(this._scrollOffset.y+=(t.minY-this._scrollOffset.y)*this.scrollBounce,this._scrollVelocity.y=0):this._scrollOffset.y>t.maxY&&(this._scrollOffset.y+=(t.maxY-this._scrollOffset.y)*this.scrollBounce,this._scrollVelocity.y=0))}_updateScrollMomentum(t){const e=this.getScrollAxis();e.horizontal&&(this._scrollVelocity.x*=this.scrollFriction,Math.abs(this._scrollVelocity.x)<this.scrollThreshold&&(this._scrollVelocity.x=0),this._scrollOffset.x+=this._scrollVelocity.x*t*60),e.vertical&&(this._scrollVelocity.y*=this.scrollFriction,Math.abs(this._scrollVelocity.y)<this.scrollThreshold&&(this._scrollVelocity.y=0),this._scrollOffset.y+=this._scrollVelocity.y*t*60),this._clampScrollBounds()}_setupScrollInteraction(){this.interactive=!0,this._scrollInputDownHandler=t=>{this._isPointInViewport(t.x,t.y)&&this._onScrollDragStart(t)},this._scrollInputMoveHandler=t=>this._onScrollDragMove(t),this._scrollInputUpHandler=t=>this._onScrollDragEnd(t),this.game.events.on("inputdown",this._scrollInputDownHandler),this.game.events.on("inputmove",this._scrollInputMoveHandler),this.game.events.on("inputup",this._scrollInputUpHandler)}_isPointInViewport(t,e){let i=t-this.x,s=e-this.y,n=this.parent;for(;n;)i-=n.x||0,s-=n.y||0,n=n.parent;const o=this._viewportWidth??this.width,r=this._viewportHeight??this.height,a=o/2,l=r/2;return i>=-a&&i<=a&&s>=-l&&s<=l}_onScrollDragStart(t){this._scrollDragging=!0,this._scrollDragStart={x:t.x,y:t.y},this._scrollDragStartOffset={...this._scrollOffset},this._lastDragPosition={x:t.x,y:t.y},this._lastDragTime=performance.now(),this._scrollVelocity={x:0,y:0}}_onScrollDragMove(t){if(!this._scrollDragging)return;const e=this.getScrollAxis(),i=performance.now(),s=Math.max(1,i-this._lastDragTime)/1e3;if(e.horizontal){const n=t.x-this._scrollDragStart.x;this._scrollOffset.x=this._scrollDragStartOffset.x+n,this._scrollVelocity.x=(t.x-this._lastDragPosition.x)/(s*60)}if(e.vertical){const n=t.y-this._scrollDragStart.y;this._scrollOffset.y=this._scrollDragStartOffset.y+n,this._scrollVelocity.y=(t.y-this._lastDragPosition.y)/(s*60)}this._lastDragPosition={x:t.x,y:t.y},this._lastDragTime=i}_onScrollDragEnd(){this._scrollDragging=!1}_needsScrolling(){if(!this.scrollable)return!1;const t=this._contentWidth??this.width,e=this._contentHeight??this.height,i=this._viewportWidth??t,s=this._viewportHeight??e,n=this.getScrollAxis();return!!(n.horizontal&&t>i||n.vertical&&e>s)}draw(){this._needsScrolling()?this._drawScrollable():super.draw()}_drawScrollable(){this.applyTransforms(),this.drawDebug();const t=this.padding??0,e=(this._viewportWidth??this.width)-t*2,i=(this._viewportHeight??this.height)-t*2;y.save(),y.ctx.beginPath(),y.ctx.rect(-e/2,-i/2,e,i),y.ctx.clip(),y.ctx.beginPath(),y.ctx.translate(this._scrollOffset.x,this._scrollOffset.y),this._collection.getSortedChildren().filter(s=>s.visible).forEach(s=>{y.save(),s.render(),y.restore()}),y.restore()}scrollTo(t,e){const i=this.getScrollAxis();i.horizontal&&(this._scrollOffset.x=t),i.vertical&&(this._scrollOffset.y=e),this._scrollVelocity={x:0,y:0}}scrollBy(t,e){const i=this.getScrollAxis();i.horizontal&&(this._scrollOffset.x+=t),i.vertical&&(this._scrollOffset.y+=e)}getScrollPosition(){return{...this._scrollOffset}}resetScroll(){this._scrollOffset={x:0,y:0},this._scrollVelocity={x:0,y:0}}getHitTestOffset(){var t,e;return this.scrollable?{x:((t=this._scrollOffset)==null?void 0:t.x)||0,y:((e=this._scrollOffset)==null?void 0:e.y)||0}:{x:0,y:0}}isChildHittable(t){var e,i;if(!this.scrollable||!this._needsScrolling())return!0;const s=this.getScrollAxis(),n=this._viewportWidth??this.width,o=this._viewportHeight??this.height,r=((e=this._scrollOffset)==null?void 0:e.x)||0,a=((i=this._scrollOffset)==null?void 0:i.y)||0,l=t.x+r,h=t.y+a,d=(t.width||0)/2,u=(t.height||0)/2;return!(s.horizontal&&(l+d<-n/2||l-d>n/2)||s.vertical&&(h+u<-o/2||h-u>o/2))}}class ar extends oi{getScrollAxis(){return{horizontal:!0,vertical:!1}}calculateLayout(){return ts(this.children,{spacing:this.spacing,padding:this.padding,align:this.align,centerItems:!0})}getLayoutOffset(){return{offsetX:-(this._contentWidth??this.width)/2,offsetY:0}}}class lr extends oi{calculateLayout(){return es(this.children,{spacing:this.spacing,padding:this.padding,align:this.align,centerItems:!0})}getLayoutOffset(){return{offsetX:0,offsetY:-(this._contentHeight??this.height)/2}}}class cr extends oi{constructor(t,e={}){super(t,e),this.columns=e.columns??4}calculateLayout(){return this.children.length?is(this.children,{columns:this.columns,spacing:this.spacing,padding:this.padding,centerItems:!0}):null}getLayoutOffset(){const t=this._contentWidth??this.width,e=this._contentHeight??this.height;return{offsetX:-t/2,offsetY:-e/2}}}class Fs extends ue{constructor(t,e={}){super(t,e),this._frames=[],this._currentFrame=0,this._frameAccumulator=0,this._isPlaying=e.autoPlay||!1,this._loop=e.loop!==void 0?e.loop:!0,this._frameRate=e.frameRate||12,this._frameDuration=1/this._frameRate,this._animations=new Map,this._currentAnimation=null,e.frames&&Array.isArray(e.frames)&&e.frames.forEach(i=>this.addFrame(i))}addAnimation(t,e,i={}){if(!t||typeof t!="string")throw new Error("Sprite.addAnimation: name is required");if(!e||!Array.isArray(e)||e.length===0)throw new Error("Sprite.addAnimation: frames array is required");return e.forEach(s=>{s.parent=this}),this._animations.set(t,{frames:e,loop:i.loop!==void 0?i.loop:!0,frameRate:i.frameRate||null}),this}removeAnimation(t){const e=this._animations.get(t);return e?(e.frames.forEach(i=>{i.parent=null}),this._animations.delete(t),this._currentAnimation===t&&(this._currentAnimation=null,this._frames=[]),!0):!1}playAnimation(t,e=!1){const i=this._animations.get(t);return i?this._currentAnimation===t&&this._isPlaying&&!e?this:(this._currentAnimation=t,this._frames=i.frames,this._loop=i.loop,i.frameRate!==null&&(this._frameRate=i.frameRate,this._frameDuration=1/this._frameRate),this._currentFrame=0,this._frameAccumulator=0,this._isPlaying=!0,this):(console.warn(`Sprite.playAnimation: animation '${t}' not found`),this)}stopAnimation(t){const e=this._animations.get(t);return e?(this._currentAnimation=t,this._frames=e.frames,this._loop=e.loop,this._currentFrame=0,this._frameAccumulator=0,this._isPlaying=!1,this):(console.warn(`Sprite.stopAnimation: animation '${t}' not found`),this)}get currentAnimationName(){return this._currentAnimation}get animationNames(){return Array.from(this._animations.keys())}hasAnimation(t){return this._animations.has(t)}addFrame(t){if(!t)throw new Error("Sprite.addFrame: shape is required");return t.parent=this,this._frames.push(t),this.markBoundsDirty(),this._frames.length-1}removeFrame(t){if(t<0||t>=this._frames.length)return null;const e=this._frames.splice(t,1)[0];return e&&(e.parent=null,this.markBoundsDirty(),this._currentFrame>=this._frames.length&&this._frames.length>0&&(this._currentFrame=this._frames.length-1)),e}clearFrames(){this._frames.forEach(t=>{t.parent=null}),this._frames=[],this._currentFrame=0,this.markBoundsDirty()}get totalFrames(){return this._frames.length}get currentFrame(){return this._currentFrame}get currentShape(){return this._frames[this._currentFrame]||null}get frames(){return this._frames}get isPlaying(){return this._isPlaying}get loop(){return this._loop}set loop(t){this._loop=t}get frameRate(){return this._frameRate}set frameRate(t){if(t<=0)throw new Error("Sprite.frameRate must be greater than 0");this._frameRate=t,this._frameDuration=1/t}play(){return this._isPlaying=!0,this}pause(){return this._isPlaying=!1,this}stop(){return this._isPlaying=!1,this._currentFrame=0,this._frameAccumulator=0,this}rewind(){return this._currentFrame=0,this._frameAccumulator=0,this}goto(t){return this._frames.length===0?this:(this._currentFrame=Math.max(0,Math.min(t,this._frames.length-1)),this._frameAccumulator=0,this)}gotoAndStop(t){return this.goto(t),this.pause(),this}gotoAndPlay(t){return this.goto(t),this.play(),this}update(t){if(super.update(t),!this._isPlaying||this._frames.length===0)return;for(this._frameAccumulator+=t;this._frameAccumulator>=this._frameDuration;)this._frameAccumulator-=this._frameDuration,this._advanceFrame();const e=this.currentShape;e&&typeof e.update=="function"&&e.update(t)}_advanceFrame(){this._currentFrame++,this._currentFrame>=this._frames.length&&(this._loop?this._currentFrame=0:(this._currentFrame=this._frames.length-1,this._isPlaying=!1))}draw(){super.draw();const t=this.currentShape;t&&t.visible!==!1&&(y.save(),t.render(),y.restore())}calculateBounds(){if(this._frames.length===0)return{x:this.x,y:this.y,width:0,height:0};let t=1/0,e=1/0,i=-1/0,s=-1/0;return this._frames.forEach(n=>{const o=n.getBounds();t=Math.min(t,o.x),e=Math.min(e,o.y),i=Math.max(i,o.x+o.width),s=Math.max(s,o.y+o.height)}),{x:t+this.x,y:e+this.y,width:i-t,height:s-e}}toString(){return`[Sprite frames=${this.totalFrames} current=${this.currentFrame} playing=${this.isPlaying}]`}}class Bi extends Fs{constructor(t,e={}){super(t,{frameRate:e.frameRate||12,loop:e.loop!==void 0?e.loop:!0,autoPlay:!1,...e}),this._src=e.src,this._frameWidth=e.frameWidth,this._frameHeight=e.frameHeight,this._columns=e.columns,this._rows=e.rows,this._frameCount=e.frameCount||e.columns*e.rows,this._startFrame=e.startFrame||0,this._smoothing=e.smoothing!==void 0?e.smoothing:!1,this._autoPlayAfterLoad=e.autoPlay||!1,this._loaded=!1,this._loading=!1,this._image=null,this._frameCanvases=[],this.width=this._frameWidth,this.height=this._frameHeight}static async create(t,e){const i=new Bi(t,e);return await i.load(),i}async load(){if(this._loaded||this._loading)return this;this._loading=!0;try{return this._image=await this._loadImage(this._src),await this._sliceFrames(),this._loaded=!0,this._loading=!1,this._autoPlayAfterLoad&&this.play(),this}catch(t){throw this._loading=!1,console.error("SpriteSheet.load failed:",t),t}}_loadImage(t){return new Promise((e,i)=>{const s=new Image;s.onload=()=>e(s),s.onerror=n=>i(new Error(`Failed to load image: ${t}`)),s.src=t})}async _sliceFrames(){const{_image:t,_frameWidth:e,_frameHeight:i,_columns:s}=this;this.clearFrames(),this._frameCanvases=[];for(let n=this._startFrame;n<this._startFrame+this._frameCount;n++){const o=n%s,r=Math.floor(n/s),a=o*e,l=r*i,h=document.createElement("canvas");h.width=e,h.height=i;const d=h.getContext("2d");d.imageSmoothingEnabled=this._smoothing,d.drawImage(t,a,l,e,i,0,0,e,i),this._frameCanvases.push(h);const u=new Ue(h,{width:e,height:i,anchor:"center",smoothing:this._smoothing});this.addFrame(u)}}get loaded(){return this._loaded}get loading(){return this._loading}get frameWidth(){return this._frameWidth}get frameHeight(){return this._frameHeight}get columns(){return this._columns}get rows(){return this._rows}update(t){this._loaded&&super.update(t)}draw(){this._loaded&&super.draw()}toString(){return`[SpriteSheet src="${this._src}" frames=${this._frameCount} loaded=${this._loaded}]`}}class hr extends ri{constructor(t,e,i={}){const s=new Oi(e,{font:i.font||"16px monospace",color:i.color||"yellow",align:i.align||"left",baseline:i.baseline||"top",strokeColor:i.strokeColor||"#000",lineWidth:i.lineWidth||1,debugColor:i.debugColor||"yellow"});super(t,s,i),this._textOptions={font:i.font||"16px monospace",color:i.color||"yellow",align:i.align||"left",baseline:i.baseline||"top"}}get text(){return this.shape.text}set text(t){this.shape.text=t,this.markBoundsDirty()}get font(){return this.shape.font}set font(t){this.shape.font=t,this._textOptions.font=t,this.markBoundsDirty()}get color(){return this.shape.color}set color(t){this.shape.color=t,this._textOptions.color=t}get align(){return this.shape.align}set align(t){this.shape.align=t,this._textOptions.align=t,this.markBoundsDirty()}get baseline(){return this.shape.baseline}set baseline(t){this.shape.baseline=t,this._textOptions.baseline=t,this.markBoundsDirty()}measureWidth(){return y.ctx?y.text.measureTextWidth(this.text,this.font):0}measureHeight(){if(!this.font)return 16;const t=parseInt(this.font);return isNaN(t)?16:t}getBounds(){const t=super.getBounds();if(this.shape.getTextBounds){const e=this.shape.getTextBounds();return{x:this.x,y:this.y,width:e.width,height:e.height}}return t}update(t){super.update(t),this.shape&&(this.width=this.shape.width||this.measureWidth(),this.height=this.shape.height||this.measureHeight())}}class ur extends ri{constructor(t,e,i={}){const s=e instanceof Ue?e:new Ue(e,i);super(t,s,i)}reset(){this.shape.reset()}}class Ee{constructor(t={}){this.shape=t.shape||"circle",this.x=t.x??0,this.y=t.y??0,this.scaleX=t.scaleX??1,this.scaleY=t.scaleY??1,this.radius=t.radius??100,this.width=t.width??200,this.height=t.height??200,this.cornerRadius=t.cornerRadius??0,this.radiusX=t.radiusX??100,this.radiusY=t.radiusY??100,this.pathFn=t.pathFn??null,this.invert=t.invert??!1,this._applied=!1}apply(t){if(this._applied){console.warn("Mask already applied. Call remove() first.");return}t.save(),t.beginPath(),this.invert?(t.rect(-1e4,-1e4,2e4,2e4),this._drawPath(t),t.clip("evenodd")):(this._drawPath(t),t.clip()),this._applied=!0}remove(t){this._applied&&(t.restore(),this._applied=!1)}_drawPath(t){const e=this.scaleX,i=this.scaleY;switch(this.shape){case"circle":const s=(e+i)/2;t.arc(this.x,this.y,this.radius*s,0,Math.PI*2);break;case"rectangle":const n=this.width*e,o=this.height*i,r=this.cornerRadius*Math.min(e,i);r>0?this._roundedRect(t,this.x-n/2,this.y-o/2,n,o,r):t.rect(this.x-n/2,this.y-o/2,n,o);break;case"ellipse":t.ellipse(this.x,this.y,this.radiusX*e,this.radiusY*i,0,0,Math.PI*2);break;case"path":this.pathFn&&this.pathFn(t,this);break;default:console.warn(`Unknown mask shape: ${this.shape}`)}}_roundedRect(t,e,i,s,n,o){o=Math.min(o,s/2,n/2),t.moveTo(e+o,i),t.lineTo(e+s-o,i),t.arcTo(e+s,i,e+s,i+o,o),t.lineTo(e+s,i+n-o),t.arcTo(e+s,i+n,e+s-o,i+n,o),t.lineTo(e+o,i+n),t.arcTo(e,i+n,e,i+n-o,o),t.lineTo(e,i+o),t.arcTo(e,i,e+o,i,o),t.closePath()}setPosition(t,e){return this.x=t,this.y=e,this}setScale(t){return this.scaleX=t,this.scaleY=t,this}setScaleXY(t,e){return this.scaleX=t,this.scaleY=e,this}static circle(t,e,i){return new Ee({shape:"circle",x:t,y:e,radius:i})}static rectangle(t,e,i,s,n=0){return new Ee({shape:"rectangle",x:t,y:e,width:i,height:s,cornerRadius:n})}static ellipse(t,e,i,s){return new Ee({shape:"ellipse",x:t,y:e,radiusX:i,radiusY:s})}}class Xt{static lerp(t,e,i){return t+(e-t)*i}static lerpAngle(t,e,i){let s=e-t;for(;s<-Math.PI;)s+=Math.PI*2;for(;s>Math.PI;)s-=Math.PI*2;return t+s*i}static tweenColor(t,e,i){return t.map((s,n)=>Xt.lerp(s,e[n],i))}static tweenGradient(t,e,i){let s=t[0],n=e[0];Math.abs(n-s)>180&&(s<n?s+=360:n+=360);const o=Xt.lerp(s,n,i)%360,r=Xt.lerp(t[1],e[1],i),a=Xt.lerp(t[2],e[2],i);return[o,r,a]}}function Ws(c,t,e,i,s,n=!1,o=null,r={},a=null){const{t:l,easedT:h,completed:d,state:u}=$._frame(i,s,n,o,r,a),f=1/(e+1),g=Math.min(Math.floor(h/f),e),m=h%f/f,p=c*Math.pow(.6,g),v=Math.sin(m*Math.PI),_=t-v*(t-p);return $.animationResult({y:_,segment:g,bounceHeight:p},l,n,d,u)}function Gs(c,t,e,i,s,n,o=!0,r=null,a={},l=null){if(e<=0)return $.animationResult({x:c.x,y:c.y,moving:!1},1,!1,!0);l||(l={initialX:c.x,initialY:c.y,started:!1,completed:!1,loopCount:0});const h=l.initialX,d=l.initialY,{t:u,easedT:f,completed:g,state:m}=$._frame(t,e,o,r,a,l);l={...l,...m};const p=t*i,v=Math.max(0,Math.min(1,s)),_=.7,w=.9,x=2.3,S=1.9,k=Math.sin(p*_)+v*.4*Math.sin(p*x+.5),C=Math.cos(p*w)+v*.4*Math.cos(p*S+.7),M=h+k*n,R=d+C*n,D=_*Math.cos(p*_)+v*.4*x*Math.cos(p*x+.5),A=-.9*Math.sin(p*w)+v*.4*-1.9*Math.sin(p*S+.7),O=Math.sqrt(D*D+A*A),E=O>.8,L=Math.sqrt((M-h)*(M-h)+(R-d)*(R-d));return $.animationResult({x:M,y:R,centerX:h,centerY:d,offsetX:M-h,offsetY:R-d,distance:L,moving:E,velocity:O},u,o,g,l)}function Ns(c,t=!1,e,i,s=!1,n=null,o={},r=null){if(!c||c.length<2)return this._createResult({x:0,y:0},0,s,!1);const{t:a,easedT:l,completed:h,state:d}=$._frame(e,i,s,n,o,r);if(!r||!r.pathData){const M={segmentLengths:[],totalLength:0,points:[...c]};for(let R=0;R<c.length-1;R++){const D=c[R],A=c[R+1],O=A[0]-D[0],E=A[1]-D[1],L=Math.sqrt(O*O+E*E);M.segmentLengths.push(L),M.totalLength+=L}if(t){const R=c[c.length-1],D=c[0],A=D[0]-R[0],O=D[1]-R[1],E=Math.sqrt(A*A+O*O);M.segmentLengths.push(E),M.totalLength+=E}d.pathData=M}const{segmentLengths:u,totalLength:f,points:g}=d.pathData,m=l*f;let p=0,v=0;for(let M=0;M<u.length;M++){if(p+u[M]>=m){v=M;break}p+=u[M]}const _=(m-p)/u[v],w=g[v],x=v<g.length-1?g[v+1]:g[0],S=Xt.lerp(w[0],x[0],_),k=Xt.lerp(w[1],x[1],_),C=Math.atan2(x[1]-w[1],x[0]-w[0]);return $.animationResult({x:S,y:k,angle:C,segmentIndex:v,segmentProgress:_,pathProgress:l},a,s,h,d)}function Hs(c,t,e,i,s,n,o,r=!0,a=!0,l=null,h={},d=null){const{t:u,easedT:f,completed:g,state:m}=$._frame(n,o,r,l,h,d),v=s+(a?1:-1)*f*Math.PI*2,_=c+e*Math.cos(v),w=t+i*Math.sin(v);return $.animationResult({x:_,y:w,angle:v},u,r,g,m)}function Us(c,t,e,i,s=!0,n=null,o={},r=null){const{t:a,easedT:l,completed:h,state:d}=$._frame(e,i,s,n,o,r),u=(t-c)/2,g=c+u+u*Math.sin(l*Math.PI*2);return $.animationResult({value:g},a,s,h,d)}function Vs(c,t,e,i,s,n=!1,o=!1,r=null,a={},l=null){l||(l={started:!1,loopCount:0,direction:1,lastDirection:1,completed:!1});let h=s>0?i/s:1,d=!1,u={...a};if(o||n)if(n)if(o){const w=s*2,x=i%w,S=Math.floor(i/w),k=x<s?1:-1;h=k===1?x/s:2-x/s,k!==l.direction&&(l.direction=k,l.direction===1&&u.onLoop&&u.onLoop(S)),S>l.loopCount&&(l.loopCount=S)}else{h=h%1;const w=Math.floor(i/s);w>l.loopCount&&u.onLoop&&(u.onLoop(w),l.loopCount=w)}else o&&!n&&(h<=1?l.direction=1:h<=2?(h=2-h,l.direction=-1):(h=0,d=!0,l.direction=1));else h>=1&&(h=1,d=!0);!l.started&&u.onStart&&(u.onStart(),l.started=!0),d&&!l.completed&&u.onComplete&&(u.onComplete(),l.completed=!0);const f=r?r(h):h,g=c+e-2*t,m=2*(t-c),p=c,v=g*f*f+m*f+p,_={...l,lastDirection:l.direction,completed:d||l.completed};return $.animationResult({value:v,direction:l.direction},h,n||o&&!d,d,_)}function qs(c,t,e,i,s,n,o=!0,r=null){r||(r={currentX:c,currentY:t,targetX:c,targetY:t,isWaiting:!0,waitStartTime:0,moveStartTime:0,moveCount:0,direction:"idle"});const a=()=>Math.random();let l=r.isWaiting,h=r.currentX,d=r.currentY,u=r.direction;if(l){if(e-r.waitStartTime>=s){l=!1,r.moveStartTime=e,u=["up","down","left","right"][Math.floor(a()*4)];let v=r.currentX,_=r.currentY;const w=n*(.2+a()*.6);switch(u){case"up":_=r.currentY-w;break;case"down":_=r.currentY+w;break;case"left":v=r.currentX-w;break;case"right":v=r.currentX+w;break}Math.pow(v-c,2)+Math.pow(_-t,2)>n*n&&(u==="up"||u==="down"?(_=t,u=r.currentY>t?"up":"down"):(v=c,u=r.currentX>c?"left":"right")),r.targetX=v,r.targetY=_,r.direction=u,r.moveCount++}}else{const p=(e-r.moveStartTime)/i;p>=1?(l=!0,r.waitStartTime=e,r.currentX=r.targetX,r.currentY=r.targetY,u="idle"):(h=r.currentX+(r.targetX-r.currentX)*p,d=r.currentY+(r.targetY-r.currentY)*p)}r.isWaiting=l,r.direction=u,l||(r.currentX=h,r.currentY=d);const f=i+s,g=e%f/f,m=Math.sqrt(Math.pow(h-c,2)+Math.pow(d-t,2));return $.animationResult({x:h,y:d,moving:!l,direction:u,distanceFromCenter:m},g,o,!1,r)}function $s(c,t,e,i,s=!0,n=!1,o=null,r={},a=null){const{t:l,easedT:h,completed:d,state:u}=$._frame(e,i,s,null,r,a),f=n&&!s?Math.exp(-4*l):1;let g=c+t*Math.cos(h*2*Math.PI)*f;if(o){const m=(g-c)/(t*f);g=c+o((m+1)/2)*t*f*2-t*f}return $.animationResult({angle:g},l,s,d,u)}function Zs(c,t,e,i,s=!0,n=!1,o=null,r={}){let a=e/i,l="forward";if(s){const u=Math.floor(a);a=a%1,u>0&&r.onLoop&&r.onLoop(u)}else a>1&&(a=1);a>0&&e<=i&&r.onStart&&r.onStart();let h;if(n)if(a<.5){const u=a*2,f=o?o(u):u;h=c+(t-c)*f,l="forward"}else{const u=(a-.5)*2,f=o?o(u):u;h=t-(t-c)*f,l="return",a>=.5&&a<.51&&r.onYoyoTurn&&r.onYoyoTurn()}else{const u=o?o(a):a,f=u<.5?u*2:2-u*2;h=c+(t-c)*f}const d=!s&&a>=1;return d&&r.onComplete&&r.onComplete(),$.animationResult({value:h,phase:l},a,s,d)}function js(c,t,e,i,s=!0,n=!0,o=null,r={},a=null){const{t:l,easedT:h,completed:d,state:u}=$._frame(e,i,s,o,r,a,n);let f=0;!s&&!n?f=d?1:Math.sin(Math.min(l,1)*Math.PI*.5):n?f=Math.sin(h*Math.PI):f=Math.sin(Math.min(l,1)*Math.PI*.5);const g=c-t*f;return $.animationResult({y:g},l,s,d,u)}function Ks(c,t,e,i,s,n,o,r,a=!1,l=null,h={},d=null){const{t:u,easedT:f,completed:g,state:m}=$._frame(o,r,a,l,h,d),p=Math.pow(1-f,n),v=f*Math.PI*2*s,_=f*Math.PI*2*s*1.3,w=p*e*(Math.sin(v)*.6+Math.sin(v*2.5)*.3+Math.sin(v*5.6)*.1),x=p*i*(Math.cos(_)*.6+Math.cos(_*2.7)*.3+Math.cos(_*6.3)*.1);let S=c+w,k=t+x;if(f>.9){const C=(f-.9)/.1;S=c+w*(1-C),k=t+x*(1-C)}return $.animationResult({x:S,y:k,intensity:p},u,a,g,m)}function Qs(c,t,e,i,s,n,o,r,a=!1,l=!1,h=null,d={},u=null){u||(u={started:!1,loopCount:0,direction:1,lastDirection:1});let f=r>0?o/r:1,g=!1,m={...d};if(l||a)if(a)if(l){const k=r*2,C=o%k,M=Math.floor(o/k),R=C<r?1:-1;f=R===1?C/r:2-C/r,R!==u.direction&&(u.direction=R,u.direction===1&&m.onLoop&&m.onLoop(M)),M>u.loopCount&&(u.loopCount=M)}else{f=f%1;const k=Math.floor(o/r);k>u.loopCount&&m.onLoop&&(m.onLoop(k),u.loopCount=k)}else l&&!a&&(f<=1?u.direction=1:f<=2?(f=2-f,u.direction=-1):(f=0,g=!0,u.direction=1));else f>=1&&(f=1,g=!0);!u.started&&m.onStart&&(m.onStart(),u.started=!0),g&&!u.completed&&m.onComplete&&(m.onComplete(),u.completed=!0);const p=h?h(f):f,v=Xt.lerp(e,i,p),_=s+p*n*Math.PI*2,w=c+v*Math.cos(_),x=t+v*Math.sin(_),S={...u,lastDirection:u.direction};return $.animationResult({x:w,y:x,radius:v,angle:_,direction:u.direction},f,a||l&&!g,g,S)}function Js(c,t,e,i,s=!1,n=!1,o={},r={}){if(i<=0)return this.animationResult({value:t,velocity:0,done:!0,phase:"complete"},1,!1,!0);let a=e/i,l="forward",h=0;s?(h=Math.floor(a),a=a%1,h>0&&r.onLoop&&r.onLoop(h)):a>1&&(a=1),a>0&&e<=i&&r.onStart&&r.onStart();let d,u,f;n?a>=.5?(d=c,u=t,f=(a-.5)*2,l="return",a>=.5&&a<.51&&r.onYoyoTurn&&r.onYoyoTurn()):(d=t,u=c,f=a*2,l="forward"):(d=t,u=c,f=a);const g=o.stiffness!==void 0?o.stiffness:.3,m=o.damping!==void 0?o.damping:.6,p=Math.max(.1,1/(m*1.5)),v=Math.max(.1,.8/(g*1.5+.5));let _;if(f<.99)_=lt.easeOutElastic(f,p,v);else{const D=(f-.99)/.01;_=lt.easeOutElastic(.99,p,v)*(1-D)+1*D}const w=Xt.lerp(u,d,_),x=.01,S=Math.min(f+x,1);let k;if(S<.99)k=lt.easeOutElastic(S,p,v);else{const D=(S-.99)/.01;k=lt.easeOutElastic(.99,p,v)*(1-D)+1*D}const M=(Xt.lerp(u,d,k)-w)/x*i,R=!s&&a>=1;return R&&r.onComplete&&r.onComplete(),$.animationResult({value:w,velocity:M,delta:l==="forward"?t-w:c-w,done:R,phase:l},a,s,R)}function tn(c,t,e,i,s,n=!0,o=!0,r=null,a={},l=null){const{t:h,easedT:d,completed:u,state:f}=$._frame(i,s,n,r,a,l),m=Math.sin(o?d*Math.PI*2:d*Math.PI)*e;return $.animationResult({angle:m},h,n,u,f)}function en(c,t,e,i,s,n=!0,o={},r=null){if(!e||!Array.isArray(e)||e.length<2)return console.warn("Patrol animation requires at least 2 waypoints"),$._createResult({x:0,y:0,moving:!1,direction:"idle",waypoint:0},0,!1,!0);r||(r={currentWaypoint:0,nextWaypoint:1,isWaiting:!0,waitStartTime:0,lastWaypointTime:0,lastWaypointReached:-1,completed:!1});let a=0;for(let M=0;M<e.length;M++){const R=(M+1)%e.length;if(!n&&M===e.length-1)break;const D=e[R][0]-e[M][0],A=e[R][1]-e[M][1];a+=Math.abs(D)+Math.abs(A)}const l=a/i,h=s*e.length,d=l+h;let u=t;n?u=t%d:u=Math.min(t,d);const f=u/d;let g=u,m=0,p=1,v=!0,_=0,w=0,x=!1;if(g<s)_=g/s,m=0,p=1,v=!0;else{g-=s;for(let M=0;M<e.length;M++){if(!n&&M===e.length-1){m=M,p=M,v=!0,_=1,x=!0;break}const R=(M+1)%e.length,D=e[R][0]-e[M][0],A=e[R][1]-e[M][1],E=(Math.abs(D)+Math.abs(A))/i;if(g<E){m=M,p=R,v=!1,w=g/E;break}if(g-=E,g<s){m=R,p=(R+1)%e.length,v=!0,_=g/s,r.lastWaypointReached!==m&&(o.onWaypointReached&&o.onWaypointReached(m),o.onWaitStart&&o.onWaitStart(m),r.lastWaypointReached=m);break}g-=s}}let S,k,C;if(v||x)S=e[m][0],k=e[m][1],C="idle",!r.isWaiting&&v&&o.onWaitEnd&&o.onWaitEnd(m);else{const M=e[m],R=e[p],D=R[0]-M[0],A=R[1]-M[1],O=Math.abs(D)+Math.abs(A),E=Math.abs(D)/O;if(w<=E&&D!==0){const L=w/E;S=M[0]+D*L,k=M[1],C=D>0?"right":"left"}else{const L=(w-E)/(1-E);S=R[0],k=M[1]+A*L,C=A>0?"down":"up"}}return r.currentWaypoint=m,r.nextWaypoint=p,r.isWaiting=v,!r.completed&&x&&o.onPatrolComplete&&(o.onPatrolComplete(),r.completed=!0),$.animationResult({x:S,y:k,moving:!v,waiting:v,waitProgress:v?_:0,direction:C,waypoint:m,nextWaypoint:p},f,n,x,r)}class ${static animationResult(t,e,i,s=!1,n=null){return{...t,t:e,progress:e,loop:i,completed:s,state:n}}static _step(t,e,i,s={},n={started:!1,loopCount:0}){let o=e>0?t/e:1,r=!1;if(n=n||{started:!1,loopCount:0},!n.started&&s.onStart&&(s.onStart(),n.started=!0),i){o=o%1;const a=Math.floor(t/e);a>n.loopCount&&s.onLoop&&(s.onLoop(a),n.loopCount=a)}else o>=1&&(o=1,r=!0,!n.completed&&s.onComplete&&(s.onComplete(),n.completed=!0));return{t:o,completed:r,state:n}}static _frame(t,e,i,s=null,n={},o=null){const{t:r,completed:a,state:l}=this._step(t,e,i,n,o),h=s?s(r):r;return{t:r,easedT:h,completed:a,state:l}}static oscillate(t,e,i,s,n=!0,o=null,r={},a=null){return Us(t,e,i,s,n,o,r,a)}static parabolic(t,e,i,s,n,o=!1,r=!1,a=null,l={},h=null){return Vs(t,e,i,s,n,o,r,a,l,h)}static float(t,e,i,s,n,o,r=!0,a=null,l={},h=null){return Gs(t,e,i,s,n,o,r,a,l,h)}static spring(t,e,i,s,n=!1,o=!1,r={},a={}){return Js(t,e,i,s,n,o,r,a)}static swing(t,e,i,s,n,o=!0,r=!0,a=null,l={},h=null){return tn(t,e,i,s,n,o,r,a,l,h)}static pendulum(t,e,i,s,n=!0,o=!1,r=null,a={},l=null){return $s(t,e,i,s,n,o,r,a,l)}static pulse(t,e,i,s,n=!0,o=!1,r=null,a={}){return Zs(t,e,i,s,n,o,r,a={})}static spiral(t,e,i,s,n,o,r,a,l=!1,h=!1,d=null,u={},f=null){return Qs(t,e,i,s,n,o,r,a,l,h,d,u,f)}static orbit(t,e,i,s,n,o,r,a=!0,l=!0,h=null,d={},u=null){return Hs(t,e,i,s,n,o,r,a,l,h,d,u)}static bezier(t,e,i,s,n,o,r=!1,a=!1,l=null,h={},d=null){return sn(t,e,i,s,n,o,r,a,l,h,d)}static bounce(t,e,i,s,n,o=!1,r=null,a={},l=null){return Ws(t,e,i,s,n,o,r,a,l)}static shake(t,e,i,s,n,o,r,a,l=!1,h=null,d={},u=null){return Ks(t,e,i,s,n,o,r,a,l,h,d,u)}static follow(t,e=!1,i,s,n=!1,o=null,r={},a=null){return Ns(t,e,i,s,n,o,r,a)}static waypoint(t,e,i,s,n,o=!0,r={},a=null){return en(t,e,i,s,n,o,r,a)}static patrol(t,e,i,s,n,o,r=!0,a=null){return qs(t,e,i,s,n,o,r,a)}static hop(t,e,i,s,n=!0,o=!0,r=null,a={},l=null){return js(t,e,i,s,n,o,r,a,l)}static group(t,e,i,s,n=!1,o=null,r={},a=null){a||(a={started:!1,loopCount:0,animationStates:Array(t.length).fill(null)});const{t:l,easedT:h,completed:d,state:u}=this._frame(i,s,n,o,r,a),f={};for(let g=0;g<t.length;g++){const m=t[g],p=[...e[g]];m===this.parabolic||m===this.oscillate||m===this.pulse?(p[3]=i,p[4]=s,p[5]=n,p[6]===void 0&&(p[6]=o)):m===this.spring?(p[2]=i,p[3]=s,p[4]=n):m===this.spiral||m===this.bezier?(p[6]=i,p[7]=s,p[8]=n,p[9]===void 0&&(p[9]=o)):m===this.orbit?(p[5]=i,p[6]=s,p[7]=n,p[9]===void 0&&(p[9]=o)):m===this.bounce||m===this.shake?(p[6]=i,p[7]=s,p[8]=n,p[9]===void 0&&(p[9]=o)):m===this.followPath&&(p[2]=i,p[3]=s,p[4]=n,p[5]===void 0&&(p[5]=o)),p.push(r),p.push(u.animationStates[g]);const v=m.apply(this,p);u.animationStates[g]=v.state;const _=`anim${g}`;f[_]=v}return this.animationResult(f,l,n,d,u)}static sequence(t,e,i,s,n=!1,o=null,r={},a=null,l=null){if(!l){l={started:!1,loopCount:0,animationStates:Array(t.length).fill(null),currentAnim:0,animStartTimes:[0],totalDuration:0};let x=0;for(let S=0;S<i.length;S++)x+=i[S],S<i.length-1&&l.animStartTimes.push(x);l.totalDuration=x}let h=s;if(n&&l.totalDuration>0){h=s%l.totalDuration;const x=Math.floor(s/l.totalDuration);x>l.loopCount&&r.onLoop&&(r.onLoop(x),l.loopCount=x)}!l.started&&r.onStart&&(r.onStart(),l.started=!0);let d=0;for(let x=t.length-1;x>=0;x--)if(h>=l.animStartTimes[x]){d=x;break}l.currentAnim=d;const u=l.animStartTimes[d],f=h-u,g=i[d],m=t[d],p=[...e[d]];m===this.parabolic||m===this.oscillate||m===this.pulse?(p[3]=f,p[4]=g,p[5]=!1,o&&o[d]&&(p[6]=o[d])):m===this.spring?(p[2]=f,p[3]=g,p[4]=!1):m===this.spiral||m===this.bezier?(p[6]=f,p[7]=g,p[8]=!1,o&&o[d]&&(p[9]=o[d])):m===this.orbit?(p[5]=f,p[6]=g,p[7]=!1,o&&o[d]&&(p[9]=o[d])):m===this.bounce||m===this.shake?(p[6]=f,p[7]=g,p[8]=!1,o&&o[d]&&(p[9]=o[d])):m===this.followPath&&(p[2]=f,p[3]=g,p[4]=!1,o&&o[d]&&(p[5]=o[d]));const v=a&&a[d]?a[d]:{},_=m.apply(this,[...p,v,l.animationStates[d]]);l.animationStates[d]=_.state;const w=!n&&h>=l.totalDuration;return w&&!l.completed&&r.onComplete&&(r.onComplete(),l.completed=!0),this.animationResult({..._,currentAnim:d,totalAnimations:t.length,sequenceProgress:Math.min(h/l.totalDuration,1)},h/l.totalDuration,n,w,l)}}function sn(c,t,e,i,s,n,o=!1,r=!1,a=null,l={},h=null){if(n<=0)return $.animationResult({x:i[0],y:i[1],phase:"complete"},1,!1,!0);let d=s/n,u="forward",f=0;o?(f=Math.floor(d),d=d%1,f>0&&l.onLoop&&l.onLoop(f)):d>1&&(d=1),d>0&&s<=n&&l.onStart&&l.onStart();let m=a?a(d):d;r&&(d>=.5?(m=1-(d-.5)*2,u="return",d>=.5&&d<.51&&l.onYoyoTurn&&l.onYoyoTurn()):(m=d*2,u="forward"),m=a?a(m):m);const p=3*(t[0]-c[0]),v=3*(e[0]-t[0])-p,_=i[0]-c[0]-p-v,w=3*(t[1]-c[1]),x=3*(e[1]-t[1])-w,S=i[1]-c[1]-w-x,k=_*Math.pow(m,3)+v*Math.pow(m,2)+p*m+c[0],C=S*Math.pow(m,3)+x*Math.pow(m,2)+w*m+c[1],M=!o&&d>=1;return M&&l.onComplete&&l.onComplete(),$.animationResult({x:k,y:C,phase:u},d,o,M,h)}class Bt{constructor(t,e,i,s,n={}){this.target=t,this.toProps={...e},this.duration=i,this.easingFn=s||lt.easeOutQuad,this.delay=n.delay||0,this.onStart=n.onStart||null,this.onComplete=n.onComplete||null,this.onUpdate=n.onUpdate||null,this._elapsed=0,this._started=!1,this._finished=!1,this._startProps={};for(const o in this.toProps)o in this.target&&(this._startProps[o]=this.target[o])}static to(t,e,i,s,n){const o=new Bt(t,e,i,s,n);return Bt._active.push(o),o}update(t){if(this._finished||(this._elapsed+=t,this._elapsed<this.delay))return;const e=this._elapsed-this.delay,i=Math.min(e/this.duration,1);!this._started&&i>0&&(this._started=!0,this.onStart&&this.onStart());const s=this.easingFn(i);for(const n in this._startProps){const o=this._startProps[n],r=this.toProps[n];this.target[n]=Xt.lerp(o,r,s)}this.onUpdate&&this.onUpdate(),i>=1&&(this._finished=!0,this.onComplete&&this.onComplete())}static updateAll(t){for(const e of Bt._active)e.update(t);Bt._active=Bt._active.filter(e=>!e._finished)}static killTarget(t){Bt._active=Bt._active.filter(e=>e.target!==t)}static killAll(){Bt._active=[]}}class nn extends Ci{constructor(t){super(),this.game=t,this._collection=new ti,this._collection._owner=this,["inputdown","inputup","inputmove","click"].forEach(i=>{this.game.events.on(i,s=>{this.dispatchInputEvent(i,s)})})}_hoverObject(t,e){if(!t.interactive||!t._hitTest)return;const i=t._hitTest(e.x,e.y);i&&!t._hovered?(t._hovered=!0,t.events.emit("mouseover",e)):!i&&t._hovered&&(t._hovered=!1,t.events.emit("mouseout",e))}_hoverScene(t,e){if(t.children&&t.children.length>0)for(let i=t.children.length-1;i>=0;i--){const s=t.children[i];if(t.isChildHittable&&!t.isChildHittable(s)){s._hovered&&(s._hovered=!1,s.events.emit("mouseout",e));continue}s instanceof Zt?this._hoverScene(s,e):this._hoverObject(s,e)}this._hoverObject(t,e)}dispatchInputEvent(t,e){var i;for(let s=this.gameObjects.length-1;s>=0;s--){const n=this.gameObjects[s];if(n instanceof Zt){if(this._dispatchToScene(n,t,e))break}else if(n.interactive&&((i=n._hitTest)!=null&&i.call(n,e.x,e.y))){n.events.emit(t,e);break}}t==="inputmove"&&this._dispatchHover(e)}_dispatchHover(t){for(let e=this.gameObjects.length-1;e>=0;e--){const i=this.gameObjects[e];i instanceof Zt?this._hoverScene(i,t):this._hoverObject(i,t)}}_dispatchToScene(t,e,i){var s,n;for(let o=t.children.length-1;o>=0;o--){const r=t.children[o];if(!(t.isChildHittable&&!t.isChildHittable(r))){if(r instanceof Zt){if(this._dispatchToScene(r,e,i))return!0}else if(r.interactive&&((s=r._hitTest)!=null&&s.call(r,i.x,i.y)))return r.events.emit(e,i),!0}}return t.interactive&&((n=t._hitTest)!=null&&n.call(t,i.x,i.y))?(t.events.emit(e,i),!0):!1}add(t){t.parent=this.game;const e=this._collection.add(t);return e.init&&e.init(),e}remove(t){if(t==null){this.logger.warn("Cannot remove undefined or null object",t);return}this._collection.remove(t)}bringToFront(t){return this._collection.bringToFront(t)}sendToBack(t){return this._collection.sendToBack(t)}bringForward(t){return this._collection.bringForward(t)}sendBackward(t){return this._collection.sendBackward(t)}clear(){return this._collection.clear()}get gameObjects(){return this._collection.children}update(t){this.logger.groupCollapsed("Pipeline.update"),this._collection.children.filter(e=>e.active).forEach(e=>e.update(t)),Bt.updateAll(t),this.logger.groupEnd()}render(){const t=s=>s.render(),e=s=>s.visible,i=s=>s.active;this.logger.groupCollapsed("Pipeline.render"),this._collection.getSortedChildren().filter(e).filter(i).forEach(t),this.logger.groupEnd()}}class dr{constructor(t){N(this,Ce,0),N(this,De,0),this.canvas=t,this.ctx=t.getContext("2d"),this.events=new zi,this._cursor=null,this.lastTime=0,this.dt=0,this.running=!1,this._frame=0,this.pipeline=new nn(this),y.init(this.ctx),this.targetFPS=60,this._frameInterval=1e3/this.targetFPS,this._accumulator=0,this._pauseOnBlur=!1,this._isPaused=!1,this._init=!1,this.initLogging()}setFPS(t){this.targetFPS=t,this._frameInterval=1e3/t}init(){this.initIO(),this.initMotion(),this._init=!0,this.logger.log("[Game] Initialized")}initMouse(){zs.init(this)}initTouch(){Ys.init(this)}initInput(){V.init(this)}initKeyboard(){Bs.init(this)}initIO(){this.initMouse(),this.initTouch(),this.initInput(),this.initKeyboard()}initMotion(){Bt._active=[]}initLogging(){this.logger=new zt("Game"),zt.setOutput(console),zt.disableAll(),zt.disable(),zt.setLevel(zt.INFO),this.logger.groupCollapsed("Initializing Game...")}enableLogging(){zt.enable()}disableLogging(){zt.disableAll(),zt.disable()}markBoundsDirty(){this._boundsDirty=!0}get boundsDirty(){return this._boundsDirty}set boundsDirty(t){this._boundsDirty=t}enableFluidSize(t=window,e={}){const{top:i=0,right:s=0,bottom:n=0,left:o=0}=e;if(t===window){const r=()=>{var a;this.canvas.width=window.innerWidth-o-s,this.canvas.height=window.innerHeight-i-n,(b(this,Ce)!==this.canvas.width||b(this,De)!==this.canvas.height)&&(this.markBoundsDirty(),(a=this.onResize)==null||a.call(this)),q(this,Ce,this.canvas.width),q(this,De,this.canvas.height)};r(),window.addEventListener("resize",r),this._fluidResizeCleanup=()=>{window.removeEventListener("resize",r)}}else{if(!("ResizeObserver"in window)){console.warn("ResizeObserver not supported in this browser.");return}const r=()=>{const l=t.getBoundingClientRect();this.canvas.width=l.width-o-s,this.canvas.height=l.height-i-n},a=new ResizeObserver(()=>{r()});a.observe(t),r(),this._fluidResizeCleanup=()=>a.disconnect()}}disableFluidSize(){this._fluidResizeCleanup&&(this._fluidResizeCleanup(),this._fluidResizeCleanup=null)}start(){if(this.logger.groupCollapsed("[Game] Starting..."),this.init(),!this._init)throw new Error("Game not initialized. Did you call init()? Remember to call super.init() in your subclass.");this.running=!0,this.loop=this.loop.bind(this),requestAnimationFrame(this.loop),this.logger.log("[Game] Started"),this.logger.groupEnd()}stop(){this.running=!1,this.logger.log("[Game] Stopped")}restart(){this.pipeline.clear(),this.init(),this.start(),this.logger.log("[Game] Restarted")}loop(t){if(!this.running)return;const e=t-this.lastTime;if(this.lastTime=t,this._accumulator+=e,this.actualFps=1e3/e,this._accumulator>=this._frameInterval){const i=this._frameInterval/1e3;this.dt=i,this._frame++,this.logger.groupCollapsed(`Frame #${this._frame}`),this.logger.time("render time"),this.update(i),this.render(),this.logger.timeEnd("render time"),this.logger.groupEnd(),this._accumulator-=this._frameInterval}this.boundsDirty&&(this.boundsDirty=!1),requestAnimationFrame(this.loop)}update(t){this.pipeline.update(t)}render(){y.setContext(this.ctx),this.running&&this.clear(),this.pipeline.render()}clear(){y.clear()}get width(){return this.canvas.width}get height(){return this.canvas.height}set backgroundColor(t){this.canvas.style.backgroundColor=t}set cursor(t){this._cursor&&(this._cursor.destroy(),this.pipeline.remove(this._cursor)),this._cursor=t,this._cursor.activate(),this.pipeline.add(t)}get cursor(){return this._cursor}resetCursor(){this._cursor&&(this._cursor.destroy(),this.pipeline.remove(this._cursor),this._cursor=null)}enablePauseOnBlur(t){this._pauseOnBlur=t,t?window.addEventListener("visibilitychange",this._handleVisibilityChange.bind(this),!1):window.removeEventListener("visibilitychange",this._handleVisibilityChange.bind(this),!1)}_handleVisibilityChange(){this.logger.log("Visibility change detected"),document.hidden?this._pauseOnBlur&&this.running&&(this._isPaused=!0,this.stop(),this.logger.log("Paused due to tab visibility change")):this._isPaused&&(this._isPaused=!1,this.start(),this.logger.log("Resumed after tab visibility change"))}}Ce=new WeakMap;De=new WeakMap;const Rt={button:{default:{bg:"rgba(0, 0, 0, 0.85)",stroke:"rgba(0, 255, 0, 0.4)",text:"#0f0"},hover:{bg:"#0f0",stroke:"#0f0",text:"#000"},pressed:{bg:"#0c0",stroke:"#0f0",text:"#000"},active:{bg:"rgba(0, 255, 0, 0.15)",stroke:"#0f0",text:"#0f0"}}};class rn extends ue{constructor(t,e={}){super(t,e);const{x:i=0,y:s=0,width:n=120,height:o=40,text:r="Button",font:a="14px monospace",textColor:l="#000",textAlign:h="center",textBaseline:d="middle",shape:u=null,label:f=null,onClick:g=null,onHover:m=null,onPressed:p=null,onRelease:v=null,padding:_=10,colorDefaultBg:w=Rt.button.default.bg,colorDefaultStroke:x=Rt.button.default.stroke,colorDefaultText:S=Rt.button.default.text,colorHoverBg:k=Rt.button.hover.bg,colorHoverStroke:C=Rt.button.hover.stroke,colorHoverText:M=Rt.button.hover.text,colorPressedBg:R=Rt.button.pressed.bg,colorPressedStroke:D=Rt.button.pressed.stroke,colorPressedText:A=Rt.button.pressed.text}=e;this.x=i,this.y=s,this.width=Math.max(n,44),this.height=Math.max(o,44),this.padding=_,this.textAlign=h,this.textBaseline=d,this.initColorScheme({colorDefaultBg:w,colorDefaultStroke:x,colorDefaultText:S,colorHoverBg:k,colorHoverStroke:C,colorHoverText:M,colorPressedBg:R,colorPressedStroke:D,colorPressedText:A}),this.initBackground(u),this.initLabel(r,a,l,f),this.initGroup(),this.initEvents(g,m,p,v),this.setState("default")}initColorScheme(t){this.colors={default:{bg:t.colorDefaultBg,stroke:t.colorDefaultStroke,text:t.colorDefaultText},hover:{bg:t.colorHoverBg,stroke:t.colorHoverStroke,text:t.colorHoverText},pressed:{bg:t.colorPressedBg,stroke:t.colorPressedStroke,text:t.colorPressedText}}}initBackground(t){this.bg=t??new Pi({width:this.width,height:this.height,color:this.colors.default.bg,stroke:this.colors.default.stroke,lineWidth:2})}initLabel(t,e,i,s){this.label=s??new Oi(t,{font:e,color:i,align:this.textAlign,baseline:this.textBaseline}),this.alignText()}alignText(){if(!this.label)return;const t=this.width/2,e=this.height/2,i=(this.label._width||0)/2,s=(this.label._height||0)/2;switch(this.textAlign){case"left":this.label.x=-t+this.padding+i;break;case"right":this.label.x=t-this.padding-i;break;case"center":default:this.label.x=0;break}switch(this.textBaseline){case"top":this.label.y=-e+this.padding+s;break;case"bottom":this.label.y=e-this.padding-s;break;case"middle":default:this.label.y=0;break}}initGroup(){this.group=new Ts,this.group.add(this.bg),this.group.add(this.label)}initEvents(t,e,i,s){this.interactive=!0,this.onHover=e,this.onPressed=i,this.onRelease=s,this._pointerOver=!1,this._isTouch=!1,this.on("mouseover",n=>{this._pointerOver=!0,this._isTouch||this.setState("hover")}),this.on("mouseout",n=>{this._pointerOver=!1,this._isTouch||this.setState("default")}),this.on("inputdown",n=>{(n.touches||n.nativeEvent&&n.nativeEvent.type==="touchstart")&&(this._isTouch=!0,n.nativeEvent&&n.nativeEvent.preventDefault()),this._pointerOver=!0,this.setState("pressed")}),this.on("inputup",n=>{const o=this.state==="pressed";(n.touches||n.nativeEvent&&n.nativeEvent.type==="touchend")&&(n.nativeEvent&&n.nativeEvent.preventDefault(),this._isTouch=!0);const r=this._hitTest&&this._hitTest(n.x,n.y);o&&r&&typeof t=="function"&&t(),r&&!this._isTouch?this.setState("hover"):(this.setState("default"),this._isTouch&&setTimeout(()=>{this._isTouch=!1},300))}),this.on("inputmove",n=>{this._hitTest&&this._hitTest(n.x,n.y)?this._pointerOver=!0:(this._pointerOver=!1,this.state==="hover"&&!this._isTouch&&this.setState("default"))})}setState(t){var e,i,s;if(this.state!==t)switch(this.state=t,t){case"default":this.game.cursor&&setTimeout(()=>{this.game.cursor.activate()},0),this.bg.color=this.colors.default.bg,this.bg.stroke=this.colors.default.stroke,this.label.color=this.colors.default.text,this.game.canvas.style.cursor="default",(e=this.onRelease)==null||e.call(this);break;case"hover":this.game.cursor&&this.game.cursor.deactivate(),this.bg.color=this.colors.hover.bg,this.bg.stroke=this.colors.hover.stroke,this.label.color=this.colors.hover.text,this.game.canvas.style.cursor="pointer",(i=this.onHover)==null||i.call(this);break;case"pressed":this.game.cursor&&this.game.cursor.deactivate(),this.bg.color=this.colors.pressed.bg,this.bg.stroke=this.colors.pressed.stroke,this.label.color=this.colors.pressed.text,this.game.canvas.style.cursor="pointer",(s=this.onPressed)==null||s.call(this);break}}update(t){super.update(t),this._boundsDirty&&this.alignText()}get text(){return this.label.text}set text(t){this.label.text=t,this._boundsDirty=!0}setTextAlign(t){this.textAlign=t,this.label.align=t,this._boundsDirty=!0}setTextBaseline(t){this.textBaseline=t,this.label.baseline=t,this._boundsDirty=!0}setFont(t){this.label.font=t,this._boundsDirty=!0}resize(t,e){this.width=t,this.height=e,this.bg.width=t,this.bg.height=e,this._boundsDirty=!0}getBounds(){return{x:this.x,y:this.y,width:this.width,height:this.height}}draw(){super.draw(),this.group.render()}}class fr extends rn{constructor(t,e={}){const i=e.onClick;super(t,{...e,onClick:()=>{this.toggled=!this.toggled,typeof e.onToggle=="function"&&e.onToggle(this.toggled),typeof i=="function"&&i();const s=this.state;this.refreshToggleVisual(),s&&this.setState(s)}}),this.colorActiveBg=e.colorActiveBg||Rt.button.active.bg,this.colorActiveStroke=e.colorActiveStroke||Rt.button.active.stroke,this.colorActiveText=e.colorActiveText||Rt.button.active.text,this.toggled=!!e.startToggled,this.refreshToggleVisual()}toggle(t){const e=this.state;this.toggled=t,this.refreshToggleVisual(),e&&this.setState(e)}refreshToggleVisual(){this.toggled?(this.bg.color=this.colorActiveBg,this.bg.stroke=this.colorActiveStroke,this.label.color=this.colorActiveText):(this.bg.color=this.colors.default.bg,this.bg.stroke=this.colors.default.stroke,this.label.color=this.colors.default.text)}setState(t){super.setState(t),this.toggled&&(this.bg.color=this.colorActiveBg,this.bg.stroke=this.colorActiveStroke,this.label.color=this.colorActiveText)}}class on{constructor(){this.x=0,this.y=0,this.z=0,this.vx=0,this.vy=0,this.vz=0,this.size=1,this.color={r:255,g:255,b:255,a:1},this.shape="circle",this.age=0,this.lifetime=1,this.alive=!0,this.custom={}}reset(){this.x=0,this.y=0,this.z=0,this.vx=0,this.vy=0,this.vz=0,this.size=1,this.color.r=255,this.color.g=255,this.color.b=255,this.color.a=1,this.shape="circle",this.age=0,this.lifetime=1,this.alive=!0;for(const t in this.custom)delete this.custom[t]}get progress(){return this.lifetime>0?this.age/this.lifetime:1}}class an{constructor(t={}){this.rate=t.rate??10,this.position={x:0,y:0,z:0,...t.position},this.spread={x:0,y:0,z:0,...t.spread},this.velocity={x:0,y:0,z:0,...t.velocity},this.velocitySpread={x:0,y:0,z:0,...t.velocitySpread},this.lifetime={min:1,max:2,...t.lifetime},this.size={min:1,max:1,...t.size},this.color={r:255,g:255,b:255,a:1,...t.color},this.shape=t.shape??"circle",this.active=t.active!==!1,this._timer=0}_spread(t){return(Math.random()-.5)*2*t}_range(t,e){return t+Math.random()*(e-t)}emit(t){t.x=this.position.x+this._spread(this.spread.x),t.y=this.position.y+this._spread(this.spread.y),t.z=this.position.z+this._spread(this.spread.z),t.vx=this.velocity.x+this._spread(this.velocitySpread.x),t.vy=this.velocity.y+this._spread(this.velocitySpread.y),t.vz=this.velocity.z+this._spread(this.velocitySpread.z),t.lifetime=this._range(this.lifetime.min,this.lifetime.max),t.age=0,t.alive=!0,t.size=this._range(this.size.min,this.size.max),t.color.r=this.color.r,t.color.g=this.color.g,t.color.b=this.color.b,t.color.a=this.color.a,t.shape=this.shape}update(t){if(!this.active||this.rate<=0)return 0;this._timer+=t;const e=1/this.rate;let i=0;for(;this._timer>=e;)this._timer-=e,i++;return i}reset(){this._timer=0}}const Le={velocity:(c,t)=>{c.x+=c.vx*t,c.y+=c.vy*t,c.z+=c.vz*t},lifetime:(c,t)=>{c.age+=t,c.age>=c.lifetime&&(c.alive=!1)},gravity:(c=200)=>(t,e)=>{t.vy+=c*e},rise:(c=100)=>(t,e)=>{t.vy-=c*e},damping:(c=.98)=>(t,e)=>{t.vx*=c,t.vy*=c,t.vz*=c},fadeOut:(c,t)=>{c.color.a=Math.max(0,1-c.progress)},fadeInOut:(c,t)=>{const e=c.progress;c.color.a=e<.5?e*2:(1-e)*2},shrink:(c=0)=>(t,e)=>{t.custom._initialSize===void 0&&(t.custom._initialSize=t.size),t.size=t.custom._initialSize*(1-t.progress*(1-c))},grow:(c=2)=>(t,e)=>{t.custom._initialSize===void 0&&(t.custom._initialSize=t.size),t.size=t.custom._initialSize*(1+t.progress*(c-1))},colorOverLife:(c,t)=>(e,i)=>{const s=e.progress;e.color.r=Math.floor(c.r+(t.r-c.r)*s),e.color.g=Math.floor(c.g+(t.g-c.g)*s),e.color.b=Math.floor(c.b+(t.b-c.b)*s)},wobble:(c=10)=>(t,e)=>{t.vx+=(Math.random()-.5)*c*e,t.vy+=(Math.random()-.5)*c*e},bounds:(c,t=.8)=>(e,i)=>{e.x<c.left?(e.x=c.left,e.vx=Math.abs(e.vx)*t):e.x>c.right&&(e.x=c.right,e.vx=-Math.abs(e.vx)*t),e.y<c.top?(e.y=c.top,e.vy=Math.abs(e.vy)*t):e.y>c.bottom&&(e.y=c.bottom,e.vy=-Math.abs(e.vy)*t)},attract:(c,t=100)=>(e,i)=>{const s=c.x-e.x,n=c.y-e.y,o=(c.z??0)-e.z,r=Math.sqrt(s*s+n*n+o*o);if(r>1){const a=t*i/r;e.vx+=s*a,e.vy+=n*a,e.vz+=o*a}}},ln=`
precision highp float;

attribute vec2 aPosition;   // Screen position (pixels, already projected)
attribute float aSize;      // Point size in pixels
attribute vec4 aColor;      // RGBA color (0-1 range)

varying vec4 vColor;

uniform vec2 uResolution;   // Canvas dimensions

void main() {
    // Convert from pixel coords to clip space (-1 to 1)
    vec2 clipPos = (aPosition / uResolution) * 2.0 - 1.0;
    clipPos.y = -clipPos.y;  // Flip Y (canvas Y is down, GL Y is up)

    gl_Position = vec4(clipPos, 0.0, 1.0);
    gl_PointSize = aSize;
    vColor = aColor;
}
`,cn=`
precision mediump float;

varying vec4 vColor;

void main() {
    // gl_PointCoord is 0-1 UV within the point quad
    vec2 coord = gl_PointCoord - vec2(0.5);
    float dist = length(coord);

    // Discard pixels outside circle
    if (dist > 0.5) {
        discard;
    }

    // Soft edge for anti-aliasing
    float alpha = vColor.a * (1.0 - smoothstep(0.4, 0.5, dist));
    gl_FragColor = vec4(vColor.rgb, alpha);
}
`,hn=`
precision mediump float;

varying vec4 vColor;

void main() {
    vec2 coord = gl_PointCoord - vec2(0.5);
    float dist = length(coord);

    if (dist > 0.5) {
        discard;
    }

    // Radial falloff for glow effect
    float glow = 1.0 - (dist * 2.0);
    glow = glow * glow;  // Quadratic falloff

    float alpha = vColor.a * glow;
    vec3 color = vColor.rgb * (0.5 + glow * 0.5);  // Brighten center

    gl_FragColor = vec4(color, alpha);
}
`,un=`
precision mediump float;

varying vec4 vColor;

void main() {
    gl_FragColor = vColor;
}
`,dn=`
precision mediump float;

varying vec4 vColor;

void main() {
    vec2 coord = abs(gl_PointCoord - vec2(0.5)) * 2.0;  // 0 at center, 1 at edge
    float d = max(coord.x, coord.y);

    // Soft edge
    float alpha = vColor.a * (1.0 - smoothstep(0.8, 1.0, d));
    gl_FragColor = vec4(vColor.rgb, alpha);
}
`;class fn{constructor(t=1e4,e={}){if(this.maxParticles=t,this.width=e.width||800,this.height=e.height||600,this.shape=e.shape||"circle",this.blendMode=e.blendMode||"alpha",this.canvas=document.createElement("canvas"),this.canvas.width=this.width,this.canvas.height=this.height,this.gl=this.canvas.getContext("webgl",{alpha:!0,premultipliedAlpha:!0,antialias:!1,preserveDrawingBuffer:!0}),!this.gl){console.warn("WebGL not available for particle rendering"),this.available=!1;return}this.available=!0,this._positions=new Float32Array(t*2),this._sizes=new Float32Array(t),this._colors=new Float32Array(t*4),this._initGL(),this._createBuffers(),this._compileShaders(),this._setupBlending()}isAvailable(){return this.available}_initGL(){const t=this.gl;t.viewport(0,0,this.width,this.height),t.enable(t.BLEND)}_setupBlending(){const t=this.gl;this.blendMode==="additive"?t.blendFunc(t.ONE,t.ONE):t.blendFunc(t.ONE,t.ONE_MINUS_SRC_ALPHA)}setBlendMode(t){this.blendMode=t,this.available&&this._setupBlending()}_createBuffers(){const t=this.gl;this.positionBuffer=t.createBuffer(),t.bindBuffer(t.ARRAY_BUFFER,this.positionBuffer),t.bufferData(t.ARRAY_BUFFER,this._positions,t.DYNAMIC_DRAW),this.sizeBuffer=t.createBuffer(),t.bindBuffer(t.ARRAY_BUFFER,this.sizeBuffer),t.bufferData(t.ARRAY_BUFFER,this._sizes,t.DYNAMIC_DRAW),this.colorBuffer=t.createBuffer(),t.bindBuffer(t.ARRAY_BUFFER,this.colorBuffer),t.bufferData(t.ARRAY_BUFFER,this._colors,t.DYNAMIC_DRAW)}_compileShaders(){const t=this.gl;let e;switch(this.shape){case"glow":e=hn;break;case"square":e=un;break;case"softSquare":e=dn;break;case"circle":default:e=cn;break}const i=t.createShader(t.VERTEX_SHADER);if(t.shaderSource(i,ln),t.compileShader(i),!t.getShaderParameter(i,t.COMPILE_STATUS)){console.error("Vertex shader error:",t.getShaderInfoLog(i)),this.available=!1;return}const s=t.createShader(t.FRAGMENT_SHADER);if(t.shaderSource(s,e),t.compileShader(s),!t.getShaderParameter(s,t.COMPILE_STATUS)){console.error("Fragment shader error:",t.getShaderInfoLog(s)),this.available=!1;return}if(this.program=t.createProgram(),t.attachShader(this.program,i),t.attachShader(this.program,s),t.linkProgram(this.program),!t.getProgramParameter(this.program,t.LINK_STATUS)){console.error("Program link error:",t.getProgramInfoLog(this.program)),this.available=!1;return}t.useProgram(this.program),this.aPosition=t.getAttribLocation(this.program,"aPosition"),this.aSize=t.getAttribLocation(this.program,"aSize"),this.aColor=t.getAttribLocation(this.program,"aColor"),this.uResolution=t.getUniformLocation(this.program,"uResolution"),t.uniform2f(this.uResolution,this.width,this.height),t.deleteShader(i),t.deleteShader(s)}setShape(t){t!==this.shape&&(this.shape=t,this.available&&(this.program&&this.gl.deleteProgram(this.program),this._compileShaders()))}resize(t,e){if(this.width=t,this.height=e,this.canvas.width=t,this.canvas.height=e,this.available){const i=this.gl;i.viewport(0,0,t,e),i.useProgram(this.program),i.uniform2f(this.uResolution,t,e)}}updateParticles(t){if(!this.available)return 0;const e=Math.min(t.length,this.maxParticles),i=this.gl;for(let s=0;s<e;s++){const n=t[s],o=s*2,r=s*4;this._positions[o]=n.x,this._positions[o+1]=n.y,this._sizes[s]=n.size;const a=n.color,l=a.a!==void 0?a.a:1,h=a.r/255*l,d=a.g/255*l,u=a.b/255*l;this._colors[r]=h,this._colors[r+1]=d,this._colors[r+2]=u,this._colors[r+3]=l}return i.bindBuffer(i.ARRAY_BUFFER,this.positionBuffer),i.bufferSubData(i.ARRAY_BUFFER,0,this._positions.subarray(0,e*2)),i.bindBuffer(i.ARRAY_BUFFER,this.sizeBuffer),i.bufferSubData(i.ARRAY_BUFFER,0,this._sizes.subarray(0,e)),i.bindBuffer(i.ARRAY_BUFFER,this.colorBuffer),i.bufferSubData(i.ARRAY_BUFFER,0,this._colors.subarray(0,e*4)),e}clear(t=0,e=0,i=0,s=0){if(!this.available)return;const n=this.gl;n.clearColor(t,e,i,s),n.clear(n.COLOR_BUFFER_BIT)}render(t){if(!this.available||t===0)return;const e=this.gl;e.useProgram(this.program),e.bindBuffer(e.ARRAY_BUFFER,this.positionBuffer),e.enableVertexAttribArray(this.aPosition),e.vertexAttribPointer(this.aPosition,2,e.FLOAT,!1,0,0),e.bindBuffer(e.ARRAY_BUFFER,this.sizeBuffer),e.enableVertexAttribArray(this.aSize),e.vertexAttribPointer(this.aSize,1,e.FLOAT,!1,0,0),e.bindBuffer(e.ARRAY_BUFFER,this.colorBuffer),e.enableVertexAttribArray(this.aColor),e.vertexAttribPointer(this.aColor,4,e.FLOAT,!1,0,0),e.drawArrays(e.POINTS,0,t)}compositeOnto(t,e=0,i=0,s,n){this.available&&t.drawImage(this.canvas,e,i,s??this.canvas.width,n??this.canvas.height)}getCanvas(){return this.canvas}destroy(){if(!this.available)return;const t=this.gl;this.program&&t.deleteProgram(this.program),t.deleteBuffer(this.positionBuffer),t.deleteBuffer(this.sizeBuffer),t.deleteBuffer(this.colorBuffer),this._positions=null,this._sizes=null,this._colors=null}}class gn extends ue{constructor(t,e={}){super(t,e),this.particles=[],this.pool=[],this.maxParticles=e.maxParticles??5e3,this.emitters=new Map,this.camera=e.camera??null,this.depthSort=e.depthSort??!1,this.updaters=e.updaters??[Le.velocity,Le.lifetime],this.blendMode=e.blendMode??"source-over",this.worldSpace=e.worldSpace??!1,this.webglRenderer=null,e.webglRenderer?this.webglRenderer=e.webglRenderer:e.useWebGL&&(this.webglRenderer=new fn(this.maxParticles,{width:t.width,height:t.height,shape:e.webglShape??"circle",blendMode:e.webglBlendMode??"alpha"}),this.webglRenderer.isAvailable()||(console.warn("WebGL not available, falling back to Canvas 2D"),this.webglRenderer=null)),this.depthShading=e.depthShading??!1,this.depthShadingMin=e.depthShadingMin??.3,this.depthShadingMax=e.depthShadingMax??1,this.webglOffset=e.webglOffset??null,this._webglRenderList=[],this._particleCount=0}addEmitter(t,e){return this.emitters.set(t,e),this}removeEmitter(t){return this.emitters.delete(t),this}getEmitter(t){return this.emitters.get(t)}acquire(){return this.pool.length>0?this.pool.pop():new on}release(t){t.reset(),this.pool.push(t)}emit(t,e){for(let i=0;i<t&&this.particles.length<this.maxParticles;i++){const s=this.acquire();e.emit(s),this.particles.push(s)}}burst(t,e){const i=typeof e=="string"?this.emitters.get(e):e;i&&this.emit(t,i)}update(t){super.update(t);for(const e of this.emitters.values())if(e.active){const i=e.update(t);this.emit(i,e)}for(let e=this.particles.length-1;e>=0;e--){const i=this.particles[e];for(const s of this.updaters)s(i,t,this);i.alive||(this.release(i),this.particles.splice(e,1))}this._particleCount=this.particles.length}render(){super.render(),this.particles.length!==0&&(this.webglRenderer?this.renderWebGL():this.camera&&this.depthSort?this.renderWithDepthSort():this.renderSimple())}renderWebGL(){var t,e;const i=this.webglRenderer,s=this._webglRenderList;(i.width!==this.game.width||i.height!==this.game.height)&&i.resize(this.game.width,this.game.height),s.length=0;const n=this.game.width/2,o=this.game.height/2;if(this.camera&&this.depthSort){for(const h of this.particles){const d=this.camera.project(h.x,h.y,h.z);d.z<-this.camera.perspective+10||s.push({x:n+d.x,y:o+d.y,z:d.z,size:h.size*d.scale,color:h.color})}if(s.sort((h,d)=>d.z-h.z),this.depthShading&&s.length>1){let h=1/0,d=-1/0;for(const f of s)f.z<h&&(h=f.z),f.z>d&&(d=f.z);const u=d-h;if(u>0){const f=this.depthShadingMax-this.depthShadingMin;for(const g of s){const m=(d-g.z)/u,p=this.depthShadingMin+m*f;g.color={r:g.color.r*p,g:g.color.g*p,b:g.color.b*p,a:g.color.a}}}}}else{const h=((t=this.webglOffset)==null?void 0:t.x)??0,d=((e=this.webglOffset)==null?void 0:e.y)??0;for(const u of this.particles)s.push({x:u.x+h,y:u.y+d,size:u.size,color:u.color})}i.clear();const r=i.updateParticles(s);i.render(r);const a=this.webglOffset?-this.webglOffset.x:0,l=this.webglOffset?-this.webglOffset.y:0;y.useCtx(h=>{h.globalCompositeOperation=this.blendMode,i.compositeOnto(h,a,l),h.globalCompositeOperation="source-over"})}renderSimple(){y.useCtx(t=>{t.globalCompositeOperation=this.blendMode;for(const e of this.particles)this.drawParticle(t,e,e.x,e.y,1);t.globalCompositeOperation="source-over"})}renderWithDepthSort(){const t=[];for(const e of this.particles){const i=this.camera.project(e.x,e.y,e.z);i.z<-this.camera.perspective+10||t.push({p:e,x:i.x,y:i.y,z:i.z,scale:i.scale})}t.sort((e,i)=>i.z-e.z),y.useCtx(e=>{e.globalCompositeOperation=this.blendMode;const i=this.parent&&this.parent.constructor.name==="Scene3D";!this.worldSpace&&!i&&(e.save(),e.translate(this.game.width/2,this.game.height/2));for(const s of t)this.drawParticle(e,s.p,s.x,s.y,s.scale);!this.worldSpace&&!i&&e.restore(),e.globalCompositeOperation="source-over"})}drawParticle(t,e,i,s,n){const{r:o,g:r,b:a,a:l}=e.color,h=e.size*n;if(h<.5||l<=0)return;t.fillStyle=`rgba(${Math.floor(o)},${Math.floor(r)},${Math.floor(a)},${l})`;const d=e.shape??"circle",u=h/2;t.beginPath(),d==="circle"?t.arc(i,s,u,0,Math.PI*2):d==="square"?t.rect(i-u,s-u,h,h):d==="triangle"&&(t.moveTo(i,s-u),t.lineTo(i+u,s+u),t.lineTo(i-u,s+u),t.closePath()),t.fill()}clear(){for(const t of this.particles)this.release(t);this.particles=[],this._particleCount=0}destroy(){this.clear(),this.webglRenderer&&(this.webglRenderer.destroy(),this.webglRenderer=null),this.pool=[],this.emitters.clear()}get isWebGL(){return this.webglRenderer!==null&&this.webglRenderer.isAvailable()}get particleCount(){return this._particleCount}get poolSize(){return this.pool.length}}class St{static rectRect(t,e){return t.x<e.x+e.width&&t.x+t.width>e.x&&t.y<e.y+e.height&&t.y+t.height>e.y}static intersects(t,e){return St.rectRect(t,e)}static pointRect(t,e,i){return t>=i.x&&t<=i.x+i.width&&e>=i.y&&e<=i.y+i.height}static circleCircle(t,e){const i=t.x-e.x,s=t.y-e.y,n=i*i+s*s,o=t.radius+e.radius;return n<=o*o}static getCircleOverlap(t,e){const i=t.x-e.x,s=t.y-e.y,n=i*i+s*s,o=t.radius+e.radius;if(n>=o*o||n<1e-4)return null;const r=Math.sqrt(n),a=o-r,l=1/r;return{overlap:a,nx:i*l,ny:s*l,dist:r}}static applyCircleSeparation(t,e,i={}){const s=i.strength??5e3,n=i.useSizeAsRadius??!0,o=t.length;for(let r=0;r<o;r++){const a=t[r],l=n?a.size*.5:a.radius??10;for(let h=r+1;h<o;h++){const d=t[h],u=n?d.size*.5:d.radius??10,f=St.getCircleOverlap({x:a.x,y:a.y,radius:l},{x:d.x,y:d.y,radius:u});if(f){const g=s*(f.overlap/(l+u)),m=f.nx*g,p=f.ny*g;e[r].x+=m,e[r].y+=p,e[h].x-=m,e[h].y-=p}}}}static pointCircle(t,e,i){const s=t-i.x,n=e-i.y;return s*s+n*n<=i.radius*i.radius}static circleRect(t,e){const i=Math.max(e.x,Math.min(t.x,e.x+e.width)),s=Math.max(e.y,Math.min(t.y,e.y+e.height)),n=t.x-i,o=t.y-s;return n*n+o*o<=t.radius*t.radius}static lineRect(t,e,i,s,n,o=0){const r=n.x-o/2,a=n.y-o/2,l=n.width+o,h=n.height+o;if(St.pointRect(t,e,{x:r,y:a,width:l,height:h})||St.pointRect(i,s,{x:r,y:a,width:l,height:h}))return!0;const d=St.lineLine(t,e,i,s,r,a,r,a+h),u=St.lineLine(t,e,i,s,r+l,a,r+l,a+h),f=St.lineLine(t,e,i,s,r,a,r+l,a),g=St.lineLine(t,e,i,s,r,a+h,r+l,a+h);return d||u||f||g}static lineLine(t,e,i,s,n,o,r,a){const l=(a-o)*(i-t)-(r-n)*(s-e);if(l===0)return!1;const h=((r-n)*(e-o)-(a-o)*(t-n))/l,d=((i-t)*(e-o)-(s-e)*(t-n))/l;return h>=0&&h<=1&&d>=0&&d<=1}static segmentsRect(t,e,i=0){for(const s of t)if(St.lineRect(s.x1,s.y1,s.x2,s.y2,e,i))return!0;return!1}static getOverlap(t,e){if(!St.rectRect(t,e))return null;const i=Math.min(t.x+t.width,e.x+e.width)-Math.max(t.x,e.x),s=Math.min(t.y+t.height,e.y+e.height)-Math.max(t.y,e.y);return{x:i,y:s}}static getMTV(t,e){const i=St.getOverlap(t,e);if(!i)return null;const s=t.x+t.width/2,n=t.y+t.height/2,o=e.x+e.width/2,r=e.y+e.height/2,a=s<o?-i.x:i.x,l=n<r?-i.y:i.y;return Math.abs(i.x)<Math.abs(i.y)?{x:a,y:0}:{x:0,y:l}}static sweep(t,e,i,s){const n={x:s.x-t.width/2,y:s.y-t.height/2,width:s.width+t.width,height:s.height+t.height},o=t.x+t.width/2,r=t.y+t.height/2;let a,l,h,d;e!==0?(a=(n.x-o)/e,l=(n.x+n.width-o)/e,a>l&&([a,l]=[l,a])):(a=o>=n.x&&o<=n.x+n.width?-1/0:1/0,l=o>=n.x&&o<=n.x+n.width?1/0:-1/0),i!==0?(h=(n.y-r)/i,d=(n.y+n.height-r)/i,h>d&&([h,d]=[d,h])):(h=r>=n.y&&r<=n.y+n.height?-1/0:1/0,d=r>=n.y&&r<=n.y+n.height?1/0:-1/0);const u=Math.max(a,h),f=Math.min(l,d);if(u>f||u<0||u>1)return null;let g=0,m=0;return a>h?g=e>0?-1:1:m=i>0?-1:1,{time:u,normalX:g,normalY:m}}}const ee={maxParticles:500,particleSize:20,particleColor:{r:100,g:180,b:255,a:.9},physics:"liquid",gravity:200,damping:.98,bounce:.3,maxSpeed:400,fluid:{smoothingRadius:null,restDensity:3,pressureStiffness:80,nearPressureStiffness:3,viscosity:.005,maxForce:5e3},gas:{interactionRadius:null,pressure:150,diffusion:.15,drag:.02,turbulence:50,buoyancy:300,sinking:200,repulsion:300},heat:{enabled:!1,heatZone:.88,coolZone:.25,rate:.03,heatMultiplier:1.5,coolMultiplier:2,middleMultiplier:.005,transitionWidth:.08,neutralTemp:.5,deadZone:.15,buoyancy:300,sinking:200},collision:{enabled:!0,strength:5e3},boundary:{enabled:!0,strength:4e3,radius:null},shake:{enabled:!0,sensitivity:2,maxForce:2500,damping:.8},blendMode:"source-over"};class Yi extends gn{constructor(t,e={}){var i,s,n,o;const r=Yi._mergeConfig(e),a=((i=e.bounds)==null?void 0:i.x)??0,l=((s=e.bounds)==null?void 0:s.y)??0,h=e.width??((n=e.bounds)==null?void 0:n.w)??0,d=e.height??((o=e.bounds)==null?void 0:o.h)??0;super(t,{maxParticles:r.maxParticles,blendMode:r.blendMode,updaters:[Le.velocity,Le.lifetime],x:e.x??a+h/2,y:e.y??l+d/2,width:h,height:d,debug:e.debug??!1,debugColor:e.debugColor??"#0f0"}),this.config=r,this.bounds=e.bounds||null,this.gravityEnabled=e.gravityEnabled??!0,this.modeMix=r.physics==="gas"?1:0,this._targetMode=this.modeMix,this._modeLerpSpeed=5,this._forces=[],this._shake={lastX:window.screenX,lastY:window.screenY,velocityX:0,velocityY:0,forceX:0,forceY:0},this._createEmitter()}static _mergeConfig(t){const e={...ee,...t},i=e.particleSize;return e.fluid={...ee.fluid,...t.fluid},e.gas={...ee.gas,...t.gas},e.heat={...ee.heat,...t.heat},e.collision={...ee.collision,...t.collision},e.boundary={...ee.boundary,...t.boundary},e.shake={...ee.shake,...t.shake},e.fluid.smoothingRadius===null&&(e.fluid.smoothingRadius=i*2),e.gas.interactionRadius===null&&(e.gas.interactionRadius=i*4),e.boundary.radius===null&&(e.boundary.radius=i*.8),e}_createEmitter(){const{particleSize:t,particleColor:e}=this.config,i=new an({rate:0,position:{x:0,y:0},spread:{x:100,y:100},velocity:{x:0,y:0},velocitySpread:{x:10,y:10},size:{min:t,max:t+2},lifetime:{min:99999,max:99999},color:e,shape:"circle"});this.addEmitter("fluid",i)}spawn(t,e={}){const i=this.emitters.get("fluid");if(!i)return;let s=e.x,n=e.y,o=e.spreadX??100,r=e.spreadY??100;this.bounds&&s===void 0&&(s=this.bounds.x+this.bounds.w/2,n=this.bounds.y+this.bounds.h*.6,o=Math.min(this.bounds.w*.8,400),r=Math.min(this.bounds.h*.5,250)),i.position.x=s??this.game.width/2,i.position.y=n??this.game.height/2,i.spread.x=o,i.spread.y=r,this.burst(t,"fluid");for(const a of this.particles)a.custom.initialized||(a.custom.initialized=!0,a.custom.mass=1,a.custom.temperature=.5,a.vx=(Math.random()-.5)*20,a.vy=(Math.random()-.5)*20)}setBounds(t){this.bounds=t,this.x=t.x+t.w/2,this.y=t.y+t.h/2,this.width=t.w,this.height=t.h}update(t){t=Math.min(t,.033),this.modeMix=lt.lerp(this.modeMix,this._targetMode,t*this._modeLerpSpeed);const e=this.particles;if(e.length===0){super.update(t);return}this._ensureForceArray(e.length),this._resetForces(),this._computePhysicsForces(e),this.modeMix>.5&&((this.config.heat.enabled||this.modeMix>.95)&&(this._updateTemperatures(e),this._applyThermalForces(e)),this.modeMix>.95&&this._applyGasRepulsion(e)),this.config.collision.enabled&&St.applyCircleSeparation(e,this._forces,{strength:this.config.collision.strength,useSizeAsRadius:!0}),this.bounds&&this.config.boundary.enabled&&this._applyBoundaryForces(e),this.config.shake.enabled&&(this._updateShakeForces(t),this._applyShakeForces()),this._integrateForces(e,t),super.update(t),this.bounds&&this._clampBounds(e)}_ensureForceArray(t){for(;this._forces.length<t;)this._forces.push({x:0,y:0})}_resetForces(){for(let t=0;t<this._forces.length;t++)this._forces[t].x=0,this._forces[t].y=0}_computePhysicsForces(t){const{fluid:e,gas:i}=this.config;if(this.modeMix<.01){const s=_i(t,{kernel:{smoothingRadius:e.smoothingRadius},fluid:{restDensity:e.restDensity,pressureStiffness:e.pressureStiffness,nearPressureStiffness:e.nearPressureStiffness,viscosity:e.viscosity,maxForce:e.maxForce}});this._accumulateForces(s.forces)}else if(this.modeMix>.95){const s=bi(t,{gas:{interactionRadius:i.interactionRadius,pressure:i.pressure,diffusion:i.diffusion,drag:i.drag,turbulence:i.turbulence,buoyancy:i.buoyancy}});this._accumulateForces(s.forces)}else{const s=_i(t,{kernel:{smoothingRadius:e.smoothingRadius},fluid:e}),n=bi(t,{gas:i}),o=ds(s.forces,n.forces,this.modeMix);this._accumulateForces(o)}}_accumulateForces(t){const e=Math.min(t.length,this._forces.length);for(let i=0;i<e;i++)this._forces[i].x+=t[i].x,this._forces[i].y+=t[i].y}_applyBoundaryForces(t){const{x:e,y:i,w:s,h:n}=this.bounds,{radius:o,strength:r}=this.config.boundary,a=e,l=e+s,h=i,d=i+n;for(let u=0;u<t.length;u++){const f=t[u],g=f.size*.5,m=f.x-g-a,p=l-f.x-g,v=f.y-g-h,_=d-f.y-g;if(m<o){const w=Math.max(0,1-m/o);this._forces[u].x+=r*w*w}if(p<o){const w=Math.max(0,1-p/o);this._forces[u].x-=r*w*w}if(v<o){const w=Math.max(0,1-v/o);this._forces[u].y+=r*w*w}if(_<o){const w=Math.max(0,1-_/o);this._forces[u].y-=r*w*w}}}_updateTemperatures(t){if(!this.bounds)return;const{heat:e}=this.config,i=this.bounds.y,s=this.bounds.h;for(let n=0;n<t.length;n++){const o=t[n],r=o.custom.temperature??e.neutralTemp,a=Math.min(1,Math.max(0,(o.y-i)/s)),l=cs(a,r,e);o.custom.temperature=Math.min(1,Math.max(0,l))}}_applyThermalForces(t){const{heat:e}=this.config,i=e.neutralTemp,s=e.deadZone;for(let n=0;n<t.length;n++){const a=(t[n].custom.temperature??i)-i;if(Math.abs(a)>s){let l=0;a>0?l=-(a-s)*e.buoyancy*2:l=(-a-s)*e.sinking*2,this._forces[n].y+=l}}}_applyGasRepulsion(t){const{gas:e}=this.config,i=e.interactionRadius,s=i*i,n=e.repulsion||200,o=t.length;for(let r=0;r<o;r++){const a=t[r];for(let l=r+1;l<o;l++){const h=t[l],d=a.x-h.x,u=a.y-h.y,f=d*d+u*u;if(f>=s||f<1)continue;const g=Math.sqrt(f),m=1-g/i,p=n*m*m*m,v=d/g*p,_=u/g*p;this._forces[r].x+=v,this._forces[r].y+=_,this._forces[l].x-=v,this._forces[l].y-=_}}}_updateShakeForces(t){const{shake:e}=this.config;if(!e.enabled)return;const i=window.screenX,s=window.screenY,n=i-this._shake.lastX,o=s-this._shake.lastY;t>0&&t<.1&&(this._shake.velocityX=n/t,this._shake.velocityY=o/t),this._shake.lastX=i,this._shake.lastY=s;const r=-this._shake.velocityX*e.sensitivity,a=-this._shake.velocityY*e.sensitivity;this._shake.forceX=lt.lerp(this._shake.forceX,r,1-e.damping),this._shake.forceY=lt.lerp(this._shake.forceY,a,1-e.damping);const l=Math.sqrt(this._shake.forceX*this._shake.forceX+this._shake.forceY*this._shake.forceY);if(l>e.maxForce){const h=e.maxForce/l;this._shake.forceX*=h,this._shake.forceY*=h}}_applyShakeForces(){const t=this._shake.forceX,e=this._shake.forceY;if(!(Math.abs(t)<1&&Math.abs(e)<1))for(let i=0;i<this._forces.length;i++)this._forces[i].x+=t,this._forces[i].y+=e}_integrateForces(t,e){const{gravity:i,damping:s,maxSpeed:n,heat:o}=this.config,r=n*n,l=lt.lerp(s,.995,this.modeMix);for(let h=0;h<t.length;h++){const d=t[h],u=this._forces[h],f=d.custom.mass||1;let g,m;if(this.modeMix>.5){const v=d.custom.temperature??o.neutralTemp;g=f*lt.lerp(1.5,.3,v),m=this.gravityEnabled?i*lt.lerp(1.2,.6,v):0}else g=f,m=this.gravityEnabled?i:0;d.vx+=u.x/g*e,d.vy+=(u.y/g+m)*e,d.vx*=l,d.vy*=l;const p=d.vx*d.vx+d.vy*d.vy;if(p>r){const v=n/Math.sqrt(p);d.vx*=v,d.vy*=v}}}_clampBounds(t){const{x:e,y:i,w:s,h:n}=this.bounds,{bounce:o}=this.config;for(let r=0;r<t.length;r++){const a=t[r],l=a.size*.5,h=e+l,d=e+s-l,u=i+l,f=i+n-l;a.x<h?(a.x=h,a.vx=Math.abs(a.vx)*o):a.x>d&&(a.x=d,a.vx=-Math.abs(a.vx)*o),a.y<u?(a.y=u,a.vy=Math.abs(a.vy)*o):a.y>f&&(a.y=f,a.vy=-Math.abs(a.vy)*o)}}reset(){const t=this.particles.length;this.particles.length=0,this._forces.length=0,this.spawn(t)}toggleGravity(){return this.gravityEnabled=!this.gravityEnabled,this.gravityEnabled}setPhysicsMode(t,e=!1){let i;if(t==="liquid")i=0;else if(t==="gas")i=1;else if(typeof t=="number")i=Math.max(0,Math.min(1,t));else return;this._targetMode=i,e&&(this.modeMix=i)}getPhysicsMode(){return this.modeMix<.01?"liquid":this.modeMix>.99?"gas":"blending"}isHeatEnabled(){return this.config.heat.enabled||this.modeMix>.5}}class Xi{static applyADSR(t,e={}){const{attack:i=.01,decay:s=.1,sustain:n=.7,release:o=.2,startTime:r=0,duration:a=1,peakVolume:l=1}=e,h=l*n,d=Math.max(0,a-i-s);t.setValueAtTime(0,r),t.linearRampToValueAtTime(l,r+i),t.linearRampToValueAtTime(h,r+i+s),t.setValueAtTime(h,r+i+s+d),t.linearRampToValueAtTime(0,r+a+o)}static get presets(){return{pluck:{attack:.001,decay:.2,sustain:0,release:.1},pad:{attack:.5,decay:.3,sustain:.8,release:1},organ:{attack:.01,decay:0,sustain:1,release:.05},perc:{attack:.001,decay:.1,sustain:0,release:.05},string:{attack:.1,decay:.2,sustain:.7,release:.3},brass:{attack:.05,decay:.1,sustain:.8,release:.2},blip:{attack:.001,decay:.05,sustain:0,release:.02},laser:{attack:.001,decay:.15,sustain:0,release:.05},explosion:{attack:.001,decay:.3,sustain:.2,release:.5}}}}class Oe{static init(t,e){q(this,U,t),q(this,qt,e)}static get ctx(){return b(this,U)}static get now(){return b(this,U).currentTime}static tone(t,e,i={}){const{type:s="sine",volume:n=.5,attack:o=.01,decay:r=.1,sustain:a=.7,release:l=.2,detune:h=0,startTime:d=b(this,U).currentTime}=i,u=b(this,U).createOscillator(),f=b(this,U).createGain();return u.type=s,u.frequency.setValueAtTime(t,d),u.detune.setValueAtTime(h,d),Xi.applyADSR(f.gain,{attack:o,decay:r,sustain:a,release:l,startTime:d,duration:e,peakVolume:n}),u.connect(f),f.connect(b(this,qt)),u.start(d),u.stop(d+e+l),u}static continuous(t={}){const{type:e="sine",frequency:i=440,volume:s=.5}=t,n=b(this,U).createOscillator(),o=b(this,U).createGain();n.type=e,n.frequency.value=i,o.gain.value=s,n.connect(o),o.connect(b(this,qt)),n.start();const r=b(this,U);return{osc:n,gain:o,setFrequency:(a,l=0)=>{l>0?n.frequency.linearRampToValueAtTime(a,r.currentTime+l):n.frequency.setValueAtTime(a,r.currentTime)},setVolume:(a,l=0)=>{l>0?o.gain.linearRampToValueAtTime(a,r.currentTime+l):o.gain.setValueAtTime(a,r.currentTime)},stop:(a=0)=>{a>0?(o.gain.linearRampToValueAtTime(0,r.currentTime+a),n.stop(r.currentTime+a+.01)):n.stop()}}}static fm(t,e,i,s,n={}){const{volume:o=.5,startTime:r=b(this,U).currentTime}=n,a=b(this,U).createOscillator(),l=b(this,U).createOscillator(),h=b(this,U).createGain(),d=b(this,U).createGain();return l.frequency.value=e,h.gain.value=i,a.frequency.value=t,d.gain.value=o,l.connect(h),h.connect(a.frequency),a.connect(d),d.connect(b(this,qt)),d.gain.setValueAtTime(o,r),d.gain.linearRampToValueAtTime(0,r+s),l.start(r),a.start(r),l.stop(r+s+.1),a.stop(r+s+.1),{carrier:a,modulator:l,outputGain:d}}static additive(t,e,i,s={}){const{volume:n=.5,startTime:o=b(this,U).currentTime}=s,r=[],a=b(this,U).createGain();return a.gain.value=n/e.length,a.connect(b(this,qt)),a.gain.setValueAtTime(n/e.length,o),a.gain.linearRampToValueAtTime(0,o+i),e.forEach((l,h)=>{if(l>0){const d=b(this,U).createOscillator(),u=b(this,U).createGain();d.frequency.value=t*(h+1),u.gain.value=l,d.connect(u),u.connect(a),d.start(o),d.stop(o+i+.1),r.push(d)}}),r}static sweep(t,e,i,s={}){const{type:n="sine",volume:o=.5,exponential:r=!0,startTime:a=b(this,U).currentTime}=s,l=b(this,U).createOscillator(),h=b(this,U).createGain();return l.type=n,l.frequency.setValueAtTime(t,a),r&&e>0?l.frequency.exponentialRampToValueAtTime(e,a+i):l.frequency.linearRampToValueAtTime(e,a+i),h.gain.setValueAtTime(o,a),h.gain.linearRampToValueAtTime(0,a+i),l.connect(h),h.connect(b(this,qt)),l.start(a),l.stop(a+i+.01),l}static pulse(t,e,i=.5,s={}){const{volume:n=.5,startTime:o=b(this,U).currentTime}=s,r=b(this,U).createOscillator(),a=b(this,U).createOscillator(),l=b(this,U).createGain(),h=b(this,U).createGain(),d=b(this,U).createGain();return r.type="sawtooth",a.type="sawtooth",r.frequency.value=t,a.frequency.value=t,l.gain.value=.5,h.gain.value=-.5,d.gain.setValueAtTime(n,o),d.gain.linearRampToValueAtTime(0,o+e),r.connect(l),a.connect(h),l.connect(d),h.connect(d),d.connect(b(this,qt)),r.start(o),a.start(o),r.stop(o+e+.01),a.stop(o+e+.01),{osc1:r,osc2:a,output:d}}}U=new WeakMap;qt=new WeakMap;N(Oe,U,null);N(Oe,qt,null);class ze{static init(t,e){q(this,j,t),q(this,Je,e)}static get ctx(){return b(this,j)}static filter(t="lowpass",e=1e3,i=1){const s=b(this,j).createBiquadFilter();return s.type=t,s.frequency.value=e,s.Q.value=i,s}static delay(t=.3,e=.4,i=.5){const s=b(this,j).createDelay(5),n=b(this,j).createGain(),o=b(this,j).createGain(),r=b(this,j).createGain(),a=b(this,j).createGain(),l=b(this,j).createGain();return s.delayTime.value=t,n.gain.value=e,o.gain.value=i,r.gain.value=1-i,a.connect(s),a.connect(r),s.connect(n),n.connect(s),s.connect(o),o.connect(l),r.connect(l),{input:a,output:l,setTime:h=>s.delayTime.setValueAtTime(h,b(this,j).currentTime),setFeedback:h=>n.gain.setValueAtTime(h,b(this,j).currentTime),setMix:h=>{o.gain.setValueAtTime(h,b(this,j).currentTime),r.gain.setValueAtTime(1-h,b(this,j).currentTime)}}}static reverb(t=2,e=2){const i=b(this,j).createConvolver(),s=b(this,j).sampleRate,n=s*t,o=b(this,j).createBuffer(2,n,s);for(let r=0;r<2;r++){const a=o.getChannelData(r);for(let l=0;l<n;l++)a[l]=(Math.random()*2-1)*Math.pow(1-l/n,e)}return i.buffer=o,i}static distortion(t=50){const e=b(this,j).createWaveShaper(),i=t,s=44100,n=new Float32Array(s);for(let o=0;o<s;o++){const r=o*2/s-1;n[o]=(3+i)*r*20*(Math.PI/180)/(Math.PI+i*Math.abs(r))}return e.curve=n,e.oversample="4x",e}static tremolo(t=5,e=.5){const i=b(this,j).createOscillator(),s=b(this,j).createGain(),n=b(this,j).createGain();return i.frequency.value=t,s.gain.value=e*.5,n.gain.value=1-e*.5,i.connect(s),s.connect(n.gain),i.start(),{input:n,output:n,lfo:i,setRate:o=>i.frequency.setValueAtTime(o,b(this,j).currentTime),setDepth:o=>s.gain.setValueAtTime(o*.5,b(this,j).currentTime),stop:()=>i.stop()}}static compressor(t={}){const{threshold:e=-24,knee:i=30,ratio:s=12,attack:n=.003,release:o=.25}=t,r=b(this,j).createDynamicsCompressor();return r.threshold.value=e,r.knee.value=i,r.ratio.value=s,r.attack.value=n,r.release.value=o,r}static panner(t=0){const e=b(this,j).createStereoPanner();return e.pan.value=t,e}static gain(t=1){const e=b(this,j).createGain();return e.gain.value=t,e}}j=new WeakMap;Je=new WeakMap;N(ze,j,null);N(ze,Je,null);class mn{static white(t,e){const i=t.sampleRate*e,s=t.createBuffer(1,i,t.sampleRate),n=s.getChannelData(0);for(let r=0;r<i;r++)n[r]=Math.random()*2-1;const o=t.createBufferSource();return o.buffer=s,o}static pink(t,e){const i=t.sampleRate*e,s=t.createBuffer(1,i,t.sampleRate),n=s.getChannelData(0);let o=0,r=0,a=0,l=0,h=0,d=0,u=0;for(let g=0;g<i;g++){const m=Math.random()*2-1;o=.99886*o+m*.0555179,r=.99332*r+m*.0750759,a=.969*a+m*.153852,l=.8665*l+m*.3104856,h=.55*h+m*.5329522,d=-.7616*d-m*.016898,n[g]=(o+r+a+l+h+d+u+m*.5362)*.11,u=m*.115926}const f=t.createBufferSource();return f.buffer=s,f}static brown(t,e){const i=t.sampleRate*e,s=t.createBuffer(1,i,t.sampleRate),n=s.getChannelData(0);let o=0;for(let a=0;a<i;a++){const l=Math.random()*2-1;n[a]=(o+.02*l)/1.02,o=n[a],n[a]*=3.5}const r=t.createBufferSource();return r.buffer=s,r}}class Fe{static noteToFreq(t){const e=t.match(/^([A-G][#b]?)(\d+)$/);if(!e)throw new Error(`Invalid note: ${t}`);const[,i,s]=e,n=this.NOTE_FREQUENCIES[i];if(n===void 0)throw new Error(`Unknown note: ${i}`);return n*Math.pow(2,parseInt(s))}static scale(t,e="major",i=1){const s=this.noteToFreq(t),n=this.SCALES[e];if(!n)throw new Error(`Unknown scale: ${e}`);const o=[];for(let r=0;r<i;r++)for(const a of n)o.push(s*Math.pow(2,(a+r*12)/12));return o}static chord(t,e="major"){const i=this.noteToFreq(t),s=this.CHORDS[e];if(!s)throw new Error(`Unknown chord type: ${e}`);return s.map(n=>i*Math.pow(2,n/12))}static mapToScale(t,e="C4",i="pentatonic",s=2){const n=this.scale(e,i,s),o=Math.max(0,Math.min(1,t)),r=Math.floor(o*n.length)%n.length;return n[r]}static midiToFreq(t){return 440*Math.pow(2,(t-69)/12)}static freqToMidi(t){return Math.round(12*Math.log2(t/440)+69)}static randomNote(t="C4",e="pentatonic",i=2){const s=this.scale(t,e,i);return s[Math.floor(Math.random()*s.length)]}static detune(t,e){return t*Math.pow(2,e/1200)}}P(Fe,"NOTE_FREQUENCIES",{C:16.35,"C#":17.32,Db:17.32,D:18.35,"D#":19.45,Eb:19.45,E:20.6,F:21.83,"F#":23.12,Gb:23.12,G:24.5,"G#":25.96,Ab:25.96,A:27.5,"A#":29.14,Bb:29.14,B:30.87});P(Fe,"SCALES",{major:[0,2,4,5,7,9,11],minor:[0,2,3,5,7,8,10],pentatonic:[0,2,4,7,9],pentatonicMinor:[0,3,5,7,10],blues:[0,3,5,6,7,10],dorian:[0,2,3,5,7,9,10],mixolydian:[0,2,4,5,7,9,10],chromatic:[0,1,2,3,4,5,6,7,8,9,10,11],wholeTone:[0,2,4,6,8,10],diminished:[0,2,3,5,6,8,9,11]});P(Fe,"CHORDS",{major:[0,4,7],minor:[0,3,7],diminished:[0,3,6],augmented:[0,4,8],sus2:[0,2,7],sus4:[0,5,7],major7:[0,4,7,11],minor7:[0,3,7,10],dom7:[0,4,7,10],dim7:[0,3,6,9],add9:[0,4,7,14],power:[0,7]});class oe{static init(t,e){q(this,we,t),q(this,tt,t.createAnalyser()),b(this,tt).fftSize=2048,e.connect(b(this,tt)),b(this,tt).connect(t.destination),q(this,se,new Uint8Array(b(this,tt).frequencyBinCount)),q(this,ne,new Uint8Array(b(this,tt).frequencyBinCount))}static get isInitialized(){return b(this,tt)!==null}static get node(){return b(this,tt)}static setFFTSize(t){b(this,tt)&&(b(this,tt).fftSize=t,q(this,se,new Uint8Array(b(this,tt).frequencyBinCount)),q(this,ne,new Uint8Array(b(this,tt).frequencyBinCount)))}static getWaveform(){return b(this,tt)?(b(this,tt).getByteTimeDomainData(b(this,se)),b(this,se)):new Uint8Array(0)}static getFrequency(){return b(this,tt)?(b(this,tt).getByteFrequencyData(b(this,ne)),b(this,ne)):new Uint8Array(0)}static getBands(t=8){const e=this.getFrequency();if(e.length===0)return new Array(t).fill(0);const i=Math.floor(e.length/t),s=[];for(let n=0;n<t;n++){let o=0;for(let r=0;r<i;r++)o+=e[n*i+r];s.push(o/(i*255))}return s}static getAmplitude(){const t=this.getWaveform();if(t.length===0)return 0;let e=0;for(let i=0;i<t.length;i++){const s=(t[i]-128)/128;e+=s*s}return Math.sqrt(e/t.length)}static getPeakFrequency(){if(!b(this,tt)||!b(this,we))return 0;const t=this.getFrequency();let e=0,i=0;for(let n=0;n<t.length;n++)t[n]>i&&(i=t[n],e=n);const s=b(this,we).sampleRate/2;return e*s/b(this,tt).frequencyBinCount}static dispose(){b(this,tt)&&(b(this,tt).disconnect(),q(this,tt,null)),q(this,se,null),q(this,ne,null)}}we=new WeakMap;tt=new WeakMap;se=new WeakMap;ne=new WeakMap;N(oe,we,null);N(oe,tt,null);N(oe,se,null);N(oe,ne,null);class ai{static init(t={}){if(b(this,he)){console.warn("[Synth] Already initialized");return}const{masterVolume:e=.5,sampleRate:i=44100,enableAnalyzer:s=!1}=t;try{q(this,et,new(window.AudioContext||window.webkitAudioContext)({sampleRate:i})),q(this,vt,b(this,et).createGain()),b(this,vt).gain.value=e,b(this,vt).connect(b(this,et).destination),Oe.init(b(this,et),b(this,vt)),ze.init(b(this,et),b(this,vt)),s&&oe.init(b(this,et),b(this,vt)),q(this,he,!0),console.log("[Synth] Audio system initialized")}catch(n){console.error("[Synth] Failed to initialize audio:",n)}}static get isInitialized(){return b(this,he)}static get ctx(){return b(this,et)}static get master(){return b(this,vt)}static get osc(){return Oe}static get fx(){return ze}static get env(){return Xi}static get noise(){return mn}static get music(){return Fe}static get analyzer(){return oe}static async resume(){b(this,et)&&b(this,et).state==="suspended"&&(await b(this,et).resume(),console.log("[Synth] Audio context resumed"))}static async suspend(){b(this,et)&&b(this,et).state==="running"&&await b(this,et).suspend()}static get now(){return b(this,et)?b(this,et).currentTime:0}static get state(){return b(this,et)?b(this,et).state:"closed"}static set volume(t){b(this,vt)&&b(this,vt).gain.setValueAtTime(Math.max(0,Math.min(1,t)),b(this,et).currentTime)}static get volume(){return b(this,vt)?b(this,vt).gain.value:0}static chain(...t){for(let e=0;e<t.length-1;e++)t[e].connect(t[e+1]);return{first:t[0],last:t[t.length-1],connectTo:e=>t[t.length-1].connect(e)}}static schedule(t,e){const i=Math.max(0,(e-this.now)*1e3);return setTimeout(t,i)}static async close(){b(this,et)&&(oe.dispose(),await b(this,et).close(),q(this,et,null),q(this,vt,null),q(this,he,!1),console.log("[Synth] Audio system closed"))}}et=new WeakMap;vt=new WeakMap;he=new WeakMap;N(ai,et,null);N(ai,vt,null);N(ai,he,!1);class gr{constructor(t,e={}){this.audioContext=t;const{baseDelay:i=.005,maxDelay:s=.02,lfoFrequency:n=.5,lfoDepth:o=.002,feedback:r=.5,wet:a=0,dry:l=1}=e;this.delay=t.createDelay(s),this.delay.delayTime.value=i,this.lfo=t.createOscillator(),this.lfo.type="sine",this.lfo.frequency.value=n,this.lfoDepth=t.createGain(),this.lfoDepth.gain.value=o,this.feedback=t.createGain(),this.feedback.gain.value=r,this.wetGain=t.createGain(),this.wetGain.gain.value=a,this.dryGain=t.createGain(),this.dryGain.gain.value=l,this.output=t.createGain(),this.output.gain.value=1,this.lfo.connect(this.lfoDepth),this.lfoDepth.connect(this.delay.delayTime),this.delay.connect(this.feedback),this.feedback.connect(this.delay),this.lfo.start(),this.input=t.createGain()}connect(t){t.connect(this.dryGain),this.dryGain.connect(this.output),t.connect(this.delay),this.delay.connect(this.wetGain),this.wetGain.connect(this.output)}setMix(t,e){this.wetGain.gain.value=t,this.dryGain.gain.value=e}setLFOFrequency(t){this.lfo.frequency.value=t}setFeedback(t){this.feedback.gain.value=t}disconnect(){try{this.lfo.stop(),this.lfo.disconnect(),this.delay.disconnect(),this.feedback.disconnect(),this.wetGain.disconnect(),this.dryGain.disconnect(),this.lfoDepth.disconnect(),this.input.disconnect(),this.output.disconnect()}catch{}}}class mr{constructor(t,e={}){this.audioContext=t;const{type:i="lowpass",frequency:s=2e4,Q:n=1}=e;this.filter=t.createBiquadFilter(),this.filter.type=i,this.filter.frequency.value=s,this.filter.Q.value=n}connect(t){t.connect(this.filter)}setFrequency(t){this.filter.frequency.value=t}setQ(t){this.filter.Q.value=t}setType(t){this.filter.type=t}getNode(){return this.filter}disconnect(){try{this.filter.disconnect()}catch{}}}class pr{constructor(t,e={}){this.audioContext=t;const{numBands:i=16,minFreq:s=40,maxFreq:n=12e3,Q:o=4}=e;this.filters=[],this.numBands=i;for(let r=0;r<i;r++){const a=t.createBiquadFilter();a.type="peaking";const l=i>1?s*Math.pow(n/s,r/(i-1)):(s+n)/2;a.frequency.value=l,a.Q.value=o,a.gain.value=0,this.filters.push(a)}}connect(t){let e=t;for(const i of this.filters)e.connect(i),e=i}setBandGain(t,e){t>=0&&t<this.filters.length&&(this.filters[t].gain.value=e)}setBandGains(t){for(let e=0;e<Math.min(t.length,this.filters.length);e++)this.filters[e].gain.value=t[e]}getFilter(t){return this.filters[t]}getFilters(){return this.filters}disconnect(){for(const t of this.filters)try{t.disconnect()}catch{}}}class yr{constructor(t,e={}){this.audioContext=t;const{frequency:i=4e3,gain:s=3}=e;this.filter=t.createBiquadFilter(),this.filter.type="highshelf",this.filter.frequency.value=i,this.filter.gain.value=s}connect(t){t.connect(this.filter)}setFrequency(t){this.filter.frequency.value=t}setGain(t){this.filter.gain.value=t}getNode(){return this.filter}disconnect(){try{this.filter.disconnect()}catch{}}}class vr{constructor(t,e={}){this.audioContext=t;const{delayTime:i=.15,maxDelay:s=.5,feedback:n=.2,wet:o=.15,dry:r=.85}=e;this.delay=t.createDelay(s),this.delay.delayTime.value=i,this.feedbackGain=t.createGain(),this.feedbackGain.gain.value=n,this.wetGain=t.createGain(),this.wetGain.gain.value=o,this.dryGain=t.createGain(),this.dryGain.gain.value=r,this.output=t.createGain(),this.output.gain.value=1,this.delay.connect(this.feedbackGain),this.feedbackGain.connect(this.delay),this.input=t.createGain()}connect(t){t.connect(this.dryGain),this.dryGain.connect(this.output),t.connect(this.delay),this.delay.connect(this.wetGain),this.wetGain.connect(this.output)}setDelayTime(t){this.delay.delayTime.value=t}setMix(t,e){this.wetGain.gain.value=t,this.dryGain.gain.value=e}setFeedback(t){this.feedbackGain.gain.value=t}getOutput(){return this.output}disconnect(){try{this.delay.disconnect(),this.feedbackGain.disconnect(),this.wetGain.disconnect(),this.dryGain.disconnect(),this.input.disconnect(),this.output.disconnect()}catch{}}}class _r{constructor(t,e={}){this.audioContext=t;const{amount:i=0,oversample:s="4x"}=e;this.shaper=t.createWaveShaper(),this.shaper.oversample=s,this.amount=i,this.updateCurve(i)}updateCurve(t){const i=new Float32Array(44100),s=Math.PI/180,n=t*400;for(let o=0;o<44100;o++){const r=o*2/44100-1;n===0?i[o]=r:i[o]=(3+n)*r*20*s/(Math.PI+n*Math.abs(r))}this.shaper.curve=i,this.amount=t}connect(t){t.connect(this.shaper)}setAmount(t){this.updateCurve(t)}getNode(){return this.shaper}disconnect(){try{this.shaper.disconnect()}catch{}}}class br{constructor(t,e={}){this.audioContext=t;const{rate:i=4,depth:s=0,lfoType:n="sine"}=e;this.gain=t.createGain(),this.gain.gain.value=1,this.lfo=t.createOscillator(),this.lfo.type=n,this.lfo.frequency.value=i,this.depthGain=t.createGain(),this.depthGain.gain.value=s,this.lfo.connect(this.depthGain),this.depthGain.connect(this.gain.gain),this.lfo.start()}connect(t){t.connect(this.gain)}setRate(t){this.lfo.frequency.value=t}setDepth(t){this.depthGain.gain.value=t}getNode(){return this.gain}disconnect(){try{this.lfo.stop(),this.lfo.disconnect(),this.depthGain.disconnect(),this.gain.disconnect()}catch{}}}class xr{constructor(t,e={}){this.audioContext=t;const{threshold:i=-3,knee:s=0,ratio:n=20,attack:o=.001,release:r=.1}=e;this.compressor=t.createDynamicsCompressor(),this.compressor.threshold.value=i,this.compressor.knee.value=s,this.compressor.ratio.value=n,this.compressor.attack.value=o,this.compressor.release.value=r}connect(t){t.connect(this.compressor)}setThreshold(t){this.compressor.threshold.value=t}getNode(){return this.compressor}disconnect(){try{this.compressor.disconnect()}catch{}}}class wr{constructor(t,e=1){this.audioContext=t,this.gain=t.createGain(),this.gain.gain.value=e}connect(t){t.connect(this.gain)}setVolume(t){this.gain.gain.value=t}getNode(){return this.gain}disconnect(){try{this.gain.disconnect()}catch{}}}class Fi{constructor(t={}){this.states=t.states||{},this.currentState=null,this.previousState=null,this.stateTime=0,this.context=t.context||null,this.paused=!1,this.onStateChange=null,t.initial&&this.setState(t.initial)}get state(){return this.currentState}get currentStateConfig(){return this.currentState?this.states[this.currentState]:null}is(t){return this.currentState===t}isAny(...t){return t.includes(this.currentState)}addState(t,e){return this.states[t]=e,this}removeState(t){return delete this.states[t],this}setState(t,e){if(!this.states[t])return console.warn(`StateMachine: Unknown state '${t}'`),!1;if(this.currentState){const s=this.states[this.currentState];s!=null&&s.exit&&this._call(s.exit,e)}this.previousState=this.currentState,this.currentState=t,this.stateTime=0;const i=this.states[t];return i!=null&&i.enter&&this._call(i.enter,e),this.onStateChange&&this.onStateChange(t,this.previousState,e),!0}trigger(t,e){const i=this.currentStateConfig;if(!(i!=null&&i.on))return!1;const s=i.on[t];return s?typeof s=="string"?this.setState(s,e):s.guard&&!this._call(s.guard,e)?!1:(s.action&&this._call(s.action,e),s.target?this.setState(s.target,e):!1):!1}update(t){if(this.paused||!this.currentState)return;this.stateTime+=t;const e=this.states[this.currentState];e&&(e.update&&this._call(e.update,t),e.duration!==void 0&&this.stateTime>=e.duration&&(e.next?this.setState(e.next):e.onComplete&&this._call(e.onComplete)))}get progress(){const t=this.currentStateConfig;return t!=null&&t.duration?Math.min(1,this.stateTime/t.duration):0}get remaining(){const t=this.currentStateConfig;return t!=null&&t.duration?Math.max(0,t.duration-this.stateTime):1/0}get isTimed(){var t;return((t=this.currentStateConfig)==null?void 0:t.duration)!==void 0}pause(){this.paused=!0}resume(){this.paused=!1}reset(t){if(this.stateTime=0,this.previousState=null,t)this.setState(t);else{const e=Object.keys(this.states)[0];e&&this.setState(e)}}_call(t,...e){if(typeof t=="function")return this.context?t.call(this.context,...e):t(...e)}static fromSequence(t,e={}){var i;const s={};for(let n=0;n<t.length;n++){const o=t[n],r=n===t.length-1,a=r?e.loop?t[0].name:null:t[n+1].name;s[o.name]={duration:o.duration,next:a,enter:o.enter,update:o.update,exit:o.exit,onComplete:r&&!e.loop?e.onComplete:void 0}}return new Fi({initial:(i=t[0])==null?void 0:i.name,states:s,context:e.context})}}const Wi={scrollDebounce:150,implementedDays:[1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18,19,20,21,22,23,24,25,26,27,28,29,30,31]},T={currentDay:0,currentKernel:0,games:new Map,mounting:new Set,sections:[],kernelSections:[],isScrolling:!1,isProgrammaticScroll:!1,isInitializing:!0,isFullscreenTransition:!1},G={main:null,sidebar:null,navLinks:null,overlay:null,hamburger:null,navUp:null,navDown:null};async function Kt(c){if(c===0)return;const t=`day-${c}`;if(T.games.has(t)||T.mounting.has(t))return;for(const[i,s]of T.games)i!==t&&(console.log(`[Genuary] Unmounting ${i} (switching to Day ${c})`),s.stop(),T.games.delete(i));T.mounting.add(t);const e=document.getElementById(`canvas-${c}`);if(!e){T.mounting.delete(t);return}if(!Wi.implementedDays.includes(c)){Ve(e,c),T.mounting.delete(t);return}try{const i=await wi(Object.assign({"./days/day01.js":()=>z(()=>import("./day01-Cb65kRpS.js"),[]),"./days/day02.js":()=>z(()=>import("./day02-BZnmcZkZ.js"),[]),"./days/day03.js":()=>z(()=>import("./day03-_TnszaSD.js"),[]),"./days/day04.js":()=>z(()=>import("./day04-D17KiHMg.js"),[]),"./days/day05.js":()=>z(()=>import("./day05-DKOqB3Tx.js"),[]),"./days/day06.js":()=>z(()=>import("./day06-BQ8FCnL6.js"),[]),"./days/day07.js":()=>z(()=>import("./day07-YeKk_ywP.js"),[]),"./days/day08.js":()=>z(()=>import("./day08-m4ts4-8e.js"),[]),"./days/day09.js":()=>z(()=>import("./day09-CdcTE2SD.js"),[]),"./days/day10.js":()=>z(()=>import("./day10-D1CNF1FW.js"),[]),"./days/day11.js":()=>z(()=>import("./day11-Bwceg1OG.js"),[]),"./days/day12.js":()=>z(()=>import("./day12-CP4S6bro.js"),[]),"./days/day13.js":()=>z(()=>import("./day13-_wHsybL4.js"),[]),"./days/day14.config.js":()=>z(()=>import("./day14.config-C2x5zr_q.js"),[]),"./days/day14.js":()=>z(()=>import("./day14-BApK3_Yi.js"),__vite__mapDeps([0,1])),"./days/day15.js":()=>z(()=>import("./day15-CR_rcwE5.js"),[]),"./days/day16.js":()=>z(()=>import("./day16-C3JaC8Bi.js"),[]),"./days/day17.js":()=>z(()=>import("./day17-BxQiW0k-.js"),[]),"./days/day18.js":()=>z(()=>import("./day18-BRElpN8B.js"),[]),"./days/day19.grokking.js":()=>z(()=>import("./day19.grokking-BLQhquhM.js"),__vite__mapDeps([2,3])),"./days/day19.js":()=>z(()=>import("./day19-Dyd4XAPM.js"),__vite__mapDeps([4,2,3])),"./days/day19.utils.js":()=>z(()=>import("./day19.utils-DeEDoNyc.js"),[]),"./days/day19.worker.js":()=>z(()=>import("./day19.worker-DnZQuLnN.js"),__vite__mapDeps([5,2,3])),"./days/day20.js":()=>z(()=>import("./day20-CShOOtCN.js"),[]),"./days/day21.js":()=>z(()=>import("./day21-B-Gl2gvx.js"),[]),"./days/day22.js":()=>z(()=>import("./day22-DetnVWKr.js"),[]),"./days/day23.js":()=>z(()=>import("./day23-BHKwOeVt.js"),[]),"./days/day24.js":()=>z(()=>import("./day24-4tfKwcG0.js"),[]),"./days/day25.chemistry.js":()=>z(()=>import("./day25.chemistry-fLO6Y1II.js"),[]),"./days/day25.config.js":()=>z(()=>import("./day25.config-DJwhhKHN.js"),[]),"./days/day25.js":()=>z(()=>import("./day25-BzEsJEQ1.js"),__vite__mapDeps([6,7,8,9,10,11])),"./days/day25.lightning.js":()=>z(()=>import("./day25.lightning-BYJs8w6b.js"),[]),"./days/day25.molecule.js":()=>z(()=>import("./day25.molecule-Baxzd6wS.js"),__vite__mapDeps([9,7,8])),"./days/day25.ui.js":()=>z(()=>import("./day25.ui-CVeRNEGR.js"),__vite__mapDeps([10,7,8])),"./days/day26.js":()=>z(()=>import("./day26-C7H52uds.js"),[]),"./days/day27.js":()=>z(()=>import("./day27-BFXDwq-u.js"),[]),"./days/day28.js":()=>z(()=>import("./day28-CscHunDU.js"),[]),"./days/day29.js":()=>z(()=>import("./day29-DlZYf3WM.js"),[]),"./days/day30.js":()=>z(()=>import("./day30-BxfV6vRJ.js"),[]),"./days/day31.birds.js":()=>z(()=>import("./day31.birds-BeLwQsgh.js"),__vite__mapDeps([12,13])),"./days/day31.config.js":()=>z(()=>import("./day31.config-DDGTRykT.js"),[]),"./days/day31.js":()=>z(()=>import("./day31-CApvlH2u.js"),__vite__mapDeps([14,13,12,15,16,17])),"./days/day31.matrix.js":()=>z(()=>import("./day31.matrix-B7FGu3RC.js"),__vite__mapDeps([17,13])),"./days/day31.posters.js":()=>z(()=>import("./day31.posters-Dmc02CF_.js"),__vite__mapDeps([15,13])),"./days/day31.runner.js":()=>z(()=>import("./day31.runner-B6sN3_uy.js"),__vite__mapDeps([16,13]))}),`./days/day${String(c).padStart(2,"0")}.js`,3);if(!T.mounting.has(t))return;const s=e.parentElement;e.width=s.clientWidth,e.height=s.clientHeight;const n=i.default(e);T.games.set(t,n),T.mounting.delete(t),jt.isTouchPrimary()&&jt.wakeLockSupported&&jt.requestWakeLock(),console.log(`[Genuary] Mounted Day ${c} (only game running)`)}catch(i){console.warn(`[Genuary] Day ${c} not implemented:`,i.message),T.mounting.delete(t),Ve(e,c)}}async function ae(c){if(c===0)return;const t=`kernel-${c}`;if(T.games.has(t)||T.mounting.has(t))return;for(const[s,n]of T.games)s!==t&&(console.log(`[Genuary] Unmounting ${s} (switching to Kernel ${c})`),n.stop(),T.games.delete(s));T.mounting.add(t);const e=document.getElementById(`kernel-canvas-${c}`);if(!e){T.mounting.delete(t);return}const i=ji(c);if(!i){console.warn(`[Genuary] Kernel ${c} has no filename mapping`),T.mounting.delete(t);return}try{const s=await wi(Object.assign({"./kernels/ascii.js":()=>z(()=>import("./ascii-DznOO3qU.js"),[]),"./kernels/booleandemo.js":()=>z(()=>import("./booleandemo-BUKzxTX3.js"),[]),"./kernels/day19.js":()=>z(()=>import("./day19-CKylf733.js"),[]),"./kernels/feynman.js":()=>z(()=>import("./feynman-C-CjFYRq.js"),[]),"./kernels/finale.js":()=>z(()=>import("./finale-tW8QFpC7.js"),[]),"./kernels/galaxy.js":()=>z(()=>import("./galaxy-CTD-Srzj.js"),[]),"./kernels/gates.js":()=>z(()=>import("./gates-B04RGGqZ.js"),[]),"./kernels/hilbert.js":()=>z(()=>import("./hilbert-Cau34c-i.js"),[]),"./kernels/spongecube3d.js":()=>z(()=>import("./spongecube3d-DW2R4j1A.js"),[]),"./kernels/spongegl.js":()=>z(()=>import("./spongegl-BT9ZSfT-.js"),[]),"./kernels/template.js":()=>z(()=>import("./template-BjoNZAAa.js"),[])}),`./kernels/${i}.js`,3);if(!T.mounting.has(t))return;const n=e.parentElement;e.width=n.clientWidth,e.height=n.clientHeight;const o=s.default(e);T.games.set(t,o),T.mounting.delete(t),jt.isTouchPrimary()&&jt.wakeLockSupported&&jt.requestWakeLock(),console.log(`[Genuary] Mounted Kernel ${c} (${Ge(c)})`)}catch(s){console.warn(`[Genuary] Kernel ${c} failed to load:`,s.message),T.mounting.delete(t),Ve(e,`kernel-${c}`)}}function Nt(c){const t=`day-${c}`;T.mounting.delete(t);const e=T.games.get(t);if(!e)return;e.stop(),T.games.delete(t),T.games.size===0&&jt.releaseWakeLock();const i=document.getElementById(`canvas-${c}`);if(i){const s=i.getContext("2d");s.fillStyle="#000",s.fillRect(0,0,i.width,i.height)}console.log(`[Genuary] Unmounted Day ${c}`)}function Ft(c){const t=`kernel-${c}`;T.mounting.delete(t);const e=T.games.get(t);if(!e)return;e.stop(),T.games.delete(t),T.games.size===0&&jt.releaseWakeLock();const i=document.getElementById(`kernel-canvas-${c}`);if(i){const s=i.getContext("2d");s.fillStyle="#000",s.fillRect(0,0,i.width,i.height)}console.log(`[Genuary] Unmounted Kernel ${c}`)}function Ve(c,t){const e=c.getContext("2d"),i=c.parentElement,s=window.devicePixelRatio||1,n=i.getBoundingClientRect();c.width=n.width*s,c.height=n.height*s,c.width=n.width,c.height=n.height;const o=c.width,r=c.height;e.fillStyle="#050505",e.fillRect(0,0,o,r),e.fillStyle="#1a1a1a";const a=30;for(let h=0;h<o;h+=a)for(let d=0;d<r;d+=a)e.fillRect(h,d,1,1);e.strokeStyle="#111",e.lineWidth=1,e.beginPath(),e.moveTo(0,0),e.lineTo(o,r),e.moveTo(o,0),e.lineTo(0,r),e.stroke();const l=Math.min(o,r)*.1;e.font=`bold ${l}px "Fira Code", monospace`,e.textAlign="center",e.textBaseline="middle",e.fillStyle="rgba(0, 255, 0, 0.05)",e.fillText("SYSTEM_OFFLINE",o/2+2,r/2+2),e.fillStyle="#222",e.fillText("SYSTEM_OFFLINE",o/2,r/2),e.font='14px "Fira Code", monospace',e.fillStyle="#444",e.textAlign="left",e.fillText(`DAY_${String(t).padStart(2,"0")}_PENDING_INIT`,20,30),e.textAlign="right",e.fillStyle="#0f0",e.globalAlpha=.5,e.fillText("INITIALIZING...",o-20,r-20),e.globalAlpha=1}function pn(){G.main=document.getElementById("main-content"),G.navLinks=document.getElementById("nav-links");const c=document.createElement("section");c.className="day-section intro-section active",c.dataset.day=0,c.innerHTML=`
    <div class="intro-container">
      <div class="intro-content">
        <div class="intro-header">
          <div class="intro-logo">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="32.9 174.743 71.888 63.576" width="60" height="52">
              <path d="M 57.971 224.292 L 57.971 203.374 L 57.971 194.861 L 75.109 194.861 L 75.109 188.769 L 63.16 188.769 L 63.16 174.743 L 57.971 174.743 L 57.971 189.041 L 57.971 194.861 L 32.9 194.861 L 32.9 203.773 L 50.377 203.773 L 50.377 224.292 L 57.971 224.292 Z M 79.717 238.319 L 79.717 224.02 L 79.717 218.2 L 104.788 218.2 L 104.788 209.287 L 87.31 209.287 L 87.31 188.769 L 79.717 188.769 L 79.717 209.686 L 79.717 218.2 L 62.579 218.2 L 62.579 224.293 L 74.526 224.293 L 74.526 238.319 L 79.717 238.319 Z" style="fill: #0f0; fill-rule: evenodd;"/>
            </svg>
          </div>
          <h1 class="intro-title">GENUARY 2026</h1>
          <p class="intro-subtitle">31 days of Generative Art studies by Guinetik</p>
        </div>

        <div class="intro-body">
          <div class="intro-avatar-wrapper">
            <img src="./avatar.jpeg" alt="Guinetik" class="intro-avatar">
            <div class="avatar-glitch"></div>
          </div>
          
          <div class="intro-text">
            <p><strong>Hi, I'm Guinetik.</strong></p>
            <p>I'm a software engineer from the banking space, trying out generative art for the first time.</p>
            <p>This project is a showcase for <a href="https://gcanvas.guinetik.com" target="_blank">@guinetik/gcanvas</a>, a lightweight creative coding framework I built for the HTML5 Canvas.</p>
          </div>

          <div class="intro-links">
            <a href="https://guinetik.com" target="_blank" class="intro-link">
              <span class="link-icon">ðŸŒ</span> guinetik.com
            </a>
            <a href="https://github.com/guinetik" target="_blank" class="intro-link">
              <span class="link-icon">ðŸ™</span> github/guinetik
            </a>
            <a href="https://github.com/guinetik/genuary2026" target="_blank" class="intro-link">
              <span class="link-icon">ðŸ“¦</span> Project Repo
            </a>
          </div>
          
          <button class="intro-start-btn" onclick="document.getElementById('nav-links').firstElementChild.click()">
            START JOURNEY <span class="arrow">â†“</span>
          </button>
        </div>
      </div>
    </div>
  `,G.main.appendChild(c),T.sections.push(c);for(let s=1;s<=_t;s++){const n=document.createElement("section");n.className="day-section",n.dataset.day=s,n.innerHTML=`
      <div class="day-bg-number">${String(s).padStart(2,"0")}</div>
      <div class="day-canvas-container">
        <div class="corner-tr"></div>
        <div class="corner-bl"></div>
        <div class="tech-decor-top">SYSTEM.Render(0${s})</div>
        <canvas id="canvas-${s}"></canvas>
      </div>
      <div class="canvas-bottom-row">
        <div class="canvas-controls">
          <button class="canvas-btn btn-restart" data-day="${s}" title="Restart">
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <path d="M3 12a9 9 0 1 0 9-9 9.75 9.75 0 0 0-6.74 2.74L3 8"/>
              <path d="M3 3v5h5"/>
            </svg>
          </button>
        </div>
        <div class="day-info">
          <div class="day-number-display">Day ${s}</div>
          <h2 class="day-title">${Pe(s)}</h2>
          <p class="day-interpretation">${Mi(s)}</p>
          <p class="day-date">January ${s}, 2026</p>
        </div>
        <button class="canvas-btn btn-fullscreen" data-day="${s}" title="Fullscreen">
          <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M8 3H5a2 2 0 0 0-2 2v3m18 0V5a2 2 0 0 0-2-2h-3m0 18h3a2 2 0 0 0 2-2v-3M3 16v3a2 2 0 0 0 2 2h3"/>
          </svg>
        </button>
      </div>
    `,G.main.appendChild(n),T.sections.push(n);const o=document.createElement("a");o.href=`#day-${s}`,o.dataset.day=s,s===1&&o.classList.add("active"),o.innerHTML=`
      <span class="day-number">${String(s).padStart(2,"0")}</span>
      <span class="day-name">${Pe(s)}</span>
    `,o.addEventListener("click",r=>_n(r,s)),G.navLinks.appendChild(o)}const t=document.createElement("section");t.className="day-section kernels-section",t.dataset.kernels=!0,t.dataset.kernel=0,t.innerHTML=`
    <div class="day-bg-number">K</div>
    <div class="day-canvas-container">
      <div class="corner-tr"></div>
      <div class="corner-bl"></div>
      <div class="tech-decor-top">SYSTEM.Kernels()</div>
      <div class="kernels-index">
        <h2 class="kernels-title">Experimental Kernels</h2>
        <p class="kernels-subtitle">Cut experiments and prototypes from Genuary 2026</p>
        <div class="kernels-grid" id="kernels-grid">
          <!-- Generated below -->
        </div>
      </div>
    </div>
    <div class="canvas-bottom-row">
      <div class="day-info">
        <div class="day-number-display">Kernels</div>
        <h2 class="day-title">Experimental Prototypes</h2>
        <p class="day-interpretation">These are experiments that didn't make it into the final Genuary days but are still interesting visualizations worth exploring.</p>
      </div>
    </div>
  `,G.main.appendChild(t),T.sections.push(t);const e=t.querySelector("#kernels-grid");for(let s=1;s<=Me;s++){const n=document.createElement("div");n.className="kernel-item",n.dataset.kernelIndex=s,n.innerHTML=`
      <div class="kernel-item-number">${String(s).padStart(2,"0")}</div>
      <div class="kernel-item-name">${Ge(s)}</div>
      <div class="kernel-item-desc">${di(s)}</div>
    `,n.addEventListener("click",o=>{o.preventDefault(),o.stopPropagation(),T.isProgrammaticScroll||hi(s)}),e.appendChild(n)}for(let s=1;s<=Me;s++){const n=document.createElement("section");n.className="day-section kernel-section",n.dataset.kernel=s,n.innerHTML=`
      <div class="day-bg-number">K${String(s).padStart(2,"0")}</div>
      <div class="day-canvas-container">
        <div class="corner-tr"></div>
        <div class="corner-bl"></div>
        <div class="tech-decor-top">SYSTEM.Kernel(${String(s).padStart(2,"0")})</div>
        <canvas id="kernel-canvas-${s}"></canvas>
      </div>
      <div class="canvas-bottom-row">
        <div class="canvas-controls">
          <button class="canvas-btn btn-restart" data-kernel="${s}" title="Restart">
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <path d="M3 12a9 9 0 1 0 9-9 9.75 9.75 0 0 0-6.74 2.74L3 8"/>
              <path d="M3 3v5h5"/>
            </svg>
          </button>
        </div>
        <div class="day-info">
          <div class="day-number-display">Kernel ${s}</div>
          <h2 class="day-title">${Ge(s)}</h2>
          <p class="day-interpretation">${di(s)}</p>
        </div>
        <button class="canvas-btn btn-fullscreen" data-kernel="${s}" title="Fullscreen">
          <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M8 3H5a2 2 0 0 0-2 2v3m18 0V5a2 2 0 0 0-2-2h-3m0 18h3a2 2 0 0 0 2-2v-3M3 16v3a2 2 0 0 0 2 2h3"/>
          </svg>
        </button>
      </div>
    `,G.main.appendChild(n),T.sections.push(n),T.kernelSections.push(n)}const i=document.createElement("a");i.href="#kernels",i.dataset.kernels=!0,i.innerHTML=`
    <span class="day-number">K</span>
    <span class="day-name">Kernels</span>
  `,i.addEventListener("click",s=>{s.preventDefault(),ci(),Te()}),G.navLinks.appendChild(i)}function yn(){const c=document.createElement("div");c.className="mobile-footer",c.innerHTML=`
    <div class="mobile-footer-left">
      <div class="marquee-container">
        <div class="marquee-content" id="mobile-footer-title">GENUARY 2026</div>
      </div>
    </div>
    <div class="mobile-footer-right">
      <button class="mobile-btn" id="mobile-info-btn" aria-label="Info">
        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <circle cx="12" cy="12" r="10"></circle>
          <line x1="12" y1="16" x2="12" y2="12"></line>
          <line x1="12" y1="8" x2="12.01" y2="8"></line>
        </svg>
      </button>
      <div class="mobile-nav-group">
        <button class="mobile-btn" id="mobile-prev-btn" aria-label="Previous">
          <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M18 15l-6-6-6 6"/>
          </svg>
        </button>
        <button class="mobile-btn" id="mobile-next-btn" aria-label="Next">
          <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M6 9l6 6 6-6"/>
          </svg>
        </button>
      </div>
    </div>
  `,document.body.appendChild(c);const t=document.createElement("div");t.className="mobile-info-overlay",t.id="mobile-info-overlay",t.innerHTML=`
    <div class="mobile-info-content">
      <button class="mobile-info-close" id="mobile-info-close">&times;</button>
      <div class="mobile-info-body">
        <div class="mobile-info-day" id="mobile-info-day">DAY 01</div>
        <h2 class="mobile-info-title" id="mobile-info-title-full">Title</h2>
        <p class="mobile-info-desc" id="mobile-info-desc">Description...</p>
        <div class="mobile-info-actions">
          <button class="action-btn" id="mobile-restart-btn">
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <path d="M3 12a9 9 0 1 0 9-9 9.75 9.75 0 0 0-6.74 2.74L3 8"/>
              <path d="M3 3v5h5"/>
            </svg>
            RESTART
          </button>
        </div>
      </div>
    </div>
  `,document.body.appendChild(t),document.getElementById("mobile-prev-btn").addEventListener("click",qe),document.getElementById("mobile-next-btn").addEventListener("click",$e);const e=document.getElementById("mobile-info-btn"),i=document.getElementById("mobile-info-close"),s=document.getElementById("mobile-restart-btn");e.addEventListener("click",()=>{t.classList.add("open"),vn(T.currentDay)}),i.addEventListener("click",()=>{t.classList.remove("open")}),t.addEventListener("click",n=>{n.target===t&&t.classList.remove("open")}),s.addEventListener("click",()=>{Ni(T.currentDay),t.classList.remove("open")})}function li(c){const t=document.getElementById("mobile-footer-title"),e=document.getElementById("mobile-prev-btn"),i=document.getElementById("mobile-next-btn");t&&(c===0?(t.textContent="GENUARY 2026",e.disabled=!0,i.disabled=!1):(t.textContent=`DAY #${c}: ${Pe(c)}`,e.disabled=!1,i.disabled=c>=_t))}function vn(c){c!==0&&(document.getElementById("mobile-info-day").textContent=`DAY ${String(c).padStart(2,"0")}`,document.getElementById("mobile-info-title-full").textContent=Pe(c),document.getElementById("mobile-info-desc").textContent=Mi(c))}function _n(c,t){c.preventDefault(),!T.isProgrammaticScroll&&(Se(t),Te())}function Se(c){const t=T.sections[c];if(!t)return;const e=T.currentDay,i=T.currentKernel;if(c===e&&i===0)return;T.isProgrammaticScroll=!0,e>0?Nt(e):i>0&&Ft(i),T.currentDay=c,T.currentKernel=0,Dt(c);let s=document.getElementById("nav-transition-overlay");s||(s=document.createElement("div"),s.id="nav-transition-overlay",s.style.cssText=`
      position: fixed;
      inset: 0;
      background: #000;
      opacity: 0;
      pointer-events: none;
      z-index: 100;
      transition: opacity 0.15s ease;
    `,document.body.appendChild(s)),s.style.opacity="1",setTimeout(()=>{t.scrollIntoView({behavior:"instant"}),T.sections.forEach(n=>n.classList.remove("active")),t.classList.add("active"),setTimeout(()=>{s.style.opacity="0",Kt(c),c>0?history.replaceState(null,"",`#day-${c}`):history.replaceState(null,""," "),T.isProgrammaticScroll=!1},50)},150)}function Dt(c,t=!1){document.querySelectorAll("#nav-links a").forEach(e=>{if(e.dataset.kernels)e.classList.toggle("active",t&&c===0);else{const i=parseInt(e.dataset.day);e.classList.toggle("active",!t&&i===c)}}),T.sections.forEach((e,i)=>{if(e.dataset.kernels||e.dataset.kernel)if(t)if(e.dataset.kernels)e.classList.toggle("active",c===0);else{const s=parseInt(e.dataset.kernel);e.classList.toggle("active",s===T.currentKernel)}else e.classList.remove("active");else e.classList.toggle("active",!t&&i===c)}),t?(G.navUp.disabled=T.currentKernel===0,G.navDown.disabled=T.currentKernel===Me):(G.navUp.disabled=c===0,G.navDown.disabled=c===_t),t||li(c)}function qe(){if(T.currentKernel>0){T.currentKernel>1&&!T.isProgrammaticScroll?hi(T.currentKernel-1):T.currentKernel===1&&!T.isProgrammaticScroll&&ci();return}if(T.currentKernel===0&&T.currentDay===0&&!T.isProgrammaticScroll){Se(_t);return}T.currentDay>0&&!T.isProgrammaticScroll&&Se(T.currentDay-1)}function $e(){if(T.currentKernel>0){T.currentKernel<Me&&!T.isProgrammaticScroll&&hi(T.currentKernel+1);return}if(T.currentDay===_t&&!T.isProgrammaticScroll){ci();return}T.currentDay<_t&&!T.isProgrammaticScroll&&Se(T.currentDay+1)}function ci(){const c=T.sections.find(i=>i.dataset.kernels==="true");if(!c)return;const t=T.currentDay,e=T.currentKernel;t>0?Nt(t):e>0&&Ft(e),T.currentDay=0,T.currentKernel=0,T.isProgrammaticScroll=!0,c.scrollIntoView({behavior:"instant"}),c.classList.add("active"),Dt(0,!0),history.replaceState(null,"","#kernels"),setTimeout(()=>{T.isProgrammaticScroll=!1},300)}function hi(c){const t=T.kernelSections[c-1];if(!t)return;const e=T.currentDay,i=T.currentKernel;if(c===i||T.isProgrammaticScroll)return;T.isProgrammaticScroll=!0,e>0?Nt(e):i>0&&Ft(i),T.currentDay=0,T.currentKernel=c,Dt(0,!0);let s=document.getElementById("nav-transition-overlay");s||(s=document.createElement("div"),s.id="nav-transition-overlay",s.style.cssText=`
      position: fixed;
      inset: 0;
      background: #000;
      opacity: 0;
      pointer-events: none;
      z-index: 100;
      transition: opacity 0.15s ease;
    `,document.body.appendChild(s)),s.style.opacity="1",setTimeout(()=>{t.scrollIntoView({behavior:"instant"}),T.sections.forEach(n=>{(n.dataset.kernel||n.dataset.kernels)&&n.classList.remove("active")}),t.classList.add("active"),setTimeout(()=>{s.style.opacity="0",ae(c),history.replaceState(null,"",`#kernel-${c}`),setTimeout(()=>{T.isProgrammaticScroll=!1},200)},50)},150)}function bn(){let c;const t={root:G.main,rootMargin:"0px",threshold:.6},e=new IntersectionObserver(i=>{if(!(T.isInitializing||T.isProgrammaticScroll||T.isFullscreenTransition)){for(const s of i)if(s.isIntersecting&&s.intersectionRatio>=.6)if(s.target.dataset.kernel){const n=parseInt(s.target.dataset.kernel);!isNaN(n)&&n>0&&n!==T.currentKernel&&T.currentKernel>=0&&(Math.abs(n-T.currentKernel)<=1||T.currentKernel===0?(clearTimeout(c),c=setTimeout(()=>{wn(n)},50)):(clearTimeout(c),c=setTimeout(()=>{const r=T.currentKernel;T.currentKernel=n,T.currentDay=0,r>0&&Ft(r),ae(n),Dt(0,!0),history.replaceState(null,"",`#kernel-${n}`)},100)))}else if(s.target.dataset.kernels==="true")(T.currentKernel!==0||T.currentDay!==0)&&(clearTimeout(c),c=setTimeout(()=>{const n=T.currentDay,o=T.currentKernel;T.currentDay=0,T.currentKernel=0,n>0&&Nt(n),o>0&&Ft(o),Dt(0,!0),history.replaceState(null,"","#kernels")},50));else{const n=window.location.hash,o=n==="#kernels"||n.startsWith("#kernel-");if(T.currentKernel===0&&!o){const r=parseInt(s.target.dataset.day);!isNaN(r)&&r!==T.currentDay&&(Math.abs(r-T.currentDay)<=1?(clearTimeout(c),c=setTimeout(()=>{Gi(r)},50)):(clearTimeout(c),c=setTimeout(()=>{const l=T.currentDay,h=T.currentKernel;T.currentDay=r,T.currentKernel=0,l>0&&Nt(l),h>0&&Ft(h),Kt(r),Dt(r),r>0?history.replaceState(null,"",`#day-${r}`):history.replaceState(null,""," ")},100)))}}}},t);T.sections.forEach(i=>e.observe(i)),T.sectionObserver=e,G.main.addEventListener("scroll",()=>{T.isScrolling=!0,clearTimeout(T.scrollEndTimeout),T.scrollEndTimeout=setTimeout(()=>{T.isScrolling=!1,!T.isInitializing&&!T.isProgrammaticScroll&&!T.isFullscreenTransition&&xn()},Wi.scrollDebounce)},{passive:!0})}function xn(){if(T.isProgrammaticScroll||T.currentKernel>0)return;const c=G.main.scrollTop,t=T.sections[0],e=t?t.offsetHeight:G.main.clientHeight;if(e<=0)return;const i=Math.round(c/e),s=Math.max(0,Math.min(_t,i));s!==T.currentDay&&Gi(s)}async function Gi(c){const t=T.currentDay,e=T.currentKernel;T.currentDay=c,T.currentKernel=0,t>0?Nt(t):e>0&&Ft(e),await Kt(c),Dt(c),li(c),c>0?history.replaceState(null,"",`#day-${c}`):history.replaceState(null,""," ")}async function wn(c){const t=T.currentDay,e=T.currentKernel;T.currentDay=0,T.currentKernel=c,t>0?Nt(t):e>0&&Ft(e),await ae(c),Dt(0,!0),history.replaceState(null,"",`#kernel-${c}`)}function Mn(){G.hamburger=document.getElementById("hamburger"),G.sidebar=document.getElementById("sidebar"),G.overlay=document.getElementById("nav-overlay");const c=document.getElementById("header-brand");G.hamburger.addEventListener("click",Sn),G.overlay.addEventListener("click",Te),c==null||c.addEventListener("click",()=>{Te()})}function Sn(){const c=document.getElementById("mobile-header");G.sidebar.classList.toggle("open"),G.overlay.classList.toggle("open"),G.hamburger.classList.toggle("active"),c==null||c.classList.toggle("menu-open")}function Te(){const c=document.getElementById("mobile-header");G.sidebar.classList.remove("open"),G.overlay.classList.remove("open"),G.hamburger.classList.remove("active"),c==null||c.classList.remove("menu-open")}function Tn(){document.addEventListener("click",t=>{const e=t.target.closest(".btn-restart");if(e){if(e.dataset.day){const s=parseInt(e.dataset.day);Ni(s)}else if(e.dataset.kernel){const s=parseInt(e.dataset.kernel);kn(s)}}const i=t.target.closest(".btn-fullscreen");if(i){if(i.dataset.day){const s=parseInt(i.dataset.day);Rn(s)}else if(i.dataset.kernel){const s=parseInt(i.dataset.kernel);Cn(s)}}});const c=document.querySelector(".nav-logo");c&&(c.style.cursor="pointer",c.addEventListener("click",()=>{Se(0),Te()})),document.addEventListener("fullscreenchange",Dn)}async function Ni(c){const t=`day-${c}`;T.games.has(t)&&(Nt(c),await Kt(c),console.log(`[Genuary] Restarted Day ${c}`))}async function kn(c){const t=`kernel-${c}`;T.games.has(t)&&(Ft(c),await ae(c),console.log(`[Genuary] Restarted Kernel ${c}`))}function Rn(c){const t=document.getElementById(`canvas-${c}`);if(!t)return;const e=t.parentElement;document.fullscreenElement?document.exitFullscreen():e.requestFullscreen().catch(i=>{console.warn("[Genuary] Fullscreen error:",i)})}function Cn(c){const t=document.getElementById(`kernel-canvas-${c}`);if(!t)return;const e=t.parentElement;document.fullscreenElement?document.exitFullscreen():e.requestFullscreen().catch(i=>{console.warn("[Genuary] Fullscreen error:",i)})}function Dn(){const c=!!document.fullscreenElement,t=T.currentDay,e=T.currentKernel;T.isFullscreenTransition=!0,setTimeout(()=>{let i,s,n;if(e>0?(i=document.getElementById(`kernel-canvas-${e}`),i&&(s=i.parentElement,n=T.kernelSections[e-1])):t>0&&(i=document.getElementById(`canvas-${t}`),i&&(s=i.parentElement,n=T.sections[t])),!i){T.isFullscreenTransition=!1;return}const o=s.clientWidth,r=s.clientHeight;(i.width!==o||i.height!==r)&&(e>0?(console.log(`[Genuary] Fullscreen ${c?"enter":"exit"} - resizing Kernel ${e}`),Ft(e),ae(e)):(console.log(`[Genuary] Fullscreen ${c?"enter":"exit"} - resizing Day ${t}`),Nt(t),Kt(t))),!c&&n&&n.scrollIntoView({behavior:"instant"}),setTimeout(()=>{T.isFullscreenTransition=!1},300)},150)}function En(){G.navUp=document.getElementById("nav-up"),G.navDown=document.getElementById("nav-down"),G.navUp.addEventListener("click",qe),G.navDown.addEventListener("click",$e),document.addEventListener("keydown",c=>{c.key==="ArrowUp"||c.key==="PageUp"?(c.preventDefault(),qe()):(c.key==="ArrowDown"||c.key==="PageDown")&&(c.preventDefault(),$e())})}function Pn(){let c;window.addEventListener("resize",()=>{clearTimeout(c),c=setTimeout(()=>{const t=T.currentDay,e=T.currentKernel;if(e>0){const i=T.games.get(`kernel-${e}`);if(i){if(i.handlesResize){const s=document.getElementById(`kernel-canvas-${e}`);if(s){const n=s.parentElement;s.width=n.clientWidth,s.height=n.clientHeight}console.log(`[Genuary] Kernel ${e} handles resize internally`);return}Ft(e),ae(e)}}else if(t>0){const i=T.games.get(`day-${t}`);if(i){if(i.handlesResize){const s=document.getElementById(`canvas-${t}`);if(s){const n=s.parentElement;s.width=n.clientWidth,s.height=n.clientHeight}console.log(`[Genuary] Day ${t} handles resize internally`);return}Nt(t),Kt(t)}}},250)})}function An(){const c=window.location.hash,t=c.match(/^#day-(\d+)$/);if(t){const i=parseInt(t[1]);if(i>=1&&i<=_t){T.currentDay=i,T.currentKernel=0,T.isProgrammaticScroll=!0;const s=T.sections[i];return s&&(s.scrollIntoView({behavior:"instant"}),s.classList.add("active"),Dt(i)),setTimeout(()=>{Kt(i),T.isProgrammaticScroll=!1,T.isInitializing=!1},100),!0}}const e=c.match(/^#kernel-(\d+)$/);if(e){const i=parseInt(e[1]);if(i>=1&&i<=Me){T.currentDay=0,T.currentKernel=i,T.isProgrammaticScroll=!0;const s=T.kernelSections[i-1];return s&&(s.scrollIntoView({behavior:"instant"}),s.classList.add("active"),Dt(0,!0)),setTimeout(()=>{ae(i),T.isProgrammaticScroll=!1,T.isInitializing=!1},100),!0}}if(c==="#kernels"){T.currentDay=0,T.currentKernel=0,T.isProgrammaticScroll=!0;const i=T.sections.find(s=>s.dataset.kernels==="true");return i&&(i.scrollIntoView({behavior:"instant"}),i.classList.add("active"),Dt(0,!0)),setTimeout(()=>{T.isProgrammaticScroll=!1,T.isInitializing=!1},100),!0}return!1}async function In(){console.log("[Genuary] Initializing..."),pn(),yn(),bn(),Mn(),En(),Tn(),Pn(),An()||(await Kt(T.currentDay),Dt(T.currentDay),li(T.currentDay),setTimeout(()=>{T.isInitializing=!1},500)),console.log("[Genuary] Ready!")}function Hi(){const c=document.getElementById("grid-svg"),t=document.getElementById("grid-lines");if(!c||!t)return;const e=window.innerWidth,i=window.innerHeight*_t;c.setAttribute("viewBox",`0 0 ${e} ${i}`),c.style.width="100%",c.style.height=`${_t*100}vh`,t.innerHTML="";const s=20,n=_t*8,o=i/_t;for(let r=0;r<=s;r++){const a=r/s*e,l=document.createElementNS("http://www.w3.org/2000/svg","path");let h=`M ${a} 0`;for(let d=0;d<_t;d++){const u=d*o,f=u+o/2,m=(1-Math.abs(a-e/2)/(e/2))*40,p=a+(a<e/2?m:-m);h+=` Q ${p} ${f}, ${a} ${u+o}`}l.setAttribute("d",h),l.setAttribute("stroke","url(#lineGradient)"),l.setAttribute("stroke-width","0.5"),l.setAttribute("fill","none"),l.setAttribute("opacity","0.5"),t.appendChild(l)}for(let r=0;r<=n;r++){const a=r/n*i,l=document.createElementNS("http://www.w3.org/2000/svg","path"),d=(Math.floor(a/o)+.5)*o,u=Math.abs(a-d)/(o/2),f=Math.max(0,1-u)*30;let g=`M 0 ${a}`;const m=e/2,p=a+f;g+=` Q ${m} ${p}, ${e} ${a}`,l.setAttribute("d",g),l.setAttribute("stroke","#0f0"),l.setAttribute("stroke-width","0.5"),l.setAttribute("fill","none"),l.setAttribute("opacity",`${.08+(1-u)*.15}`),t.appendChild(l)}for(let r=0;r<_t;r++){const a=(r+.5)*o,l=e/2;for(let h=1;h<=3;h++){const d=document.createElementNS("http://www.w3.org/2000/svg","ellipse");d.setAttribute("cx",l),d.setAttribute("cy",a),d.setAttribute("rx",80+h*60),d.setAttribute("ry",40+h*30),d.setAttribute("stroke","#0f0"),d.setAttribute("stroke-width","0.5"),d.setAttribute("fill","none"),d.setAttribute("opacity",`${.25-h*.05}`),t.appendChild(d)}}}function Ln(){let c;window.addEventListener("resize",()=>{clearTimeout(c),c=setTimeout(Hi,300)})}window.addEventListener("load",()=>{In(),Hi(),Ln()});export{hr as $,Un as A,rn as B,On as C,dt as D,lt as E,ki as F,dr as G,sr as H,ur as I,Li as J,Bs as K,Pi as L,$ as M,Pt as N,ir as O,y as P,er as Q,jn as R,Bi as S,Bt as T,Le as U,Zn as V,Ai as W,zs as X,ar as Y,nr as Z,lr as _,Yn as a,cr as a0,Hn as a1,_r as a2,vr as a3,gr as a4,mr as a5,br as a6,pr as a7,yr as a8,xr as a9,wr as aa,fe as ab,tr as ac,rr as ad,Ee as ae,an as b,gn as c,jt as d,fr as e,Xs as f,fi as g,Gn as h,Nn as i,Qn as j,Fi as k,Jn as l,zn as m,or as n,ue as o,Zt as p,$n as q,Kn as r,Fn as s,Wn as t,Xn as u,Yi as v,Ts as w,Vn as x,qn as y,cs as z};
