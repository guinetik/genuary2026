import{G as E,P as m,ab as X,M as Y}from"./index-DMqzgpv5.js";const n={expr:{variables:["A","B","C","D","E"],maxDepth:5,notProbability:.22,ops:["AND","OR","XOR","NAND","NOR","XNOR"]},layout:{margin:70,layerGap:150,leafGap:80,nodeW:92,nodeH:46,portOffsetY:12,elbowX:60},render:{backgroundAlpha:.14,blendMode:"screen",wireWidth:2,wireWidthHot:3,gateRadius:10,font:'12px "Fira Code", monospace',signalRadius:4.2,explanationFont:'14px "Fira Code", monospace',explanationSmallFont:'11px "Fira Code", monospace'},animation:{clockHz:.55,jitterHz:.12,packetSpeed:.6,packetSpacing:.33},colors:{bg:"#000",gateStroke:"rgba(0, 255, 0, 0.55)",wireOff:"rgba(0, 255, 0, 0.16)",wireOn:"rgba(0, 255, 0, 0.75)",wireHot:"rgba(255, 255, 255, 0.85)",signalOff:"rgba(0, 255, 0, 0.25)",signalOn:"rgba(0, 255, 0, 0.95)",signalHot:"rgba(255, 255, 255, 0.95)",text:"rgba(0, 255, 0, 0.85)"}};function T(r){return r-Math.floor(r)}function b(r,t,e){return r+(t-r)*e}function L(r){return r<.5?2*r*r:1-Math.pow(-2*r+2,2)/2}class S{constructor(t){this.cfg=t}node(t){const{vars:e,maxDepth:s,notProbability:o}=this.cfg;if(t>=s||Math.random()<.22){let g={type:"var",name:e[Math.floor(Math.random()*e.length)]};return Math.random()<o&&(g={type:"not",a:g}),g}const i=this.node(t+1),l=this.node(t+1);let u={type:"bin",op:this.cfg.ops[Math.floor(Math.random()*this.cfg.ops.length)],a:i,b:l};return Math.random()<o*.6&&(u={type:"not",a:u}),u}toString(t){return t.type==="var"?t.name:t.type==="not"?`NOT(${this.toString(t.a)})`:`(${this.toString(t.a)} ${t.op} ${this.toString(t.b)})`}}function F(r){let t=0;const e=new Map,s=o=>{const h=e.get(o);if(h)return h;const i={id:`n${t++}`,type:o.type,name:o.type==="var"?o.name:void 0,value:o.type==="const"?!!o.value:void 0,inputs:[],x:0,y:0,depth:0};return e.set(o,i),o.type==="not"?i.inputs=[s(o.left)]:(o.type==="and"||o.type==="or"||o.type==="xor"||o.type==="nand"||o.type==="nor"||o.type==="xnor")&&(i.inputs=[s(o.left),s(o.right)]),i};return s(r)}function P(r){const t=[],e=[];let s=0;const o=[],h=(a,f)=>{if(a.depth=f,t.push(a),a.inputs.length===0){o.push(a);return}for(let y=0;y<a.inputs.length;y++){const M=a.inputs[y];e.push({id:`e${s++}`,from:M,to:a,portIndex:y===0?0:1}),h(M,f+1)}};h(r,0);const i=t.reduce((a,f)=>Math.max(a,f.depth),0);for(const a of t)a.depth=i-a.depth;for(let a=0;a<o.length;a++)o[a].y=a*n.layout.leafGap;const l=[...t].sort((a,f)=>f.depth-a.depth);for(const a of l)if(a.inputs.length>0){const f=a.inputs.map(y=>y.y);a.y=f.reduce((y,M)=>y+M,0)/f.length}for(const a of t)a.x=a.depth*n.layout.layerGap;const c=Math.min(...t.map(a=>a.y)),u=Math.max(...t.map(a=>a.y)),g=(c+u)/2;for(const a of t)a.y-=g;const d=Math.min(...t.map(a=>a.x)),x=Math.max(...t.map(a=>a.x)),v=(d+x)/2;for(const a of t)a.x-=v;return{nodes:t,edges:e,maxDepth:i}}function p(r,t){switch(r.type){case"const":return!!r.value;case"var":return!!(t[r.name]??!1);case"not":return!p(r.inputs[0],t);case"and":return p(r.inputs[0],t)&&p(r.inputs[1],t);case"nand":return!(p(r.inputs[0],t)&&p(r.inputs[1],t));case"or":return p(r.inputs[0],t)||p(r.inputs[1],t);case"nor":return!(p(r.inputs[0],t)||p(r.inputs[1],t));case"xor":{const e=p(r.inputs[0],t),s=p(r.inputs[1],t);return e&&!s||!e&&s}case"xnor":{const e=p(r.inputs[0],t),s=p(r.inputs[1],t);return e===s}default:return!1}}class W extends E{constructor(t){super(t),this.backgroundColor=n.colors.bg}init(){super.init(),m.init(this.ctx),this.container=this.canvas.parentElement,this.container&&this.enableFluidSize(this.container),this.time=0,this.clock=0,this.zoom=1,this.targetZoom=1,this.offsetX=0,this.offsetY=0,this.targetOffsetX=0,this.targetOffsetY=0,this.isDragging=!1,this.hasDragged=!1,this.lastMouseX=0,this.lastMouseY=0,this.mouseDownTime=0,this.touches=new Map,this.lastPinchDist=0,this.touchStartTime=0,this.touchMoved=!1,this.setupMouseControls(),this.setupTouchControls(),this.setupWheelControls(),this._onFullscreenChange=()=>{this.setupWheelControls()},document.addEventListener("fullscreenchange",this._onFullscreenChange),document.addEventListener("webkitfullscreenchange",this._onFullscreenChange),document.addEventListener("mozfullscreenchange",this._onFullscreenChange),document.addEventListener("MSFullscreenChange",this._onFullscreenChange),this.regenerate()}stop(){super.stop(),this._onMouseDown&&this.canvas.removeEventListener("mousedown",this._onMouseDown),this._onMouseMove&&this.canvas.removeEventListener("mousemove",this._onMouseMove),this._onMouseUp&&this.canvas.removeEventListener("mouseup",this._onMouseUp),this._onMouseLeave&&this.canvas.removeEventListener("mouseleave",this._onMouseLeave),this._onWheel&&(this.canvas.removeEventListener("wheel",this._onWheel),this.container&&this.container.removeEventListener("wheel",this._onWheel)),this._onTouchStart&&this.canvas.removeEventListener("touchstart",this._onTouchStart),this._onTouchMove&&this.canvas.removeEventListener("touchmove",this._onTouchMove),this._onTouchEnd&&this.canvas.removeEventListener("touchend",this._onTouchEnd),this._onTouchCancel&&this.canvas.removeEventListener("touchcancel",this._onTouchCancel),this._onFullscreenChange&&(document.removeEventListener("fullscreenchange",this._onFullscreenChange),document.removeEventListener("webkitfullscreenchange",this._onFullscreenChange),document.removeEventListener("mozfullscreenchange",this._onFullscreenChange),document.removeEventListener("MSFullscreenChange",this._onFullscreenChange))}setupMouseControls(){this._onMouseDown=t=>{this.isDragging=!0,this.hasDragged=!1,this.mouseDownTime=Date.now();const e=this.canvas.getBoundingClientRect();this.lastMouseX=t.clientX-e.left,this.lastMouseY=t.clientY-e.top},this._onMouseMove=t=>{if(!this.isDragging)return;const e=this.canvas.getBoundingClientRect(),s=t.clientX-e.left,o=t.clientY-e.top,h=Math.abs(s-this.lastMouseX),i=Math.abs(o-this.lastMouseY);(h>5||i>5)&&(this.hasDragged=!0);const l=(s-this.lastMouseX)/this.zoom,c=(o-this.lastMouseY)/this.zoom;this.targetOffsetX+=l,this.targetOffsetY+=c,this.lastMouseX=s,this.lastMouseY=o},this._onMouseUp=()=>{const e=Date.now()-this.mouseDownTime;!this.hasDragged&&e<300&&(this.regenerate(),this.targetZoom=1,this.targetOffsetX=0,this.targetOffsetY=0),this.isDragging=!1},this._onMouseLeave=()=>{this.isDragging=!1},this.canvas.addEventListener("mousedown",this._onMouseDown),this.canvas.addEventListener("mousemove",this._onMouseMove),this.canvas.addEventListener("mouseup",this._onMouseUp),this.canvas.addEventListener("mouseleave",this._onMouseLeave)}setupWheelControls(){this._onWheel&&(this.canvas.removeEventListener("wheel",this._onWheel),this.container&&this.container.removeEventListener("wheel",this._onWheel)),this._onWheel=t=>{t.preventDefault(),t.stopPropagation();const e=t.deltaY>0?.9:1.1;this.targetZoom*=e,this.targetZoom=Math.max(.1,Math.min(5,this.targetZoom))},this.canvas.addEventListener("wheel",this._onWheel,{passive:!1}),this.container&&this.container.addEventListener("wheel",this._onWheel,{passive:!1})}setupTouchControls(){this._onTouchStart=t=>{t.preventDefault(),this.touchStartTime=Date.now(),this.touchMoved=!1;for(const e of t.changedTouches)this.touches.set(e.identifier,{x:e.clientX,y:e.clientY});if(this.touches.size===2){const[e,s]=Array.from(this.touches.values());this.lastPinchDist=Math.hypot(s.x-e.x,s.y-e.y),this.lastPinchCenterX=(e.x+s.x)/2,this.lastPinchCenterY=(e.y+s.y)/2,this.isDragging=!1}if(this.touches.size===1){this.isDragging=!0,this.hasDragged=!1;const e=t.touches[0],s=this.canvas.getBoundingClientRect();this.lastMouseX=e.clientX-s.left,this.lastMouseY=e.clientY-s.top}},this._onTouchMove=t=>{t.preventDefault();for(const e of t.changedTouches)this.touches.has(e.identifier)&&this.touches.set(e.identifier,{x:e.clientX,y:e.clientY});if(this.touches.size===2){const[e,s]=Array.from(this.touches.values()),o=Math.hypot(s.x-e.x,s.y-e.y),h=(e.x+s.x)/2,i=(e.y+s.y)/2;if(this.lastPinchDist>0){const l=o/this.lastPinchDist;this.targetZoom*=l,this.targetZoom=Math.max(.1,Math.min(5,this.targetZoom)),this.touchMoved=!0,this.canvas.getBoundingClientRect();const c=(h-this.lastPinchCenterX)/this.zoom,u=(i-this.lastPinchCenterY)/this.zoom;this.targetOffsetX+=c,this.targetOffsetY+=u}this.lastPinchDist=o,this.lastPinchCenterX=h,this.lastPinchCenterY=i}else if(this.touches.size===1&&this.isDragging){const e=t.touches[0],s=this.canvas.getBoundingClientRect(),o=e.clientX-s.left,h=e.clientY-s.top,i=Math.abs(o-this.lastMouseX),l=Math.abs(h-this.lastMouseY);(i>5||l>5)&&(this.hasDragged=!0,this.touchMoved=!0);const c=(o-this.lastMouseX)/this.zoom,u=(h-this.lastMouseY)/this.zoom;this.targetOffsetX+=c,this.targetOffsetY+=u,this.lastMouseX=o,this.lastMouseY=h}},this._onTouchEnd=t=>{t.preventDefault();for(const e of t.changedTouches)this.touches.delete(e.identifier);if(this.touches.size<2&&(this.lastPinchDist=0),this.touches.size===0){this.isDragging=!1;const s=Date.now()-this.touchStartTime;!this.touchMoved&&!this.hasDragged&&s<300&&(this.regenerate(),this.targetZoom=1,this.targetOffsetX=0,this.targetOffsetY=0)}},this._onTouchCancel=()=>{this.touches.clear(),this.lastPinchDist=0,this.isDragging=!1},this.canvas.addEventListener("touchstart",this._onTouchStart,{passive:!1}),this.canvas.addEventListener("touchmove",this._onTouchMove,{passive:!1}),this.canvas.addEventListener("touchend",this._onTouchEnd,{passive:!1}),this.canvas.addEventListener("touchcancel",this._onTouchCancel,{passive:!1})}regenerate(){const t=new S({vars:n.expr.variables,ops:n.expr.ops,maxDepth:n.expr.maxDepth,notProbability:n.expr.notProbability});this.expression=t.toString(t.node(0)),this.ast=X.parse(this.expression),this.root=F(this.ast);const{nodes:e,edges:s}=P(this.root);this.nodes=e,this.edges=s,!this.isDragging&&this.touches.size===0&&(this.targetZoom=1,this.targetOffsetX=0,this.targetOffsetY=0)}buildEnv(t){const e={},s=t*n.animation.clockHz*2*Math.PI,o=t*n.animation.jitterHz*2*Math.PI;for(let h=0;h<n.expr.variables.length;h++){const i=n.expr.variables[h],l=h*1.7,c=Math.sin(s+l)+.35*Math.sin(o+l*2.2);e[i]=c>0}return e}update(t){super.update(t),this.time+=t,this.zoom+=(this.targetZoom-this.zoom)*.15,this.offsetX+=(this.targetOffsetX-this.offsetX)*.15,this.offsetY+=(this.targetOffsetY-this.offsetY)*.15}render(){m.setContext(this.ctx),this.ctx.setTransform(1,0,0,1,0,0),this.ctx.fillStyle=`rgba(0,0,0,${n.render.backgroundAlpha})`,this.ctx.fillRect(0,0,this.width,this.height);const t=this.buildEnv(this.time),e=n.layout.margin,s=this.getCircuitBounds(),o=Math.max(1,this.width-e*2),h=Math.max(1,this.height-e*2),i=o/Math.max(1,s.w),l=h/Math.max(1,s.h),u=Math.min(i,l)*this.zoom;m.useCtx(g=>{g.globalCompositeOperation=n.render.blendMode,g.translate(this.width/2,this.height/2),g.translate(this.offsetX,this.offsetY),g.scale(u,u);for(let d=0;d<this.edges.length;d++){const x=this.edges[d],v=p(x.from,t),a=p(x.to,t),f=v&&a,y=f?n.colors.wireHot:v?n.colors.wireOn:n.colors.wireOff,M=f?n.render.wireWidthHot:n.render.wireWidth,w=this.getWirePath(x);this.drawPolyline(w,y,M);const D=this.time*n.animation.packetSpeed-d*n.animation.packetSpacing,O=T(D),C=this.samplePolyline(w,O),_=f?n.colors.signalHot:v?n.colors.signalOn:n.colors.signalOff;m.shapes.fillCircle(C.x,C.y,n.render.signalRadius,_)}for(const d of this.nodes)this.drawGate(d,t)},{saveState:!0}),this.ctx.globalCompositeOperation="source-over",this.drawExplanation(t)}drawExplanation(t){const e=this.ctx,s=20,o=20,h=16;e.save(),e.globalCompositeOperation="source-over",e.font=n.render.explanationFont,e.fillStyle=n.colors.text,e.textAlign="left",e.textBaseline="top";let i=s;e.font=n.render.explanationFont,e.fillStyle=n.colors.text,e.fillText("BOOLEAN ALGEBRA CIRCUIT",s,i),i+=o+8,e.font=n.render.explanationSmallFont,e.fillStyle="rgba(0, 255, 0, 0.7)",e.fillText(`Expression: ${this.expression}`,s,i),i+=h+4;const l=p(this.root,t);e.fillStyle=l?n.colors.wireOn:n.colors.wireOff,e.fillText(`Output: ${l?"TRUE":"FALSE"}`,s,i),i+=h+12,e.fillStyle=n.colors.text,e.fillText("Inputs:",s,i),i+=h;for(const[c,u]of Object.entries(t))e.fillStyle=u?n.colors.wireOn:n.colors.wireOff,e.fillText(`  ${c}: ${u?"TRUE":"FALSE"}`,s,i),i+=h;i+=8,e.font=n.render.explanationSmallFont,e.fillStyle="rgba(0, 255, 0, 0.5)",e.fillText("Click: New expression | Drag: Pan | Scroll: Zoom",s,i),i+=h,e.fillText("Green = OFF | Bright = ON | Dots = Data packets",s,i),e.restore()}getCircuitBounds(){const t=n.layout.nodeW/2,e=n.layout.nodeH/2,s=Math.min(...this.nodes.map(l=>l.x-t)),o=Math.max(...this.nodes.map(l=>l.x+t)),h=Math.min(...this.nodes.map(l=>l.y-e)),i=Math.max(...this.nodes.map(l=>l.y+e));return{minX:s,maxX:o,minY:h,maxY:i,w:o-s,h:i-h}}getWirePath(t){const e=n.layout.nodeW/2,s=t.to.inputs.length===1?0:t.portIndex===0?-12:n.layout.portOffsetY,o=t.from.x+e,h=t.from.y,i=t.to.x-e,l=t.to.y+s,c=b(o,i,.5),u=Math.min(c,o+n.layout.elbowX),g=Math.max(c,i-n.layout.elbowX);return[{x:o,y:h},{x:u,y:h},{x:g,y:l},{x:i,y:l}]}drawPolyline(t,e,s){for(let o=0;o<t.length-1;o++)m.lines.line(t[o].x,t[o].y,t[o+1].x,t[o+1].y,e,s)}samplePolyline(t,e){const s=[];let o=0;for(let c=0;c<t.length-1;c++){const u=t[c].x,g=t[c].y,d=t[c+1].x,x=t[c+1].y,v=Math.hypot(d-u,x-g);s.push({ax:u,ay:g,bx:d,by:x,len:v}),o+=v}const h=e*o;let i=0;for(const c of s){if(i+c.len>=h){const u=(h-i)/(c.len||1);return{x:b(c.ax,c.bx,u),y:b(c.ay,c.by,u)}}i+=c.len}const l=t[t.length-1];return{x:l.x,y:l.y}}drawGate(t,e){const s=n.layout.nodeW/2,o=n.layout.nodeH/2,h=t.x-s,i=t.y-o,l=p(t,e),c=Y.pulse(0,1,this.time,1,!0,!0).value,g=`rgba(0,255,0,${.04+(l?.35+.65*L(c):.05)*.08})`,d=l?n.colors.wireOn:n.colors.gateStroke;m.shapes.fillRoundRect(h,i,n.layout.nodeW,n.layout.nodeH,n.render.gateRadius,g),m.shapes.strokeRoundRect(h,i,n.layout.nodeW,n.layout.nodeH,n.render.gateRadius,d,2);const x=t.x+s,v=t.y;m.shapes.fillCircle(x,v,2.6,l?n.colors.signalOn:n.colors.signalOff),t.inputs.length===1?m.shapes.fillCircle(t.x-s,t.y,2.6,"rgba(0,255,0,0.35)"):t.inputs.length===2&&(m.shapes.fillCircle(t.x-s,t.y-n.layout.portOffsetY,2.6,"rgba(0,255,0,0.35)"),m.shapes.fillCircle(t.x-s,t.y+n.layout.portOffsetY,2.6,"rgba(0,255,0,0.35)"));const a=t.type==="var"?t.name:t.type==="const"?t.value?"1":"0":t.type.toUpperCase();m.useCtx(f=>{f.font=n.render.font,f.fillStyle=n.colors.text,f.textAlign="center",f.textBaseline="middle",f.fillText(a,t.x,t.y)})}}function R(r){const t=new W(r);return t.start(),{stop:()=>t.stop(),game:t}}export{R as default};
