import{G as M,P as S,C as w,Y as v,c as P}from"./index-3oaVaAML.js";const h={background:"#000",maxDepth:3,particleBaseSize:20,particleMinSize:2,particleShape:"square",colors:{stroke:"#0f0"},camera:{perspective:800,rotationX:.5,rotationY:-.6,inertia:!0,friction:.92,clampX:!1},animation:{autoRotateSpeed:.15,attractStrength:8,damping:.92,scatterForce:800,buildDelay:.003}},f=[{x:1,y:0,z:0},{x:-1,y:0,z:0},{x:0,y:-1,z:0},{x:0,y:1,z:0},{x:0,y:0,z:1},{x:0,y:0,z:-1},{x:1,y:-1,z:0},{x:-1,y:-1,z:0},{x:1,y:1,z:0},{x:-1,y:1,z:0},{x:1,y:0,z:1},{x:-1,y:0,z:1},{x:1,y:0,z:-1},{x:-1,y:0,z:-1},{x:0,y:-1,z:1},{x:0,y:-1,z:-1},{x:0,y:1,z:1},{x:0,y:1,z:-1}];function b(x,t,s,o,n,i,a=[]){if(n>=i)return a.push({x,y:t,z:s,size:o,depth:n}),a;const r=o/3,c=o/3;for(let l=-1;l<=1;l++)for(let e=-1;e<=1;e++)for(let p=-1;p<=1;p++){if((l===0?1:0)+(e===0?1:0)+(p===0?1:0)>=2)continue;const d=x+l*c,z=t+e*c,y=s+p*c;b(d,z,y,r,n+1,i,a)}return a}class C extends M{constructor(t){super(t),this.backgroundColor=h.background}init(){super.init(),S.init(this.ctx),this.camera=new w({perspective:h.camera.perspective,rotationX:h.camera.rotationX,rotationY:h.camera.rotationY,inertia:h.camera.inertia,friction:h.camera.friction,clampX:h.camera.clampX}),this.camera.enableMouseControl(this.canvas),this.time=0,this.globalRotation=0,this.zoom=1,this.targetZoom=1,this.buildTime=0,this.cubesSpawned=0,this.spongeCount=0,this.totalParticles=0,this.existingPositions=new Set,this.positionTolerance=.1,this.nextCubeIndex=0,this.generateTargets(),this.createParticleSystem(),this.canvas.addEventListener("dblclick",()=>{this.scatterParticles()}),this.gesture=new v(this.canvas,{onZoom:t=>{const s=t>0?1.1:.9;this.targetZoom=Math.max(.3,Math.min(15,this.targetZoom*s))},onTap:()=>{this.scatterParticles()}})}stop(){super.stop(),this.gesture&&this.gesture.destroy()}generateTargets(){const s=Math.min(this.width,this.height)*.35,o=b(0,0,0,s,0,h.maxDepth);o.sort((i,a)=>i.depth-a.depth);const n=this.positionTolerance;this.cubes=o.map((i,a)=>{const r=`${Math.round(i.x/n)},${Math.round(i.y/n)},${Math.round(i.z/n)}`;return this.existingPositions.add(r),{x:i.x,y:i.y,z:i.z,size:i.size,spawnDelay:a*h.animation.buildDelay,spawned:!1}}),console.log(`Menger Sponge: ${this.cubes.length} cubes/particles`)}createParticleSystem(){this._cosY=1,this._sinY=0,this._strength=h.animation.attractStrength,this._damping=h.animation.damping;const t=(s,o)=>{if(!s.alive)return;const n=s.custom;if(n.targetX===void 0)return;const i=n.targetX*this._cosY-n.targetZ*this._sinY,a=n.targetX*this._sinY+n.targetZ*this._cosY,r=this.zoom,c=i*r-s.x,l=n.targetY*r-s.y,e=a*r-s.z,p=this._strength*o,g=this._damping;s.vx=(s.vx+c*p)*g,s.vy=(s.vy+l*p)*g,s.vz=(s.vz+e*p)*g,s.x+=s.vx*o,s.y+=s.vy*o,s.z+=s.vz*o};this.particles=new P(this,{camera:this.camera,depthSort:!0,maxParticles:5e4,blendMode:"source-over",updaters:[t]}),this.pipeline.add(this.particles)}spawnCube(t){const s=this._spawnRadius||(this._spawnRadius=Math.max(this.width,this.height)*.8),o=Math.random()*Math.PI*2,n=Math.acos(2*Math.random()-1),i=s*(.3+Math.random()*.7),a=Math.sin(n),r=i*a*Math.cos(o),c=i*a*Math.sin(o),l=i*Math.cos(n),e=this.particles.acquire();e.x=r,e.y=c,e.z=l,e.vx=-r*.5,e.vy=-c*.5,e.vz=-l*.5;const p=this._baseSizeRef||(this._baseSizeRef=Math.min(this.width,this.height)*.35);e.size=Math.max(h.particleMinSize,h.particleBaseSize*t.size/p),e.color.r=0,e.color.g=255,e.color.b=0,e.color.a=1,e.shape=h.particleShape,e.age=0,e.lifetime=1/0,e.alive=!0,e.custom.targetX=t.x,e.custom.targetY=t.y,e.custom.targetZ=t.z,this.particles.particles.push(e),t.spawned=!0,this.cubesSpawned++}scatterParticles(){const t=this.particles.particles,s=h.animation.scatterForce;for(let o=0,n=t.length;o<n;o++){const i=t[o];if(!i.alive)continue;const a=Math.random()*Math.PI*2,r=Math.acos(2*Math.random()-1),c=s*(.5+Math.random()),l=Math.sin(r);i.vx+=c*l*Math.cos(a),i.vy+=c*l*Math.sin(a),i.vz+=c*Math.cos(r)}}update(t){for(super.update(t),this.time+=t,this.buildTime+=t,this.camera.update(t),this.globalRotation+=h.animation.autoRotateSpeed*t,this._cosY=Math.cos(this.globalRotation),this._sinY=Math.sin(this.globalRotation),this.zoom+=(this.targetZoom-this.zoom)*.15;this.nextCubeIndex<this.cubes.length;){const s=this.cubes[this.nextCubeIndex];if(this.buildTime>=s.spawnDelay)this.spawnCube(s),this.nextCubeIndex++;else break}this.nextCubeIndex>=this.cubes.length&&this.spawnNextSponge()}spawnNextSponge(){this.spongeCount++,this.totalParticles+=this.cubesSpawned;const s=Math.min(this.width,this.height)*.35,o=s,n=Math.floor(this.spongeCount/f.length)+1,i=(this.spongeCount-1)%f.length,a=f[i],r=a.x*o*n,c=a.y*o*n,l=a.z*o*n,e=b(r,c,l,s,0,h.maxDepth),p=this.positionTolerance,g=this.existingPositions,d=[];for(const u of e){const m=`${Math.round(u.x/p)},${Math.round(u.y/p)},${Math.round(u.z/p)}`;g.has(m)||(g.add(m),d.push(u))}d.sort((u,m)=>u.depth-m.depth);const z=this.buildTime;for(let u=0;u<d.length;u++){const m=d[u];this.cubes.push({x:m.x,y:m.y,z:m.z,size:m.size,spawnDelay:z+u*h.animation.buildDelay,spawned:!1})}const y=e.length-d.length;console.log(`Sponge #${this.spongeCount+1} | New: ${d.length} | Shared: ${y}`)}clear(){this.ctx.fillStyle="rgba(0, 0, 0, 0.1)",this.ctx.fillRect(0,0,this.width,this.height)}render(){super.render();const t=this.ctx;t.fillStyle=h.colors.stroke,t.font="12px monospace",t.textAlign="left",t.fillText(`MENGER SPONGE | Depth: ${h.maxDepth} | Sponges: ${this.spongeCount+1} | Particles: ${this.cubesSpawned}`,10,this.height-10),t.textAlign="right",t.fillText(`Zoom: ${this.zoom.toFixed(1)}x | Dbl-click to scatter`,this.width-10,20)}onResize(){this._spawnRadius=null,this._baseSizeRef=null}}function _(x){const t=new C(x);return t.start(),{stop:()=>t.stop(),game:t}}export{_ as default};
