import{G as d,P as h}from"./gcanvas.es-DYEWWlgH.js";const o={IRRATIONAL:0,RATIONAL:1,CHAOS:2},a={activePathLength:150,bakeInterval:60,circles:[{outerR:140,innerR:50,traceR:35,speed:1},{outerR:100,innerR:35,traceR:25,speed:.7},{outerR:180,innerR:60,traceR:45,speed:1.3}],traceAngleMultiplier:2,rationalPi:3,wanderRadiusRatio:.15,wanderFreqX:Math.sqrt(2)*.3,wanderFreqY:Math.sqrt(3)*.25,hueSpeed1:10,hueSpeed2:15,hueSpeed3:8,hueOffsets:[0,120,240],timeStep:.015,glowLayers:[20,15,10,5],rationalMessageStart:20,rationalMessageEnd:25,irrationalMessageStart:50,irrationalMessageEnd:55,chaosMessageStart:30,chaosMessageEnd:35};class u{constructor(e,s,t){this.outerR=e.outerR*s,this.innerR=e.innerR*s,this.traceR=e.traceR*s,this.speed=e.speed,this.hueOffset=t,this.path=[]}update(e,s,t,i,n){const r=e*this.speed,c=e*s*this.speed;this.cx1=t+this.outerR*Math.cos(r),this.cy1=i+this.outerR*Math.sin(r),this.cx2=this.cx1+this.innerR*Math.cos(c),this.cy2=this.cy1+this.innerR*Math.sin(c);const f=c*a.traceAngleMultiplier;this.px=this.cx2+this.traceR*Math.cos(f),this.py=this.cy2+this.traceR*Math.sin(f),this.hue=(n+this.hueOffset)%360,this.path.push({x:this.px,y:this.py,hue:this.hue})}extractPointsToBake(){if(this.path.length<=a.activePathLength)return[];const e=this.path.length-a.activePathLength;return this.path.splice(0,e)}reset(){this.path=[]}}class g extends d{constructor(e){super(e),this.backgroundColor="#05000f"}init(){super.init(),h.init(this.ctx),this.time=0,this.mode=o.RATIONAL,this.isAnimating=!0,this.scale=Math.min(this.width,this.height)/600,this.circles=a.circles.map((e,s)=>new u(e,this.scale,a.hueOffsets[s])),this.baseCenterX=this.width/2,this.baseCenterY=this.height/2,this.centerX=this.baseCenterX,this.centerY=this.baseCenterY,this.wanderRadius=Math.min(this.width,this.height)*a.wanderRadiusRatio,this.offscreenCanvas=document.createElement("canvas"),this.offscreenCanvas.width=this.width,this.offscreenCanvas.height=this.height,this.offscreenCtx=this.offscreenCanvas.getContext("2d"),this.clearOffscreen(),this.frameCount=0,this._clickHandler||(this._clickHandler=()=>this.toggleMode(),this.canvas.addEventListener("click",this._clickHandler)),this._keyHandler||(this._keyHandler=e=>{e.code==="Space"?(e.preventDefault(),this.isAnimating=!this.isAnimating):e.code==="KeyR"&&this.reset()},this.canvas.addEventListener("keydown",this._keyHandler)),this.canvas.tabIndex=0,this.canvas.focus()}toggleMode(){this.mode=(this.mode+1)%3,this.reset()}reset(){this.time=0,this.frameCount=0,this.centerX=this.baseCenterX,this.centerY=this.baseCenterY,this.circles.forEach(e=>e.reset()),h.save(),h.effects.clearShadow(),h.effects.setBlendMode("source-over"),h.shapes.rect(0,0,this.canvas.width,this.canvas.height,this.backgroundColor),h.restore(),this.offscreenCanvas=document.createElement("canvas"),this.offscreenCanvas.width=this.canvas.width,this.offscreenCanvas.height=this.canvas.height,this.offscreenCtx=this.offscreenCanvas.getContext("2d"),this.offscreenCtx.fillStyle=this.backgroundColor,this.offscreenCtx.fillRect(0,0,this.offscreenCanvas.width,this.offscreenCanvas.height)}clearOffscreen(){if(this.offscreenCtx){const e=this.offscreenCtx;e.save(),e.setTransform(1,0,0,1,0,0),e.shadowBlur=0,e.globalCompositeOperation="source-over",e.globalAlpha=1,e.fillStyle=this.backgroundColor,e.fillRect(0,0,this.offscreenCanvas.width,this.offscreenCanvas.height),e.restore()}}get piValue(){return this.mode===o.RATIONAL?a.rationalPi:Math.PI}get isChaosMode(){return this.mode===o.CHAOS}update(e){if(super.update(e),!this.isAnimating)return;this.time+=a.timeStep,this.isChaosMode?(this.centerX=this.baseCenterX+Math.sin(this.time*a.wanderFreqX)*this.wanderRadius,this.centerY=this.baseCenterY+Math.sin(this.time*a.wanderFreqY)*this.wanderRadius):(this.centerX=this.baseCenterX,this.centerY=this.baseCenterY);const s=this.time*a.hueSpeed1%360,t=this.time*a.hueSpeed2%360,i=this.time*a.hueSpeed3%360,n=[s,t,i];this.circles.forEach((r,c)=>{r.update(this.time,this.piValue,this.centerX,this.centerY,n[c])}),this.frameCount++,this.frameCount%a.bakeInterval===0&&this.bakeTrails()}bakeTrails(){const e=this.offscreenCtx;e.fillStyle="rgba(5, 0, 15, 0.02)",e.fillRect(0,0,this.width,this.height),this.circles.forEach(s=>{const t=s.extractPointsToBake();if(!(t.length<2)){e.lineCap="round",e.lineJoin="round",e.shadowBlur=12,e.shadowColor=`hsla(${t[0].hue}, 100%, 60%, 0.6)`,e.lineWidth=3,e.beginPath(),e.moveTo(t[0].x,t[0].y);for(let i=1;i<t.length;i++)e.lineTo(t[i].x,t[i].y);e.strokeStyle=`hsla(${t[t.length-1].hue}, 100%, 55%, 0.6)`,e.stroke(),e.shadowBlur=0,e.lineWidth=2,e.beginPath(),e.moveTo(t[0].x,t[0].y);for(let i=1;i<t.length;i++)e.lineTo(t[i].x,t[i].y);e.strokeStyle=`hsla(${t[t.length-1].hue}, 100%, 65%, 0.8)`,e.stroke()}})}render(){this.offscreenCanvas?this.ctx.drawImage(this.offscreenCanvas,0,0):h.shapes.rect(0,0,this.width,this.height,this.backgroundColor),this.circles.forEach(e=>{this.renderCirclePath(e),this.renderCircleGeometry(e),this.renderTracingPoint(e)}),h.effects.clearShadow(),this.renderUI()}renderCirclePath(e){const s=this.ctx,t=e.path;if(!(t.length<2)){a.glowLayers.forEach(i=>{h.effects.dropShadow(`hsla(${e.hue}, 100%, 60%, 0.4)`,i),h.colors.stroke(`hsla(${e.hue}, 100%, ${50+i}%, 0.3)`,3),s.beginPath(),s.moveTo(t[0].x,t[0].y);for(let n=1;n<t.length;n++){const r=n/t.length,c=(t[n].hue+r*30)%360;s.strokeStyle=`hsla(${c}, 100%, ${50+r*30}%, ${r*.6})`,s.lineTo(t[n].x,t[n].y)}s.stroke()}),h.effects.clearShadow(),h.colors.stroke(`hsla(${e.hue}, 100%, 70%, 0.9)`,2),s.beginPath(),s.moveTo(t[0].x,t[0].y);for(let i=1;i<t.length;i++)s.lineTo(t[i].x,t[i].y);s.stroke()}}renderCircleGeometry(e){h.effects.dropShadow(`hsla(${e.hue}, 100%, 60%, 0.5)`,30),h.shapes.strokeCircle(e.cx1,e.cy1,e.innerR,`hsla(${e.hue}, 80%, 60%, 0.2)`,2),h.shapes.strokeCircle(e.cx2,e.cy2,e.traceR,`hsla(${e.hue}, 80%, 60%, 0.2)`,2),h.effects.dropShadow(`hsla(${e.hue}, 100%, 60%, 0.5)`,15);const s=this.ctx;s.beginPath(),s.moveTo(this.centerX,this.centerY),s.lineTo(e.cx1,e.cy1),s.lineTo(e.cx2,e.cy2),s.lineTo(e.px,e.py),h.colors.stroke(`hsla(${e.hue}, 70%, 60%, 0.15)`,1)}renderTracingPoint(e){const s=h.colors.radialGradient(e.px,e.py,0,e.px,e.py,15,[{offset:0,color:`hsla(${e.hue}, 100%, 80%, 1)`},{offset:.5,color:`hsla(${e.hue}, 100%, 60%, 0.6)`},{offset:1,color:`hsla(${e.hue}, 100%, 40%, 0)`}]);h.effects.dropShadow(`hsla(${e.hue}, 100%, 60%, 0.8)`,25),h.shapes.fillCircle(e.px,e.py,15,s)}getModeLabel(){switch(this.mode){case o.RATIONAL:return"n = 3.14";case o.CHAOS:return"n = π + drift";default:return"n = π"}}renderUI(){const e=12*this.scale,s=16*this.scale,t=`${e}px monospace`,i=`${s}px monospace`;h.text.fillText(this.getModeLabel(),20,30,"rgba(255, 255, 255, 0.15)",t),h.text.fillText(`θ = ${this.time.toFixed(2)}`,20,50,"rgba(255, 255, 255, 0.15)",t),this.mode===o.RATIONAL&&this.time>a.rationalMessageStart&&this.time<a.rationalMessageEnd&&h.text.fillText("we will meet again",20,80,"rgba(255, 100, 100, 0.3)",i),this.mode===o.IRRATIONAL&&this.time>a.irrationalMessageStart&&this.time<a.irrationalMessageEnd&&h.text.fillText("never closing...",20,80,"rgba(100, 200, 255, 0.3)",i),this.mode===o.CHAOS&&this.time>a.chaosMessageStart&&this.time<a.chaosMessageEnd&&h.text.fillText("lost in infinity...",20,80,"rgba(255, 150, 255, 0.3)",i)}}function m(l){const e=new g(l);return e.start(),{stop:()=>e.stop(),game:e}}export{m as default};
