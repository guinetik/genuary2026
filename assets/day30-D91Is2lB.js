import{G as M,P as k}from"./index-DzXchqqB.js";const c={fftSize:2048,smoothing:.8,lineWidth:3,glowAmount:15,chaos:{noiseScale:.02,maxAmplitude:.6,glitchChance:.2,colorSpeed:1.5},calmHue:135,chaosHueStart:0,chaosHueRange:120};class P extends M{constructor(t){super(t),this.backgroundColor="#000"}init(){super.init(),k.init(this.ctx),this.time=0,this.audioContext=null,this.analyser=null,this.source=null,this.audioBuffer=null,this.waveformData=null,this.frequencyData=null,this.isPlaying=!1,this.hasAudio=!1,this.chaosLevel=0,this.targetChaosLevel=0,this.glitchOffset=0,this.colorPhase=0,this.peakLoudness=1,this.fileInput=document.createElement("input"),this.fileInput.type="file",this.fileInput.accept="audio/*",this.fileInput.style.display="none",document.body.appendChild(this.fileInput),this.fileInput.addEventListener("change",t=>{t.target.files.length>0&&this.loadAudioFile(t.target.files[0])}),this.canvas.addEventListener("click",()=>{this.hasAudio?this.togglePlayback():this.fileInput.click()}),this.canvas.addEventListener("dragover",t=>{t.preventDefault(),this.dragOver=!0}),this.canvas.addEventListener("dragleave",()=>{this.dragOver=!1}),this.canvas.addEventListener("drop",t=>{t.preventDefault(),this.dragOver=!1;const s=t.dataTransfer.files[0];s&&s.type.startsWith("audio/")&&this.loadAudioFile(s)}),this.idlePhase=0}async loadAudioFile(t){try{this.audioContext||(this.audioContext=new(window.AudioContext||window.webkitAudioContext)),this.source&&(this.source.stop(),this.source.disconnect());const s=await t.arrayBuffer();this.audioBuffer=await this.audioContext.decodeAudioData(s),this.peakLoudness=this.analyzeTrackPeak(this.audioBuffer),console.log(`[Day30] Track peak loudness: ${this.peakLoudness.toFixed(4)}`),this.analyser=this.audioContext.createAnalyser(),this.analyser.fftSize=c.fftSize,this.analyser.smoothingTimeConstant=c.smoothing,this.waveformData=new Uint8Array(this.analyser.fftSize),this.frequencyData=new Uint8Array(this.analyser.frequencyBinCount),this.hasAudio=!0,this.fileName=t.name,this.startPlayback()}catch(s){console.error("Error loading audio:",s)}}analyzeTrackPeak(t){const s=t.getChannelData(0),a=2048;let o=0;for(let h=0;h<s.length;h+=a){let e=0,i=0;const n=Math.min(h+a,s.length);for(let r=h;r<n;r++){const l=Math.abs(s[r]);e+=l*l,l>i&&(i=l)}const u=Math.sqrt(e/(n-h))*.7+i*.3;u>o&&(o=u)}return Math.max(.01,o)}startPlayback(){!this.audioBuffer||!this.audioContext||(this.source=this.audioContext.createBufferSource(),this.source.buffer=this.audioBuffer,this.source.connect(this.analyser),this.analyser.connect(this.audioContext.destination),this.source.onended=()=>{this.isPlaying=!1},this.source.start(0),this.isPlaying=!0)}togglePlayback(){this.isPlaying?(this.source&&(this.source.stop(),this.source.disconnect()),this.isPlaying=!1):this.startPlayback()}calculateLoudness(){if(!this.analyser||!this.waveformData)return 0;this.analyser.getByteTimeDomainData(this.waveformData);let t=0,s=0;for(let e=0;e<this.waveformData.length;e++){const i=Math.abs(this.waveformData[e]-128)/128;t+=i*i,i>s&&(s=i)}const h=(Math.sqrt(t/this.waveformData.length)*.7+s*.3)/this.peakLoudness;return Math.min(1,h)}update(t){if(super.update(t),this.time+=t,this.idlePhase+=t*.5,this.isPlaying){const s=this.calculateLoudness();this.targetChaosLevel=1-s}else this.targetChaosLevel=.5+Math.sin(this.time)*.3;this.chaosLevel+=(this.targetChaosLevel-this.chaosLevel)*t*2,this.colorPhase+=t*c.chaos.colorSpeed*this.chaosLevel,this.chaosLevel>.5&&Math.random()<c.chaos.glitchChance*this.chaosLevel?this.glitchOffset=(Math.random()-.5)*100*this.chaosLevel:this.glitchOffset*=.9}render(){const t=this.ctx,s=this.width,a=this.height,o=a/2,h=.1+this.chaosLevel*.2;t.fillStyle=`rgba(0, 0, 0, ${h})`,t.fillRect(0,0,s,a);const e=this.generatePoints(s,a,o);e.length<2||(this.drawChaosLine(t,e,s,a,o),this.chaosLevel>.7&&this.drawGlitchEffects(t,s,a),this.drawUI(t,s,a))}generatePoints(t,s,a){const o=[],e=this.chaosLevel;if(this.isPlaying&&this.analyser&&this.waveformData){this.analyser.getByteTimeDomainData(this.waveformData);const i=Math.max(1,Math.floor(this.waveformData.length/200));for(let n=0;n<200;n++){const f=Math.min(n*i,this.waveformData.length-1),u=n/200*t,r=(this.waveformData[f]-128)/128,l=c.chaos.noiseScale,d=Math.sin(n*l*50+this.time*2)*e,m=Math.sin(n*l*120+this.time*1.5)*e*.5,g=Math.sin(n*l*200-this.time*3)*e*.3;let p=0;e>.7&&Math.random()<.02*e&&(p=(Math.random()-.5)*2*e);const v=r*e*.3+(d+m+g+p)*c.chaos.maxAmplitude,L=a+v*s*.4+this.glitchOffset*e;o.push({x:u,y:L,v,chaos:e})}}else for(let i=0;i<200;i++){const n=i/200*t,f=this.idlePhase,u=Math.sin(i*.05+f*.8)*e*.3+Math.sin(i*.12-f*1.2)*e*.2+Math.sin(i*.03+f*.3)*.05+(Math.random()-.5)*e*.1,r=a+u*s;o.push({x:n,y:r,v:u,chaos:e})}return o}drawChaosLine(t,s,a,o,h){t.save();const e=this.chaosLevel;let i;if(e<.5)i=c.calmHue;else{const r=(e-.5)*2,l=c.chaosHueStart+Math.sin(this.colorPhase)*c.chaosHueRange;i=c.calmHue+(l-c.calmHue)*r}const n=70+e*30,f=50+e*15;t.shadowColor=`hsl(${i}, ${n}%, ${f}%)`,t.shadowBlur=e>.5?c.glowAmount+(e-.5)*60:5,t.lineWidth=c.lineWidth+(e>.5?(e-.5)*6:0),t.lineCap="round",t.lineJoin="round",t.strokeStyle=`hsl(${i}, ${n}%, ${f}%)`,t.beginPath(),t.moveTo(s[0].x,s[0].y);for(let r=1;r<s.length-1;r++){const l=s[r],d=s[r+1];if(e<.4){const m=l.x+(d.x-l.x)*.5,g=l.y+(d.y-l.y)*.5;t.quadraticCurveTo(l.x,l.y,m,g)}else t.lineTo(l.x,l.y)}const u=s[s.length-1];t.lineTo(u.x,u.y),t.stroke(),e>.5&&(t.globalAlpha=e*.8,t.lineWidth=c.lineWidth*.5,t.strokeStyle=`hsl(${i}, 100%, 90%)`,t.stroke()),t.restore()}drawGlitchEffects(t,s,a){const o=this.chaosLevel;t.fillStyle=`rgba(255, 0, 100, ${o*.1})`;const h=Math.floor(o*10);for(let e=0;e<h;e++){const i=Math.random()*a,n=1+Math.random()*3;t.fillRect(0,i,s,n)}if(Math.random()<o*.3){const e=Math.random()*s,i=Math.random()*a,n=20+Math.random()*100,f=5+Math.random()*20;t.fillStyle=`hsla(${Math.random()*360}, 100%, 50%, ${o*.2})`,t.fillRect(e,i,n,f)}if(Math.random()<o*.1){const e=Math.random()*a,i=(Math.random()-.5)*20;t.drawImage(this.canvas,0,e,s,10,i,e,s,10)}}drawUI(t,s,a){if(t.fillStyle="rgba(255, 255, 255, 0.6)",t.font="14px monospace",t.textAlign="center",this.hasAudio){t.textAlign="left",t.fillStyle="rgba(255, 255, 255, 0.4)",t.font="12px monospace";const o=this.isPlaying?"▶ PLAYING":"❚❚ PAUSED";t.fillText(o,20,30),t.fillStyle="rgba(255, 255, 255, 0.25)";const h=this.fileName.length>40?this.fileName.substring(0,37)+"...":this.fileName;t.fillText(h,20,50),t.fillStyle="rgba(255, 255, 255, 0.3)",t.fillText("CHAOS:",20,a-40);const e=100,i=8;t.fillStyle="rgba(255, 255, 255, 0.1)",t.fillRect(80,a-47,e,i);const n=this.chaosLevel*120;t.fillStyle=`hsl(${120-n}, 100%, 50%)`,t.fillRect(80,a-47,e*this.chaosLevel,i),t.fillStyle="rgba(255, 255, 255, 0.3)",t.fillText("Click to play/pause",20,a-20)}else{const o=this.chaosLevel>.5?Math.sin(this.colorPhase)*60:0;t.fillStyle=`hsl(${o}, 80%, 70%)`,t.fillText(`"IT'S NOT A BUG, IT'S A FEATURE"`,s/2,a/2-60),t.fillStyle="rgba(255, 255, 255, 0.5)",t.font="16px monospace",t.fillText("QUIET ANALYZER",s/2,a/2-30),t.fillStyle="rgba(255, 255, 255, 0.3)",t.font="12px monospace",t.fillText("The quieter the sound, the crazier the line",s/2,a/2+10),t.fillText("Click or drag & drop an audio file",s/2,a/2+30),this.dragOver&&(t.strokeStyle="hsl(0, 100%, 50%)",t.lineWidth=4,t.setLineDash([10,10]),t.strokeRect(20,20,s-40,a-40),t.setLineDash([]))}}stop(){if(this.source)try{this.source.stop(),this.source.disconnect()}catch{}this.audioContext&&this.audioContext.close(),this.fileInput&&this.fileInput.parentNode&&this.fileInput.parentNode.removeChild(this.fileInput),super.stop()}}function S(y){const t=new P(y);return t.start(),{stop:()=>t.stop(),game:t}}export{S as default};
