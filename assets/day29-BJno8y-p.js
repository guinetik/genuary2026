import{G as it,P as et,e as st,T as O,E as ot}from"./index-plo7o7PE.js";const at=["Alpha","Beta","Gamma","Delta","Epsilon","Zeta","Eta","Theta","Iota","Kappa","Lambda","Mu","Nu","Xi","Omicron","Pi","Rho","Sigma","Tau","Upsilon","Phi","Chi","Psi","Omega"],N=["#ff2060","#ff6020","#ffaa00","#ff00ff","#ff0080","#aa00ff","#6020ff","#00aaff","#00ffaa","#80ff00"],c={gridWidth:60,gridHeight:40,agentCount:100,initialVaccinatedPercent:.25,moveDelay:4,wanderSteps:{min:10,max:20},incubationTime:{min:50,max:100},infectionTime:{min:100,max:200},recoveryChance:.3,deathChance:.1,transmissionRate:.15,roomTransmissionBonus:2,vaccineEfficacy:.8,mutationChanceOnVaccinated:.005,mutationTransmissionBoost:1.2,mutationVaccineResistanceBoost:.15,maxVariants:10,newAgentInterval:60,newAgentCount:10,colors:{wall:"#353545",hospitalWall:"#40e0e0",agent:"#00ff80",vaccinated:"#00ffff",exposed:"#ffcc00",infected:"#ff2060",recovered:"#4080ff"},trailAlpha:.12,pulseSpeed:3,variantFlashDuration:2.5,variantFlashFadeStart:1.5,historyInterval:.5,maxHistoryPoints:200};function nt(m,t){const s=[],e=(y,v)=>Math.floor(Math.random()*(v-y+1))+y;let i=[];for(let y=0;y<t;y++){i.push([]);for(let v=0;v<m;v++)v===0||v===m-1||y===0||y===t-1?i[y].push({type:"wall"}):i[y].push({type:"floor"})}const o=(y,v,w,C,q)=>{for(let b=v-1;b<=v+C;b++)for(let S=y-1;S<=y+w;S++){const Q=b===v-1,Z=b===v+C,J=S===y-1,tt=S===y+w;Q||Z||J||tt?i[b][S]={type:"room_wall"}:i[b][S]={type:"room_floor"}}let R,T;const I=y+Math.floor(w/2),E=v+Math.floor(C/2);switch(q){case"top":R=I,T=v-1;break;case"bottom":R=I,T=v+C;break;case"left":R=y-1,T=E;break;case"right":R=y+w,T=E;break}return i[T][R]={type:"door"},{x:y,y:v,width:w,height:C,doorX:R,doorY:T}},a=8,d=Math.floor(m/2)-Math.floor(a/2),n=Math.floor(t/2)-Math.floor(a/2),r=o(d,n,a,a,"top");r.isHospital=!0,s.push(r);const l=5,h=4,f=e(5,7),p=e(3,5),M=Math.floor(m/2)-Math.floor(f/2),g=n-l-p;g>2&&s.push(o(M,g,f,p,"bottom"));const u=e(5,7),x=e(3,5),k=Math.floor(m/2)-Math.floor(u/2),A=n+a+l;A+x<t-2&&s.push(o(k,A,u,x,"top"));const H=h,_=e(4,6),G=e(4,5);s.push(o(H,h,_,G,"right"));const L=e(4,6),D=e(5,7),U=Math.floor(t/2)-Math.floor(D/2);s.push(o(H,U,L,D,"right"));const j=e(4,6),F=e(4,5);s.push(o(H,t-h-F-1,j,F,"right"));const V=e(4,6),K=e(4,5);s.push(o(m-h-V-1,h,V,K,"left"));const Y=e(4,6),X=e(5,7),z=Math.floor(t/2)-Math.floor(X/2);s.push(o(m-h-Y-1,z,Y,X,"left"));const B=e(4,6),P=e(4,5);return s.push(o(m-h-B-1,t-h-P-1,B,P,"left")),{grid:i,rooms:s}}function ht(m,t){const s=t.find(o=>o.isHospital);if(!s)return null;for(let o=s.y-1;o<=s.y+s.height;o++)for(let a=s.x-1;a<=s.x+s.width;a++)m[o]&&m[o][a]&&(m[o][a].type==="room_wall"||m[o][a].type==="door")&&(m[o][a].type="hospital_wall");const e=s.x+Math.floor(s.width/2),i=s.y+Math.floor(s.height/2);return m[s.y-1][e].type="door",m[s.y+s.height][e].type="door",m[i][s.x-1].type="door",m[i][s.x+s.width].type="door",s.doors=[{x:e,y:s.y-1},{x:e,y:s.y+s.height},{x:s.x-1,y:i},{x:s.x+s.width,y:i}],s}class ${constructor(t,s=null){this.index=t,this.name=at[t]||`Variant-${t}`,this.parent=s,this.generation=s?s.generation+1:0,s?(this.transmissionMultiplier=s.transmissionMultiplier*c.mutationTransmissionBoost,this.vaccineResistance=Math.min(.95,s.vaccineResistance+c.mutationVaccineResistanceBoost)):(this.transmissionMultiplier=1,this.vaccineResistance=0),this.color=N[t%N.length],this.infectionCount=0,this.emergeTime=0,this.emergeX=0,this.emergeY=0}}class W{constructor(t,s,e,i,o){this.x=t,this.y=s,this.grid=e,this.rooms=i,this.hospital=o,this.gridHeight=e.length,this.gridWidth=e[0].length,this.state="roaming",this.targetRoom=null,this.targetX=t,this.targetY=s,this.roamTargetX=t,this.roamTargetY=s,this.stepsRemaining=0,this.waitFrames=0,this.stuckCounter=0,this.moveTimer=Math.floor(Math.random()*c.moveDelay),this.healthState="susceptible",this.diseaseTimer=0,this.variant=null,this.deathFlash=0,this.lastRoom=null,this.roamTimeRemaining=0,this.dirX=0,this.dirY=0,this.dirSteps=0,this.posHistory=[],this.globalStuckCounter=0}update(){if(this.moveTimer++,!(this.moveTimer<c.moveDelay)){if(this.moveTimer=0,this.waitFrames>0){this.waitFrames--;return}if(this.posHistory.push({x:this.x,y:this.y}),this.posHistory.length>20&&this.posHistory.shift(),this.posHistory.length>=20){const t=Math.min(...this.posHistory.map(a=>a.x)),s=Math.max(...this.posHistory.map(a=>a.x)),e=Math.min(...this.posHistory.map(a=>a.y)),i=Math.max(...this.posHistory.map(a=>a.y));if(s-t+(i-e)<=4){if(this.globalStuckCounter++,this.globalStuckCounter>5){this.teleportToRandomFloor();return}}else this.globalStuckCounter=0}if(this.updateDisease(),this.healthState!=="dead")switch(this.state){case"roaming":this.roam();break;case"goingToDoor":this.goToDoor();break;case"enteringRoom":this.enterRoom();break;case"inRoom":this.wanderInRoom();break;case"exitingRoom":this.exitRoom();break}}}updateDisease(){this.healthState==="exposed"?(this.diseaseTimer--,this.diseaseTimer<=0&&(this.healthState="infected",this.diseaseTimer=c.infectionTime.min+Math.floor(Math.random()*(c.infectionTime.max-c.infectionTime.min)))):this.healthState==="infected"&&(this.diseaseTimer--,this.diseaseTimer<=0&&(Math.random()<c.deathChance?(this.healthState="dead",this.deathFlash=1,this.justDied=!0):Math.random()<c.recoveryChance?this.healthState="recovered":this.diseaseTimer=c.infectionTime.min+Math.floor(Math.random()*(c.infectionTime.max-c.infectionTime.min))))}teleportToRandomFloor(){for(let t=0;t<50;t++){const s=Math.floor(Math.random()*this.gridWidth),e=Math.floor(Math.random()*this.gridHeight);if(this.grid[e][s].type==="floor"){this.x=s,this.y=e,this.state="roaming",this.targetRoom=null,this.lastRoom=null,this.roamTimeRemaining=10,this.posHistory=[],this.globalStuckCounter=0,this.stuckCounter=0,this.dirSteps=0;return}}}roam(){if(this.roamTimeRemaining>0&&this.roamTimeRemaining--,this.randomWalk(),Math.random()<.05&&(this.waitFrames=Math.floor(Math.random()*3)+1),this.roamTimeRemaining<=0&&Math.random()<.03&&this.rooms.length>0){const t=this.rooms.filter(s=>s!==this.lastRoom);t.length>0&&(this.targetRoom=t[Math.floor(Math.random()*t.length)],this.stuckCounter=0,this.state="goingToDoor")}}randomWalk(){if(this.dirSteps>0){const e=this.x+this.dirX,i=this.y+this.dirY;if(e>=0&&e<this.gridWidth&&i>=0&&i<this.gridHeight){const o=this.grid[i][e];if(o.type==="floor"||o.type==="door"){this.x=e,this.y=i,this.dirSteps--;return}}this.dirSteps=0}const s=[{dx:1,dy:0},{dx:-1,dy:0},{dx:0,dy:1},{dx:0,dy:-1}].map(e=>{const i=this.x+e.dx,o=this.y+e.dy;let a=Math.random()*2;if(i>=0&&i<this.gridWidth&&o>=0&&o<this.gridHeight){const d=this.grid[o][i];if(d.type==="floor"||d.type==="door"){for(let r=o-1;r<=o+1;r++)for(let l=i-1;l<=i+1;l++)if(l>=0&&l<this.gridWidth&&r>=0&&r<this.gridHeight){const h=this.grid[r][l];(h.type==="wall"||h.type==="room_wall"||h.type==="hospital_wall")&&(a+=1.5)}return Math.min(i,o,this.gridWidth-i,this.gridHeight-o)<8&&(a+=2),{dir:e,score:a,valid:!0}}}return{dir:e,score:-1,valid:!1}});s.sort((e,i)=>i.score-e.score);for(const{dir:e,valid:i}of s){if(!i)continue;const o=this.x+e.dx,a=this.y+e.dy;this.x=o,this.y=a,this.dirX=e.dx,this.dirY=e.dy,this.dirSteps=8+Math.floor(Math.random()*15);return}}goToDoor(){if(!this.targetRoom){this.state="roaming";return}let t,s;if(this.targetRoom.doors&&this.targetRoom.doors.length>0){let i=1/0;for(const o of this.targetRoom.doors){const a=Math.abs(o.x-this.x)+Math.abs(o.y-this.y);a<i&&(i=a,t=o.x,s=o.y)}}else t=this.targetRoom.doorX,s=this.targetRoom.doorY;if(Math.abs(t-this.x)+Math.abs(s-this.y)<=1){this.x=t,this.y=s,this.state="enteringRoom",this.targetX=this.targetRoom.x+Math.floor(Math.random()*this.targetRoom.width),this.targetY=this.targetRoom.y+Math.floor(Math.random()*this.targetRoom.height),this.stuckCounter=0;return}if(this.stuckCounter>20){this.state="roaming",this.targetRoom=null,this.stuckCounter=0,this.roamTimeRemaining=10;return}this.smartMove(t,s)}enterRoom(){if(!this.targetRoom){this.state="roaming";return}if(this.checkHospital(),Math.abs(this.targetX-this.x)+Math.abs(this.targetY-this.y)===0){this.state="inRoom",this.stepsRemaining=c.wanderSteps.min+Math.floor(Math.random()*(c.wanderSteps.max-c.wanderSteps.min));return}if(this.stuckCounter>10){this.state="inRoom",this.stepsRemaining=c.wanderSteps.min+Math.floor(Math.random()*(c.wanderSteps.max-c.wanderSteps.min)),this.stuckCounter=0;return}this.smartMove(this.targetX,this.targetY)}checkHospital(){if(this.targetRoom&&this.targetRoom.isHospital){if(this.healthState==="infected")return this.healthState="recovered",!0;if(this.healthState==="susceptible")return this.healthState="vaccinated",!0}return!1}wanderInRoom(){if(this.stepsRemaining--,this.checkHospital(),this.stepsRemaining<=0){this.state="exitingRoom",this.stuckCounter=0;return}if(Math.random()<.1){this.waitFrames=Math.floor(Math.random()*3)+1;return}const t=this.targetRoom;if(!t){this.state="roaming";return}const s=[{dx:1,dy:0},{dx:-1,dy:0},{dx:0,dy:1},{dx:0,dy:-1},{dx:0,dy:0}],e=s[Math.floor(Math.random()*s.length)],i=this.x+e.dx,o=this.y+e.dy;this.canMove(i,o)&&i>=t.x&&i<t.x+t.width&&o>=t.y&&o<t.y+t.height&&(this.x=i,this.y=o)}exitRoom(){const t=this.targetRoom;if(!t){this.state="roaming";return}let s,e;if(t.doors&&t.doors.length>0){let n=1/0;for(const r of t.doors){const l=Math.abs(r.x-this.x)+Math.abs(r.y-this.y);l<n&&(n=l,s=r.x,e=r.y)}}else s=t.doorX,e=t.doorY;if(Math.abs(s-this.x)+Math.abs(e-this.y)<=1){this.x=s,this.y=e;const n=[{dx:0,dy:-1},{dx:0,dy:1},{dx:-1,dy:0},{dx:1,dy:0}];for(const r of n){const l=s+r.dx,h=e+r.dy;if(this.canMove(l,h)){const f=l<t.x-1||l>t.x+t.width,p=h<t.y-1||h>t.y+t.height;if(f||p){this.x=l,this.y=h;break}}}this.lastRoom=t,this.targetRoom=null,this.roamTimeRemaining=15+Math.floor(Math.random()*20),this.state="roaming";return}const o=s-this.x,a=e-this.y;let d=!1;if(Math.abs(o)>=Math.abs(a)&&o!==0){const n=this.x+(o>0?1:-1);this.canMove(n,this.y)&&(this.x=n,d=!0)}if(!d&&a!==0){const n=this.y+(a>0?1:-1);this.canMove(this.x,n)&&(this.y=n,d=!0)}if(!d&&o!==0){const n=this.x+(o>0?1:-1);this.canMove(n,this.y)&&(this.x=n,d=!0)}if(d?this.stuckCounter=0:this.stuckCounter++,this.stuckCounter>10){const n=[{dx:0,dy:-1},{dx:0,dy:1},{dx:-1,dy:0},{dx:1,dy:0}];for(const r of n){const l=s+r.dx,h=e+r.dy;if(this.canMove(l,h)){const f=l<t.x-1||l>t.x+t.width,p=h<t.y-1||h>t.y+t.height;if(f||p){this.x=l,this.y=h,this.lastRoom=t,this.targetRoom=null,this.roamTimeRemaining=15+Math.floor(Math.random()*20),this.state="roaming",this.stuckCounter=0;return}}}this.x=s,this.y=e,this.stuckCounter=0}}smartMove(t,s){const e=t-this.x,i=s-this.y,o=this.x,a=this.y;let d=!1;const n=[];e>0&&n.push({dx:1,dy:0,priority:Math.abs(e)}),e<0&&n.push({dx:-1,dy:0,priority:Math.abs(e)}),i>0&&n.push({dx:0,dy:1,priority:Math.abs(i)}),i<0&&n.push({dx:0,dy:-1,priority:Math.abs(i)}),n.sort((r,l)=>l.priority-r.priority);for(const r of n){const l=this.x+r.dx,h=this.y+r.dy;if(this.canMove(l,h)){this.x=l,this.y=h,d=!0;break}}if(!d){const r=[];e!==0&&(r.push({dx:0,dy:1}),r.push({dx:0,dy:-1})),i!==0&&(r.push({dx:1,dy:0}),r.push({dx:-1,dy:0}));for(let l=r.length-1;l>0;l--){const h=Math.floor(Math.random()*(l+1));[r[l],r[h]]=[r[h],r[l]]}for(const l of r){const h=this.x+l.dx,f=this.y+l.dy;if(this.canMove(h,f)){this.x=h,this.y=f,d=!0;break}}}this.x===o&&this.y===a?this.stuckCounter++:this.stuckCounter=0}canMove(t,s){if(t<0||t>=this.gridWidth||s<0||s>=this.gridHeight)return!1;const e=this.grid[s][t];return e.type==="floor"||e.type==="room_floor"||e.type==="door"}}class rt extends it{constructor(t){super(t),this.backgroundColor=null}init(){super.init(),et.init(this.ctx);const{grid:t,rooms:s}=nt(c.gridWidth,c.gridHeight);this.grid=t,this.rooms=s,this.gridHeight=t.length,this.gridWidth=t[0].length,this.hospital=ht(this.grid,this.rooms),this.calculateGrid(),this.agents=[];const e=[];for(let i=0;i<this.gridHeight;i++)for(let o=0;o<this.gridWidth;o++){const a=this.grid[i][o].type;(a==="floor"||a==="room_floor"||a==="door")&&e.push({x:o,y:i})}this.floorCells=e,this.variants=[],this.nextVariantIndex=0;for(let i=0;i<Math.min(c.agentCount,e.length);i++){const o=Math.floor(Math.random()*e.length),a=e[o],d=new W(a.x,a.y,this.grid,this.rooms,this.hospital);Math.random()<c.initialVaccinatedPercent&&(d.healthState="vaccinated"),this.agents.push(d)}this.elapsedTime=0,this.lastWaveTime=0,this.infectionStarted=!1,this.showDataOverlay=!1,this.history=[],this.lastHistoryTime=0,this.dominantVariant=null,this.dataButton=new st(this,{text:"[i]",width:36,height:36,font:'14px "Fira Code", monospace',startToggled:!1,onToggle:i=>{this.showDataOverlay=i}}),this.pipeline.add(this.dataButton),this.container=this.canvas.parentElement,this.container&&this.enableFluidSize(this.container),this.canvas.addEventListener("click",i=>this.handleClick(i)),this.canvas.addEventListener("touchend",i=>{i.preventDefault(),this.handleClick(i.changedTouches[0])})}handleClick(t){const s=this.canvas.getBoundingClientRect(),e=t.clientX-s.left,i=t.clientY-s.top;if(this.showDataOverlay){const l=this.width-36,h=this.height-36;if(!(e>=l-18&&e<=l+18&&i>=h-18&&i<=h+18)){this.showDataOverlay=!1,this.dataButton.toggle(!1);return}}const o=Math.floor(e/this.cellW),a=Math.floor(i/this.cellH),d=Math.max(this.cellW,this.cellH)*1.5;let n=null,r=d;for(const l of this.agents){if(l.healthState==="dead")continue;const h=l.x*this.cellW+this.cellW/2,f=l.y*this.cellH+this.cellH/2,p=Math.sqrt((e-h)**2+(i-f)**2);p<r&&(r=p,n=l)}if(n)(n.healthState==="susceptible"||n.healthState==="vaccinated")&&this.infectAgent(n);else if(o>=0&&o<this.gridWidth&&a>=0&&a<this.gridHeight){const l=this.grid[a][o];if(l.type==="floor"||l.type==="room_floor"||l.type==="door"){const h=new W(o,a,this.grid,this.rooms,this.hospital);this.agents.push(h)}}}infectAgent(t){if(!this.infectionStarted){const e=new $(this.nextVariantIndex++,null);e.emergeTime=this.elapsedTime,e.emergeX=t.x,e.emergeY=t.y,this.variants.push(e),this.infectionStarted=!0}const s=this.variants[0];t.healthState="exposed",t.variant=s,s.infectionCount++,t.diseaseTimer=c.incubationTime.min+Math.floor(Math.random()*(c.incubationTime.max-c.incubationTime.min))}calculateGrid(){this.cellW=this.width/this.gridWidth,this.cellH=this.height/this.gridHeight}update(t){super.update(t),this.calculateGrid(),this.elapsedTime+=t,this.dataButton&&(this.dataButton.x=this.width-36,this.dataButton.y=this.height-36),this.infectionStarted&&this.elapsedTime-this.lastWaveTime>=c.newAgentInterval&&(this.spawnNewAgents(c.newAgentCount),this.lastWaveTime=this.elapsedTime);for(const s of this.agents)s.update(),s.justDied&&(s.justDied=!1,O.to(s,{deathFlash:0},.8,ot.easeOutQuad));this.processTransmission(),this.elapsedTime-this.lastHistoryTime>=c.historyInterval&&(this.recordHistory(),this.lastHistoryTime=this.elapsedTime),this.updateDominantVariant(),O.updateAll(t)}recordHistory(){const t={};let s=0,e=0;for(const i of this.agents)i.healthState==="infected"||i.healthState==="exposed"?(s++,i.variant&&(t[i.variant.name]=(t[i.variant.name]||0)+1)):i.healthState==="recovered"&&e++;this.history.push({time:this.elapsedTime,infected:s,recovered:e,variants:{...t}}),this.history.length>c.maxHistoryPoints&&this.history.shift()}updateDominantVariant(){if(this.variants.length===0){this.dominantVariant=null;return}const t=new Map;for(const i of this.agents)(i.healthState==="infected"||i.healthState==="exposed")&&i.variant&&t.set(i.variant,(t.get(i.variant)||0)+1);let s=0,e=null;for(const[i,o]of t)o>s&&(s=o,e=i);this.dominantVariant=e}createMutatedVariant(t,s=null){const e=new $(this.nextVariantIndex++,t);return e.emergeTime=this.elapsedTime,s&&(e.emergeX=s.x,e.emergeY=s.y),this.variants.push(e),console.log(`[MUTATION] New variant emerged: ${e.name} (from ${t.name})`),console.log(`  - Transmissibility: ${(e.transmissionMultiplier*100).toFixed(0)}%`),console.log(`  - Vaccine resistance: ${(e.vaccineResistance*100).toFixed(0)}%`),e}spawnNewAgents(t){for(let s=0;s<t&&this.floorCells.length!==0;s++){const e=Math.floor(Math.random()*this.floorCells.length),i=this.floorCells[e],o=new W(i.x,i.y,this.grid,this.rooms,this.hospital);this.agents.push(o)}}getAgentRoom(t){for(const s of this.rooms)if(t.x>=s.x&&t.x<s.x+s.width&&t.y>=s.y&&t.y<s.y+s.height)return s;return null}processTransmission(){const t=new Map;for(const e of this.agents){if(e.healthState==="dead")continue;const i=`${e.x},${e.y}`;t.has(i)||t.set(i,[]),t.get(i).push(e)}const s=this.agents.filter(e=>e.healthState==="infected");for(const e of s){const i=this.getAgentRoom(e),o=e.variant;if(o)for(let a=-1;a<=1;a++)for(let d=-1;d<=1;d++){const n=e.x+d,r=e.y+a,l=`${n},${r}`;if(t.has(l))for(const h of t.get(l)){if(h===e||h.healthState!=="susceptible"&&h.healthState!=="vaccinated")continue;let f=c.transmissionRate*o.transmissionMultiplier;d===0&&a===0&&(f*=1.5);const p=this.getAgentRoom(h);i&&p&&i===p&&(f*=c.roomTransmissionBonus);const M=h.healthState==="vaccinated";if(M){const u=Math.max(0,c.vaccineEfficacy-o.vaccineResistance);f*=1-u}const g=Math.random();if(g<f)h.healthState="exposed",h.variant=o,o.infectionCount++,h.diseaseTimer=c.incubationTime.min+Math.floor(Math.random()*(c.incubationTime.max-c.incubationTime.min));else if(M&&g<f+c.mutationChanceOnVaccinated&&this.variants.length<c.maxVariants){const u=this.createMutatedVariant(o,e);e.variant=u;const x=Math.max(0,c.vaccineEfficacy-u.vaccineResistance),k=c.transmissionRate*u.transmissionMultiplier*(1-x);Math.random()<k&&(h.healthState="exposed",h.variant=u,u.infectionCount++,h.diseaseTimer=c.incubationTime.min+Math.floor(Math.random()*(c.incubationTime.max-c.incubationTime.min)))}}}}}render(){const t=this.ctx,s=this.elapsedTime;t.fillStyle=`rgba(5, 5, 8, ${c.trailAlpha})`,t.fillRect(0,0,this.width,this.height),this.stats={susceptible:0,vaccinated:0,exposed:0,infected:0,recovered:0,dead:0};for(const i of this.agents)this.stats[i.healthState]++;t.strokeStyle="rgba(255, 255, 255, 0.03)",t.lineWidth=1;for(let i=0;i<=this.gridWidth;i++)t.beginPath(),t.moveTo(i*this.cellW,0),t.lineTo(i*this.cellW,this.height),t.stroke();for(let i=0;i<=this.gridHeight;i++)t.beginPath(),t.moveTo(0,i*this.cellH),t.lineTo(this.width,i*this.cellH),t.stroke();for(let i=0;i<this.gridHeight;i++)for(let o=0;o<this.gridWidth;o++){const a=this.grid[i][o],d=o*this.cellW,n=i*this.cellH;a.type==="wall"||a.type==="room_wall"?(t.fillStyle=c.colors.wall,t.fillRect(d,n,this.cellW+1,this.cellH+1)):a.type==="hospital_wall"&&(t.fillStyle=c.colors.hospitalWall,t.shadowColor=c.colors.hospitalWall,t.shadowBlur=4,t.fillRect(d,n,this.cellW+1,this.cellH+1),t.shadowBlur=0)}if(this.hospital){const i=this.hospital,o=(i.x+i.width/2)*this.cellW+6,a=(i.y+i.height/2)*this.cellH+6;t.fillStyle=c.colors.hospitalWall,t.shadowColor=c.colors.hospitalWall,t.shadowBlur=3,t.globalAlpha=.25;const d=this.cellW*.7,n=this.cellH*2.5;t.fillRect(o-d/2,a-n/2,d,n),t.fillRect(o-n/2,a-d/2,n,d),t.globalAlpha=1,t.shadowBlur=0}for(const i of this.agents){const o=i.x*this.cellW+this.cellW/2,a=i.y*this.cellH+this.cellH/2,d=Math.min(this.cellW,this.cellH)*.4;let n,r,l=1,h=0;const f=i.variant&&i.variant===this.dominantVariant,p=f?1.5:i.variant&&this.dominantVariant?.6:1;switch(i.healthState){case"exposed":n=i.variant?i.variant.color:c.colors.exposed,r=n,l=.7,h=Math.sin(s*c.pulseSpeed+i.x*.5)*.2;break;case"infected":n=i.variant?i.variant.color:c.colors.infected,r=n,h=Math.sin(s*c.pulseSpeed*2+i.y*.5)*(f?.4:.25);break;case"recovered":n=c.colors.recovered,r=n;break;case"vaccinated":n=c.colors.vaccinated,r=n,h=Math.sin(s*2+i.x+i.y)*.1;break;case"dead":const g=i.deathFlash||0,u=Math.floor(34+g*221);n=`rgb(${u}, ${u}, ${u})`,r=g>.1?"#fff":"#111",l=.5+g*.5;break;default:n=c.colors.agent,r=n}const M=d*(1+h);if(i.healthState!=="dead"){const g=M*2.5*p,u=t.createRadialGradient(o,a,0,o,a,g),x=f?"80":"40";u.addColorStop(0,r+x),u.addColorStop(.5,r+"20"),u.addColorStop(1,"transparent"),t.fillStyle=u,t.beginPath(),t.arc(o,a,g,0,Math.PI*2),t.fill()}if(t.globalAlpha=l,t.fillStyle=n,t.beginPath(),t.arc(o,a,M,0,Math.PI*2),t.fill(),i.healthState!=="dead"){const g=t.createRadialGradient(o-M*.3,a-M*.3,0,o,a,M);g.addColorStop(0,"rgba(255,255,255,0.4)"),g.addColorStop(.5,"rgba(255,255,255,0.1)"),g.addColorStop(1,"transparent"),t.fillStyle=g,t.beginPath(),t.arc(o,a,M,0,Math.PI*2),t.fill()}t.globalAlpha=1}t.fillStyle="rgba(0, 0, 0, 0.03)";for(let i=0;i<this.height;i+=3)t.fillRect(0,i,this.width,1);const e=t.createRadialGradient(this.width/2,this.height/2,this.height*.3,this.width/2,this.height/2,this.height*.9);e.addColorStop(0,"transparent"),e.addColorStop(1,"rgba(0, 0, 0, 0.4)"),t.fillStyle=e,t.fillRect(0,0,this.width,this.height),this.drawVariantFlashes(t,s),this.drawMinimalHUD(t),this.showDataOverlay&&this.drawDataOverlay(t),this.dataButton&&this.dataButton.render()}drawVariantFlashes(t,s){for(const e of this.variants){const i=s-e.emergeTime;if(i<0||i>c.variantFlashDuration)continue;let o=1;i>c.variantFlashFadeStart&&(o=1-(i-c.variantFlashFadeStart)/(c.variantFlashDuration-c.variantFlashFadeStart));const a=e.emergeX*this.cellW+this.cellW/2,d=e.emergeY*this.cellH-20;t.save(),t.globalAlpha=o,t.font='bold 16px "Fira Code", monospace',t.textAlign="center",t.textBaseline="bottom",t.shadowColor=e.color,t.shadowBlur=15,t.fillStyle=e.color,t.fillText(e.name.toUpperCase(),a,d),t.shadowBlur=0,t.fillText(e.name.toUpperCase(),a,d),t.restore()}}drawMinimalHUD(t){t.font='11px "Fira Code", monospace',t.textAlign="right",t.textBaseline="top",t.fillStyle="rgba(0, 0, 0, 0.5)",t.fillRect(this.width-180,12,168,32),t.fillStyle="rgba(0, 255, 128, 0.6)",t.fillText("CLICK agent to INFECT",this.width-16,16),t.fillText("CLICK floor to SPAWN",this.width-16,28),t.font='12px "Fira Code", monospace',t.textAlign="left",t.textBaseline="bottom";const s=this.stats.infected+this.stats.exposed,e=this.stats.recovered,i=this.stats.dead,o=i>0?46:32,a=this.height-o-12;t.fillStyle="rgba(0, 0, 0, 0.5)",t.fillRect(12,a,120,o);let d=a+14;t.fillStyle=c.colors.infected,t.fillText(`INFECTED: ${s}`,16,d),d+=14,t.fillStyle=c.colors.recovered,t.fillText(`RECOVERED: ${e}`,16,d),i>0&&(d+=14,t.fillStyle="#666",t.fillText(`DEAD: ${i}`,16,d))}drawDataOverlay(t){t.fillStyle="rgba(0, 0, 0, 0.85)",t.fillRect(0,0,this.width,this.height);const s=40,e=this.width-s*2,i=(this.height-s*3)/2;t.font='bold 18px "Fira Code", monospace',t.fillStyle="#fff",t.textAlign="center",t.textBaseline="top",t.fillText("VARIANT ANALYTICS",this.width/2,15),this.drawPrevalenceChart(t,s,s+20,e,i-20),this.drawVariantBars(t,s,s+i+30,e,i-30),t.font='11px "Fira Code", monospace',t.fillStyle="rgba(255, 255, 255, 0.5)",t.textAlign="center",t.fillText("click anywhere to close",this.width/2,this.height-15)}drawPrevalenceChart(t,s,e,i,o){if(t.fillStyle="rgba(255, 255, 255, 0.05)",t.fillRect(s,e,i,o),t.font='12px "Fira Code", monospace',t.fillStyle="#888",t.textAlign="left",t.textBaseline="top",t.fillText("Infections Over Time",s,e-15),this.history.length<2){t.fillStyle="#444",t.textAlign="center",t.fillText("Collecting data...",s+i/2,e+o/2);return}let a=1;for(const n of this.history)a=Math.max(a,n.infected);t.strokeStyle="rgba(255, 255, 255, 0.1)",t.lineWidth=1;for(let n=0;n<=4;n++){const r=e+o-n/4*o;t.beginPath(),t.moveTo(s,r),t.lineTo(s+i,r),t.stroke()}const d=new Set;for(const n of this.history)for(const r of Object.keys(n.variants))d.add(r);for(const n of d){const r=this.variants.find(h=>h.name===n);if(!r)continue;t.strokeStyle=r.color,t.lineWidth=2,t.beginPath();let l=!1;for(let h=0;h<this.history.length;h++){const p=this.history[h].variants[n]||0,M=s+h/(this.history.length-1)*i,g=e+o-p/a*o;l?t.lineTo(M,g):(t.moveTo(M,g),l=!0)}t.stroke()}t.font='10px "Fira Code", monospace',t.fillStyle="#666",t.textAlign="right",t.fillText(a.toString(),s-5,e),t.fillText("0",s-5,e+o)}drawVariantBars(t,s,e,i,o){if(t.fillStyle="rgba(255, 255, 255, 0.05)",t.fillRect(s,e,i,o),t.font='12px "Fira Code", monospace',t.fillStyle="#888",t.textAlign="left",t.textBaseline="top",t.fillText("Variant Properties (Transmissibility / Vaccine Resistance)",s,e-15),this.variants.length===0){t.fillStyle="#444",t.textAlign="center",t.fillText("No variants yet",s+i/2,e+o/2);return}const a=Math.min(60,(i-20)/this.variants.length-10),d=(i-a*this.variants.length)/(this.variants.length+1);let n=1;for(const r of this.variants)n=Math.max(n,r.transmissionMultiplier);for(let r=0;r<this.variants.length;r++){const l=this.variants[r],h=s+d+r*(a+d),f=l.transmissionMultiplier/n*(o-30);t.fillStyle=l.color,t.fillRect(h,e+o-20-f,a/2-2,f);const p=l.vaccineResistance*(o-30);t.fillStyle=l.color+"80",t.fillRect(h+a/2+2,e+o-20-p,a/2-2,p),t.font='10px "Fira Code", monospace',t.fillStyle=l.color,t.textAlign="center",t.fillText(l.name,h+a/2,e+o-5)}t.font='10px "Fira Code", monospace',t.fillStyle="#666",t.textAlign="right",t.fillText("■ Trans  □ Resist",s+i,e-15)}}function ct(m){const t=new rt(m);return t.start(),{stop:()=>t.stop(),game:t}}export{ct as default};
