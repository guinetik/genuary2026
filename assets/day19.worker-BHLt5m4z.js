import{F as A,g as w,s as F,c as k}from"./grokking-mlp-NK8p3y84.js";console.log("[Worker] Factored MLP module loaded");let e=null,a=[],r=[],g=null,d=0,p=0,f=0,u=!1;self.onmessage=function(c){const{type:b,data:h}=c.data;switch(console.log(`[Worker] Received: ${b}`),b){case"init":{try{const t=h.config;console.log("[Worker] Config:",t),e=new A(t);const n=w(t.nTokens,t.symmetric!==!1),s=F(n,t.trainFraction||.4);a=s.train,r=s.test,console.log(`[Worker] Data: ${a.length} train, ${r.length} test`),d=0,p=0,f=0,m(),console.log("[Worker] Init complete")}catch(t){console.error("[Worker] Init error:",t),self.postMessage({type:"error",error:t.message})}break}case"train":{if(!e||u)return;u=!0;const t=performance.now(),{epochsPerFrame:n,batchSize:s=64}=h;for(let W=0;W<n;W++){const i=[];for(let o=0;o<a.length;o++)i.push(o);for(let o=i.length-1;o>0;o--){const l=Math.floor(Math.random()*(o+1));[i[o],i[l]]=[i[l],i[o]]}e.resetGradients();for(let o=0;o<a.length;o++){const l=a[i[o]],{cache:T}=e.forward(l.a,l.b);e.backward(l.target,T)}e.applyAdamW(a.length),d++}p=k(e,a),f=k(e,r);const y=performance.now()-t;d%100===0&&console.log(`[Worker] Epoch ${d}: train=${(p*100).toFixed(1)}%, test=${(f*100).toFixed(1)}% (${y.toFixed(0)}ms)`),u=!1,m();break}case"forward":{if(!e)return;const{a:t,b:n}=h,{probs:s,hidden:y}=e.forward(t,n);self.postMessage({type:"forward",hiddenActivations:e.getGridActivations(),outputActivations:Array.from(s),prediction:e.predict(t,n)});break}case"syncWeights":{if(!e)return;const t=n=>n.map(s=>Array.from(s));self.postMessage({type:"syncWeights",weights:{embed:t(e.embed),Whidden:t(e.Whidden),Wout:t(e.Wout)},config:{nTokens:e.nTokens,embedSize:e.embedSize,hiddenSize:e.hiddenSize}});break}case"reset":{if(!e)return;const t=h.config;e=new A(t);const n=w(t.nTokens,t.symmetric!==!1),s=F(n,t.trainFraction||.4);a=s.train,r=s.test,g=null,d=0,p=0,f=0,m();break}case"grokMode":{c.data.enabled?(g=r,r=[...a],console.log(`[Worker] Grok mode ON - test set = train set (${r.length} examples)`)):(g&&(r=g,g=null),console.log(`[Worker] Grok mode OFF - original test set restored (${r.length} examples)`)),e&&(f=k(e,r),m());break}}};function m(){if(!e)return;const c=r[0]||a[0];c&&e.forward(c.a,c.b),self.postMessage({type:"state",epoch:d,trainAccuracy:p,testAccuracy:f,hiddenActivations:e.getGridActivations(),outputActivations:Array.from(e.outputActivations),hiddenSize:e.hiddenSize,nTokens:e.nTokens})}
