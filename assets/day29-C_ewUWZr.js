import{G as dt,d as ft,P as mt,e as gt,T as G,E as pt}from"./index-D3AXu9BF.js";const ut=["Alpha","Beta","Gamma","Delta","Epsilon","Zeta","Eta","Theta","Iota","Kappa","Lambda","Mu","Nu","Xi","Omicron","Pi","Rho","Sigma","Tau","Upsilon","Phi","Chi","Psi","Omega"],L=["#ff2060","#ff6020","#ffaa00","#ff00ff","#ff0080","#aa00ff","#6020ff","#ff4080","#ff8000","#ff0040"],l={gridWidth:60,gridHeight:40,agentCount:100,initialVaccinatedPercent:.25,moveDelay:4,wanderSteps:{min:10,max:20},incubationTime:{min:50,max:100},infectionTime:{min:100,max:200},recoveryChance:.3,deathChance:.1,transmissionRate:.15,roomTransmissionBonus:2,vaccineEfficacy:.95,mutationChanceOnVaccinated:.005,mutationTransmissionBoost:1.4,mutationTransmissionRandomness:.15,mutationVaccineResistanceBoost:.2,mutationResistanceRandomness:.1,maxVariants:10,newAgentInterval:60,newAgentCount:10,colors:{wall:"#353545",hospitalWall:"#40e0e0",agent:"#00ff80",vaccinated:"#00ffff",exposed:"#ffcc00",infected:"#ff2060",recovered:"#4080ff"},trailAlpha:.12,pulseSpeed:3,variantFlashDuration:2.5,variantFlashFadeStart:1.5,historyInterval:.5,maxHistoryPoints:200};function z(m,t){const s=[],e=(y,v)=>Math.floor(Math.random()*(v-y+1))+y;let i=[];for(let y=0;y<t;y++){i.push([]);for(let v=0;v<m;v++)v===0||v===m-1||y===0||y===t-1?i[y].push({type:"wall"}):i[y].push({type:"floor"})}const o=(y,v,b,C,nt)=>{for(let S=v-1;S<=v+C;S++)for(let w=y-1;w<=y+b;w++){const ht=S===v-1,rt=S===v+C,lt=w===y-1,ct=w===y+b;ht||rt||lt||ct?i[S][w]={type:"room_wall"}:i[S][w]={type:"room_floor"}}let R,T;const N=y+Math.floor(b/2),$=v+Math.floor(C/2);switch(nt){case"top":R=N,T=v-1;break;case"bottom":R=N,T=v+C;break;case"left":R=y-1,T=$;break;case"right":R=y+b,T=$;break}return i[T][R]={type:"door"},{x:y,y:v,width:b,height:C,doorX:R,doorY:T}},a=10,f=Math.floor(m/2),r=Math.floor(t/2),c=f-Math.floor(a/2),n=r-Math.floor(a/2),h=o(c,n,a,a,"top");h.isHospital=!0,s.push(h);const d=5,g=c+Math.floor(a/2),M=4,u=m-g-(g-M),p=Math.min(M,u),x=e(5,7),k=e(3,5),W=Math.floor(m/2)-Math.floor(x/2),Y=n-d-k;Y>2&&s.push(o(W,Y,x,k,"bottom"));const D=e(5,7),A=e(3,5),j=Math.floor(m/2)-Math.floor(D/2),F=n+a+d;F+A<t-2&&s.push(o(j,F,D,A,"top"));const X=p,q=e(4,6),Q=e(4,5);s.push(o(X,p,q,Q,"right"));const Z=e(4,6),B=e(5,7),J=Math.floor(t/2)-Math.floor(B/2);s.push(o(X,J,Z,B,"right"));const tt=e(4,6),O=e(4,5);s.push(o(X,t-p-O-1,tt,O,"right"));const V=e(4,6),it=e(4,5),st=m-p-1-V;s.push(o(st,p,V,it,"left"));const P=e(4,6),I=e(5,7),et=Math.floor(t/2)-Math.floor(I/2),ot=m-p-1-P;s.push(o(ot,et,P,I,"left"));const E=e(4,6),_=e(4,5),at=m-p-1-E;return s.push(o(at,t-p-_-1,E,_,"left")),{grid:i,rooms:s}}function K(m,t){const s=t.find(d=>d.isHospital);if(!s)return null;m[0].length,m.length;for(let d=s.y-1;d<=s.y+s.height;d++)for(let g=s.x-1;g<=s.x+s.width;g++)m[d]&&m[d][g]&&(m[d][g].type==="room_wall"||m[d][g].type==="door")&&(m[d][g].type="hospital_wall");const e=1,i=s.y-1-e,o=s.y+s.height+e,a=s.x-1-e,f=s.x+s.width+e,r=s.x+Math.floor(s.width/2),c=s.y+Math.floor(s.height/2),n=r,h=c;for(let d=a;d<=f;d++)if(d>=0&&d<m[0].length){if(d===n)continue;i>=0&&i<m.length&&m[i][d].type==="floor"&&(m[i][d].type="hospital_wall"),o>=0&&o<m.length&&m[o][d].type==="floor"&&(m[o][d].type="hospital_wall")}for(let d=i;d<=o;d++)if(d>=0&&d<m.length){if(d===h)continue;a>=0&&a<m[0].length&&m[d][a].type==="floor"&&(m[d][a].type="hospital_wall"),f>=0&&f<m[0].length&&m[d][f].type==="floor"&&(m[d][f].type="hospital_wall")}return s.y-1>=0&&n>=0&&n<m[0].length&&(m[s.y-1][n].type="door"),s.y+s.height<m.length&&n>=0&&n<m[0].length&&(m[s.y+s.height][n].type="door"),h>=0&&h<m.length&&s.x-1>=0&&(m[h][s.x-1].type="door"),h>=0&&h<m.length&&s.x+s.width<m[0].length&&(m[h][s.x+s.width].type="door"),s.doors=[{x:n,y:s.y-1},{x:n,y:s.y+s.height},{x:s.x-1,y:h},{x:s.x+s.width,y:h}],s}class U{constructor(t,s=null){if(this.index=t,this.name=ut[t]||`Variant-${t}`,this.parent=s,this.generation=s?s.generation+1:0,s){const e=l.mutationTransmissionBoost*(1+(Math.random()-.5)*l.mutationTransmissionRandomness*2);this.transmissionMultiplier=s.transmissionMultiplier*e;const i=l.mutationVaccineResistanceBoost*(1+(Math.random()-.5)*l.mutationResistanceRandomness*2);this.vaccineResistance=Math.min(.95,s.vaccineResistance+i)}else this.transmissionMultiplier=1,this.vaccineResistance=0;this.color=L[t%L.length],this.infectionCount=0,this.emergeTime=0,this.emergeX=0,this.emergeY=0}}class H{constructor(t,s,e,i,o){this.x=t,this.y=s,this.grid=e,this.rooms=i,this.hospital=o,this.gridHeight=e.length,this.gridWidth=e[0].length,this.state="roaming",this.targetRoom=null,this.targetX=t,this.targetY=s,this.roamTargetX=t,this.roamTargetY=s,this.stepsRemaining=0,this.waitFrames=0,this.stuckCounter=0,this.moveTimer=Math.floor(Math.random()*l.moveDelay),this.healthState="susceptible",this.diseaseTimer=0,this.variant=null,this.deathFlash=0,this.lastRoom=null,this.roamTimeRemaining=0,this.dirX=0,this.dirY=0,this.dirSteps=0,this.posHistory=[],this.globalStuckCounter=0}update(){if(this.moveTimer++,!(this.moveTimer<l.moveDelay)){if(this.moveTimer=0,this.waitFrames>0){this.waitFrames--;return}if(this.posHistory.push({x:this.x,y:this.y}),this.posHistory.length>20&&this.posHistory.shift(),this.posHistory.length>=20){const t=Math.min(...this.posHistory.map(a=>a.x)),s=Math.max(...this.posHistory.map(a=>a.x)),e=Math.min(...this.posHistory.map(a=>a.y)),i=Math.max(...this.posHistory.map(a=>a.y));if(s-t+(i-e)<=4){if(this.globalStuckCounter++,this.globalStuckCounter>5){this.teleportToRandomFloor();return}}else this.globalStuckCounter=0}if(this.updateDisease(),this.healthState!=="dead")switch(this.state){case"roaming":this.roam();break;case"goingToDoor":this.goToDoor();break;case"enteringRoom":this.enterRoom();break;case"inRoom":this.wanderInRoom();break;case"exitingRoom":this.exitRoom();break}}}updateDisease(){this.healthState==="exposed"?(this.diseaseTimer--,this.diseaseTimer<=0&&(this.healthState="infected",this.diseaseTimer=l.infectionTime.min+Math.floor(Math.random()*(l.infectionTime.max-l.infectionTime.min)))):this.healthState==="infected"&&(this.diseaseTimer--,this.diseaseTimer<=0&&(Math.random()<l.deathChance?(this.healthState="dead",this.deathFlash=1,this.justDied=!0):Math.random()<l.recoveryChance?this.healthState="recovered":this.diseaseTimer=l.infectionTime.min+Math.floor(Math.random()*(l.infectionTime.max-l.infectionTime.min))))}teleportToRandomFloor(){for(let t=0;t<50;t++){const s=Math.floor(Math.random()*this.gridWidth),e=Math.floor(Math.random()*this.gridHeight);if(this.grid[e][s].type==="floor"){this.x=s,this.y=e,this.state="roaming",this.targetRoom=null,this.lastRoom=null,this.roamTimeRemaining=10,this.posHistory=[],this.globalStuckCounter=0,this.stuckCounter=0,this.dirSteps=0;return}}}roam(){if(this.roamTimeRemaining>0&&this.roamTimeRemaining--,this.randomWalk(),Math.random()<.05&&(this.waitFrames=Math.floor(Math.random()*3)+1),this.roamTimeRemaining<=0&&Math.random()<.03&&this.rooms.length>0){const t=this.rooms.filter(s=>s!==this.lastRoom);t.length>0&&(this.targetRoom=t[Math.floor(Math.random()*t.length)],this.stuckCounter=0,this.state="goingToDoor")}}randomWalk(){if(this.dirSteps>0){const e=this.x+this.dirX,i=this.y+this.dirY;if(e>=0&&e<this.gridWidth&&i>=0&&i<this.gridHeight){const o=this.grid[i][e];if(o.type==="floor"||o.type==="door"){this.x=e,this.y=i,this.dirSteps--;return}}this.dirSteps=0}const s=[{dx:1,dy:0},{dx:-1,dy:0},{dx:0,dy:1},{dx:0,dy:-1}].map(e=>{const i=this.x+e.dx,o=this.y+e.dy;let a=Math.random()*2;if(i>=0&&i<this.gridWidth&&o>=0&&o<this.gridHeight){const f=this.grid[o][i];if(f.type==="floor"||f.type==="door"){for(let c=o-1;c<=o+1;c++)for(let n=i-1;n<=i+1;n++)if(n>=0&&n<this.gridWidth&&c>=0&&c<this.gridHeight){const h=this.grid[c][n];(h.type==="wall"||h.type==="room_wall"||h.type==="hospital_wall")&&(a+=1.5)}return Math.min(i,o,this.gridWidth-i,this.gridHeight-o)<8&&(a+=2),{dir:e,score:a,valid:!0}}}return{dir:e,score:-1,valid:!1}});s.sort((e,i)=>i.score-e.score);for(const{dir:e,valid:i}of s){if(!i)continue;const o=this.x+e.dx,a=this.y+e.dy;this.x=o,this.y=a,this.dirX=e.dx,this.dirY=e.dy,this.dirSteps=8+Math.floor(Math.random()*15);return}}goToDoor(){if(!this.targetRoom){this.state="roaming";return}let t,s;if(this.targetRoom.doors&&this.targetRoom.doors.length>0){let i=1/0;for(const o of this.targetRoom.doors){const a=Math.abs(o.x-this.x)+Math.abs(o.y-this.y);a<i&&(i=a,t=o.x,s=o.y)}}else t=this.targetRoom.doorX,s=this.targetRoom.doorY;if(Math.abs(t-this.x)+Math.abs(s-this.y)<=1){this.x=t,this.y=s,this.state="enteringRoom",this.targetX=this.targetRoom.x+Math.floor(Math.random()*this.targetRoom.width),this.targetY=this.targetRoom.y+Math.floor(Math.random()*this.targetRoom.height),this.stuckCounter=0;return}if(this.stuckCounter>20){this.state="roaming",this.targetRoom=null,this.stuckCounter=0,this.roamTimeRemaining=10;return}this.smartMove(t,s)}enterRoom(){if(!this.targetRoom){this.state="roaming";return}if(this.checkHospital(),Math.abs(this.targetX-this.x)+Math.abs(this.targetY-this.y)===0){this.state="inRoom",this.stepsRemaining=l.wanderSteps.min+Math.floor(Math.random()*(l.wanderSteps.max-l.wanderSteps.min));return}if(this.stuckCounter>10){this.state="inRoom",this.stepsRemaining=l.wanderSteps.min+Math.floor(Math.random()*(l.wanderSteps.max-l.wanderSteps.min)),this.stuckCounter=0;return}this.smartMove(this.targetX,this.targetY)}checkHospital(){if(this.targetRoom&&this.targetRoom.isHospital){if(this.healthState==="infected")return this.healthState="recovered",!0;if(this.healthState==="susceptible")return this.healthState="vaccinated",!0}return!1}wanderInRoom(){if(this.stepsRemaining--,this.checkHospital(),this.stepsRemaining<=0){this.state="exitingRoom",this.stuckCounter=0;return}if(Math.random()<.1){this.waitFrames=Math.floor(Math.random()*3)+1;return}const t=this.targetRoom;if(!t){this.state="roaming";return}const s=[{dx:1,dy:0},{dx:-1,dy:0},{dx:0,dy:1},{dx:0,dy:-1},{dx:0,dy:0}],e=s[Math.floor(Math.random()*s.length)],i=this.x+e.dx,o=this.y+e.dy;this.canMove(i,o)&&i>=t.x&&i<t.x+t.width&&o>=t.y&&o<t.y+t.height&&(this.x=i,this.y=o)}exitRoom(){const t=this.targetRoom;if(!t){this.state="roaming";return}let s,e;if(t.doors&&t.doors.length>0){let r=1/0;for(const c of t.doors){const n=Math.abs(c.x-this.x)+Math.abs(c.y-this.y);n<r&&(r=n,s=c.x,e=c.y)}}else s=t.doorX,e=t.doorY;if(Math.abs(s-this.x)+Math.abs(e-this.y)<=1){this.x=s,this.y=e;const r=[{dx:0,dy:-1},{dx:0,dy:1},{dx:-1,dy:0},{dx:1,dy:0}];for(const c of r){const n=s+c.dx,h=e+c.dy;if(this.canMove(n,h)){const d=n<t.x-1||n>t.x+t.width,g=h<t.y-1||h>t.y+t.height;if(d||g){this.x=n,this.y=h;break}}}this.lastRoom=t,this.targetRoom=null,this.roamTimeRemaining=15+Math.floor(Math.random()*20),this.state="roaming";return}const o=s-this.x,a=e-this.y;let f=!1;if(Math.abs(o)>=Math.abs(a)&&o!==0){const r=this.x+(o>0?1:-1);this.canMove(r,this.y)&&(this.x=r,f=!0)}if(!f&&a!==0){const r=this.y+(a>0?1:-1);this.canMove(this.x,r)&&(this.y=r,f=!0)}if(!f&&o!==0){const r=this.x+(o>0?1:-1);this.canMove(r,this.y)&&(this.x=r,f=!0)}if(f?this.stuckCounter=0:this.stuckCounter++,this.stuckCounter>10){const r=[{dx:0,dy:-1},{dx:0,dy:1},{dx:-1,dy:0},{dx:1,dy:0}];for(const c of r){const n=s+c.dx,h=e+c.dy;if(this.canMove(n,h)){const d=n<t.x-1||n>t.x+t.width,g=h<t.y-1||h>t.y+t.height;if(d||g){this.x=n,this.y=h,this.lastRoom=t,this.targetRoom=null,this.roamTimeRemaining=15+Math.floor(Math.random()*20),this.state="roaming",this.stuckCounter=0;return}}}this.x=s,this.y=e,this.stuckCounter=0}}smartMove(t,s){const e=t-this.x,i=s-this.y,o=this.x,a=this.y;let f=!1;const r=[];e>0&&r.push({dx:1,dy:0,priority:Math.abs(e)}),e<0&&r.push({dx:-1,dy:0,priority:Math.abs(e)}),i>0&&r.push({dx:0,dy:1,priority:Math.abs(i)}),i<0&&r.push({dx:0,dy:-1,priority:Math.abs(i)}),r.sort((c,n)=>n.priority-c.priority);for(const c of r){const n=this.x+c.dx,h=this.y+c.dy;if(this.canMove(n,h)){this.x=n,this.y=h,f=!0;break}}if(!f){const c=[];e!==0&&(c.push({dx:0,dy:1}),c.push({dx:0,dy:-1})),i!==0&&(c.push({dx:1,dy:0}),c.push({dx:-1,dy:0}));for(let n=c.length-1;n>0;n--){const h=Math.floor(Math.random()*(n+1));[c[n],c[h]]=[c[h],c[n]]}for(const n of c){const h=this.x+n.dx,d=this.y+n.dy;if(this.canMove(h,d)){this.x=h,this.y=d,f=!0;break}}}this.x===o&&this.y===a?this.stuckCounter++:this.stuckCounter=0}canMove(t,s){if(t<0||t>=this.gridWidth||s<0||s>=this.gridHeight)return!1;const e=this.grid[s][t];return e.type==="floor"||e.type==="room_floor"||e.type==="door"}}class yt extends dt{constructor(t){super(t),this.backgroundColor=null}init(){super.init(),ft.init(this),mt.init(this.ctx);const{grid:t,rooms:s}=z(l.gridWidth,l.gridHeight);this.grid=t,this.rooms=s,this.gridHeight=t.length,this.gridWidth=t[0].length,this.hospital=K(this.grid,this.rooms),this.calculateGrid(),this.agents=[];const e=[];for(let i=0;i<this.gridHeight;i++)for(let o=0;o<this.gridWidth;o++){const a=this.grid[i][o].type;(a==="floor"||a==="room_floor"||a==="door")&&e.push({x:o,y:i})}this.floorCells=e,this.variants=[],this.nextVariantIndex=0;for(let i=0;i<Math.min(l.agentCount,e.length);i++){const o=Math.floor(Math.random()*e.length),a=e[o],f=new H(a.x,a.y,this.grid,this.rooms,this.hospital);Math.random()<l.initialVaccinatedPercent&&(f.healthState="vaccinated"),this.agents.push(f)}this.elapsedTime=0,this.lastWaveTime=0,this.infectionStarted=!1,this.showDataOverlay=!1,this.history=[],this.lastHistoryTime=0,this.dominantVariant=null,this.dataButton=new gt(this,{text:"[i]",width:36,height:36,font:'14px "Fira Code", monospace',startToggled:!1,onToggle:i=>{this.showDataOverlay=i}}),this.pipeline.add(this.dataButton),this.container=this.canvas.parentElement,this.container&&this.enableFluidSize(this.container),this.canvas.addEventListener("click",i=>this.handleClick(i)),this.canvas.addEventListener("touchend",i=>{i.preventDefault(),this.handleClick(i.changedTouches[0])}),this.handleKeyDown=i=>{(i.key==="r"||i.key==="R")&&this.restart()},window.addEventListener("keydown",this.handleKeyDown)}handleClick(t){const s=this.canvas.getBoundingClientRect(),e=t.clientX-s.left,i=t.clientY-s.top;if(this.showDataOverlay){const n=this.width-36,h=this.height-36;if(!(e>=n-18&&e<=n+18&&i>=h-18&&i<=h+18)){this.showDataOverlay=!1,this.dataButton.toggle(!1);return}}const o=Math.floor((e-this.gridOffsetX)/this.cellW),a=Math.floor((i-this.gridOffsetY)/this.cellH),f=Math.max(this.cellW,this.cellH)*1.5;let r=null,c=f;for(const n of this.agents){if(n.healthState==="dead")continue;const h=this.gridOffsetX+n.x*this.cellW+this.cellW/2,d=this.gridOffsetY+n.y*this.cellH+this.cellH/2,g=Math.sqrt((e-h)**2+(i-d)**2);g<c&&(c=g,r=n)}if(r)(r.healthState==="susceptible"||r.healthState==="vaccinated")&&this.infectAgent(r);else if(o>=0&&o<this.gridWidth&&a>=0&&a<this.gridHeight){const n=this.grid[a][o];if(n.type==="floor"||n.type==="room_floor"||n.type==="door"){const h=new H(o,a,this.grid,this.rooms,this.hospital);this.agents.push(h)}}}restart(){const{grid:t,rooms:s}=z(l.gridWidth,l.gridHeight);this.grid=t,this.rooms=s,this.gridHeight=t.length,this.gridWidth=t[0].length,this.hospital=K(this.grid,this.rooms),this.calculateGrid();const e=[];for(let i=0;i<this.gridHeight;i++)for(let o=0;o<this.gridWidth;o++){const a=this.grid[i][o].type;(a==="floor"||a==="room_floor"||a==="door")&&e.push({x:o,y:i})}this.floorCells=e,this.agents=[];for(let i=0;i<Math.min(l.agentCount,e.length);i++){const o=Math.floor(Math.random()*e.length),a=e[o],f=new H(a.x,a.y,this.grid,this.rooms,this.hospital);Math.random()<l.initialVaccinatedPercent&&(f.healthState="vaccinated"),this.agents.push(f)}this.variants=[],this.nextVariantIndex=0,this.infectionStarted=!1,this.dominantVariant=null,this.elapsedTime=0,this.lastWaveTime=0,this.history=[],this.lastHistoryTime=0,this.showDataOverlay=!1,this.dataButton&&this.dataButton.toggle(!1)}infectAgent(t){if(!this.infectionStarted){const e=new U(this.nextVariantIndex++,null);e.emergeTime=this.elapsedTime,e.emergeX=t.x,e.emergeY=t.y,this.variants.push(e),this.infectionStarted=!0}const s=this.variants[0];t.healthState="exposed",t.variant=s,s.infectionCount++,t.diseaseTimer=l.incubationTime.min+Math.floor(Math.random()*(l.incubationTime.max-l.incubationTime.min))}calculateGrid(){const t=this.width/this.gridWidth,s=this.height/this.gridHeight,e=Math.max(t,s);this.cellW=e,this.cellH=e;const i=this.gridWidth*this.cellW,o=this.gridHeight*this.cellH;this.gridOffsetX=(this.width-i)/2,this.gridOffsetY=(this.height-o)/2}update(t){super.update(t),this.calculateGrid(),this.elapsedTime+=t,this.dataButton&&(this.dataButton.x=this.width-36,this.dataButton.y=this.height-36),this.infectionStarted&&this.elapsedTime-this.lastWaveTime>=l.newAgentInterval&&(this.spawnNewAgents(l.newAgentCount),this.lastWaveTime=this.elapsedTime);for(const s of this.agents)s.update(),s.justDied&&(s.justDied=!1,G.to(s,{deathFlash:0},.8,pt.easeOutQuad));this.processTransmission(),this.elapsedTime-this.lastHistoryTime>=l.historyInterval&&(this.recordHistory(),this.lastHistoryTime=this.elapsedTime),this.updateDominantVariant(),G.updateAll(t)}recordHistory(){const t={};let s=0,e=0;for(const i of this.agents)i.healthState==="infected"||i.healthState==="exposed"?(s++,i.variant&&(t[i.variant.name]=(t[i.variant.name]||0)+1)):i.healthState==="recovered"&&e++;this.history.push({time:this.elapsedTime,infected:s,recovered:e,variants:{...t}}),this.history.length>l.maxHistoryPoints&&this.history.shift()}updateDominantVariant(){if(this.variants.length===0){this.dominantVariant=null;return}const t=new Map;for(const i of this.agents)(i.healthState==="infected"||i.healthState==="exposed")&&i.variant&&t.set(i.variant,(t.get(i.variant)||0)+1);let s=0,e=null;for(const[i,o]of t)o>s&&(s=o,e=i);this.dominantVariant=e}createMutatedVariant(t,s=null){const e=new U(this.nextVariantIndex++,t);return e.emergeTime=this.elapsedTime,s&&(e.emergeX=s.x,e.emergeY=s.y),this.variants.push(e),console.log(`[MUTATION] New variant emerged: ${e.name} (from ${t.name})`),console.log(`  - Transmissibility: ${(e.transmissionMultiplier*100).toFixed(0)}%`),console.log(`  - Vaccine resistance: ${(e.vaccineResistance*100).toFixed(0)}%`),e}spawnNewAgents(t){for(let s=0;s<t&&this.floorCells.length!==0;s++){const e=Math.floor(Math.random()*this.floorCells.length),i=this.floorCells[e],o=new H(i.x,i.y,this.grid,this.rooms,this.hospital);this.agents.push(o)}}getAgentRoom(t){for(const s of this.rooms)if(t.x>=s.x&&t.x<s.x+s.width&&t.y>=s.y&&t.y<s.y+s.height)return s;return null}processTransmission(){const t=new Map;for(const e of this.agents){if(e.healthState==="dead")continue;const i=`${e.x},${e.y}`;t.has(i)||t.set(i,[]),t.get(i).push(e)}const s=this.agents.filter(e=>e.healthState==="infected");for(const e of s){const i=this.getAgentRoom(e),o=e.variant;if(o)for(let a=-1;a<=1;a++)for(let f=-1;f<=1;f++){const r=e.x+f,c=e.y+a,n=`${r},${c}`;if(t.has(n))for(const h of t.get(n)){if(h===e||h.healthState!=="susceptible"&&h.healthState!=="vaccinated")continue;let d=l.transmissionRate*o.transmissionMultiplier;f===0&&a===0&&(d*=1.5);const g=this.getAgentRoom(h),M=h.healthState==="vaccinated";if(i&&g&&i===g){const x=M?l.roomTransmissionBonus*.6:l.roomTransmissionBonus;d*=x}if(M){const x=Math.max(.5,l.vaccineEfficacy-o.vaccineResistance);d*=1-x}const p=Math.random();if(p<d)h.healthState="exposed",h.variant=o,o.infectionCount++,h.diseaseTimer=l.incubationTime.min+Math.floor(Math.random()*(l.incubationTime.max-l.incubationTime.min));else if(M&&p<d+l.mutationChanceOnVaccinated&&this.variants.length<l.maxVariants){const x=this.createMutatedVariant(o,e);e.variant=x;const k=Math.max(0,l.vaccineEfficacy-x.vaccineResistance),W=l.transmissionRate*x.transmissionMultiplier*(1-k);Math.random()<W&&(h.healthState="exposed",h.variant=x,x.infectionCount++,h.diseaseTimer=l.incubationTime.min+Math.floor(Math.random()*(l.incubationTime.max-l.incubationTime.min)))}}}}}render(){const t=this.ctx,s=this.elapsedTime;t.fillStyle=`rgba(5, 5, 8, ${l.trailAlpha})`,t.fillRect(0,0,this.width,this.height),this.stats={susceptible:0,vaccinated:0,exposed:0,infected:0,recovered:0,dead:0};for(const i of this.agents)this.stats[i.healthState]++;t.strokeStyle="rgba(255, 255, 255, 0.03)",t.lineWidth=1;for(let i=0;i<=this.gridWidth;i++)t.beginPath(),t.moveTo(this.gridOffsetX+i*this.cellW,this.gridOffsetY),t.lineTo(this.gridOffsetX+i*this.cellW,this.gridOffsetY+this.gridHeight*this.cellH),t.stroke();for(let i=0;i<=this.gridHeight;i++)t.beginPath(),t.moveTo(this.gridOffsetX,this.gridOffsetY+i*this.cellH),t.lineTo(this.gridOffsetX+this.gridWidth*this.cellW,this.gridOffsetY+i*this.cellH),t.stroke();for(let i=0;i<this.gridHeight;i++)for(let o=0;o<this.gridWidth;o++){const a=this.grid[i][o],f=this.gridOffsetX+o*this.cellW,r=this.gridOffsetY+i*this.cellH;a.type==="wall"||a.type==="room_wall"?(t.fillStyle=l.colors.wall,t.fillRect(f,r,this.cellW+1,this.cellH+1)):a.type==="hospital_wall"&&(t.fillStyle=l.colors.hospitalWall,t.shadowColor=l.colors.hospitalWall,t.shadowBlur=4,t.fillRect(f,r,this.cellW+1,this.cellH+1),t.shadowBlur=0)}if(this.hospital){const i=this.hospital,o=i.x+Math.floor(i.width/2),a=i.y+Math.floor(i.height/2),f=this.gridOffsetX+o*this.cellW+this.cellW/2,r=this.gridOffsetY+a*this.cellH+this.cellH/2;t.fillStyle=l.colors.hospitalWall,t.shadowColor=l.colors.hospitalWall,t.shadowBlur=3,t.globalAlpha=.25;const c=this.cellW*.7,n=this.cellH*2.5;t.fillRect(f-c/2,r-n/2,c,n),t.fillRect(f-n/2,r-c/2,n,c),t.globalAlpha=1,t.shadowBlur=0}for(const i of this.agents){const o=this.gridOffsetX+i.x*this.cellW+this.cellW/2,a=this.gridOffsetY+i.y*this.cellH+this.cellH/2,f=Math.min(this.cellW,this.cellH)*.4;let r,c,n=1,h=0;const d=i.variant&&i.variant===this.dominantVariant,g=d?1.5:i.variant&&this.dominantVariant?.6:1;switch(i.healthState){case"exposed":r=i.variant?i.variant.color:l.colors.exposed,c=r,n=.7,h=Math.sin(s*l.pulseSpeed+i.x*.5)*.2;break;case"infected":r=i.variant?i.variant.color:l.colors.infected,c=r,h=Math.sin(s*l.pulseSpeed*2+i.y*.5)*(d?.4:.25);break;case"recovered":r=l.colors.recovered,c=r;break;case"vaccinated":r=l.colors.vaccinated,c=r,h=Math.sin(s*2+i.x+i.y)*.1;break;case"dead":const u=i.deathFlash||0,p=Math.floor(34+u*221);r=`rgb(${p}, ${p}, ${p})`,c=u>.1?"#fff":"#111",n=.5+u*.5;break;default:r=l.colors.agent,c=r}const M=f*(1+h);if(i.healthState!=="dead"){const u=M*2.5*g,p=t.createRadialGradient(o,a,0,o,a,u),x=d?"80":"40";p.addColorStop(0,c+x),p.addColorStop(.5,c+"20"),p.addColorStop(1,"transparent"),t.fillStyle=p,t.beginPath(),t.arc(o,a,u,0,Math.PI*2),t.fill()}if(t.globalAlpha=n,t.fillStyle=r,t.beginPath(),t.arc(o,a,M,0,Math.PI*2),t.fill(),i.healthState!=="dead"){const u=t.createRadialGradient(o-M*.3,a-M*.3,0,o,a,M);u.addColorStop(0,"rgba(255,255,255,0.4)"),u.addColorStop(.5,"rgba(255,255,255,0.1)"),u.addColorStop(1,"transparent"),t.fillStyle=u,t.beginPath(),t.arc(o,a,M,0,Math.PI*2),t.fill()}t.globalAlpha=1}t.fillStyle="rgba(0, 0, 0, 0.03)";for(let i=0;i<this.height;i+=3)t.fillRect(0,i,this.width,1);const e=t.createRadialGradient(this.width/2,this.height/2,this.height*.3,this.width/2,this.height/2,this.height*.9);e.addColorStop(0,"transparent"),e.addColorStop(1,"rgba(0, 0, 0, 0.4)"),t.fillStyle=e,t.fillRect(0,0,this.width,this.height),this.drawVariantFlashes(t,s),this.drawMinimalHUD(t),this.showDataOverlay&&this.drawDataOverlay(t),this.dataButton&&this.dataButton.render()}drawVariantFlashes(t,s){for(const e of this.variants){const i=s-e.emergeTime;if(i<0||i>l.variantFlashDuration)continue;let o=1;i>l.variantFlashFadeStart&&(o=1-(i-l.variantFlashFadeStart)/(l.variantFlashDuration-l.variantFlashFadeStart));const a=this.gridOffsetX+e.emergeX*this.cellW+this.cellW/2,f=this.gridOffsetY+e.emergeY*this.cellH-20;t.save(),t.globalAlpha=o,t.font='bold 16px "Fira Code", monospace',t.textAlign="center",t.textBaseline="bottom",t.shadowColor=e.color,t.shadowBlur=15,t.fillStyle=e.color,t.fillText(e.name.toUpperCase(),a,f),t.shadowBlur=0,t.fillText(e.name.toUpperCase(),a,f),t.restore()}}drawMinimalHUD(t){t.font='11px "Fira Code", monospace',t.textAlign="right",t.textBaseline="top",t.fillStyle="rgba(0, 0, 0, 0.5)",t.fillRect(this.width-180,12,168,44),t.fillStyle="rgba(0, 255, 128, 0.6)",t.fillText("CLICK agent to INFECT",this.width-16,16),t.fillText("CLICK floor to SPAWN",this.width-16,28),t.fillText("[R] RESTART",this.width-16,40),t.font='12px "Fira Code", monospace',t.textAlign="left",t.textBaseline="bottom";const s=this.stats.infected+this.stats.exposed,e=this.stats.recovered,i=this.stats.dead,o=i>0?46:32,a=this.height-o-12;t.fillStyle="rgba(0, 0, 0, 0.5)",t.fillRect(12,a,120,o);let f=a+14;t.fillStyle=l.colors.infected,t.fillText(`INFECTED: ${s}`,16,f),f+=14,t.fillStyle=l.colors.recovered,t.fillText(`RECOVERED: ${e}`,16,f),i>0&&(f+=14,t.fillStyle="#666",t.fillText(`DEAD: ${i}`,16,f))}drawDataOverlay(t){t.fillStyle="rgba(0, 0, 0, 0.85)",t.fillRect(0,0,this.width,this.height);const s=40,e=this.width-s*2,i=(this.height-s*3)/2;t.font='bold 18px "Fira Code", monospace',t.fillStyle="#fff",t.textAlign="center",t.textBaseline="top",t.fillText("VARIANT ANALYTICS",this.width/2,15),this.drawPrevalenceChart(t,s,s+20,e,i-20),this.drawVariantBars(t,s,s+i+30,e,i-30),t.font='11px "Fira Code", monospace',t.fillStyle="rgba(255, 255, 255, 0.5)",t.textAlign="center",t.fillText("click anywhere to close",this.width/2,this.height-15)}drawPrevalenceChart(t,s,e,i,o){if(t.fillStyle="rgba(255, 255, 255, 0.05)",t.fillRect(s,e,i,o),t.font='12px "Fira Code", monospace',t.fillStyle="#888",t.textAlign="left",t.textBaseline="top",t.fillText("Infections Over Time",s,e-15),this.history.length<2){t.fillStyle="#444",t.textAlign="center",t.fillText("Collecting data...",s+i/2,e+o/2);return}let a=1;for(const r of this.history)a=Math.max(a,r.infected);t.strokeStyle="rgba(255, 255, 255, 0.1)",t.lineWidth=1;for(let r=0;r<=4;r++){const c=e+o-r/4*o;t.beginPath(),t.moveTo(s,c),t.lineTo(s+i,c),t.stroke()}const f=new Set;for(const r of this.history)for(const c of Object.keys(r.variants))f.add(c);for(const r of f){const c=this.variants.find(h=>h.name===r);if(!c)continue;t.strokeStyle=c.color,t.lineWidth=2,t.beginPath();let n=!1;for(let h=0;h<this.history.length;h++){const g=this.history[h].variants[r]||0,M=s+h/(this.history.length-1)*i,u=e+o-g/a*o;n?t.lineTo(M,u):(t.moveTo(M,u),n=!0)}t.stroke()}t.font='10px "Fira Code", monospace',t.fillStyle="#666",t.textAlign="right",t.fillText(a.toString(),s-5,e),t.fillText("0",s-5,e+o)}drawVariantBars(t,s,e,i,o){if(t.fillStyle="rgba(255, 255, 255, 0.05)",t.fillRect(s,e,i,o),t.font='12px "Fira Code", monospace',t.fillStyle="#888",t.textAlign="left",t.textBaseline="top",t.fillText("Variant Properties (Transmissibility / Vaccine Resistance)",s,e-15),this.variants.length===0){t.fillStyle="#444",t.textAlign="center",t.fillText("No variants yet",s+i/2,e+o/2);return}const a=Math.min(60,(i-20)/this.variants.length-10),f=(i-a*this.variants.length)/(this.variants.length+1);let r=1;for(const h of this.variants)r=Math.max(r,h.transmissionMultiplier);const c=Math.min(...this.variants.map(h=>h.transmissionMultiplier)),n=Math.max(r-c,.5);for(let h=0;h<this.variants.length;h++){const d=this.variants[h],g=s+f+h*(a+f),u=(d.transmissionMultiplier-c)/n*(o-30);t.fillStyle=d.color,t.fillRect(g,e+o-20-u,a/2-2,u);const p=d.vaccineResistance*(o-30);t.fillStyle=d.color+"80",t.fillRect(g+a/2+2,e+o-20-p,a/2-2,p),t.font='9px "Fira Code", monospace',t.fillStyle=d.color,t.textAlign="center",t.fillText(d.name,g+a/2,e+o-5),u>15&&(t.font='7px "Fira Code", monospace',t.fillStyle="#aaa",t.fillText(`${d.transmissionMultiplier.toFixed(1)}x`,g+a/2,e+o-22-u))}t.font='10px "Fira Code", monospace',t.fillStyle="#666",t.textAlign="right",t.fillText("■ Trans  □ Resist",s+i,e-15)}stop(){this.handleKeyDown&&window.removeEventListener("keydown",this.handleKeyDown),super.stop()}}function vt(m){const t=new yt(m);return t.start(),{stop:()=>t.stop(),game:t}}export{vt as default};
