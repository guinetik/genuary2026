import{G as w,P as S,C as M,Y as v,c as P}from"./index-B0ivFyqO.js";const a={background:"#000",maxDepth:3,particleBaseSize:20,particleMinSize:2,particleShape:"square",colors:{stroke:"#0f0"},camera:{perspective:800,rotationX:.5,rotationY:-.6,inertia:!0,friction:.92,clampX:!1},animation:{autoRotateSpeed:.15,attractStrength:8,damping:.92,scatterForce:800,buildDelay:.001,maxSponges:7}},f=[{x:1,y:0,z:0},{x:-1,y:0,z:0},{x:0,y:-1,z:0},{x:0,y:1,z:0},{x:0,y:0,z:1},{x:0,y:0,z:-1},{x:1,y:-1,z:0},{x:-1,y:-1,z:0},{x:1,y:1,z:0},{x:-1,y:1,z:0},{x:1,y:0,z:1},{x:-1,y:0,z:1},{x:1,y:0,z:-1},{x:-1,y:0,z:-1},{x:0,y:-1,z:1},{x:0,y:-1,z:-1},{x:0,y:1,z:1},{x:0,y:1,z:-1}];function b(g,t,e,n,o,i,h=[]){if(o>=i)return h.push({x:g,y:t,z:e,size:n,depth:o}),h;const l=n/3,c=n/3;for(let r=-1;r<=1;r++)for(let s=-1;s<=1;s++)for(let p=-1;p<=1;p++){if((r===0?1:0)+(s===0?1:0)+(p===0?1:0)>=2)continue;const m=g+r*c,y=t+s*c,z=e+p*c;b(m,y,z,l,o+1,i,h)}return h}class C extends w{constructor(t){super(t),this.backgroundColor=a.background}init(){super.init(),S.init(this.ctx),this.camera=new M({perspective:a.camera.perspective,rotationX:a.camera.rotationX,rotationY:a.camera.rotationY,inertia:a.camera.inertia,friction:a.camera.friction,clampX:a.camera.clampX,autoRotate:!0,autoRotateSpeed:a.animation.autoRotateSpeed,autoRotateAxis:"y"}),this.camera.enableMouseControl(this.canvas),this.time=0,this.zoom=1,this.targetZoom=1,this.buildTime=0,this.cubesSpawned=0,this.spongeCount=0,this.totalParticles=0,this.existingPositions=new Set,this.positionTolerance=.1,this.nextCubeIndex=0,this.generateTargets(),this.createParticleSystem(),this.canvas.addEventListener("dblclick",()=>{this.scatterParticles()}),this._onKeyDown=t=>{(t.key==="r"||t.key==="R")&&this.restart()},window.addEventListener("keydown",this._onKeyDown),this.gesture=new v(this.canvas,{onZoom:t=>{const e=t>0?1.1:.9;this.targetZoom=Math.max(.3,Math.min(15,this.targetZoom*e))},onTap:()=>{this.scatterParticles()}})}stop(){super.stop(),this.gesture&&this.gesture.destroy(),this.particles&&this.particles.destroy(),this._onKeyDown&&window.removeEventListener("keydown",this._onKeyDown)}restart(){this.particles.clear(),this.time=0,this.buildTime=0,this.cubesSpawned=0,this.spongeCount=0,this.nextCubeIndex=0,this.zoom=1,this.targetZoom=1,this.existingPositions.clear(),this.cubes=[],this.generateTargets(),console.log("Restarted")}generateTargets(){const e=Math.min(this.width,this.height)*.35,n=b(0,0,0,e,0,a.maxDepth);n.sort((i,h)=>i.depth-h.depth);const o=this.positionTolerance;this.cubes=n.map((i,h)=>{const l=`${Math.round(i.x/o)},${Math.round(i.y/o)},${Math.round(i.z/o)}`;return this.existingPositions.add(l),{x:i.x,y:i.y,z:i.z,size:i.size,spawnDelay:h*a.animation.buildDelay,spawned:!1}}),console.log(`Menger Sponge: ${this.cubes.length} cubes/particles`)}createParticleSystem(){this._strength=a.animation.attractStrength,this._damping=a.animation.damping;const t=(e,n)=>{if(!e.alive)return;const o=e.custom;if(o.targetX===void 0)return;const i=this.zoom,h=o.targetX*i-e.x,l=o.targetY*i-e.y,c=o.targetZ*i-e.z,r=this._strength*n,s=this._damping;e.vx=(e.vx+h*r)*s,e.vy=(e.vy+l*r)*s,e.vz=(e.vz+c*r)*s,e.x+=e.vx*n,e.y+=e.vy*n,e.z+=e.vz*n};this.particles=new P(this,{camera:this.camera,depthSort:!0,maxParticles:5e4,blendMode:"source-over",useWebGL:!0,webglShape:"softSquare",webglBlendMode:"alpha",depthShading:!0,depthShadingMin:.25,depthShadingMax:1,updaters:[t]}),this.pipeline.add(this.particles),console.log(`Particle rendering: ${this.particles.isWebGL?"WebGL (GPU)":"Canvas 2D (CPU)"}`)}spawnCube(t){const e=this._spawnRadius||(this._spawnRadius=Math.max(this.width,this.height)*.8),n=Math.random()*Math.PI*2,o=Math.acos(2*Math.random()-1),i=e*(.3+Math.random()*.7),h=Math.sin(o),l=i*h*Math.cos(n),c=i*h*Math.sin(n),r=i*Math.cos(o),s=this.particles.acquire();s.x=l,s.y=c,s.z=r,s.vx=-l*.5,s.vy=-c*.5,s.vz=-r*.5;const p=this._baseSizeRef||(this._baseSizeRef=Math.min(this.width,this.height)*.35);s.size=Math.max(a.particleMinSize,a.particleBaseSize*t.size/p),s.color.r=0,s.color.g=255,s.color.b=0,s.color.a=1,s.shape=a.particleShape,s.age=0,s.lifetime=1/0,s.alive=!0,s.custom.targetX=t.x,s.custom.targetY=t.y,s.custom.targetZ=t.z,this.particles.particles.push(s),t.spawned=!0,this.cubesSpawned++}scatterParticles(){const t=this.particles.particles,e=a.animation.scatterForce;for(let n=0,o=t.length;n<o;n++){const i=t[n];if(!i.alive)continue;const h=Math.random()*Math.PI*2,l=Math.acos(2*Math.random()-1),c=e*(.5+Math.random()),r=Math.sin(l);i.vx+=c*r*Math.cos(h),i.vy+=c*r*Math.sin(h),i.vz+=c*Math.cos(l)}}update(t){for(super.update(t),this.time+=t,this.buildTime+=t,this.camera.update(t),this.zoom+=(this.targetZoom-this.zoom)*.15;this.nextCubeIndex<this.cubes.length;){const e=this.cubes[this.nextCubeIndex];if(this.buildTime>=e.spawnDelay)this.spawnCube(e),this.nextCubeIndex++;else break}this.nextCubeIndex>=this.cubes.length&&this.spawnNextSponge()}spawnNextSponge(){if(this.spongeCount>=a.animation.maxSponges-1)return;this.spongeCount++,this.totalParticles+=this.cubesSpawned;const e=Math.min(this.width,this.height)*.35,n=e,o=Math.floor(this.spongeCount/f.length)+1,i=(this.spongeCount-1)%f.length,h=f[i],l=h.x*n*o,c=h.y*n*o,r=h.z*n*o,s=b(l,c,r,e,0,a.maxDepth),p=this.positionTolerance,x=this.existingPositions,m=[];for(const d of s){const u=`${Math.round(d.x/p)},${Math.round(d.y/p)},${Math.round(d.z/p)}`;x.has(u)||(x.add(u),m.push(d))}m.sort((d,u)=>d.depth-u.depth);const y=this.buildTime;for(let d=0;d<m.length;d++){const u=m[d];this.cubes.push({x:u.x,y:u.y,z:u.z,size:u.size,spawnDelay:y+d*a.animation.buildDelay,spawned:!1})}const z=s.length-m.length;console.log(`Sponge #${this.spongeCount+1} | New: ${m.length} | Shared: ${z}`)}clear(){this.ctx.fillStyle="rgba(0, 0, 0, 0.1)",this.ctx.fillRect(0,0,this.width,this.height)}render(){super.render();const t=this.ctx;t.fillStyle=a.colors.stroke,t.font="12px monospace",t.textAlign="left";const e=this.particles.isWebGL?"WebGL":"Canvas";console.log("Render Mode",e),t.fillText(`MENGER SPONGE | Depth: ${a.maxDepth} | Sponges: ${this.spongeCount+1} | Particles: ${this.cubesSpawned} | ${e}`,10,this.height-10),t.textAlign="right",t.fillText(`Zoom: ${this.zoom.toFixed(1)}x | Dbl-click: scatter | R: restart`,this.width-10,20)}onResize(){this._spawnRadius=null,this._baseSizeRef=null}}function R(g){const t=new C(g);return t.start(),{stop:()=>t.stop(),game:t}}export{R as default};
