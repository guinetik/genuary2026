import{G as E,P as G,C as A,S as D,a as H,F as x}from"./gcanvas.es-Cc1M3jca.js";const s={perspective:600,defaultTiltX:.095,defaultTiltY:0,wallHeight:320,wallY:250,wallZ:350,starCount:80,moonSize:40,sidewalkY:250,curbHeight:25,streetNearZ:50,gutterZ:120,sidewalkZ:180,sectionWidth:500,scrollSpeed:140,lampSpacing:1e3,lampHeight:450,slabWidth:150,runnerSrc:"./spritesheet_small.png",runnerFrameWidth:120,runnerFrameHeight:120,runnerColumns:10,runnerRows:5,runnerFrameCount:50,runnerFrameRate:10,runnerScale:1.1,runnerBlendMode:"xor",wallColor:"#1a1a1a",sidewalkColor:"#3a3a3a",gutterColor:"#222",streetColor:"#2a2a2a",slabLineColor:"#555",hue:135};class N extends E{constructor(e){super(e),this.backgroundColor="#000"}init(){super.init(),G.init(this.ctx),this.camera=new A({perspective:s.perspective,rotationX:s.defaultTiltX,rotationY:s.defaultTiltY,sensitivity:.003,inertia:!1,clampX:!0,minRotationX:0,maxRotationX:.5}),this.camera.enableMouseControl(this.canvas),this.cameraReturning=!1,this._setupCameraReturn(),this.time=0,this.scrollOffset=0,this.stars=[];for(let e=0;e<s.starCount;e++)this.stars.push({x:Math.random(),y:Math.random()*.3,size:Math.random()*2+1,twinkle:Math.random()*Math.PI*2});this.sectionCache=new Map,this.patternGenerators=this._getPatternGenerators(),this._loadRunner()}async _loadRunner(){this.runner=new D(this,{src:s.runnerSrc,frameWidth:s.runnerFrameWidth,frameHeight:s.runnerFrameHeight,columns:s.runnerColumns,rows:s.runnerRows,frameCount:s.runnerFrameCount,frameRate:s.runnerFrameRate,loop:!0,autoPlay:!0,smoothing:!1}),await this.runner.load()}_seededRandom(e){const t=Math.sin(e*9999)*1e4;return t-Math.floor(t)}_getPatternGenerators(){return[(e,t,o,a)=>H.checkerboard(e,e,{cellSize:4+Math.floor(this._seededRandom(a*1.1)*12),color1:o,color2:t}),(e,t,o,a)=>H.solidGrid(e,e,{spacing:4+Math.floor(this._seededRandom(a*1.2)*10),background:o,foreground:t}),(e,t,o,a)=>H.stripes(e,e,{spacing:3+Math.floor(this._seededRandom(a*1.3)*8),thickness:1+Math.floor(this._seededRandom(a*1.4)*4),background:o,foreground:t}),(e,t,o,a)=>H.mesh(e,e,{spacing:4+Math.floor(this._seededRandom(a*1.5)*10),lineWidth:1+Math.floor(this._seededRandom(a*1.6)*3),background:o,foreground:t}),(e,t,o,a)=>H.dotPattern(e,e,{dotSize:2+Math.floor(this._seededRandom(a*1.7)*6),spacing:4+Math.floor(this._seededRandom(a*1.8)*10),dotColor:t,background:o}),(e,t,o,a)=>H.cross(e,e,{size:6+Math.floor(this._seededRandom(a*1.9)*10),thickness:1+Math.floor(this._seededRandom(a*2)*4),spacing:8+Math.floor(this._seededRandom(a*2.1)*16),background:o,foreground:t})]}_hslToRgba(e,t,o,a=255){t/=100,o/=100;const c=i=>(i+e/30)%12,d=i=>o-t*Math.min(o,1-o)*Math.max(-1,Math.min(c(i)-3,Math.min(9-c(i),1)));return[Math.round(255*d(0)),Math.round(255*d(8)),Math.round(255*d(4)),a]}_getColorPalette(e){const t=[{hues:[120,140,160],sat:[60,90],light:[30,55]},{hues:[170,190,200],sat:[70,100],light:[35,50]},{hues:[300,320,340],sat:[60,85],light:[35,55]},{hues:[200,220,240],sat:[65,95],light:[30,50]},{hues:[20,35,50],sat:[80,100],light:[40,60]},{hues:[260,280,300],sat:[55,85],light:[30,50]},{hues:[160,175,190],sat:[70,95],light:[25,45]},{hues:[70,90,110],sat:[75,100],light:[35,55]}],o=Math.floor(this._seededRandom(e)*t.length);return t[o]}_pickFromPalette(e,t){const o=e.hues[Math.floor(this._seededRandom(t*1.1)*e.hues.length)],a=e.sat[0]+this._seededRandom(t*1.2)*(e.sat[1]-e.sat[0]),c=e.light[0]+this._seededRandom(t*1.3)*(e.light[1]-e.light[0]);return{hue:o,sat:a,light:c}}async _generateSection(e){if(this.sectionCache.has(e))return this.sectionCache.get(e);const t=e*12345.6789,o=32,a=256,c=document.createElement("canvas");c.width=a,c.height=a;const d=c.getContext("2d");d.imageSmoothingEnabled=!1;const i=this._getColorPalette(t*.5),w=this._seededRandom(t*.6)>.5?this._getColorPalette(t*.7):i,m=this._pickFromPalette(i,t),S=this._hslToRgba(m.hue,m.sat,m.light),C=this._hslToRgba(m.hue,20,8),h=Math.floor(this._seededRandom(t*1)*this.patternGenerators.length),f=this.patternGenerators[h](o,S,C,t),y=await G.img.createImageBitmapFromPixels(f,o,o);for(let R=0;R<a;R+=o)for(let r=0;r<a;r+=o)d.drawImage(y,r,R,o,o);const M=[[2,2],[2,3],[3,2],[3,3],[4,4],[2,4],[4,2]],u=Math.floor(this._seededRandom(t*2)*M.length),[g,n]=M[u],T=a/g,Y=a/n;for(let R=0;R<n;R++)for(let r=0;r<g;r++){const p=t*(R*10+r+3);if(this._seededRandom(p)>.4){const l=this._pickFromPalette(w,p*2),_=this._hslToRgba(l.hue,l.sat,l.light),P=this._hslToRgba(l.hue,25,12),b=Math.floor(this._seededRandom(p*2.1)*this.patternGenerators.length),k=this.patternGenerators[b](o,_,P,p),W=await G.img.createImageBitmapFromPixels(k,o,o),X=2,v=r*T+X,j=R*Y+X,B=T-X*2,L=Y-X*2;for(let F=j;F<j+L;F+=o)for(let Z=v;Z<v+B;Z+=o){const O=Math.min(o,v+B-Z),$=Math.min(o,j+L-F);d.drawImage(W,0,0,O,$,Z,F,O,$)}}}const z=this._seededRandom(t*4)>.5?1+Math.floor(this._seededRandom(t*4.1)*2):0;for(let R=0;R<z;R++){const r=t*(R+5),p=Math.floor(this._seededRandom(r*1)*6),l=48+Math.floor(this._seededRandom(r*1.1)*80);let _;p===0?_=x.sierpinski(l,l,5+Math.floor(this._seededRandom(r*1.2)*3)):p===1?_=x.sierpinskiCarpet(l,l,3+Math.floor(this._seededRandom(r*1.3)*2)):p===2?_=x.julia(l,l,30,-.8+this._seededRandom(r*1.4)*.6,.1+this._seededRandom(r*1.5)*.4):p===3?_=x.mandelbrot(l,l,40,-2.2+this._seededRandom(r*1.6)*.5,-1.5+this._seededRandom(r*1.7)*.5,-1+this._seededRandom(r*1.8)*.5,1+this._seededRandom(r*1.9)*.5):p===4?_=x.newton(l,l,30):_=x.koch(l,l,4);const P=this._pickFromPalette(i,r*2),b=new Uint8ClampedArray(l*l*4);for(let j=0;j<_.length;j++){const B=_[j],L=20+B/255*50,[F,Z,O]=this._hslToRgba(P.hue,P.sat,L);b[j*4]=F,b[j*4+1]=Z,b[j*4+2]=O,b[j*4+3]=B>20?180:0}const k=await G.img.createImageBitmapFromPixels(b,l,l),W=Math.floor(this._seededRandom(r*3)*(a-l)),X=Math.floor(this._seededRandom(r*3.1)*(a-l)),v=1+this._seededRandom(r*3.2)*1.5;d.globalAlpha=.6+this._seededRandom(r*3.3)*.3,d.drawImage(k,W,X,l*v,l*v),d.globalAlpha=1}return this.sectionCache.set(e,c),c}_setupCameraReturn(){this.canvas.addEventListener("mouseup",()=>{this.cameraReturning=!0}),this.canvas.addEventListener("mouseleave",()=>{this.cameraReturning=!0}),this.canvas.addEventListener("mousedown",()=>{this.cameraReturning=!1})}update(e){if(super.update(e),this.time+=e,this.scrollOffset+=s.scrollSpeed*e,this.cameraReturning&&!this.camera._isDragging){const o=3*e;this.camera.rotationX+=(s.defaultTiltX-this.camera.rotationX)*o,this.camera.rotationY+=(s.defaultTiltY-this.camera.rotationY)*o,Math.abs(this.camera.rotationX-s.defaultTiltX)<.001&&Math.abs(this.camera.rotationY-s.defaultTiltY)<.001&&(this.camera.rotationX=s.defaultTiltX,this.camera.rotationY=s.defaultTiltY,this.cameraReturning=!1)}const t=.25;this.camera.rotationY=Math.max(-t,Math.min(t,this.camera.rotationY)),this.camera.update(e),this.runner&&this.runner.loaded&&this.runner.update(e)}render(){const e=this.ctx,t=this.width,o=this.height,a=t/2,c=o/2;e.fillStyle="#000",e.fillRect(0,0,t,o),this._renderSky(e,t,o),this._renderWall(e,a,c),this._renderPatternSections(e,a,c),this._renderSidewalk(e,a,c,t,o),this._renderRunner(e,a,c),this._renderLampPosts(e,a,c)}_renderSky(e,t,o){const c=-this.camera.rotationY*t*.5,d=-this.camera.rotationX*o*.3;for(const h of this.stars){const f=Math.sin(this.time*3+h.twinkle)*.5+.5,y=Math.floor((.3+f*.7)*4)/4,M=Math.floor((h.x*t+c)/4)*4,u=Math.floor((h.y*o+d)/4)*4,g=Math.max(4,Math.floor(h.size/4)*4),n=Math.floor(y*3)*85;e.fillStyle=`rgb(${n}, ${n}, ${Math.min(255,n+20)})`,e.fillRect(M,u,g,g)}const i=Math.floor((t*.8+c)/4)*4,w=Math.floor((o*.12+d)/4)*4,m=s.moonSize,S=6;for(let h=S;h>=0;h--){const f=m+h*4*3,y=Math.floor((1-h/S)*4)/16;e.fillStyle=`rgba(150, 180, 220, ${y})`;for(let M=w-f;M<w+f;M+=4)for(let u=i-f;u<i+f;u+=4){const g=u-i,n=M-w,T=Math.sqrt(g*g+n*n);T<f&&T>=f-4*3&&e.fillRect(u,M,4,4)}}const C=["#e8e8f0","#d0d0e0","#b8b8d0"];for(let h=w-m-4;h<w+m+4;h+=4)for(let f=i-m-4;f<i+m+4;f+=4){const y=f-i,M=h-w,u=Math.sqrt(y*y+M*M);if(u<m){const g=(f/4+h/4)%3;e.fillStyle=C[g],e.fillRect(f,h,4,4)}else u<m+4*2&&(f/4+h/4)%2===0&&(e.fillStyle=C[2],e.fillRect(f,h,4,4))}}_renderWall(e,t,o){const d=s.wallY-s.wallHeight,i=s.wallY,w=s.wallZ,m=this.camera.project(-2e3,d,w),S=this.camera.project(2e3,d,w),C=this.camera.project(2e3,i,w),h=this.camera.project(-2e3,i,w);e.beginPath(),e.moveTo(t+m.x,o+m.y),e.lineTo(t+S.x,o+S.y),e.lineTo(t+C.x,o+C.y),e.lineTo(t+h.x,o+h.y),e.closePath(),e.fillStyle=s.wallColor,e.fill()}_renderPatternSections(e,t,o){const a=s.sectionWidth,c=s.wallY-s.wallHeight,d=s.wallY,i=s.wallZ-1,w=Math.floor(this.scrollOffset/a)-2,m=10;for(let S=0;S<m;S++){const C=w+S,h=C*a-this.scrollOffset,f=h+a,y=this.camera.project(h,c,i),M=this.camera.project(f,c,i),u=this.camera.project(f,d,i),g=this.camera.project(h,d,i),n=Math.min(y.x,g.x),T=Math.max(M.x,u.x);if(t+T<-50||t+n>this.width+50)continue;let Y=this.sectionCache.get(C);Y===void 0&&(this._generateSection(C),Y=null);const z={x:t+y.x,y:o+y.y},R={x:t+M.x,y:o+M.y},r={x:t+u.x,y:o+u.y},p={x:t+g.x,y:o+g.y};if(Y){e.save(),e.beginPath(),e.moveTo(z.x,z.y),e.lineTo(R.x,R.y),e.lineTo(r.x,r.y),e.lineTo(p.x,p.y),e.closePath(),e.clip();const l=Math.min(z.x,R.x,r.x,p.x),_=Math.max(z.x,R.x,r.x,p.x),P=Math.min(z.y,R.y,r.y,p.y),b=Math.max(z.y,R.y,r.y,p.y);e.drawImage(Y,l,P,_-l,b-P),e.restore()}else{const l=C*12345.6789,_=s.hue+(this._seededRandom(l*2.4)-.5)*40;e.beginPath(),e.moveTo(z.x,z.y),e.lineTo(R.x,R.y),e.lineTo(r.x,r.y),e.lineTo(p.x,p.y),e.closePath(),e.fillStyle=`hsl(${_}, 60%, 20%)`,e.fill()}e.strokeStyle="#000",e.lineWidth=5,e.beginPath(),e.moveTo(z.x,z.y),e.lineTo(p.x,p.y),e.stroke()}}_renderSidewalk(e,t,o,a,c){const d=s.sidewalkY,i=d+s.curbHeight,w=s.wallZ,m=s.sidewalkZ,S=s.gutterZ,C=s.streetNearZ;this.camera.project(-2e3,i,C),this.camera.project(2e3,i,C);const h=this.camera.project(-2e3,i,S),f=this.camera.project(2e3,i,S);e.beginPath(),e.moveTo(0,c),e.lineTo(a,c),e.lineTo(t+f.x,o+f.y),e.lineTo(t+h.x,o+h.y),e.closePath(),e.fillStyle=s.streetColor,e.fill();const y=this.camera.project(-2e3,i,S),M=this.camera.project(2e3,i,S),u=this.camera.project(-2e3,i,m),g=this.camera.project(2e3,i,m);e.beginPath(),e.moveTo(t+y.x,o+y.y),e.lineTo(t+M.x,o+M.y),e.lineTo(t+g.x,o+g.y),e.lineTo(t+u.x,o+u.y),e.closePath(),e.fillStyle=s.gutterColor,e.fill();const n=this.camera.project(-2e3,d,m),T=this.camera.project(2e3,d,m),Y=this.camera.project(-2e3,i,m),z=this.camera.project(2e3,i,m);e.beginPath(),e.moveTo(t+n.x,o+n.y),e.lineTo(t+T.x,o+T.y),e.lineTo(t+z.x,o+z.y),e.lineTo(t+Y.x,o+Y.y),e.closePath(),e.fillStyle="#333",e.fill(),e.strokeStyle="#444",e.lineWidth=2,e.beginPath(),e.moveTo(t+n.x,o+n.y),e.lineTo(t+T.x,o+T.y),e.stroke();const R=this.camera.project(-2e3,d,m),r=this.camera.project(2e3,d,m),p=this.camera.project(-2e3,d,w),l=this.camera.project(2e3,d,w);e.beginPath(),e.moveTo(t+R.x,o+R.y),e.lineTo(t+r.x,o+r.y),e.lineTo(t+l.x,o+l.y),e.lineTo(t+p.x,o+p.y),e.closePath(),e.fillStyle=s.sidewalkColor,e.fill();const _=s.slabWidth,P=3;e.fillStyle=s.slabLineColor;const b=Math.floor((this.scrollOffset-1e3)/_)*_;for(let k=b;k<this.scrollOffset+1e3;k+=_){const W=k-this.scrollOffset,X=this.camera.project(W,d,m),v=this.camera.project(W,d,w),j=Math.floor((t+X.x)/P)*P,B=Math.floor((o+X.y)/P)*P,L=Math.floor((o+v.y)/P)*P;for(let F=Math.min(B,L);F<=Math.max(B,L);F+=P)e.fillRect(j,F,P,P)}}_renderRunner(e,t,o){if(!this.runner||!this.runner.loaded)return;const a=0,c=(s.sidewalkZ+s.wallZ)/2,d=s.sidewalkY,i=this.camera.project(a,d,c),w=i.scale*s.runnerScale,m=t+i.x,S=o+i.y,C=this.runner.currentShape;if(!C||!C._bitmap)return;const h=C._bitmap,f=s.runnerFrameWidth*w,y=s.runnerFrameHeight*w;e.save(),e.imageSmoothingEnabled=!1;const M=m-f/2,u=S-y,g=2;e.globalCompositeOperation="source-over",e.filter="brightness(0) invert(1)";for(let n=-g;n<=g;n+=g)for(let T=-g;T<=g;T+=g)n===0&&T===0||e.drawImage(h,M+n,u+T,f,y);e.filter="none",e.globalCompositeOperation=s.runnerBlendMode,e.drawImage(h,M,u,f,y),e.restore()}_renderLampPosts(e,t,o){const a=s.lampSpacing,c=s.sidewalkY,d=(s.sidewalkZ+s.wallZ)/2,i=Math.floor((this.scrollOffset-1200)/a),w=Math.ceil((this.scrollOffset+1200)/a);for(let m=i;m<=w;m++){const S=m*a-this.scrollOffset+100,C=this.camera.project(S,c,d);if(Math.abs(C.x)>this.width)continue;const h=this.camera.project(S,c,d),f=this.camera.project(S,c-s.lampHeight,d);e.strokeStyle="#444",e.lineWidth=Math.max(2,5*h.scale),e.beginPath(),e.moveTo(t+h.x,o+h.y),e.lineTo(t+f.x,o+f.y),e.stroke();const y=d-50,M=this.camera.project(S,c-s.lampHeight+20,y);e.lineWidth=Math.max(1,3*h.scale),e.beginPath(),e.moveTo(t+f.x,o+f.y),e.lineTo(t+M.x,o+M.y),e.stroke();const u=this.camera.project(S,c-s.lampHeight+35,y),g=60*u.scale,n=6,T=Math.floor((t+u.x)/n)*n,Y=Math.floor((o+u.y)/n)*n,z=4;for(let b=z;b>=0;b--){const k=g/z*(b+1),W=(1-b/z)*.6,X=70-b*10;e.fillStyle=`hsla(${s.hue}, 100%, ${X}%, ${W})`;for(let v=Y-k;v<Y+k;v+=n)for(let j=T-k;j<T+k;j+=n){const B=j-T,L=v-Y,F=Math.sqrt(B*B+L*L);F<k&&F>=k-g/z&&e.fillRect(j,v,n,n)}}e.fillStyle=`hsla(${s.hue}, 100%, 80%, 0.9)`,e.fillRect(T-n,Y-n,n*2,n*2);const R=this.camera.project(S-80,c,y+20),r=this.camera.project(S+80,c,y+20),p=Math.abs(r.x-R.x),l=Math.max(n*2,30*u.scale),_=Math.floor((t+u.x-p/2)/n)*n,P=Math.floor((o+R.y-l/2)/n)*n;e.fillStyle=`hsla(${s.hue}, 70%, 40%, 0.2)`;for(let b=P;b<P+l;b+=n)for(let k=_;k<_+p;k+=n){const W=Math.min(k-_,_+p-k-n)/p,X=Math.min(b-P,P+l-b-n)/l;(Math.min(W,X)>.1||(k/n+b/n)%2===0)&&e.fillRect(k,b,n,n)}}}stop(){super.stop(),this.camera&&this.camera.disableMouseControl()}}function q(I){const e=new N(I);return e.start(),{stop:()=>e.stop(),game:e}}export{q as default};
