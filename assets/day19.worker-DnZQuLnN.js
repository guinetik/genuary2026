import{FactoredNetwork as w,generateAllPairs as y,splitData as A,calcAccuracy as k}from"./day19.grokking-BLQhquhM.js";import{shuffledIndices as $}from"./day19.utils-DeEDoNyc.js";console.log("[Worker] Factored MLP module loaded");let e=null,n=[],o=[],l=null,i=0,d=0,c=0,m=!1;self.onmessage=function(a){const{type:u,data:f}=a.data;switch(console.log(`[Worker] Received: ${u}`),u){case"init":{try{const t=f.config;console.log("[Worker] Config:",t),e=new w(t);const r=y(t.nTokens,t.symmetric??!0),s=A(r,t.trainFraction||.4);n=s.train,o=s.test,console.log(`[Worker] Data: ${n.length} train, ${o.length} test`),i=0,d=0,c=0,g(),console.log("[Worker] Init complete")}catch(t){console.error("[Worker] Init error:",t),self.postMessage({type:"error",error:t.message})}break}case"train":{if(!e||m)return;m=!0;const t=performance.now(),{epochsPerFrame:r,batchSize:s=64}=f;for(let W=0;W<r;W++){const F=$(n.length);e.resetGradients();for(let p=0;p<n.length;p++){const h=n[F[p]],{cache:T}=e.forward(h.a,h.b);e.backward(h.target,T)}e.applyAdamW(n.length),i++}d=k(e,n),c=k(e,o);const b=performance.now()-t;i%100===0&&console.log(`[Worker] Epoch ${i}: train=${(d*100).toFixed(1)}%, test=${(c*100).toFixed(1)}% (${b.toFixed(0)}ms)`),m=!1,g();break}case"forward":{if(!e)return;const{a:t,b:r}=f,{probs:s,hidden:b}=e.forward(t,r);self.postMessage({type:"forward",hiddenActivations:e.getGridActivations(),outputActivations:s,prediction:e.predict(t,r)});break}case"syncWeights":{if(!e)return;self.postMessage({type:"syncWeights",weights:{embed:e.embed,Whidden:e.Whidden,Wout:e.Wout},config:{nTokens:e.nTokens,embedSize:e.embedSize,hiddenSize:e.hiddenSize}});break}case"reset":{if(!e)return;const t=f.config;e=new w(t);const r=y(t.nTokens,t.symmetric??!0),s=A(r,t.trainFraction||.4);n=s.train,o=s.test,l=null,i=0,d=0,c=0,g();break}case"grokMode":{a.data.enabled?(l=o,o=[...n],console.log(`[Worker] Grok mode ON - test set = train set (${o.length} examples)`)):(l&&(o=l,l=null),console.log(`[Worker] Grok mode OFF - original test set restored (${o.length} examples)`)),e&&(c=k(e,o),g());break}}};function g(){if(!e)return;const a=o[0]||n[0];a&&e.forward(a.a,a.b),self.postMessage({type:"state",epoch:i,trainAccuracy:d,testAccuracy:c,hiddenActivations:e.getGridActivations(),outputActivations:e.outputActivations,hiddenSize:e.hiddenSize,nTokens:e.nTokens})}
