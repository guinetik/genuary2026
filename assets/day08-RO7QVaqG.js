import{G as A,P as O,C as D,g as $,c as Z,U as T,b as E,i as G,E as X,M as Y,j as k}from"./gcanvas.es-BBvhR3Fu.js";const c={star:{radius:80,temperature:25e3,activityLevel:.7,color:[.6,.8,1],rotationSpeed:.3},lattice:{nodeSize:1.5,rotationSpeed:.03,color:"#44aaff",layers:[{radius:140,count:80,size:1},{radius:160,count:120,size:1.5},{radius:180,count:100,size:1.25}]},streams:{particleCount:80,speed:100,innerColor:{r:150,g:200,b:255,a:.9}},ships:{count:15,size:4,speed:120,constructorSpeed:250,color:"#44ddbb",glowColor:"rgba(80, 220, 180, 0.8)",trailColor:"rgba(80, 200, 170, 0.4)"},stations:{count:5,orbitRadius:280},camera:{perspective:600,autoRotateSpeed:.08,friction:.92},phases:{intro:6,arrival:7,deployment:5,capitol:6},rocket:{bodyColor:"#663399",accentColor:"#ffcc00",thrustColor:"#ff8800",panelColor:"#8866ff",voxelSize:4},reveal:{staggerDelay:.02,annexStagger:1.5,shipSpawnInterval:1},style:{bgColor:"#000",trailAlpha:.12},starfield:{count:250,radius:450,minSize:.5,maxSize:1.5,twinkleSpeed:1.5},wormhole:{radius:60,ringCount:5,particleCount:40,rotationSpeed:2,spawnTime:2.3,colors:{inner:"#aa88ff",outer:"#4488ff",particles:"#cc99ff"},fadeOutStart:.4,fadeOutEnd:.8}};function I(M,t){const i=[],s=Math.PI*(3-Math.sqrt(5));for(let a=0;a<M;a++){const e=1-a/(M-1)*2,r=Math.sqrt(1-e*e),n=s*a;i.push({x:Math.cos(n)*r*t,y:e*t,z:Math.sin(n)*r*t})}return i}function j(M,t,i,s,a){M.save(),M.translate(t,i),M.rotate(a),M.beginPath(),M.moveTo(s,0),M.lineTo(-s*.6,-s*.5),M.lineTo(-s*.3,0),M.lineTo(-s*.6,s*.5),M.closePath(),M.fillStyle=c.ships.color,M.fill(),M.beginPath(),M.arc(-s*.4,0,s*.3,0,Math.PI*2),M.fillStyle=c.ships.glowColor,M.fill(),M.restore()}class F{constructor(t,i,s){this.id=t,this.route=i,this.routeIndex=0,this.speed=s,this.active=!1,this.state="travel",this.stateTimer=0,this.orbitRadius=25+Math.random()*15,this.orbitSpeed=(Math.random()>.5?1:-1)*(.5+Math.random()*.8),this.orbitAngle=Math.random()*Math.PI*2,this.orbitTilt=(Math.random()-.5)*1,this.x=0,this.y=0,this.z=0,this.trail=[],this.angle=0}spawn(t,i,s){this.active=!0,this.x=t,this.y=i,this.z=s,this.state="travel",this.routeIndex=0,this.trail=[]}getCurrentTargetPos(){const t=this.route[this.routeIndex];return t.type==="station"?{x:t.target.x,y:t.target.y,z:t.target.z}:t.target}update(t){const i=this.getCurrentTargetPos();if(this.trail.push({x:this.x,y:this.y,z:this.z}),this.trail.length>25&&this.trail.shift(),this.state==="travel"){const s=i.x-this.x,a=i.y-this.y,e=i.z-this.z,r=Math.sqrt(s*s+a*a+e*e),n=this.route[this.routeIndex].type==="station"?this.orbitRadius:5;if(r<n+2)this.state="orbit",this.stateTimer=4+Math.random()*5,this.orbitAngle=Math.atan2(this.z-i.z,this.x-i.x);else{const o=this.speed*t;this.x+=s/r*o,this.y+=a/r*o,this.z+=e/r*o,this.angle=Math.atan2(a,s)}}else if(this.state==="orbit"){if(this.stateTimer-=t,this.stateTimer<=0){this.state="travel",this.routeIndex=(this.routeIndex+1)%this.route.length;return}this.orbitAngle+=this.orbitSpeed*t;const s=this.orbitRadius,a=Math.cos(this.orbitAngle)*s,e=Math.sin(this.orbitAngle)*s,r=Math.sin(this.orbitAngle)*Math.sin(this.orbitTilt)*s;this.x=i.x+a,this.y=i.y+r,this.z=i.z+e;const n=this.orbitAngle+.1*Math.sign(this.orbitSpeed),o=Math.cos(n)*s,h=Math.sin(n)*Math.sin(this.orbitTilt)*s;this.angle=Math.atan2(h-r,o-a)}}}class L{constructor(t){this.game=t,this.visible=!0,this.x=0,this.y=0,this.z=0,this.heading=0,this.panelDeployProgress=0,this.satelliteSeparation=0,this.disassembling=!1,this.disassemblyProgress=0,this.capitolTarget=null,this.voxels=[],this.panels=[],this.satellites=[],this.generateStarship()}setCapitolTarget(t,i,s){this.capitolTarget={x:t,y:i,z:s}}generateStarship(){var u,d,f,m,y;const t=(u=c.rocket)==null?void 0:u.voxelSize,i=(d=c.rocket)==null?void 0:d.bodyColor,s="#442266",a=(f=c.rocket)==null?void 0:f.accentColor,e=(m=c.rocket)==null?void 0:m.thrustColor,r=(y=c.rocket)==null?void 0:y.panelColor,n=(l,S,g,x,b=1)=>{const w=Math.random()*Math.PI*2,P=(Math.random()-.5)*Math.PI,v=80+Math.random()*120;return{lx:l*t,ly:S*t,lz:g*t,size:t*b,color:x,cube:new k(t*b,{camera:this.game.camera,faceColors:{front:x,back:x,left:x,right:x,top:x,bottom:x},stroke:"rgba(150, 100, 200, 0.4)"}),scatterVel:{x:Math.cos(w)*Math.cos(P)*v,y:Math.sin(P)*v,z:Math.sin(w)*Math.cos(P)*v},disassemblyOffset:{x:0,y:0,z:0},alpha:1}},o=[{x:-8,width:9},{x:-7,width:9},{x:-6,width:8},{x:-5,width:8},{x:-4,width:7},{x:-3,width:7},{x:-2,width:6},{x:-1,width:5},{x:0,width:5},{x:1,width:4},{x:2,width:4},{x:3,width:3},{x:4,width:3},{x:5,width:2},{x:6,width:2},{x:7,width:1},{x:8,width:1},{x:9,width:1},{x:10,width:.5}];for(const l of o){const S=l.width/2;for(let g=-Math.floor(S);g<=Math.floor(S);g++)this.voxels.push(n(l.x,0,g,i)),l.width>=5&&Math.abs(g)<S-1&&this.voxels.push(n(l.x,1,g,i,.9)),l.width>=4&&Math.abs(g)<S-.5&&this.voxels.push(n(l.x,-1,g,s,.9)),l.width>=7&&Math.abs(g)<S-1.5&&this.voxels.push(n(l.x,-2,g,s,.8))}for(let l=-4;l<=0;l++)for(let S=-1;S<=1;S++)this.voxels.push(n(l,2,S,i,.85));for(let l=-3;l<=-1;l++)this.voxels.push(n(l,3,0,a,.7));this.voxels.push(n(-2,4,0,a,.5));for(let l=-6;l<=6;l+=2){const S=o.findIndex(g=>g.x===l);if(S>=0){const g=Math.floor(o[S].width/2);this.voxels.push(n(l,0,g,a,.6)),this.voxels.push(n(l,0,-g,a,.6))}}for(let l=-4;l<=4;l++)this.voxels.push(n(-9,0,l,e,.8)),Math.abs(l)<3&&this.voxels.push(n(-9,-1,l,e,.7));for(let l=2;l<=6;l+=2)this.voxels.push(n(l,1,0,a,.5));const h=[-5,-4,-3,-2,-1,0,1,2];for(const l of h)this.panels.push({...n(l,0,5,r,.5),baseX:l*t,baseZ:5*t,side:1,deployOffset:4*t}),this.panels.push({...n(l,0,-5,r,.5),baseX:l*t,baseZ:-5*t,side:-1,deployOffset:4*t});const p=[{x:4,y:2,z:2,dir:{x:1,y:1,z:1}},{x:4,y:2,z:-2,dir:{x:1,y:1,z:-1}},{x:0,y:2,z:3,dir:{x:0,y:1,z:1}},{x:0,y:2,z:-3,dir:{x:0,y:1,z:-1}},{x:-4,y:2,z:3,dir:{x:-1,y:1,z:1}},{x:-4,y:2,z:-3,dir:{x:-1,y:1,z:-1}}];for(const l of p)this.satellites.push({...n(l.x,l.y,l.z,a,.6),baseX:l.x*t,baseY:l.y*t,baseZ:l.z*t,separationDir:l.dir})}setPosition(t,i,s){this.x=t,this.y=i,this.z=s}setHeading(t){this.heading=t}deployPanels(t){this.panelDeployProgress=Math.max(0,Math.min(1,t));for(const i of this.panels)i.lz=i.baseZ+i.side*i.deployOffset*this.panelDeployProgress}separateSatellites(t){if(this.satelliteSeparation=Math.max(0,Math.min(1,t)),!this.capitolTarget){for(const r of this.satellites){const n=this.satelliteSeparation;r.lx=r.baseX+r.separationDir.x*40*n,r.ly=r.baseY+r.separationDir.y*40*n,r.lz=r.baseZ+r.separationDir.z*40*n}return}const i=this.satellites.length,s=.6,a=(1-s)/Math.max(1,i-1);for(let e=0;e<i;e++){const r=this.satellites[e],n=e*a,o=n+s;let h=0;if(this.satelliteSeparation>=o?h=1:this.satelliteSeparation>n&&(h=(this.satelliteSeparation-n)/s),h>0&&!r.flightStartPos&&(r.flightStartPos={x:this.x+r.baseX,y:this.y+r.baseY,z:this.z+r.baseZ}),!r.flightStartPos){r.lx=r.baseX,r.ly=r.baseY,r.lz=r.baseZ,r.worldPos=null;continue}const p=h*h*(3-2*h),u=30,d=e/i*Math.PI*2,f=this.capitolTarget.x+Math.cos(d)*u,m=this.capitolTarget.y+10,y=this.capitolTarget.z+Math.sin(d)*u,l=r.flightStartPos.x+(f-r.flightStartPos.x)*p,S=r.flightStartPos.y+(m-r.flightStartPos.y)*p,g=r.flightStartPos.z+(y-r.flightStartPos.z)*p;r.worldPos={x:l,y:S,z:g},r.alpha=1}}startDisassembly(t,i=4){this.disassembling=!0,this.disassemblyStartTime=t,this.disassemblyDuration=i;const s=[...this.voxels,...this.panels,...this.satellites];for(let e=s.length-1;e>0;e--){const r=Math.floor(Math.random()*(e+1));[s[e],s[r]]=[s[r],s[e]]}const a=i/s.length;s.forEach((e,r)=>{e.hideTime=t+r*a,e.alpha=1})}updateDisassembly(t){if(!this.disassembling)return!0;const i=[...this.voxels,...this.panels,...this.satellites];let s=!0;for(const a of i)t>=a.hideTime?a.alpha=0:s=!1;return s?(this.disassembling=!1,this.visible=!1,!0):!1}update(t){this.disassembling&&this.updateDisassembly(t)}getRenderables(t){if(!this.visible)return;const i=Math.cos(this.heading),s=Math.sin(this.heading),a=e=>{var f,m,y;if(e.alpha<=0)return;const r=e.lx*i-e.lz*s,n=e.lx*s+e.lz*i,o=e.ly,h=this.x+r+(((f=e.disassemblyOffset)==null?void 0:f.x)||0),p=this.y+o+(((m=e.disassemblyOffset)==null?void 0:m.y)||0),u=this.z+n+(((y=e.disassemblyOffset)==null?void 0:y.z)||0),d=this.game.camera.project(h,p,u);t.push({type:"voxel",cube:e.cube,x:h,y:p,z:u,depth:d.z,scale:d.scale,revealScale:1,alpha:e.alpha})};for(const e of this.voxels)a(e);for(const e of this.panels)a(e);for(const e of this.satellites){if(e.alpha<=0)continue;let r,n,o;if(e.worldPos)r=e.worldPos.x,n=e.worldPos.y,o=e.worldPos.z;else{const p=e.lx*i-e.lz*s,u=e.lx*s+e.lz*i;r=this.x+p,n=this.y+e.ly,o=this.z+u}const h=this.game.camera.project(r,n,o);t.push({type:"voxel",cube:e.cube,x:r,y:n,z:o,depth:h.z,scale:h.scale,revealScale:1,alpha:e.alpha})}}}class V{constructor(t,i,s,a,e=!1,r=.03){this.game=t,this.id=i,this.orbitRadius=s,this.isCapitol=e,this.orbitSpeed=r,this.tilt=(Math.random()-.5)*.4,this.angle=a,this.rotation=Math.random()*Math.PI*2,this.rotationSpeed=.1+Math.random()*.1,this.baseRadius=e?10:3+Math.floor(Math.random()*2),this.voxelSize=e?5:4,this.voxels=[],this.generateCity(),this.updatePosition()}generateCity(){const t=this.baseRadius,i=this.voxelSize,s={capitol:{main:"#ffaa44",accent:"#ffcc88",dark:"#aa6600",glow:"#ffff00",stroke:"rgba(255, 200, 100, 0.4)"},annex:[{main:"#00ffaa",accent:"#44ffcc",dark:"#006644",glow:"#00ffff",stroke:"rgba(0, 255, 200, 0.4)"},{main:"#4488ff",accent:"#88aaff",dark:"#222266",glow:"#44ccff",stroke:"rgba(100, 150, 255, 0.4)"},{main:"#aa44ff",accent:"#cc88ff",dark:"#442244",glow:"#ff44ff",stroke:"rgba(180, 100, 255, 0.4)"},{main:"#44ff44",accent:"#88ff88",dark:"#224422",glow:"#00ff00",stroke:"rgba(100, 255, 100, 0.4)"}]},a=this.isCapitol?s.capitol:s.annex[this.id%s.annex.length],e=a.stroke,r=(d,f,m,y,l=1)=>{const S=this.voxels.length;this.voxels.push({lx:d*i,ly:f*i,lz:m*i,size:i*l,color:y,cube:new k(i*l,{camera:this.game.camera,faceColors:{front:y,back:y,left:y,right:y,top:y,bottom:y},stroke:e}),visible:!0,revealOrder:S,revealTime:0,revealScale:1})},n=this.isCapitol?8:4+Math.floor(Math.random()*3);for(let d=1;d<=n;d++){const f=d>n*.7?.7:1;r(0,-d,0,a.dark,f)}r(0,-(n+1),0,a.glow,.6);const o=this.isCapitol?4:2;for(let d=0;d<o;d++){const f=d/o*Math.PI*2,m=Math.round(Math.cos(f)*1.5),y=Math.round(Math.sin(f)*1.5);for(let l=2;l<=n*.6;l++)r(m,-l,y,a.dark,.6)}for(let d=-t;d<=t;d++)for(let f=-t;f<=t;f++){const m=d*d+f*f;m<=t*t&&(r(d,0,f,a.dark),Math.floor(Math.sqrt(Math.max(0,t*t-m))*.3)>0&&m>(t-2)*(t-2)&&r(d,-1,f,a.dark,.8))}for(let d=0;d<Math.PI*2;d+=.3){const f=Math.round(Math.cos(d)*t),m=Math.round(Math.sin(d)*t);Math.random()>.3&&r(f,1,m,a.accent,.5)}const h=new Map,p=this.isCapitol?4:2;for(let d=0;d<p;d++){const f=d/p*Math.PI*2+Math.random()*.5,m=Math.random()*t*.5,y=Math.round(Math.cos(f)*m),l=Math.round(Math.sin(f)*m),S=this.isCapitol?6+Math.floor(Math.random()*4):3+Math.floor(Math.random()*3);for(let g=-1;g<=1;g++)for(let x=-1;x<=1;x++){const b=y+g,w=l+x,P=`${b},${w}`;if(h.has(P)||b*b+w*w>t*t||Math.random()>.7)continue;const v=Math.max(1,S-Math.abs(g)-Math.abs(x)+Math.floor(Math.random()*2));for(let z=1;z<=v;z++){const C=z===v&&v>2?.7:.9;let R;z===v&&v>2?R=a.accent:z>v*.6?R=a.main:R=a.dark,r(b,z,w,R,C)}v>=S-1&&Math.random()>.5&&r(b,v+1,w,a.glow,.3),h.set(P,!0)}}const u=this.isCapitol?20:10;for(let d=0;d<u;d++){const f=Math.random()*Math.PI*2,m=.3*t+Math.random()*t*.6,y=Math.round(Math.cos(f)*m),l=Math.round(Math.sin(f)*m),S=`${y},${l}`;if(h.has(S)||y*y+l*l>t*t)continue;const g=1+Math.floor(Math.random()*2);for(let x=1;x<=g;x++){const b=x===g?a.main:a.dark;r(y,x,l,b,.8)}h.set(S,!0)}if(this.isCapitol)for(let f=1;f<=8;f++){const m=f<3?1.2:f>6?.6:.9;r(0,f,0,f===8?a.glow:a.main,m)}}update(t){this.angle+=this.orbitSpeed*t,this.rotation+=this.rotationSpeed*t,this.updatePosition()}updatePosition(){this.x=Math.cos(this.angle)*this.orbitRadius,this.z=Math.sin(this.angle)*this.orbitRadius,this.y=Math.sin(this.angle*2)*Math.sin(this.tilt)*this.orbitRadius*.15}sortVoxelsForReveal(){let t=1/0;for(const s of this.voxels)s.ly<t&&(t=s.ly);for(const s of this.voxels){const a=s.ly-t,e=Math.sqrt(s.lx*s.lx+s.lz*s.lz);s.revealOrder=a*10+e*.5}[...this.voxels].sort((s,a)=>s.revealOrder-a.revealOrder).forEach((s,a)=>s.revealOrder=a)}startReveal(t,i=.02){this.sortVoxelsForReveal();for(const s of this.voxels)s.visible=!0,s.revealTime=t+s.revealOrder*i,s.revealScale=0}hideAll(){for(const t of this.voxels)t.visible=!1,t.revealScale=0}updateReveal(t){for(const i of this.voxels){if(!i.visible)continue;const s=t-i.revealTime;if(s<0){i.revealScale=0;continue}const a=Y.spring(0,1,s,.3,!1,!1,{stiffness:.8,damping:.5});i.revealScale=Math.min(1,a.value)}}getRenderables(t){const i=Math.cos(this.rotation),s=Math.sin(this.rotation);for(const a of this.voxels){if(!a.visible||a.revealScale<=.01)continue;const e=a.lx*i-a.lz*s,r=a.lx*s+a.lz*i,n=-a.ly,o=this.x+e,h=this.y+n,p=this.z+r,u=this.game.camera.project(o,h,p);t.push({type:"voxel",cube:a.cube,x:o,y:h,z:p,depth:u.z,scale:u.scale,revealScale:a.revealScale})}}}class N extends A{constructor(t){super(t),this.backgroundColor=c.style.bgColor}init(){console.log("[Day08] init() called"),super.init(),O.init(this.ctx),this.time=0;const t=Math.min(this.width,this.height);this.scale=t/600,this.camera=new D({perspective:c.camera.perspective*this.scale,rotationX:.3,rotationY:0,autoRotate:!0,autoRotateSpeed:c.camera.autoRotateSpeed,inertia:!0,friction:c.camera.friction,sensitivity:.004}),this.camera.enableMouseControl(this.canvas),this.starfield=[];const i=c.starfield,s=I(i.count,i.radius*this.scale);for(const e of s)this.starfield.push({x:e.x,y:e.y,z:e.z,size:i.minSize+Math.random()*(i.maxSize-i.minSize),twinkleOffset:Math.random()*Math.PI*2,brightness:.3+Math.random()*.7});console.log("[STARFIELD] Created",this.starfield.length,"stars"),this.star=new $(c.star.radius*this.scale,{camera:this.camera,useShader:!0,shaderType:"star",shaderUniforms:{uStarColor:c.star.color,uTemperature:c.star.temperature,uActivityLevel:c.star.activityLevel,uRotationSpeed:c.star.rotationSpeed}}),this.latticeNodes=[];for(const e of c.lattice.layers){const r=I(e.count,e.radius*this.scale);for(const n of r)n.size=e.size,n.layer=e.radius,n.alpha=0,n.revealTime=0;this.latticeNodes.push(...r)}this.latticeRotation=0,this.latticeRevealing=!1,this.stations=[],this.createStations(this.scale),this.ships=[],this.createShips(this.scale),this.createEnergyStreams(this.scale),this.rocket=new L(this);const a=-800*this.scale;this.rocket.setPosition(a,0,0),this.rocket.setHeading(0),this.rocket.visible=!0,this.shipsActive=!1,this.energyParticlesActive=!1,this.latticeVisible=!1;for(const e of this.stations)e.hideAll();this.initStateMachine()}createShips(t){const i=c.lattice.layers[1].radius*t,s=c.stations.orbitRadius*t;for(let a=0;a<c.ships.count;a++){let e=[];const r=a%4;if(r===0){const n=this.stations[Math.floor(Math.random()*this.stations.length)],o=Math.random()*Math.PI*2,h={x:Math.cos(o)*i,y:(Math.random()-.5)*i*.4,z:Math.sin(o)*i};e=[{type:"station",target:n},{type:"space",target:h}]}else if(r===1){const n=this.stations[Math.floor(Math.random()*this.stations.length)];let o=this.stations[Math.floor(Math.random()*this.stations.length)];for(;n===o;)o=this.stations[Math.floor(Math.random()*this.stations.length)];e=[{type:"station",target:n},{type:"station",target:o}]}else if(r===2){const n=this.stations[Math.floor(Math.random()*this.stations.length)],o=this.stations[Math.floor(Math.random()*this.stations.length)],h=Math.random()*Math.PI*2,p={x:Math.cos(h)*s*1.2,y:(Math.random()-.5)*s*.5,z:Math.sin(h)*s*1.2};e=[{type:"station",target:n},{type:"space",target:p},{type:"station",target:o}]}else{const n=this.stations[Math.floor(Math.random()*this.stations.length)],o=Math.random()*Math.PI*2,h={x:Math.cos(o)*i*.5,y:(Math.random()-.5)*i*.2,z:Math.sin(o)*i*.5};e=[{type:"station",target:n},{type:"space",target:h}]}this.ships.push(new F(a,e,c.ships.speed*t*(.8+Math.random()*.4)))}}createStations(t){for(let s=0;s<c.stations.count;s++){const a=s===0;let e;if(a)e=Math.PI*.5;else{const h=s-1,p=c.stations.count-1;e=Math.PI*.5+(h+1)/(p+1)*Math.PI*2}const r=c.stations.orbitRadius*t,n=a?1:.85+Math.random()*.3,o=r*n;this.stations.push(new V(this,s,o,e,a,.025))}}createEnergyStreams(t){const i=a=>{const e=a.age/a.lifetime;a.color.r=Math.round(150+105*e),a.color.g=Math.round(200+0*e),a.color.b=Math.round(255+-155*e)};this.energyParticles=new Z(this,{camera:this.camera,maxParticles:c.streams.particleCount,blendMode:"lighter",depthSort:!0,updaters:[T.velocity,T.lifetime,i,T.fadeOut,T.shrink(.3)]});const s=8;for(let a=0;a<s;a++){const e=a/s*Math.PI*2,r=Math.PI*.5+(Math.random()-.5)*.8,n={x:Math.sin(r)*Math.cos(e),y:Math.cos(r),z:Math.sin(r)*Math.sin(e)},o=c.star.radius*this.scale;this.energyParticles.addEmitter(`stream${a}`,new E({rate:2,position:{x:n.x*o*1.2,y:n.y*o*1.2,z:n.z*o*1.2},velocity:{x:n.x*c.streams.speed*t,y:n.y*c.streams.speed*t,z:n.z*c.streams.speed*t},velocitySpread:{x:15,y:15,z:15},lifetime:{min:1.2,max:2},size:{min:2,max:4},color:c.streams.innerColor,shape:"circle"}))}}startLatticeReveal(t){this.latticeRevealing=!0,this.latticeVisible=!0;for(const h of this.latticeNodes)h.finalX=h.x,h.finalY=h.y,h.finalZ=h.z,h.flightProgress=0,h.flightStarted=!1;const i=[...this.latticeNodes].sort((h,p)=>h.layer!==p.layer?p.layer-h.layer:Math.random()-.5),s=4,a=.08,e=Math.max(...c.lattice.layers.map(h=>h.radius)),r=Math.min(...c.lattice.layers.map(h=>h.radius));let n=null,o=0;i.forEach(h=>{h.layer!==n&&(n=h.layer,o=0);const u=(e-h.layer)/(e-r||1)*s,d=o*a;h.revealTime=t+u+d,o++})}updateLatticeReveal(t){if(!this.latticeRevealing)return;let i=!0;const s=2.5,a=this.stations[0],e=Math.cos(this.latticeRotation),r=Math.sin(this.latticeRotation);for(const n of this.latticeNodes){if(n.flightProgress>=1)continue;const o=t-n.revealTime;if(o<0)n.alpha=0,n.flightProgress=0,n.x=a.x,n.y=a.y,n.z=a.z,i=!1;else{n.flightStarted||(n.flightStarted=!0,n.startX=a.x,n.startY=a.y,n.startZ=a.z);const h=n.finalX*e-n.finalZ*r,p=n.finalX*r+n.finalZ*e,u=n.finalY,d=Math.min(1,o/s),f=d*d*(3-2*d);n.flightProgress=d,n.x=n.startX+(h-n.startX)*f,n.y=n.startY+(u-n.startY)*f,n.z=n.startZ+(p-n.startZ)*f,n.alpha=Math.min(1,d*2),n.flightProgress<1&&(i=!1)}}i&&(this.latticeRevealing=!1)}updateConstructorShips(){if(!(!this.constructorShips||!this.constructorSpawningStarted)){if(this.nextConstructorSpawn<this.constructorShips.length&&this.time>=this.nextConstructorSpawnTime){const t=this.constructorShips[this.nextConstructorSpawn],i=this.ships[t.shipIndex],s=this.stations[0];i.route=[{type:"station",target:s},{type:"station",target:t.annex}],i.routeIndex=1,i.speed=c.ships.constructorSpeed*this.scale,i.spawn(s.x,s.y,s.z),console.log(`[FORGE STAR] Constructor ship ${this.nextConstructorSpawn} launched to Annex ${t.annexIndex}`),this.nextConstructorSpawn++,this.nextConstructorSpawnTime=this.time+c.reveal.annexStagger}for(const t of this.constructorShips){if(t.triggered)continue;const i=this.ships[t.shipIndex];if(i.active&&i.state==="orbit"&&i.routeIndex===1&&(t.arrived=!0,!t.triggered)){t.triggered=!0,console.log(`[FORGE STAR] Constructor arrived - building Annex ${t.annexIndex}`),t.annex.startReveal(this.time,c.reveal.staggerDelay),this.annexesBuilt=(this.annexesBuilt||0)+1;const s=(t.annexIndex-1)*this.voxelsPerAnnex,a=Math.min(s+this.voxelsPerAnnex,this.remainingShipVoxels.length);for(let e=s;e<a;e++)this.remainingShipVoxels[e]&&(this.remainingShipVoxels[e].alpha=0);this.nextConstructorSpawn>=this.constructorShips.length&&(this.nextShipSpawnTime=this.time+c.reveal.shipSpawnInterval)}}}}initStateMachine(){this.phaseTime=0;const t=this.stations[0];this.capitolOrbit={radius:t.orbitRadius,angle:t.angle};const i=t.orbitRadius*.85;this.shipOrbit={x:0,y:i*.9,z:i*.4},this.shipPath={startX:-350*this.scale,startY:50*this.scale,startZ:200*this.scale,endX:this.shipOrbit.x,endY:this.shipOrbit.y,endZ:this.shipOrbit.z},this.sceneFSM=G.fromSequence([{name:"intro",duration:c.phases.intro,enter:()=>{console.log("[FORGE STAR] Phase: INTRO"),this.phaseTime=0,this.rocket.visible=!1,this.wormhole=null,this.camera.autoRotateSpeed=c.camera.autoRotateSpeed*.2},update:s=>{this.phaseTime+=s}},{name:"arrival",duration:c.phases.arrival,enter:()=>{console.log("[FORGE STAR] Phase: ARRIVAL"),this.phaseTime=0,this.camera.autoRotateSpeed=c.camera.autoRotateSpeed*.3,this.rocket.visible=!1,this.wormhole={x:this.shipPath.startX,y:-this.shipPath.startY,z:this.shipPath.startZ,alpha:0,scale:0,rotation:0,active:!0,spawnTime:c.wormhole.spawnTime,particles:[]};const s=c.wormhole.particleCount;for(let a=0;a<s;a++){const e=a/s*Math.PI*2*3,r=a/s*c.wormhole.radius*this.scale;this.wormhole.particles.push({angle:e,dist:r,speed:.5+Math.random()*1.5,size:1+Math.random()*2})}},update:s=>{this.phaseTime+=s;const a=c.phases.arrival,e=c.wormhole.spawnTime;if(this.wormhole&&this.wormhole.active){this.wormhole.rotation+=c.wormhole.rotationSpeed*s;const g=this.phaseTime/a,x=Math.min(1,this.phaseTime/e);if(x<1){const b=x,w=Math.sin(b*Math.PI*1.5)*.2*(1-b);this.wormhole.scale=b+w,this.wormhole.alpha=b}else{this.wormhole.scale=1,this.rocket.visible||(this.rocket.visible=!0);const b=c.wormhole.fadeOutStart,w=c.wormhole.fadeOutEnd;g<b?this.wormhole.alpha=1:g>w?(this.wormhole.alpha=0,this.wormhole.active=!1):this.wormhole.alpha=1-(g-b)/(w-b)}for(const b of this.wormhole.particles)b.angle+=b.speed*s}const r=Math.max(0,this.phaseTime-e),n=a-e,o=Math.min(1,r/(n*.85)),h=X.easeInOutCubic(o),p=this.shipPath.startX+(this.shipPath.endX-this.shipPath.startX)*h,u=this.shipPath.startZ+(this.shipPath.endZ-this.shipPath.startZ)*h,d=this.shipPath.startY+(this.shipPath.endY-this.shipPath.startY)*h,f=Math.sin(h*Math.PI)*this.shipOrbit.y*.3,m=-(d+f);this.rocket.setPosition(p,m,u);const y=this.shipPath.endX-this.shipPath.startX,l=this.shipPath.endZ-this.shipPath.startZ,S=Math.atan2(l,y);this.rocket.setHeading(S)}},{name:"deployment",duration:c.phases.deployment,enter:()=>{console.log("[FORGE STAR] Phase: DEPLOYMENT"),this.phaseTime=0,this.rocket.setPosition(this.shipOrbit.x,-this.shipOrbit.y,this.shipOrbit.z),this.rocket.setHeading(Math.PI/2);const s=this.stations[0];this.rocket.setCapitolTarget(s.x,s.y,s.z)},update:s=>{this.phaseTime+=s;const a=this.phaseTime/c.phases.deployment;this.rocket.setPosition(this.shipOrbit.x,-this.shipOrbit.y,this.shipOrbit.z),this.rocket.setHeading(Math.PI/2);const e=this.stations[0];this.rocket.setCapitolTarget(e.x,e.y,e.z),a<.5?this.rocket.deployPanels(a*2):(this.rocket.deployPanels(1),this.rocket.separateSatellites((a-.5)*2))}},{name:"capitol",duration:c.phases.capitol,enter:()=>{console.log("[FORGE STAR] Phase: CAPITOL"),this.phaseTime=0;const s=this.stations[0],a=s.voxels.length*c.reveal.staggerDelay+.5;this.capitolRevealDuration=a,this.capitolRevealStartTime=this.time,this.rocket.startDisassembly(this.time,a),s.startReveal(this.time,c.reveal.staggerDelay),this.startLatticeReveal(this.time);const e=this.stations.length-1;this.constructorShips=[],this.nextConstructorSpawn=0,this.constructorSpawningStarted=!1;for(let r=0;r<e;r++){const n=this.stations[r+1];this.constructorShips.push({shipIndex:r,annexIndex:r+1,annex:n,arrived:!1,triggered:!1})}this.remainingShipVoxels=this.rocket.voxels.filter(r=>r.alpha>0),this.voxelsPerAnnex=Math.ceil(this.remainingShipVoxels.length/e),this.shipsActive=!0,this.nextShipToSpawn=e,this.nextShipSpawnTime=1/0,this.annexesBuilt=0,this.camera.autoRotateSpeed=c.camera.autoRotateSpeed*.6},update:s=>{this.phaseTime+=s,this.rocket.updateDisassembly(this.time),this.stations[0].updateReveal(this.time),this.updateLatticeReveal(this.time),(this.time-this.capitolRevealStartTime)/this.capitolRevealDuration>=.5&&!this.constructorSpawningStarted&&(this.constructorSpawningStarted=!0,this.nextConstructorSpawnTime=this.time,console.log("[FORGE STAR] Capitol at 50% - starting constructor ships")),this.updateConstructorShips()}},{name:"empire",duration:null,enter:()=>{console.log("[FORGE STAR] Phase: EMPIRE"),this.phaseTime=0,this.constructorSpawningStarted||(this.constructorSpawningStarted=!0,this.nextConstructorSpawnTime=this.time),this.energyParticlesActive=!1,this.annexesBuilt=this.annexesBuilt||0,this.empireComplete=!1,this.starTransitionStartTime=null,this.camera.autoRotateSpeed=c.camera.autoRotateSpeed},update:s=>{this.phaseTime+=s;for(const e of this.stations)e.updateReveal(this.time);this.updateConstructorShips();const a=this.stations.length-1;if(this.annexesBuilt>=a&&this.nextShipToSpawn<this.ships.length&&this.time>=this.nextShipSpawnTime){const e=this.stations[0];this.ships[this.nextShipToSpawn].spawn(e.x,e.y,e.z),this.nextShipToSpawn++,this.nextShipSpawnTime=this.time+c.reveal.shipSpawnInterval}if(!this.energyParticlesActive&&this.annexesBuilt>=a-1){console.log("[FORGE STAR] Energy harvesting begins"),this.energyParticlesActive=!0,this.pipeline.add(this.energyParticles);for(const[e,r]of Object.entries(this.energyParticles.emitters))r.active=!0}if(!this.empireComplete&&this.annexesBuilt>=a&&this.nextShipToSpawn>=this.ships.length&&(console.log("[FORGE STAR] Empire complete - star transforms"),this.empireComplete=!0,this.starTransitionStartTime=this.time),this.empireComplete){const r=this.time-this.starTransitionStartTime,n=Math.min(1,r/5),o=.6+(.7-.6)*n,h=.8+(.3-.8)*n,p=1;this.starColor={r:o,g:h,b:p},this.star&&this.star.setShaderUniforms&&this.star.setShaderUniforms({uStarColor:[o,h,p],uTime:this.time})}this.updateLatticeReveal(this.time)}}],{context:this,loop:!1})}update(t){if(super.update(t),this.time+=t,this.camera.update(t),this.sceneFSM.update(t),this.latticeRotation+=c.lattice.rotationSpeed*t,this.rocket&&this.rocket.visible&&this.rocket.update(t),this.shipsActive)for(const i of this.ships)i.active&&i.update(t);for(const i of this.stations)i.update(t);this.star&&this.star.setShaderUniforms&&this.star.setShaderUniforms({uTime:this.time})}render(){const t=this.ctx,i=this.width,s=this.height,a=i/2,e=s/2;t.fillStyle=`rgba(0, 0, 0, ${c.style.trailAlpha})`,t.fillRect(0,0,i,s);const r=[];for(const o of this.stations)o.getRenderables(r);this.rocket&&this.rocket.visible&&this.rocket.getRenderables(r);const n=this.camera.project(0,0,0);if(r.push({type:"star",x:n.x,y:n.y,z:n.z,scale:n.scale,depth:n.z}),this.wormhole&&this.wormhole.active&&this.wormhole.alpha>0){const o=this.camera.project(this.wormhole.x,this.wormhole.y,this.wormhole.z);r.push({type:"wormhole",x:o.x,y:o.y,z:o.z,scale:o.scale,depth:o.z,alpha:this.wormhole.alpha,spawnScale:this.wormhole.scale,rotation:this.wormhole.rotation,particles:this.wormhole.particles})}if(this.shipsActive)for(const o of this.ships){if(!o.active)continue;const h=this.camera.project(o.x,o.y,o.z);r.push({type:"ship",x:h.x,y:h.y,z:h.z,scale:h.scale,depth:h.z,angle:o.angle,trail:o.trail.map(p=>{const u=this.camera.project(p.x,p.y,p.z);return{x:u.x,y:u.y}})})}if(this.latticeVisible)for(const o of this.latticeNodes){if(o.alpha<=0)continue;let h,p,u;if(o.flightProgress<1)h=o.x,u=o.y,p=o.z;else{const f=Math.cos(this.latticeRotation),m=Math.sin(this.latticeRotation);h=o.finalX*f-o.finalZ*m,p=o.finalX*m+o.finalZ*f,u=o.finalY}const d=this.camera.project(h,u,p);r.push({type:"latticeNode",x:d.x,y:d.y,z:d.z,scale:d.scale,depth:d.z,nodeSize:o.size,alpha:o.alpha})}if(r.sort((o,h)=>h.depth-o.depth),super.render(),this.starfield&&this.starfield.length>0){t.save(),t.translate(a,e),t.fillStyle="#ffffff";for(const o of this.starfield){const h=this.camera.project(o.x,o.y,o.z);if(h.scale<=0)continue;const p=.5+.5*Math.sin(this.time*c.starfield.twinkleSpeed+o.twinkleOffset);t.globalAlpha=o.brightness*p,t.beginPath(),t.arc(h.x,h.y,o.size,0,Math.PI*2),t.fill()}t.globalAlpha=1,t.restore()}t.save(),t.translate(a,e);for(const o of r)if(!(o.scale<=0))switch(o.type){case"latticeNode":this.drawLatticeNode(t,o);break;case"ship":this.drawShipWithTrail(t,o);break;case"voxel":if(o.cube){o.cube.x=o.x,o.cube.y=o.y,o.cube.z=o.z;const h=o.revealScale!==void 0&&o.revealScale<1,p=o.alpha!==void 0&&o.alpha<1;if(h||p){if(t.save(),p&&(t.globalAlpha=Math.max(0,o.alpha)),h){const u=this.camera.project(o.x,o.y,o.z);t.translate(u.x,u.y),t.scale(o.revealScale,o.revealScale),t.translate(-u.x,-u.y)}o.cube.draw(),t.restore()}else o.cube.draw()}break;case"star":this.drawStarItem(t,o);break;case"wormhole":this.drawWormhole(t,o);break}t.restore()}drawWormhole(t,i){const s=i.spawnScale||1,a=c.wormhole.radius*this.scale*i.scale*s,e=c.wormhole.colors,r=c.wormhole.ringCount;t.save(),t.translate(i.x,i.y),t.globalAlpha=i.alpha,t.globalCompositeOperation="lighter";const n=t.createRadialGradient(0,0,a*.5,0,0,a*2);n.addColorStop(0,"rgba(68, 136, 255, 0.3)"),n.addColorStop(.5,"rgba(170, 136, 255, 0.15)"),n.addColorStop(1,"transparent"),t.fillStyle=n,t.beginPath(),t.arc(0,0,a*2,0,Math.PI*2),t.fill();for(let h=0;h<r;h++){const p=a*(.3+h/r*.7),u=i.rotation*(h%2===0?1:-.7)+h*Math.PI/r,d=.6-h/r*.3;t.save(),t.rotate(u);const f=8,m=.3;for(let y=0;y<f;y++){const l=y/f*Math.PI*2,S=l+Math.PI*2/f*(1-m);t.strokeStyle=h<r/2?e.inner:e.outer,t.lineWidth=2+(r-h)*.5,t.globalAlpha=i.alpha*d,t.beginPath(),t.arc(0,0,p,l,S),t.stroke()}t.restore()}t.globalAlpha=i.alpha*.8,t.fillStyle=e.particles;for(const h of i.particles){const p=Math.cos(h.angle)*h.dist,u=Math.sin(h.angle)*h.dist;t.beginPath(),t.arc(p,u,h.size*i.scale,0,Math.PI*2),t.fill()}const o=t.createRadialGradient(0,0,0,0,0,a*.4);o.addColorStop(0,"rgba(255, 255, 255, 0.9)"),o.addColorStop(.3,"rgba(200, 180, 255, 0.6)"),o.addColorStop(.7,"rgba(136, 100, 255, 0.3)"),o.addColorStop(1,"transparent"),t.globalAlpha=i.alpha,t.fillStyle=o,t.beginPath(),t.arc(0,0,a*.4,0,Math.PI*2),t.fill(),t.restore()}drawStarItem(t,i){const s=i.x,a=i.y,e=c.star.radius*this.scale*i.scale,r=this.time||0,n=this.starColor||{r:.6,g:.8,b:1},o=Math.floor(n.r*255),h=Math.floor(n.g*255),p=Math.floor(n.b*255),u=1+Math.sin(r*2)*.05+Math.sin(r*3.7)*.03;t.save(),t.globalCompositeOperation="lighter";const d=e*4*u,f=t.createRadialGradient(s,a,e*.5,s,a,d);f.addColorStop(0,`rgba(${o+50}, ${h+50}, ${p}, 0.15)`),f.addColorStop(.3,`rgba(${o}, ${h}, ${p}, 0.08)`),f.addColorStop(.6,`rgba(${Math.floor(o*.7)}, ${Math.floor(h*.7)}, ${p}, 0.03)`),f.addColorStop(1,"transparent"),t.fillStyle=f,t.beginPath(),t.arc(s,a,d,0,Math.PI*2),t.fill();const m=12;for(let w=0;w<m;w++){const P=w/m*Math.PI*2+r*.1,v=e*(1.5+Math.sin(r*2+w)*.5)*u,z=e*.15;t.save(),t.translate(s,a),t.rotate(P);const C=t.createLinearGradient(e*.8,0,e+v,0);C.addColorStop(0,`rgba(${o+80}, ${h+60}, ${p}, 0.4)`),C.addColorStop(.3,`rgba(${o+30}, ${h+30}, ${p}, 0.2)`),C.addColorStop(1,"transparent"),t.fillStyle=C,t.beginPath(),t.moveTo(e*.8,0),t.lineTo(e+v,-z*.3),t.lineTo(e+v,z*.3),t.closePath(),t.fill(),t.restore()}const y=e*2*u,l=t.createRadialGradient(s,a,0,s,a,y);l.addColorStop(0,`rgba(${o+100}, ${h+80}, ${p}, 0.5)`),l.addColorStop(.2,`rgba(${o+50}, ${h+50}, ${p}, 0.35)`),l.addColorStop(.5,`rgba(${o}, ${h}, ${p}, 0.15)`),l.addColorStop(1,"transparent"),t.fillStyle=l,t.beginPath(),t.arc(s,a,y,0,Math.PI*2),t.fill();const S=e*1.1,g=t.createRadialGradient(s,a,0,s,a,S);g.addColorStop(0,"rgba(255, 255, 255, 1)"),g.addColorStop(.3,`rgba(${o+100}, ${h+80}, ${p}, 0.95)`),g.addColorStop(.6,`rgba(${o+50}, ${h+50}, ${p}, 0.8)`),g.addColorStop(.85,`rgba(${o}, ${h}, ${p}, 0.6)`),g.addColorStop(1,`rgba(${Math.floor(o*.6)}, ${Math.floor(h*.6)}, ${p}, 0.3)`),t.fillStyle=g,t.beginPath(),t.arc(s,a,S,0,Math.PI*2),t.fill();const x=e*.4,b=t.createRadialGradient(s,a,0,s,a,x);b.addColorStop(0,"rgba(255, 255, 255, 1)"),b.addColorStop(.5,"rgba(255, 255, 255, 0.8)"),b.addColorStop(1,"rgba(230, 245, 255, 0.4)"),t.fillStyle=b,t.beginPath(),t.arc(s,a,x,0,Math.PI*2),t.fill(),t.restore(),this.star&&(t.save(),t.globalAlpha=.6,t.translate(s,a),t.scale(i.scale,i.scale),this.star.x=0,this.star.y=0,this.star.z=0,this.star.draw(),t.restore())}drawLatticeNode(t,i){const s=(i.nodeSize||c.lattice.nodeSize)*i.scale,a=i.alpha!==void 0?i.alpha:1;if(a<=0)return;t.save(),t.globalAlpha=a;const e=t.createRadialGradient(i.x,i.y,0,i.x,i.y,s*3);e.addColorStop(0,"rgba(100, 170, 255, 0.5)"),e.addColorStop(.4,"rgba(100, 170, 255, 0.15)"),e.addColorStop(1,"transparent"),t.fillStyle=e,t.beginPath(),t.arc(i.x,i.y,s*3,0,Math.PI*2),t.fill(),t.fillStyle=c.lattice.color,t.beginPath(),t.arc(i.x,i.y,s,0,Math.PI*2),t.fill(),t.restore()}drawShipWithTrail(t,i){if(i.trail.length>1){t.beginPath(),t.moveTo(i.trail[0].x,i.trail[0].y);for(let s=1;s<i.trail.length;s++)t.lineTo(i.trail[s].x,i.trail[s].y);t.strokeStyle=c.ships.trailColor,t.lineWidth=1.5,t.stroke()}j(t,i.x,i.y,c.ships.size*i.scale,i.angle)}}function B(M){console.log("[Day08] Initializing Forge Star...",M);const t=new N(M);return console.log("[Day08] Game created, starting..."),t.start(),console.log("[Day08] Game started"),{stop:()=>t.stop(),game:t}}export{B as default};
