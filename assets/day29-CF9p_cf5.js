import{G as lt,d as ct,P as ft,e as dt,T as G,E as mt}from"./index-B0ivFyqO.js";const gt=["Alpha","Beta","Gamma","Delta","Epsilon","Zeta","Eta","Theta","Iota","Kappa","Lambda","Mu","Nu","Xi","Omicron","Pi","Rho","Sigma","Tau","Upsilon","Phi","Chi","Psi","Omega"],L=["#ff2060","#ff6020","#ffaa00","#ff00ff","#ff0080","#aa00ff","#6020ff","#ff4080","#ff8000","#ff0040"],c={gridWidth:60,gridHeight:40,agentCount:100,initialVaccinatedPercent:.25,moveDelay:4,wanderSteps:{min:10,max:20},incubationTime:{min:50,max:100},infectionTime:{min:100,max:200},recoveryChance:.3,deathChance:.1,transmissionRate:.15,roomTransmissionBonus:2,vaccineEfficacy:.95,mutationChanceOnVaccinated:.005,mutationTransmissionBoost:1.4,mutationTransmissionRandomness:.15,mutationVaccineResistanceBoost:.2,mutationResistanceRandomness:.1,maxVariants:10,newAgentInterval:60,newAgentCount:10,colors:{wall:"#353545",hospitalWall:"#40e0e0",agent:"#00ff80",vaccinated:"#00ffff",exposed:"#ffcc00",infected:"#ff2060",recovered:"#4080ff"},trailAlpha:.12,pulseSpeed:3,variantFlashDuration:2.5,variantFlashFadeStart:1.5,historyInterval:.5,maxHistoryPoints:200};function pt(m,t){const e=[],s=(y,v)=>Math.floor(Math.random()*(v-y+1))+y;let i=[];for(let y=0;y<t;y++){i.push([]);for(let v=0;v<m;v++)v===0||v===m-1||y===0||y===t-1?i[y].push({type:"wall"}):i[y].push({type:"floor"})}const o=(y,v,w,C,ot)=>{for(let S=v-1;S<=v+C;S++)for(let b=y-1;b<=y+w;b++){const at=S===v-1,nt=S===v+C,ht=b===y-1,rt=b===y+w;at||nt||ht||rt?i[S][b]={type:"room_wall"}:i[S][b]={type:"room_floor"}}let R,T;const _=y+Math.floor(w/2),$=v+Math.floor(C/2);switch(ot){case"top":R=_,T=v-1;break;case"bottom":R=_,T=v+C;break;case"left":R=y-1,T=$;break;case"right":R=y+w,T=$;break}return i[T][R]={type:"door"},{x:y,y:v,width:w,height:C,doorX:R,doorY:T}},a=10,d=Math.floor(m/2),r=Math.floor(t/2),l=d-Math.floor(a/2),n=r-Math.floor(a/2),h=o(l,n,a,a,"top");h.isHospital=!0,e.push(h);const f=5,g=l+Math.floor(a/2),M=4,u=m-g-(g-M),p=Math.min(M,u),x=s(5,7),k=s(3,5),H=Math.floor(m/2)-Math.floor(x/2),Y=n-f-k;Y>2&&e.push(o(H,Y,x,k,"bottom"));const A=s(5,7),D=s(3,5),U=Math.floor(m/2)-Math.floor(A/2),F=n+a+f;F+D<t-2&&e.push(o(U,F,A,D,"top"));const W=p,j=s(4,6),K=s(4,5);e.push(o(W,p,j,K,"right"));const q=s(4,6),O=s(5,7),Q=Math.floor(t/2)-Math.floor(O/2);e.push(o(W,Q,q,O,"right"));const Z=s(4,6),B=s(4,5);e.push(o(W,t-p-B-1,Z,B,"right"));const V=s(4,6),J=s(4,5),tt=m-p-1-V;e.push(o(tt,p,V,J,"left"));const P=s(4,6),I=s(5,7),it=Math.floor(t/2)-Math.floor(I/2),et=m-p-1-P;e.push(o(et,it,P,I,"left"));const E=s(4,6),N=s(4,5),st=m-p-1-E;return e.push(o(st,t-p-N-1,E,N,"left")),{grid:i,rooms:e}}function ut(m,t){const e=t.find(f=>f.isHospital);if(!e)return null;m[0].length,m.length;for(let f=e.y-1;f<=e.y+e.height;f++)for(let g=e.x-1;g<=e.x+e.width;g++)m[f]&&m[f][g]&&(m[f][g].type==="room_wall"||m[f][g].type==="door")&&(m[f][g].type="hospital_wall");const s=1,i=e.y-1-s,o=e.y+e.height+s,a=e.x-1-s,d=e.x+e.width+s,r=e.x+Math.floor(e.width/2),l=e.y+Math.floor(e.height/2),n=r,h=l;for(let f=a;f<=d;f++)if(f>=0&&f<m[0].length){if(f===n)continue;i>=0&&i<m.length&&m[i][f].type==="floor"&&(m[i][f].type="hospital_wall"),o>=0&&o<m.length&&m[o][f].type==="floor"&&(m[o][f].type="hospital_wall")}for(let f=i;f<=o;f++)if(f>=0&&f<m.length){if(f===h)continue;a>=0&&a<m[0].length&&m[f][a].type==="floor"&&(m[f][a].type="hospital_wall"),d>=0&&d<m[0].length&&m[f][d].type==="floor"&&(m[f][d].type="hospital_wall")}return e.y-1>=0&&n>=0&&n<m[0].length&&(m[e.y-1][n].type="door"),e.y+e.height<m.length&&n>=0&&n<m[0].length&&(m[e.y+e.height][n].type="door"),h>=0&&h<m.length&&e.x-1>=0&&(m[h][e.x-1].type="door"),h>=0&&h<m.length&&e.x+e.width<m[0].length&&(m[h][e.x+e.width].type="door"),e.doors=[{x:n,y:e.y-1},{x:n,y:e.y+e.height},{x:e.x-1,y:h},{x:e.x+e.width,y:h}],e}class z{constructor(t,e=null){if(this.index=t,this.name=gt[t]||`Variant-${t}`,this.parent=e,this.generation=e?e.generation+1:0,e){const s=c.mutationTransmissionBoost*(1+(Math.random()-.5)*c.mutationTransmissionRandomness*2);this.transmissionMultiplier=e.transmissionMultiplier*s;const i=c.mutationVaccineResistanceBoost*(1+(Math.random()-.5)*c.mutationResistanceRandomness*2);this.vaccineResistance=Math.min(.95,e.vaccineResistance+i)}else this.transmissionMultiplier=1,this.vaccineResistance=0;this.color=L[t%L.length],this.infectionCount=0,this.emergeTime=0,this.emergeX=0,this.emergeY=0}}class X{constructor(t,e,s,i,o){this.x=t,this.y=e,this.grid=s,this.rooms=i,this.hospital=o,this.gridHeight=s.length,this.gridWidth=s[0].length,this.state="roaming",this.targetRoom=null,this.targetX=t,this.targetY=e,this.roamTargetX=t,this.roamTargetY=e,this.stepsRemaining=0,this.waitFrames=0,this.stuckCounter=0,this.moveTimer=Math.floor(Math.random()*c.moveDelay),this.healthState="susceptible",this.diseaseTimer=0,this.variant=null,this.deathFlash=0,this.lastRoom=null,this.roamTimeRemaining=0,this.dirX=0,this.dirY=0,this.dirSteps=0,this.posHistory=[],this.globalStuckCounter=0}update(){if(this.moveTimer++,!(this.moveTimer<c.moveDelay)){if(this.moveTimer=0,this.waitFrames>0){this.waitFrames--;return}if(this.posHistory.push({x:this.x,y:this.y}),this.posHistory.length>20&&this.posHistory.shift(),this.posHistory.length>=20){const t=Math.min(...this.posHistory.map(a=>a.x)),e=Math.max(...this.posHistory.map(a=>a.x)),s=Math.min(...this.posHistory.map(a=>a.y)),i=Math.max(...this.posHistory.map(a=>a.y));if(e-t+(i-s)<=4){if(this.globalStuckCounter++,this.globalStuckCounter>5){this.teleportToRandomFloor();return}}else this.globalStuckCounter=0}if(this.updateDisease(),this.healthState!=="dead")switch(this.state){case"roaming":this.roam();break;case"goingToDoor":this.goToDoor();break;case"enteringRoom":this.enterRoom();break;case"inRoom":this.wanderInRoom();break;case"exitingRoom":this.exitRoom();break}}}updateDisease(){this.healthState==="exposed"?(this.diseaseTimer--,this.diseaseTimer<=0&&(this.healthState="infected",this.diseaseTimer=c.infectionTime.min+Math.floor(Math.random()*(c.infectionTime.max-c.infectionTime.min)))):this.healthState==="infected"&&(this.diseaseTimer--,this.diseaseTimer<=0&&(Math.random()<c.deathChance?(this.healthState="dead",this.deathFlash=1,this.justDied=!0):Math.random()<c.recoveryChance?this.healthState="recovered":this.diseaseTimer=c.infectionTime.min+Math.floor(Math.random()*(c.infectionTime.max-c.infectionTime.min))))}teleportToRandomFloor(){for(let t=0;t<50;t++){const e=Math.floor(Math.random()*this.gridWidth),s=Math.floor(Math.random()*this.gridHeight);if(this.grid[s][e].type==="floor"){this.x=e,this.y=s,this.state="roaming",this.targetRoom=null,this.lastRoom=null,this.roamTimeRemaining=10,this.posHistory=[],this.globalStuckCounter=0,this.stuckCounter=0,this.dirSteps=0;return}}}roam(){if(this.roamTimeRemaining>0&&this.roamTimeRemaining--,this.randomWalk(),Math.random()<.05&&(this.waitFrames=Math.floor(Math.random()*3)+1),this.roamTimeRemaining<=0&&Math.random()<.03&&this.rooms.length>0){const t=this.rooms.filter(e=>e!==this.lastRoom);t.length>0&&(this.targetRoom=t[Math.floor(Math.random()*t.length)],this.stuckCounter=0,this.state="goingToDoor")}}randomWalk(){if(this.dirSteps>0){const s=this.x+this.dirX,i=this.y+this.dirY;if(s>=0&&s<this.gridWidth&&i>=0&&i<this.gridHeight){const o=this.grid[i][s];if(o.type==="floor"||o.type==="door"){this.x=s,this.y=i,this.dirSteps--;return}}this.dirSteps=0}const e=[{dx:1,dy:0},{dx:-1,dy:0},{dx:0,dy:1},{dx:0,dy:-1}].map(s=>{const i=this.x+s.dx,o=this.y+s.dy;let a=Math.random()*2;if(i>=0&&i<this.gridWidth&&o>=0&&o<this.gridHeight){const d=this.grid[o][i];if(d.type==="floor"||d.type==="door"){for(let l=o-1;l<=o+1;l++)for(let n=i-1;n<=i+1;n++)if(n>=0&&n<this.gridWidth&&l>=0&&l<this.gridHeight){const h=this.grid[l][n];(h.type==="wall"||h.type==="room_wall"||h.type==="hospital_wall")&&(a+=1.5)}return Math.min(i,o,this.gridWidth-i,this.gridHeight-o)<8&&(a+=2),{dir:s,score:a,valid:!0}}}return{dir:s,score:-1,valid:!1}});e.sort((s,i)=>i.score-s.score);for(const{dir:s,valid:i}of e){if(!i)continue;const o=this.x+s.dx,a=this.y+s.dy;this.x=o,this.y=a,this.dirX=s.dx,this.dirY=s.dy,this.dirSteps=8+Math.floor(Math.random()*15);return}}goToDoor(){if(!this.targetRoom){this.state="roaming";return}let t,e;if(this.targetRoom.doors&&this.targetRoom.doors.length>0){let i=1/0;for(const o of this.targetRoom.doors){const a=Math.abs(o.x-this.x)+Math.abs(o.y-this.y);a<i&&(i=a,t=o.x,e=o.y)}}else t=this.targetRoom.doorX,e=this.targetRoom.doorY;if(Math.abs(t-this.x)+Math.abs(e-this.y)<=1){this.x=t,this.y=e,this.state="enteringRoom",this.targetX=this.targetRoom.x+Math.floor(Math.random()*this.targetRoom.width),this.targetY=this.targetRoom.y+Math.floor(Math.random()*this.targetRoom.height),this.stuckCounter=0;return}if(this.stuckCounter>20){this.state="roaming",this.targetRoom=null,this.stuckCounter=0,this.roamTimeRemaining=10;return}this.smartMove(t,e)}enterRoom(){if(!this.targetRoom){this.state="roaming";return}if(this.checkHospital(),Math.abs(this.targetX-this.x)+Math.abs(this.targetY-this.y)===0){this.state="inRoom",this.stepsRemaining=c.wanderSteps.min+Math.floor(Math.random()*(c.wanderSteps.max-c.wanderSteps.min));return}if(this.stuckCounter>10){this.state="inRoom",this.stepsRemaining=c.wanderSteps.min+Math.floor(Math.random()*(c.wanderSteps.max-c.wanderSteps.min)),this.stuckCounter=0;return}this.smartMove(this.targetX,this.targetY)}checkHospital(){if(this.targetRoom&&this.targetRoom.isHospital){if(this.healthState==="infected")return this.healthState="recovered",!0;if(this.healthState==="susceptible")return this.healthState="vaccinated",!0}return!1}wanderInRoom(){if(this.stepsRemaining--,this.checkHospital(),this.stepsRemaining<=0){this.state="exitingRoom",this.stuckCounter=0;return}if(Math.random()<.1){this.waitFrames=Math.floor(Math.random()*3)+1;return}const t=this.targetRoom;if(!t){this.state="roaming";return}const e=[{dx:1,dy:0},{dx:-1,dy:0},{dx:0,dy:1},{dx:0,dy:-1},{dx:0,dy:0}],s=e[Math.floor(Math.random()*e.length)],i=this.x+s.dx,o=this.y+s.dy;this.canMove(i,o)&&i>=t.x&&i<t.x+t.width&&o>=t.y&&o<t.y+t.height&&(this.x=i,this.y=o)}exitRoom(){const t=this.targetRoom;if(!t){this.state="roaming";return}let e,s;if(t.doors&&t.doors.length>0){let r=1/0;for(const l of t.doors){const n=Math.abs(l.x-this.x)+Math.abs(l.y-this.y);n<r&&(r=n,e=l.x,s=l.y)}}else e=t.doorX,s=t.doorY;if(Math.abs(e-this.x)+Math.abs(s-this.y)<=1){this.x=e,this.y=s;const r=[{dx:0,dy:-1},{dx:0,dy:1},{dx:-1,dy:0},{dx:1,dy:0}];for(const l of r){const n=e+l.dx,h=s+l.dy;if(this.canMove(n,h)){const f=n<t.x-1||n>t.x+t.width,g=h<t.y-1||h>t.y+t.height;if(f||g){this.x=n,this.y=h;break}}}this.lastRoom=t,this.targetRoom=null,this.roamTimeRemaining=15+Math.floor(Math.random()*20),this.state="roaming";return}const o=e-this.x,a=s-this.y;let d=!1;if(Math.abs(o)>=Math.abs(a)&&o!==0){const r=this.x+(o>0?1:-1);this.canMove(r,this.y)&&(this.x=r,d=!0)}if(!d&&a!==0){const r=this.y+(a>0?1:-1);this.canMove(this.x,r)&&(this.y=r,d=!0)}if(!d&&o!==0){const r=this.x+(o>0?1:-1);this.canMove(r,this.y)&&(this.x=r,d=!0)}if(d?this.stuckCounter=0:this.stuckCounter++,this.stuckCounter>10){const r=[{dx:0,dy:-1},{dx:0,dy:1},{dx:-1,dy:0},{dx:1,dy:0}];for(const l of r){const n=e+l.dx,h=s+l.dy;if(this.canMove(n,h)){const f=n<t.x-1||n>t.x+t.width,g=h<t.y-1||h>t.y+t.height;if(f||g){this.x=n,this.y=h,this.lastRoom=t,this.targetRoom=null,this.roamTimeRemaining=15+Math.floor(Math.random()*20),this.state="roaming",this.stuckCounter=0;return}}}this.x=e,this.y=s,this.stuckCounter=0}}smartMove(t,e){const s=t-this.x,i=e-this.y,o=this.x,a=this.y;let d=!1;const r=[];s>0&&r.push({dx:1,dy:0,priority:Math.abs(s)}),s<0&&r.push({dx:-1,dy:0,priority:Math.abs(s)}),i>0&&r.push({dx:0,dy:1,priority:Math.abs(i)}),i<0&&r.push({dx:0,dy:-1,priority:Math.abs(i)}),r.sort((l,n)=>n.priority-l.priority);for(const l of r){const n=this.x+l.dx,h=this.y+l.dy;if(this.canMove(n,h)){this.x=n,this.y=h,d=!0;break}}if(!d){const l=[];s!==0&&(l.push({dx:0,dy:1}),l.push({dx:0,dy:-1})),i!==0&&(l.push({dx:1,dy:0}),l.push({dx:-1,dy:0}));for(let n=l.length-1;n>0;n--){const h=Math.floor(Math.random()*(n+1));[l[n],l[h]]=[l[h],l[n]]}for(const n of l){const h=this.x+n.dx,f=this.y+n.dy;if(this.canMove(h,f)){this.x=h,this.y=f,d=!0;break}}}this.x===o&&this.y===a?this.stuckCounter++:this.stuckCounter=0}canMove(t,e){if(t<0||t>=this.gridWidth||e<0||e>=this.gridHeight)return!1;const s=this.grid[e][t];return s.type==="floor"||s.type==="room_floor"||s.type==="door"}}class yt extends lt{constructor(t){super(t),this.backgroundColor=null}init(){super.init(),ct.init(this),ft.init(this.ctx);const{grid:t,rooms:e}=pt(c.gridWidth,c.gridHeight);this.grid=t,this.rooms=e,this.gridHeight=t.length,this.gridWidth=t[0].length,this.hospital=ut(this.grid,this.rooms),this.calculateGrid(),this.agents=[];const s=[];for(let i=0;i<this.gridHeight;i++)for(let o=0;o<this.gridWidth;o++){const a=this.grid[i][o].type;(a==="floor"||a==="room_floor"||a==="door")&&s.push({x:o,y:i})}this.floorCells=s,this.variants=[],this.nextVariantIndex=0;for(let i=0;i<Math.min(c.agentCount,s.length);i++){const o=Math.floor(Math.random()*s.length),a=s[o],d=new X(a.x,a.y,this.grid,this.rooms,this.hospital);Math.random()<c.initialVaccinatedPercent&&(d.healthState="vaccinated"),this.agents.push(d)}this.elapsedTime=0,this.lastWaveTime=0,this.infectionStarted=!1,this.showDataOverlay=!1,this.history=[],this.lastHistoryTime=0,this.dominantVariant=null,this.dataButton=new dt(this,{text:"[i]",width:36,height:36,font:'14px "Fira Code", monospace',startToggled:!1,onToggle:i=>{this.showDataOverlay=i}}),this.pipeline.add(this.dataButton),this.container=this.canvas.parentElement,this.container&&this.enableFluidSize(this.container),this.canvas.addEventListener("click",i=>this.handleClick(i)),this.canvas.addEventListener("touchend",i=>{i.preventDefault(),this.handleClick(i.changedTouches[0])})}handleClick(t){const e=this.canvas.getBoundingClientRect(),s=t.clientX-e.left,i=t.clientY-e.top;if(this.showDataOverlay){const n=this.width-36,h=this.height-36;if(!(s>=n-18&&s<=n+18&&i>=h-18&&i<=h+18)){this.showDataOverlay=!1,this.dataButton.toggle(!1);return}}const o=Math.floor((s-this.gridOffsetX)/this.cellW),a=Math.floor((i-this.gridOffsetY)/this.cellH),d=Math.max(this.cellW,this.cellH)*1.5;let r=null,l=d;for(const n of this.agents){if(n.healthState==="dead")continue;const h=this.gridOffsetX+n.x*this.cellW+this.cellW/2,f=this.gridOffsetY+n.y*this.cellH+this.cellH/2,g=Math.sqrt((s-h)**2+(i-f)**2);g<l&&(l=g,r=n)}if(r)(r.healthState==="susceptible"||r.healthState==="vaccinated")&&this.infectAgent(r);else if(o>=0&&o<this.gridWidth&&a>=0&&a<this.gridHeight){const n=this.grid[a][o];if(n.type==="floor"||n.type==="room_floor"||n.type==="door"){const h=new X(o,a,this.grid,this.rooms,this.hospital);this.agents.push(h)}}}infectAgent(t){if(!this.infectionStarted){const s=new z(this.nextVariantIndex++,null);s.emergeTime=this.elapsedTime,s.emergeX=t.x,s.emergeY=t.y,this.variants.push(s),this.infectionStarted=!0}const e=this.variants[0];t.healthState="exposed",t.variant=e,e.infectionCount++,t.diseaseTimer=c.incubationTime.min+Math.floor(Math.random()*(c.incubationTime.max-c.incubationTime.min))}calculateGrid(){const t=this.width/this.gridWidth,e=this.height/this.gridHeight,s=Math.max(t,e);this.cellW=s,this.cellH=s;const i=this.gridWidth*this.cellW,o=this.gridHeight*this.cellH;this.gridOffsetX=(this.width-i)/2,this.gridOffsetY=(this.height-o)/2}update(t){super.update(t),this.calculateGrid(),this.elapsedTime+=t,this.dataButton&&(this.dataButton.x=this.width-36,this.dataButton.y=this.height-36),this.infectionStarted&&this.elapsedTime-this.lastWaveTime>=c.newAgentInterval&&(this.spawnNewAgents(c.newAgentCount),this.lastWaveTime=this.elapsedTime);for(const e of this.agents)e.update(),e.justDied&&(e.justDied=!1,G.to(e,{deathFlash:0},.8,mt.easeOutQuad));this.processTransmission(),this.elapsedTime-this.lastHistoryTime>=c.historyInterval&&(this.recordHistory(),this.lastHistoryTime=this.elapsedTime),this.updateDominantVariant(),G.updateAll(t)}recordHistory(){const t={};let e=0,s=0;for(const i of this.agents)i.healthState==="infected"||i.healthState==="exposed"?(e++,i.variant&&(t[i.variant.name]=(t[i.variant.name]||0)+1)):i.healthState==="recovered"&&s++;this.history.push({time:this.elapsedTime,infected:e,recovered:s,variants:{...t}}),this.history.length>c.maxHistoryPoints&&this.history.shift()}updateDominantVariant(){if(this.variants.length===0){this.dominantVariant=null;return}const t=new Map;for(const i of this.agents)(i.healthState==="infected"||i.healthState==="exposed")&&i.variant&&t.set(i.variant,(t.get(i.variant)||0)+1);let e=0,s=null;for(const[i,o]of t)o>e&&(e=o,s=i);this.dominantVariant=s}createMutatedVariant(t,e=null){const s=new z(this.nextVariantIndex++,t);return s.emergeTime=this.elapsedTime,e&&(s.emergeX=e.x,s.emergeY=e.y),this.variants.push(s),console.log(`[MUTATION] New variant emerged: ${s.name} (from ${t.name})`),console.log(`  - Transmissibility: ${(s.transmissionMultiplier*100).toFixed(0)}%`),console.log(`  - Vaccine resistance: ${(s.vaccineResistance*100).toFixed(0)}%`),s}spawnNewAgents(t){for(let e=0;e<t&&this.floorCells.length!==0;e++){const s=Math.floor(Math.random()*this.floorCells.length),i=this.floorCells[s],o=new X(i.x,i.y,this.grid,this.rooms,this.hospital);this.agents.push(o)}}getAgentRoom(t){for(const e of this.rooms)if(t.x>=e.x&&t.x<e.x+e.width&&t.y>=e.y&&t.y<e.y+e.height)return e;return null}processTransmission(){const t=new Map;for(const s of this.agents){if(s.healthState==="dead")continue;const i=`${s.x},${s.y}`;t.has(i)||t.set(i,[]),t.get(i).push(s)}const e=this.agents.filter(s=>s.healthState==="infected");for(const s of e){const i=this.getAgentRoom(s),o=s.variant;if(o)for(let a=-1;a<=1;a++)for(let d=-1;d<=1;d++){const r=s.x+d,l=s.y+a,n=`${r},${l}`;if(t.has(n))for(const h of t.get(n)){if(h===s||h.healthState!=="susceptible"&&h.healthState!=="vaccinated")continue;let f=c.transmissionRate*o.transmissionMultiplier;d===0&&a===0&&(f*=1.5);const g=this.getAgentRoom(h),M=h.healthState==="vaccinated";if(i&&g&&i===g){const x=M?c.roomTransmissionBonus*.6:c.roomTransmissionBonus;f*=x}if(M){const x=Math.max(.5,c.vaccineEfficacy-o.vaccineResistance);f*=1-x}const p=Math.random();if(p<f)h.healthState="exposed",h.variant=o,o.infectionCount++,h.diseaseTimer=c.incubationTime.min+Math.floor(Math.random()*(c.incubationTime.max-c.incubationTime.min));else if(M&&p<f+c.mutationChanceOnVaccinated&&this.variants.length<c.maxVariants){const x=this.createMutatedVariant(o,s);s.variant=x;const k=Math.max(0,c.vaccineEfficacy-x.vaccineResistance),H=c.transmissionRate*x.transmissionMultiplier*(1-k);Math.random()<H&&(h.healthState="exposed",h.variant=x,x.infectionCount++,h.diseaseTimer=c.incubationTime.min+Math.floor(Math.random()*(c.incubationTime.max-c.incubationTime.min)))}}}}}render(){const t=this.ctx,e=this.elapsedTime;t.fillStyle=`rgba(5, 5, 8, ${c.trailAlpha})`,t.fillRect(0,0,this.width,this.height),this.stats={susceptible:0,vaccinated:0,exposed:0,infected:0,recovered:0,dead:0};for(const i of this.agents)this.stats[i.healthState]++;t.strokeStyle="rgba(255, 255, 255, 0.03)",t.lineWidth=1;for(let i=0;i<=this.gridWidth;i++)t.beginPath(),t.moveTo(this.gridOffsetX+i*this.cellW,this.gridOffsetY),t.lineTo(this.gridOffsetX+i*this.cellW,this.gridOffsetY+this.gridHeight*this.cellH),t.stroke();for(let i=0;i<=this.gridHeight;i++)t.beginPath(),t.moveTo(this.gridOffsetX,this.gridOffsetY+i*this.cellH),t.lineTo(this.gridOffsetX+this.gridWidth*this.cellW,this.gridOffsetY+i*this.cellH),t.stroke();for(let i=0;i<this.gridHeight;i++)for(let o=0;o<this.gridWidth;o++){const a=this.grid[i][o],d=this.gridOffsetX+o*this.cellW,r=this.gridOffsetY+i*this.cellH;a.type==="wall"||a.type==="room_wall"?(t.fillStyle=c.colors.wall,t.fillRect(d,r,this.cellW+1,this.cellH+1)):a.type==="hospital_wall"&&(t.fillStyle=c.colors.hospitalWall,t.shadowColor=c.colors.hospitalWall,t.shadowBlur=4,t.fillRect(d,r,this.cellW+1,this.cellH+1),t.shadowBlur=0)}if(this.hospital){const i=this.hospital,o=i.x+Math.floor(i.width/2),a=i.y+Math.floor(i.height/2),d=this.gridOffsetX+o*this.cellW+this.cellW/2,r=this.gridOffsetY+a*this.cellH+this.cellH/2;t.fillStyle=c.colors.hospitalWall,t.shadowColor=c.colors.hospitalWall,t.shadowBlur=3,t.globalAlpha=.25;const l=this.cellW*.7,n=this.cellH*2.5;t.fillRect(d-l/2,r-n/2,l,n),t.fillRect(d-n/2,r-l/2,n,l),t.globalAlpha=1,t.shadowBlur=0}for(const i of this.agents){const o=this.gridOffsetX+i.x*this.cellW+this.cellW/2,a=this.gridOffsetY+i.y*this.cellH+this.cellH/2,d=Math.min(this.cellW,this.cellH)*.4;let r,l,n=1,h=0;const f=i.variant&&i.variant===this.dominantVariant,g=f?1.5:i.variant&&this.dominantVariant?.6:1;switch(i.healthState){case"exposed":r=i.variant?i.variant.color:c.colors.exposed,l=r,n=.7,h=Math.sin(e*c.pulseSpeed+i.x*.5)*.2;break;case"infected":r=i.variant?i.variant.color:c.colors.infected,l=r,h=Math.sin(e*c.pulseSpeed*2+i.y*.5)*(f?.4:.25);break;case"recovered":r=c.colors.recovered,l=r;break;case"vaccinated":r=c.colors.vaccinated,l=r,h=Math.sin(e*2+i.x+i.y)*.1;break;case"dead":const u=i.deathFlash||0,p=Math.floor(34+u*221);r=`rgb(${p}, ${p}, ${p})`,l=u>.1?"#fff":"#111",n=.5+u*.5;break;default:r=c.colors.agent,l=r}const M=d*(1+h);if(i.healthState!=="dead"){const u=M*2.5*g,p=t.createRadialGradient(o,a,0,o,a,u),x=f?"80":"40";p.addColorStop(0,l+x),p.addColorStop(.5,l+"20"),p.addColorStop(1,"transparent"),t.fillStyle=p,t.beginPath(),t.arc(o,a,u,0,Math.PI*2),t.fill()}if(t.globalAlpha=n,t.fillStyle=r,t.beginPath(),t.arc(o,a,M,0,Math.PI*2),t.fill(),i.healthState!=="dead"){const u=t.createRadialGradient(o-M*.3,a-M*.3,0,o,a,M);u.addColorStop(0,"rgba(255,255,255,0.4)"),u.addColorStop(.5,"rgba(255,255,255,0.1)"),u.addColorStop(1,"transparent"),t.fillStyle=u,t.beginPath(),t.arc(o,a,M,0,Math.PI*2),t.fill()}t.globalAlpha=1}t.fillStyle="rgba(0, 0, 0, 0.03)";for(let i=0;i<this.height;i+=3)t.fillRect(0,i,this.width,1);const s=t.createRadialGradient(this.width/2,this.height/2,this.height*.3,this.width/2,this.height/2,this.height*.9);s.addColorStop(0,"transparent"),s.addColorStop(1,"rgba(0, 0, 0, 0.4)"),t.fillStyle=s,t.fillRect(0,0,this.width,this.height),this.drawVariantFlashes(t,e),this.drawMinimalHUD(t),this.showDataOverlay&&this.drawDataOverlay(t),this.dataButton&&this.dataButton.render()}drawVariantFlashes(t,e){for(const s of this.variants){const i=e-s.emergeTime;if(i<0||i>c.variantFlashDuration)continue;let o=1;i>c.variantFlashFadeStart&&(o=1-(i-c.variantFlashFadeStart)/(c.variantFlashDuration-c.variantFlashFadeStart));const a=this.gridOffsetX+s.emergeX*this.cellW+this.cellW/2,d=this.gridOffsetY+s.emergeY*this.cellH-20;t.save(),t.globalAlpha=o,t.font='bold 16px "Fira Code", monospace',t.textAlign="center",t.textBaseline="bottom",t.shadowColor=s.color,t.shadowBlur=15,t.fillStyle=s.color,t.fillText(s.name.toUpperCase(),a,d),t.shadowBlur=0,t.fillText(s.name.toUpperCase(),a,d),t.restore()}}drawMinimalHUD(t){t.font='11px "Fira Code", monospace',t.textAlign="right",t.textBaseline="top",t.fillStyle="rgba(0, 0, 0, 0.5)",t.fillRect(this.width-180,12,168,32),t.fillStyle="rgba(0, 255, 128, 0.6)",t.fillText("CLICK agent to INFECT",this.width-16,16),t.fillText("CLICK floor to SPAWN",this.width-16,28),t.font='12px "Fira Code", monospace',t.textAlign="left",t.textBaseline="bottom";const e=this.stats.infected+this.stats.exposed,s=this.stats.recovered,i=this.stats.dead,o=i>0?46:32,a=this.height-o-12;t.fillStyle="rgba(0, 0, 0, 0.5)",t.fillRect(12,a,120,o);let d=a+14;t.fillStyle=c.colors.infected,t.fillText(`INFECTED: ${e}`,16,d),d+=14,t.fillStyle=c.colors.recovered,t.fillText(`RECOVERED: ${s}`,16,d),i>0&&(d+=14,t.fillStyle="#666",t.fillText(`DEAD: ${i}`,16,d))}drawDataOverlay(t){t.fillStyle="rgba(0, 0, 0, 0.85)",t.fillRect(0,0,this.width,this.height);const e=40,s=this.width-e*2,i=(this.height-e*3)/2;t.font='bold 18px "Fira Code", monospace',t.fillStyle="#fff",t.textAlign="center",t.textBaseline="top",t.fillText("VARIANT ANALYTICS",this.width/2,15),this.drawPrevalenceChart(t,e,e+20,s,i-20),this.drawVariantBars(t,e,e+i+30,s,i-30),t.font='11px "Fira Code", monospace',t.fillStyle="rgba(255, 255, 255, 0.5)",t.textAlign="center",t.fillText("click anywhere to close",this.width/2,this.height-15)}drawPrevalenceChart(t,e,s,i,o){if(t.fillStyle="rgba(255, 255, 255, 0.05)",t.fillRect(e,s,i,o),t.font='12px "Fira Code", monospace',t.fillStyle="#888",t.textAlign="left",t.textBaseline="top",t.fillText("Infections Over Time",e,s-15),this.history.length<2){t.fillStyle="#444",t.textAlign="center",t.fillText("Collecting data...",e+i/2,s+o/2);return}let a=1;for(const r of this.history)a=Math.max(a,r.infected);t.strokeStyle="rgba(255, 255, 255, 0.1)",t.lineWidth=1;for(let r=0;r<=4;r++){const l=s+o-r/4*o;t.beginPath(),t.moveTo(e,l),t.lineTo(e+i,l),t.stroke()}const d=new Set;for(const r of this.history)for(const l of Object.keys(r.variants))d.add(l);for(const r of d){const l=this.variants.find(h=>h.name===r);if(!l)continue;t.strokeStyle=l.color,t.lineWidth=2,t.beginPath();let n=!1;for(let h=0;h<this.history.length;h++){const g=this.history[h].variants[r]||0,M=e+h/(this.history.length-1)*i,u=s+o-g/a*o;n?t.lineTo(M,u):(t.moveTo(M,u),n=!0)}t.stroke()}t.font='10px "Fira Code", monospace',t.fillStyle="#666",t.textAlign="right",t.fillText(a.toString(),e-5,s),t.fillText("0",e-5,s+o)}drawVariantBars(t,e,s,i,o){if(t.fillStyle="rgba(255, 255, 255, 0.05)",t.fillRect(e,s,i,o),t.font='12px "Fira Code", monospace',t.fillStyle="#888",t.textAlign="left",t.textBaseline="top",t.fillText("Variant Properties (Transmissibility / Vaccine Resistance)",e,s-15),this.variants.length===0){t.fillStyle="#444",t.textAlign="center",t.fillText("No variants yet",e+i/2,s+o/2);return}const a=Math.min(60,(i-20)/this.variants.length-10),d=(i-a*this.variants.length)/(this.variants.length+1);let r=1;for(const h of this.variants)r=Math.max(r,h.transmissionMultiplier);const l=Math.min(...this.variants.map(h=>h.transmissionMultiplier)),n=Math.max(r-l,.5);for(let h=0;h<this.variants.length;h++){const f=this.variants[h],g=e+d+h*(a+d),u=(f.transmissionMultiplier-l)/n*(o-30);t.fillStyle=f.color,t.fillRect(g,s+o-20-u,a/2-2,u);const p=f.vaccineResistance*(o-30);t.fillStyle=f.color+"80",t.fillRect(g+a/2+2,s+o-20-p,a/2-2,p),t.font='9px "Fira Code", monospace',t.fillStyle=f.color,t.textAlign="center",t.fillText(f.name,g+a/2,s+o-5),u>15&&(t.font='7px "Fira Code", monospace',t.fillStyle="#aaa",t.fillText(`${f.transmissionMultiplier.toFixed(1)}x`,g+a/2,s+o-22-u))}t.font='10px "Fira Code", monospace',t.fillStyle="#666",t.textAlign="right",t.fillText("■ Trans  □ Resist",e+i,s-15)}}function vt(m){const t=new yt(m);return t.start(),{stop:()=>t.stop(),game:t}}export{vt as default};
