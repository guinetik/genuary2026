import{G as F,P as I,C as O,Y as X}from"./index-plo7o7PE.js";const i={radius1:100,radius2:100,piRational:3,piIrrational:Math.PI,timeStep:.06,maxTheta:Math.PI*60,maxTrailLength:15e3,depthPerTheta:8,perspective:800,initialRotationX:.05,initialZoom:.08,maxZoom:1.5,wheelZoomSpeed:.08,autoZoomSpeed:8e-4,jitterAmount:.6,grainDensity:.25,scratchChance:.012,dustChance:6e-4,flickerSpeed:.08,flickerIntensity:.1,chromaMaxOffset:4,chromaStartProgress:.05,rationalFlashInterval:Math.PI*8,rationalFlashDuration:12,maxJitterMultiplier:4,frameSkipChance:.03,lineVibrateAmount:2,contrastBoost:1.4,crushBlacks:20,blowWhites:235};class Y extends F{constructor(t){super(t),this.backgroundColor="#000"}init(){super.init(),I.init(this.ctx),this.theta=0,this.isRational=!1,this.isAnimating=!0,this.scale=Math.min(this.width,this.height)/500,this.centerX=this.width/2,this.centerY=this.height/2,this.camera=new O({perspective:i.perspective,rotationX:i.initialRotationX,rotationY:Math.PI,inertia:!0,friction:.92,sensitivity:.004,clampX:!1,clampY:!1}),this.camera.enableMouseControl(this.canvas),this.trail=[],this.zoom=i.initialZoom,this.targetZoom=i.initialZoom,this.userZoomed=!1,this.zoomResumeTimer=null,this.rationalFlashFrames=0,this.lastFlashTheta=0,this.skipFrame=!1,this.vibrateOffset={x:0,y:0},this.grainCanvas=document.createElement("canvas"),this.grainCanvas.width=this.width,this.grainCanvas.height=this.height,this.grainCtx=this.grainCanvas.getContext("2d"),this._dblClickHandler||(this._dblClickHandler=()=>{this.isRational=!this.isRational,this.trail=[],this.theta=0,this.zoom=i.initialZoom,this.targetZoom=i.initialZoom,this.userZoomed=!1,this.zoomResumeTimer&&(clearTimeout(this.zoomResumeTimer),this.zoomResumeTimer=null)},this.canvas.addEventListener("dblclick",this._dblClickHandler)),this._gesture||(this._gesture=new X(this.canvas,{onZoom:t=>{this.userZoomed=!0,this.zoomResumeTimer&&clearTimeout(this.zoomResumeTimer),this.zoomResumeTimer=setTimeout(()=>{this.userZoomed=!1},2e3);const h=t*i.wheelZoomSpeed*2;this.targetZoom=Math.max(.05,this.targetZoom+h)},onTap:()=>{const t=Date.now();this._lastTapTime&&t-this._lastTapTime<400?(this.isRational=!this.isRational,this.trail=[],this.theta=0,this.zoom=i.initialZoom,this.targetZoom=i.initialZoom,this.userZoomed=!1,this.zoomResumeTimer&&(clearTimeout(this.zoomResumeTimer),this.zoomResumeTimer=null),this._lastTapTime=0):this._lastTapTime=t},wheelZoomFactor:i.wheelZoomSpeed,pinchZoomFactor:2})),this._keyHandler||(this._keyHandler=t=>{t.code==="Space"&&(t.preventDefault(),this.isAnimating=!this.isAnimating)},this.canvas.addEventListener("keydown",this._keyHandler)),this.canvas.tabIndex=0,this.canvas.focus()}get piValue(){return this.isRational?i.piRational:i.piIrrational}calculatePosition(t){const h=this.piValue,b=i.radius1*this.scale,s=i.radius2*this.scale,r=b*Math.cos(t)+s*Math.cos(h*t),c=b*Math.sin(t)+s*Math.sin(h*t),n=t*i.depthPerTheta;return{x:r,y:c,z:n}}jitter(t){return t+(Math.random()-.5)*i.jitterAmount}update(t){if(super.update(t),this.camera.update(t),this.zoom+=(this.targetZoom-this.zoom)*.05,!this.isAnimating)return;this.theta+=i.timeStep,!this.userZoomed&&this.targetZoom<i.maxZoom&&(this.targetZoom+=i.autoZoomSpeed,this.targetZoom=Math.min(this.targetZoom,i.maxZoom)),!this.isRational&&this.rationalFlashFrames>0&&this.rationalFlashFrames--,!this.isRational&&this.theta-this.lastFlashTheta>=i.rationalFlashInterval&&(this.rationalFlashFrames=i.rationalFlashDuration,this.lastFlashTheta=this.theta),this.skipFrame=Math.random()<i.frameSkipChance,this.vibrateOffset={x:(Math.random()-.5)*i.lineVibrateAmount,y:(Math.random()-.5)*i.lineVibrateAmount};const h=this.calculatePosition(this.theta);this.currentPos=h,this.trail.push({x:h.x,y:h.y,z:h.z,theta:this.theta}),this.trail.length>i.maxTrailLength&&this.trail.shift()}renderGrain(){const t=this.grainCtx;t.clearRect(0,0,this.width,this.height);const h=Math.floor(this.width*this.height*i.grainDensity/80);for(let s=0;s<h;s++){const r=Math.random()*this.width,c=Math.random()*this.height,n=Math.random()*2.5+.5,M=Math.random()>.8?i.blowWhites+Math.random()*20:Math.random()*i.crushBlacks,y=Math.random()*.5+.15;t.fillStyle=`rgba(${M}, ${M}, ${M}, ${y})`,t.fillRect(r,c,n,n)}if(Math.random()<i.scratchChance){const s=Math.random()*this.width,r=Math.random()*this.height*.7+this.height*.2,c=Math.random()*(this.height-r);t.strokeStyle=`rgba(200, 200, 200, ${Math.random()*.3+.1})`,t.lineWidth=Math.random()*1.5+.5,t.beginPath(),t.moveTo(s,c);for(let n=c;n<c+r;n+=10)t.lineTo(s+(Math.random()-.5)*2,n);t.stroke()}const b=Math.floor(this.width*this.height*i.dustChance);for(let s=0;s<b;s++){const r=Math.random()*this.width,c=Math.random()*this.height,n=Math.random()*4+2;t.fillStyle=`rgba(0, 0, 0, ${Math.random()*.6+.2})`,t.beginPath(),t.arc(r,c,n,0,Math.PI*2),t.fill()}if(Math.random()<.03){const s=Math.random()*this.height,r=Math.random()*8+2;t.fillStyle=`rgba(255, 255, 255, ${Math.random()*.1})`,t.fillRect(0,s,this.width,r)}}render(){const t=this.ctx;if(this.skipFrame)return;const h=Math.min(1,this.theta/i.maxTheta),b=i.flickerIntensity*(1+h*.5),s=1-Math.random()*b*(.5+.5*Math.sin(this.theta*i.flickerSpeed*10)),r=1+(i.maxJitterMultiplier-1)*h;if(t.fillStyle=`rgb(${i.crushBlacks}, ${i.crushBlacks}, ${i.crushBlacks})`,t.fillRect(0,0,this.width,this.height),t.fillStyle="#000",t.fillRect(0,0,this.width,this.height),t.lineCap="round",t.lineJoin="round",this.trail.length>1){const d=this.trail[0].z,M=this.trail[this.trail.length-1].z,y=(d+M)/2,g=this.trail.map(e=>{const a=this.camera.project(e.x,e.y,e.z-y);return{sx:this.centerX+a.x*this.zoom,sy:this.centerY+a.y*this.zoom,scale:a.scale*this.zoom,z:a.z,theta:e.theta}}),T=Math.max(0,(h-i.chromaStartProgress)/(1-i.chromaStartProgress)),m=i.chromaMaxOffset*Math.pow(T,1.2),f=Math.min(255,Math.floor(80*i.contrastBoost)),x=Math.min(255,Math.floor(255*i.contrastBoost));t.globalCompositeOperation="lighter";const P=[{color:`rgba(${x}, ${f}, ${f}, ${.7*s})`,offsetX:-m,offsetY:-m*.5},{color:`rgba(${f}, ${x}, ${f}, ${.7*s})`,offsetX:0,offsetY:0},{color:`rgba(${f}, ${f}, ${x}, ${.7*s})`,offsetX:m,offsetY:m*.5}];for(const e of P){t.beginPath();for(let a=0;a<g.length;a++){const l=g[a];m*(.5+.5*l.scale);const u=e.offsetX*(.3+.7*(l.theta/i.maxTheta)),z=e.offsetY*(.3+.7*(l.theta/i.maxTheta)),p=l.sx+u+this.vibrateOffset.x+(Math.random()-.5)*i.jitterAmount*r*.3,o=l.sy+z+this.vibrateOffset.y+(Math.random()-.5)*i.jitterAmount*r*.3;a===0?t.moveTo(p,o):t.lineTo(p,o)}t.strokeStyle=e.color,t.lineWidth=1,t.stroke()}t.globalCompositeOperation="source-over",t.globalCompositeOperation="lighter";for(let e=0;e<g.length;e+=50){const a=g[e],l=Math.max(.1,Math.min(1,a.scale)),u=Math.max(.5,2*a.scale),z=a.theta/i.maxTheta,p=m*z;t.fillStyle=`rgba(255, 100, 100, ${l*.25*s})`,t.beginPath(),t.arc(a.sx-p,a.sy-p*.5,u,0,Math.PI*2),t.fill(),t.fillStyle=`rgba(100, 255, 100, ${l*.25*s})`,t.beginPath(),t.arc(a.sx,a.sy,u,0,Math.PI*2),t.fill(),t.fillStyle=`rgba(100, 100, 255, ${l*.25*s})`,t.beginPath(),t.arc(a.sx+p,a.sy+p*.5,u,0,Math.PI*2),t.fill()}if(t.globalCompositeOperation="source-over",this.rationalFlashFrames>0&&!this.isRational){const e=this.rationalFlashFrames/i.rationalFlashDuration,a=i.piRational,l=i.radius1*this.scale,u=i.radius2*this.scale;t.globalCompositeOperation="screen",t.strokeStyle=`rgba(255, 255, 200, ${.6*e*s})`,t.lineWidth=2,t.beginPath();const z=Math.PI*2*a;for(let o=0;o<=z;o+=.1){const v=l*Math.cos(o)+u*Math.cos(a*o),S=l*Math.sin(o)+u*Math.sin(a*o),R=o*i.depthPerTheta,$=this.camera.project(v,S,R-y),Z=this.centerX+$.x*this.zoom,C=this.centerY+$.y*this.zoom;o===0?t.moveTo(Z,C):t.lineTo(Z,C)}if(t.stroke(),t.globalCompositeOperation="source-over",Math.floor(this.lastFlashTheta)%2===0){const o=Math.min(this.width,this.height)*.5;t.font=`bold ${o}px serif`,t.textAlign="center",t.textBaseline="middle",t.fillStyle=`rgba(255, 0, 0, ${.8*e*s})`,t.fillText("π",this.centerX+(Math.random()-.5)*20,this.centerY+(Math.random()-.5)*20)}else{const o="3141592653589793238462643383279502884197169399375105820974944592307816406286",v=Math.floor(100*e);for(let S=0;S<v;S++){const R=o[Math.floor(Math.random()*o.length)],$=Math.random()*this.width,Z=Math.random()*this.height,C=24+Math.random()*72;t.font=`bold ${C}px monospace`;const w=Math.floor(Math.random()*100+50);t.fillStyle=`rgba(${w}, ${w}, ${w}, ${.5+Math.random()*.4})`,t.fillText(R,$,Z)}}t.globalCompositeOperation="source-over"}}if(this.currentPos&&this.trail.length>1){const d=this.trail[0].z,M=this.trail[this.trail.length-1].z,y=(d+M)/2,g=this.camera.project(this.currentPos.x,this.currentPos.y,this.currentPos.z-y),T=.7+.3*Math.sin(this.theta*8),m=Math.max(2,4*g.scale*this.zoom),f=this.centerX+g.x*this.zoom,x=this.centerY+g.y*this.zoom,P=this.theta/i.maxTheta,e=Math.max(0,(P-i.chromaStartProgress)/(1-i.chromaStartProgress)),a=i.chromaMaxOffset*e*P;t.globalCompositeOperation="lighter",t.fillStyle=`rgba(255, 120, 120, ${T*s})`,t.beginPath(),t.arc(f-a,x-a*.5,m,0,Math.PI*2),t.fill(),t.fillStyle=`rgba(120, 255, 120, ${T*s})`,t.beginPath(),t.arc(f,x,m,0,Math.PI*2),t.fill(),t.fillStyle=`rgba(120, 120, 255, ${T*s})`,t.beginPath(),t.arc(f+a,x+a*.5,m,0,Math.PI*2),t.fill(),t.globalCompositeOperation="source-over"}if(Math.random()>.5&&this.renderGrain(),t.drawImage(this.grainCanvas,0,0),Math.random()<.06){const d=t.createRadialGradient(this.centerX,this.centerY,this.width*.2,this.centerX,this.centerY,this.width*.55);d.addColorStop(0,"rgba(0, 0, 0, 0)"),d.addColorStop(1,"rgba(0, 0, 0, 0.25)"),t.fillStyle=d,t.fillRect(0,0,this.width,this.height)}t.font="12px monospace",t.fillStyle=`rgba(150, 150, 150, ${.5*s})`;const c=this.isRational?"π ≈ 3":"π = 3.14159265...";t.fillText(c,20,30),t.fillStyle=`rgba(120, 120, 120, ${.4*s})`,t.fillText("z(θ) = e^(θi) + e^(πθi)",20,48);const n=(this.theta/(Math.PI*2)).toFixed(1);t.fillStyle=`rgba(150, 150, 150, ${.4*s})`,t.fillText(`${n} revolutions`,20,66),this.isRational?(t.fillStyle=`rgba(100, 255, 100, ${.4*s})`,t.fillText("it would close...",20,84)):(t.fillStyle=`rgba(255, 100, 100, ${.4*s})`,t.fillText("it will never close.",20,84)),t.fillStyle=`rgba(100, 100, 100, ${.3*s})`,t.fillText("drag to orbit • scroll/pinch to zoom • double-tap to toggle π",20,this.height-20)}stop(){super.stop(),this._gesture&&this._gesture.destroy(),this.zoomResumeTimer&&clearTimeout(this.zoomResumeTimer)}}function _(k){const t=new Y(k);return t.start(),{stop:()=>t.stop(),game:t}}export{_ as default};
