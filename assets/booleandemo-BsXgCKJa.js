import{G as H,P as y,ab as W,M as S}from"./index-CyJvuFm5.js";const o={expr:{variables:["A","B","C","D","E"],maxDepth:5,notProbability:.22,ops:["AND","OR","XOR","NAND","NOR","XNOR"]},layout:{margin:70,layerGap:150,leafGap:80,nodeW:92,nodeH:46,portOffsetY:12,elbowX:60},render:{backgroundAlpha:.14,blendMode:"screen",wireWidth:2,wireWidthHot:3,gateRadius:10,font:'12px "Fira Code", monospace',signalRadius:4.2},animation:{clockHz:.55,jitterHz:.12,packetSpeed:.6,packetSpacing:.33},colors:{bg:"#000",gateStroke:"rgba(0, 255, 0, 0.55)",wireOff:"rgba(0, 255, 0, 0.16)",wireOn:"rgba(0, 255, 0, 0.75)",wireHot:"rgba(255, 255, 255, 0.85)",signalOff:"rgba(0, 255, 0, 0.25)",signalOn:"rgba(0, 255, 0, 0.95)",signalHot:"rgba(255, 255, 255, 0.95)",text:"rgba(0, 255, 0, 0.85)"}};function P(a){return a-Math.floor(a)}function w(a,t,i){return a+(t-a)*i}function R(a){return a<.5?2*a*a:1-Math.pow(-2*a+2,2)/2}class X{constructor(t){this.cfg=t}node(t){const{vars:i,maxDepth:n,notProbability:e}=this.cfg;if(t>=n||Math.random()<.22){let p={type:"var",name:i[Math.floor(Math.random()*i.length)]};return Math.random()<e&&(p={type:"not",a:p}),p}const r=this.node(t+1),c=this.node(t+1);let u={type:"bin",op:this.cfg.ops[Math.floor(Math.random()*this.cfg.ops.length)],a:r,b:c};return Math.random()<e*.6&&(u={type:"not",a:u}),u}toString(t){return t.type==="var"?t.name:t.type==="not"?`NOT(${this.toString(t.a)})`:`(${this.toString(t.a)} ${t.op} ${this.toString(t.b)})`}}function D(a){let t=0;const i=new Map,n=e=>{const h=i.get(e);if(h)return h;const r={id:`n${t++}`,type:e.type,name:e.type==="var"?e.name:void 0,value:e.type==="const"?!!e.value:void 0,inputs:[],x:0,y:0,depth:0};return i.set(e,r),e.type==="not"?r.inputs=[n(e.left)]:(e.type==="and"||e.type==="or"||e.type==="xor"||e.type==="nand"||e.type==="nor"||e.type==="xnor")&&(r.inputs=[n(e.left),n(e.right)]),r};return n(a)}function Y(a){const t=[],i=[];let n=0;const e=[],h=(s,f)=>{if(s.depth=f,t.push(s),s.inputs.length===0){e.push(s);return}for(let x=0;x<s.inputs.length;x++){const M=s.inputs[x];i.push({id:`e${n++}`,from:M,to:s,portIndex:x===0?0:1}),h(M,f+1)}};h(a,0);const r=t.reduce((s,f)=>Math.max(s,f.depth),0);for(const s of t)s.depth=r-s.depth;for(let s=0;s<e.length;s++)e[s].y=s*o.layout.leafGap;const c=[...t].sort((s,f)=>f.depth-s.depth);for(const s of c)if(s.inputs.length>0){const f=s.inputs.map(x=>x.y);s.y=f.reduce((x,M)=>x+M,0)/f.length}for(const s of t)s.x=s.depth*o.layout.layerGap;const l=Math.min(...t.map(s=>s.y)),u=Math.max(...t.map(s=>s.y)),p=(l+u)/2;for(const s of t)s.y-=p;const g=Math.min(...t.map(s=>s.x)),m=Math.max(...t.map(s=>s.x)),b=(g+m)/2;for(const s of t)s.x-=b;return{nodes:t,edges:i,maxDepth:r}}function d(a,t){switch(a.type){case"const":return!!a.value;case"var":return!!(t[a.name]??!1);case"not":return!d(a.inputs[0],t);case"and":return d(a.inputs[0],t)&&d(a.inputs[1],t);case"nand":return!(d(a.inputs[0],t)&&d(a.inputs[1],t));case"or":return d(a.inputs[0],t)||d(a.inputs[1],t);case"nor":return!(d(a.inputs[0],t)||d(a.inputs[1],t));case"xor":{const i=d(a.inputs[0],t),n=d(a.inputs[1],t);return i&&!n||!i&&n}case"xnor":{const i=d(a.inputs[0],t),n=d(a.inputs[1],t);return i===n}default:return!1}}class B extends H{constructor(t){super(t),this.backgroundColor=o.colors.bg}init(){super.init(),y.init(this.ctx),this.container=this.canvas.parentElement,this.container&&this.enableFluidSize(this.container),this.time=0,this.clock=0,this._onClick=()=>this.regenerate(),this.canvas.addEventListener("click",this._onClick),this.regenerate()}stop(){super.stop(),this._onClick&&this.canvas.removeEventListener("click",this._onClick)}regenerate(){const t=new X({vars:o.expr.variables,ops:o.expr.ops,maxDepth:o.expr.maxDepth,notProbability:o.expr.notProbability});this.expression=t.toString(t.node(0)),this.ast=W.parse(this.expression),this.root=D(this.ast);const{nodes:i,edges:n}=Y(this.root);this.nodes=i,this.edges=n}buildEnv(t){const i={},n=t*o.animation.clockHz*2*Math.PI,e=t*o.animation.jitterHz*2*Math.PI;for(let h=0;h<o.expr.variables.length;h++){const r=o.expr.variables[h],c=h*1.7,l=Math.sin(n+c)+.35*Math.sin(e+c*2.2);i[r]=l>0}return i}update(t){super.update(t),this.time+=t}render(){y.setContext(this.ctx),this.ctx.setTransform(1,0,0,1,0,0),this.ctx.fillStyle=`rgba(0,0,0,${o.render.backgroundAlpha})`,this.ctx.fillRect(0,0,this.width,this.height);const t=this.buildEnv(this.time),i=o.layout.margin,n=this.getCircuitBounds(),e=Math.max(1,this.width-i*2),h=Math.max(1,this.height-i*2),r=e/Math.max(1,n.w),c=h/Math.max(1,n.h),l=Math.min(r,c);y.useCtx(u=>{u.globalCompositeOperation=o.render.blendMode,u.translate(this.width/2,this.height/2),u.scale(l,l);for(let p=0;p<this.edges.length;p++){const g=this.edges[p],m=d(g.from,t),b=d(g.to,t),s=m&&b,f=s?o.colors.wireHot:m?o.colors.wireOn:o.colors.wireOff,x=s?o.render.wireWidthHot:o.render.wireWidth,M=this.getWirePath(g);this.drawPolyline(M,f,x);const O=this.time*o.animation.packetSpeed-p*o.animation.packetSpacing,k=P(O),C=this.samplePolyline(M,k),v=s?o.colors.signalHot:m?o.colors.signalOn:o.colors.signalOff;y.shapes.fillCircle(C.x,C.y,o.render.signalRadius,v)}for(const p of this.nodes)this.drawGate(p,t)},{saveState:!0}),this.ctx.globalCompositeOperation="source-over"}getCircuitBounds(){const t=o.layout.nodeW/2,i=o.layout.nodeH/2,n=Math.min(...this.nodes.map(c=>c.x-t)),e=Math.max(...this.nodes.map(c=>c.x+t)),h=Math.min(...this.nodes.map(c=>c.y-i)),r=Math.max(...this.nodes.map(c=>c.y+i));return{minX:n,maxX:e,minY:h,maxY:r,w:e-n,h:r-h}}getWirePath(t){const i=o.layout.nodeW/2,n=t.to.inputs.length===1?0:t.portIndex===0?-12:o.layout.portOffsetY,e=t.from.x+i,h=t.from.y,r=t.to.x-i,c=t.to.y+n,l=w(e,r,.5),u=Math.min(l,e+o.layout.elbowX),p=Math.max(l,r-o.layout.elbowX);return[{x:e,y:h},{x:u,y:h},{x:p,y:c},{x:r,y:c}]}drawPolyline(t,i,n){for(let e=0;e<t.length-1;e++)y.lines.line(t[e].x,t[e].y,t[e+1].x,t[e+1].y,i,n)}samplePolyline(t,i){const n=[];let e=0;for(let l=0;l<t.length-1;l++){const u=t[l].x,p=t[l].y,g=t[l+1].x,m=t[l+1].y,b=Math.hypot(g-u,m-p);n.push({ax:u,ay:p,bx:g,by:m,len:b}),e+=b}const h=i*e;let r=0;for(const l of n){if(r+l.len>=h){const u=(h-r)/(l.len||1);return{x:w(l.ax,l.bx,u),y:w(l.ay,l.by,u)}}r+=l.len}const c=t[t.length-1];return{x:c.x,y:c.y}}drawGate(t,i){const n=o.layout.nodeW/2,e=o.layout.nodeH/2,h=t.x-n,r=t.y-e,c=d(t,i),l=S.pulse(0,1,this.time,1,!0,!0).value,p=`rgba(0,255,0,${.04+(c?.35+.65*R(l):.05)*.08})`,g=c?o.colors.wireOn:o.colors.gateStroke;y.shapes.fillRoundRect(h,r,o.layout.nodeW,o.layout.nodeH,o.render.gateRadius,p),y.shapes.strokeRoundRect(h,r,o.layout.nodeW,o.layout.nodeH,o.render.gateRadius,g,2);const m=t.x+n,b=t.y;y.shapes.fillCircle(m,b,2.6,c?o.colors.signalOn:o.colors.signalOff),t.inputs.length===1?y.shapes.fillCircle(t.x-n,t.y,2.6,"rgba(0,255,0,0.35)"):t.inputs.length===2&&(y.shapes.fillCircle(t.x-n,t.y-o.layout.portOffsetY,2.6,"rgba(0,255,0,0.35)"),y.shapes.fillCircle(t.x-n,t.y+o.layout.portOffsetY,2.6,"rgba(0,255,0,0.35)"));const s=t.type==="var"?t.name:t.type==="const"?t.value?"1":"0":t.type.toUpperCase();y.useCtx(f=>{f.font=o.render.font,f.fillStyle=o.colors.text,f.textAlign="center",f.textBaseline="middle",f.fillText(s,t.x,t.y)})}}function A(a){const t=new B(a);return t.start(),{stop:()=>t.stop(),game:t}}export{A as default};
